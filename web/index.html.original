<!DOCTYPE html>
<!--
    PegaProx - Cluster Management for Proxmox VE
    Version: 0.6.4 Beta
    Website: https://pegaprox.com
    GitHub:  https://github.com/PegaProx/project-pegaprox
    
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    Copyright (C) 2025-2026 PegaProx Team
    
    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU Affero General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
    GNU Affero General Public License for more details.

    You should have received a copy of the GNU Affero General Public License
    along with this program. If not, see <https://www.gnu.org/licenses/>.
    
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    Development Team: 
      - Nico Schmidt (NS) - Lead Developer & Founder
      - Marcus Kellermann (MK) - Backend Developer
      - Laura Weber (LW) - Frontend Developer
    
    Contributors:
      - Florian Paul Azim Hoberg @gyptazy
    
    Started: September 2025
    Last major refactor: January 2026
    License: AGPL-3.0
    
    Tech Stack: React 18 + Tailwind CSS (single-file SPA)
    Yeah I know, single file is weird but it actually works great
    for our deployment scenario. Makes updates super easy. - NS
    
    Credits:
      - ProxLB by gyptazy (https://github.com/gyptazy/ProxLB)
        Load balancing logic is based on this project. Thanks!
      - ProxSnap by gyptazy (https://github.com/gyptazy/ProxSnap)
        Inspiration for the snapshot overview feature. Great tool!
    
    Some parts were optimized with AI assistance (Claude/ChatGPT).
    We've marked those sections. Most of the core logic is hand-written.
    
    Contact: sponsor@pegaprox.com (for sponsorship inquiries)
    
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    TODO (NS): Split into proper components when we have time
    TODO (MK): The API could use some cleanup too tbh
    TODO (LW): Dark mode is the only mode rn, maybe add light theme?
    FIXME (NS): Memory leak somewhere in the console component, low prio
    FIXED (LW): mobile layout works now (Jan 2026)
    
    git log --oneline (for reference):
    - b3f7a1d feat(MK): disk bus type editing
    - a2c8e4f feat(LW): EFI disk and TPM management
    - 9e4f3c2 feat: rolling update manager
    - 8f3a2b1 fix: ISO detection in migrate modal
    - 7c91ef4 feat: cross-cluster migration
    - 6d82ab3 fix: websocket reconnect issue (#247)
    - 5e73cd2 refactor: auth system
    
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
-->
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PegaProx ‚Ä¢ Cluster Management for Proxmox VE</title>
    <meta name="google" content="notranslate">
    
    <!-- NS: Preconnect - DNS resolution starts early = faster loading -->
    <link rel="preconnect" href="https://cdn.jsdelivr.net">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">
    
    <!-- NS: Preload removed - was causing credential mode mismatch warnings -->
    <!-- Scripts are loaded via loadScriptWithFallback which handles this better -->
    
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
    
    <!-- 
    OFFLINE MODE: For jumphosts without internet access:
    1. Run: python3 pegaprox_server.py --download-static (on machine WITH internet)
    2. Copy 'static' folder to jumphost
    3. The UI will use local files automatically
    
    Downloads: React, Babel, xterm.js, noVNC, + generates Tailwind CSS subset
    -->
    
    <!-- Smart Script Loader - CDN first, local fallback for offline -->
    <!-- SRI Hashes for supply chain security - verify these match official releases -->
    <script>
        // NS: Global flag to know when libs are ready
        window.pegaproxLibsReady = false;
        
        // SRI Hashes for supply chain security - verify CDN scripts haven't been tampered with
        // IMPORTANT: Update these hashes when upgrading library versions!
        // Generate hashes at: https://www.srihash.org/ or use jsDelivr's ?integrity query
        // Example: curl -s https://cdn.jsdelivr.net/npm/react@18/umd/react.production.min.js | openssl dgst -sha384 -binary | openssl base64 -A
        // Empty string = skip SRI check (use during development, fill in for production)
        const SRI_HASHES = {
            // React 18.2.0 - https://unpkg.com/react@18.2.0/umd/react.production.min.js
            'react@18': '',
            // React-DOM 18.2.0
            'react-dom@18': '',
            // Babel Standalone 7.x
            'babel@7': '',
            // noVNC 1.4.0
            'novnc@1.4.0': '',
            // xterm.js 5.3.0
            'xterm@5.3.0': '',
            // xterm-addon-fit 0.8.0
            'xterm-addon-fit@0.8.0': ''
        };
        
        function loadScriptWithFallback(cdnUrl, localUrl, integrityKey) {
            return new Promise(function(resolve) {
                var script = document.createElement('script');
                script.src = cdnUrl;
                
                // Add SRI hash if available (supply chain protection)
                if (integrityKey && SRI_HASHES[integrityKey]) {
                    script.integrity = SRI_HASHES[integrityKey];
                    script.crossOrigin = 'anonymous';
                }
                
                script.onload = resolve;
                script.onerror = function() {
                    // CDN failed (offline or integrity check failed) - try local
                    console.log('CDN unavailable or integrity check failed, trying local:', localUrl);
                    var local = document.createElement('script');
                    local.src = localUrl;
                    local.onload = resolve;
                    local.onerror = function() {
                        console.error('Failed to load from both CDN and local');
                        resolve();
                    };
                    document.head.appendChild(local);
                };
                document.head.appendChild(script);
            });
        }
        
        // Load in sequence - using jsdelivr instead of unpkg (faster + better caching)
        loadScriptWithFallback(
            'https://cdn.jsdelivr.net/npm/react@18/umd/react.production.min.js',
            '/static/js/react.production.min.js',
            'react@18'
        ).then(function() {
            return loadScriptWithFallback(
                'https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.production.min.js',
                '/static/js/react-dom.production.min.js',
                'react-dom@18'
            );
        }).then(function() {
            return loadScriptWithFallback(
                'https://cdn.jsdelivr.net/npm/@babel/standalone@7/babel.min.js',
                '/static/js/babel.min.js',
                'babel@7'
            );
        }).then(function() {
            // All libs loaded - transform babel scripts
            window.pegaproxLibsReady = true;
            if (window.Babel) {
                Babel.transformScriptTags();
            }
        });
    </script>
    
    <!-- Tailwind CSS - CDN with offline fallback -->
    <script src="https://cdn.tailwindcss.com" onerror="
        var link = document.createElement('link');
        link.rel = 'stylesheet';
        link.href = '/static/css/tailwind.min.css';
        document.head.appendChild(link);
    "></script>
    
    <!-- noVNC - lazy loaded when needed -->
    <script>
        window.loadNoVNC = function() {
            return new Promise((resolve, reject) => {
                if (window.RFB) { resolve(); return; }
                var script = document.createElement('script');
                script.type = 'module';
                script.src = '/static/js/rfb.js';
                script.onerror = function() {
                    this.src = 'https://cdn.jsdelivr.net/npm/@novnc/novnc@1.4.0/core/rfb.js';
                    if (SRI_HASHES['novnc@1.4.0']) {
                        this.integrity = SRI_HASHES['novnc@1.4.0'];
                        this.crossOrigin = 'anonymous';
                    }
                };
                script.onload = resolve;
                document.head.appendChild(script);
            });
        };
    </script>
    
    <!-- Fonts -->
    <style>
        :root {
            --font-sans: 'Plus Jakarta Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            --font-mono: 'JetBrains Mono', 'SF Mono', 'Fira Code', 'Fira Mono', 'Roboto Mono', monospace;
        }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <script>
        // ============================================
        // THEME SYSTEM - NS Jan 2026
        // ============================================
        // Available themes with full color definitions
        // To add a new theme: add entry here + it auto-appears in Settings
        
        const PEGAPROX_THEMES = {
            proxmoxDark: {
                name: 'Proxmox Dark',
                icon: 'üåô',
                description: 'Official Proxmox inspired dark theme',
                colors: {
                    primary: '#E57000',      // Official Proxmox orange
                    primaryHover: '#FF8C00',
                    dark: '#0F1419',
                    darker: '#080B0E',
                    card: '#161B22',
                    border: '#30363D',
                    hover: '#1C2128',
                    text: '#FFFFFF',
                    textMuted: '#8B949E',
                    success: '#3FB950',
                    warning: '#D29922',
                    error: '#F85149',
                    info: '#58A6FF'
                }
            },
            proxmoxLight: {
                name: 'Proxmox Light',
                icon: '‚òÄÔ∏è',
                description: 'Clean light theme for daytime use',
                colors: {
                    primary: '#E57000',
                    primaryHover: '#CC6400',
                    dark: '#F6F8FA',
                    darker: '#FFFFFF',
                    card: '#FFFFFF',
                    border: '#D0D7DE',
                    hover: '#F3F4F6',
                    text: '#1F2328',
                    textMuted: '#656D76',
                    success: '#1A7F37',
                    warning: '#9A6700',
                    error: '#CF222E',
                    info: '#0969DA'
                }
            },
            midnight: {
                name: 'Midnight Blue',
                icon: 'üåå',
                description: 'Deep blue for night owls',
                colors: {
                    primary: '#6366F1',
                    primaryHover: '#818CF8',
                    dark: '#0F172A',
                    darker: '#020617',
                    card: '#1E293B',
                    border: '#334155',
                    hover: '#1E3A5F',
                    text: '#F1F5F9',
                    textMuted: '#94A3B8',
                    success: '#22C55E',
                    warning: '#EAB308',
                    error: '#EF4444',
                    info: '#3B82F6'
                }
            },
            forest: {
                name: 'Forest',
                icon: 'üå≤',
                description: 'Nature-inspired green theme',
                colors: {
                    primary: '#10B981',
                    primaryHover: '#34D399',
                    dark: '#0D1117',
                    darker: '#010409',
                    card: '#161B22',
                    border: '#21262D',
                    hover: '#1C2128',
                    text: '#C9D1D9',
                    textMuted: '#8B949E',
                    success: '#3FB950',
                    warning: '#D29922',
                    error: '#F85149',
                    info: '#58A6FF'
                }
            },
            rose: {
                name: 'Rose',
                icon: 'üå∏',
                description: 'Soft pink accent theme',
                colors: {
                    primary: '#F43F5E',
                    primaryHover: '#FB7185',
                    dark: '#18181B',
                    darker: '#09090B',
                    card: '#27272A',
                    border: '#3F3F46',
                    hover: '#2D2D33',
                    text: '#FAFAFA',
                    textMuted: '#A1A1AA',
                    success: '#22C55E',
                    warning: '#EAB308',
                    error: '#EF4444',
                    info: '#3B82F6'
                }
            },
            ocean: {
                name: 'Ocean',
                icon: 'üåä',
                description: 'Cool blue ocean vibes',
                colors: {
                    primary: '#0EA5E9',
                    primaryHover: '#38BDF8',
                    dark: '#0C1222',
                    darker: '#060A10',
                    card: '#132337',
                    border: '#1E3A5F',
                    hover: '#1A3550',
                    text: '#E2E8F0',
                    textMuted: '#94A3B8',
                    success: '#22C55E',
                    warning: '#F59E0B',
                    error: '#EF4444',
                    info: '#3B82F6'
                }
            },
            highContrast: {
                name: 'High Contrast',
                icon: '‚óê',
                description: 'Maximum visibility for accessibility',
                colors: {
                    primary: '#FFD700',
                    primaryHover: '#FFED4A',
                    dark: '#000000',
                    darker: '#000000',
                    card: '#0A0A0A',
                    border: '#FFFFFF',
                    hover: '#1A1A1A',
                    text: '#FFFFFF',
                    textMuted: '#CCCCCC',
                    success: '#00FF00',
                    warning: '#FFFF00',
                    error: '#FF0000',
                    info: '#00FFFF'
                }
            },
            // extra skins - LW wanted more variety
            dracula: {
                name: 'Dracula',
                icon: 'üßõ',
                description: 'Popular Dracula color scheme',
                colors: {
                    primary: '#BD93F9',
                    primaryHover: '#D4B8FF',
                    dark: '#282A36',
                    darker: '#1E1F29',
                    card: '#343746',
                    border: '#44475A',
                    hover: '#3D4051',
                    text: '#F8F8F2',
                    textMuted: '#6272A4',
                    success: '#50FA7B',
                    warning: '#F1FA8C',
                    error: '#FF5555',
                    info: '#8BE9FD'
                }
            },
            nord: {
                name: 'Nord',
                icon: '‚ùÑÔ∏è',
                description: 'Arctic, north-bluish color palette',
                colors: {
                    primary: '#88C0D0',
                    primaryHover: '#8FBCBB',
                    dark: '#2E3440',
                    darker: '#242933',
                    card: '#3B4252',
                    border: '#4C566A',
                    hover: '#434C5E',
                    text: '#ECEFF4',
                    textMuted: '#D8DEE9',
                    success: '#A3BE8C',
                    warning: '#EBCB8B',
                    error: '#BF616A',
                    info: '#81A1C1'
                }
            },
            monokai: {
                name: 'Monokai',
                icon: 'üé®',
                description: 'Classic code editor theme',
                colors: {
                    primary: '#F92672',
                    primaryHover: '#FF79C6',
                    dark: '#272822',
                    darker: '#1E1F1C',
                    card: '#3E3D32',
                    border: '#49483E',
                    hover: '#3E3D32',
                    text: '#F8F8F2',
                    textMuted: '#75715E',
                    success: '#A6E22E',
                    warning: '#E6DB74',
                    error: '#F92672',
                    info: '#66D9EF'
                }
            },
            matrix: {
                name: 'Matrix',
                icon: 'üíä',
                description: 'Enter the Matrix',
                colors: {
                    primary: '#00FF41',
                    primaryHover: '#00CC33',
                    dark: '#0D0208',
                    darker: '#000000',
                    card: '#0D0D0D',
                    border: '#003B00',
                    hover: '#001A00',
                    text: '#00FF41',
                    textMuted: '#008F11',
                    success: '#00FF41',
                    warning: '#ADFF2F',
                    error: '#FF0000',
                    info: '#39FF14'
                }
            },
            sunset: {
                name: 'Sunset',
                icon: 'üåÖ',
                description: 'Warm orange and purple gradients',
                colors: {
                    primary: '#FF6B35',
                    primaryHover: '#FF8C5A',
                    dark: '#1A1423',
                    darker: '#0F0A14',
                    card: '#2D2137',
                    border: '#4A3B5C',
                    hover: '#3D2F4A',
                    text: '#FFF4E6',
                    textMuted: '#B8A9C9',
                    success: '#7CB518',
                    warning: '#FFB627',
                    error: '#E63946',
                    info: '#A855F7'
                }
            },
            cyberpunk: {
                name: 'Cyberpunk',
                icon: 'ü§ñ',
                description: 'Neon lights of Night City',
                colors: {
                    primary: '#00D9FF',
                    primaryHover: '#00FFFF',
                    dark: '#0A0A0F',
                    darker: '#050508',
                    card: '#12121A',
                    border: '#FF00FF',
                    hover: '#1A1A25',
                    text: '#FFFFFF',
                    textMuted: '#8888AA',
                    success: '#00FF9F',
                    warning: '#FFFF00',
                    error: '#FF0055',
                    info: '#00D9FF'
                }
            },
            github: {
                name: 'GitHub Dark',
                icon: 'üêô',
                description: 'GitHub dark mode colors',
                colors: {
                    primary: '#238636',
                    primaryHover: '#2EA043',
                    dark: '#0D1117',
                    darker: '#010409',
                    card: '#161B22',
                    border: '#30363D',
                    hover: '#1F2428',
                    text: '#C9D1D9',
                    textMuted: '#8B949E',
                    success: '#238636',
                    warning: '#D29922',
                    error: '#F85149',
                    info: '#58A6FF'
                }
            },
            solarizedDark: {
                name: 'Solarized Dark',
                icon: 'üîÜ',
                description: 'Precision colors for machines and people',
                colors: {
                    primary: '#B58900',
                    primaryHover: '#CB4B16',
                    dark: '#002B36',
                    darker: '#001F27',
                    card: '#073642',
                    border: '#586E75',
                    hover: '#094552',
                    text: '#FDF6E3',
                    textMuted: '#93A1A1',
                    success: '#859900',
                    warning: '#B58900',
                    error: '#DC322F',
                    info: '#268BD2'
                }
            },
            gruvbox: {
                name: 'Gruvbox',
                icon: 'üì¶',
                description: 'Retro groove color scheme',
                colors: {
                    primary: '#FE8019',
                    primaryHover: '#FABD2F',
                    dark: '#1D2021',
                    darker: '#0D1011',
                    card: '#282828',
                    border: '#3C3836',
                    hover: '#32302F',
                    text: '#EBDBB2',
                    textMuted: '#A89984',
                    success: '#B8BB26',
                    warning: '#FABD2F',
                    error: '#FB4934',
                    info: '#83A598'
                }
            },
            // Corporate/Enterprise style themes
            corporateDark: {
                name: 'Corporate Dark',
                icon: 'üñ•Ô∏è',
                description: 'Modern corporate dark theme',
                colors: {
                    primary: '#1A73E8',       // Corporate blue
                    primaryHover: '#4285F4',
                    dark: '#1E1E1E',          // Dark sidebar
                    darker: '#121212',        // Darkest background
                    card: '#252525',          // Card background
                    border: '#3D3D3D',        // Subtle borders
                    hover: '#2D2D2D',         // Hover state
                    text: '#FFFFFF',
                    textMuted: '#9E9E9E',
                    success: '#34A853',
                    warning: '#FBBC04',
                    error: '#EA4335',
                    info: '#4285F4'
                }
            },
            corporateLight: {
                name: 'Corporate Light',
                icon: 'üíª',
                description: 'Modern corporate light theme',
                colors: {
                    primary: '#1A73E8',
                    primaryHover: '#1557B0',
                    dark: '#F5F5F5',
                    darker: '#FFFFFF',
                    card: '#FFFFFF',
                    border: '#DADCE0',
                    hover: '#E8EAED',
                    text: '#202124',
                    textMuted: '#5F6368',
                    success: '#137333',
                    warning: '#EA8600',
                    error: '#C5221F',
                    info: '#1967D2'
                }
            },
            enterpriseBlue: {
                name: 'Enterprise Blue',
                icon: 'üî∑',
                description: 'Classic enterprise blue theme',
                colors: {
                    primary: '#005EB8',       // Classic enterprise blue
                    primaryHover: '#0073D1',
                    dark: '#2C3E50',          // Dark blue-gray
                    darker: '#1A252F',
                    card: '#34495E',
                    border: '#4A6278',
                    hover: '#3D5266',
                    text: '#ECF0F1',
                    textMuted: '#95A5A6',
                    success: '#27AE60',
                    warning: '#F39C12',
                    error: '#E74C3C',
                    info: '#3498DB'
                }
            }
        };
        
        // Apply theme by setting CSS variables
        function applyTheme(themeName) {
            const theme = PEGAPROX_THEMES[themeName] || PEGAPROX_THEMES.proxmoxDark;
            const root = document.documentElement;
            
            Object.entries(theme.colors).forEach(([key, value]) => {
                root.style.setProperty(`--color-${key}`, value);
            });
            
            // Special handling for light theme - only if body exists
            if (document.body) {
                const lightThemes = ['proxmoxLight', 'corporateLight'];
                if (lightThemes.includes(themeName)) {
                    document.body.classList.add('light-theme');
                    document.body.classList.remove('dark-theme');
                } else {
                    document.body.classList.add('dark-theme');
                    document.body.classList.remove('light-theme');
                }
            }
            
            localStorage.setItem('pegaprox-theme', themeName);
            console.log(`Theme applied: ${theme.name}`);
        }
        
        // Load saved theme on page load - apply CSS vars immediately, body classes after DOM ready
        (function() {
            const saved = localStorage.getItem('pegaprox-theme') || 'proxmoxDark';
            // Apply CSS variables immediately (works on documentElement)
            const theme = PEGAPROX_THEMES[saved] || PEGAPROX_THEMES.proxmoxDark;
            Object.entries(theme.colors).forEach(([key, value]) => {
                document.documentElement.style.setProperty(`--color-${key}`, value);
            });
            // Apply body classes after DOM is ready
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', () => applyTheme(saved));
            } else {
                applyTheme(saved);
            }
        })();
        
        // ============================================
        // TAILWIND CONFIG
        // ============================================
        // LW: Custom Proxmox-inspired color palette
        // Now uses CSS variables for dynamic theming
        if (typeof tailwind !== 'undefined') {
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Plus Jakarta Sans', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        proxmox: {
                            // These now reference CSS variables for theme support
                            orange: 'var(--color-primary, #E57000)',
                            dark: 'var(--color-dark, #0F1419)',
                            darker: 'var(--color-darker, #080B0E)',
                            card: 'var(--color-card, #161B22)',
                            border: 'var(--color-border, #30363D)',
                            hover: 'var(--color-hover, #1C2128)',
                        },
                        // Semantic colors
                        theme: {
                            primary: 'var(--color-primary, #E57000)',
                            success: 'var(--color-success, #3FB950)',
                            warning: 'var(--color-warning, #D29922)',
                            error: 'var(--color-error, #F85149)',
                            info: 'var(--color-info, #58A6FF)',
                        }
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'gradient': 'gradient 8s ease infinite',
                        'slide-up': 'slideUp 0.5s ease-out',
                        'slide-in': 'slideIn 0.3s ease-out',
                        'fade-in': 'fadeIn 0.4s ease-out',
                        'scale-in': 'scaleIn 0.3s ease-out',
                        'glow': 'glow 2s ease-in-out infinite alternate',
                    },
                    keyframes: {
                        gradient: {
                            '0%, 100%': { backgroundPosition: '0% 50%' },
                            '50%': { backgroundPosition: '100% 50%' },
                        },
                        slideUp: {
                            '0%': { opacity: '0', transform: 'translateY(20px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        },
                        slideIn: {
                            '0%': { opacity: '0', transform: 'translateX(-10px)' },
                            '100%': { opacity: '1', transform: 'translateX(0)' },
                        },
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        scaleIn: {
                            '0%': { opacity: '0', transform: 'scale(0.95)' },
                            '100%': { opacity: '1', transform: 'scale(1)' },
                        },
                        glow: {
                            '0%': { boxShadow: '0 0 20px var(--color-primary, rgba(229, 112, 0, 0.3))' },
                            '100%': { boxShadow: '0 0 40px var(--color-primary, rgba(229, 112, 0, 0.6))' },
                        },
                    }
                }
            }
        };
        } // end if (typeof tailwind !== 'undefined')
    </script>
    <style>
        * {
            scrollbar-width: thin;
            scrollbar-color: #30363D #161B22;
        }
        *::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        *::-webkit-scrollbar-track {
            background: #161B22;
        }
        *::-webkit-scrollbar-thumb {
            background: #30363D;
            border-radius: 4px;
        }
        *::-webkit-scrollbar-thumb:hover {
            background: #484F58;
        }

        /* Global dark mode for form elements */
        input, select, textarea {
            background-color: var(--color-dark, #0F1419);
            color: var(--color-text, #E6EDF3);
            border-color: var(--color-border, #30363D);
        }
        input::placeholder, textarea::placeholder {
            color: #6B7280;
        }
        input[type="checkbox"], input[type="radio"] {
            accent-color: var(--color-primary, #E57000);
        }
        input[type="range"] {
            background: transparent;
        }
        select option {
            background-color: var(--color-dark, #0F1419);
            color: var(--color-text, #E6EDF3);
        }
        /* Fix focus outline */
        *:focus {
            outline-color: var(--color-primary, #E57000);
        }
        /* Reset potential white backgrounds */
        button, fieldset, legend {
            background-color: transparent;
        }
        hr {
            border-color: var(--color-border, #30363D);
        }
        /* GLOBAL BORDER FIX - prevent white borders from Tailwind default */
        *, *::before, *::after {
            border-color: var(--color-border, #30363D);
        }
        /* Fix table borders */
        table {
            border-collapse: collapse;
            border-spacing: 0;
            border-color: var(--color-border, #30363D);
            background-color: transparent;
        }
        tbody {
            background-color: var(--color-card, #161B22);
        }
        tr, td, th {
            border-color: var(--color-border, #30363D) !important;
            background-color: inherit;
        }
        tbody tr {
            border-color: rgba(48, 54, 61, 0.5) !important;
        }
        /* Force dark borders on all elements */
        .border-gray-700\/50 {
            border-color: rgba(55, 65, 81, 0.5) !important;
        }

        /* Gradient backgrounds */
        .gradient-mesh {
            background: 
                radial-gradient(at 40% 20%, rgba(229, 112, 0, 0.15) 0px, transparent 50%),
                radial-gradient(at 80% 0%, rgba(229, 112, 0, 0.1) 0px, transparent 50%),
                radial-gradient(at 0% 50%, rgba(229, 112, 0, 0.08) 0px, transparent 50%),
                radial-gradient(at 80% 100%, rgba(229, 112, 0, 0.05) 0px, transparent 50%);
        }

        /* Gauge styles */
        .gauge-container {
            position: relative;
            width: 120px;
            height: 120px;
        }
        .gauge-bg {
            fill: none;
            stroke: #30363D;
            stroke-width: 10;
        }
        .gauge-fill {
            fill: none;
            stroke-width: 10;
            stroke-linecap: round;
            transform: rotate(-90deg);
            transform-origin: center;
            transition: stroke-dashoffset 0.8s cubic-bezier(0.4, 0, 0.2, 1), stroke 0.3s ease;
        }
        .gauge-text {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 600;
            fill: currentColor;
        }

        /* Card hover effects */
        /* NS: removed transform because it breaks fixed modal positioning */
        .card-hover {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .card-hover:hover {
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3), 0 0 0 1px rgba(229, 112, 0, 0.2);
        }

        /* Slider styles */
        .custom-slider {
            -webkit-appearance: none;
            appearance: none;
            height: 8px;
            border-radius: 4px;
            outline: none;
            transition: all 0.2s;
            background: transparent;
        }
        .custom-slider::-webkit-slider-runnable-track {
            height: 8px;
            border-radius: 4px;
            background: transparent;
        }
        .custom-slider::-moz-range-track {
            height: 8px;
            border-radius: 4px;
            background: transparent;
        }
        .custom-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #E57000;
            cursor: grab;
            box-shadow: 0 2px 10px rgba(229, 112, 0, 0.5);
            transition: all 0.2s;
        }
        .custom-slider::-webkit-slider-thumb:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 20px rgba(229, 112, 0, 0.7);
        }
        .custom-slider::-webkit-slider-thumb:active {
            cursor: grabbing;
        }
        .custom-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #E57000;
            cursor: grab;
            border: none;
            box-shadow: 0 2px 10px rgba(229, 112, 0, 0.5);
        }

        /* Status indicator pulse */
        .status-online {
            animation: pulse-online 2s ease-in-out infinite;
        }
        @keyframes pulse-online {
            0%, 100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7); }
            50% { box-shadow: 0 0 0 8px rgba(34, 197, 94, 0); }
        }

        /* Noise texture overlay */
        .noise-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            opacity: 0.03;
            z-index: 1000;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E");
        }

        /* Modal backdrop blur */
        .modal-backdrop {
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
        }

        /* Timeline styles */
        .timeline-line {
            position: absolute;
            left: 19px;
            top: 40px;
            bottom: 0;
            width: 2px;
            background: linear-gradient(to bottom, #E57000, transparent);
        }

        /* Toggle switch */
        .toggle-switch {
            position: relative;
            width: 48px;
            height: 26px;
            background: #30363D;
            border-radius: 13px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .toggle-switch.active {
            background: #E57000;
        }
        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }
        .toggle-switch.active::after {
            left: 25px;
        }

        /* Glow effect for active elements */
        .glow-orange {
            box-shadow: 0 0 30px rgba(229, 112, 0, 0.4);
        }

        /* Table row hover */
        .table-row-hover {
            transition: all 0.2s;
        }
        .table-row-hover:hover {
            background: rgba(229, 112, 0, 0.1);
        }

        /* Notification toast */
        .toast-enter {
            animation: toastEnter 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }
        @keyframes toastEnter {
            0% { opacity: 0; transform: translateX(100%); }
            100% { opacity: 1; transform: translateX(0); }
        }

        /* Sparkline */
        .sparkline-path {
            fill: none;
            stroke: #E57000;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }
        .sparkline-area {
            fill: url(#sparklineGradient);
        }
    </style>
</head>
<body class="dark notranslate">
    <div class="noise-overlay"></div>
    
    <!-- NS: Loading screen - shows immediately while Babel compiles -->
    <div id="loading-screen" style="
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, #1a1a2e 0%, #0f0f1a 100%);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    ">
        <div style="
            width: 80px;
            height: 80px;
            border: 3px solid rgba(226, 109, 65, 0.2);
            border-top-color: #e26d41;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        "></div>
        <div style="color: #e26d41; font-size: 24px; font-weight: 600; margin-top: 24px;">
            PegaProx
        </div>
        <div style="color: #888; font-size: 14px; margin-top: 8px;">
            Loading...
        </div>
    </div>
    <style>
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
    
    <div id="root"></div>

    <script type="text/babel">
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // React Setup - LW
        // Using production build for performance
        // Babel transpiles on-the-fly (fine for our use case)
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        const { useState, useEffect, useRef, useCallback, useMemo, createContext, useContext } = React;
        
        // NS: API runs on same origin, Flask serves both frontend and API
        // This makes deployment super easy - just one process
        const API_URL = window.location.origin + '/api';
        // const API_URL = 'http://localhost:5000/api';  // local dev
        // const API_URL = 'https://pegaprox.internal/api' // old staging
        
        // NS: Central version constant - keep in sync with backend PEGAPROX_VERSION
        const PEGAPROX_VERSION = "Beta 0.6.4";
        const DEBUG = false; // set true for verbose logging

        // =====================================================
        // TRANSLATION SYSTEM
        // LW: German first because thats what we started with
        // English added later. Some keys might still be missing
        // TODO: Maybe add French/Spanish someday?
        // FIXME: some keys are definetly duplicated, cleanup needed
        // =====================================================
        const translations = {
            de: {
                // General
                loading: 'Laden...',
                save: 'Speichern',
                cancel: 'Abbrechen',
                delete: 'L√∂schen',
                edit: 'Bearbeiten',
                add: 'Hinzuf√ºgen',
                close: 'Schlie√üen',
                yes: 'Ja',
                no: 'Nein',
                ok: 'OK',  // added later
                enabled: 'Aktiviert',
                disabled: 'Deaktiviert',
                enable: 'Aktivieren',
                disable: 'Deaktivieren',
                actions: 'Aktionen',
                status: 'Status',
                name: 'Name',
                type: 'Typ',
                // type: 'Type',  // english version, remove later - LW
                online: 'Online',
                offline: 'Offline',
                running: 'L√§uft',
                stopped: 'Gestoppt',
                active: 'Aktiv',
                all: 'Alle',
                id: 'ID',
                cores: 'Kerne',
                search: 'Suche',
                searchByNameOrId: 'Suche nach Name oder ID...',
                searchAllClusters: 'Alle Cluster durchsuchen...',
                pressEnterToOpen: 'Enter dr√ºcken um zur VM zu springen',
                toggleFavorite: 'Favorit umschalten',
                results: 'Ergebnisse',
                noResults: 'Keine Ergebnisse',
                target: 'Ziel',
                source: 'Quelle',
                rules: 'Regeln',
                default: 'Standard',
                none: 'Keine',
                of: 'von',
                since: 'Seit',
                uptime: 'Betriebszeit',
                sinceStart: 'Seit Start',
                
                // Auth
                login: 'Anmelden',
                logout: 'Abmelden',
                loginTitle: 'Bei PegaProx anmelden',
                loginSubtitle: 'PegaProx Cluster Management for Proxmox VE',
                usernameLabel: 'Benutzername',
                passwordLabel: 'Passwort',
                passwordPolicyHint: 'Min. 8 Zeichen, Gro√ü-, Kleinbuchstaben & Zahl erforderlich',
                minChars: 'Min.',
                characters: 'Zeichen',
                uppercase: 'Gro√übuchstaben',
                lowercase: 'Kleinbuchstaben',
                numbers: 'Zahl',
                specialChar: 'Sonderzeichen',
                loginButton: 'Anmelden',
                loggingIn: 'Anmeldung...',
                loginError: 'Anmeldung fehlgeschlagen',
                invalidCredentials: 'Ung√ºltige Anmeldedaten',
                sessionExpired: 'Sitzung abgelaufen',
                welcomeBack: 'Willkommen zur√ºck',
                changePassword: 'Passwort √§ndern',
                currentPassword: 'Aktuelles Passwort',
                newPassword: 'Neues Passwort',
                confirmPassword: 'Passwort best√§tigen',
                passwordChanged: 'Passwort ge√§ndert',
                passwordMismatch: 'Passw√∂rter stimmen nicht √ºberein',
                userManagement: 'Benutzerverwaltung',
                users: 'Benutzer',
                addUser: 'Benutzer hinzuf√ºgen',
                editUser: 'Benutzer bearbeiten',
                deleteUser: 'Benutzer l√∂schen',
                deleteUserConfirm: 'Benutzer wirklich l√∂schen?',
                role: 'Rolle',
                roleAdmin: 'Administrator',
                roleUser: 'Benutzer',
                roleViewer: 'Betrachter',
                displayName: 'Anzeigename',
                user: 'Benutzer',
                email: 'E-Mail',
                userEnabled: 'Aktiviert',
                lastLogin: 'Letzte Anmeldung',
                never: 'Nie',
                profile: 'Profil',
                
                // PegaProx Settings
                pegaproxSettings: 'PegaProx Einstellungen',
                serverSettings: 'Server',
                networkSettings: 'Netzwerk-Einstellungen',
                domain: 'Domain',
                domainHint: '√ñffentliche Domain f√ºr den Zugriff auf PegaProx',
                port: 'Port',
                portHint: 'Standard: 5000, HTTPS typischerweise 443',
                httpRedirectPort: 'HTTP Redirect Port (zus√§tzlich)',
                httpRedirectPortHint: 'F√ºr Port 80 Redirect. -1 = aus (Standard), 0 = auto, 80 = aktiviert. HTTP auf gleichem Port wird automatisch umgeleitet.',
                sslSettings: 'SSL/TLS Zertifikat',
                enableSsl: 'SSL aktivieren',
                sslCertificate: 'SSL Zertifikat',
                sslKey: 'Privater Schl√ºssel',
                noCertSelected: 'Kein Zertifikat ausgew√§hlt',
                noKeySelected: 'Kein Schl√ºssel ausgew√§hlt',
                browse: 'Durchsuchen',
                sslWarning: 'Nach dem Aktivieren von SSL muss der Server neu gestartet werden. Stellen Sie sicher, dass Zertifikat und Schl√ºssel g√ºltig sind!',
                sslHint: 'F√ºr Let\'s Encrypt: Verwenden Sie fullchain.pem als Zertifikat und privkey.pem als Schl√ºssel.',
                saveSettings: 'Einstellungen speichern',
                serverSettingsSaved: 'Server-Einstellungen gespeichert',
                restartRequired: 'Server-Neustart erforderlich um √Ñnderungen anzuwenden',
                restartInfo: 'Hinweis zu √Ñnderungen',
                restartInfoDesc: '√Ñnderungen an Port oder SSL-Einstellungen erfordern einen Neustart des PegaProx-Servers.',
                errorSavingSettings: 'Fehler beim Speichern der Einstellungen',
                restartServer: 'Server neu starten',
                restartServerDesc: 'Startet den PegaProx-Server neu um √Ñnderungen anzuwenden',
                restartNow: 'Jetzt neu starten',
                confirmRestart: 'Server neu starten?',
                restartWarning: 'Der Server wird kurzzeitig nicht erreichbar sein',
                restartConfirmText: 'M√∂chten Sie den PegaProx-Server wirklich neu starten?',
                restartEffect1: 'Alle aktiven Verbindungen werden getrennt',
                restartEffect2: 'Die Weboberfl√§che ist f√ºr ca. 5-10 Sekunden nicht erreichbar',
                restartEffect3: 'Nicht gespeicherte √Ñnderungen gehen verloren',
                yesRestart: 'Ja, neu starten',
                restarting: 'Wird neu gestartet...',
                restartInitiated: 'Server-Neustart wurde eingeleitet',
                reconnecting: 'Verbindung wird wiederhergestellt...',
                restartFailed: 'Server-Neustart fehlgeschlagen',
                
                // Tenants & Permissions
                // Feature request from r/selfhosted - MSPs wanted multi-tenant support
                // Took a weekend to implement but people seem to like it
                tenants: 'Mandanten',
                tenant: 'Mandant',
                addTenant: 'Mandant hinzuf√ºgen',
                editTenant: 'Mandant bearbeiten',
                deleteTenant: 'Mandant l√∂schen',
                tenantSaved: 'Mandant gespeichert',
                tenantClustersHint: 'W√§hlen Sie aus, auf welche Cluster dieser Mandant zugreifen kann (leer = alle)',
                noVmsInCluster: 'Keine VMs in diesem Cluster gefunden',
                tenantsDesc: 'Mandanten erm√∂glichen die Trennung von Benutzern und die Einschr√§nkung des Zugriffs auf bestimmte Cluster.',
                tenantAutoHint: 'Wird automatisch gesetzt bei Mandanten-Rolle',
                defaultTenant: 'Standard-Mandant',
                tenantClusters: 'Cluster f√ºr diesen Mandanten',
                allClusters: 'Alle Cluster',
                
                // Cluster Groups - NS Jan 2026
                clusterGroups: 'Cluster-Gruppen',
                clusterGroup: 'Cluster-Gruppe',
                addGroup: 'Gruppe hinzuf√ºgen',
                editGroup: 'Gruppe bearbeiten',
                deleteGroup: 'Gruppe l√∂schen',
                groupName: 'Gruppenname',
                groupDescription: 'Beschreibung',
                groupColor: 'Farbe',
                assignToGroup: 'Gruppe zuweisen',
                ungrouped: 'Nicht gruppiert',
                noGroup: 'Keine Gruppe',
                removeFromGroup: 'Aus Gruppe entfernen',
                groupCreated: 'Gruppe erstellt',
                groupDeleted: 'Gruppe gel√∂scht',
                groupUpdated: 'Gruppe aktualisiert',
                manageGroups: 'Gruppen verwalten',
                clusterGroupsDesc: 'Organisieren Sie Cluster in Gruppen und weisen Sie sie Mandanten zur Zugriffskontrolle zu.',
                noGroupsYet: 'Noch keine Gruppen erstellt',
                createGroupFirst: 'Erstellen Sie zuerst eine Gruppe',
                assignTenant: 'Mandant zuweisen (optional)',
                noTenantAllVisible: 'Kein Mandant (f√ºr alle sichtbar)',
                groupTenantHint: 'Wenn zugewiesen, sieht nur dieser Mandant die Cluster in dieser Gruppe',
                groupsTip: 'Tipp: Weisen Sie Gruppen Mandanten in Einstellungen ‚Üí Cluster-Gruppen zu f√ºr Zugriffskontrolle',
                
                permissions: 'Berechtigungen',
                permission: 'Berechtigung',
                permissionsDesc: 'Konfigurieren Sie granulare Berechtigungen f√ºr Benutzer. Rollenbasierte Standardwerte k√∂nnen pro Benutzer √ºberschrieben werden.',
                selectUser: 'Benutzer ausw√§hlen',
                selectUserToEdit: 'W√§hlen Sie einen Benutzer aus, um die Berechtigungen zu bearbeiten',
                effectivePermissions: 'Effektive Berechtigungen',
                extraPermissions: 'Zus√§tzliche Berechtigungen',
                deniedPermissions: 'Verweigerte Berechtigungen',
                grantedByRole: 'Von Rolle gew√§hrt',
                permissionSaved: 'Berechtigungen gespeichert',
                tenantCreated: 'Mandant erstellt',
                tenantDeleted: 'Mandant gel√∂scht',
                tenantUpdated: 'Mandant aktualisiert',
                cannotDeleteDefaultTenant: 'Standard-Mandant kann nicht gel√∂scht werden',
                reassignUsersFirst: 'Benutzer m√ºssen zuerst neu zugewiesen werden',
                
                // Custom Roles section
                roles: 'Rollen',
                customRoles: 'Benutzerdefinierte Rollen',
                createRole: 'Rolle erstellen',
                roleId: 'Rollen-ID',
                roleName: 'Anzeigename',
                rolesDesc: 'Erstellen Sie benutzerdefinierte Rollen mit bestimmten Berechtigungen. Rollen k√∂nnen global oder mandantenspezifisch sein.',
                scope: 'Geltungsbereich',
                global: 'Global',
                roleCreated: 'Rolle erstellt',
                roleSaved: 'Rolle gespeichert',
                roleDeleted: 'Rolle gel√∂scht',
                confirmDeleteRole: 'Diese Rolle wirklich l√∂schen?',
                builtinRole: 'Eingebaute Rolle',
                tenantSpecific: 'Mandantenspezifisch',
                roleTemplates: 'Rollen-Vorlagen',
                roleTemplatesDesc: 'Schnellstart-Vorlagen f√ºr g√§ngige Rollenkonfigurationen',
                createFromTemplate: 'Aus Vorlage erstellen',
                includedPermissions: 'Enthaltene Berechtigungen',
                roleCreatedFromTemplate: 'Rolle aus Vorlage erstellt',
                vmAcl: 'VM-Zugriffskontrolle',
                vmAclDesc: 'Berechtigungen f√ºr einzelne VMs festlegen',
                addVmAcl: 'VM-Berechtigung hinzuf√ºgen',
                editVmAcl: 'VM-Berechtigung bearbeiten',
                vmPermissions: 'VM-Berechtigungen',
                noVmAcls: 'Keine VM-spezifischen Berechtigungen konfiguriert. Alle VMs folgen rollenbasierten Zugriffsrechten.',
                selectClusterFirst: 'W√§hlen Sie zuerst einen Cluster aus',
                selectVm: 'VM ausw√§hlen',
                usersWithAccess: 'Benutzer mit Zugriff',
                inheritRolePerms: 'Voller VM-Zugriff (Start, Stop, Console, etc.)',
                customPermissions: 'Benutzerdefinierte Berechtigungen',
                vmAclSaved: 'VM-Berechtigungen gespeichert',
                vmAclDeleted: 'VM-Berechtigungen entfernt',
                confirmDeleteVmAcl: 'Benutzerdefinierte Berechtigungen f√ºr diese VM entfernen?',
                
                // Pool Permissions - MK Jan 2026
                poolPermissions: 'Pool-Berechtigungen',
                poolPermissionsDesc: 'Gew√§hren Sie Benutzern oder Gruppen Zugriff auf Proxmox Resource Pools. Berechtigungen gelten f√ºr alle VMs im Pool.',
                managePools: 'Pools verwalten',
                poolManagerDesc: 'Erstellen, bearbeiten und l√∂schen Sie Resource Pools. Weisen Sie VMs zu Pools f√ºr organisierte Berechtigungsverwaltung zu.',
                createPool: 'Pool erstellen',
                editPool: 'Pool bearbeiten',
                deletePool: 'Pool l√∂schen',
                poolId: 'Pool-ID',
                poolIdRequired: 'Pool-ID ist erforderlich',
                poolIdHint: 'Nur Buchstaben, Zahlen, Bindestriche und Unterstriche',
                poolIdCannotChange: 'Pool-ID kann nicht ge√§ndert werden',
                poolCreated: 'Pool erfolgreich erstellt',
                poolUpdated: 'Pool erfolgreich aktualisiert',
                poolDeleted: 'Pool erfolgreich gel√∂scht',
                confirmDeletePool: 'Sind Sie sicher, dass Sie diesen Pool l√∂schen m√∂chten? Dies kann nicht r√ºckg√§ngig gemacht werden.',
                noPoolsYet: 'Noch keine Pools',
                createFirstPool: 'Erstellen Sie Ihren ersten Pool, um VMs zu organisieren',
                poolMembers: 'Mitglieder',
                members: 'Mitglieder',
                addVmToPool: 'VM zum Pool hinzuf√ºgen',
                removeFromPool: 'Aus Pool entfernen',
                vmAddedToPool: 'VM zum Pool hinzugef√ºgt',
                vmRemovedFromPool: 'VM aus Pool entfernt',
                confirmRemoveVmFromPool: 'VM aus diesem Pool entfernen?',
                selectVmToAdd: 'W√§hlen Sie eine VM zum Hinzuf√ºgen aus',
                allVmsInPools: 'Alle VMs sind bereits in Pools',
                optionalDescription: 'Optionale Beschreibung...',
                userPermissions: 'Benutzer-Berechtigungen',
                selectPool: 'Pool ausw√§hlen',
                noPools: 'Keine Resource Pools in diesem Cluster gefunden',
                noPoolPerms: 'Keine Berechtigungen f√ºr diesen Pool konfiguriert',
                selectPoolFirst: 'W√§hlen Sie einen Cluster und Pool zur Verwaltung',
                addPoolPerm: 'Pool-Berechtigung hinzuf√ºgen',
                editPoolPerm: 'Pool-Berechtigung bearbeiten',
                poolPermSaved: 'Pool-Berechtigung gespeichert',
                poolPermDeleted: 'Pool-Berechtigung entfernt',
                refreshPools: 'Pools von Proxmox aktualisieren',
                poolCacheRefreshed: 'Pool-Cache aktualisiert',
                confirmDeletePoolPerm: 'Berechtigung entfernen?',
                subjectType: 'Typ',
                permissionsFor: 'Berechtigungen f√ºr',
                addPermission: 'Berechtigung hinzuf√ºgen',
                groupName: 'Gruppenname',
                
                auditLog: 'Audit Log',
                auditLogDescription: 'Alle Benutzeraktionen der letzten 90 Tage',
                noAuditLogs: 'Keine Audit-Eintr√§ge vorhanden',
                action: 'Aktion',
                details: 'Details',
                timestamp: 'Zeitstempel',
                ipAddress: 'IP-Adresse',
                userCreated: 'Benutzer erstellt',
                userUpdated: 'Benutzer aktualisiert',
                userDeleted: 'Benutzer gel√∂scht',
                userLogin: 'Anmeldung',
                userLogout: 'Abmeldung',
                passwordChanged: 'Passwort ge√§ndert',
                clusterAdded: 'Cluster hinzugef√ºgt',
                apiTokenWarningTitle: 'API Token Authentifizierung',
                apiTokenWarningDesc: 'Die Verwendung von API Tokens wird unterst√ºtzt, aber nicht alle Funktionen werden korrekt funktionieren. Features die SSH-Zugriff ben√∂tigen (SMBIOS Auto-Config, Rolling Updates, 2-Node HA, Node Shell) erfordern Passwort-Authentifizierung. PegaProx empfiehlt einen dedizierten privilegierten Benutzer oder root mit Passwort f√ºr volle Funktionalit√§t.',
                clusterDeleted: 'Cluster gel√∂scht',
                clusterConfigChanged: 'Cluster-Konfiguration ge√§ndert',
                vmStarted: 'VM gestartet',
                vmStopped: 'VM gestoppt',
                vmRestarted: 'VM neu gestartet',
                vmCreated: 'VM erstellt',
                vmDeleted: 'VM gel√∂scht',
                vmCloned: 'VM geklont',
                vmMigrated: 'VM migriert',
                vmUnlocked: 'VM entsperrt',
                vmLocked: 'VM gesperrt',
                unlockVm: 'VM entsperren',
                lockReason: 'Sperrgrund',
                unlockWarning: 'Warnung: Das Entsperren einer VM w√§hrend einer aktiven Operation kann zu Datenverlust oder anderen Problemen f√ºhren. Nur fortfahren wenn die Operation fehlgeschlagen oder abgebrochen wurde.',
                vmBulkMigrated: 'Massen-Migration',
                vmConfigChanged: 'VM-Konfiguration ge√§ndert',
                vmSuspended: 'VM angehalten',
                vmResumed: 'VM fortgesetzt',
                vmDiskAdded: 'Festplatte hinzugef√ºgt',
                vmDiskRemoved: 'Festplatte entfernt',
                vmDiskResized: 'Festplatte vergr√∂√üert',
                vmDiskMoved: 'Festplatte verschoben',
                vmNetworkAdded: 'Netzwerk hinzugef√ºgt',
                vmNetworkRemoved: 'Netzwerk entfernt',
                vmNetworkUpdated: 'Netzwerk aktualisiert',
                removeDiskConfirm: 'Festplatte wirklich entfernen',
                detachDisk: 'Abklemmen',
                importDisk: 'Festplatte importieren',
                importDiskDesc: 'Vorhandenes Disk-Image von Storage importieren',
                selectImportStorage: 'Quell-Storage ausw√§hlen',
                selectDiskImage: 'Disk-Image ausw√§hlen',
                targetBus: 'Ziel-Bus',
                reassignOwner: 'Besitzer √§ndern',
                reassignOwnerDesc: 'Festplatte einer anderen VM zuweisen',
                targetVm: 'Ziel-VM',
                diskReassigned: 'Festplatte neu zugewiesen',
                diskImported: 'Festplatte importiert',
                noImportableDisks: 'Keine importierbaren Disk-Images gefunden',
                reassign: 'Neu zuweisen',
                import: 'Importieren',
                detachDiskConfirm: 'Festplatte wirklich abklemmen? Sie wird zu einer ungenutzten Festplatte.',
                diskDetached: 'Festplatte abgeklemmt',
                diskDeleted: 'Festplatte gel√∂scht',
                diskAdded: 'Festplatte hinzugef√ºgt',
                dataWillBeDeleted: 'Daten werden dauerhaft gel√∂scht!',
                removeNetworkConfirm: 'Netzwerk wirklich entfernen',
                snapshotCreated: 'Snapshot erstellt',
                snapshotDeleted: 'Snapshot gel√∂scht',
                snapshotRestored: 'Snapshot wiederhergestellt',
                rollbackConfirm: 'Wirklich zu diesem Snapshot zur√ºckrollen? Dies kann nicht r√ºckg√§ngig gemacht werden!',
                replicationCreated: 'Replikation erstellt',
                replicationDeleted: 'Replikation gel√∂scht',
                replicationTriggered: 'Replikation manuell gestartet',
                haEnabled: 'HA aktiviert',
                haDisabled: 'HA deaktiviert',
                noFallbackHosts: 'Keine Fallback-Hosts gefunden (Single-Node Cluster?)',
                haVmAdded: 'VM zu HA hinzugef√ºgt',
                haVmRemoved: 'VM aus HA entfernt',
                nodeMaintenanceEntered: 'Wartungsmodus aktiviert',
                nodeMaintenanceExited: 'Wartungsmodus beendet',
                nodeUpdateStarted: 'Node-Update gestartet',
                twoFactorAuth: '2-Faktor-Authentifizierung',
                twoFactorEnabled: '2FA aktiviert',
                twoFactorDisabled: '2FA deaktiviert',
                enable2FA: '2FA aktivieren',
                disable2FA: '2FA deaktivieren',
                setup2FA: '2FA einrichten',
                scan2FACode: 'QR-Code mit Authenticator-App scannen',
                enter2FACode: '6-stelligen Code eingeben',
                verify2FA: 'Verifizieren',
                secretKey: 'Geheimer Schl√ºssel',
                twoFARequired: '2FA-Code erforderlich',
                invalid2FACode: 'Ung√ºltiger 2FA-Code',
                resetPassword: 'Passwort zur√ºcksetzen',
                newPassword: 'Neues Passwort',
                confirmPassword: 'Passwort best√§tigen',
                currentPassword: 'Aktuelles Passwort',
                passwordsDoNotMatch: 'Passw√∂rter stimmen nicht √ºberein',
                passwordTooShort: 'Passwort muss mindestens 4 Zeichen haben',
                passwordResetSuccess: 'Passwort erfolgreich ge√§ndert',
                myProfile: 'Mein Profil',
                security: 'Sicherheit',
                snapshotNotSupported: 'Snapshots werden nicht unterst√ºtzt',
                snapshotWarnings: 'Snapshot-Warnungen',
                filterByUser: 'Nach Benutzer filtern',
                filterByAction: 'Nach Aktion filtern',
                allUsers: 'Alle Benutzer',
                allActions: 'Alle Aktionen',
                exportAuditLog: 'Exportieren',
                refreshAuditLog: 'Aktualisieren',
                
                // Header
                addCluster: 'Cluster hinzuf√ºgen',
                clusterManagement: 'PegaProx Cluster Management for Proxmox VE',
                
                // Tabs
                overview: '√úbersicht',
                resources: 'Ressourcen',
                datacenter: 'Datacenter',
                settings: 'Einstellungen',
                of: 'von',
                showing: 'Zeige',
                perPage: 'Pro Seite',
                loadingDatacenter: 'Lade Datacenter Daten...',
                
                // Cluster
                clusters: 'Cluster',
                noClusterSelected: 'Kein Cluster ausgew√§hlt',
                allClustersOverview: 'Alle Cluster √úbersicht',
                allClusters: 'Alle Cluster',
                multiClusterSummary: 'Zusammenfassung aller verwalteten Cluster',
                clustersConnected: 'Cluster verbunden',
                clusterOverview: 'Cluster √úbersicht',
                vmsRunning: 'VMs laufend',
                vmsStopped: 'VMs gestoppt',
                noClustersConfigured: 'Keine Cluster konfiguriert',
                addClusterToStart: 'F√ºge einen Cluster hinzu um zu beginnen',
                clickClusterTip: 'Klicke auf eine Cluster-Zeile oder w√§hle aus der Sidebar um Details anzuzeigen und Ressourcen zu verwalten.',
                health: 'Zustand',
                average: 'Durchschnitt',
                noDataAvailable: 'Keine Daten verf√ºgbar',
                clickToManage: 'Klicken zum Verwalten',
                sortBy: 'Sortieren nach',
                ungrouped: 'Nicht gruppiert',
                alerts: 'Warnungen',
                updated: 'Aktualisiert',
                justNow: 'gerade eben',
                topResources: 'Top Ressourcen',
                highestCpuUsage: 'H√∂chste CPU- und RAM-Auslastung √ºber alle Cluster',
                clickToOpenVm: 'Klicken um VM zu √∂ffnen',
                selectCluster: 'W√§hle einen Cluster aus der Liste aus',
                addFirstCluster: 'Ersten Cluster hinzuf√ºgen',
                connectCluster: 'Verbinde einen Proxmox Cluster mit PegaProx',
                clusterName: 'Cluster Name',
                host: 'Host',
                username: 'Benutzername',
                password: 'Passwort',
                passwordOrToken: 'Passwort / Token',
                apiTokenHint: 'F√ºr API Tokens: user@realm!tokenid',
                sslVerification: 'SSL Verifizierung',
                connecting: 'Verbinde...',
                addNewCluster: 'Neuen Cluster hinzuf√ºgen',
                testConnection: 'Verbindung testen',
                deleteCluster: 'Cluster l√∂schen',
                deleteClusterConfirm: 'Cluster wirklich l√∂schen?',
                clusterHealth: 'Cluster Gesundheit',
                excellent: 'Ausgezeichnet',
                good: 'Gut',
                warning: 'Warnung',
                critical: 'Kritisch',
                nodesOnline: 'Nodes Online',
                avgScore: 'Avg. Score',
                avgCpu: 'Avg. CPU',
                avgRam: 'Avg. RAM',
                
                // Nodes
                nodes: 'Nodes',
                node: 'Node',
                loadingMetrics: 'Lade Metriken...',
                connectionError: 'Verbindungsfehler',
                retry: 'Erneut versuchen',
                checkConnectionAndRetry: 'Bitte √ºberpr√ºfen Sie Ihre Verbindung und versuchen Sie es erneut.',
                connectionTimeout: 'Zeit√ºberschreitung - Proxmox nicht erreichbar',
                maintenance: 'Wartung',
                enterMaintenance: 'Wartungsmodus aktivieren',
                exitMaintenance: 'Wartungsmodus beenden',
                maintenanceMode: 'Wartungsmodus',
                update: 'Update',
                startUpdate: 'Update starten',
                nodeConfig: 'Node Konfiguration',
                cpuHistory: 'CPU Verlauf',
                ramHistory: 'RAM Verlauf',
                ramUsage: 'RAM Nutzung',
                cpuUsage: 'CPU Nutzung',
                diskUsage: 'Disk Nutzung',
                showMore: 'Mehr anzeigen',
                showLess: 'Weniger anzeigen',
                
                // VMs & Resources
                virtualMachines: 'Virtuelle Maschinen',
                containers: 'Container',
                vm: 'VM',
                lxc: 'LXC',
                lxcContainer: 'LXC Container',
                container: 'Container',
                guests: 'Guests',
                start: 'Starten',
                stop: 'Stoppen',
                shutdown: 'Herunterfahren',
                reboot: 'Neustarten',
                forceStop: 'Force Stop',
                forceReset: 'Force Reset',
                forceStopConfirm: 'wirklich hart ausschalten? Dies kann zu Datenverlust f√ºhren!',
                migrate: 'Migrieren',
                migrateVm: 'VM migrieren',
                crossClusterMigration: 'Cross-Cluster Migration',
                crossClusterMigrateDesc: 'VM zu anderem Proxmox-Cluster migrieren',
                crossClusterMigrate: 'Cross-Cluster migrieren',
                crossClusterStarted: 'Cross-Cluster Migration gestartet',
                crossClusterFailed: 'Cross-Cluster Migration fehlgeschlagen',
                sourceVm: 'Quell-VM',
                targetCluster: 'Ziel-Cluster',
                targetNode: 'Ziel-Node',
                targetStorage: 'Ziel-Storage',
                targetBridge: 'Ziel-Netzwerk (Bridge)',
                newVmid: 'Neue VMID (optional)',
                sameIdPlaceholder: 'Leer = gleiche ID',
                liveMigrationOption: 'Live-Migration (VM l√§uft weiter)',
                deleteSourceAfter: 'Quell-VM nach Migration l√∂schen',
                autoTokenInfo: 'PegaProx erstellt tempor√§re API-Tokens f√ºr die Migration und l√∂scht diese automatisch nach Abschluss.',
                clusterReachableInfo: 'Die Cluster m√ºssen sich gegenseitig √ºber das Netzwerk erreichen k√∂nnen. Der konfigurierte Benutzer muss Rechte zum Erstellen von API-Tokens haben.',
                selectCluster: 'Cluster ausw√§hlen...',
                selectNode: 'Node ausw√§hlen',
                selectStorage: 'Storage ausw√§hlen...',
                loadingNodes: 'Lade Ziel-Nodes...',
                loadingStorageNetwork: 'Lade Storage/Netzwerk...',
                liveMigration: 'Live-Migration (ohne Downtime)',
                on: 'auf',
                targetStorage: 'Ziel-Storage',
                sameAsSource: 'Gleich wie Quelle',
                loadingStorages: 'Lade Storages',
                free: 'frei',
                withLocalDisks: 'Mit lokalen Disks',
                withLocalDisksDesc: 'Lokale Disks zum Ziel-Storage migrieren',
                localDisksDetected: 'Diese VM hat lokale Disks. Migration erfordert Kopieren der Disk-Daten.',
                requiredForThisVm: 'Erforderlich f√ºr diese VM',
                cdDvdMounted: 'CD/DVD eingelegt',
                cdDvdMigrationWarning: 'Live-Migration ist mit eingelegter CD/DVD nicht m√∂glich. Bitte zuerst die CD/DVD auswerfen oder Offline-Migration verwenden.',
                isoMounted: 'ISO/CD-ROM eingelegt',
                isoMigrationWarning: 'Migration kann fehlschlagen wenn die ISO auf dem Ziel-Node nicht verf√ºgbar ist. CD/DVD auswerfen oder ISO auf Shared Storage sicherstellen.',
                localStorage: 'Lokal',
                bootOrderIssue: 'Boot Order Problem',
                bootOrderWarning: 'Boot Order referenziert nicht-existierende Disks',
                bootOrder: 'Boot-Reihenfolge',
                dragToReorder: 'Klicken zum Umschalten, Pfeile zum Sortieren',
                noBootDevices: 'Keine Boot-Ger√§te gefunden',
                resizeDiskHint: 'Erh√∂hen um (z.B. +10G) oder neue Gr√∂√üe',
                // SMBIOS Settings
                smbiosSettings: 'SMBIOS Einstellungen',
                smbiosHint: 'System Management BIOS - n√ºtzlich f√ºr Windows-Lizenzierung und VM-Identifikation',
                applySmbiosFromClusterConfig: 'SMBIOS-Einstellungen aus Cluster-Konfiguration anwenden',
                requiresRestart: 'NEUSTART',
                readOnly: 'schreibgesch√ºtzt',
                autoGenerated: 'auto-generiert',
                smbiosFormatHint: 'Nur Buchstaben und Zahlen erlaubt (A-Za-z0-9)',
                preview: 'Vorschau',
                currentValue: 'Aktueller Wert',
                managedByProxmox: 'von Proxmox verwaltet',
                willBeAutoGenerated: 'Wird beim Speichern automatisch generiert',
                forceConntrack: 'Force (Conntrack State)',
                forceConntrackDesc: 'Erzwingt Migration auch wenn Conntrack-Eintr√§ge existieren',
                containerNoLiveMigration: 'Container unterst√ºtzen keine echte Live-Migration',
                startingMigration: 'Starte Migration von',
                migrationStarted: 'Migration gestartet:',
                migrationFailed: 'Migration fehlgeschlagen',
                clone: 'Klonen',
                console: 'Konsole',
                config: 'Konfiguration',
                configuration: 'Konfiguration',
                createVm: 'Neue VM erstellen',
                createContainer: 'Neuen Container erstellen',
                noNodesAvailable: 'Keine Nodes verf√ºgbar. Bitte warten Sie bis die Cluster-Daten geladen sind.',
                loadingStorage: 'Lade Storage-Liste...',
                noIsoAvailable: 'Keine ISO-Images gefunden',
                noTemplateAvailable: 'Keine Templates gefunden',
                noStorageAvailable: 'Keine Storage verf√ºgbar',
                noIsoStorage: 'Kein Storage mit ISO-Inhalt gefunden',
                ram: 'RAM',
                cpu: 'CPU',
                disk: 'Disk',
                network: 'Netzwerk',
                
                // VM Creation Wizard
                node: 'Node',
                next: 'N√§chste',
                guestOs: 'Gastbetriebssystem',
                isoImage: 'ISO Image',
                noIso: 'Kein ISO',
                virtioDrivers: 'VirtIO Treiber ISO (Windows)',
                noVirtioDrivers: 'Keine VirtIO Treiber',
                allIsos: 'Alle ISOs',
                virtioDriversHint: 'Wird als zus√§tzliches CD-ROM eingebunden f√ºr Windows Treiberinstallation',
                
                // MK: New wizard translations
                advancedCpu: 'Erweiterte CPU-Einstellungen',
                cpuAffinity: 'CPU-Affinit√§t',
                cpuAffinityHint: 'VCPUs an bestimmte Host-CPUs binden',
                enableNuma: 'NUMA aktivieren',
                advancedMemory: 'Erweiterte Arbeitsspeicher-Einstellungen',
                minimumMemory: 'Minimaler Arbeitsspeicher',
                sameAsMemory: 'Gleich wie Speicher (kein Ballooning)',
                minimumMemoryHint: 'Untere Grenze f√ºr Speicher-Ballooning',
                ballooningDevice: 'Ballooning-Ger√§t',
                memoryShares: 'Speicher-Anteile',
                memorySharesHint: 'Gewichtung f√ºr automatisches Speicher-Ballooning (0-50000, Standard: 1000)',
                primaryDisk: 'Prim√§re Festplatte',
                additionalDisk: 'Zus√§tzliche Festplatte',
                addDisk: 'Festplatte hinzuf√ºgen',
                macAddress: 'MAC-Adresse',
                autoGenerate: 'Auto-generieren (leer lassen)',
                advancedNetwork: 'Erweiterte Netzwerk-Einstellungen',
                inheritBridge: 'Von Bridge erben',
                rateLimit: 'Ratenbegrenzung',
                unlimited: 'Unbegrenzt',
                noLinkOnStart: 'Keine Netzwerkverbindung beim Start',
                highAvailability: 'Hochverf√ºgbarkeit',
                enableHa: 'Zu Proxmox Native HA hinzuf√ºgen',
                haGroup: 'HA-Gruppe',
                defaultGroup: 'Standardgruppe (leer lassen)',
                rootFilesystem: 'Root-Dateisystem',
                mountPoint: 'Mount-Point',
                addMountPoint: 'Mount-Point hinzuf√ºgen',
                path: 'Pfad',
                busType: 'Bus/Typ',
                size: 'Gr√∂√üe',
                format: 'Format',
                storageDefault: 'Storage Default',
                bestPerformance: 'beste Performance',
                free: 'frei',
                bridge: 'Bridge',
                model: 'Modell',
                vlanTag: 'VLAN Tag (optional)',
                vlanExample: 'z.B. 100',
                enableFirewall: 'Firewall aktivieren',
                cpuType: 'CPU Typ',
                machineType: 'Machine Type',
                efiSettings: 'UEFI/EFI Einstellungen',
                efiDiskStorage: 'EFI Disk Storage',
                preEnrollKeys: 'Pre-enroll Microsoft Keys (SecureBoot)',
                tpmSettings: 'TPM (Trusted Platform Module)',
                enableTpm: 'TPM aktivieren',
                tpmStorage: 'TPM Storage',
                tpmVersion: 'TPM Version',
                recommended: 'empfohlen',
                win11NeedsTpm: 'Windows 11 ben√∂tigt TPM 2.0',
                efiTpmSettings: 'EFI & TPM Einstellungen',
                efiDisk: 'EFI Disk',
                tpmChip: 'TPM Chip',
                configured: 'Konfiguriert',
                noEfiDisk: 'Keine EFI Disk konfiguriert',
                addEfiDisk: 'EFI Disk hinzuf√ºgen',
                efiDiskRequired: 'Erforderlich f√ºr UEFI-Boot. Wird automatisch beim ersten Start erstellt wenn nicht konfiguriert.',
                efiDiskInfo: 'EFI Disk speichert UEFI Firmware-Variablen und ist f√ºr UEFI-Boot erforderlich. Gr√∂√üe wird automatisch auf 4MB gesetzt.',
                efiDiskAdded: 'EFI Disk hinzugef√ºgt',
                noTpm: 'Kein TPM konfiguriert',
                addTpm: 'TPM hinzuf√ºgen',
                tpmInfo: 'TPM (Trusted Platform Module) ist f√ºr Windows 11 erforderlich und bietet hardwarebasierte Sicherheitsfunktionen wie BitLocker.',
                tpmAdded: 'TPM hinzugef√ºgt',
                confirmDeleteEfiDisk: 'EFI Disk l√∂schen? Die VM startet m√∂glicherweise nicht mehr.',
                confirmDeleteTpm: 'TPM l√∂schen? Windows 11 und BitLocker funktionieren nicht mehr.',
                efiDiskDeleted: 'EFI Disk gel√∂scht',
                tpmDeleted: 'TPM gel√∂scht',
                enableQemuAgent: 'QEMU Guest Agent aktivieren',
                startOnBoot: 'Bei Host-Start automatisch starten',
                startAfterCreate: 'Nach Erstellung sofort starten',
                rootPassword: 'Root Passwort',
                sshPublicKeys: 'SSH Public Keys',
                loadSshKeyFile: 'SSH Key Datei laden',
                sshKeyHintMultiple: 'Ein Key pro Zeile. Einf√ºgen oder aus Datei laden.',
                // SSH Shell Login
                dropKeyFileHere: 'Key-Datei hier ablegen oder klicken',
                keyLoaded: 'Key geladen',
                lines: 'Zeilen',
                keyPassphrase: 'Key Passphrase',
                optional: 'optional',
                ifKeyEncrypted: 'Falls Key verschl√ºsselt ist...',
                connect: 'Verbinden',
                dnsDomain: 'DNS Domain',
                dnsServers: 'DNS Server',
                useHostSettings: 'Host-Einstellungen verwenden',
                dnsServersHint: 'Leerzeichen-getrennte Liste von DNS Servern',
                disconnected: 'Getrennt',
                manual: 'Manuell',
                ipAddress: 'IP Adresse',
                recommended: 'empfohlen',
                dockerSupport: 'Docker Support',
                free: 'frei',
                used: 'belegt',
                total: 'gesamt',
                selectTemplate: 'Template w√§hlen...',
                cpuCoresLabel: 'CPU Kerne',
                swapMemory: 'Swap (MB)',
                unprivileged: 'Unprivilegiert',
                unprivilegedHint: 'Sicherer, aber eingeschr√§nkte Funktionalit√§t',
                nesting: 'Nesting',
                nestingHint: 'Erm√∂glicht Docker/LXC in LXC',
                ipConfig: 'IP Konfiguration',
                useDhcp: 'DHCP verwenden',
                gateway: 'Gateway',
                lvmZfsIgnoreFormat: 'LVM/ZFS ignorieren Format',
                targetNode: 'Ziel-Node',
                sameNode: 'selber Node',
                crossNodeCloneWarning: 'Cross-Node Clone ben√∂tigt Shared Storage (NFS, Ceph, etc.). Lokaler Storage funktioniert nicht!',
                willBeCloned: 'wird geklont',
                newVmId: 'Neue VM ID',
                cloneMode: 'Clone-Modus',
                fullClone: 'Full Clone',
                fullCloneDesc: 'Unabh√§ngige Kopie aller Daten',
                linkedClone: 'Linked Clone',
                linkedCloneDesc: 'Schneller, ben√∂tigt Basis-Image',
                onlyForVms: 'Nur f√ºr VMs verf√ºgbar',
                cloneNotes: 'Notizen zum Clone...',
                optional: 'optional',
                
                gridView: 'Kachelansicht',
                listView: 'Listenansicht',
                compactView: 'Kompaktansicht',
                selectAll: 'Alle ausw√§hlen',
                deselectAll: 'Auswahl aufheben',
                selectedItems: 'ausgew√§hlt',
                bulkActions: 'Massenaktionen',
                quickActions: 'Schnellaktionen',
                moreActions: 'Weitere Aktionen',
                xOfYResources: 'von',
                resourcesLabel: 'Ressourcen Verwaltung',
                startClone: 'Klonen starten',
                vmStillRunning: 'Die VM l√§uft noch. Sie wird vor dem L√∂schen gestoppt.',
                ctStillRunning: 'Der Container l√§uft noch. Er wird vor dem L√∂schen gestoppt.',
                confirmDelete: 'L√∂schen best√§tigen',
                reallyDelete: 'Wirklich l√∂schen?',
                connectionFailed: 'Verbindung fehlgeschlagen',
                cloneFailed: 'Clone fehlgeschlagen',
                forceStopFailed: 'Force Stop fehlgeschlagen',
                bulkMigrationFailed: 'Bulk-Migration fehlgeschlagen',
                bulkMigration: 'Bulk-Migration',
                vmsSelected: 'VMs ausgew√§hlt',
                targetNode: 'Ziel-Node',
                selectNode: 'Node ausw√§hlen...',
                liveMigration: 'Live-Migration (ohne Downtime)',
                migrateVms: 'VMs migrieren',
                startingBulkMigration: 'Starte Bulk-Migration von',
                creationFailed: 'Erstellung fehlgeschlagen',
                actionFailed: 'Aktion fehlgeschlagen',
                autoDetectionFailed: 'Auto-Erkennung fehlgeschlagen',
                clusterOffline: 'Cluster nicht erreichbar',
                connectionClosed: 'Verbindung beendet',
                unexpectedDisconnect: 'Verbindung unerwartet getrennt',
                serverError: 'Server-Fehler',
                switchTabToReconnect: 'Tab wechseln und zur√ºck um neu zu verbinden',
                deleteInterfaceConfirm: 'Interface wirklich l√∂schen?',
                noMigrationsYet: 'Noch keine Migrationen',
                showMore: 'Alle anzeigen',
                showLess: 'Weniger anzeigen',
                olderMigrations: '√§ltere Migrationen',
                paused: 'Pausiert',
                performanceMetrics: 'Performance-Metriken',
                hour: 'Stunde',
                day: 'Tag',
                week: 'Woche',
                month: 'Monat',
                year: 'Jahr',
                
                // Detail View
                hostname: 'Hostname',
                tags: 'Tags',
                description: 'Beschreibung',
                changesRequireRestart: 'Hinweis: Manche √Ñnderungen erfordern einen Neustart',
                
                // Tags - NS Jan 2026
                manageTags: 'Tags verwalten',
                noTags: 'Keine Tags',
                newTag: 'Neuer Tag...',
                existingTags: 'Vorhandene Tags',
                
                // Schedules - MK Jan 2026
                schedules: 'Zeitpl√§ne',
                scheduledActions: 'Geplante Aktionen',
                newSchedule: 'Neuer Zeitplan',
                editSchedule: 'Zeitplan bearbeiten',
                noSchedules: 'Keine geplanten Aktionen',
                noSchedulesDesc: 'Erstelle Zeitpl√§ne um VMs automatisch zu starten, stoppen oder zu snapshotten',
                createFirstSchedule: 'Ersten Zeitplan erstellen',
                scheduleCreated: 'Zeitplan erstellt',
                scheduleDeleted: 'Zeitplan gel√∂scht',
                scheduleType: 'Zeitplan-Typ',
                daily: 'T√§glich',
                weekdays: 'Wochentags',
                weekends: 'Wochenende',
                weekly: 'W√∂chentlich',
                once: 'Einmalig',
                forOnce: 'f√ºr einmalig',
                forWeekly: 'f√ºr w√∂chentlich',
                days: 'Tage',
                lastRun: 'Letzter Lauf',
                
                // Reports - NS Jan 2026
                reports: 'Berichte',
                reportsAnalytics: 'Berichte & Analysen',
                lastHour: 'Letzte Stunde',
                last24h: 'Letzte 24h',
                lastWeek: 'Letzte Woche',
                noReportData: 'Keine Berichtsdaten',
                noReportDataDesc: 'Historische Daten werden gesammelt. Schau in ein paar Minuten wieder vorbei.',
                topVmsCpu: 'H√∂chste CPU-Auslastung',
                topVmsMem: 'H√∂chste Speicher-Auslastung',
                historicalRange: 'Historischer Bereich',
                dataPoints: 'Datenpunkte',
                vmsRunning: 'VMs laufend',
                containersRunning: 'Container laufend',
                clustersOnline: 'Cluster online',
                nodesOnline: 'Nodes online',
                datacenterOverview: 'Datacenter √úbersicht',
                noRunningVms: 'Keine laufenden VMs',
                
                // Automation Tab - NS Jan 2026
                automation: 'Automatisierung',
                schedulesDesc: 'VMs automatisch starten, stoppen, neustarten oder snapshotten',
                tagsDesc: 'VMs mit Tags organisieren. Klicke auf das Tag-Symbol bei einer VM.',
                noTagsInCluster: 'Keine Tags in diesem Cluster',
                addTagHint: 'Nutze den Tag-Button bei VMs im Ressourcen-Tab',
                tagsTotal: 'Tags',
                clickVmTag: 'Klicke auf Tag-Symbol bei VMs zum Verwalten',
                alertsDesc: 'Benachrichtigungen wenn Ressourcen Schwellwerte √ºberschreiten',
                newAlert: 'Neuer Alarm',
                noAlertsCluster: 'Keine Alarme f√ºr diesen Cluster',
                alertCreated: 'Alarm erstellt',
                targetType: 'Anwenden auf',
                entireCluster: 'Gesamter Cluster',
                specificNode: 'Bestimmter Node',
                specificVm: 'Bestimmte VM',
                targetId: 'Ziel',
                optional: 'optional',
                condition: 'Bedingung',
                cluster: 'Cluster',
                affinityDesc: 'VMs zusammen oder getrennt auf Nodes halten',
                newRule: 'Neue Regel',
                noAffinityCluster: 'Keine Affinit√§tsregeln f√ºr diesen Cluster',
                ruleCreated: 'Regel erstellt',
                together: 'Zusammen',
                separate: 'Getrennt',
                enforced: 'Erzwungen',
                
                // Config Modal Tabs
                generalTab: 'Allgemein',
                resourcesTab: 'Ressourcen',
                storageTab: 'Storage',
                networkTab: 'Netzwerk',
                snapshotsTab: 'Snapshots',
                backupsTab: 'Backups',
                replicationTab: 'Replication',
                historyTab: 'Verlauf',
                proxmoxTasks: 'Proxmox Tasks',
                pegaproxActions: 'PegaProx Aktionen',
                optionsTab: 'Optionen',
                
                // Datacenter
                summary: 'Zusammenfassung',
                cluster: 'Cluster',
                options: 'Optionen',
                storage: 'Storage',
                backup: 'Backup',
                replication: 'Replikation',
                balancing: 'Balancing',
                excludedNodes: 'Ausgeschlossene Nodes',
                excludedNodesDesc: 'Diese Nodes werden niemals als Ziel f√ºr automatisches VM-Balancing oder Migrationsempfehlungen verwendet.',
                selectNodeToExclude: 'Node zum Ausschlie√üen w√§hlen...',
                exclude: 'Ausschlie√üen',
                excludedFromBalancing: 'Vom Balancing ausgeschlossen',
                reincludedInBalancing: 'wieder ins Balancing aufgenommen',
                excludeNode: 'Node vom Balancing ausschlie√üen',
                noExcludedNodes: 'Keine Nodes ausgeschlossen - alle Nodes nehmen am Balancing teil',
                confirmExcludeNode: 'Ausschlie√üen',
                excludedVMs: 'Ausgeschlossene VMs',
                excludedVMsDesc: 'Diese VMs werden niemals automatisch w√§hrend des Load Balancing migriert.',
                selectVMToExclude: 'VM zum Ausschlie√üen w√§hlen...',
                noExcludedVMs: 'Keine VMs ausgeschlossen - alle VMs nehmen am Balancing teil',
                fromBalancing: 'vom Balancing',
                allNodesExcluded: 'Alle Nodes sind ausgeschlossen - Balancing ist effektiv deaktiviert',
                howExclusionWorks: 'Wie Node-Ausschluss funktioniert',
                exclusionRule1: 'Ausgeschlossene Nodes werden NICHT als Ziel f√ºr automatisches VM-Balancing verwendet',
                exclusionRule2: 'Ausgeschlossene Nodes erhalten keine VMs w√§hrend Load-Balancing-Migrationen',
                exclusionRule3: 'Ausgeschlossene Nodes sind weiterhin sichtbar und k√∂nnen manuelle Migrationen empfangen',
                exclusionRule4: 'VMs auf ausgeschlossenen Nodes k√∂nnen trotzdem migriert werden, wenn der Node √ºberlastet ist',
                
                // NS: Backup translations - Dec 2025
                createBackup: 'Backup erstellen',
                noBackups: 'Keine Backups gefunden',
                noBackupsHint: 'Erstellen Sie ein Backup oder pr√ºfen Sie die Backup-Storages',
                backupMode: 'Backup-Modus',
                compression: 'Kompression',
                backupStarted: 'Backup gestartet',
                downloadStarted: 'Download gestartet',
                downloadFailed: 'Download fehlgeschlagen',
                restoreBackup: 'Backup wiederherstellen',
                selectedBackup: 'Ausgew√§hltes Backup',
                targetVmid: 'Ziel VMID',
                targetStorage: 'Ziel-Storage',
                originalStorage: 'Original beibehalten',
                sameVmidWarning: 'Gleiche VMID = VM wird √ºberschrieben!',
                startAfterRestore: 'Nach Wiederherstellung starten',
                confirmRestore: 'Backup wirklich wiederherstellen?',
                restoreStarted: 'Wiederherstellung gestartet',
                confirmDeleteBackup: 'Backup wirklich l√∂schen?',
                backupDeleted: 'Backup gel√∂scht',
                // LW: backup mode options
                backupModeSnapshot: 'Snapshot (kein Stopp)',
                backupModeSuspend: 'Suspend (kurzer Stopp)',
                backupModeStop: 'Stop (VM wird gestoppt)',
                compressZstd: 'ZSTD (empfohlen)',
                compressLzo: 'LZO (schnell)',
                compressGzip: 'GZIP',
                compressNone: 'Keine',
                backupNotes: 'Notizen (optional)',
                backupNotesPlaceholder: 'z.B. Vor gro√üem Update, w√∂chentliches Backup...',
                
                // HA
                ha: 'HA',
                haResources: 'HA Ressourcen',
                haGroups: 'HA Gruppen',
                haStatus: 'HA Status',
                
                cpuCompatibility: 'CPU Kompatibilit√§t',
                cpuCompatibilityMode: 'CPU Kompatibilit√§tsmodus',
                cpuCompatibilityDesc: 'Stellt Live-Migration Kompatibilit√§t zwischen verschiedenen CPU-Generationen sicher',
                whatIsCpuCompat: 'Was ist der CPU Kompatibilit√§tsmodus?',
                cpuCompatExplain: 'Wenn Sie Nodes mit unterschiedlichen CPU-Generationen haben (z.B. Haswell und Skylake), kann die Live-Migration fehlschlagen, da neuere CPUs Funktionen haben die √§ltere nicht unterst√ºtzen.',
                cpuCompatSolution: 'Durch das Setzen eines gemeinsamen CPU-Typs f√ºr alle VMs stellen Sie sicher, dass diese zwischen allen Nodes im Cluster migriert werden k√∂nnen.',
                recommendedSettings: 'Empfohlene Einstellungen',
                broadCompatibility: 'Breite Kompatibilit√§t - funktioniert mit den meisten CPUs ab 2008',
                modern: 'Modern',
                haswell: 'Haswell und neuer (ab 2013)',
                newest: 'Neueste',
                skylakeAvx: 'Skylake-X mit AVX-512 (ab 2017)',
                noMigration: 'Keine Migration',
                hostDesc: 'Host-CPU durchreichen - beste Performance, keine Migration',
                nodesCpuInfo: 'CPU-Information der Cluster-Nodes',
                howToApply: 'So wenden Sie es an',
                cpuStep1: 'Gehen Sie zum Hardware-Tab jeder VM',
                cpuStep2: 'Bearbeiten Sie die CPU-Einstellung',
                cpuStep3: '√Ñndern Sie "Type" auf Ihr gew√§hltes Kompatibilit√§tslevel',
                cpuStep4: 'Starten Sie die VM neu damit die √Ñnderungen wirksam werden',
                autoDetectedRecommendation: 'Automatisch erkannte Empfehlung',
                basedOnClusterCpus: 'Basierend auf den erkannten CPUs in Ihrem Cluster empfehlen wir:',
                availableLevels: 'Verf√ºgbare Kompatibilit√§tsstufen',
                safest: 'Sicherste',
                detectedClusterCpus: 'Erkannte Cluster-CPUs',
                loadingCpuInfo: 'Lade CPU-Informationen...',
                copy: 'Kopieren',
                criticalAlert: 'KRITISCHER ALARM',
                haRecoveryMayStart: 'HA-Wiederherstellung l√§uft m√∂glicherweise...',
                dismiss: 'Verwerfen',
                nodeOffline: 'Node offline',
                nodeOnline: 'Node online',
                nodeUnreachable: 'Node nicht erreichbar',
                offlineSince: 'Offline seit',
                firewall: 'Firewall',
                smbiosAuto: 'SMBIOS Auto',
                smbiosAutoDesc: 'Konfiguriert automatisch SMBIOS-Daten (Hersteller, Produkt, Seriennummer) f√ºr neue VMs und VMs ohne SMBIOS-Konfiguration. N√ºtzlich f√ºr Windows-Lizenzierung.',
                deploySmbiosConfirm: 'SMBIOS Auto-Config auf alle Nodes in diesem Cluster deployen?',
                rescanAllVms: 'Alle VMs neu scannen',
                showLogs: 'Logs anzeigen',
                deployToAllNodes: 'Auf alle Nodes deployen',
                updateAllNodes: 'Alle Nodes aktualisieren',
                nodeStatus: 'Node-Status',
                clickDeployToStart: 'Klicke "Auf alle Nodes deployen" um zu starten',
                smbiosRequiresSSH: '‚ö†Ô∏è Ben√∂tigt SSH-Key in den Cluster-Verbindungseinstellungen',
                whySSH: 'Warum SSH?',
                smbiosSSHExplanation: 'Dieses Feature verwendet SSH um Hook-Skripte auf den Nodes zu installieren. SSH-Credentials k√∂nnen optional in den Cluster-Einstellungen konfiguriert werden.',
                deployed: 'Deployed',
                notDeployed: 'Nicht deployed',
                requiresSSH: 'Ben√∂tigt SSH',
                deploymentFailed: 'Deployment fehlgeschlagen',
                clusterNodes: 'Cluster Nodes',
                joinInformation: 'Join Information',
                datacenterOptions: 'Datacenter Optionen',
                quorate: 'Quorate',
                votes: 'Stimmen',
                link: 'Link',
                resourceUsage: 'Ressourcennutzung',
                memory: 'Speicher',
                
                // Storage
                addStorage: 'Storage hinzuf√ºgen',
                storageId: 'Storage ID',
                directory: 'Verzeichnis',
                path: 'Pfad',
                server: 'Server',
                content: 'Inhalt',
                shared: 'Geteilt',
                deleteStorageConfirm: 'Storage wirklich l√∂schen?',
                deleteBackupJobConfirm: 'Backup Job wirklich l√∂schen?',
                storageType: 'Storage Typ',
                volumeGroup: 'Volume Group',
                thinPool: 'Thin Pool',
                export: 'Export',
                share: 'Share',
                datastore: 'Datastore',
                pool: 'Pool',
                portal: 'Portal',
                skipCertVerification: 'Zertifikatspr√ºfung √ºberspringen',
                
                // Backup
                backupJobs: 'Backup Jobs',
                noBackupJobs: 'Keine Backup Jobs',
                createBackupJob: 'Backup Job erstellen',
                selectStorage: 'Storage ausw√§hlen',
                allNodes: 'Alle Nodes',
                hourly: 'St√ºndlich',
                daily: 'T√§glich (02:00)',
                weekly: 'W√∂chentlich (Sonntag 02:00)',
                monthly: 'Monatlich (1. des Monats 02:00)',
                compression: 'Komprimierung',
                notification: 'Benachrichtigung',
                always: 'Immer',
                onFailure: 'Bei Fehler',
                never: 'Nie',
                schedule: 'Zeitplan',
                selection: 'Auswahl',
                retention: 'Aufbewahrung',
                
                // Replication
                replicationJobs: 'Replikationsjobs',
                noReplicationJobs: 'Keine Replikationsjobs',
                guest: 'Guest',
                job: 'Job',
                
                // Firewall
                firewallOptions: 'Firewall Optionen',
                firewallRules: 'Firewall Regeln',
                noFirewallRules: 'Keine Firewall Regeln',
                policyIn: 'Policy In',
                policyOut: 'Policy Out',
                addRule: 'Regel hinzuf√ºgen',
                deleteRuleConfirm: 'Regel wirklich l√∂schen?',
                action: 'Aktion',
                protocol: 'Protokoll',
                
                // Settings
                balancingConfig: 'Balancing Konfiguration',
                migrationThreshold: 'Migration Threshold',
                migrationThresholdDesc: 'Score-Differenz ab der eine Migration ausgel√∂st wird',
                checkInterval: 'Check Intervall',
                checkIntervalDesc: 'Intervall zwischen Balance-Checks',
                autoMigrate: 'Automatische Migration',
                autoMigrateDesc: 'Automatische VM-Migration bei Ungleichgewicht',
                dryRun: 'Dry Run Modus (keine echten Migrationen)',
                dryRunShort: 'Dry Run',
                dryRunDesc: 'Migrationen nur simulieren, nicht ausf√ºhren',
                balancingEnabled: 'Balancing aktiviert',
                optionsTitle: 'Optionen',
                intervalBetweenChecks: 'Intervall zwischen Balance-Checks',
                
                // HA
                highAvailability: 'High Availability (HA)',
                haEnabled: 'High Availability aktiviert',
                haMonitoring: 'HA Monitoring',
                haMonitorActive: 'HA Monitor aktiv',
                fallbackHosts: 'Fallback Hosts',
                fallbackHostsAuto: 'Fallback Hosts (automatisch erkannt)',
                proxmoxHa: 'Proxmox HA',
                proxmoxNativeHa: 'Proxmox Native HA',
                haGroups: 'HA Gruppen',
                haResources: 'HA Ressourcen',
                fencing: 'Fencing',
                haInactive: 'Proxmox HA inaktiv',
                haActivate: 'HA aktivieren',
                enableNativeHa: 'Natives Proxmox HA f√ºr diese VM aktivieren',
                haMonitorDesc: '√úberwacht Nodes alle 10 Sekunden. Bei Ausfall werden VMs automatisch auf anderen Nodes neu gestartet.',
                nativeHaDesc: 'Das native Proxmox HA l√§uft direkt auf dem Cluster und bietet Fencing & Quorum.',
                vmsWithHa: 'VMs/CTs mit Proxmox HA',
                noVmsWithHa: 'Keine VMs mit Proxmox HA konfiguriert. Aktiviere HA f√ºr einzelne VMs in der Detail-Ansicht.',
                removeFromHa: 'Aus HA entfernen',
                deleteCannotBeUndone: 'Diese Aktion kann nicht r√ºckg√§ngig gemacht werden!',
                purgeDisks: 'Purge - Alle Disks komplett l√∂schen',
                destroyUnreferencedDisks: 'Nicht-referenzierte Disks l√∂schen',
                enterToConfirm: 'Eingeben um zu best√§tigen',
                deletePermanently: 'Endg√ºltig l√∂schen',
                updateNode: 'Node aktualisieren',
                updateCommand: 'Es wird apt update && apt dist-upgrade ausgef√ºhrt.',
                rebootAfterUpdate: 'Nach Update neustarten',
                recommendedForKernel: 'Empfohlen f√ºr Kernel-Updates',
                startUpdate: 'Update starten',
                started: 'gestartet',
                stopped: 'gestoppt',
                restarted: 'neu gestartet',
                created: 'erstellt',
                deleted: 'gel√∂scht',
                cloned: 'geklont',
                migrated: 'migriert',
                vmStillRunning: 'Die VM l√§uft noch. Sie wird vor dem L√∂schen gestoppt.',
                ctStillRunning: 'Der Container l√§uft noch. Er wird vor dem L√∂schen gestoppt.',
                primary: 'Primary',
                fallbacks: 'Fallbacks',
                
                // Messages
                connectionError: 'Verbindungsfehler',
                
                // Task Bar
                tasks: 'Tasks',
                taskMigrate: 'Migration',
                taskStart: 'Starten',
                taskStop: 'Stoppen',
                taskReboot: 'Neustart',
                taskCreate: 'Erstellen',
                taskDelete: 'L√∂schen',
                taskClone: 'Klonen',
                taskSnapshot: 'Snapshot',
                taskDiskMove: 'Disk verschieben',
                taskDiskResize: 'Disk vergr√∂√üern',
                taskFailed: 'Task fehlgeschlagen',
                taskCancelled: 'Task abgebrochen',
                taskCancelFailed: 'Task konnte nicht abgebrochen werden',
                cancelTask: 'Task abbrechen',
                allTasks: 'Alle Tasks',
                runningTasks: 'Laufende Tasks',
                failedTasks: 'Fehlgeschlagene Tasks',
                todaysTasks: 'Heutige Tasks',
                tasksShown: 'Tasks angezeigt',
                taskOutput: 'Task-Ausgabe',
                errorLoadingLog: 'Fehler beim Laden des Logs',
                duration: 'Dauer',
                description: 'Beschreibung',
                clearCompleted: 'Abgeschlossene l√∂schen',
                startTime: 'Startzeit',
                endTime: 'Endzeit',
                output: 'Ausgabe',
                noOutput: 'Keine Ausgabe',
                noTasks: 'Keine Tasks vorhanden',
                completed: 'abgeschlossen',
                success: 'Erfolgreich',
                error: 'Fehler',
                unsavedChanges: 'Ungespeicherte √Ñnderungen',
                migrationStarted: 'Migration gestartet',
                configSaved: 'Konfiguration gespeichert',
                operationFailed: 'Operation fehlgeschlagen',
                confirmAction: 'Aktion best√§tigen',
                
                // Misc
                lastCheck: 'Letzter Check',
                clusterInfo: 'Cluster Info',
                primaryHost: 'Primary Host',
                connectedTo: 'Verbunden mit',
                fallback: 'Fallback',
                configured: 'konfiguriert',
                noRestrictions: 'Keine Einschr√§nkungen',
                general: 'Allgemein',
                advanced: 'Erweitert',
                os: 'Betriebssystem',
                template: 'Template',
                help: 'Hilfe',
                lastMigrations: 'Letzte Migrationen',
                noMigrations: 'Keine Migrationen',
                
                // Options labels
                keyboardLayout: 'Tastaturlayout',
                httpProxy: 'HTTP Proxy',
                consoleViewer: 'Konsole Viewer',
                emailFrom: 'E-Mail Absender',
                macPrefix: 'MAC Pr√§fix',
                migrationSettings: 'Migrations-Einstellungen',
                replicationSettings: 'Replikations-Einstellungen',
                haSettings: 'HA Einstellungen',
                haSettingsSaved: 'HA-Einstellungen gespeichert',
                haEnabled: 'HA aktiviert',
                haDisabled: 'HA deaktiviert',
                haActive: 'HA Aktiv',
                haInactive: 'HA Inaktiv',
                clusterType: 'Cluster-Typ',
                quorum: 'Quorum',
                quorumYes: 'Ja',
                quorumNo: 'Nein',
                healthy: 'Gesund',
                degraded: 'Degraded',
                critical: 'Kritisch',
                splitBrainPrevention: 'Split-Brain Pr√§vention',
                splitBrainInfo: 'Bei 2-Node Clustern kann es zu "Split-Brain" kommen wenn beide Nodes denken der andere ist tot. Die Quorum-Hosts werden gepingt um zu entscheiden welcher Node handeln darf.',
                splitBrainTip: 'Verwende IPs die beide Nodes erreichen k√∂nnen (Gateway, DNS-Server, oder externe IPs). F√ºr interne Netze ohne Internet: Nutze deinen Router/Gateway als Quorum-Host.',
                quorumSettings: 'Quorum Einstellungen',
                enableQuorumCheck: 'Quorum-Check aktivieren',
                quorumCheckDesc: 'Verhindert Split-Brain durch externe Erreichbarkeitspr√ºfung',
                gatewayIp: 'Gateway IP',
                gatewayIpHint: 'Dein Router/Gateway f√ºr lokale Netze',
                requiredVotes: 'Ben√∂tigte Stimmen',
                additionalQuorumHosts: 'Zus√§tzliche Quorum-Hosts (kommagetrennt)',
                quorumHostsHint: 'F√ºr isolierte Netze: Eigene DNS-Server, Router, oder andere stabile Hosts im Netzwerk',
                selfFencingRecovery: 'Self-Fencing & Recovery',
                selfFencing: 'Self-Fencing',
                selfFencingDesc: 'Node ohne Quorum startet keine VMs',
                networkCheck: 'Netzwerk-Check',
                networkCheckDesc: 'Pr√ºft Konnektivit√§t vor Recovery',
                recoveryDelay: 'Recovery Verz√∂gerung (Sekunden)',
                recoveryDelayHint: 'Wartezeit bevor VMs auf anderem Node gestartet werden',
                failureThreshold: 'Fehler-Schwelle',
                failureThresholdHint: 'Anzahl fehlgeschlagener Checks bevor Node als offline gilt',
                hardwareWatchdog: 'Hardware Watchdog',
                watchdogWarning: 'VORSICHT: Node rebootet automatisch bei Quorum-Verlust!',
                
                // Fencing Explanation - NS Jan 2026
                fencingExplanation: 'Wie Split-Brain verhindert wird',
                fencingStep1Title: '1. Quorum-Verlust Erkennung',
                fencingStep1Desc: 'Der isolierte Node verliert Quorum (< 50% Stimmen) und /etc/pve wird READ-ONLY. Der pve-ha-lrm stoppt automatisch alle HA-VMs.',
                fencingStep2Title: '2. Self-Fencing (Selbst-Isolation)',
                fencingStep2Desc: 'Der Node erkennt dass er isoliert ist und verweigert VM-Operationen. So k√∂nnen keine 2 Instanzen derselben VM gleichzeitig laufen.',
                fencingStep3Title: '3. Watchdog (Hardware-Timer)',
                fencingStep3Desc: 'Falls aktiviert: Ein Hardware/Software-Timer wird regelm√§√üig zur√ºckgesetzt. Bei Quorum-Verlust stoppt das Zur√ºcksetzen und der Node wird nach ~60s hart rebootet.',
                fencingStep4Title: '4. External Fencing (STONITH)',
                fencingStep4Desc: 'Optionale Hardware: IPMI/iLO/iDRAC oder PDU schaltet den Node garantiert stromlos bevor VMs auf anderem Node gestartet werden.',
                fencingWarning: 'WICHTIG: Ohne Fencing-Mechanismus kann Split-Brain zu Datenkorruption f√ºhren!',
                fencingRecommendation: 'Empfehlung f√ºr 2-Node Cluster:',
                fencingRecList: '‚Ä¢ Quorum-Hosts konfigurieren (Gateway, DNS-Server)\n‚Ä¢ Hardware Watchdog aktivieren wenn verf√ºgbar\n‚Ä¢ Recovery-Delay auf mindestens 30 Sekunden setzen',
                
                enableHA: 'HA Aktivieren',
                disableHA: 'HA Deaktivieren',
                changesAfterRestart: '√Ñnderungen nach Neustart aktiv',
                important2NodeCluster: 'wichtig f√ºr 2-Node Cluster!',
                online: 'Online',
                
                // 2-Node Cluster Mode - NS Jan 2026
                twoNodeMode: '2-Node Cluster Modus',
                twoNodeWarning: '2-Node Cluster Limitierung',
                twoNodeExplanation: 'In einem 2-Node Proxmox Cluster verliert der √ºberlebende Node das Quorum wenn ein Node ausf√§llt und kann keine VMs starten. Dieser Modus erlaubt PegaProx automatisch das Quorum auf dem √ºberlebenden Node zu erzwingen.',
                enableTwoNodeMode: '2-Node Cluster Modus aktivieren',
                enableTwoNodeModeDesc: 'Quorum automatisch erzwingen wenn ein Node ausf√§llt',
                twoNodeReady: 'Bereit f√ºr 2-Node HA',
                twoNodeCredentialsInfo: 'PegaProx verwendet die Cluster-Zugangsdaten um sich per SSH auf den √ºberlebenden Node zu verbinden und "pvecm expected 1" auszuf√ºhren.',
                twoNodeTip: 'Tipp',
                twoNodeTipText: 'F√ºr beste Ergebnisse installiere "sshpass" auf dem PegaProx Server: apt install sshpass',
                
                // Split-Brain Risk - 2-Node - NS Jan 2026
                splitBrainRisk: 'Split-Brain Risiko ohne Fencing!',
                splitBrainRiskDesc: 'Wenn beide Nodes leben aber das Netzwerk dazwischen ausf√§llt, kann das Erzwingen von Quorum dazu f√ºhren dass BEIDE Nodes dieselbe VM starten = Datenkorruption!',
                safeSolutions: 'Sichere L√∂sungen f√ºr 2-Node Cluster:',
                qdeviceDesc: 'F√ºge eine 3. Stimme hinzu (Raspberry Pi reicht!)',
                ipmiDesc: 'Anderen Node ausschalten vor Recovery',
                pduDesc: 'Smarte Steckdosenleiste f√ºr Remote-Stromabschaltung',
                quorumHostsDesc2: 'Externe IPs um zu bestimmen welcher Node isoliert ist',
                safetyChecklist: 'Sicherheits-Checkliste',
                quorumHostsConfigured: 'Quorum-Hosts konfiguriert',
                recoveryDelayCheck: 'Recovery-Verz√∂gerung ‚â• 30 Sekunden',
                selfFencingEnabled: 'Self-Fencing aktiviert',
                
                // Storage-based Split-Brain Protection - NS Jan 2026
                storageHeartbeat: 'Storage-basierter Split-Brain Schutz',
                recommendedFor2Node: 'Empfohlen f√ºr 2-Node Cluster!',
                storageHeartbeatDesc: 'Nutzt Shared Storage (NFS/Ceph/iSCSI) zur Koordination zwischen Nodes. Wenn ein Node keine Heartbeats mehr schreibt, ist er best√§tigt tot. Ein "Poison Pill" Mechanismus teilt dem isolierten Node mit, dass er seine VMs stoppen muss bevor Recovery startet.',
                enableStorageHeartbeat: 'Storage-basiertes Heartbeat aktivieren',
                enableStorageHeartbeatDesc: 'Schreibt Heartbeats auf Shared Storage zur Node-Gesundheitspr√ºfung',
                storageHeartbeatPath: 'Shared Storage Pfad',
                storageHeartbeatPathHint: 'Pfad zu Shared Storage der von allen Nodes erreichbar ist (z.B. Ceph, NFS, iSCSI)',
                heartbeatTimeout: 'Heartbeat Timeout (s)',
                heartbeatTimeoutHint: 'Node gilt als tot wenn kein Heartbeat in dieser Zeit',
                poisonPillEnabled: 'Poison Pill Mechanismus aktivieren',
                poisonPillDesc: 'Teilt isoliertem Node per Storage mit VMs zu stoppen vor Recovery',
                strictFencing: 'Strenger Fencing Modus',
                strictFencingDesc: 'Recovery ABBRECHEN wenn Node nicht als tot best√§tigt werden kann (sicherer aber mehr false positives)',
                howItWorks: 'So funktioniert es',
                step1Heartbeat: 'PegaProx schreibt alle 5 Sekunden Heartbeats auf Shared Storage',
                step2Check: 'Bei Node-Ausfall wird Storage-Heartbeat gepr√ºft um Tod zu best√§tigen',
                step3Poison: 'Eine "Poison Pill" Datei wird geschrieben die dem anderen Node sagt VMs zu stoppen',
                step4Recovery: 'Erst nach Best√§tigung/Timeout startet Recovery',
                nodeAgentRequired: 'Node-Agent erforderlich!',
                nodeAgentRequiredDesc: 'Damit dieses Feature funktioniert, musst du den PegaProx Node-Agent auf jedem Proxmox-Node installieren. Der Agent schreibt Heartbeats und reagiert auf Poison Pills.',
                
                // Automatic Split-Brain Protection - NS Jan 2026 - FULLY AUTOMATIC
                splitBrainProtection: 'Split-Brain Schutz',
                fullyAutomatic: '100% AUTOMATISCH',
                autoProtectionExplain: 'PegaProx findet automatisch Shared Storage, installiert Node-Agents und sch√ºtzt vor Split-Brain - keine Konfiguration n√∂tig!',
                sharedStoragesFound: 'Shared Storages gefunden:',
                inUse: 'AKTIV',
                fullProtectionActive: 'Voller Dual-Network Schutz aktiv',
                nodeAgentsInstalled: 'Node-Agents automatisch installiert',
                heartbeatsViaStorage: 'Heartbeats √ºber Storage-Netzwerk',
                sshOnlyMode: 'SSH-Only Schutz Modus',
                noSharedStorageFound: 'Kein Shared Storage (NFS/CephFS) gefunden. Schutz funktioniert √ºber SSH-Verifizierung.',
                notSafeForDualNetwork: 'Nicht sicher f√ºr Dual-Network Setups (getrennte Server/Storage Netzwerke)',
                
                // Block Storage Warning - NS Jan 2026
                blockStorageOnly: 'Nur Block-Storage gefunden',
                blockStorageExplain: 'Block-Storage (LVM, iSCSI, RBD) kann keine Heartbeat-Dateien speichern. F√ºr vollen Dual-Network Schutz ein kleines NFS-Share hinzuf√ºgen.',
                sshOnlyActive: 'SSH-Only Schutz aktiv',
                sshOnlyRisk: 'Funktioniert f√ºr Single-Network. F√ºr Dual-Network (getrennte Server/iSCSI) ein kleines NFS-Share hinzuf√ºgen (100MB reichen).',
                
                // Multiple Storages - NS Jan 2026
                clickToSelect: 'Klicken zum Ausw√§hlen',
                selected: 'Ausgew√§hlt',
                currentlyActive: 'Aktuell aktiv',
                blockStoragesIgnored: 'Block-Storages (nicht verwendbar)',
                
                // Self-Fence Protection - NS Jan 2026
                selfFenceProtection: 'Self-Fence Schutz',
                advancedSettings: 'Erweiterte Einstellungen',
                selfFenceExplain: 'Jeder Node pr√ºft ob er den Manager ODER einen anderen Node erreichen kann. Wenn niemand erreichbar ‚Üí Node ist isoliert ‚Üí stoppt seine eigenen VMs.',
                howItWorks: 'So funktioniert es',
                nodeCanReachSomeone: 'Node kann jemanden erreichen',
                everythingOk: 'Alles OK, nichts tun',
                nodeCanReachNoone: 'Node kann NIEMANDEN erreichen',
                nodeStopsOwnVms: 'Isoliert! Stoppt eigene VMs',
                selfFenceActive: 'Self-Fence Schutz aktiv',
                agentInstalledOnNodes: 'Agent installiert auf',
                allNodes: 'allen Nodes',
                selfFenceNotInstalled: 'Self-Fence Agent nicht installiert',
                selfFenceInstallHint: 'Klicke den Button um den Agent auf allen Nodes zu installieren. Der Agent pr√ºft alle 5 Sekunden die Erreichbarkeit.',
                installSelfFenceAgent: 'Self-Fence Agent installieren',
                selfFenceInstalling: 'Agent wird installiert...',
                noSharedStorageNeeded: 'Kein Shared Storage n√∂tig',
                worksWithLvmIscsi: 'Funktioniert mit LVM, iSCSI, allem',
                nodeDecidesItself: 'Node entscheidet selbst = schnelle Reaktion',
                uninstall: 'Deinstallieren',
                confirmUninstallAgent: 'Self-Fence Agent wirklich von allen Nodes deinstallieren?',
                selfFenceUninstalling: 'Agent wird deinstalliert...',
                enable2NodeMode: '2-Node Cluster Modus aktivieren',
                twoNodeModeDesc: 'Erzwingt automatisch Quorum wenn ein Node ausf√§llt',
                
                // Legacy translations (kept for compatibility)
                autoSplitBrainProtection: 'Automatischer Split-Brain Schutz',
                noSetupRequired: 'KEINE EINRICHTUNG N√ñTIG',
                autoProtectionDesc: 'PegaProx verhindert Split-Brain automatisch mit deinen vorhandenen SSH-Zugangsdaten.',
                sshSucceeds: 'SSH erfolgreich:',
                networkSplitDetected: 'Netzwerk-Split! VMs werden zuerst auf dem isolierten Node gestoppt',
                sshFails: 'SSH schl√§gt fehl:',
                nodeConfirmedDead: 'Node best√§tigt tot, sicheres Failover',
                advancedOptions: 'Erweiterte Optionen',
                dualNetworkWarning: 'Dual-Network Setup? (Server + iSCSI)',
                dualNetworkProblem: 'Wenn Server-Netzwerk ausf√§llt aber iSCSI noch geht, schl√§gt SSH fehl aber Node schreibt noch auf Storage = DATENKORRUPTION!',
                enableDualNetworkProtection: 'Storage-basierten Schutz aktivieren',
                dualNetworkProtectionDesc: 'Voraussetzung: PegaProx Server kann Shared Storage mounten (NFS/CephFS)',
                sharedStoragePath: 'Shared Storage Pfad',
                agentAutoInstall: 'Node-Agent wird automatisch via SSH installiert',
                
                // Device Passthrough
                devicePassthrough: 'Device Passthrough',
                pciDevices: 'PCI Devices',
                usbDevices: 'USB Devices',
                serialPorts: 'Serial Ports',
                addPci: 'PCI hinzuf√ºgen',
                addUsb: 'USB hinzuf√ºgen',
                addSerial: 'Serial hinzuf√ºgen',
                noPciDevices: 'Keine PCI Devices',
                noUsbDevices: 'Keine USB Devices',
                noSerialPorts: 'Keine Serial Ports',
                availableDevices: 'Verf√ºgbare Devices',
                selectDevice: 'Device ausw√§hlen',
                pcie: 'PCIe (empfohlen)',
                romBar: 'ROM-Bar',
                usb3: 'USB 3.0',
                serialType: 'Typ',
                socketConsole: 'Socket (Unix Socket Console)',
                deviceAdded: 'Device hinzugef√ºgt',
                deviceRemoved: 'Device entfernt',
                iommuGroup: 'IOMMU Gruppe',
                vendor: 'Hersteller',
                adding: 'Wird hinzugef√ºgt...',
                
                bandwidthLimits: 'Bandbreitenlimits',
                maxWorkers: 'Max. Workers',
                nextVmid: 'N√§chste VMID',
                userTagAccess: 'Benutzer-Tag Zugriff',
                registeredTags: 'Registrierte Tags',
                
                // Subscription
                subscriptionStatus: 'Subscription Status',
                licensed: 'Lizenziert',
                notLicensed: 'Nicht lizenziert',
                product: 'Produkt',
                licenseKey: 'Lizenzschl√ºssel',
                validUntil: 'G√ºltig bis',
                supportLevel: 'Support Level',
                noActiveSubscription: 'Keine aktive Subscription',
                noSubscriptionDesc: 'Dieser Node hat keine g√ºltige Proxmox VE Subscription. Ohne Subscription erhalten Sie keine Enterprise-Updates und keinen Support.',
                enterLicenseKey: 'Lizenzschl√ºssel eingeben',
                subscriptionKey: 'Subscription Key',
                pleaseEnterLicenseKey: 'Bitte Lizenzschl√ºssel eingeben',
                licenseActivated: 'Lizenz erfolgreich aktiviert!',
                activationFailed: 'Aktivierung fehlgeschlagen',
                activateLicense: 'Lizenz aktivieren',
                refreshStatus: 'Status aktualisieren',
                subscriptionBenefits: 'Eine Proxmox VE Subscription bietet',
                subscriptionBenefit1: 'Zugang zum Enterprise Repository mit stabilen Updates',
                subscriptionBenefit2: 'Technischer Support durch Proxmox',
                subscriptionBenefit3: 'Keine Subscription-Warnung beim Login',
                
                // Maintenance
                maintenanceModeTitle: 'Wartungsmodus aktivieren',
                maintenanceWarning: 'Achtung: Alle laufenden VMs und Container auf diesem Node werden automatisch auf andere Nodes migriert.',
                maintenanceDesc: 'Der Node wird aus dem Load Balancing ausgeschlossen bis der Wartungsmodus beendet wird.',
                startMaintenance: 'Wartung starten',
                removeNodeFromCluster: 'Node aus Cluster entfernen',
                removeNodeWarning: 'Der Node wird permanent aus dem Cluster entfernt. Alle VMs m√ºssen vorher migriert werden.',
                removeNodeConfirm: 'Node entfernen',
                removeNodeTypeName: 'Node-Name eingeben zum Best√§tigen',
                ready: 'Bereit',
                completedWithErrors: 'Fertig (mit Fehlern)',
                evacuating: 'Evakuiert...',
                failed: 'Fehlgeschlagen',
                starting: 'Startet...',
                progress: 'Fortschritt',
                migrating: 'Migriere',
                vmsCouldNotMigrate: 'VM(s) konnten nicht migriert werden',
                migrationIncomplete: 'Migration unvollst√§ndig',
                someVmsOnLocalStorage: 'Einige VMs konnten nicht migriert werden, wahrscheinlich wegen lokalem Storage. Sie k√∂nnen:',
                proceedWithCaution: 'Trotzdem fortfahren (VMs werden w√§hrend des Neustarts gestoppt)',
                exitAndMigrateManually: 'Wartung beenden und manuell migrieren',
                forceMaintenanceWarning: '‚ö†Ô∏è WARNUNG: Fortfahren wird die verbleibenden VMs auf diesem Node w√§hrend des Neustarts stoppen. Fortfahren?',
                proceedAnyway: 'Trotzdem fortfahren',
                failedToMigrate: 'Migration fehlgeschlagen',
                vmsWillBeStopped: 'VM(s) werden w√§hrend des Neustarts gestoppt',
                updating: 'Aktualisiert',
                nodeConfiguration: 'Node Konfiguration',
                rebootNode: 'Node neu starten',
                shutdownNode: 'Node herunterfahren',
                rebootNodeWarning: 'Der Node wird neu gestartet. Da er sich im Wartungsmodus befindet, sind keine VMs betroffen.',
                shutdownNodeWarning: 'Der Node wird heruntergefahren. Sie m√ºssen ihn manuell wieder einschalten!',
                rebootNow: 'Jetzt neu starten',
                shutdownNow: 'Jetzt herunterfahren',
                updateAndReboot: 'Update & Reboot',
                sudoNotAvailable: 'sudo ist auf diesem Node nicht verf√ºgbar',
                nodeActionFailed: 'Node-Aktion fehlgeschlagen',
                startingUpdateFor: 'Starte Update f√ºr',
                updateStartedFor: 'Update gestartet f√ºr',
                errorStartingUpdate: 'Fehler beim Starten des Updates',
                rebootInitiated: 'Neustart eingeleitet',
                shutdownInitiated: 'Herunterfahren eingeleitet',
                updateRunning: 'Update l√§uft',
                updateFailed: 'Update fehlgeschlagen',
                failedNodes: 'Fehlgeschlagene Nodes',
                maintenanceModeWarning: 'Einige Nodes befinden sich m√∂glicherweise noch im Wartungsmodus. Pr√ºfe den Nodes-Tab und beende den Wartungsmodus manuell falls n√∂tig.',
                viewLogs: 'Logs anzeigen',
                updateCompleted: 'Update abgeschlossen!',
                packagesUpdated: 'Pakete aktualisiert.',
                waitingForNode: 'Warte auf Node...',
                done: 'Fertig',
                cancelAndExitMaintenance: 'Abbrechen & Wartungsmodus beenden',
                sshSettings: 'SSH-Einstellungen',
                sshSettingsDesc: 'Wird f√ºr Node-Updates, Reboot und Shutdown ben√∂tigt. Wenn leer, wird der Proxmox-Benutzer/Passwort verwendet.',
                sshKeyOptional: 'SSH Key (Optional)',
                sshKeyExplanation: 'SSH-Features (SMBIOS Auto-Config, Custom Scripts, 2-Node HA) verwenden automatisch deine Login-Daten. F√ºge hier nur einen Key hinzu, wenn Password-Auth auf deinen Nodes deaktiviert ist.',
                
                // Common notifications
                connectionError: 'Verbindungsfehler',
                saveFailed: 'Speichern fehlgeschlagen',
                deleteError: 'Fehler beim L√∂schen',
                activationError: 'Fehler beim Aktivieren',
                deactivationError: 'Fehler beim Beenden',
                bulkMigrationNote: 'Migrationen werden nacheinander durchgef√ºhrt. Dies kann einige Zeit dauern.',
                deleteFailed: 'L√∂schen fehlgeschlagen',
                createFailed: 'Erstellen fehlgeschlagen',
                configSaved: 'Konfiguration gespeichert',
                failedToSaveSettings: 'Einstellungen konnten nicht gespeichert werden',
                failedToUnlockIp: 'IP konnte nicht entsperrt werden',
                failedToUnlockAllIps: 'IPs konnten nicht entsperrt werden',
                snapshotFailed: 'Snapshot fehlgeschlagen',
                rollbackFailed: 'Rollback fehlgeschlagen',
                replicationCreated: 'Replikation erstellt',
                replicationDeleted: 'Replikation gel√∂scht',
                replicationStarted: 'Replikation gestartet',
                startFailed: 'Start fehlgeschlagen',
                unlockVm: 'VM entsperren',
                vmLocked: 'VM ist gesperrt',
                vmUnlocked: 'VM entsperrt',
                
                // Security Settings
                securitySettings: 'Sicherheitseinstellungen',
                securityDashboard: 'Security Dashboard',
                issuesFound: 'Probleme gefunden',
                allSecure: 'Alle Systeme sicher',
                securityUpdates: 'Sicherheitsupdates',
                bannedIps: 'Gebannte IPs',
                securityIssues: 'Sicherheitsprobleme',
                recommendations: 'Empfehlungen',
                enableClusterFirewall: 'Cluster-Firewall aktivieren',
                installSecurityUpdates: 'Ausstehende Sicherheitsupdates installieren',
                enable2fa: 'Zwei-Faktor-Authentifizierung aktivieren',
                disableRootLogin: 'SSH Root-Login deaktivieren',
                clusterFirewall: 'Cluster-Firewall',
                nodeFirewalls: 'Node-Firewalls',
                rules: 'Regeln',
                noSecurityUpdates: 'Keine Sicherheitsupdates ausstehend',
                systemUpToDate: 'Alle Systeme sind aktuell',
                sshConfiguration: 'SSH-Konfiguration pro Node',
                activeJails: 'Aktive Jails',
                totalBanned: 'Gesamt gebannt',
                installed: 'Installiert',
                notInstalled: 'Nicht installiert',
                optional: 'Optional',
                refreshSecurityAudit: 'Sicherheitsaudit aktualisieren',
                analyzingSecurity: 'Analysiere Sicherheit...',
                bruteForceProtection: 'Brute-Force Schutz',
                bruteForceProtectionDesc: 'Konfigurieren Sie die Anzahl erlaubter Login-Versuche und Sperrzeiten um unbefugte Zugriffsversuche zu blockieren',
                loginProtection: 'Anmeldeschutz',
                passwordPolicy: 'Passwort-Richtlinie',
                minPasswordLength: 'Minimale L√§nge',
                requireUppercase: 'Gro√übuchstaben',
                requireLowercase: 'Kleinbuchstaben',
                requireNumbers: 'Zahlen',
                requireSpecial: 'Sonderzeichen',
                sessionTimeout: 'Session-Timeout',
                hours: 'Stunden',
                days: 'Tage',
                securityRecommendations: 'Sicherheitsempfehlungen',
                securityRecommendationsDesc: 'Vorschl√§ge zur Verbesserung der PegaProx-Sicherheit',
                httpsEnabled: 'Verbindung ist verschl√ºsselt',
                httpsDisabled: 'HTTPS f√ºr sichere Verbindungen aktivieren',
                sessionTimeout: 'Session-Timeout',
                currentlySetTo: 'Aktuell eingestellt auf',
                adminAccounts: 'Admin-Konten',
                adminAccountsActive: 'Admin-Konto(en) aktiv',
                defaultCredentials: 'Standard-Anmeldedaten',
                noDefaultPassword: 'Keine Standardpassw√∂rter erkannt',
                defaultPasswordWarning: 'Standard-Admin-Passwort wird noch verwendet!',
                lockAfter: 'Sperre nach',
                failedAttempts: 'fehlgeschlagenen Versuchen',
                auditLogging: 'Audit-Protokollierung',
                auditLoggingEnabled: 'Alle Aktionen werden protokolliert',
                secure: 'Sicher',
                recommended: 'Empfohlen',
                good: 'Gut',
                considerLowering: 'Verringern empfohlen',
                reviewRecommended: '√úberpr√ºfung empfohlen',
                actionRequired: 'Aktion erforderlich',
                maxLoginAttempts: 'Max. Login-Versuche',
                maxLoginAttemptsDesc: 'Anzahl fehlgeschlagener Versuche bevor gesperrt wird',
                lockoutTime: 'Sperrzeit',
                attemptWindow: 'Zeitfenster',
                lockedIps: 'Gesperrte IPs',
                noLockedIps: 'Keine IPs gesperrt',
                unlockAll: 'Alle entsperren',
                unlockAllConfirm: 'Wirklich alle IPs entsperren?',
                allIpsUnlocked: 'Alle IPs entsperrt',
                unlock: 'Entsperren',
                unlocked: 'entsperrt',
                locked: 'gesperrt',
                attempts: 'Versuche',
                remaining: 'verbleibend',
                
                // About page translations
                about: '√úber',
                developmentTeam: 'Entwicklungsteam',
                creditsAcknowledgments: 'Credits & Danksagungen',
                links: 'Links',
                
                // update Manager
                updateManager: 'Update Manager',
                updateManagerDesc: 'Pr√ºfen und installieren Sie Updates auf allen Cluster-Nodes',
                checkForUpdates: 'Nach Updates suchen',
                checkingUpdates: 'Pr√ºfe Updates...',
                updatesAvailable: 'Updates verf√ºgbar',
                noUpdatesAvailable: 'Keine Updates verf√ºgbar',
                packagesAvailable: 'Pakete verf√ºgbar',
                securityUpdates: 'Sicherheitsupdates',
                lastChecked: 'Zuletzt gepr√ºft',
                neverChecked: 'Noch nie gepr√ºft',
                startRollingUpdate: 'Rolling Update starten',
                updateThisNode: 'Diesen Node updaten',
                rebootRequired: 'Neustart erforderlich f√ºr Kernel',
                package: 'Paket',
                currentVersion: 'Aktuell',
                newVersion: 'Neu',
                noUpdatesForNode: 'Dieser Node ist aktuell',
                updateNode: 'Node updaten',
                updateNodeDesc: 'Dies f√ºhrt apt update && apt dist-upgrade auf dem Node aus.',
                kernelUpdateDetected: 'Kernel-Update erkannt',
                rebootRecommended: 'Ein Neustart wird empfohlen um Kernel-√Ñnderungen anzuwenden.',
                rebootAfterUpdate: 'Nach Update neustarten',
                startUpdate: 'Update starten',
                updateStarted: 'Update gestartet',
                updates: 'Updates',
                nodeNotInMaintenance: 'Node ist nicht im Wartungsmodus.',
                forceUpdateWarning: 'Laufende VMs auf diesem Node k√∂nnten beeintr√§chtigt werden wenn ein Neustart durchgef√ºhrt wird.',
                continueAnyway: 'Trotzdem fortfahren?',
                rollingUpdateDesc: 'Aktualisiert alle Nodes nacheinander. Jeder Node wird in den Wartungsmodus versetzt, VMs werden migriert, Updates installiert und optional neu gestartet.',
                
                // PegaProx Auto-Update - NS Jan 2026
                confirmUpdate: 'Update wird heruntergeladen und installiert. Ein Backup wird erstellt. Der Server startet automatisch neu. Fortfahren?',
                downloadingUpdate: 'Update wird heruntergeladen...',
                installingUpdate: 'Update wird installiert...',
                serverRestarting: 'Server startet neu...',
                reconnecting: 'Verbindung wird wiederhergestellt...',
                updateSuccessRestarting: 'Update installiert! Server startet neu...',
                updateComplete: 'Update abgeschlossen! Bitte Seite aktualisieren.',
                alreadyUpToDate: 'Bereits auf dem neuesten Stand!',
                installUpdate: 'Update installieren',
                updateAvailable: 'Update verf√ºgbar!',
                newVersionAvailable: 'Neue Version verf√ºgbar!',
                updateTo: 'Update auf',
                currentVersion: 'Aktuelle Version',
                viewUpdate: 'Update ansehen',
                later: 'Sp√§ter',
                whatsNew: 'Was ist neu',
                breakingChanges: 'Wichtige √Ñnderungen',
                doNotCloseWindow: 'Bitte dieses Fenster nicht schlie√üen...',
                rollback: 'Zur√ºcksetzen',
                rollbackDesc: 'Eine fr√ºhere Version aus einem Backup wiederherstellen',
                viewBackups: 'Backups anzeigen',
                selectBackup: 'Backup zum Wiederherstellen ausw√§hlen',
                noBackupsFound: 'Keine Backups gefunden',
                confirmRollback: 'PegaProx wird aus dem Backup wiederhergestellt. Der Server wird neu gestartet. Fortfahren?',
                restoringBackup: 'Backup wird wiederhergestellt...',
                rollbackSuccess: 'Wiederherstellung erfolgreich! Server startet neu...',
                rollbackWarning: '‚ö†Ô∏è Beim Zur√ºcksetzen wird der Server neu gestartet. Stellen Sie sicher, dass alle Arbeiten gespeichert sind.',
                
                // Security / Military Grade Encryption - NS Jan 2026
                securityStatus: 'Sicherheitsstatus',
                dataEncryption: 'Datenverschl√ºsselung',
                passwordHashing: 'Passwort-Hashing',
                compliance: 'Compliance',
                complianceStatus: 'Compliance-Status',
                auditLogIntegrity: 'Audit-Log Integrit√§t',
                encryptionKey: 'Verschl√ºsselungsschl√ºssel',
                corsConfiguration: 'CORS-Konfiguration',
                verifyIntegrity: 'Integrit√§t pr√ºfen',
                rotateKey: 'Schl√ºssel rotieren',
                rotating: 'Rotiere...',
                recommendations: 'Empfehlungen',
                totalEntries: 'Gesamteintr√§ge',
                verified: 'Verifiziert',
                unsigned: 'Unsigniert (alt)',
                tampered: 'M√∂glicherweise manipuliert',
                algorithm: 'Algorithmus',
                keySize: 'Schl√ºsselgr√∂√üe',
                lastRotation: 'Letzte Rotation',
                backups: 'Backups',
                allowedOrigins: 'Erlaubte Origins',
                // IP Whitelisting
                ipWhitelisting: 'IP-Whitelist',
                enableIPWhitelist: 'IP-Whitelist aktivieren',
                ipWhitelistDesc: 'Nur Zugriff von bestimmten IP-Adressen erlauben',
                yourIP: 'Deine aktuelle IP',
                whitelist: 'Whitelist',
                blacklist: 'Blacklist',
                allowedIPs: 'Erlaubte IPs',
                blockedIPs: 'Immer blockiert',
                testIP: 'IP-Zugriff testen',
                supportedFormats: 'Unterst√ºtzte Formate',
                // Config Backup/Restore
                configBackupRestore: 'Konfigurations-Backup & Wiederherstellung',
                exportConfig: 'Konfiguration exportieren',
                importConfig: 'Konfiguration importieren',
                includeUsers: 'Benutzerkonten einschlie√üen',
                includeSecrets: 'Passw√∂rter & Geheimnisse einschlie√üen',
                includeAuditLog: 'Audit-Log einschlie√üen',
                canBeLarge: 'Kann gro√ü sein',
                sensitive: 'Sensibel',
                downloadBackup: 'Backup herunterladen',
                exporting: 'Exportiere...',
                merge: 'Zusammenf√ºhren',
                overwrite: '√úberschreiben',
                keepExisting: 'Bestehende behalten',
                replaceAll: 'Alles ersetzen',
                restoreUsers: 'Benutzerkonten wiederherstellen',
                notAdmin: 'Au√üer Admin',
                dryRun: 'Testlauf',
                validateOnly: 'Nur validieren, nicht anwenden',
                selectBackupFile: 'Backup-Datei ausw√§hlen',
                importing: 'Importiere...',
                dryRunComplete: 'Testlauf abgeschlossen - Ergebnisse unten pr√ºfen',
                dryRunResults: 'Testlauf-Ergebnisse',
                restoreComplete: 'Konfiguration wiederhergestellt',
                restoreResults: 'Wiederherstellungs-Ergebnisse',
                backupVersion: 'Backup-Version',
                backupDate: 'Backup-Datum',
                backupDownloaded: 'Backup heruntergeladen',
                backupBy: 'Erstellt von',
                restored: 'Wiederhergestellt',
                skipped: '√úbersprungen',
                // Secure Backup
                secureBackup: 'Sicheres Backup',
                secureBackupDesc: 'Backups werden mit AES-256-GCM verschl√ºsselt. Sie m√ºssen Ihr Passwort und ein Backup-Passwort eingeben.',
                securityVerification: 'Sicherheits√ºberpr√ºfung',
                exportSecurityDesc: 'Um ein verschl√ºsseltes Backup zu erstellen, best√§tigen Sie bitte Ihre Identit√§t und legen Sie ein Backup-Passwort fest.',
                importSecurityDesc: 'Um ein Backup wiederherzustellen, best√§tigen Sie bitte Ihre Identit√§t und geben Sie das Backup-Passwort ein.',
                yourPassword: 'Ihr Passwort',
                enterYourPassword: 'Geben Sie Ihr Kontopasswort ein',
                backupPassword: 'Backup-Passwort',
                backupPasswordPlaceholder: 'Min. 8 Zeichen - merken Sie sich dieses!',
                confirmBackupPassword: 'Backup-Passwort best√§tigen',
                repeatBackupPassword: 'Backup-Passwort wiederholen',
                backupPasswordMin8: 'Backup-Passwort muss mindestens 8 Zeichen haben',
                passwordsNoMatch: 'Passw√∂rter stimmen nicht √ºberein',
                backupPasswordRequired: 'Backup-Passwort erforderlich',
                rememberBackupPassword: 'Merken Sie sich das Backup-Passwort! Ohne es k√∂nnen Sie das Backup nicht wiederherstellen.',
                createBackup: 'Backup erstellen',
                restoreBackup: 'Backup wiederherstellen',
                restoreFromBackup: 'Aus Backup wiederherstellen',
                validateBackup: 'Backup validieren',
                backupFile: 'Backup-Datei',
                backupPasswordUsedWhenCreating: 'Passwort das beim Erstellen verwendet wurde',
                autoMigration: 'Auto-Migration',
                militaryGradeEncryption: 'Military Grade Verschl√ºsselung',
                rollingUpdateInProgress: 'Rolling Update l√§uft',
                currentlyUpdating: 'Aktualisiere gerade',
                waitingForReboot: 'Warte auf Neustart',
                nodesCompleted: 'Nodes abgeschlossen',
                nodesRemaining: 'Nodes verbleibend',
                includeReboot: 'Nach Update neu starten',
                includeRebootHint: 'Empfohlen bei Kernel-Updates',
                skipNode: 'Node √ºberspringen',
                retryNode: 'Node erneut versuchen',
                cancelRollingUpdate: 'Rolling Update abbrechen',
                confirmRollingUpdate: 'Rolling Update best√§tigen',
                rollingUpdateWarning: 'Alle Nodes werden nacheinander aktualisiert. VMs werden automatisch migriert.',
                skipUpToDate: 'Aktuelle Nodes √ºberspringen',
                skipUpToDateHint: 'Nodes ohne Updates werden √ºbersprungen',
                advancedOptions: 'Erweiterte Optionen',
                evacuationTimeout: 'Evakuierungs-Timeout',
                evacuationTimeoutHint: 'Wartezeit f√ºr VM-Migration vor Timeout',
                skipEvacuation: 'VM-Evakuierung √ºberspringen',
                skipEvacuationHint: 'NICHT EMPFOHLEN - VMs bleiben auf dem Node w√§hrend des Updates',
                skipEvacuationWarning: '‚ö†Ô∏è Warnung: VMs k√∂nnen bei Problemen w√§hrend des Updates abst√ºrzen!',
                scheduleUpdates: 'Automatische Updates',
                enableAutoUpdate: 'Automatische Updates aktivieren',
                autoUpdateDesc: 'Rolling Updates automatisch nach Zeitplan ausf√ºhren',
                updateDay: 'Update-Tag',
                updateTime: 'Update-Zeit',
                serverTimezone: 'Server-Zeitzone',
                autoUpdateInfo: 'Nodes werden nacheinander aktualisiert. VMs werden automatisch migriert. Aktuelle Nodes werden √ºbersprungen.',
                scheduleSaved: 'Update-Zeitplan gespeichert',
                scheduledFor: 'Geplant f√ºr',
                schedule: 'Zeitplan',
                experimental: 'EXPERIMENTELL',
                experimentalWarning: 'Mit Vorsicht verwenden - dieses Feature ist derzeit experimentell. Zuerst in Nicht-Produktionsumgebungen testen.',
                runOnce: 'Einmalig',
                recurring: 'Wiederkehrend',
                runOnceInfo: 'Das Update wird einmalig zur geplanten Zeit ausgef√ºhrt und deaktiviert sich dann selbst.',
                monday: 'Montag',
                tuesday: 'Dienstag',
                wednesday: 'Mittwoch',
                thursday: 'Donnerstag',
                friday: 'Freitag',
                saturday: 'Samstag',
                sunday: 'Sonntag',
                daily: 'T√§glich',
                hour: 'Stunde',
                hours: 'Stunden',
                estimatedTime: 'Gesch√§tzte Zeit',
                minutes: 'Minuten',
                updateHistory: 'Update-Verlauf',
                viewUpdateLog: 'Update-Log anzeigen',
                checkingForUpdates: 'Pr√ºfe auf Updates',
                checkingNodes: 'Pr√ºfe Nodes auf verf√ºgbare Updates...',
                connectingToCluster: 'Verbinde zum Cluster...',
                processingResults: 'Verarbeite Ergebnisse...',
                // Repo management - MK
                repoInfo: 'APT-Repositories f√ºr diesen Node verwalten. Repositories aktivieren/deaktivieren um verf√ºgbare Pakete zu steuern.',
                repoProxmoxNotice: 'Hinweis: Aufgrund von Proxmox\'s Umstellung auf neues Source-Format kann die Anzeige aktuell noch ungenau sein. Wir arbeiten daran.',
                requiresSubscription: 'Erfordert Subscription',
                detected: 'Erkannt',
                notConfigured: 'Nicht konfiguriert',
                repoWarning: 'Das Mischen von Enterprise und No-Subscription Repositories wird nicht empfohlen. Nach √Ñnderungen "apt update" ausf√ºhren.',
                noReposFound: 'Keine Repositories gefunden',
                currentNode: 'Aktueller Node',
                currentStep: 'Aktueller Schritt',
                updateLogs: 'Update-Logs',
                started: 'Gestartet',
                sshUser: 'SSH-Benutzer',
                sshPort: 'SSH-Port',
                sshPrivateKey: 'SSH Private Key',
                sshKeyHint: 'Wird f√ºr Nodes ben√∂tigt, die nur Public-Key-Authentifizierung erlauben',
                sshKeyRequired: 'SSH-Key wird ben√∂tigt. Bitte in den Cluster-Einstellungen konfigurieren.',
                balanceContainers: 'Container balancieren',
                balanceLocalDisks: 'VMs mit lokalen Disks balancieren',
                balanceLocalDisksDesc: 'VMs mit lokalen Disks werden mit --with-local-disks migriert (kopiert Daten zum Ziel)',
                localDiskBalanceWarning: 'Migration von VMs mit lokalen Disks kopiert alle Disk-Daten zum Ziel-Node. Dies kann lange dauern und erh√∂ht die Netzwerklast erheblich.',
                containerBalanceWarning: 'Container k√∂nnen NICHT live migriert werden! Bei der Migration wird der Container gestoppt und neu gestartet, was zu Downtime f√ºhrt.',
                clusterSettings: 'Cluster-Einstellungen',
                clusterSettingsDesc: 'Konfiguriere Balancing-Einstellungen f√ºr jeden Cluster.',
                clusterSettingsSaved: 'Cluster-Einstellungen gespeichert',
                noClustersConfigured: 'Keine Cluster konfiguriert',
                collapse: 'Einklappen',
                threshold: 'Schwellwert',
                interval: 'Intervall',
                saveSettings: 'Einstellungen speichern',
                haEnabled: 'HA aktiviert',
                
                // VM Detail buttons
                console: 'Konsole',
                configuration: 'Konfiguration',
                
                // Config Modal
                cpuCores: 'CPU Kerne',
                cpuLimit: 'CPU Limit',
                memory: 'Arbeitsspeicher (RAM)',
                hardware: 'Hardware',
                disks: 'Festplatten',
                
                // Config Modal Tabs
                mountIso: 'ISO einbinden',
                noIsoEject: 'Kein ISO (auswerfen)',
                device: 'Device',
                target: 'Ziel',
                cdrom: 'CD-ROM',
                hardDisk: 'Festplatte',
                existingCdrom: 'Existierendes CD-ROM Laufwerk',
                hardDiskNotAvailable: 'Festplatte - nicht verf√ºgbar!',
                freeSlot: 'Freier Slot',
                mount: 'Einbinden',
                eject: 'Auswerfen',
                addDisk: 'Festplatte hinzuf√ºgen',
                freeSpace: 'Frei',
                notEnoughSpace: 'Nicht genug Speicherplatz!',
                usedSpace: 'Belegt',
                resize: 'Vergr√∂√üern',
                move: 'Verschieben',
                remove: 'Entfernen',
                editDiskType: 'Bus-Typ √§ndern',
                changeDiskBusType: 'Festplatten-Bus-Typ √§ndern',
                vmIsRunning: 'VM l√§uft noch',
                vmMustBeStopped: 'VM muss gestoppt sein',
                vmMustBeStoppedForBusChange: 'Die VM muss gestoppt sein, bevor der Festplatten-Bus-Typ ge√§ndert werden kann. Bitte fahren Sie die VM zuerst herunter.',
                currentDisk: 'Aktuell',
                diskBusWarning: 'Das √Ñndern des Bus-Typs erfordert, dass die VM gestoppt ist. Das Gastbetriebssystem ben√∂tigt m√∂glicherweise Treiber-Updates.',
                selectNewBusType: 'Neuen Bus-Typ ausw√§hlen',
                scsiDesc: 'Beste Performance mit VirtIO SCSI Controller',
                virtioDesc: 'Legacy VirtIO, gute Performance',
                sataDesc: 'Gute Kompatibilit√§t, mittlere Performance',
                ideDesc: 'Maximale Kompatibilit√§t, niedrigste Performance',
                current: 'Aktuell',
                changeBusType: 'Bus-Typ √§ndern',
                saving: 'Speichern...',
                diskBusChanged: 'Festplatten-Bus-Typ ge√§ndert',
                optionsWillBeRemoved: 'Folgende Optionen werden nicht unterst√ºtzt und entfernt',
                noDisksConfigured: 'Keine Festplatten konfiguriert',
                unusedDisks: 'Ungenutzte Festplatten',
                unusedDisksDesc: 'Diese Festplatten sind abgetrennt aber existieren noch. Sie k√∂nnen wieder angeh√§ngt oder gel√∂scht werden.',
                reattach: 'Anh√§ngen',
                reattachDisk: 'Festplatte wieder anh√§ngen',
                selectBusType: 'Bus-Typ ausw√§hlen',
                diskId: 'Festplatten-ID',
                nextAvailableId: 'N√§chste verf√ºgbare ID f√ºr gew√§hlten Bus-Typ',
                diskOptions: 'Festplatten-Optionen',
                ideLimitedOptions: 'IDE hat eingeschr√§nkte Optionen',
                preview: 'Vorschau',
                attaching: 'Wird angeh√§ngt...',
                volume: 'Volume',
                diskReattached: 'Festplatte wieder angeh√§ngt',
                deleteUnusedDiskConfirm: 'Festplatte dauerhaft l√∂schen? Dies kann nicht r√ºckg√§ngig gemacht werden!',
                unusedDiskDeleted: 'Ungenutzte Festplatte gel√∂scht',
                deletePermanently: 'Dauerhaft l√∂schen',
                configLoadError: 'Konfiguration konnte nicht geladen werden',
                networkInterfaces: 'Netzwerk-Interfaces',
                addNetwork: 'Netzwerk hinzuf√ºgen',
                noNetworksConfigured: 'Keine Netzwerke konfiguriert',
                networkDisconnected: 'Netzwerk getrennt',
                disconnectNetwork: 'Netzwerk trennen',
                disconnectNetworkHint: 'Simuliert ein ausgestecktes Netzwerkkabel',
                connectNetwork: 'Netzwerk verbinden',
                createSnapshot: 'Snapshot erstellen',
                unknown: 'Unbekannt',
                rollback: 'Rollback',
                noSnapshots: 'Keine Snapshots vorhanden',
                createReplication: 'Replication erstellen',
                replicationNeedsTwoNodes: 'Replication ben√∂tigt mindestens 2 Nodes im Cluster',
                lastSync: 'Letzte Sync',
                neverSynced: 'Nie synchronisiert',
                syncNow: 'Jetzt synchronisieren',
                startOnBoot: 'Start bei Boot',
                protection: 'Schutz (vor L√∂schen/√Ñndern)',
                kvmVirtualization: 'KVM Hardware-Virtualisierung',
                unprivilegedContainer: 'Unprivilegierter Container',
                osType: 'OS Typ',
                other: 'Andere',
                hotplug: 'Hotplug',
                hotplugHint: 'Ger√§te die im laufenden Betrieb hinzugef√ºgt werden k√∂nnen',
                hotplugDisk: 'Disk',
                hotplugNetwork: 'Netzwerk',
                hotplugUsb: 'USB',
                hotplugMemory: 'Memory',
                hotplugCpu: 'CPU',
                qemuGuestAgent: 'QEMU Guest Agent',
                qemuGuestAgentHint: 'Erm√∂glicht Shutdown, Freeze/Thaw f√ºr Snapshots',
                fstrim: 'FSTRIM nach Clone/Migration',
                fstrimHint: 'Automatisch TRIM nach Clone ausf√ºhren',
                
                // More modals
                optional: 'optional',
                snapshotDescription: 'Beschreibung des Snapshots...',
                saveRamState: 'RAM-Zustand speichern (Hibernate)',
                create: 'Erstellen',
                createReplicationJob: 'Replication Job erstellen',
                targetNode: 'Ziel-Node',
                rateLimit: 'Rate Limit (MB/s)',
                unlimited: 'Unbegrenzt',
                comment: 'Kommentar',
                commentPlaceholder: 'z.B. DR-Replikation',
                every5min: 'Alle 5 Minuten',
                every15min: 'Alle 15 Minuten',
                every30min: 'Alle 30 Minuten',
                hourly: 'St√ºndlich',
                every2hours: 'Alle 2 Stunden',
                every4hours: 'Alle 4 Stunden',
                every6hours: 'Alle 6 Stunden',
                every12hours: 'Alle 12 Stunden',
                daily: 'T√§glich (Mitternacht)',
                size: 'Gr√∂√üe',
                enableFirewall: 'Firewall aktivieren',
                editNetwork: 'Netzwerk bearbeiten',
                enableNuma: 'NUMA aktivieren',
                viommu: 'vIOMMU (Virtualized IOMMU)',
                viommuInfo: 'Erforderlich f√ºr verschachtelte Virtualisierung und bestimmte Passthrough-Szenarien',
                sockets: 'Sockets',
                ballooningMinimum: 'Ballooning Minimum',
                swap: 'Swap',
                cpuType: 'CPU Typ',
                scsiController: 'SCSI Controller',
                machineType: 'Maschinentyp',
                machineTypePlaceholder: 'z.B. q35 oder i440fx (leer = Standard)',
                none: 'Keine',
                compatible: 'kompatibel',
                cache: 'Cache',
                noCache: 'Kein Cache',
                default: 'Standard',
                unsafe: 'unsicher',
                fastest: 'schnellste',
                discard: 'Discard',
                ioThread: 'IO Thread',
                ssdEmulation: 'SSD Emulation',
                cores: 'Kerne',
                branding: 'Branding',
                appName: 'App-Name',
                customLogo: 'Eigenes Logo',
                logoHint: 'PNG, SVG oder GIF empfohlen. Max 500KB.',
                logoUploaded: 'Logo hochgeladen',
                logoUploadFailed: 'Logo-Upload fehlgeschlagen',
                logoDeleted: 'Logo entfernt',
                remove: 'Entfernen',
                upload: 'Hochladen',
                thanksToSponsors: 'Danke an unsere Sponsoren',
                sponsorSubtitle: 'Unterst√ºtzung f√ºr Open-Source-Entwicklung',
                becomeSponsor: 'Sponsor werden',
                madeWithLove: 'Mit ‚ù§Ô∏è f√ºr die Proxmox-Community gemacht',
                settingsSaved: 'Einstellungen gespeichert',
                saveError: 'Fehler beim Speichern',
                dnsSaved: 'DNS gespeichert',
                hostsSaved: 'Hosts gespeichert',
                searchDomain: 'Such-Domain',
                dnsServer: 'DNS Server',
                time: 'Zeit',
                timezone: 'Zeitzone',
                localTime: 'Lokale Zeit',
                sslCertificates: 'SSL Zertifikate',
                uploadCustomCert: 'Custom Zertifikat hochladen',
                issuer: 'Aussteller',
                valid: 'G√ºltig',
                expired: 'Abgelaufen',
                noCertificates: 'Keine Zertifikate gefunden',
                certificate: 'Zertifikat',
                privateKey: 'Privater Schl√ºssel',
                certChainHint: 'Kann mehrere Zertifikate enthalten (Chain)',
                restartPveproxyAfterUpload: 'pveproxy nach Upload neustarten',
                certAndKeyRequired: 'Zertifikat und Key erforderlich',
                certUploaded: 'Zertifikat hochgeladen!',
                uploadCertificate: 'Zertifikat hochladen',
                deleteCertConfirm: 'Custom Zertifikat l√∂schen und auf Self-Signed zur√ºcksetzen?',
                certDeleted: 'Zertifikat gel√∂scht',
                deleteCustomCert: 'Custom Cert l√∂schen',
                syslogLatest: 'Syslog (neueste Eintr√§ge)',
                noLogEntries: 'Keine Log-Eintr√§ge',
                datastore: 'Datenspeicher',
                datastores: 'Datenspeicher',
                esxiHosts: 'ESXi Hosts',
                connectEsxi: 'ESXi Host verbinden',
                esxiHostname: 'ESXi Hostname/IP',
                esxiUsername: 'Benutzername',
                esxiPassword: 'Passwort',
                esxiConnected: 'ESXi verbunden',
                esxiVms: 'ESXi VMs',
                migrateToProxmox: 'Zu Proxmox importieren',
                esxiMigrationHint: 'VM muss auf ESXi ausgeschaltet sein!',
                esxiMigrating: 'Import l√§uft...',
                esxiMigrationStarted: 'Import gestartet',
                esxiDisconnect: 'Verbindung trennen',
                esxiNoVms: 'Keine VMs auf diesem ESXi Host',
                esxiExperimental: 'ESXi-Import nutzt native Proxmox-Funktion (PVE 8.1+)',
                noEsxiHosts: 'Keine ESXi Hosts verbunden',
                fillAllFields: 'Bitte alle Felder ausf√ºllen',
                confirmDisconnect: 'ESXi Host wirklich trennen?',
                connect: 'Verbinden',
                sharedStorage: 'Gemeinsamer Speicher',
                selectStorage: 'Speicher ausw√§hlen um Inhalte anzuzeigen',
                clickStorageToView: 'Klicken Sie auf einen Speicher um dessen Inhalte anzuzeigen',
                storageEmpty: 'Dieser Speicher ist leer',
                content: 'Inhalt',
                format: 'Format',
                browse: 'Durchsuchen',
                storageDrsDesc: 'Automatisches Balancing der Festplattennutzung √ºber gemeinsamen Speicher',
                storageUsage: 'Speichernutzung',
                currentImbalance: 'Aktuelle Ungleichheit',
                threshold: 'Schwellenwert',
                recommendations: 'Empfehlungen',
                migrate: 'Migrieren',
                storageBalanced: 'Alle Speicher sind gut ausgelastet. Keine Aktion erforderlich.',
                experimentalFeature: 'Experimentelles Feature',
                storageBalancingExperimental: 'Storage Balancing ist noch experimentell. Wir freuen uns √ºber Feedback!',
                uploadIso: 'ISO hochladen',
                downloadFromUrl: 'Von URL herunterladen',
                fromUrl: 'Von URL',
                isoUrl: 'ISO URL',
                isoUrlHint: 'Direkter Link zur ISO-Datei (http/https)',
                autoDetect: 'Automatisch aus URL ermitteln',
                startingDownload: 'Download wird gestartet...',
                downloading: 'Wird heruntergeladen...',
                downloadFailed: 'Download fehlgeschlagen',
                selectFile: 'Datei ausw√§hlen',
                confirmDelete: 'L√∂schen best√§tigen',
                deleteConfirmText: 'Sind Sie sicher, dass Sie l√∂schen m√∂chten',
                createStorageCluster: 'Storage Cluster erstellen',
                noStorageClusters: 'Keine Storage Cluster konfiguriert',
                createStorageClusterHint: 'Erstellen Sie ein Cluster um Speicher √ºber mehrere Volumes zu balancieren',
                selectCluster: 'W√§hlen Sie ein Storage Cluster',
                selectClusterToView: 'W√§hlen Sie ein Storage Cluster um den Status anzuzeigen',
                balancingThreshold: 'Balancing Schwellenwert',
                thresholdDesc: 'Balancing ausl√∂sen wenn Ungleichheit diesen Wert √ºbersteigt',
                actionRecommended: 'Aktion empfohlen',
                balanced: 'Ausgeglichen',
                storagesInCluster: 'Storages im Cluster',
                addStorage: '+ Storage hinzuf√ºgen',
                clusterName: 'Cluster Name',
                selectStorages: 'Storages ausw√§hlen',
                minTwo: 'mind. 2',
                noSharedStorages: 'Keine gemeinsamen Storages verf√ºgbar',
                confirmDeleteCluster: 'Dieses Storage Cluster l√∂schen?',
                minTwoStorages: 'Mindestens 2 Storages erforderlich',
                needTwoStorages: 'Mindestens 2 Storages erforderlich',
                migrationStarted: 'Migration gestartet!',
                autoBalance: 'Auto-Balance',
                autoBalanceActive: 'Auto-Balance Aktiv',
                autoBalanceDesc: 'Disks werden automatisch migriert wenn die Ungleichheit den Schwellenwert √ºberschreitet. VMs mit aktiven Snapshots/Backups werden √ºbersprungen.',
                dryRunShort: 'Dry Run',
                connecting: 'Verbinde...',
                needsRestart: 'NEUSTART ERFORDERLICH',
                
                // NS: Alerts, Tasks, Tags, Affinity - Dec 2025
                alerts: 'Alarme',
                alertsDesc: 'E-Mail-Benachrichtigungen bei Schwellwert-√úberschreitungen',
                createAlert: 'Alarm erstellen',
                editAlert: 'Alarm bearbeiten',
                alertName: 'Alarm Name',
                alertMetric: 'Metrik',
                alertThreshold: 'Schwellenwert',
                alertOperator: 'Bedingung',
                alertTarget: 'Ziel',
                alertTargetType: 'Ziel-Typ',
                noAlerts: 'Keine Alarme konfiguriert',
                testEmail: 'Test-Email senden',
                testEmailSuccess: 'Test-Email gesendet!',
                testEmailFailed: 'Test-Email konnte nicht gesendet werden',
                enterEmailAddress: 'Bitte E-Mail-Adresse eingeben',
                saveSmtpSettings: 'SMTP Einstellungen speichern',
                smtpSettingsSaved: 'SMTP Einstellungen gespeichert!',
                enableSmtpHint: 'Aktivieren Sie SMTP um E-Mail-Einstellungen zu konfigurieren',
                smtpHostRequired: 'SMTP Server ist erforderlich',
                smtpFromEmailRequired: 'Absender E-Mail ist erforderlich',
                emailRecipients: 'E-Mail Empf√§nger',
                addRecipient: 'Empf√§nger hinzuf√ºgen',
                
                scheduledTasks: 'Geplante Aufgaben',
                scheduledTasksDesc: 'VM-Operationen automatisch planen',
                createTask: 'Aufgabe erstellen',
                editTask: 'Aufgabe bearbeiten',
                taskName: 'Aufgaben-Name',
                taskAction: 'Aktion',
                taskSchedule: 'Zeitplan',
                scheduleType: 'Zeitplan-Typ',
                scheduleTime: 'Uhrzeit',
                scheduleDay: 'Tag',
                noScheduledTasks: 'Keine geplanten Aufgaben',
                runNow: 'Jetzt ausf√ºhren',
                lastRun: 'Letzte Ausf√ºhrung',
                hourly: 'St√ºndlich',
                daily: 'T√§glich',
                weekly: 'W√∂chentlich',
                monthly: 'Monatlich',
                
                tagsLabels: 'Tags & Labels',
                tagsDesc: 'VMs kategorisieren und gruppieren',
                createTag: 'Tag erstellen',
                tagName: 'Tag Name',
                tagColor: 'Farbe',
                noTags: 'Keine Tags definiert',
                assignedVms: 'Zugewiesene VMs',
                
                affinityRules: 'Affinit√§tsregeln',
                customScripts: 'Eigene Skripte',
                scriptsDesc: 'F√ºhre eigene .sh oder .py Skripte auf Cluster-Nodes aus',
                newScript: 'Neues Skript',
                noScripts: 'Keine Skripte konfiguriert',
                scriptsInfo: 'Erstelle Skripte um Aufgaben auf deinen Cluster-Nodes zu automatisieren',
                runScript: 'Skript ausf√ºhren',
                runScriptConfirm: 'Skript ausf√ºhren?',
                scriptStarted: 'Skriptausf√ºhrung gestartet',
                scriptDeleted: 'Skript gel√∂scht',
                scriptCreated: 'Skript erstellt',
                scriptUpdated: 'Skript aktualisiert',
                scriptPermissions: 'Skript-Berechtigungen',
                scriptPermissionsDesc: 'Skripte ben√∂tigen SSH-Zugriff auf Nodes. Konfiguriere den SSH-Key in den Cluster-Einstellungen.',
                scriptContent: 'Skript-Inhalt',
                targetNodes: 'Ziel-Nodes',
                scriptWarning: 'Skripte werden mit SSH-Benutzerrechten ausgef√ºhrt. Stelle sicher dass Skripte sicher sind.',
                passwordRequiredForScripts: 'Passwort-Best√§tigung aus Sicherheitsgr√ºnden erforderlich',
                viewOutput: 'Ausgabe anzeigen',
                noOutput: 'Keine Ausgabe verf√ºgbar',
                output: 'Ausgabe',
                affinityDesc: 'Bestimmen Sie welche VMs zusammen oder getrennt laufen sollen',
                createAffinityRule: 'Regel erstellen',
                editAffinityRule: 'Regel bearbeiten',
                ruleName: 'Regel-Name',
                ruleType: 'Regel-Typ',
                together: 'Zusammen (gleicher Host)',
                separate: 'Getrennt (verschiedene Hosts)',
                selectVms: 'VMs ausw√§hlen',
                noAffinityRules: 'Keine Affinit√§tsregeln',
                enforceRule: 'Regel erzwingen',
                enforceRuleHint: 'Migration blockieren wenn Regel verletzt w√ºrde',
                
                // Console Settings - NS Jan 2026
                consoleSettings: 'Konsolen-Ports',
                vncPort: 'VNC Port',
                shellPort: 'Shell Port',
                consolePortHint: 'VNC f√ºr VM-Konsolen, Shell f√ºr Node-Terminals. Server-Neustart erforderlich nach √Ñnderung!',
                nodeShellHint: 'F√ºr Node-Shell oder detaillierte Performance nutze den Proxmox UI Button oben oder verbinde dich direkt zum Node.',
                selfSignedCertWarning: 'Selbst-signierte Zertifikate',
                selfSignedCertHint: 'VNC und Shell laufen auf separaten Ports. Bei selbst-signierten Zertifikaten m√ºssen diese Ports im Browser einmalig akzeptiert werden.',
                openVncPort: 'VNC Port √∂ffnen',
                openShellPort: 'Shell Port √∂ffnen',
                certInstructions: 'Bei selbst-signierten Zertifikaten:',
                certStep1: '1. √ñffne diesen Link in einem neuen Tab:',
                certStep2: '2. Akzeptiere das Zertifikat im Browser',
                certStep3: '3. Komm zur√ºck und versuche es erneut',
                acceptCert: 'Zertifikat akzeptieren',
                openInProxmox: 'In Proxmox √∂ffnen',
                connectionError: 'Verbindungsfehler',
                wsConnectionFailed: 'WebSocket Verbindung fehlgeschlagen',
                checkServerLogs: 'Pr√ºfe die Server-Logs f√ºr Details',
                connectingWs: 'Verbinde WebSocket',
                wsConnected: 'WebSocket verbunden, warte auf Server...',
                ipFetchFailed: 'IP-Ermittlung fehlgeschlagen',
                
                smtpSettings: 'SMTP Einstellungen',
                smtpHost: 'SMTP Server',
                smtpPort: 'Port',
                smtpUser: 'Benutzername',
                smtpPassword: 'Passwort',
                smtpFromEmail: 'Absender E-Mail',
                smtpFromName: 'Absender Name',
                smtpTls: 'TLS verwenden',
                smtpSsl: 'SSL verwenden',
                alertCooldown: 'Alarm-Cooldown (Sekunden)',
                
                migrationHistory: 'Migrations-Verlauf',
                noMigrationHistory: 'Keine Migrationen aufgezeichnet',
                
                // LW: Password expiry settings
                passwordExpiry: 'Passwort-Ablauf',
                passwordExpiryDesc: 'Benutzer m√ºssen ihr Passwort nach einer bestimmten Anzahl von Tagen √§ndern.',
                passwordExpiryHint: 'Benutzer erhalten E-Mail-Erinnerungen 14, 7, 3 und 1 Tag(e) vor Ablauf. Ein Warnbanner wird in der UI angezeigt. SMTP muss f√ºr E-Mails konfiguriert sein.',
                sendExpiryEmails: 'E-Mail-Benachrichtigungen senden wenn Passwort bald abl√§uft',
                expiryDays: 'Passwort l√§uft ab nach',
                warningDays: 'Benutzer warnen vor',
                
                // LW: Password expiry banner
                passwordExpired: 'Ihr Passwort ist abgelaufen!',
                passwordExpiresIn: 'Ihr Passwort l√§uft in {days} Tagen ab',
                pleaseChangeNow: 'Bitte √§ndern Sie es jetzt.',
                pleaseChangeSoon: 'Bitte √§ndern Sie es rechtzeitig.',
                changePassword: 'Passwort √§ndern',
                dismissForNow: 'Sp√§ter erinnern',
                
                // LW: Reset all passwords - Dec 2025
                forcePasswordReset: 'Passwort-Reset erzwingen',
                forcePasswordResetDesc: 'Alle Benutzerpassw√∂rter sofort ablaufen lassen. Nach Sicherheitsvorf√§llen verwenden.',
                resetAllPasswords: 'Alle zur√ºcksetzen',
                confirmPasswordReset: 'Passwort-Reset best√§tigen',
                resetAllWarning: 'Dies zwingt ALLE Benutzer, ihr Passwort bei der n√§chsten Anmeldung zu √§ndern. Diese Aktion kann nicht r√ºckg√§ngig gemacht werden.',
                includeAdmins: 'Admin-Konten einschlie√üen',
                includeAdminsWarning: 'Achtung: Sie m√ºssen dann auch Ihr Passwort √§ndern!',
                includeAdminsInExpiry: 'Admin-Konten einschlie√üen',
                includeAdminsInExpiryDesc: 'Auch Admins m√ºssen ihr Passwort regelm√§√üig √§ndern',
                
                // Theme System - NS Jan 2026
                appearance: 'Erscheinungsbild',
                themeDesc: 'W√§hle ein Farbthema f√ºr die Oberfl√§che',
                themeNote: 'Das Theme wird in deinem Account gespeichert und bleibt √ºber Sitzungen hinweg erhalten.',
                chooseTheme: 'W√§hle dein Theme',
                themePersonal: 'W√§hle ein Theme das zu dir passt. Diese Einstellung ist pers√∂nlich und betrifft nur deinen Account.',
                defaultTheme: 'Standard-Theme',
                defaultThemeDesc: 'Standard-Theme f√ºr neue Benutzer festlegen. Benutzer k√∂nnen ihr Theme in "Mein Profil" √§ndern.',
                currentDefault: 'Aktueller Standard',
                themeInProfile: '√Ñndere dein Theme in "Mein Profil" (klicke auf deinen Benutzernamen oben rechts)',
                
                // UI Layout - NS Jan 2026
                uiLayout: 'Benutzeroberfl√§che',
                layoutDesc: 'W√§hle zwischen verschiedenen Interface-Layouts.',
                inventory: 'Inventar',
                selectItem: 'W√§hle ein Element aus dem Baum',
                summary: 'Zusammenfassung',
                monitor: '√úberwachung',
                configure: 'Konfiguration',
                console: 'Konsole',
                
                
                snapshots: 'Snapshots',
                snapshotsOverview: 'Snapshot √úbersicht',
                snapshotsCleanUp: 'Cleanup',
                snapshotsDesc: '√úbersicht der √§ltesten Snapshots in diesem Cluster',
                snapshotsHint: '√úbersicht von allen Snapshots √ºber alle G√§ste und Nodes',
                snapshotsType: 'Art',
                snapshotsDate: 'Erstellt',
                snapshotsAge: 'Alter',
                snapshotsAction: 'Aktion',
                noSnapshots: 'Keine Snapshots gefunden',
            },
            en: {
                // General
                loading: 'Loading...',
                save: 'Save',
                cancel: 'Cancel',
                delete: 'Delete',
                edit: 'Edit',
                add: 'Add',
                close: 'Close',
                yes: 'Yes',
                no: 'No',
                enabled: 'Enabled',
                disabled: 'Disabled',
                enable: 'Enable',
                disable: 'Disable',
                actions: 'Actions',
                status: 'Status',
                name: 'Name',
                type: 'Type',
                online: 'Online',
                offline: 'Offline',
                running: 'Running',
                stopped: 'Stopped',
                active: 'Active',
                all: 'All',
                id: 'ID',
                cores: 'Cores',
                search: 'Search',
                searchByNameOrId: 'Search by name or ID...',
                searchAllClusters: 'Search all clusters...',
                pressEnterToOpen: 'Press Enter to jump to VM',
                toggleFavorite: 'Toggle favorite',
                results: 'results',
                noResults: 'No results',
                target: 'Target',
                source: 'Source',
                rules: 'Rules',
                default: 'Default',
                none: 'None',
                of: 'of',
                since: 'Since',
                uptime: 'Uptime',
                sinceStart: 'Since Start',
                
                // Auth
                login: 'Login',
                logout: 'Logout',
                loginTitle: 'Sign in to PegaProx',
                loginSubtitle: 'PegaProx Cluster Management for Proxmox VE',
                usernameLabel: 'Username',
                passwordLabel: 'Password',
                passwordPolicyHint: 'Min. 8 characters, uppercase, lowercase & number required',
                minChars: 'Min.',
                characters: 'characters',
                uppercase: 'uppercase',
                lowercase: 'lowercase',
                numbers: 'number',
                specialChar: 'special char',
                loginButton: 'Sign In',
                loggingIn: 'Signing in...',
                loginError: 'Login failed',
                invalidCredentials: 'Invalid credentials',
                sessionExpired: 'Session expired',
                welcomeBack: 'Welcome back',
                changePassword: 'Change Password',
                currentPassword: 'Current Password',
                newPassword: 'New Password',
                confirmPassword: 'Confirm Password',
                passwordChanged: 'Password changed',
                passwordMismatch: 'Passwords do not match',
                userManagement: 'User Management',
                users: 'Users',
                addUser: 'Add User',
                editUser: 'Edit User',
                deleteUser: 'Delete User',
                deleteUserConfirm: 'Really delete this user?',
                role: 'Role',
                roleAdmin: 'Administrator',
                roleUser: 'User',
                roleViewer: 'Viewer',
                displayName: 'Display Name',
                user: 'User',
                email: 'Email',
                userEnabled: 'Enabled',
                lastLogin: 'Last Login',
                never: 'Never',
                profile: 'Profile',
                
                // PegaProx Settings
                pegaproxSettings: 'PegaProx Settings',
                serverSettings: 'Server',
                networkSettings: 'Network Settings',
                domain: 'Domain',
                domainHint: 'Public domain to access PegaProx',
                port: 'Port',
                portHint: 'Default: 5000, HTTPS typically 443',
                httpRedirectPort: 'HTTP Redirect Port (additional)',
                httpRedirectPortHint: 'For port 80 redirect. -1 = off (default), 0 = auto, 80 = enabled. HTTP on same port redirects automatically.',
                sslSettings: 'SSL/TLS Certificate',
                enableSsl: 'Enable SSL',
                sslCertificate: 'SSL Certificate',
                sslKey: 'Private Key',
                noCertSelected: 'No certificate selected',
                noKeySelected: 'No key selected',
                browse: 'Browse',
                sslWarning: 'After enabling SSL, the server must be restarted. Make sure the certificate and key are valid!',
                sslHint: 'For Let\'s Encrypt: Use fullchain.pem as certificate and privkey.pem as key.',
                saveSettings: 'Save Settings',
                serverSettingsSaved: 'Server settings saved',
                restartRequired: 'Server restart required to apply changes',
                restartInfo: 'Note about Changes',
                restartInfoDesc: 'Changes to port or SSL settings require a restart of the PegaProx server.',
                errorSavingSettings: 'Error saving settings',
                restartServer: 'Restart Server',
                restartServerDesc: 'Restarts the PegaProx server to apply changes',
                restartNow: 'Restart Now',
                confirmRestart: 'Restart Server?',
                restartWarning: 'The server will be temporarily unavailable',
                restartConfirmText: 'Do you really want to restart the PegaProx server?',
                restartEffect1: 'All active connections will be disconnected',
                restartEffect2: 'The web interface will be unavailable for about 5-10 seconds',
                restartEffect3: 'Unsaved changes will be lost',
                yesRestart: 'Yes, restart',
                restarting: 'Restarting...',
                restartInitiated: 'Server restart initiated',
                reconnecting: 'Reconnecting...',
                restartFailed: 'Server restart failed',
                
                // Tenants & Permissions
                // Reddit feature request - MSPs needed this for customer isolation
                tenants: 'Tenants',
                tenant: 'Tenant',
                addTenant: 'Add Tenant',
                editTenant: 'Edit Tenant',
                deleteTenant: 'Delete Tenant',
                tenantSaved: 'Tenant saved',
                tenantClustersHint: 'Select which clusters this tenant can access (empty = all)',
                noVmsInCluster: 'No VMs found in this cluster',
                tenantsDesc: 'Tenants allow you to separate users and restrict access to specific clusters.',
                defaultTenant: 'Default Tenant',
                tenantClusters: 'Clusters for this tenant',
                allClusters: 'All clusters',
                
                // Cluster Groups - NS Jan 2026
                clusterGroups: 'Cluster Groups',
                clusterGroup: 'Cluster Group',
                addGroup: 'Add Group',
                editGroup: 'Edit Group',
                deleteGroup: 'Delete Group',
                groupName: 'Group Name',
                groupDescription: 'Description',
                groupColor: 'Color',
                assignToGroup: 'Assign to Group',
                ungrouped: 'Ungrouped',
                noGroup: 'No Group',
                removeFromGroup: 'Remove from Group',
                groupCreated: 'Group created',
                groupDeleted: 'Group deleted',
                groupUpdated: 'Group updated',
                manageGroups: 'Manage Groups',
                clusterGroupsDesc: 'Organize clusters into groups and assign them to tenants for access control.',
                noGroupsYet: 'No groups created yet',
                createGroupFirst: 'Create a group first',
                assignTenant: 'Assign to Tenant (optional)',
                noTenantAllVisible: 'No tenant (visible to all)',
                groupTenantHint: 'If assigned, only this tenant can see clusters in this group',
                groupsTip: 'Tip: Assign groups to tenants in Settings ‚Üí Cluster Groups for access control',
                
                permissions: 'Permissions',
                permission: 'Permission',
                permissionsDesc: 'Configure granular permissions for users. Role-based defaults can be overridden per user.',
                selectUser: 'Select User',
                selectUserToEdit: 'Select a user to edit permissions',
                effectivePermissions: 'Effective Permissions',
                extraPermissions: 'Extra Permissions',
                deniedPermissions: 'Denied Permissions',
                grantedByRole: 'Granted by role',
                permissionSaved: 'Permissions saved',
                tenantCreated: 'Tenant created',
                tenantDeleted: 'Tenant deleted',
                tenantUpdated: 'Tenant updated',
                cannotDeleteDefaultTenant: 'Cannot delete default tenant',
                reassignUsersFirst: 'Users must be reassigned first',
                
                // Custom Roles section
                roles: 'Roles',
                customRoles: 'Custom Roles',
                createRole: 'Create Role',
                roleId: 'Role ID',
                roleName: 'Display Name',
                rolesDesc: 'Create custom roles with specific permissions. Roles can be global or tenant-specific.',
                scope: 'Scope',
                global: 'Global',
                roleCreated: 'Role created',
                roleSaved: 'Role saved',
                roleDeleted: 'Role deleted',
                confirmDeleteRole: 'Delete this role?',
                builtinRole: 'Builtin Role',
                tenantSpecific: 'Tenant-specific',
                roleTemplates: 'Role Templates',
                roleTemplatesDesc: 'Quick-start templates for common role configurations',
                createFromTemplate: 'Create from Template',
                includedPermissions: 'Included Permissions',
                roleCreatedFromTemplate: 'Role created from template',
                vmAcl: 'VM Access Control',
                vmAclDesc: 'Set permissions for individual VMs',
                addVmAcl: 'Add VM Permission',
                editVmAcl: 'Edit VM Permission',
                vmPermissions: 'VM Permissions',
                noVmAcls: 'No VM-specific permissions configured. All VMs follow role-based access.',
                selectClusterFirst: 'Select a cluster first',
                selectVm: 'Select VM',
                usersWithAccess: 'Users with Access',
                inheritRolePerms: 'Full VM access (start, stop, console, etc.)',
                customPermissions: 'Custom Permissions',
                vmAclSaved: 'VM permissions saved',
                vmAclDeleted: 'VM permissions removed',
                confirmDeleteVmAcl: 'Remove custom permissions for this VM?',
                
                // Pool Permissions - MK Jan 2026
                poolPermissions: 'Pool Permissions',
                poolPermissionsDesc: 'Grant users or groups access to Proxmox resource pools. Permissions apply to all VMs within the pool.',
                managePools: 'Manage Pools',
                poolManagerDesc: 'Create, edit, and delete resource pools. Assign VMs to pools for organized permission management.',
                createPool: 'Create Pool',
                editPool: 'Edit Pool',
                deletePool: 'Delete Pool',
                poolId: 'Pool ID',
                poolIdRequired: 'Pool ID is required',
                poolIdHint: 'Letters, numbers, dashes and underscores only',
                poolIdCannotChange: 'Pool ID cannot be changed',
                poolCreated: 'Pool created successfully',
                poolUpdated: 'Pool updated successfully',
                poolDeleted: 'Pool deleted successfully',
                confirmDeletePool: 'Are you sure you want to delete this pool? This cannot be undone.',
                noPoolsYet: 'No pools yet',
                createFirstPool: 'Create your first pool to organize VMs',
                poolMembers: 'Members',
                members: 'members',
                addVmToPool: 'Add VM to Pool',
                removeFromPool: 'Remove from pool',
                vmAddedToPool: 'VM added to pool',
                vmRemovedFromPool: 'VM removed from pool',
                confirmRemoveVmFromPool: 'Remove VM from this pool?',
                selectVmToAdd: 'Select a VM to add to this pool',
                allVmsInPools: 'All VMs are already in pools',
                optionalDescription: 'Optional description...',
                userPermissions: 'User Permissions',
                selectPool: 'Select Pool',
                noPools: 'No resource pools found in this cluster',
                noPoolPerms: 'No permissions configured for this pool',
                selectPoolFirst: 'Select a cluster and pool to manage permissions',
                addPoolPerm: 'Add Pool Permission',
                editPoolPerm: 'Edit Pool Permission',
                poolPermSaved: 'Pool permission saved',
                poolPermDeleted: 'Pool permission removed',
                refreshPools: 'Refresh pools from Proxmox',
                poolCacheRefreshed: 'Pool cache refreshed',
                confirmDeletePoolPerm: 'Remove permission?',
                subjectType: 'Type',
                permissionsFor: 'Permissions for',
                addPermission: 'Add Permission',
                groupName: 'Group Name',
                
                auditLog: 'Audit Log',
                auditLogDescription: 'All user actions from the last 90 days',
                noAuditLogs: 'No audit entries available',
                action: 'Action',
                details: 'Details',
                timestamp: 'Timestamp',
                ipAddress: 'IP Address',
                userCreated: 'User created',
                userUpdated: 'User updated',
                userDeleted: 'User deleted',
                userLogin: 'Login',
                userLogout: 'Logout',
                passwordChanged: 'Password changed',
                clusterAdded: 'Cluster added',
                apiTokenWarningTitle: 'API Token Authentication',
                apiTokenWarningDesc: 'Using API tokens is supported but not all features will work correctly. Features requiring SSH access (SMBIOS Auto-Config, Rolling Updates, 2-Node HA, Node Shell) need password authentication. PegaProx recommends using a dedicated privileged user or root with password for full functionality.',
                clusterDeleted: 'Cluster deleted',
                clusterConfigChanged: 'Cluster config changed',
                vmStarted: 'VM started',
                vmStopped: 'VM stopped',
                vmRestarted: 'VM restarted',
                vmCreated: 'VM created',
                vmDeleted: 'VM deleted',
                vmCloned: 'VM cloned',
                vmMigrated: 'VM migrated',
                vmUnlocked: 'VM unlocked',
                vmLocked: 'VM locked',
                unlockVm: 'Unlock VM',
                lockReason: 'Lock Reason',
                unlockWarning: 'Warning: Unlocking a VM during an active operation may cause data corruption or other issues. Only proceed if you are sure the operation has failed or been cancelled.',
                vmBulkMigrated: 'Bulk migration',
                vmConfigChanged: 'VM config changed',
                vmSuspended: 'VM suspended',
                vmResumed: 'VM resumed',
                vmDiskAdded: 'Disk added',
                vmDiskRemoved: 'Disk removed',
                vmDiskResized: 'Disk resized',
                vmDiskMoved: 'Disk moved',
                vmNetworkAdded: 'Network added',
                vmNetworkRemoved: 'Network removed',
                vmNetworkUpdated: 'Network updated',
                removeDiskConfirm: 'Really remove disk',
                detachDisk: 'Detach',
                importDisk: 'Import Disk',
                importDiskDesc: 'Import existing disk image from storage',
                selectImportStorage: 'Select Source Storage',
                selectDiskImage: 'Select Disk Image',
                targetBus: 'Target Bus',
                reassignOwner: 'Reassign Owner',
                reassignOwnerDesc: 'Assign disk to a different VM',
                targetVm: 'Target VM',
                diskReassigned: 'Disk reassigned',
                diskImported: 'Disk imported',
                noImportableDisks: 'No importable disk images found',
                reassign: 'Reassign',
                import: 'Import',
                detachDiskConfirm: 'Really detach disk? It will become an unused disk.',
                diskDetached: 'Disk detached',
                diskDeleted: 'Disk deleted',
                diskAdded: 'Disk added',
                dataWillBeDeleted: 'Data will be permanently deleted!',
                removeNetworkConfirm: 'Really remove network',
                snapshotCreated: 'Snapshot created',
                snapshotDeleted: 'Snapshot deleted',
                snapshotRestored: 'Snapshot restored',
                rollbackConfirm: 'Really rollback to this snapshot? This cannot be undone!',
                replicationCreated: 'Replication created',
                replicationDeleted: 'Replication deleted',
                replicationTriggered: 'Replication triggered',
                haEnabled: 'HA enabled',
                haDisabled: 'HA disabled',
                noFallbackHosts: 'No fallback hosts found (Single-Node Cluster?)',
                haVmAdded: 'VM added to HA',
                haVmRemoved: 'VM removed from HA',
                nodeMaintenanceEntered: 'Maintenance mode entered',
                nodeMaintenanceExited: 'Maintenance mode exited',
                nodeUpdateStarted: 'Node update started',
                twoFactorAuth: 'Two-Factor Authentication',
                twoFactorEnabled: '2FA enabled',
                twoFactorDisabled: '2FA disabled',
                enable2FA: 'Enable 2FA',
                disable2FA: 'Disable 2FA',
                setup2FA: 'Setup 2FA',
                scan2FACode: 'Scan QR code with authenticator app',
                enter2FACode: 'Enter 6-digit code',
                verify2FA: 'Verify',
                secretKey: 'Secret Key',
                twoFARequired: '2FA code required',
                invalid2FACode: 'Invalid 2FA code',
                resetPassword: 'Reset Password',
                newPassword: 'New Password',
                confirmPassword: 'Confirm Password',
                currentPassword: 'Current Password',
                passwordsDoNotMatch: 'Passwords do not match',
                passwordTooShort: 'Password must be at least 4 characters',
                passwordResetSuccess: 'Password changed successfully',
                myProfile: 'My Profile',
                security: 'Security',
                snapshotNotSupported: 'Snapshots not supported',
                snapshotWarnings: 'Snapshot warnings',
                filterByUser: 'Filter by user',
                filterByAction: 'Filter by action',
                allUsers: 'All Users',
                allActions: 'All Actions',
                exportAuditLog: 'Export',
                refreshAuditLog: 'Refresh',
                
                // Header
                addCluster: 'Add Cluster',
                clusterManagement: 'PegaProx Cluster Management for Proxmox VE',
                
                // Tabs
                overview: 'Overview',
                resources: 'Resources',
                datacenter: 'Datacenter',
                settings: 'Settings',
                of: 'of',
                showing: 'Showing',
                perPage: 'Per page',
                loadingDatacenter: 'Loading datacenter data...',
                
                // Cluster
                clusters: 'Clusters',
                noClusterSelected: 'No Cluster Selected',
                allClustersOverview: 'All Clusters Overview',
                allClusters: 'All Clusters',
                multiClusterSummary: 'Summary of all managed clusters',
                clustersConnected: 'Clusters Connected',
                clusterOverview: 'Cluster Overview',
                vmsRunning: 'VMs Running',
                vmsStopped: 'VMs Stopped',
                noClustersConfigured: 'No clusters configured',
                addClusterToStart: 'Add a cluster to get started',
                clickClusterTip: 'Click on a cluster row or select from the sidebar to view detailed information and manage resources.',
                health: 'Health',
                average: 'Average',
                noDataAvailable: 'No data available',
                clickToManage: 'Click to manage',
                sortBy: 'Sort by',
                ungrouped: 'Ungrouped',
                alerts: 'Alerts',
                updated: 'Updated',
                justNow: 'just now',
                topResources: 'Top Resources',
                highestCpuUsage: 'Highest CPU and RAM usage across all clusters',
                clickToOpenVm: 'Click to open VM',
                selectCluster: 'Select a cluster from the list',
                addFirstCluster: 'Add First Cluster',
                connectCluster: 'Connect a Proxmox cluster with PegaProx',
                clusterName: 'Cluster Name',
                host: 'Host',
                username: 'Username',
                password: 'Password',
                passwordOrToken: 'Password / Token',
                apiTokenHint: 'For API tokens: user@realm!tokenid',
                sslVerification: 'SSL Verification',
                connecting: 'Connecting...',
                addNewCluster: 'Add New Cluster',
                testConnection: 'Test Connection',
                deleteCluster: 'Delete Cluster',
                deleteClusterConfirm: 'Really delete cluster?',
                clusterHealth: 'Cluster Health',
                excellent: 'Excellent',
                good: 'Good',
                warning: 'Warning',
                critical: 'Critical',
                nodesOnline: 'Nodes Online',
                avgScore: 'Avg. Score',
                avgCpu: 'Avg. CPU',
                avgRam: 'Avg. RAM',
                
                // Nodes
                nodes: 'Nodes',
                node: 'Node',
                loadingMetrics: 'Loading metrics...',
                connectionError: 'Connection Error',
                retry: 'Retry',
                checkConnectionAndRetry: 'Please check your connection and try again.',
                connectionTimeout: 'Timeout - Proxmox unreachable',
                maintenance: 'Maintenance',
                enterMaintenance: 'Enter Maintenance Mode',
                exitMaintenance: 'Exit Maintenance Mode',
                maintenanceMode: 'Maintenance Mode',
                update: 'Update',
                startUpdate: 'Start Update',
                nodeConfig: 'Node Configuration',
                cpuHistory: 'CPU History',
                ramHistory: 'RAM History',
                ramUsage: 'RAM Usage',
                cpuUsage: 'CPU Usage',
                diskUsage: 'Disk Usage',
                showMore: 'Show more',
                showLess: 'Show less',
                
                // VMs & Resources
                virtualMachines: 'Virtual Machines',
                containers: 'Containers',
                vm: 'VM',
                lxc: 'LXC',
                lxcContainer: 'LXC Container',
                container: 'Container',
                guests: 'Guests',
                start: 'Start',
                stop: 'Stop',
                shutdown: 'Shutdown',
                reboot: 'Reboot',
                forceStop: 'Force Stop',
                forceReset: 'Force Reset',
                forceStopConfirm: 'really force stop? This may cause data loss!',
                migrate: 'Migrate',
                migrateVm: 'Migrate VM',
                crossClusterMigration: 'Cross-Cluster Migration',
                crossClusterMigrateDesc: 'Migrate VM to another Proxmox cluster',
                crossClusterMigrate: 'Cross-Cluster Migrate',
                crossClusterStarted: 'Cross-Cluster Migration started',
                crossClusterFailed: 'Cross-Cluster Migration failed',
                sourceVm: 'Source VM',
                targetCluster: 'Target Cluster',
                targetNode: 'Target Node',
                targetStorage: 'Target Storage',
                targetBridge: 'Target Network (Bridge)',
                newVmid: 'New VMID (optional)',
                sameIdPlaceholder: 'Empty = same ID',
                liveMigrationOption: 'Live Migration (VM keeps running)',
                deleteSourceAfter: 'Delete source VM after migration',
                autoTokenInfo: 'PegaProx automatically creates temporary API tokens for migration and deletes them after completion.',
                clusterReachableInfo: 'Clusters must be able to reach each other over the network. The configured user must have permissions to create API tokens.',
                selectCluster: 'Select cluster...',
                selectNode: 'Select Node',
                selectStorage: 'Select storage...',
                loadingNodes: 'Loading target nodes...',
                loadingStorageNetwork: 'Loading storage/network...',
                liveMigration: 'Live Migration (no downtime)',
                on: 'on',
                targetStorage: 'Target Storage',
                sameAsSource: 'Same as source',
                loadingStorages: 'Loading storages',
                free: 'free',
                withLocalDisks: 'With Local Disks',
                withLocalDisksDesc: 'Migrate local disks to target storage',
                localDisksDetected: 'This VM has local disks. Migration requires copying disk data.',
                requiredForThisVm: 'Required for this VM',
                cdDvdMounted: 'CD/DVD Drive Mounted',
                cdDvdMigrationWarning: 'Live migration is not possible with a CD/DVD mounted. Please eject the CD/DVD first or use offline migration.',
                isoMounted: 'ISO/CD-ROM Mounted',
                isoMigrationWarning: 'Migration may fail if the ISO is not available on the target node. Eject the CD/DVD or ensure the ISO exists on shared storage.',
                localStorage: 'Local',
                bootOrderIssue: 'Boot Order Issue',
                bootOrderWarning: 'Boot order references non-existent disks',
                bootOrder: 'Boot Order',
                dragToReorder: 'Click to toggle, use arrows to reorder',
                noBootDevices: 'No boot devices found',
                resizeDiskHint: 'Increase by (e.g. +10G) or new size',
                // SMBIOS Settings
                smbiosSettings: 'SMBIOS Settings',
                smbiosHint: 'System Management BIOS - useful for Windows licensing and VM identification',
                applySmbiosFromClusterConfig: 'Apply SMBIOS settings from cluster configuration',
                requiresRestart: 'RESTART',
                readOnly: 'read-only',
                autoGenerated: 'auto-generated',
                smbiosFormatHint: 'Only letters and numbers allowed (A-Za-z0-9)',
                preview: 'Preview',
                currentValue: 'Current Value',
                managedByProxmox: 'managed by Proxmox',
                willBeAutoGenerated: 'Will be auto-generated on save',
                forceConntrack: 'Force (Conntrack State)',
                forceConntrackDesc: 'Force migration even if conntrack entries exist',
                containerNoLiveMigration: 'Containers do not support true live migration',
                startingMigration: 'Starting migration of',
                migrationStarted: 'Migration started:',
                migrationFailed: 'Migration failed',
                clone: 'Clone',
                console: 'Console',
                config: 'Configuration',
                configuration: 'Configuration',
                createVm: 'Create new VM',
                createContainer: 'Create new Container',
                noNodesAvailable: 'No nodes available. Please wait for cluster data to load.',
                loadingStorage: 'Loading storage list...',
                noIsoAvailable: 'No ISO images found',
                noTemplateAvailable: 'No templates found',
                noStorageAvailable: 'No storage available',
                noIsoStorage: 'No storage with ISO content found',
                ram: 'RAM',
                cpu: 'CPU',
                disk: 'Disk',
                network: 'Network',
                
                // VM Creation Wizard
                node: 'Node',
                next: 'Next',
                guestOs: 'Guest Operating System',
                isoImage: 'ISO Image',
                noIso: 'No ISO',
                virtioDrivers: 'VirtIO Drivers ISO (Windows)',
                noVirtioDrivers: 'No VirtIO Drivers',
                allIsos: 'All ISOs',
                virtioDriversHint: 'Will be mounted as additional CD-ROM for Windows driver installation',
                
                // MK: New wizard translations
                advancedCpu: 'Advanced CPU Settings',
                cpuAffinity: 'CPU Affinity',
                cpuAffinityHint: 'Pin vCPUs to specific host CPUs',
                enableNuma: 'Enable NUMA',
                advancedMemory: 'Advanced Memory Settings',
                minimumMemory: 'Minimum Memory',
                sameAsMemory: 'Same as Memory (no ballooning)',
                minimumMemoryHint: 'Lower limit for memory ballooning',
                ballooningDevice: 'Ballooning Device',
                memoryShares: 'Memory Shares',
                memorySharesHint: 'Weight for memory auto-ballooning (0-50000, default: 1000)',
                primaryDisk: 'Primary Disk',
                additionalDisk: 'Additional Disk',
                addDisk: 'Add Disk',
                macAddress: 'MAC Address',
                autoGenerate: 'Auto-generate (leave empty)',
                advancedNetwork: 'Advanced Network Settings',
                inheritBridge: 'Inherit from bridge',
                rateLimit: 'Rate Limit',
                unlimited: 'Unlimited',
                noLinkOnStart: 'No network link on start',
                highAvailability: 'High Availability',
                enableHa: 'Add to Proxmox Native HA',
                haGroup: 'HA Group',
                defaultGroup: 'Default group (leave empty)',
                rootFilesystem: 'Root Filesystem',
                mountPoint: 'Mount Point',
                addMountPoint: 'Add Mount Point',
                path: 'Path',
                busType: 'Bus/Type',
                size: 'Size',
                format: 'Format',
                storageDefault: 'Storage Default',
                bestPerformance: 'best performance',
                free: 'free',
                bridge: 'Bridge',
                model: 'Model',
                vlanTag: 'VLAN Tag (optional)',
                vlanExample: 'e.g. 100',
                enableFirewall: 'Enable Firewall',
                cpuType: 'CPU Type',
                machineType: 'Machine Type',
                efiSettings: 'UEFI/EFI Settings',
                efiDiskStorage: 'EFI Disk Storage',
                preEnrollKeys: 'Pre-enroll Microsoft Keys (SecureBoot)',
                tpmSettings: 'TPM (Trusted Platform Module)',
                enableTpm: 'Enable TPM',
                tpmStorage: 'TPM Storage',
                tpmVersion: 'TPM Version',
                recommended: 'recommended',
                win11NeedsTpm: 'Windows 11 requires TPM 2.0',
                efiTpmSettings: 'EFI & TPM Settings',
                efiDisk: 'EFI Disk',
                tpmChip: 'TPM Chip',
                configured: 'Configured',
                noEfiDisk: 'No EFI disk configured',
                addEfiDisk: 'Add EFI Disk',
                efiDiskRequired: 'Required for UEFI boot. Will be created automatically on first boot if not configured.',
                efiDiskInfo: 'EFI disk stores UEFI firmware variables and is required for UEFI boot. Size is automatically set to 4MB.',
                efiDiskAdded: 'EFI disk added',
                noTpm: 'No TPM configured',
                addTpm: 'Add TPM',
                tpmInfo: 'TPM (Trusted Platform Module) is required for Windows 11 and provides hardware-based security features like BitLocker.',
                tpmAdded: 'TPM added',
                confirmDeleteEfiDisk: 'Delete EFI disk? This may prevent the VM from booting.',
                confirmDeleteTpm: 'Delete TPM? Windows 11 and BitLocker will stop working.',
                efiDiskDeleted: 'EFI disk deleted',
                tpmDeleted: 'TPM deleted',
                enableQemuAgent: 'Enable QEMU Guest Agent',
                startOnBoot: 'Start on host boot',
                startAfterCreate: 'Start after creation',
                rootPassword: 'Root Password',
                sshPublicKeys: 'SSH Public Keys',
                loadSshKeyFile: 'Load SSH Key File',
                sshKeyHintMultiple: 'One key per line. Paste or load from file.',
                // SSH Shell Login
                dropKeyFileHere: 'Drop key file here or click',
                keyLoaded: 'Key loaded',
                lines: 'lines',
                keyPassphrase: 'Key Passphrase',
                optional: 'optional',
                ifKeyEncrypted: 'If key is encrypted...',
                connect: 'Connect',
                dnsDomain: 'DNS Domain',
                dnsServers: 'DNS Servers',
                useHostSettings: 'Use host settings',
                dnsServersHint: 'Space-separated list of DNS servers',
                disconnected: 'Disconnected',
                manual: 'Manual',
                ipAddress: 'IP Address',
                recommended: 'recommended',
                dockerSupport: 'Docker support',
                free: 'free',
                used: 'used',
                total: 'total',
                selectTemplate: 'Select template...',
                cpuCoresLabel: 'CPU Cores',
                swapMemory: 'Swap (MB)',
                unprivileged: 'Unprivileged',
                unprivilegedHint: 'Safer, but limited functionality',
                nesting: 'Nesting',
                nestingHint: 'Allows Docker/LXC in LXC',
                ipConfig: 'IP Configuration',
                useDhcp: 'Use DHCP',
                gateway: 'Gateway',
                lvmZfsIgnoreFormat: 'LVM/ZFS ignore format',
                targetNode: 'Target Node',
                sameNode: 'same node',
                crossNodeCloneWarning: 'Cross-node clone requires shared storage (NFS, Ceph, etc.). Local storage will not work!',
                willBeCloned: 'will be cloned',
                newVmId: 'New VM ID',
                cloneMode: 'Clone Mode',
                fullClone: 'Full Clone',
                fullCloneDesc: 'Independent copy of all data',
                linkedClone: 'Linked Clone',
                linkedCloneDesc: 'Faster, requires base image',
                onlyForVms: 'Only available for VMs',
                cloneNotes: 'Notes for clone...',
                optional: 'optional',
                
                gridView: 'Grid View',
                listView: 'List View',
                compactView: 'Compact View',
                selectAll: 'Select All',
                deselectAll: 'Deselect All',
                selectedItems: 'selected',
                bulkActions: 'Bulk Actions',
                quickActions: 'Quick Actions',
                moreActions: 'More Actions',
                xOfYResources: 'of',
                resourcesLabel: 'Resource Management',
                startClone: 'Start Clone',
                vmStillRunning: 'The VM is still running. It will be stopped before deletion.',
                ctStillRunning: 'The container is still running. It will be stopped before deletion.',
                confirmDelete: 'Confirm Delete',
                reallyDelete: 'Really delete?',
                connectionFailed: 'Connection failed',
                cloneFailed: 'Clone failed',
                forceStopFailed: 'Force stop failed',
                bulkMigrationFailed: 'Bulk migration failed',
                bulkMigration: 'Bulk Migration',
                vmsSelected: 'VMs selected',
                targetNode: 'Target Node',
                selectNode: 'Select node...',
                liveMigration: 'Live Migration (no downtime)',
                migrateVms: 'Migrate VMs',
                startingBulkMigration: 'Starting bulk migration of',
                creationFailed: 'Creation failed',
                actionFailed: 'Action failed',
                autoDetectionFailed: 'Auto-detection failed',
                clusterOffline: 'Cluster unreachable',
                connectionClosed: 'Connection closed',
                unexpectedDisconnect: 'Connection unexpectedly closed',
                serverError: 'Server error',
                switchTabToReconnect: 'Switch tab and back to reconnect',
                deleteInterfaceConfirm: 'Really delete interface?',
                noMigrationsYet: 'No migrations yet',
                showMore: 'Show all',
                showLess: 'Show less',
                olderMigrations: 'older migrations',
                paused: 'Paused',
                performanceMetrics: 'Performance Metrics',
                hour: 'Hour',
                day: 'Day',
                week: 'Week',
                month: 'Month',
                year: 'Year',
                
                // Detail View
                hostname: 'Hostname',
                tags: 'Tags',
                description: 'Description',
                changesRequireRestart: 'Note: Some changes require a restart',
                
                // Tags - NS Jan 2026
                manageTags: 'Manage Tags',
                noTags: 'No tags',
                newTag: 'New tag...',
                existingTags: 'Existing tags',
                
                // Schedules - MK Jan 2026
                schedules: 'Schedules',
                scheduledActions: 'Scheduled Actions',
                newSchedule: 'New Schedule',
                editSchedule: 'Edit Schedule',
                noSchedules: 'No Scheduled Actions',
                noSchedulesDesc: 'Create schedules to automatically start, stop, or snapshot VMs',
                createFirstSchedule: 'Create your first schedule',
                scheduleCreated: 'Schedule created',
                scheduleDeleted: 'Schedule deleted',
                scheduleType: 'Schedule Type',
                daily: 'Daily',
                weekdays: 'Weekdays',
                weekends: 'Weekends',
                weekly: 'Weekly',
                once: 'Once',
                forOnce: 'for once',
                forWeekly: 'for weekly',
                days: 'Days',
                lastRun: 'Last Run',
                
                // Reports - NS Jan 2026
                reports: 'Reports',
                reportsAnalytics: 'Reports & Analytics',
                lastHour: 'Last Hour',
                last24h: 'Last 24h',
                lastWeek: 'Last Week',
                noReportData: 'No Report Data',
                noReportDataDesc: 'Historical data is being collected. Check back in a few minutes.',
                topVmsCpu: 'Highest CPU Usage',
                topVmsMem: 'Highest Memory Usage',
                historicalRange: 'Historical Range',
                dataPoints: 'data points',
                vmsRunning: 'VMs Running',
                containersRunning: 'Containers Running',
                clustersOnline: 'Clusters Online',
                nodesOnline: 'Nodes Online',
                datacenterOverview: 'Datacenter Overview',
                noRunningVms: 'No running VMs',
                
                // Automation Tab - NS Jan 2026
                automation: 'Automation',
                schedulesDesc: 'Automatically start, stop, reboot or snapshot VMs on a schedule',
                tagsDesc: 'Organize VMs with tags. Click the tag icon on any VM to add tags.',
                noTagsInCluster: 'No tags in this cluster yet',
                addTagHint: 'Use the tag button on VMs in the Resources tab',
                tagsTotal: 'tags',
                clickVmTag: 'Click tag icon on VMs to manage',
                alertsDesc: 'Get notified when resources exceed thresholds',
                newAlert: 'New Alert',
                noAlertsCluster: 'No alerts for this cluster',
                alertCreated: 'Alert created',
                targetType: 'Apply to',
                entireCluster: 'Entire Cluster',
                specificNode: 'Specific Node',
                specificVm: 'Specific VM',
                targetId: 'Target',
                optional: 'optional',
                condition: 'Condition',
                cluster: 'Cluster',
                affinityDesc: 'Keep VMs together or separate across nodes',
                newRule: 'New Rule',
                noAffinityCluster: 'No affinity rules for this cluster',
                ruleCreated: 'Rule created',
                together: 'Together',
                separate: 'Separate',
                enforced: 'Enforced',
                
                // Config Modal Tabs
                generalTab: 'General',
                resourcesTab: 'Resources',
                storageTab: 'Storage',
                networkTab: 'Network',
                snapshotsTab: 'Snapshots',
                backupsTab: 'Backups',
                replicationTab: 'Replication',
                historyTab: 'History',
                proxmoxTasks: 'Proxmox Tasks',
                pegaproxActions: 'PegaProx Actions',
                optionsTab: 'Options',
                
                // Datacenter
                summary: 'Summary',
                cluster: 'Cluster',
                options: 'Options',
                storage: 'Storage',
                backup: 'Backup',
                replication: 'Replication',
                balancing: 'Balancing',
                excludedNodes: 'Excluded Nodes',
                excludedNodesDesc: 'These nodes will never be targets for automatic VM balancing or migration recommendations.',
                selectNodeToExclude: 'Select node to exclude...',
                exclude: 'Exclude',
                excludedFromBalancing: 'Excluded from balancing',
                reincludedInBalancing: 're-included in balancing',
                excludeNode: 'Exclude a node from balancing',
                noExcludedNodes: 'No nodes excluded - all nodes participate in balancing',
                confirmExcludeNode: 'Exclude',
                excludedVMs: 'Excluded VMs',
                excludedVMsDesc: 'These VMs will never be automatically migrated during load balancing.',
                selectVMToExclude: 'Select VM to exclude...',
                noExcludedVMs: 'No VMs excluded - all VMs participate in balancing',
                fromBalancing: 'from balancing',
                allNodesExcluded: 'All nodes are excluded - balancing is effectively disabled',
                howExclusionWorks: 'How node exclusion works',
                exclusionRule1: 'Excluded nodes will NOT be targets for automatic VM balancing',
                exclusionRule2: 'Excluded nodes will NOT receive VMs during load balancing migrations',
                exclusionRule3: 'Excluded nodes are still visible and can receive manual migrations',
                exclusionRule4: 'VMs on excluded nodes may still be migrated away if the node is overloaded',
                
                // NS: Backup translations - Dec 2025
                createBackup: 'Create Backup',
                noBackups: 'No backups found',
                noBackupsHint: 'Create a backup or check your backup storages',
                backupMode: 'Backup Mode',
                compression: 'Compression',
                backupStarted: 'Backup started',
                downloadStarted: 'Download started',
                downloadFailed: 'Download failed',
                restoreBackup: 'Restore Backup',
                selectedBackup: 'Selected Backup',
                targetVmid: 'Target VMID',
                targetStorage: 'Target Storage',
                originalStorage: 'Keep original',
                sameVmidWarning: 'Same VMID = VM will be overwritten!',
                startAfterRestore: 'Start after restore',
                confirmRestore: 'Really restore this backup?',
                restoreStarted: 'Restore started',
                confirmDeleteBackup: 'Really delete this backup?',
                backupDeleted: 'Backup deleted',
                // LW: backup mode options
                backupModeSnapshot: 'Snapshot (no stop)',
                backupModeSuspend: 'Suspend (brief pause)',
                backupModeStop: 'Stop (VM will stop)',
                compressZstd: 'ZSTD (recommended)',
                compressLzo: 'LZO (fast)',
                compressGzip: 'GZIP',
                compressNone: 'None',
                backupNotes: 'Notes (optional)',
                backupNotesPlaceholder: 'e.g. Before major update, weekly backup...',
                
                // HA
                ha: 'HA',
                haResources: 'HA Resources',
                haGroups: 'HA Groups',
                haStatus: 'HA Status',
                
                cpuCompatibility: 'CPU Compatibility',
                cpuCompatibilityMode: 'CPU Compatibility Mode',
                cpuCompatibilityDesc: 'Ensure live migration compatibility across different CPU generations',
                whatIsCpuCompat: 'What is CPU Compatibility Mode?',
                cpuCompatExplain: 'When you have nodes with different CPU generations (e.g., Haswell and Skylake), live migration may fail because newer CPUs expose features that older CPUs don\'t support.',
                cpuCompatSolution: 'By setting all VMs to use a common CPU type, you ensure they can migrate between any node in the cluster.',
                recommendedSettings: 'Recommended Settings',
                broadCompatibility: 'Broad compatibility - works with most CPUs from 2008+',
                modern: 'Modern',
                haswell: 'Haswell and newer (2013+)',
                newest: 'Newest',
                skylakeAvx: 'Skylake-X with AVX-512 (2017+)',
                noMigration: 'No Migration',
                hostDesc: 'Pass-through host CPU - best performance, no migration',
                nodesCpuInfo: 'Cluster Nodes CPU Information',
                howToApply: 'How to Apply',
                cpuStep1: 'Go to each VM\'s Hardware tab',
                cpuStep2: 'Edit the CPU setting',
                cpuStep3: 'Change "Type" to your chosen compatibility level',
                cpuStep4: 'Restart the VM for changes to take effect',
                autoDetectedRecommendation: 'Auto-Detected Recommendation',
                basedOnClusterCpus: 'Based on the CPUs detected in your cluster, we recommend:',
                availableLevels: 'Available Compatibility Levels',
                safest: 'Safest',
                detectedClusterCpus: 'Detected Cluster CPUs',
                loadingCpuInfo: 'Loading CPU information...',
                copy: 'Copy',
                criticalAlert: 'CRITICAL ALERT',
                haRecoveryMayStart: 'HA recovery may be in progress...',
                dismiss: 'Dismiss',
                nodeOffline: 'Node offline',
                nodeOnline: 'Node online',
                nodeUnreachable: 'Node unreachable',
                offlineSince: 'Offline since',
                firewall: 'Firewall',
                smbiosAuto: 'SMBIOS Auto',
                smbiosAutoDesc: 'Automatically configures SMBIOS data (Manufacturer, Product, Serial) for new VMs and VMs without SMBIOS configuration. Useful for Windows licensing.',
                deploySmbiosConfirm: 'Deploy SMBIOS Auto-Config to all nodes in this cluster?',
                rescanAllVms: 'Rescan all VMs',
                showLogs: 'Show logs',
                deployToAllNodes: 'Deploy to All Nodes',
                updateAllNodes: 'Update All Nodes',
                nodeStatus: 'Node Status',
                clickDeployToStart: 'Click "Deploy to All Nodes" to get started',
                smbiosRequiresSSH: '‚ö†Ô∏è Requires SSH key configured in cluster connection settings',
                whySSH: 'Why SSH?',
                smbiosSSHExplanation: 'This feature uses SSH to deploy hook scripts to nodes. SSH credentials can be optionally configured in cluster settings.',
                deployed: 'Deployed',
                notDeployed: 'Not Deployed',
                requiresSSH: 'Requires SSH',
                deploymentFailed: 'Deployment failed',
                clusterNodes: 'Cluster Nodes',
                joinInformation: 'Join Information',
                datacenterOptions: 'Datacenter Options',
                quorate: 'Quorate',
                votes: 'Votes',
                link: 'Link',
                resourceUsage: 'Resource Usage',
                memory: 'Memory',
                
                // Storage
                addStorage: 'Add Storage',
                storageId: 'Storage ID',
                directory: 'Directory',
                path: 'Path',
                server: 'Server',
                content: 'Content',
                shared: 'Shared',
                deleteStorageConfirm: 'Really delete storage?',
                deleteBackupJobConfirm: 'Really delete backup job?',
                storageType: 'Storage Type',
                volumeGroup: 'Volume Group',
                thinPool: 'Thin Pool',
                export: 'Export',
                share: 'Share',
                datastore: 'Datastore',
                pool: 'Pool',
                portal: 'Portal',
                skipCertVerification: 'Skip Certificate Verification',
                
                // Backup
                backupJobs: 'Backup Jobs',
                noBackupJobs: 'No Backup Jobs',
                createBackupJob: 'Create Backup Job',
                selectStorage: 'Select Storage',
                allNodes: 'All Nodes',
                hourly: 'Hourly',
                daily: 'Daily (02:00)',
                weekly: 'Weekly (Sunday 02:00)',
                monthly: 'Monthly (1st of month 02:00)',
                compression: 'Compression',
                notification: 'Notification',
                always: 'Always',
                onFailure: 'On Failure',
                never: 'Never',
                schedule: 'Schedule',
                selection: 'Selection',
                retention: 'Retention',
                
                // Replication
                replicationJobs: 'Replication Jobs',
                noReplicationJobs: 'No Replication Jobs',
                guest: 'Guest',
                job: 'Job',
                
                // Firewall
                firewallOptions: 'Firewall Options',
                firewallRules: 'Firewall Rules',
                noFirewallRules: 'No Firewall Rules',
                policyIn: 'Policy In',
                policyOut: 'Policy Out',
                addRule: 'Add Rule',
                deleteRuleConfirm: 'Really delete rule?',
                action: 'Action',
                protocol: 'Protocol',
                
                // Settings
                balancingConfig: 'Balancing Configuration',
                migrationThreshold: 'Migration Threshold',
                migrationThresholdDesc: 'Score difference that triggers a migration',
                checkInterval: 'Check Interval',
                checkIntervalDesc: 'Interval between balance checks',
                autoMigrate: 'Automatic Migration',
                autoMigrateDesc: 'Automatic VM migration on imbalance',
                dryRun: 'Dry Run Mode (no real migrations)',
                dryRunDesc: 'Only simulate migrations, do not execute',
                balancingEnabled: 'Balancing enabled',
                optionsTitle: 'Options',
                intervalBetweenChecks: 'Interval between balance checks',
                
                // HA
                highAvailability: 'High Availability (HA)',
                haEnabled: 'High Availability enabled',
                haMonitoring: 'HA Monitoring',
                haMonitorActive: 'HA Monitor active',
                fallbackHosts: 'Fallback Hosts',
                fallbackHostsAuto: 'Fallback Hosts (auto-detected)',
                proxmoxHa: 'Proxmox HA',
                proxmoxNativeHa: 'Proxmox Native HA',
                haGroups: 'HA Groups',
                haResources: 'HA Resources',
                fencing: 'Fencing',
                haInactive: 'Proxmox HA inactive',
                haActivate: 'Activate HA',
                enableNativeHa: 'Enable native Proxmox HA for this VM',
                haMonitorDesc: 'Monitors nodes every 10 seconds. On failure, VMs are automatically restarted on other nodes.',
                nativeHaDesc: 'Native Proxmox HA runs directly on the cluster and provides Fencing & Quorum.',
                vmsWithHa: 'VMs/CTs with Proxmox HA',
                noVmsWithHa: 'No VMs configured with Proxmox HA. Enable HA for individual VMs in the detail view.',
                removeFromHa: 'Remove from HA',
                deleteCannotBeUndone: 'This action cannot be undone!',
                purgeDisks: 'Purge - Delete all disks completely',
                destroyUnreferencedDisks: 'Delete unreferenced disks',
                enterToConfirm: 'Enter to confirm',
                deletePermanently: 'Delete permanently',
                updateNode: 'Update Node',
                updateCommand: 'Will run apt update && apt dist-upgrade.',
                rebootAfterUpdate: 'Reboot after update',
                recommendedForKernel: 'Recommended for kernel updates',
                startUpdate: 'Start Update',
                started: 'started',
                stopped: 'stopped',
                restarted: 'restarted',
                created: 'created',
                deleted: 'deleted',
                cloned: 'cloned',
                migrated: 'migrated',
                vmStillRunning: 'The VM is still running. It will be stopped before deletion.',
                ctStillRunning: 'The container is still running. It will be stopped before deletion.',
                primary: 'Primary',
                fallbacks: 'Fallbacks',
                
                // Messages
                connectionError: 'Connection Error',
                
                // Task Bar
                tasks: 'Tasks',
                taskMigrate: 'Migration',
                taskStart: 'Start',
                taskStop: 'Stop',
                taskReboot: 'Reboot',
                taskCreate: 'Create',
                taskDelete: 'Delete',
                taskClone: 'Clone',
                taskSnapshot: 'Snapshot',
                taskDiskMove: 'Move Disk',
                taskDiskResize: 'Resize Disk',
                taskFailed: 'Task failed',
                taskCancelled: 'Task cancelled',
                taskCancelFailed: 'Failed to cancel task',
                cancelTask: 'Cancel task',
                allTasks: 'All Tasks',
                runningTasks: 'Running Tasks',
                failedTasks: 'Failed Tasks',
                todaysTasks: 'Today\'s Tasks',
                tasksShown: 'tasks shown',
                taskOutput: 'Task Output',
                errorLoadingLog: 'Error loading log',
                duration: 'Duration',
                description: 'Description',
                clearCompleted: 'Clear completed',
                startTime: 'Start Time',
                endTime: 'End Time',
                output: 'Output',
                noOutput: 'No output',
                noTasks: 'No tasks available',
                completed: 'completed',
                success: 'Success',
                error: 'Error',
                unsavedChanges: 'Unsaved Changes',
                migrationStarted: 'Migration started',
                configSaved: 'Configuration saved',
                operationFailed: 'Operation failed',
                confirmAction: 'Confirm Action',
                
                // Misc
                lastCheck: 'Last Check',
                clusterInfo: 'Cluster Info',
                primaryHost: 'Primary Host',
                connectedTo: 'Connected to',
                fallback: 'Fallback',
                configured: 'configured',
                noRestrictions: 'No restrictions',
                general: 'General',
                advanced: 'Advanced',
                os: 'Operating System',
                template: 'Template',
                help: 'Help',
                lastMigrations: 'Last Migrations',
                noMigrations: 'No migrations',
                
                // Options labels
                keyboardLayout: 'Keyboard Layout',
                httpProxy: 'HTTP Proxy',
                consoleViewer: 'Console Viewer',
                emailFrom: 'Email From',
                macPrefix: 'MAC Prefix',
                migrationSettings: 'Migration Settings',
                replicationSettings: 'Replication Settings',
                haSettings: 'HA Settings',
                haSettingsSaved: 'HA settings saved',
                haEnabled: 'HA enabled',
                haDisabled: 'HA disabled',
                haActive: 'HA Active',
                haInactive: 'HA Inactive',
                clusterType: 'Cluster Type',
                quorum: 'Quorum',
                quorumYes: 'Yes',
                quorumNo: 'No',
                healthy: 'Healthy',
                degraded: 'Degraded',
                critical: 'Critical',
                splitBrainPrevention: 'Split-Brain Prevention',
                splitBrainInfo: 'In 2-node clusters, "split-brain" can occur when both nodes think the other is dead. Quorum hosts are pinged to decide which node may act.',
                splitBrainTip: 'Use IPs that both nodes can reach (gateway, DNS servers, or external IPs). For internal networks without internet: Use your router/gateway as quorum host.',
                quorumSettings: 'Quorum Settings',
                enableQuorumCheck: 'Enable Quorum Check',
                quorumCheckDesc: 'Prevents split-brain through external reachability check',
                gatewayIp: 'Gateway IP',
                gatewayIpHint: 'Your router/gateway for local networks',
                requiredVotes: 'Required Votes',
                additionalQuorumHosts: 'Additional Quorum Hosts (comma-separated)',
                quorumHostsHint: 'For isolated networks: Own DNS servers, routers, or other stable hosts in the network',
                selfFencingRecovery: 'Self-Fencing & Recovery',
                selfFencing: 'Self-Fencing',
                selfFencingDesc: 'Node without quorum will not start VMs',
                networkCheck: 'Network Check',
                networkCheckDesc: 'Checks connectivity before recovery',
                recoveryDelay: 'Recovery Delay (seconds)',
                recoveryDelayHint: 'Wait time before VMs are started on another node',
                failureThreshold: 'Failure Threshold',
                failureThresholdHint: 'Number of failed checks before node is considered offline',
                hardwareWatchdog: 'Hardware Watchdog',
                watchdogWarning: 'CAUTION: Node will automatically reboot on quorum loss!',
                
                // Fencing Explanation - NS Jan 2026
                fencingExplanation: 'How Split-Brain is Prevented',
                fencingStep1Title: '1. Quorum Loss Detection',
                fencingStep1Desc: 'The isolated node loses quorum (< 50% votes) and /etc/pve becomes READ-ONLY. The pve-ha-lrm automatically stops all HA VMs.',
                fencingStep2Title: '2. Self-Fencing (Self-Isolation)',
                fencingStep2Desc: 'The node recognizes it is isolated and refuses VM operations. This prevents two instances of the same VM running simultaneously.',
                fencingStep3Title: '3. Watchdog (Hardware Timer)',
                fencingStep3Desc: 'If enabled: A hardware/software timer is regularly reset. On quorum loss, the reset stops and the node is hard-rebooted after ~60s.',
                fencingStep4Title: '4. External Fencing (STONITH)',
                fencingStep4Desc: 'Optional hardware: IPMI/iLO/iDRAC or PDU powers off the node before VMs are started on another node.',
                fencingWarning: 'IMPORTANT: Without fencing mechanism, split-brain can cause data corruption!',
                fencingRecommendation: 'Recommendation for 2-Node Clusters:',
                fencingRecList: '‚Ä¢ Configure quorum hosts (gateway, DNS server)\n‚Ä¢ Enable hardware watchdog if available\n‚Ä¢ Set recovery delay to at least 30 seconds',
                
                enableHA: 'Enable HA',
                disableHA: 'Disable HA',
                changesAfterRestart: 'Changes active after restart',
                important2NodeCluster: 'important for 2-node clusters!',
                online: 'Online',
                
                // 2-Node Cluster Mode - NS Jan 2026
                twoNodeMode: '2-Node Cluster Mode',
                twoNodeWarning: '2-Node Cluster Limitation',
                twoNodeExplanation: 'In a 2-node Proxmox cluster, when one node fails, the surviving node loses quorum and cannot start VMs. This mode allows PegaProx to automatically force quorum on the surviving node.',
                enableTwoNodeMode: 'Enable 2-Node Cluster Mode',
                enableTwoNodeModeDesc: 'Automatically force quorum when one node fails',
                twoNodeReady: 'Ready for 2-Node HA',
                twoNodeCredentialsInfo: 'PegaProx will use the cluster credentials to SSH into the surviving node and run "pvecm expected 1" to restore quorum.',
                twoNodeTip: 'Tip',
                twoNodeTipText: 'For best results, install "sshpass" on the PegaProx server: apt install sshpass',
                
                // Split-Brain Risk - 2-Node - NS Jan 2026
                splitBrainRisk: 'Split-Brain Risk Without Fencing!',
                splitBrainRiskDesc: 'If both nodes are alive but network between them fails, forcing quorum can cause BOTH nodes to run the same VM = data corruption!',
                safeSolutions: 'Safe solutions for 2-Node clusters:',
                qdeviceDesc: 'Add a 3rd vote (Raspberry Pi is enough!)',
                ipmiDesc: 'Power off the other node before recovery',
                pduDesc: 'Smart power strip to cut power remotely',
                quorumHostsDesc2: 'External IPs to determine which node is isolated',
                safetyChecklist: 'Safety Checklist',
                quorumHostsConfigured: 'Quorum hosts configured',
                recoveryDelayCheck: 'Recovery delay ‚â• 30 seconds',
                selfFencingEnabled: 'Self-fencing enabled',
                
                // Storage-based Split-Brain Protection - NS Jan 2026
                storageHeartbeat: 'Storage-based Split-Brain Protection',
                recommendedFor2Node: 'Recommended for 2-Node Clusters!',
                storageHeartbeatDesc: 'Uses shared storage (NFS/Ceph/iSCSI) to coordinate between nodes. If a node fails to write heartbeats, it is confirmed dead. A "poison pill" mechanism tells the isolated node to stop its VMs before recovery starts.',
                enableStorageHeartbeat: 'Enable Storage-based Heartbeat',
                enableStorageHeartbeatDesc: 'Write heartbeats to shared storage for node health verification',
                storageHeartbeatPath: 'Shared Storage Path',
                storageHeartbeatPathHint: 'Path to shared storage accessible by all nodes (e.g., Ceph, NFS, iSCSI)',
                heartbeatTimeout: 'Heartbeat Timeout (s)',
                heartbeatTimeoutHint: 'Node dead if no heartbeat for this long',
                poisonPillEnabled: 'Enable Poison Pill Mechanism',
                poisonPillDesc: 'Tell isolated node to stop VMs via storage before recovery',
                strictFencing: 'Strict Fencing Mode',
                strictFencingDesc: 'ABORT recovery if node cannot be confirmed dead (safer but may cause false positives)',
                howItWorks: 'How it works',
                step1Heartbeat: 'PegaProx writes heartbeats to shared storage every 5 seconds',
                step2Check: 'When a node fails, storage heartbeat is checked to confirm death',
                step3Poison: 'A "poison pill" file is written telling the other node to stop VMs',
                step4Recovery: 'Only after confirmation/timeout does recovery proceed',
                nodeAgentRequired: 'Node Agent Required!',
                nodeAgentRequiredDesc: 'For this feature to work, you need to install the PegaProx Node Agent on each Proxmox node. The agent writes heartbeats and responds to poison pills.',
                
                // Automatic Split-Brain Protection - NS Jan 2026 - FULLY AUTOMATIC
                splitBrainProtection: 'Split-Brain Protection',
                fullyAutomatic: '100% AUTOMATIC',
                autoProtectionExplain: 'PegaProx automatically discovers shared storage, installs node agents, and protects against split-brain - no configuration needed!',
                sharedStoragesFound: 'Shared Storages Found:',
                inUse: 'IN USE',
                fullProtectionActive: 'Full dual-network protection active',
                nodeAgentsInstalled: 'Node agents auto-installed',
                heartbeatsViaStorage: 'Heartbeats via storage network',
                sshOnlyMode: 'SSH-Only Protection Mode',
                noSharedStorageFound: 'No shared storage (NFS/CephFS) found. Protection works via SSH verification.',
                notSafeForDualNetwork: 'Not safe for dual-network setups (separate server/storage networks)',
                
                // Block Storage Warning - NS Jan 2026
                blockStorageOnly: 'Only Block Storage Found',
                blockStorageExplain: 'Block storage (LVM, iSCSI, RBD) cannot store heartbeat files. For full dual-network protection, add a small NFS share.',
                sshOnlyActive: 'SSH-Only Protection Active',
                sshOnlyRisk: 'Works for single-network. For dual-network (separate server/iSCSI), add a small NFS share (100MB is enough).',
                
                // Multiple Storages - NS Jan 2026
                clickToSelect: 'Click to select',
                selected: 'Selected',
                currentlyActive: 'Currently active',
                blockStoragesIgnored: 'Block storages (not usable)',
                
                // Self-Fence Protection - NS Jan 2026
                selfFenceProtection: 'Self-Fence Protection',
                advancedSettings: 'Advanced Settings',
                selfFenceExplain: 'Each node checks if it can reach the manager OR another node. If nobody reachable ‚Üí node is isolated ‚Üí stops its own VMs.',
                howItWorks: 'How it works',
                nodeCanReachSomeone: 'Node can reach someone',
                everythingOk: 'Everything OK, do nothing',
                nodeCanReachNoone: 'Node can reach NOBODY',
                nodeStopsOwnVms: 'Isolated! Stops own VMs',
                selfFenceActive: 'Self-Fence Protection Active',
                agentInstalledOnNodes: 'Agent installed on',
                allNodes: 'all nodes',
                selfFenceNotInstalled: 'Self-Fence Agent not installed',
                selfFenceInstallHint: 'Click the button to install the agent on all nodes. The agent checks reachability every 5 seconds.',
                installSelfFenceAgent: 'Install Self-Fence Agent',
                selfFenceInstalling: 'Installing agent...',
                noSharedStorageNeeded: 'No shared storage needed',
                worksWithLvmIscsi: 'Works with LVM, iSCSI, anything',
                nodeDecidesItself: 'Node decides itself = fast reaction',
                uninstall: 'Uninstall',
                confirmUninstallAgent: 'Really uninstall Self-Fence Agent from all nodes?',
                selfFenceUninstalling: 'Uninstalling agent...',
                enable2NodeMode: 'Enable 2-Node Cluster Mode',
                twoNodeModeDesc: 'Automatically force quorum when one node fails',
                
                // Legacy translations (kept for compatibility)
                autoSplitBrainProtection: 'Automatic Split-Brain Protection',
                noSetupRequired: 'NO SETUP REQUIRED',
                autoProtectionDesc: 'PegaProx automatically prevents split-brain using your existing SSH credentials.',
                sshSucceeds: 'SSH succeeds:',
                networkSplitDetected: 'Network split! VMs stopped on partitioned node first',
                sshFails: 'SSH fails:',
                nodeConfirmedDead: 'Node confirmed dead, safe to failover',
                advancedOptions: 'Advanced Options',
                dualNetworkWarning: 'Dual-Network Setup? (Server + iSCSI)',
                dualNetworkProblem: 'If server network fails but iSCSI is up, SSH fails but node still writes to storage = DATA CORRUPTION!',
                enableDualNetworkProtection: 'Enable Storage-based Protection',
                dualNetworkProtectionDesc: 'Requires: PegaProx server can mount the shared storage (NFS/CephFS)',
                sharedStoragePath: 'Shared Storage Path',
                agentAutoInstall: 'Node agent will auto-install via SSH',
                
                // Device Passthrough
                devicePassthrough: 'Device Passthrough',
                pciDevices: 'PCI Devices',
                usbDevices: 'USB Devices',
                serialPorts: 'Serial Ports',
                addPci: 'Add PCI',
                addUsb: 'Add USB',
                addSerial: 'Add Serial',
                noPciDevices: 'No PCI Devices',
                noUsbDevices: 'No USB Devices',
                noSerialPorts: 'No Serial Ports',
                availableDevices: 'Available Devices',
                selectDevice: 'Select device',
                pcie: 'PCIe (recommended)',
                romBar: 'ROM-Bar',
                usb3: 'USB 3.0',
                serialType: 'Type',
                socketConsole: 'Socket (Unix Socket Console)',
                deviceAdded: 'Device added',
                deviceRemoved: 'Device removed',
                iommuGroup: 'IOMMU Group',
                vendor: 'Vendor',
                adding: 'Adding...',
                
                bandwidthLimits: 'Bandwidth Limits',
                maxWorkers: 'Max Workers',
                nextVmid: 'Next VMID',
                userTagAccess: 'User Tag Access',
                registeredTags: 'Registered Tags',
                
                // Subscription
                subscriptionStatus: 'Subscription Status',
                licensed: 'Licensed',
                notLicensed: 'Not Licensed',
                product: 'Product',
                licenseKey: 'License Key',
                validUntil: 'Valid Until',
                supportLevel: 'Support Level',
                noActiveSubscription: 'No Active Subscription',
                noSubscriptionDesc: 'This node has no valid Proxmox VE subscription. Without a subscription you will not receive enterprise updates or support.',
                enterLicenseKey: 'Enter License Key',
                subscriptionKey: 'Subscription Key',
                pleaseEnterLicenseKey: 'Please enter license key',
                licenseActivated: 'License activated successfully!',
                activationFailed: 'Activation failed',
                activateLicense: 'Activate License',
                refreshStatus: 'Refresh Status',
                subscriptionBenefits: 'A Proxmox VE Subscription provides',
                subscriptionBenefit1: 'Access to Enterprise Repository with stable updates',
                subscriptionBenefit2: 'Technical support from Proxmox',
                subscriptionBenefit3: 'No subscription warning on login',
                
                // Maintenance
                maintenanceModeTitle: 'Enable Maintenance Mode',
                maintenanceWarning: 'Warning: All running VMs and containers on this node will be automatically migrated to other nodes.',
                maintenanceDesc: 'The node will be excluded from load balancing until maintenance mode is disabled.',
                startMaintenance: 'Start Maintenance',
                removeNodeFromCluster: 'Remove Node from Cluster',
                removeNodeWarning: 'The node will be permanently removed from the cluster. All VMs must be migrated first.',
                removeNodeConfirm: 'Remove Node',
                removeNodeTypeName: 'Type node name to confirm',
                ready: 'Ready',
                completedWithErrors: 'Completed (with errors)',
                evacuating: 'Evacuating...',
                failed: 'Failed',
                starting: 'Starting...',
                progress: 'Progress',
                migrating: 'Migrating',
                vmsCouldNotMigrate: 'VM(s) could not be migrated',
                migrationIncomplete: 'Migration Incomplete',
                someVmsOnLocalStorage: 'Some VMs could not be migrated, likely due to local storage. You can:',
                proceedWithCaution: 'Proceed anyway (VMs will be stopped during reboot)',
                exitAndMigrateManually: 'Exit maintenance and migrate manually',
                forceMaintenanceWarning: '‚ö†Ô∏è WARNING: Proceeding will stop the remaining VMs on this node during reboot. Continue?',
                proceedAnyway: 'Proceed Anyway',
                failedToMigrate: 'Failed to migrate',
                vmsWillBeStopped: 'VM(s) will be stopped during reboot',
                updating: 'Updating',
                nodeConfiguration: 'Node Configuration',
                rebootNode: 'Reboot Node',
                shutdownNode: 'Shutdown Node',
                rebootNodeWarning: 'The node will be rebooted. Since it is in maintenance mode, no VMs are affected.',
                shutdownNodeWarning: 'The node will be shut down. You will need to power it on manually!',
                rebootNow: 'Reboot Now',
                shutdownNow: 'Shutdown Now',
                updateAndReboot: 'Update & Reboot',
                sudoNotAvailable: 'sudo is not available on this node',
                nodeActionFailed: 'Node action failed',
                startingUpdateFor: 'Starting update for',
                updateStartedFor: 'Update started for',
                errorStartingUpdate: 'Error starting update',
                rebootInitiated: 'reboot initiated',
                shutdownInitiated: 'shutdown initiated',
                updateRunning: 'Update running',
                updateFailed: 'Update failed',
                failedNodes: 'Failed Nodes',
                maintenanceModeWarning: 'Some nodes may still be in maintenance mode. Check the Nodes tab and exit maintenance mode manually if needed.',
                viewLogs: 'View Logs',
                updateCompleted: 'Update completed!',
                packagesUpdated: 'packages updated.',
                waitingForNode: 'Waiting for node...',
                done: 'Done',
                cancelAndExitMaintenance: 'Cancel & exit maintenance mode',
                sshSettings: 'SSH Settings',
                sshSettingsDesc: 'Required for node updates, reboot, and shutdown. If empty, Proxmox user/password will be used.',
                sshKeyOptional: 'SSH Key (Optional)',
                sshKeyExplanation: 'SSH features (SMBIOS Auto-Config, Custom Scripts, 2-Node HA) use your login credentials automatically. Only add a key here if password authentication is disabled on your nodes.',
                sshUser: 'SSH User',
                sshPort: 'SSH Port',
                sshPrivateKey: 'SSH Private Key',
                sshKeyHint: 'Paste your private key here (id_rsa, id_ed25519, etc.)',
                sshKeyRequired: 'SSH key required. Please configure in cluster settings.',
                balanceContainers: 'Balance Containers',
                balanceLocalDisks: 'Balance VMs with Local Disks',
                balanceLocalDisksDesc: 'VMs with local disks will be migrated with --with-local-disks (copies data to target)',
                localDiskBalanceWarning: 'Migration of VMs with local disks copies all disk data to the target node. This can take a long time and significantly increases network load.',
                containerBalanceWarning: 'Containers can NOT be live migrated! Migration will stop and restart the container, causing downtime.',
                clusterSettings: 'Cluster Settings',
                clusterSettingsDesc: 'Configure balancing settings for each cluster.',
                clusterSettingsSaved: 'Cluster settings saved',
                noClustersConfigured: 'No clusters configured',
                collapse: 'Collapse',
                threshold: 'Threshold',
                interval: 'Interval',
                saveSettings: 'Save Settings',
                haEnabled: 'HA Enabled',
                
                // Common notifications
                connectionError: 'Connection error',
                saveFailed: 'Save failed',
                deleteError: 'Delete error',
                activationError: 'Activation error',
                deactivationError: 'Deactivation error',
                bulkMigrationNote: 'Migrations will be performed sequentially. This may take some time.',
                deleteFailed: 'Delete failed',
                createFailed: 'Create failed',
                configSaved: 'Configuration saved',
                failedToSaveSettings: 'Failed to save settings',
                failedToUnlockIp: 'Failed to unlock IP',
                failedToUnlockAllIps: 'Failed to unlock all IPs',
                snapshotFailed: 'Snapshot failed',
                rollbackFailed: 'Rollback failed',
                replicationCreated: 'Replication created',
                replicationDeleted: 'Replication deleted',
                replicationStarted: 'Replication started',
                startFailed: 'Start failed',
                unlockVm: 'Unlock VM',
                vmLocked: 'VM is locked',
                vmUnlocked: 'VM unlocked',
                
                // Security Settings
                securitySettings: 'Security Settings',
                securityDashboard: 'Security Dashboard',
                issuesFound: 'issues found',
                allSecure: 'All systems secure',
                securityUpdates: 'Security Updates',
                bannedIps: 'Banned IPs',
                securityIssues: 'Security Issues',
                recommendations: 'Recommendations',
                enableClusterFirewall: 'Enable cluster-wide firewall',
                installSecurityUpdates: 'Install pending security updates',
                enable2fa: 'Enable two-factor authentication',
                disableRootLogin: 'Disable SSH root login',
                clusterFirewall: 'Cluster Firewall',
                nodeFirewalls: 'Node Firewalls',
                rules: 'rules',
                noSecurityUpdates: 'No security updates pending',
                systemUpToDate: 'All systems are up to date',
                sshConfiguration: 'SSH Configuration per Node',
                activeJails: 'Active Jails',
                totalBanned: 'Total Banned',
                installed: 'Installed',
                notInstalled: 'Not Installed',
                optional: 'Optional',
                refreshSecurityAudit: 'Refresh Security Audit',
                analyzingSecurity: 'Analyzing security...',
                bruteForceProtection: 'Brute Force Protection',
                bruteForceProtectionDesc: 'Configure login attempt limits and lockout durations to block unauthorized access attempts',
                loginProtection: 'Login Protection',
                passwordPolicy: 'Password Policy',
                minPasswordLength: 'Minimum Length',
                requireUppercase: 'Uppercase',
                requireLowercase: 'Lowercase',
                requireNumbers: 'Numbers',
                requireSpecial: 'Special chars',
                sessionTimeout: 'Session Timeout',
                hours: 'hours',
                days: 'days',
                securityRecommendations: 'Security Recommendations',
                securityRecommendationsDesc: 'Suggestions to improve PegaProx security',
                httpsEnabled: 'Connection is encrypted',
                httpsDisabled: 'Consider enabling HTTPS for secure connections',
                sessionTimeout: 'Session Timeout',
                currentlySetTo: 'Currently set to',
                adminAccounts: 'Admin Accounts',
                adminAccountsActive: 'admin account(s) active',
                defaultCredentials: 'Default Credentials',
                noDefaultPassword: 'No default passwords detected',
                defaultPasswordWarning: 'Default admin password is still in use!',
                lockAfter: 'Lock after',
                failedAttempts: 'failed attempts',
                auditLogging: 'Audit Logging',
                auditLoggingEnabled: 'All actions are logged for security',
                secure: 'Secure',
                recommended: 'Recommended',
                good: 'Good',
                considerLowering: 'Consider lowering',
                reviewRecommended: 'Review recommended',
                actionRequired: 'Action Required',
                maxLoginAttempts: 'Max Login Attempts',
                maxLoginAttemptsDesc: 'Number of failed attempts before lockout',
                lockoutTime: 'Lockout Time',
                attemptWindow: 'Attempt Window',
                lockedIps: 'Locked IPs',
                noLockedIps: 'No IPs locked',
                unlockAll: 'Unlock All',
                unlockAllConfirm: 'Really unlock all IPs?',
                allIpsUnlocked: 'All IPs unlocked',
                unlock: 'Unlock',
                unlocked: 'unlocked',
                locked: 'locked',
                attempts: 'attempts',
                remaining: 'remaining',
                
                // About page translations
                about: 'About',
                developmentTeam: 'Development Team',
                creditsAcknowledgments: 'Credits & Acknowledgments',
                links: 'Links',
                
                // update Manager
                updateManager: 'Update Manager',
                updateManagerDesc: 'Check and install updates on all cluster nodes',
                checkForUpdates: 'Check for Updates',
                checkingUpdates: 'Checking updates...',
                updatesAvailable: 'Updates available',
                noUpdatesAvailable: 'No updates available',
                packagesAvailable: 'packages available',
                securityUpdates: 'Security updates',
                lastChecked: 'Last checked',
                neverChecked: 'Never checked',
                startRollingUpdate: 'Start Rolling Update',
                updateThisNode: 'Update this Node',
                rebootRequired: 'Reboot required for kernel',
                package: 'Package',
                currentVersion: 'Current',
                newVersion: 'New',
                noUpdatesForNode: 'This node is up to date',
                updateNode: 'Update Node',
                updateNodeDesc: 'This will run apt update && apt dist-upgrade on the node.',
                kernelUpdateDetected: 'Kernel update detected',
                rebootRecommended: 'A reboot is recommended to apply kernel changes.',
                rebootAfterUpdate: 'Reboot after update',
                startUpdate: 'Start Update',
                updateStarted: 'Update started',
                updates: 'updates',
                nodeNotInMaintenance: 'Node is not in maintenance mode.',
                forceUpdateWarning: 'Running VMs on this node may be affected if a reboot is performed.',
                continueAnyway: 'Continue anyway?',
                rollingUpdateDesc: 'Updates all nodes one by one. Each node is put into maintenance mode, VMs are migrated, updates are installed, and optionally rebooted.',
                rollingUpdateInProgress: 'Rolling Update in Progress',
                currentlyUpdating: 'Currently updating',
                waitingForReboot: 'Waiting for reboot',
                nodesCompleted: 'Nodes completed',
                nodesRemaining: 'Nodes remaining',
                includeReboot: 'Reboot after update',
                includeRebootHint: 'Recommended for kernel updates',
                
                // PegaProx Auto-Update - NS Jan 2026
                confirmUpdate: 'This will download and install the update. A backup will be created. The server will restart automatically. Continue?',
                downloadingUpdate: 'Downloading update...',
                installingUpdate: 'Installing update...',
                serverRestarting: 'Server restarting...',
                reconnecting: 'Reconnecting...',
                updateSuccessRestarting: 'Update installed! Server is restarting...',
                updateComplete: 'Update complete! Please refresh the page.',
                alreadyUpToDate: 'Already up to date!',
                installUpdate: 'Install Update',
                updateAvailable: 'Update Available!',
                newVersionAvailable: 'New Version Available!',
                updateTo: 'Update to',
                currentVersion: 'Current version',
                viewUpdate: 'View Update',
                later: 'Later',
                whatsNew: "What's New",
                breakingChanges: 'Breaking Changes',
                doNotCloseWindow: 'Please do not close this window...',
                rollback: 'Rollback',
                rollbackDesc: 'Restore a previous version from backup',
                viewBackups: 'View Backups',
                selectBackup: 'Select Backup to Restore',
                noBackupsFound: 'No backups found',
                confirmRollback: 'This will restore PegaProx from backup. The server will restart. Continue?',
                restoringBackup: 'Restoring from backup...',
                rollbackSuccess: 'Rollback successful! Server is restarting...',
                rollbackWarning: '‚ö†Ô∏è Rollback will restart the server. Make sure you have saved any unsaved work.',
                
                // Security / Military Grade Encryption - NS Jan 2026
                securityStatus: 'Security Status',
                dataEncryption: 'Data Encryption',
                passwordHashing: 'Password Hashing',
                compliance: 'Compliance',
                complianceStatus: 'Compliance Status',
                auditLogIntegrity: 'Audit Log Integrity',
                encryptionKey: 'Encryption Key',
                corsConfiguration: 'CORS Configuration',
                verifyIntegrity: 'Verify Integrity',
                rotateKey: 'Rotate Key',
                rotating: 'Rotating...',
                recommendations: 'Recommendations',
                totalEntries: 'Total Entries',
                verified: 'Verified',
                unsigned: 'Unsigned (old)',
                tampered: 'Potentially Tampered',
                algorithm: 'Algorithm',
                keySize: 'Key Size',
                lastRotation: 'Last Rotation',
                backups: 'Backups',
                allowedOrigins: 'Allowed Origins',
                // IP Whitelisting
                ipWhitelisting: 'IP Whitelisting',
                enableIPWhitelist: 'Enable IP Whitelist',
                ipWhitelistDesc: 'Only allow access from specific IP addresses',
                yourIP: 'Your current IP',
                whitelist: 'Whitelist',
                blacklist: 'Blacklist',
                allowedIPs: 'Allowed IPs',
                blockedIPs: 'Always Blocked',
                testIP: 'Test IP Access',
                supportedFormats: 'Supported formats',
                // Config Backup/Restore
                configBackupRestore: 'Configuration Backup & Restore',
                exportConfig: 'Export Configuration',
                importConfig: 'Import Configuration',
                includeUsers: 'Include user accounts',
                includeSecrets: 'Include passwords & secrets',
                includeAuditLog: 'Include audit log',
                canBeLarge: 'Can be large',
                sensitive: 'Sensitive',
                downloadBackup: 'Download Backup',
                exporting: 'Exporting...',
                merge: 'Merge',
                overwrite: 'Overwrite',
                keepExisting: 'Keep existing',
                replaceAll: 'Replace all',
                restoreUsers: 'Restore user accounts',
                notAdmin: 'Excluding admin',
                dryRun: 'Dry run',
                validateOnly: 'Validate only, don\'t apply',
                selectBackupFile: 'Select Backup File',
                importing: 'Importing...',
                dryRunComplete: 'Dry run complete - check results below',
                dryRunResults: 'Dry Run Results',
                restoreComplete: 'Configuration restored',
                restoreResults: 'Restore Results',
                backupVersion: 'Backup version',
                backupDate: 'Backup date',
                backupDownloaded: 'Encrypted backup downloaded',
                backupBy: 'Created by',
                restored: 'Restored',
                skipped: 'Skipped',
                // Secure Backup
                secureBackup: 'Secure Backup',
                secureBackupDesc: 'Backups are encrypted with AES-256-GCM. You must provide your password and a backup encryption password.',
                securityVerification: 'Security Verification',
                exportSecurityDesc: 'To create an encrypted backup, please verify your identity and set a backup password.',
                importSecurityDesc: 'To restore a backup, please verify your identity and enter the backup password.',
                yourPassword: 'Your Password',
                enterYourPassword: 'Enter your account password',
                backupPassword: 'Backup Password',
                backupPasswordPlaceholder: 'Min. 8 characters - remember this!',
                confirmBackupPassword: 'Confirm Backup Password',
                repeatBackupPassword: 'Repeat backup password',
                backupPasswordMin8: 'Backup password must be at least 8 characters',
                passwordsNoMatch: 'Passwords do not match',
                backupPasswordRequired: 'Backup password required',
                rememberBackupPassword: 'Remember the backup password! Without it, you cannot restore the backup.',
                createBackup: 'Create Backup',
                restoreBackup: 'Restore Backup',
                restoreFromBackup: 'Restore from Backup',
                validateBackup: 'Validate Backup',
                backupFile: 'Backup File',
                backupPasswordUsedWhenCreating: 'Password used when creating backup',
                autoMigration: 'Auto Migration',
                militaryGradeEncryption: 'Military Grade Encryption',
                skipNode: 'Skip node',
                retryNode: 'Retry node',
                cancelRollingUpdate: 'Cancel Rolling Update',
                confirmRollingUpdate: 'Confirm Rolling Update',
                rollingUpdateWarning: 'All nodes will be updated one by one. VMs will be migrated automatically.',
                skipUpToDate: 'Skip up-to-date nodes',
                skipUpToDateHint: 'Nodes without updates will be skipped',
                advancedOptions: 'Advanced Options',
                evacuationTimeout: 'Evacuation Timeout',
                evacuationTimeoutHint: 'How long to wait for VMs to migrate before timeout',
                skipEvacuation: 'Skip VM evacuation',
                skipEvacuationHint: 'NOT RECOMMENDED - VMs stay on node during update',
                skipEvacuationWarning: '‚ö†Ô∏è Warning: VMs may crash if something goes wrong during the update!',
                scheduleUpdates: 'Schedule Updates',
                enableAutoUpdate: 'Enable Automatic Updates',
                autoUpdateDesc: 'Automatically run rolling updates on schedule',
                updateDay: 'Update Day',
                updateTime: 'Update Time',
                serverTimezone: 'Server timezone',
                autoUpdateInfo: 'Nodes will be updated one by one. VMs will be automatically migrated. Up-to-date nodes will be skipped.',
                scheduleSaved: 'Update schedule saved',
                scheduledFor: 'Scheduled for',
                schedule: 'Schedule',
                experimental: 'EXPERIMENTAL',
                experimentalWarning: 'Use with caution - this feature is currently experimental. Test in non-production environments first.',
                runOnce: 'Run Once',
                recurring: 'Recurring',
                runOnceInfo: 'The update will run once at the scheduled time and then disable itself.',
                monday: 'Monday',
                tuesday: 'Tuesday',
                wednesday: 'Wednesday',
                thursday: 'Thursday',
                friday: 'Friday',
                saturday: 'Saturday',
                sunday: 'Sunday',
                daily: 'Daily',
                hour: 'hour',
                hours: 'hours',
                estimatedTime: 'Estimated time',
                minutes: 'minutes',
                updateHistory: 'Update History',
                viewUpdateLog: 'View Update Log',
                checkingForUpdates: 'Checking for Updates',
                checkingNodes: 'Checking nodes for available updates...',
                connectingToCluster: 'Connecting to cluster...',
                processingResults: 'Processing results...',
                // Repo management - MK
                repoInfo: 'Manage APT repositories for this node. Enable/disable repositories to control which packages are available.',
                repoProxmoxNotice: 'Note: Due to Proxmox\'s switch to a new source format, the display may currently be inaccurate. We\'re working on it.',
                requiresSubscription: 'Requires Subscription',
                detected: 'Detected',
                notConfigured: 'Not configured',
                repoWarning: 'Mixing enterprise and no-subscription repositories is not recommended. After changing repositories, run "apt update" to refresh the package list.',
                noReposFound: 'No repositories found',
                currentNode: 'Current Node',
                currentStep: 'Current Step',
                updateLogs: 'Update Logs',
                started: 'Started',
                
                // VM Detail buttons
                console: 'Console',
                configuration: 'Configuration',
                
                // Config Modal
                cpuCores: 'CPU Cores',
                cpuLimit: 'CPU Limit',
                memory: 'Memory (RAM)',
                hardware: 'Hardware',
                disks: 'Disks',
                
                // Config Modal Tabs
                mountIso: 'Mount ISO',
                noIsoEject: 'No ISO (eject)',
                device: 'Device',
                target: 'Target',
                cdrom: 'CD-ROM',
                hardDisk: 'Hard Disk',
                existingCdrom: 'Existing CD-ROM drive',
                hardDiskNotAvailable: 'Hard Disk - not available!',
                freeSlot: 'Free Slot',
                mount: 'Mount',
                eject: 'Eject',
                addDisk: 'Add Disk',
                freeSpace: 'Free',
                notEnoughSpace: 'Not enough space!',
                usedSpace: 'Used',
                resize: 'Resize',
                move: 'Move',
                remove: 'Remove',
                editDiskType: 'Change Bus Type',
                changeDiskBusType: 'Change Disk Bus Type',
                vmIsRunning: 'VM is running',
                vmMustBeStopped: 'VM must be stopped',
                vmMustBeStoppedForBusChange: 'The VM must be stopped before changing the disk bus type. Please shut down the VM first.',
                currentDisk: 'Current',
                diskBusWarning: 'Changing the bus type requires the VM to be stopped. The guest OS may need driver updates.',
                selectNewBusType: 'Select new bus type',
                scsiDesc: 'Best performance with VirtIO SCSI controller',
                virtioDesc: 'Legacy VirtIO, good performance',
                sataDesc: 'Good compatibility, moderate performance',
                ideDesc: 'Maximum compatibility, lowest performance',
                current: 'Current',
                changeBusType: 'Change Bus Type',
                saving: 'Saving...',
                diskBusChanged: 'Disk bus type changed',
                optionsWillBeRemoved: 'The following options are not supported and will be removed',
                noDisksConfigured: 'No disks configured',
                unusedDisks: 'Unused Disks',
                unusedDisksDesc: 'These disks are detached but still exist. You can reattach or delete them.',
                reattach: 'Reattach',
                reattachDisk: 'Reattach disk',
                selectBusType: 'Select Bus Type',
                diskId: 'Disk ID',
                nextAvailableId: 'Next available ID for selected bus type',
                diskOptions: 'Disk Options',
                ideLimitedOptions: 'IDE has limited options available',
                preview: 'Preview',
                attaching: 'Attaching...',
                volume: 'Volume',
                diskReattached: 'Disk reattached',
                deleteUnusedDiskConfirm: 'Permanently delete disk? This cannot be undone!',
                unusedDiskDeleted: 'Unused disk deleted',
                deletePermanently: 'Delete permanently',
                configLoadError: 'Could not load configuration',
                networkInterfaces: 'Network Interfaces',
                addNetwork: 'Add Network',
                noNetworksConfigured: 'No networks configured',
                networkDisconnected: 'Network disconnected',
                disconnectNetwork: 'Disconnect Network',
                disconnectNetworkHint: 'Simulates an unplugged network cable',
                connectNetwork: 'Connect Network',
                createSnapshot: 'Create Snapshot',
                unknown: 'Unknown',
                rollback: 'Rollback',
                noSnapshots: 'No snapshots available',
                createReplication: 'Create Replication',
                replicationNeedsTwoNodes: 'Replication requires at least 2 nodes in the cluster',
                lastSync: 'Last Sync',
                neverSynced: 'Never synced',
                syncNow: 'Sync Now',
                noReplicationJobs: 'No Replication Jobs',
                startOnBoot: 'Start on Boot',
                protection: 'Protection (prevent delete/modify)',
                kvmVirtualization: 'KVM Hardware Virtualization',
                unprivilegedContainer: 'Unprivileged Container',
                osType: 'OS Type',
                other: 'Other',
                hotplug: 'Hotplug',
                hotplugHint: 'Devices that can be added while VM is running',
                hotplugDisk: 'Disk',
                hotplugNetwork: 'Network',
                hotplugUsb: 'USB',
                hotplugMemory: 'Memory',
                hotplugCpu: 'CPU',
                qemuGuestAgent: 'QEMU Guest Agent',
                qemuGuestAgentHint: 'Enables shutdown, freeze/thaw for snapshots',
                fstrim: 'FSTRIM after Clone/Migration',
                fstrimHint: 'Automatically run TRIM after clone',
                
                // More modals
                optional: 'optional',
                snapshotDescription: 'Snapshot description...',
                saveRamState: 'Save RAM state (Hibernate)',
                create: 'Create',
                createReplicationJob: 'Create Replication Job',
                targetNode: 'Target Node',
                rateLimit: 'Rate Limit (MB/s)',
                unlimited: 'Unlimited',
                comment: 'Comment',
                commentPlaceholder: 'e.g. DR replication',
                every5min: 'Every 5 minutes',
                every15min: 'Every 15 minutes',
                every30min: 'Every 30 minutes',
                hourly: 'Hourly',
                every2hours: 'Every 2 hours',
                every4hours: 'Every 4 hours',
                every6hours: 'Every 6 hours',
                every12hours: 'Every 12 hours',
                daily: 'Daily (midnight)',
                size: 'Size',
                enableFirewall: 'Enable Firewall',
                editNetwork: 'Edit Network',
                enableNuma: 'Enable NUMA',
                viommu: 'vIOMMU (Virtualized IOMMU)',
                viommuInfo: 'Required for nested virtualization and certain passthrough scenarios',
                sockets: 'Sockets',
                ballooningMinimum: 'Ballooning Minimum',
                swap: 'Swap',
                cpuType: 'CPU Type',
                scsiController: 'SCSI Controller',
                machineType: 'Machine Type',
                machineTypePlaceholder: 'e.g. q35 or i440fx (empty = default)',
                none: 'None',
                compatible: 'compatible',
                cache: 'Cache',
                noCache: 'No cache',
                default: 'Default',
                unsafe: 'unsafe',
                fastest: 'fastest',
                discard: 'Discard',
                ioThread: 'IO Thread',
                ssdEmulation: 'SSD Emulation',
                cores: 'Cores',
                branding: 'Branding',
                appName: 'App Name',
                customLogo: 'Custom Logo',
                logoHint: 'PNG, SVG, or GIF recommended. Max 500KB.',
                logoUploaded: 'Logo uploaded',
                logoUploadFailed: 'Logo upload failed',
                logoDeleted: 'Logo removed',
                remove: 'Remove',
                upload: 'Upload',
                thanksToSponsors: 'Thanks to our Sponsors',
                sponsorSubtitle: 'Supporting open source development',
                becomeSponsor: 'Become a sponsor',
                madeWithLove: 'Made with ‚ù§Ô∏è for the Proxmox community',
                settingsSaved: 'Settings saved',
                saveError: 'Error saving',
                dnsSaved: 'DNS saved',
                hostsSaved: 'Hosts saved',
                searchDomain: 'Search Domain',
                dnsServer: 'DNS Server',
                time: 'Time',
                timezone: 'Timezone',
                localTime: 'Local Time',
                sslCertificates: 'SSL Certificates',
                uploadCustomCert: 'Upload Custom Certificate',
                issuer: 'Issuer',
                valid: 'Valid',
                expired: 'Expired',
                noCertificates: 'No certificates found',
                certificate: 'Certificate',
                privateKey: 'Private Key',
                certChainHint: 'Can contain multiple certificates (chain)',
                restartPveproxyAfterUpload: 'Restart pveproxy after upload',
                certAndKeyRequired: 'Certificate and key required',
                certUploaded: 'Certificate uploaded!',
                uploadCertificate: 'Upload Certificate',
                deleteCertConfirm: 'Delete custom certificate and revert to self-signed?',
                certDeleted: 'Certificate deleted',
                deleteCustomCert: 'Delete Custom Cert',
                syslogLatest: 'Syslog (latest entries)',
                noLogEntries: 'No log entries',
                datastore: 'Datastore',
                datastores: 'Datastores',
                esxiHosts: 'ESXi Hosts',
                connectEsxi: 'Connect ESXi Host',
                esxiHostname: 'ESXi Hostname/IP',
                esxiUsername: 'Username',
                esxiPassword: 'Password',
                esxiConnected: 'ESXi connected',
                esxiVms: 'ESXi VMs',
                migrateToProxmox: 'Import to Proxmox',
                esxiMigrationHint: 'VM must be powered off on ESXi!',
                esxiMigrating: 'Import in progress...',
                esxiMigrationStarted: 'Import started',
                esxiDisconnect: 'Disconnect',
                esxiNoVms: 'No VMs on this ESXi host',
                esxiExperimental: 'ESXi import uses native Proxmox feature (PVE 8.1+)',
                noEsxiHosts: 'No ESXi hosts connected',
                fillAllFields: 'Please fill all fields',
                confirmDisconnect: 'Disconnect this ESXi host?',
                connect: 'Connect',
                sharedStorage: 'Shared Storage',
                selectStorage: 'Select a storage to view contents',
                clickStorageToView: 'Click on a storage to view its contents',
                storageEmpty: 'This storage is empty',
                content: 'Content',
                format: 'Format',
                browse: 'Browse',
                storageDrsDesc: 'Automatically balance disk usage across shared storage',
                storageUsage: 'Storage Usage',
                currentImbalance: 'Current Imbalance',
                threshold: 'Threshold',
                recommendations: 'Recommendations',
                migrate: 'Migrate',
                storageBalanced: 'All storage is well balanced. No action needed.',
                experimentalFeature: 'Experimental Feature',
                storageBalancingExperimental: 'Storage Balancing is still experimental. We appreciate your feedback!',
                uploadIso: 'Upload ISO',
                downloadFromUrl: 'Download from URL',
                fromUrl: 'From URL',
                isoUrl: 'ISO URL',
                isoUrlHint: 'Direct link to ISO file (http/https)',
                autoDetect: 'Auto-detect from URL',
                startingDownload: 'Starting download...',
                downloading: 'Downloading...',
                downloadFailed: 'Download failed',
                selectFile: 'Select File',
                confirmDelete: 'Confirm Delete',
                deleteConfirmText: 'Are you sure you want to delete',
                createStorageCluster: 'Create Storage Cluster',
                noStorageClusters: 'No storage clusters configured',
                createStorageClusterHint: 'Create a cluster to balance storage across multiple volumes',
                selectCluster: 'Select a storage cluster',
                selectClusterToView: 'Select a storage cluster to view balancing status',
                balancingThreshold: 'Balancing Threshold',
                thresholdDesc: 'Trigger balancing when imbalance exceeds this value',
                actionRecommended: 'Action Recommended',
                balanced: 'Balanced',
                storagesInCluster: 'Storages in Cluster',
                addStorage: '+ Add Storage',
                clusterName: 'Cluster Name',
                selectStorages: 'Select Storages',
                minTwo: 'min. 2',
                noSharedStorages: 'No shared storages available',
                confirmDeleteCluster: 'Delete this storage cluster?',
                minTwoStorages: 'Minimum 2 storages required',
                needTwoStorages: 'Need at least 2 storages',
                migrationStarted: 'Migration started!',
                autoBalance: 'Auto-Balance',
                autoBalanceActive: 'Auto-Balance Active',
                autoBalanceDesc: 'Disks will be automatically migrated when imbalance exceeds threshold. VMs with active snapshots/backups are skipped.',
                dryRunShort: 'Dry Run',
                connecting: 'Connecting...',
                needsRestart: 'NEEDS RESTART',
                
                // NS: Alerts, Tasks, Tags, Affinity - Dec 2025
                alerts: 'Alerts',
                alertsDesc: 'Email notifications when thresholds are exceeded',
                createAlert: 'Create Alert',
                editAlert: 'Edit Alert',
                alertName: 'Alert Name',
                alertMetric: 'Metric',
                alertThreshold: 'Threshold',
                alertOperator: 'Condition',
                alertTarget: 'Target',
                alertTargetType: 'Target Type',
                noAlerts: 'No alerts configured',
                testEmail: 'Send Test Email',
                testEmailSuccess: 'Test email sent!',
                testEmailFailed: 'Failed to send test email',
                enterEmailAddress: 'Please enter an email address',
                saveSmtpSettings: 'Save SMTP Settings',
                smtpSettingsSaved: 'SMTP settings saved!',
                enableSmtpHint: 'Enable SMTP to configure email settings',
                smtpHostRequired: 'SMTP host is required',
                smtpFromEmailRequired: 'From email address is required',
                emailRecipients: 'Email Recipients',
                addRecipient: 'Add Recipient',
                
                scheduledTasks: 'Scheduled Tasks',
                scheduledTasksDesc: 'Automate VM operations on a schedule',
                createTask: 'Create Task',
                editTask: 'Edit Task',
                taskName: 'Task Name',
                taskAction: 'Action',
                taskSchedule: 'Schedule',
                scheduleType: 'Schedule Type',
                scheduleTime: 'Time',
                scheduleDay: 'Day',
                noScheduledTasks: 'No scheduled tasks',
                runNow: 'Run Now',
                lastRun: 'Last Run',
                hourly: 'Hourly',
                daily: 'Daily',
                weekly: 'Weekly',
                monthly: 'Monthly',
                
                tagsLabels: 'Tags & Labels',
                tagsDesc: 'Categorize and group VMs',
                createTag: 'Create Tag',
                tagName: 'Tag Name',
                tagColor: 'Color',
                noTags: 'No tags defined',
                assignedVms: 'Assigned VMs',
                
                affinityRules: 'Affinity Rules',
                customScripts: 'Custom Scripts',
                scriptsDesc: 'Run custom .sh or .py scripts on cluster nodes',
                newScript: 'New Script',
                noScripts: 'No scripts configured',
                scriptsInfo: 'Create scripts to automate tasks across your cluster nodes',
                runScript: 'Run Script',
                runScriptConfirm: 'Run this script?',
                scriptStarted: 'Script execution started',
                scriptDeleted: 'Script deleted',
                scriptCreated: 'Script created',
                scriptUpdated: 'Script updated',
                scriptPermissions: 'Script Permissions',
                scriptPermissionsDesc: 'Scripts require SSH access to nodes. Configure SSH key in cluster settings.',
                scriptContent: 'Script Content',
                targetNodes: 'Target Nodes',
                scriptWarning: 'Scripts run with SSH user permissions. Ensure scripts are safe before running.',
                passwordRequiredForScripts: 'Password confirmation required for security',
                viewOutput: 'View Output',
                noOutput: 'No output available',
                output: 'Output',
                affinityDesc: 'Determine which VMs should run together or separately',
                createAffinityRule: 'Create Rule',
                editAffinityRule: 'Edit Rule',
                ruleName: 'Rule Name',
                ruleType: 'Rule Type',
                together: 'Together (same host)',
                separate: 'Separate (different hosts)',
                selectVms: 'Select VMs',
                noAffinityRules: 'No affinity rules',
                enforceRule: 'Enforce Rule',
                enforceRuleHint: 'Block migrations that would violate this rule',
                
                // Console Settings - NS Jan 2026
                consoleSettings: 'Console Ports',
                vncPort: 'VNC Port',
                shellPort: 'Shell Port',
                consolePortHint: 'VNC for VM consoles, Shell for node terminals. Server restart required after changes!',
                nodeShellHint: 'To access node shell or see detailed performance, use the Proxmox UI button above or connect directly to the node.',
                selfSignedCertWarning: 'Self-signed Certificates',
                selfSignedCertHint: 'VNC and Shell run on separate ports. With self-signed certificates, you need to accept them in your browser once.',
                openVncPort: 'Open VNC Port',
                openShellPort: 'Open Shell Port',
                certInstructions: 'For self-signed certificates:',
                certStep1: '1. Open this link in a new tab:',
                certStep2: '2. Accept the certificate in your browser',
                certStep3: '3. Come back and try again',
                acceptCert: 'Accept Certificate',
                openInProxmox: 'Open in Proxmox',
                connectionError: 'Connection Error',
                wsConnectionFailed: 'WebSocket connection failed',
                checkServerLogs: 'Check server logs for details',
                connectingWs: 'Connecting WebSocket',
                wsConnected: 'WebSocket connected, waiting for server...',
                ipFetchFailed: 'Failed to fetch IP',
                
                smtpSettings: 'SMTP Settings',
                smtpHost: 'SMTP Server',
                smtpPort: 'Port',
                smtpUser: 'Username',
                smtpPassword: 'Password',
                smtpFromEmail: 'From Email',
                smtpFromName: 'From Name',
                smtpTls: 'Use TLS',
                smtpSsl: 'Use SSL',
                alertCooldown: 'Alert Cooldown (seconds)',
                
                migrationHistory: 'Migration History',
                noMigrationHistory: 'No migrations recorded',
                
                // LW: Password expiry settings
                passwordExpiry: 'Password Expiry',
                passwordExpiryDesc: 'Force users to change their password after a specified number of days.',
                passwordExpiryHint: 'Users receive email reminders at 14, 7, 3, and 1 day(s) before expiry. A warning banner is shown in the UI. SMTP must be configured for emails.',
                sendExpiryEmails: 'Send email notifications when password is about to expire',
                expiryDays: 'Password expires after',
                warningDays: 'Warn users before',
                
                // LW: Password expiry banner
                passwordExpired: 'Your password has expired!',
                passwordExpiresIn: 'Your password expires in {days} days',
                pleaseChangeNow: 'Please change it now.',
                pleaseChangeSoon: 'Please change it soon.',
                changePassword: 'Change Password',
                dismissForNow: 'Remind me later',
                
                // LW: Reset all passwords - Dec 2025
                forcePasswordReset: 'Force Password Reset',
                forcePasswordResetDesc: 'Expire all user passwords immediately. Use after security incidents.',
                resetAllPasswords: 'Reset All',
                confirmPasswordReset: 'Confirm Password Reset',
                resetAllWarning: 'This will force ALL users to change their passwords on next login. This action cannot be undone.',
                includeAdmins: 'Include admin accounts',
                includeAdminsWarning: 'Warning: You will also need to change your password!',
                includeAdminsInExpiry: 'Include admin accounts',
                includeAdminsInExpiryDesc: 'Admins will also need to change their passwords regularly',
                
                // Theme System - NS Jan 2026
                appearance: 'Appearance',
                themeDesc: 'Choose a color theme for the interface',
                themeNote: 'Theme changes are applied immediately and saved to your account.',
                chooseTheme: 'Choose Your Theme',
                themePersonal: 'Select a theme that suits your style. This setting is personal and only affects your account.',
                defaultTheme: 'Default Theme',
                defaultThemeDesc: 'Set the default theme for new users. Users can change their theme in My Profile.',
                currentDefault: 'Current default',
                themeInProfile: 'Change your theme in My Profile (click your username in the top right)',
                
                // UI Layout - NS Jan 2026
                uiLayout: 'UI Layout',
                layoutDesc: 'Choose between different interface layouts.',
                inventory: 'Inventory',
                selectItem: 'Select an item from the tree',
                summary: 'Summary',
                monitor: 'Monitor',
                configure: 'Configure',
                console: 'Console',
                
                
                snapshots: 'Snapshots',
                snapshotsOverview: 'Snapshot Overview',
                snapshotsCleanUp: 'Cleanup',
                snapshotsDesc: 'Overview of the oldest snapshots in this cluster',
                snapshotsHint: 'Overview of the oldest snapshots over all guests within the cluster.',
                snapshotsType: 'Type',
                snapshotsDate: 'Created',
                snapshotsAge: 'Age',
                snapshotsAction: 'Action',
                noSnapshots: 'No snapshots found',
            }
        };

        // Language Context
        // LW: Default is German (de) since thats what we use internally
        const LanguageContext = createContext();

        function LanguageProvider({ children }) {
            // Persist language preference in localStorage
            const [language, setLanguage] = useState(() => {
                const saved = localStorage.getItem('pegaprox-language');
                return saved || 'de';  // German default
            });

            // Translation function with English fallback
            const t = useCallback((key) => {
                return translations[language]?.[key] || translations['en']?.[key] || key;
            }, [language]);

            const changeLanguage = useCallback((lang) => {
                setLanguage(lang);
                localStorage.setItem('pegaprox-language', lang);
            });

            return(
                <LanguageContext.Provider value={{ language, t, changeLanguage }}>
                    {children}
                </LanguageContext.Provider>
            );
        }

        function useTranslation() {
            return useContext(LanguageContext);
        }

        // Language Switcher Component
        function LanguageSwitcher() {
            const { language, changeLanguage } = useTranslation();
            
            return(
                <div className="flex items-center gap-1 bg-proxmox-dark rounded-lg p-1 border border-proxmox-border">
                    <button
                        onClick={() => changeLanguage('de')}
                        className={`flex items-center gap-1.5 px-2 py-1 rounded text-sm transition-all ${language === 'de' ? 'bg-proxmox-orange text-white' : 'text-gray-400 hover:text-white'}`}
                        title="Deutsch (√ñsterreich)"
                    >
                        <span className="text-base">üá¶üáπ</span>
                        <span className="hidden sm:inline">DE</span>
                    </button>
                    <button
                        onClick={() => changeLanguage('en')}
                        className={`flex items-center gap-1.5 px-2 py-1 rounded text-sm transition-all ${language === 'en' ? 'bg-proxmox-orange text-white' : 'text-gray-400 hover:text-white'}`}
                        title="English"
                    >
                        <span className="text-base">üá¨üáß</span>
                        <span className="hidden sm:inline">EN</span>
                    </button>
                </div>
            );
        }

        // ============================================
        // Authentication System
        // NS: Simple session-based auth. Sessions stored server-side.
        // Passwords hashed with bcrypt on backend.
        // ============================================
        
        const AuthContext = createContext();
        
        function AuthProvider({ children }) {
            const [user, setUser] = useState(null);
            // NS: Security fix - session cookie is HttpOnly (can't be stolen by XSS)
            // But we also keep sessionId in memory for WebSocket auth (not in localStorage!)
            const [sessionId, setSessionId] = useState(null);
            const [isAuthenticated, setIsAuthenticated] = useState(false);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [passwordExpiry, setPasswordExpiry] = useState(null);  // LW: Track password expiration
            
            // Check session on mount
            useEffect(() => {
                checkSession();
            }, []);
            
            // check if session still valid (cookie is sent automatically)
            const checkSession = async () => {
                try {
                    // Add cache-busting to prevent stale data
                    const r = await fetch(`${API_URL}/auth/check?t=${Date.now()}`, {
                        credentials: 'include',  // Important: send cookies
                        headers: { 
                            'Cache-Control': 'no-cache, no-store, must-revalidate',
                            'Pragma': 'no-cache'
                        }
                    });
                    
                    if (r && r.ok) {
                        const d = await r.json();
                        console.log('Session check response:', d);
                        if (d.authenticated) {
                            setUser(d.user);
                            setIsAuthenticated(true);
                            // NS: Get session_id from response for WebSocket auth
                            if (d.session_id) {
                                setSessionId(d.session_id);
                            }
                            // LW: Store password expiry info if present
                            if (d.password_expiry) {
                                setPasswordExpiry(d.password_expiry);
                            }
                            // NS: Apply user's theme or default
                            const userTheme = d.user?.theme || d.default_theme || 'proxmoxDark';
                            if (userTheme && PEGAPROX_THEMES[userTheme]) {
                                applyTheme(userTheme);
                            }
                        } else {
                            logout();
                        }
                    } else {
                        logout();
                    }
                } catch (err) {
                    console.error('Session check failed:', err);
                    console.log('err obj:', err);
                    logout();
                }
                setLoading(false);
            };
            
            // -lw: Main login handler - supports 2FA flow
            // TODO: add "remember me" checkbox somtime
            const login = async (username, password, totpCode = '') => {
                setError(null);
                console.log('login attempt:', username);  // tmp debug
                try {
                    const resp = await fetch(`${API_URL}/auth/login`, {
                        method: 'POST',
                        credentials: 'include',  // Important: receive and send cookies
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username, password, totp_code: totpCode })
                    });
                    
                    const data = await resp.json();
                    
                    // rate limit check
                    if (resp.status === 429 && data.locked) {
                        setError(`${data.error}`);
                        return { success: false, locked: true, retry_after: data.retry_after };
                    }
                    
                    // 2fa required?
                    if (resp.ok && data.requires_2fa) {
                        return { requires_2fa: true };
                    }
                    
                    if (resp.ok && data.success) {
                        setUser(data.user);
                        setIsAuthenticated(true);
                        // NS: Keep session_id in memory for WebSocket auth
                        if (data.session_id) {
                            setSessionId(data.session_id);
                        }
                        // NS: Apply user's theme
                        const userTheme = data.user?.theme;
                        if (userTheme && PEGAPROX_THEMES[userTheme]) {
                            applyTheme(userTheme);
                        }
                        // NS: Security warning for default password
                        if (data.security_warning === 'DEFAULT_PASSWORD') {
                            setTimeout(() => {
                                alert('‚ö†Ô∏è SECURITY WARNING!\n\nYou are using the default admin password.\nPlease change it immediately in Settings ‚Üí Users!');
                            }, 500);
                        }
                        return { success: true };
                    } else {
                        setError(data.error || 'Login failed');
                        return { success: false, error: data.error };
                    }
                } catch (err) {
                    console.error('login err', err);
                    setError('Connection error');
                    return { success: false, error: 'Connection error' };
                }
            };
            
            // LW: Update user preferences (theme, language, ui_layout)
            const updatePreferences = async (prefs) => {
                try {
                    console.log('updatePreferences: Sending request with prefs:', prefs);
                    const r = await fetch(`${API_URL}/user/preferences`, {
                        method: 'PUT',
                        credentials: 'include',  // Important: send session cookie
                        headers: { 
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(prefs)
                    });
                    console.log('updatePreferences: Response status:', r.status);
                    
                    if (r.ok) {
                        const data = await r.json();
                        console.log('updatePreferences: Response data:', data);
                        
                        // Update user in state
                        setUser(currentUser => {
                            const updated = {
                                ...currentUser,
                                theme: data.theme,
                                language: data.language,
                                ui_layout: data.ui_layout
                            };
                            console.log('updatePreferences: Updated user state:', updated);
                            return updated;
                        });
                        
                        // Apply theme immediately AND save to localStorage
                        if (data.theme && PEGAPROX_THEMES[data.theme]) {
                            applyTheme(data.theme);
                        }
                        return { success: true, data };
                    }
                    
                    const errorData = await r.json().catch(() => ({}));
                    console.error('updatePreferences: Request failed:', errorData);
                    return { success: false, error: errorData.error };
                } catch (e) {
                    console.error('Failed to update preferences:', e);
                    return { success: false, error: e.message };
                }
            };
            
            const logout = async () => {
                try {
                    await fetch(`${API_URL}/auth/logout`, {
                        method: 'POST',
                        credentials: 'include'  // Cookie is sent automatically
                    });
                } catch (err) {
                    console.error('Logout request failed:', err);
                }
                setUser(null);
                setSessionId(null);
                setIsAuthenticated(false);
            };
            
            // NS: No more X-Session-ID header needed for fetch - cookies are automatic
            // But sessionId is still available for WebSocket URLs
            const getAuthHeaders = () => {
                return {};  // Empty - credentials: 'include' handles auth for fetch
            };
            
            return(
                <AuthContext.Provider value={{ user, sessionId, isAuthenticated, loading, error, login, logout, getAuthHeaders, isAdmin: user?.role === 'admin', passwordExpiry, updatePreferences }}>
                    {children}
                </AuthContext.Provider>
            );
        }
        
        function useAuth() {
            return useContext(AuthContext);
        }
        
        // Login Screen Component
        // LW: Keep this simple - first thing users see!
        function LoginScreen() {
            const { t } = useTranslation();
            const { login, error } = useAuth();
            const [username, setUsername] = useState('');
            const [password, setPassword] = useState('');
            const [totpCode, setTotpCode] = useState('');
            const [loading, setLoading] = useState(false);
            const [showPassword, setShowPassword] = useState(false);
            const [requires2FA, setRequires2FA] = useState(false);
            
            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!username || !password) return;
                if (requires2FA && !totpCode) return;
                
                setLoading(true);
                const result = await login(username, password, totpCode);
                
                if (result?.requires_2fa) {
                    setRequires2FA(true);
                }
                setLoading(false);
            };
            
            return(
                <div className="min-h-screen bg-proxmox-darker flex items-center justify-center p-4">
                    <div className="w-full max-w-md">
                        {/* Logo and Title */}
                        <div className="text-center mb-8">
                            <img 
                                src="/images/pegaprox.png" 
                                alt="PegaProx" 
                                className="w-24 h-24 mx-auto mb-4 rounded-full object-cover shadow-lg shadow-orange-500/30"
                                onError={(e) => {
                                    // fallback to styled div if PNG not found
                                    e.target.outerHTML = '<div class="w-24 h-24 mx-auto mb-4 rounded-full bg-gradient-to-br from-proxmox-orange to-orange-600 flex items-center justify-center shadow-lg shadow-orange-500/30"><svg class="w-12 h-12 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2" /></svg></div>';
                                }}
                            />
                            <h1 className="text-3xl font-bold text-white mb-2">PegaProx</h1>
                            <p className="text-gray-400">{t('loginSubtitle')}</p>
                        </div>
                        
                        {/* Login Form */}
                        <div className="bg-proxmox-card border border-proxmox-border rounded-2xl p-8 shadow-xl">
                            <h2 className="text-xl font-semibold text-white mb-6">
                                {requires2FA ? t('twoFARequired') : t('loginTitle')}
                            </h2>
                            
                            {error && (
                                <div className="mb-4 p-3 bg-red-500/10 border border-red-500/30 rounded-lg text-red-400 text-sm">
                                    {error}
                                </div>
                            )}
                            
                            <form onSubmit={handleSubmit} className="space-y-5">
                                {!requires2FA ? (
                                    <>
                                        <div>
                                            <label className="block text-sm font-medium text-gray-300 mb-2">
                                                {t('usernameLabel')}
                                            </label>
                                            <input
                                                type="text"
                                                value={username}
                                                onChange={(e) => setUsername(e.target.value)}
                                                className="w-full px-4 py-3 bg-proxmox-dark border border-proxmox-border rounded-xl text-white placeholder-gray-500 focus:outline-none focus:border-proxmox-orange transition-colors"
                                                placeholder="pegaprox"
                                                autoComplete="username"
                                                autoFocus
                                            />
                                        </div>
                                        
                                        <div>
                                            <label className="block text-sm font-medium text-gray-300 mb-2">
                                                {t('passwordLabel')}
                                            </label>
                                            <div className="relative">
                                                <input
                                                    type={showPassword ? 'text' : 'password'}
                                                    value={password}
                                                    onChange={(e) => setPassword(e.target.value)}
                                                    className="w-full px-4 py-3 bg-proxmox-dark border border-proxmox-border rounded-xl text-white placeholder-gray-500 focus:outline-none focus:border-proxmox-orange transition-colors pr-12"
                                                    placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                                                    autoComplete="current-password"
                                                />
                                                <button
                                                    type="button"
                                                    onClick={() => setShowPassword(!showPassword)}
                                                    className="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-white"
                                                >
                                                    {showPassword ? (
                                                        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21" />
                                                        </svg>
                                                    ) : (
                                                        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                                                        </svg>
                                                    )}
                                                </button>
                                            </div>
                                        </div>
                                    </>
                                ) : (
                                    <div>
                                        <label className="block text-sm font-medium text-gray-300 mb-2">
                                            {t('enter2FACode')}
                                        </label>
                                        <input
                                            type="text"
                                            value={totpCode}
                                            onChange={(e) => setTotpCode(e.target.value.replace(/\D/g, '').slice(0, 6))}
                                            className="w-full px-4 py-3 bg-proxmox-dark border border-proxmox-border rounded-xl text-white text-center text-2xl tracking-widest placeholder-gray-500 focus:outline-none focus:border-proxmox-orange transition-colors"
                                            placeholder="000000"
                                            maxLength={6}
                                            autoFocus
                                        />
                                        <p className="text-gray-400 text-sm mt-2 text-center">
                                            {t('scan2FACode')}
                                        </p>
                                    </div>
                                )}
                                
                                <button
                                    type="submit"
                                    disabled={loading || !username || !password}
                                    className="w-full py-3 bg-proxmox-orange rounded-xl text-white font-semibold hover:bg-orange-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
                                >
                                    {loading ? (
                                        <>
                                            <svg className="w-5 h-5 animate-spin" fill="none" viewBox="0 0 24 24">
                                                <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                                                <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                            </svg>
                                            {t('loggingIn')}
                                        </>
                                    ) : (
                                        t('loginButton')
                                    )}
                                </button>
                            </form>
                        </div>
                        
                        {/* Language Switcher */}
                        <div className="flex justify-center mt-6">
                            <LanguageSwitcher />
                        </div>
                        
                        {/* Footer */}
                        <p className="text-center text-gray-500 text-sm mt-6">
                            PegaProx Cluster Management {PEGAPROX_VERSION}
                        </p>
                    </div>
                </div>
            );
        }

        // Icons - mostly from Heroicons, some custom ones -- MK
        // ChatGPT helped clean these up, they look pretty good now
        // TODO: maybe use react-icons instead? would be cleaner - LW
        // nah heroicons is fine - NS
        const Icons = {
            Server: () => (
                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2m-2-4h.01M17 16h.01" />
                </svg>
            ),
            // Palette icon for themes - NS Jan 2026
            Palette: () => (
                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01" />
                </svg>
            ),
            // Building icon for tenants - NS
            Building: () => (
                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                </svg>
            ),
            // Key icon for permissions
            Key: () => (
                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z" />
                </svg>
            ),
            // FileKey icon for SSH key authentication
            FileKey: () => (
                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 11a2 2 0 100-4 2 2 0 000 4z" />
                </svg>
            ),
            Database: () => (
                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4" />
                </svg>
            ),
            // Storage: () => (...)  // old, use Database instead
            Cpu: () => (
                <svg className='w-5 h-5' fill='none' stroke='currentColor' viewBox='0 0 24 24'>
                    <path strokeLinecap='round' strokeLinejoin='round' strokeWidth={2} d="M9 3v2m6-2v2M9 19v2m6-2v2M3 9h2m-2 6h2m14-6h2m-2 6h2M5 5h14a2 2 0 012 2v10a2 2 0 01-2 2H5a2 2 0 01-2-2V7a2 2 0 012-2z" />
                </svg>
            ),
            Memory: () => (
                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                </svg>
            ),
            Plus: () => (
                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" />
                </svg>
            ),
            MoreVertical: () => (
                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z" />
                </svg>
            ),
            Trash: () => (
                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                </svg>
            ),
            // MK: Alias for Trash2
            Trash2: () => (
                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                </svg>
            ),
            Settings: () => (
                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
            ),
            Activity: () => (
                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 10V3L4 14h7v7l9-11h-7z" />
                </svg>
            ),
            ArrowRight: () => (
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M14 5l7 7m0 0l-7 7m7-7H3" />
                </svg>
            ),
            Check: () => (
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
                </svg>
            ),
            Upload: () => (
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                </svg>
            ),
            Zap: () => (
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 10V3L4 14h7v7l9-11h-7z" />
                </svg>
            ),
            X: () => (
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                </svg>
            ),
            XCircle: () => (
                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
            ),
            CheckCircle: () => (
                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
            ),
            Copy: () => (
                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                </svg>
            ),
            Eye: () => (
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                </svg>
            ),
            Clock: () => (
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
            ),
            RotateCcw: () => (
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 10h4a4 4 0 014 4v0a4 4 0 01-4 4H3m0 0l3-3m-3 3l3 3M21 14h-4a4 4 0 01-4-4v0a4 4 0 014-4h4m0 0l-3 3m3-3l-3-3" />
                </svg>
            ),
            Grid: () => (
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" />
                </svg>
            ),
            List: () => (
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6h16M4 10h16M4 14h16M4 18h16" />
                </svg>
            ),
            Globe: () => (
                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
            ),
            // NS: New icons for alerts, tasks, tags, affinity - Dec 2025
            Mail: () => (
                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                </svg>
            ),
            Tag: () => (
                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" />
                </svg>
            ),
            Link: () => (
                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" />
                </svg>
            ),
            Unlink: () => (
                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101M3 3l18 18m-1.828-8.828a4 4 0 00-5.656 0l-4 4" />
                </svg>
            ),
            Square: () => (
                <svg className="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                    <rect x="4" y="4" width="16" height="16" rx="2" />
                </svg>
            ),
            Camera: () => (
                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
            ),
            Archive: () => (
                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4" />
                </svg>
            ),
            Bell: () => (
                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
                </svg>
            ),
            WifiOff: () => (
                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M18.364 5.636a9 9 0 010 12.728m0 0l-2.829-2.829m2.829 2.829L21 21M15.536 8.464a5 5 0 010 7.072m0 0l-2.829-2.829m-4.243 2.829a4.978 4.978 0 01-1.414-2.83m-1.414 5.658a9 9 0 01-2.167-9.238m7.824 2.167a1 1 0 111.414 1.414m-1.414-1.414L3 3m8.293 8.293l1.414 1.414" />
                </svg>
            ),
            Folder: () => (
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" />
                </svg>
            ),
            FolderPlus: () => (
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 13h6m-3-3v6m-9 1V7a2 2 0 012-2h6l2 2h6a2 2 0 012 2v8a2 2 0 01-2 2H5a2 2 0 01-2-2z" />
                </svg>
            ),
            FolderInput: () => (
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 9l3 3m0 0l-3 3m3-3H8m13 0a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
            ),
            Search: () => (
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
            ),
            Filter: () => (
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
                </svg>
            ),
            Refresh: () => (
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                </svg>
            ),
            VM: () => (
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                </svg>
            ),
            Container: () => (
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
                </svg>
            ),
            Play: () => (
                <svg className="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M8 5v14l11-7z" />
                </svg>
            ),
            Wrench: () => (
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
            ),
            Download: () => (
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                </svg>
            ),
            RotateCw: () => (
                <svg className="w-4 h-4 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                </svg>
            ),
            Terminal: () => (
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 9l3 3-3 3m5 0h3M5 20h14a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                </svg>
            ),
            Power: () => (
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5.636 5.636a9 9 0 1012.728 0M12 3v9" />
                </svg>
            ),
            Stop: () => (
                <svg className="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                    <rect x="6" y="6" width="12" height="12" rx="1" />
                </svg>
            ),
            PlayCircle: () => (
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
            ),
            StopCircle: () => (
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 10a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1v-4z" />
                </svg>
            ),
            RefreshCw: () => (
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                </svg>
            ),
            Monitor: () => (
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                </svg>
            ),
            Maximize: () => (
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4" />
                </svg>
            ),
            Minimize: () => (
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 9V4.5M9 9H4.5M9 9L3.75 3.75M9 15v4.5M9 15H4.5M9 15l-5.25 5.25M15 9h4.5M15 9V4.5M15 9l5.25-5.25M15 15h4.5M15 15v4.5m0-4.5l5.25 5.25" />
                </svg>
            ),
            Cog: () => (
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
            ),
            HardDrive: () => (
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4" />
                </svg>
            ),
            Layers: () => (
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5" />
                </svg>
            ),
            Network: () => (
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8.111 16.404a5.5 5.5 0 017.778 0M12 20h.01m-7.08-7.071c3.904-3.905 10.236-3.905 14.14 0M1.394 9.393c5.857-5.857 15.355-5.857 21.213 0" />
                </svg>
            ),
            Plug: () => (
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 10V3L4 14h7v7l9-11h-7z" />
                </svg>
            ),
            // MK: Unplug icon - plug with arrow showing disconnect
            Unplug: () => (
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 3v3M15 3v3M9 21v-3M15 21v-3M3 9h3M21 9h-3M3 15h3M21 15h-3" />
                    <rect x="7" y="7" width="10" height="10" rx="1" strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} />
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 5l14 14" />
                </svg>
            ),
            Save: () => (
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" />
                </svg>
            ),
            Shield: () => (
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                </svg>
            ),
            Scale: ({ className }) => (
                <svg className={className || "w-5 h-5"} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 6l3 1m0 0l-3 9a5.002 5.002 0 006.001 0M6 7l3 9M6 7l6-2m6 2l3-1m-3 1l-3 9a5.002 5.002 0 006.001 0M18 7l3 9m-3-9l-6-2m0-2v2m0 16V5m0 16H9m3 0h3" />
                </svg>
            ),
            Disc: ({ className }) => (
                <svg className={className || "w-5 h-5"} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <circle cx="12" cy="12" r="10" strokeWidth={2} />
                    <circle cx="12" cy="12" r="3" strokeWidth={2} />
                </svg>
            ),
            MemoryStick: ({ className }) => (
                <svg className={className || "w-5 h-5"} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <rect x="4" y="4" width="16" height="16" rx="2" strokeWidth={2} />
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 4v4M15 4v4M9 16v4M15 16v4M4 9h4M4 15h4M16 9h4M16 15h4" />
                </svg>
            ),
            Star: ({ className }) => (
                <svg className={className || "w-5 h-5"} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" />
                </svg>
            ),
            Package: () => (
                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
                </svg>
            ),
            Lock: () => (
                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                </svg>
            ),
            Unlock: () => (
                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 11V7a4 4 0 118 0m-4 8v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2z" />
                </svg>
            ),
            Ban: ({ className }) => (
                <svg className={className || "w-5 h-5"} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <circle cx="12" cy="12" r="10" strokeWidth={2} />
                    <line x1="4.93" y1="4.93" x2="19.07" y2="19.07" strokeWidth={2} strokeLinecap="round" />
                </svg>
            ),
            UserX: () => (
                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 7a4 4 0 11-8 0 4 4 0 018 0zM9 14a6 6 0 00-6 6v1h12v-1a6 6 0 00-6-6zM21 12h-6" />
                </svg>
            ),
            AlertTriangle: () => (
                <svg className="w-5 h-5 text-yellow-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                </svg>
            ),
            Info: () => (
                <svg className="w-5 h-5 text-blue-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
            ),
            LogOut: () => (
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                </svg>
            ),
            ChevronDown: () => (
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                </svg>
            ),
            ChevronUp: () => (
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 15l7-7 7 7" />
                </svg>
            ),
            ChevronRight: () => (
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" />
                </svg>
            ),
            User: () => (
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                </svg>
            ),
            Users: () => (
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
                </svg>
            ),
            ClipboardList: () => (
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" />
                </svg>
            ),
            UserPlus: () => (
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z" />
                </svg>
            ),
            Edit: () => (
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                </svg>
            ),
            BarChart: () => (
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                </svg>
            ),
            Image: () => (
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                </svg>
            ),
            FileText: () => (
                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
            ),
            ExternalLink: () => (
                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                </svg>
            ),
            Github: () => (
                <svg className="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                    <path fillRule="evenodd" d="M12 2C6.477 2 2 6.484 2 12.017c0 4.425 2.865 8.18 6.839 9.504.5.092.682-.217.682-.483 0-.237-.008-.868-.013-1.703-2.782.605-3.369-1.343-3.369-1.343-.454-1.158-1.11-1.466-1.11-1.466-.908-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.113-4.555-4.951 0-1.093.39-1.988 1.029-2.688-.103-.253-.446-1.272.098-2.65 0 0 .84-.27 2.75 1.026A9.564 9.564 0 0112 6.844c.85.004 1.705.115 2.504.337 1.909-1.296 2.747-1.027 2.747-1.027.546 1.379.202 2.398.1 2.651.64.7 1.028 1.595 1.028 2.688 0 3.848-2.339 4.695-4.566 4.943.359.309.678.92.678 1.855 0 1.338-.012 2.419-.012 2.747 0 .268.18.58.688.482A10.019 10.019 0 0022 12.017C22 6.484 17.522 2 12 2z" clipRule="evenodd" />
                </svg>
            ),
            Loader: () => (
                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                </svg>
            ),
            // NS: Added missing icons for About section
            Heart: () => (
                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
                </svg>
            ),
            Book: () => (
                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                </svg>
            ),
        };

        // Sparkline Component - Small inline chart
        // NS: ChatGPT wrote the initial SVG math, I just cleaned it up
        function Sparkline({ data = [], color = '#3b82f6', height = 24, width = 80 }) {
            if (!data || data.length === 0) return null;
            
            const max = Math.max(...data, 1);
            const min = Math.min(...data, 0);
            const range = max - min || 1;
            
            const points = data.map((value, index) => {
                const x = (index / (data.length - 1)) * width;
                const y = height - ((value - min) / range) * height;
                return `${x},${y}`;
            }).join(' ');
            
            return(
                <svg width={width} height={height} className="inline-block">
                    <polyline
                        fill="none"
                        stroke={color}
                        strokeWidth="1.5"
                        points={points}
                    />
                </svg>
            );
        }

        // VM Metrics Modal - Shows detailed graphs
        // LW: RRD data from Proxmox, charts built with SVG
        // Oct 2025: Added timeframe selector after user feedback
        function VmMetricsModal({ vm, clusterId, onClose }) {
            const { t } = useTranslation();
            const { getAuthHeaders } = useAuth();
            const [timeframe, setTimeframe] = useState('day');
            const [loading, setLoading] = useState(true);
            const [data, setData] = useState(null);
            const [err, setErr] = useState(null);
            
            // LW: one-liner, keep it simple
            const authFetch = (url, opts = {}) => fetch(url, { ...opts, credentials: 'include', headers: { ...opts.headers, ...getAuthHeaders() } });
            
            useEffect(() => {
                const fetchMetrics = async () => {
                    setLoading(true);
                    setErr(null);
                    try {
                        const r = await authFetch(
                            `${API_URL}/clusters/${clusterId}/vms/${vm.node}/${vm.type}/${vm.vmid}/rrd/${timeframe}`
                        );
                        if (r.ok) {
                            setData(await r.json());
                        }else{
                            setErr('Failed to load metrics');
                        }
                    } catch (e) {
                        setErr(e.message);
                    }
                    setLoading(false);
                };
                fetchMetrics();
            }, [timeframe, vm.vmid]);
            
            // NS: I know this is duplicated like 5 times... will fix later
            const formatBytes = (bytes) => {
                if (!bytes) return '0 B';
                const k = 1024;
                const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return(bytes / Math.pow(k, i)).toFixed(1) + ' ' + sizes[i];
            };
            
            const formatTime = (ts) => {
                if (!ts) return '';
                return new Date(ts * 1000).toLocaleString();
            };
            
            // Simple line chart component
            const LineChart = ({ data, label, color, unit = '%', formatValue }) => {
                if (!data || data.length === 0) return null;
                
                const max = Math.max(...data, 1);
                const min = Math.min(...data, 0);
                const range = max - min || 1;
                const h = 120;
                const w = 400;
                
                const pts = data.map((val, idx) => {
                    const x = (idx / (data.length - 1)) * w;
                    const y = h - ((val - min) / range) * h;
                    return `${x},${y}`;
                }).join(' ');
                
                const current = data[data.length - 1] || 0;
                const avg = data.reduce((a, b) => a + b, 0) / data.length;
                
                return(
                    <div className="bg-proxmox-dark rounded-lg p-4">
                        <div className="flex justify-between items-center mb-2">
                            <span className="text-sm font-medium text-gray-300">{label}</span>
                            <div className="text-xs text-gray-500">
                                <span className="mr-3">Current: <span className="text-white">{formatValue ? formatValue(current) : current.toFixed(1)}{unit}</span></span>
                                <span>Avg: <span className="text-white">{formatValue ? formatValue(avg) : avg.toFixed(1)}{unit}</span></span>
                            </div>
                        </div>
                        <svg width="100%" height={h} viewBox={`0 0 ${w} ${h}`} preserveAspectRatio="none">
                            <defs>
                                <linearGradient id={`gradient-${label}`} x1="0" y1="0" x2="0" y2="1">
                                    <stop offset="0%" stopColor={color} stopOpacity="0.3" />
                                    <stop offset="100%" stopColor={color} stopOpacity="0" />
                                </linearGradient>
                            </defs>
                            <polygon
                                fill={`url(#gradient-${label})`}
                                points={`0,${h} ${pts} ${w},${h}`}
                            />
                            <polyline
                                fill="none"
                                stroke={color}
                                strokeWidth="2"
                                points={pts}
                            />
                        </svg>
                    </div>
                );
            };
            
            return(
                <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" onClick={onClose}>
                    <div className="bg-proxmox-card border border-proxmox-border rounded-xl w-full max-w-4xl max-h-[90vh] overflow-hidden" onClick={e => e.stopPropagation()}>
                        <div className="flex justify-between items-center p-4 border-b border-proxmox-border">
                            <div>
                                <h2 className="text-lg font-semibold text-white">
                                    {vm.name || `${vm.type === 'qemu' ? 'VM' : 'CT'} ${vm.vmid}`} - {t('performanceMetrics') || 'Performance Metrics'}
                                </h2>
                                <p className="text-sm text-gray-500">Node: {vm.node}</p>
                            </div>
                            <div className="flex items-center gap-4">
                                <select
                                    value={timeframe}
                                    onChange={e => setTimeframe(e.target.value)}
                                    className="bg-proxmox-dark border border-proxmox-border rounded px-3 py-1.5 text-sm text-white"
                                >
                                    <option value="hour">1 {t('hour') || 'Hour'}</option>
                                    <option value="day">1 {t('day') || 'Day'}</option>
                                    <option value="week">1 {t('week') || 'Week'}</option>
                                    <option value="month">1 {t('month') || 'Month'}</option>
                                    <option value="year">1 {t('year') || 'Year'}</option>
                                </select>
                                <button onClick={onClose} className="p-1 hover:bg-proxmox-border rounded">
                                    <Icons.X />
                                </button>
                            </div>
                        </div>
                        
                        <div className="p-4 overflow-y-auto max-h-[70vh]">
                            {loading ? (
                                <div className="flex items-center justify-center py-12">
                                    <Icons.RotateCw />
                                    <span className="ml-2 text-gray-400">{t('loading') || 'Loading...'}</span>
                                </div>
                            ) : err ? (
                                <div className="text-center py-12 text-red-400">{err}</div>
                            ) : data && data.metrics ? (
                                <div className="space-y-4">
                                    <LineChart 
                                        data={data.metrics.cpu} 
                                        label="CPU" 
                                        color="#3b82f6" 
                                        unit="%" 
                                    />
                                    <LineChart 
                                        data={data.metrics.memory} 
                                        label="Memory" 
                                        color="#22c55e" 
                                        unit="%" 
                                    />
                                    <div className="grid grid-cols-2 gap-4">
                                        <LineChart 
                                            data={data.metrics.disk_read} 
                                            label="Disk Read" 
                                            color="#eab308" 
                                            unit="/s"
                                            formatValue={formatBytes}
                                        />
                                        <LineChart 
                                            data={data.metrics.disk_write} 
                                            label="Disk Write" 
                                            color="#f97316" 
                                            unit="/s"
                                            formatValue={formatBytes}
                                        />
                                    </div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <LineChart 
                                            data={data.metrics.net_in} 
                                            label="Network In" 
                                            color="#06b6d4" 
                                            unit="/s"
                                            formatValue={formatBytes}
                                        />
                                        <LineChart 
                                            data={data.metrics.net_out} 
                                            label="Network Out" 
                                            color="#8b5cf6" 
                                            unit="/s"
                                            formatValue={formatBytes}
                                        />
                                    </div>
                                    
                                    {data.timestamps && data.timestamps.length > 0 && (
                                        <div className="text-xs text-gray-500 text-center mt-4">
                                            {formatTime(data.timestamps[0])} - {formatTime(data.timestamps[data.timestamps.length - 1])}
                                        </div>
                                    )}
                                </div>
                            ) : (
                                <div className="text-center py-12 text-gray-400">No data available</div>
                            )}
                        </div>
                    </div>
                </div>
            );
        }
        // Gauge Component
        function Gauge({ value, max = 100, size = 120, label, color }) {
            const r = 45;
            const circ = 2 * Math.PI * r;
            const prog = Math.min(value / max, 1);
            const off = circ - (prog * circ);
            
            // color thresholds
            const getColor = () => {
                if (color) return color;
                if (value < 50) return '#22c55e';  // green
                if (value < 80) return '#eab308';  // yellow
                return '#ef4444';  // red
            };

            return(
                <div className="gauge-container flex flex-col items-center">
                    <svg viewBox="0 0 100 100" className="w-full h-full">
                        <circle cx="50" cy="50" r={r} className="gauge-bg" />
                        <circle 
                            cx="50" 
                            cy="50" 
                            r={r} 
                            className="gauge-fill"
                            style={{
                                stroke: getColor(),
                                strokeDasharray: circ,
                                strokeDashoffset: off,
                            }}
                        />
                        <text x="50" y="50" textAnchor="middle" dy="0.35em" className="gauge-text text-white text-lg">
                            {value.toFixed(1)}%
                        </text>
                    </svg>
                    <span className="text-xs text-gray-400 mt-1 font-medium">{label}</span>
                </div>
            );
        }

        /*
         * Toggle Component
         * NS: simple on/off switch, used everywhere
         */
        function Toggle({ checked, onChange, label }) {
            return(
                <label className="flex items-center gap-3 cursor-pointer group">
                    <div className={`toggle-switch ${checked ? 'active' : ''}`} onClick={() => onChange(!checked)} />
                    <span className="text-sm text-gray-300 group-hover:text-white transition-colors">{label}</span>
                </label>
            );
        }

        // Slider Component - LW: fancy slider with gradient fill
        function Slider({ label, value, onChange, min = 0, max = 100, step = 1, unit = '%', description }) {
            const percentage = ((value - min) / (max - min)) * 100;
            
            return(
                <div className="space-y-3">
                    <div className="flex justify-between items-center">
                        <div>
                            <label className="text-sm font-medium text-gray-200">{label}</label>
                            {description && <p className="text-xs text-gray-500">{description}</p>}
                        </div>
                        <span className="font-mono text-sm text-proxmox-orange font-semibold bg-proxmox-orange/10 px-3 py-1 rounded-lg">
                            {value}{unit}
                        </span>
                    </div>
                    <div className="relative">
                        <div className="absolute inset-0 h-2 rounded-full bg-proxmox-border top-1/2 -translate-y-1/2" />
                        <div 
                            className="absolute h-2 rounded-full bg-gradient-to-r from-proxmox-orange to-orange-400 top-1/2 -translate-y-1/2 transition-all"
                            style={{ width: `${percentage}%` }}
                        />
                        <input
                            type="range"
                            min={min}
                            max={max}
                            step={step}
                            value={value}
                            onChange={(e) => onChange(Number(e.target.value))}
                            className="custom-slider w-full relative z-10 bg-transparent"
                        />
                    </div>
                    <div className="flex justify-between text-xs text-gray-500">
                        <span>{min}{unit}</span>
                        <span>{max}{unit}</span>
                    </div>
                </div>
            );
        }

        // Sponsor Slot Component - loads PNG from /images/sponsors/
        function SponsorSlot({ num }) {
            const { t } = useTranslation();
            const [hasImage, setHasImage] = useState(true);
            const [sponsorUrl, setSponsorUrl] = useState(null);
            
            // Sponsor URLs - edit these to add sponsor links
            const sponsorLinks = {
                1: 'https://socialfurr.com',
                2: null,
                3: null,
                4: null,
                5: null,
                6: null,
                7: null,
                8: null
            };
            
            const handleImageError = () => {
                setHasImage(false);
            };
            
            const url = sponsorLinks[num];
            const imageSrc = `/images/sponsors/sponsor${num}.png`;
            
            if (!hasImage) {
                // Show "Wanted" placeholder
                return(
                    <a 
                        href="mailto:sponsor@pegaprox.com?subject=Sponsorship%20Inquiry" 
                        className="group"
                        title={t('becomeSponsor') || 'Become a sponsor'}
                    >
                        <div className="w-12 h-12 rounded-lg bg-proxmox-card border border-dashed border-proxmox-border flex flex-col items-center justify-center hover:border-proxmox-orange/50 transition-all hover:scale-105">
                            <span className="text-sm">üéØ</span>
                        </div>
                    </a>
                );
            }
            
            const content = (
                <div className="w-12 h-12 rounded-lg bg-proxmox-card border border-proxmox-border p-1 flex items-center justify-center hover:border-proxmox-orange/50 transition-all hover:scale-105 overflow-hidden">
                    <img 
                        src={imageSrc}
                        alt={`Sponsor ${num}`}
                        className="w-full h-full object-contain opacity-80 group-hover:opacity-100 transition-opacity"
                        onError={handleImageError}
                    />
                </div>
            );
            
            if (url) {
                return(
                    <a href={url} target="_blank" rel="noopener noreferrer" className="group">
                        {content}
                    </a>
                );
            }
            
            return <div className="group">{content}</div>;
        }

        // Notification Toast
        // LW: Simple toast - auto-closes after 3s
        // tried 5s but users complained it was too long
        function Toast({ message, type = 'success', onClose }) {
            useEffect(() => {
                const timer = setTimeout(onClose, 3000);  // 3000ms = 3s
                return() => clearTimeout(timer);
            }, [onClose]);

            // NS: ternary hell but it works lol
            return(
                <div className={`toast-enter flex items-center gap-3 px-4 py-3 rounded-lg border ${
                    type === 'success' 
                        ? 'bg-green-500/10 border-green-500/30 text-green-400' 
                        : type === 'error'
                        ? 'bg-red-500/10 border-red-500/30 text-red-400'
                        : 'bg-proxmox-orange/10 border-proxmox-orange/30 text-proxmox-orange'
                }`}>
                    {type === 'success' ? <Icons.Check /> : type === 'error' ? <Icons.X /> : <Icons.Activity />}
                    <span className="text-sm font-medium">{message}</span>
                </div>
            );
        }

        // Node Alert Banner - shows critical alerts when nodes go offline
        // fix for #184 - banner was not showing on first load
        // NS: Now filters by cluster_id to only show alerts for current cluster
        function NodeAlertBanner({ alerts, onDismiss, currentClusterId }) {
            const { t } = useTranslation();
            
            // Filter alerts to only show ones for the current cluster
            const alertEntries = Object.entries(alerts || {})
                .filter(([nodeName, alert]) => !currentClusterId || alert.cluster_id === currentClusterId);
            
            if (alertEntries.length === 0) return null;
            
            return(
                <div className="fixed top-0 left-0 right-0 z-50">
                    {alertEntries.map(([nodeName, alert]) => (
                        <div 
                            key={nodeName}
                            className="bg-red-600 text-white px-4 py-3 flex items-center justify-between animate-pulse"
                        >
                            <div className="flex items-center gap-3">
                                <div className="p-2 bg-red-500 rounded-full">
                                    <Icons.AlertTriangle className="w-5 h-5" />
                                </div>
                                <div>
                                    <span className="font-bold">{t('criticalAlert') || 'CRITICAL ALERT'}:</span>
                                    <span className="ml-2">{alert.message}</span>
                                    <span className="ml-4 text-red-200 text-sm">
                                        {new Date(alert.timestamp).toLocaleTimeString()}
                                    </span>
                                </div>
                            </div>
                            <div className="flex items-center gap-3">
                                <span className="text-sm text-red-200">
                                    {t('haRecoveryMayStart') || 'HA recovery may be in progress...'}
                                </span>
                                <button
                                    onClick={() => onDismiss && onDismiss(nodeName)}
                                    className="p-1 hover:bg-red-500 rounded"
                                    title={t('dismiss') || 'Dismiss'}
                                >
                                    <Icons.X className="w-4 h-4" />
                                </button>
                            </div>
                        </div>
                    ))}
                </div>
            );
        }

        // =============================================================================
        // NODE MANAGEMENT COMPONENTS
        // =============================================================================
        function NodeJoinWizard({ isOpen, onClose, clusterId, onSuccess, addToast }) {
            const { t } = useTranslation();
            const { getAuthHeaders } = useAuth();
            const [step, setStep] = useState(1);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);
            const [nodeIp, setNodeIp] = useState('');
            const [username, setUsername] = useState('root');
            const [password, setPassword] = useState('');
            const [sshPort, setSshPort] = useState(22);
            const [link0Address, setLink0Address] = useState('');
            const [nodeInfo, setNodeInfo] = useState(null);
            const [joinResult, setJoinResult] = useState(null);
            
            const resetWizard = () => { setStep(1); setNodeIp(''); setUsername('root'); setPassword(''); setSshPort(22); setLink0Address(''); setNodeInfo(null); setJoinResult(null); setError(null); setLoading(false); };
            const handleClose = () => { resetWizard(); onClose(); };
            
            const testConnection = async () => {
                setLoading(true); setError(null);
                try {
                    const response = await fetch(`${API_URL}/clusters/${clusterId}/nodes/join/test`, {
                        method: 'POST', 
                        credentials: 'include',
                        headers: { 'Content-Type': 'application/json', ...getAuthHeaders() },
                        body: JSON.stringify({ node_ip: nodeIp, username, password, ssh_port: sshPort })
                    });
                    const data = await response.json();
                    if (data.success) { setNodeInfo(data.info); setStep(2); } else { setError(data.error || 'Connection failed'); }
                } catch (err) { setError('Network error: ' + err.message); }
                finally { setLoading(false); }
            };
            
            const joinCluster = async () => {
                setLoading(true); setError(null);
                try {
                    const response = await fetch(`${API_URL}/clusters/${clusterId}/nodes/join`, {
                        method: 'POST', 
                        credentials: 'include',
                        headers: { 'Content-Type': 'application/json', ...getAuthHeaders() },
                        body: JSON.stringify({ node_ip: nodeIp, username, password, ssh_port: sshPort, link0_address: link0Address || undefined })
                    });
                    const data = await response.json();
                    if (data.success) { setJoinResult(data); setStep(3); if (onSuccess) onSuccess(); } else { setError(data.error || 'Join failed'); }
                } catch (err) { setError('Network error: ' + err.message); }
                finally { setLoading(false); }
            };
            
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
                    <div className="bg-proxmox-card border border-proxmox-border rounded-xl w-full max-w-lg">
                        <div className="p-4 border-b border-proxmox-border flex justify-between items-center">
                            <h2 className="text-lg font-semibold flex items-center gap-2"><Icons.Server className="w-5 h-5 text-proxmox-orange" />Add Node to Cluster</h2>
                            <button onClick={handleClose} className="p-1 hover:bg-proxmox-dark rounded"><Icons.X className="w-5 h-5" /></button>
                        </div>
                        <div className="px-4 py-3 border-b border-proxmox-border">
                            <div className="flex items-center justify-between">
                                {[1, 2, 3].map(s => (<div key={s} className="flex items-center"><div className={`w-8 h-8 rounded-full flex items-center justify-center text-sm font-medium ${step >= s ? 'bg-proxmox-orange text-white' : 'bg-proxmox-dark text-gray-400'}`}>{step > s ? <Icons.Check className="w-4 h-4" /> : s}</div><span className={`ml-2 text-sm ${step >= s ? 'text-white' : 'text-gray-500'}`}>{s === 1 ? 'Connect' : s === 2 ? 'Verify' : 'Join'}</span>{s < 3 && <div className="w-12 h-0.5 bg-proxmox-border mx-2" />}</div>))}
                            </div>
                        </div>
                        <div className="p-4">
                            {error && <div className="mb-4 p-3 bg-red-500/20 border border-red-500 rounded-lg text-red-400 text-sm">{error}</div>}
                            {step === 1 && (<div className="space-y-4">
                                <div><label className="block text-sm text-gray-400 mb-1">Node IP *</label><input type="text" value={nodeIp} onChange={e => setNodeIp(e.target.value)} placeholder="192.168.1.100" className="w-full bg-proxmox-dark border border-proxmox-border rounded px-3 py-2 text-white" /></div>
                                <div className="grid grid-cols-2 gap-4"><div><label className="block text-sm text-gray-400 mb-1">SSH User</label><input type="text" value={username} onChange={e => setUsername(e.target.value)} className="w-full bg-proxmox-dark border border-proxmox-border rounded px-3 py-2 text-white" /></div><div><label className="block text-sm text-gray-400 mb-1">SSH Port</label><input type="number" value={sshPort} onChange={e => setSshPort(parseInt(e.target.value) || 22)} className="w-full bg-proxmox-dark border border-proxmox-border rounded px-3 py-2 text-white" /></div></div>
                                <div><label className="block text-sm text-gray-400 mb-1">SSH Password *</label><input type="password" value={password} onChange={e => setPassword(e.target.value)} className="w-full bg-proxmox-dark border border-proxmox-border rounded px-3 py-2 text-white" /></div>
                                <div><label className="block text-sm text-gray-400 mb-1">Link0 Address (optional)</label><input type="text" value={link0Address} onChange={e => setLink0Address(e.target.value)} placeholder="10.0.0.100" className="w-full bg-proxmox-dark border border-proxmox-border rounded px-3 py-2 text-white" /><p className="text-xs text-gray-500 mt-1">Only for multi-network setups</p></div>
                            </div>)}
                            {step === 2 && nodeInfo && (<div className="space-y-4">
                                <div className="p-4 bg-green-500/10 border border-green-500/30 rounded-lg"><div className="flex items-center gap-2 text-green-400"><Icons.CheckCircle className="w-5 h-5" /><span className="font-medium">Connection OK</span></div></div>
                                <div className="bg-proxmox-dark rounded-lg p-4 space-y-3">
                                    <div className="flex justify-between"><span className="text-gray-400">Hostname:</span><span className="font-mono text-white">{nodeInfo.hostname}</span></div>
                                    <div className="flex justify-between"><span className="text-gray-400">IP:</span><span className="font-mono text-white">{nodeInfo.ip}</span></div>
                                    <div className="flex justify-between"><span className="text-gray-400">Proxmox:</span><span className={nodeInfo.proxmox_installed ? 'text-green-400' : 'text-red-400'}>{nodeInfo.proxmox_installed ? nodeInfo.proxmox_version : 'Not Installed'}</span></div>
                                    <div className="flex justify-between"><span className="text-gray-400">Cluster:</span><span className={nodeInfo.already_in_cluster ? 'text-yellow-400' : 'text-green-400'}>{nodeInfo.already_in_cluster ? nodeInfo.current_cluster : 'Not in cluster'}</span></div>
                                </div>
                                {!nodeInfo.proxmox_installed && <div className="p-3 bg-red-500/20 border border-red-500 rounded-lg text-red-400 text-sm">Proxmox VE not installed</div>}
                                {nodeInfo.already_in_cluster && <div className="p-3 bg-yellow-500/20 border border-yellow-500 rounded-lg text-yellow-400 text-sm">Already in a cluster</div>}
                            </div>)}
                            {step === 3 && joinResult && (<div className="text-center"><div className="p-4 bg-green-500/10 border border-green-500/30 rounded-lg"><Icons.CheckCircle className="w-12 h-12 text-green-400 mx-auto mb-2" /><h3 className="text-lg font-semibold text-green-400">Node Joined!</h3><p className="text-gray-400 mt-2">{joinResult.message}</p></div><p className="text-sm text-gray-500 mt-4">Refresh to see the new node.</p></div>)}
                        </div>
                        <div className="p-4 border-t border-proxmox-border flex justify-between">
                            {step === 1 && (<><button onClick={handleClose} className="px-4 py-2 bg-proxmox-dark hover:bg-proxmox-border rounded-lg text-white">Cancel</button><button onClick={testConnection} disabled={loading || !nodeIp || !password} className="px-4 py-2 bg-proxmox-orange hover:bg-orange-600 rounded-lg disabled:opacity-50 flex items-center gap-2 text-white">{loading && <Icons.Loader className="w-4 h-4 animate-spin" />}Test Connection</button></>)}
                            {step === 2 && (<><button onClick={() => setStep(1)} className="px-4 py-2 bg-proxmox-dark hover:bg-proxmox-border rounded-lg text-white">Back</button><button onClick={joinCluster} disabled={loading || !nodeInfo?.proxmox_installed || nodeInfo?.already_in_cluster} className="px-4 py-2 bg-proxmox-orange hover:bg-orange-600 rounded-lg disabled:opacity-50 flex items-center gap-2 text-white">{loading && <Icons.Loader className="w-4 h-4 animate-spin" />}{loading ? 'Joining...' : 'Join Cluster'}</button></>)}
                            {step === 3 && <button onClick={handleClose} className="px-4 py-2 bg-proxmox-orange hover:bg-orange-600 rounded-lg ml-auto text-white">Done</button>}
                        </div>
                    </div>
                </div>
            );
        }

        function RemoveNodeConfirmModal({ isOpen, onClose, node, clusterId, onSuccess, addToast }) {
            const { getAuthHeaders } = useAuth();
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);
            const [canRemove, setCanRemove] = useState(null);
            const [confirmText, setConfirmText] = useState('');
            
            useEffect(() => {
                if (isOpen && node) {
                    setConfirmText(''); setError(null);
                    fetch(`${API_URL}/clusters/${clusterId}/nodes/${node.name}/can-remove`, { headers: getAuthHeaders() })
                        .then(r => r.json()).then(setCanRemove).catch(() => setError('Could not check status'));
                }
            }, [isOpen, node]);
            
            const removeNode = async () => {
                if (confirmText !== node.name) return;
                setLoading(true); setError(null);
                try {
                    const response = await fetch(`${API_URL}/clusters/${clusterId}/nodes/${node.name}/cluster-membership`, {
                        method: 'DELETE', headers: { 'Content-Type': 'application/json', ...getAuthHeaders() },
                        body: JSON.stringify({ confirm: true })
                    });
                    const data = await response.json();
                    if (data.success) { if (addToast) addToast('Node removed', 'success'); if (onSuccess) onSuccess(); onClose(); }
                    else { setError(data.error || 'Failed'); }
                } catch (err) { setError('Network error'); }
                finally { setLoading(false); }
            };
            
            if (!isOpen || !node) return null;
            return (
                <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
                    <div className="bg-proxmox-card border border-proxmox-border rounded-xl w-full max-w-md">
                        <div className="p-4 border-b border-proxmox-border"><h2 className="text-lg font-semibold text-red-400 flex items-center gap-2"><Icons.AlertTriangle className="w-5 h-5" />Remove Node</h2></div>
                        <div className="p-4 space-y-4">
                            {error && <div className="p-3 bg-red-500/20 border border-red-500 rounded-lg text-red-400 text-sm">{error}</div>}
                            <p className="text-gray-300">Remove <strong className="text-white">{node.name}</strong> from cluster?</p>
                            {canRemove && (<div className="bg-proxmox-dark rounded-lg p-3 space-y-2">
                                <div className="flex items-center gap-2">{canRemove.in_maintenance ? <Icons.CheckCircle className="w-4 h-4 text-green-400" /> : <Icons.XCircle className="w-4 h-4 text-red-400" />}<span className={canRemove.in_maintenance ? 'text-green-400' : 'text-red-400'}>Maintenance Mode</span></div>
                                <div className="flex items-center gap-2">{canRemove.maintenance_complete ? <Icons.CheckCircle className="w-4 h-4 text-green-400" /> : <Icons.XCircle className="w-4 h-4 text-red-400" />}<span className={canRemove.maintenance_complete ? 'text-green-400' : 'text-red-400'}>Evacuation Done</span></div>
                                <div className="flex items-center gap-2">{canRemove.is_offline ? <Icons.CheckCircle className="w-4 h-4 text-green-400" /> : <Icons.XCircle className="w-4 h-4 text-red-400" />}<span className={canRemove.is_offline ? 'text-green-400' : 'text-red-400'}>Node Offline</span></div>
                            </div>)}
                            {canRemove && !canRemove.can_remove && canRemove.blockers?.length > 0 && (<div className="p-3 bg-yellow-500/20 border border-yellow-500 rounded-lg text-yellow-400 text-sm"><strong>Blockers:</strong><ul className="mt-1 ml-4 list-disc">{canRemove.blockers.map((b, i) => <li key={i}>{b}</li>)}</ul></div>)}
                            {canRemove?.can_remove && (<div><label className="block text-sm text-gray-400 mb-1">Type <strong className="text-white">{node.name}</strong> to confirm:</label><input type="text" value={confirmText} onChange={e => setConfirmText(e.target.value)} placeholder={node.name} className="w-full bg-proxmox-dark border border-proxmox-border rounded px-3 py-2 text-white" /></div>)}
                        </div>
                        <div className="p-4 border-t border-proxmox-border flex justify-end gap-3">
                            <button onClick={onClose} className="px-4 py-2 bg-proxmox-dark hover:bg-proxmox-border rounded-lg text-white">Cancel</button>
                            <button onClick={removeNode} disabled={loading || !canRemove?.can_remove || confirmText !== node.name} className="px-4 py-2 bg-red-600 hover:bg-red-700 rounded-lg disabled:opacity-50 flex items-center gap-2 text-white">{loading && <Icons.Loader className="w-4 h-4 animate-spin" />}Remove</button>
                        </div>
                    </div>
                </div>
            );
        }

        // Datacenter Tab Component (embedded in main view)

        // Datacenter Tab Component
        function DatacenterTab({ clusterId, addToast }) {
            const { t } = useTranslation();
            const { getAuthHeaders } = useAuth();
            const [activeSection, setActiveSection] = useState('summary');
            const [loading, setLoading] = useState(true);
            const [dcStatus, setDcStatus] = useState(null);
            const [clusterNodes, setClusterNodes] = useState([]);
            const [joinInfo, setJoinInfo] = useState(null);
            const [showJoinInfo, setShowJoinInfo] = useState(false);
            const [dcOptions, setDcOptions] = useState({});
            const [showEditOptions, setShowEditOptions] = useState(false);
            const [editingOptions, setEditingOptions] = useState({});
            const [storage, setStorage] = useState([]);
            const [showAddStorage, setShowAddStorage] = useState(false);
            const [newStorage, setNewStorage] = useState({ type: 'dir', storage: '', path: '', content: 'images,rootdir' });
            const [backupJobs, setBackupJobs] = useState([]);
            const [replicationJobs, setReplicationJobs] = useState([]);  // TODO: actually use this
            const [firewallOptions, setFirewallOptions] = useState({});
            const [firewallRules, setFirewallRules] = useState([]);
            const [showAddRuleModal, setShowAddRuleModal] = useState(false);
            const [newRule, setNewRule] = useState({ type: 'in', action: 'ACCEPT', enable: 1 });
            
            // MK: HA State Variables
            const [haManagerStatus, setHaManagerStatus] = useState([]);
            const [haResources, setHaResources] = useState([]);
            const [haGroups, setHaGroups] = useState([]);
            const [availableVmsForHa, setAvailableVmsForHa] = useState([]);
            const [showAddHaResource, setShowAddHaResource] = useState(false);
            const [showAddHaGroup, setShowAddHaGroup] = useState(false);
            const [showEditHaResource, setShowEditHaResource] = useState(null);
            const [showEditHaGroup, setShowEditHaGroup] = useState(null);
            const [newHaResource, setNewHaResource] = useState({ sid: '', state: 'started', group: '', max_restart: 1, max_relocate: 1, comment: '' });
            const [newHaGroup, setNewHaGroup] = useState({ group: '', nodes: '', restricted: 0, nofailback: 0 });
            
            const [showAddBackupJob, setShowAddBackupJob] = useState(false);
            // const [editBackupJob, setEditBackupJob] = useState(null);  // later
            const [newBackupJob, setNewBackupJob] = useState({
                enabled: 1,
                schedule: 'daily',
                storage: '',
                mode: 'snapshot',
                compress: 'zstd',
                vmid: '',
                node: '',
                mailnotification: 'always',
                mailto: ''
            });
            const [cpuInfo, setCpuInfo] = useState([]);
            const [recommendedCpu, setRecommendedCpu] = useState(null);
            const authHeaders = getAuthHeaders();
            
            // Node Management state
            const [showNodeJoinWizard, setShowNodeJoinWizard] = useState(false);
            const [showRemoveNodeModal, setShowRemoveNodeModal] = useState(false);
            const [nodeToRemove, setNodeToRemove] = useState(null);
            
            /*
             * MK: CPU generation detection for recommended CPU type
             * Maps physical CPU model to x86-64 microarchitecture level
             * Used to suggest optimal QEMU cpu type in VM settings
             * 
             * Levels: v1 (baseline), v2-AES (most compatible), v3 (AVX2), v4 (AVX-512)
             * ChatGPT helped compile this list, I double-checked against Intel ARK
             */
            const detectCpuGeneration = (cpuModel) => {
                if (!cpuModel) return { level: 'v2-AES', generation: 'Unknown' };
                const model = cpuModel.toLowerCase();
                
                // Intel Xeon generations (server CPUs)
                if (model.includes('xeon')) {
                    // Xeon Scalable (Sapphire Rapids, Emerald Rapids)
                    if (model.includes('sapphire') || model.includes('emerald') || model.match(/[w\d]-[34]\d{3}/))
                        return { level: 'v4', generation: 'Intel Xeon Scalable 4th/5th Gen' };
                    // Xeon Scalable (Ice Lake, Cascade Lake)
                    if (model.includes('ice') || model.includes('cascade') || model.includes('platinum') || model.includes('gold') || model.includes('silver') || model.includes('bronze'))
                        return { level: 'v3', generation: 'Intel Xeon Scalable' };
                    // Xeon E5/E7 v4 (Broadwell)
                    if (model.includes('v4'))
                        return { level: 'v3', generation: 'Intel Xeon E5/E7 v4 (Broadwell)' };
                    // Xeon E5/E7 v3 (Haswell)
                    if (model.includes('v3'))
                        return { level: 'v3', generation: 'Intel Xeon E5/E7 v3 (Haswell)' };
                    // Xeon E5/E7 v2 (Ivy Bridge)
                    if (model.includes('v2'))
                        return { level: 'v2-AES', generation: 'Intel Xeon E5/E7 v2 (Ivy Bridge)' };
                    // Xeon E5/E7 v1 (Sandy Bridge)
                    if (model.includes('e5-') || model.includes('e7-'))
                        return { level: 'v2-AES', generation: 'Intel Xeon E5/E7 (Sandy Bridge)' };
                    // Older Xeons
                    return { level: 'v2-AES', generation: 'Intel Xeon (Legacy)' };
                }
                
                // Intel Core generations (desktop/laptop CPUs)
                if (model.includes('core')) {
                    if (model.includes('13th') || model.includes('14th') || model.includes('i9-13') || model.includes('i9-14') || model.includes('i7-13') || model.includes('i7-14'))
                        return { level: 'v4', generation: 'Intel Core 13th/14th Gen' };
                    if (model.includes('11th') || model.includes('12th') || model.includes('i9-12') || model.includes('i7-12') || model.includes('i9-11') || model.includes('i7-11'))
                        return { level: 'v3', generation: 'Intel Core 11th/12th Gen' };
                    if (model.includes('10th') || model.includes('i9-10') || model.includes('i7-10') || model.includes('i5-10'))
                        return { level: 'v3', generation: 'Intel Core 10th Gen' };
                    if (model.includes('8th') || model.includes('9th') || model.includes('i7-8') || model.includes('i7-9') || model.includes('i5-8') || model.includes('i5-9'))
                        return { level: 'v3', generation: 'Intel Core 8th/9th Gen' };
                    if (model.includes('6th') || model.includes('7th') || model.includes('i7-6') || model.includes('i7-7') || model.includes('i5-6') || model.includes('i5-7'))
                        return { level: 'v3', generation: 'Intel Core 6th/7th Gen (Skylake/Kaby Lake)' };
                    if (model.includes('4th') || model.includes('5th') || model.includes('i7-4') || model.includes('i7-5') || model.includes('i5-4') || model.includes('i5-5'))
                        return { level: 'v3', generation: 'Intel Core 4th/5th Gen (Haswell/Broadwell)' };
                    if (model.includes('3rd') || model.includes('2nd') || model.includes('i7-3') || model.includes('i7-2') || model.includes('i5-3') || model.includes('i5-2'))
                        return { level: 'v2-AES', generation: 'Intel Core 2nd/3rd Gen (Sandy/Ivy Bridge)' };
                    return { level: 'v2-AES', generation: 'Intel Core (Legacy)' };
                }
                
                // AMD EPYC generations (server CPUs)
                if (model.includes('epyc')) {
                    // EPYC 9xx4 series (Genoa, Zen 4)
                    if (model.match(/9\d{3}/) || model.includes('genoa'))
                        return { level: 'v4', generation: 'AMD EPYC Genoa (Zen 4)' };
                    // EPYC 7xx3 series (Milan, Zen 3)
                    if (model.match(/7\d{2}3/) || model.match(/77\d{2}/) || model.includes('milan'))
                        return { level: 'v3', generation: 'AMD EPYC Milan (Zen 3)' };
                    // EPYC 7xx2 series (Rome, Zen 2)
                    if (model.match(/7\d{2}2/) || model.includes('rome'))
                        return { level: 'v3', generation: 'AMD EPYC Rome (Zen 2)' };
                    // EPYC 7xx1 series (Naples, Zen 1)
                    if (model.match(/7\d{2}1/) || model.includes('naples'))
                        return { level: 'v2-AES', generation: 'AMD EPYC Naples (Zen 1)' };
                    return { level: 'v2-AES', generation: 'AMD EPYC' };
                }
                
                // AMD Ryzen/Threadripper generations
                if (model.includes('ryzen') || model.includes('threadripper')) {
                    if (model.includes('7000') || model.includes('9000') || model.match(/\d{1}-7\d{3}/) || model.match(/\d{1}-9\d{3}/))
                        return { level: 'v4', generation: 'AMD Ryzen 7000/9000 (Zen 4)' };
                    if (model.includes('5000') || model.includes('6000') || model.match(/\d{1}-5\d{3}/) || model.match(/\d{1}-6\d{3}/))
                        return { level: 'v3', generation: 'AMD Ryzen 5000/6000 (Zen 3)' };
                    if (model.includes('3000') || model.includes('4000') || model.match(/\d{1}-3\d{3}/) || model.match(/\d{1}-4\d{3}/))
                        return { level: 'v3', generation: 'AMD Ryzen 3000/4000 (Zen 2)' };
                    if (model.includes('1000') || model.includes('2000') || model.match(/\d{1}-1\d{3}/) || model.match(/\d{1}-2\d{3}/))
                        return { level: 'v2-AES', generation: 'AMD Ryzen 1000/2000 (Zen/Zen+)' };
                    return { level: 'v2-AES', generation: 'AMD Ryzen' };
                }
                
                // fallback for other/unknown CPUs
                if (model.includes('amd'))
                    return { level: 'v2-AES', generation: 'AMD (Unknown)' };
                if (model.includes('intel'))
                    return { level: 'v2-AES', generation: 'Intel (Unknown)' };
                
                return { level: 'v2-AES', generation: 'Unknown CPU' };
            };
            
            // Determine recommended CPU level based on all nodes
            const calculateRecommendedCpu = (cpuInfoList) => {
                if (!cpuInfoList || cpuInfoList.length === 0) return 'x86-64-v2-AES';
                
                const levels = cpuInfoList.map(c => c.detectedLevel);
                const levelOrder = ['v2-AES', 'v3', 'v4'];
                
                // Find the lowest common denominator
                let lowestIndex = levelOrder.length - 1;
                for (const level of levels) {
                    const idx = levelOrder.indexOf(level);
                    if (idx < lowestIndex && idx >= 0) lowestIndex = idx;
                }
                
                return `x86-64-${levelOrder[lowestIndex]}`;
            };
            
            // NS: authFetch wrapper with proper error handling
            // Returns null on network failure so callers need to check
            const authFetch = async function(url, options) {
                options = options || {};
                try {
                    const response = await fetch(url, {
                        ...options,
                        credentials: 'include',  // NS: Security - use cookies for auth
                        headers: Object.assign({}, options.headers, getAuthHeaders())
                    });
                    return response;
                } catch (err) {
                    console.error('Auth fetch error:', err);
                    return null;
                }
            };

            const sections = [
                { id: 'summary', labelKey: 'summary', icon: Icons.Activity },
                { id: 'cluster', labelKey: 'cluster', icon: Icons.Server },
                { id: 'options', labelKey: 'options', icon: Icons.Settings },
                { id: 'storage', labelKey: 'storage', icon: Icons.HardDrive },
                { id: 'backup', labelKey: 'backup', icon: Icons.Clock },
                { id: 'replication', labelKey: 'replication', icon: Icons.RefreshCw },
                { id: 'ha', labelKey: 'proxmoxNativeHa', icon: Icons.Activity },
                { id: 'cpucompat', labelKey: 'cpuCompatibility', icon: Icons.Cpu },
                { id: 'firewall', labelKey: 'firewall', icon: Icons.Shield },
            ];

            const storageTypes = [
                { id: 'dir', label: 'Directory', icon: 'üìÅ' },
                { id: 'lvm', label: 'LVM', icon: 'üíæ' },
                { id: 'lvmthin', label: 'LVM-Thin', icon: 'üíæ' },
                { id: 'btrfs', label: 'BTRFS', icon: 'üå≤' },
                { id: 'nfs', label: 'NFS', icon: 'üåê' },
                { id: 'cifs', label: 'SMB/CIFS', icon: 'üñ•' },
                { id: 'iscsi', label: 'iSCSI', icon: 'üîó' },
                { id: 'cephfs', label: 'CephFS', icon: 'üêô' },
                { id: 'rbd', label: 'RBD', icon: 'üêô' },
                { id: 'zfs', label: 'ZFS over iSCSI', icon: '‚ö°' },
                { id: 'zfspool', label: 'ZFS', icon: '‚ö°' },
                { id: 'pbs', label: 'Proxmox Backup Server', icon: 'üíº' },
                { id: 'esxi', label: 'ESXi', icon: 'üñ•' },
            ];

            const defaultOptions = {
                keyboard: 'de',
                http_proxy: '',
                console: '',
                email_from: '',
                mac_prefix: 'BC:24:11',
                max_workers: 4,
                // Migration (complex)
                migration_type: '',
                migration_network: '',
                // HA (complex)
                ha_shutdown_policy: '',
                // CRS (complex)
                crs_ha_rebalance: '',
                crs_mode: '',
                // Next ID Range (complex)
                next_id_lower: 100,
                next_id_upper: 999999999,
                // Bandwidth limits (complex)
                bwlimit_clone: '',
                bwlimit_migration: '',
                bwlimit_move: '',
                bwlimit_restore: '',
                bwlimit_default: '',
                // Tags
                user_tag_access: 'free',
                registered_tags: '',
                // Tag Style (complex)
                tag_style_shape: '',
                tag_style_color_map: '',
                tag_style_ordering: '',
            };
            
            // MK: Parse complex options from API response into editable fields
            const parseOptionsForEdit = (opts) => {
                const parsed = {...defaultOptions};
                
                // Simple fields
                if (opts.keyboard) parsed.keyboard = opts.keyboard;
                if (opts.http_proxy) parsed.http_proxy = opts.http_proxy;
                if (opts.console) parsed.console = opts.console;
                if (opts.email_from) parsed.email_from = opts.email_from;
                if (opts.mac_prefix) parsed.mac_prefix = opts.mac_prefix;
                if (opts.max_workers) parsed.max_workers = opts.max_workers;
                
                // Migration: can be string "type=secure,network=10.0.0.0/24" or object {type, network}
                if (opts.migration) {
                    if (typeof opts.migration === 'object') {
                        parsed.migration_type = opts.migration.type || '';
                        parsed.migration_network = opts.migration.network || '';
                    } else if (typeof opts.migration === 'string') {
                        opts.migration.split(',').forEach(part => {
                            const [k, v] = part.split('=');
                            if (k === 'type') parsed.migration_type = v;
                            if (k === 'network') parsed.migration_network = v;
                        });
                    }
                }
                
                // HA: can be object {shutdown_policy} or string
                if (opts.ha) {
                    if (typeof opts.ha === 'object') {
                        parsed.ha_shutdown_policy = opts.ha.shutdown_policy || '';
                    } else if (typeof opts.ha === 'string') {
                        opts.ha.split(',').forEach(part => {
                            const [k, v] = part.split('=');
                            if (k === 'shutdown_policy') parsed.ha_shutdown_policy = v;
                        });
                    }
                }
                
                // CRS: can be object {ha-rebalance-on-start, scheduling} or string
                if (opts.crs) {
                    if (typeof opts.crs === 'object') {
                        parsed.crs_ha_rebalance = opts.crs['ha-rebalance-on-start'] ? '1' : '';
                        parsed.crs_mode = opts.crs.scheduling || '';
                    } else if (typeof opts.crs === 'string') {
                        opts.crs.split(',').forEach(part => {
                            const [k, v] = part.split('=');
                            if (k === 'ha-rebalance-on-start') parsed.crs_ha_rebalance = v === '1' ? '1' : '';
                            if (k === 'scheduling') parsed.crs_mode = v;
                        });
                    }
                }
                
                // Next ID: can be object {lower, upper} or string
                const nextId = opts['next-id'] || opts.next_id;
                if (nextId) {
                    if (typeof nextId === 'object') {
                        parsed.next_id_lower = nextId.lower || 100;
                        parsed.next_id_upper = nextId.upper || 999999999;
                    } else if (typeof nextId === 'string') {
                        nextId.split(',').forEach(part => {
                            const [k, v] = part.split('=');
                            if (k === 'lower') parsed.next_id_lower = parseInt(v) || 100;
                            if (k === 'upper') parsed.next_id_upper = parseInt(v) || 999999999;
                        });
                    }
                }
                
                // Bandwidth limits: can be object or string
                if (opts.bwlimit) {
                    if (typeof opts.bwlimit === 'object') {
                        parsed.bwlimit_clone = opts.bwlimit.clone || '';
                        parsed.bwlimit_migration = opts.bwlimit.migration || '';
                        parsed.bwlimit_move = opts.bwlimit.move || '';
                        parsed.bwlimit_restore = opts.bwlimit.restore || '';
                        parsed.bwlimit_default = opts.bwlimit.default || '';
                    } else if (typeof opts.bwlimit === 'string') {
                        opts.bwlimit.split(',').forEach(part => {
                            const [k, v] = part.split('=');
                            if (k === 'clone') parsed.bwlimit_clone = v;
                            if (k === 'migration') parsed.bwlimit_migration = v;
                            if (k === 'move') parsed.bwlimit_move = v;
                            if (k === 'restore') parsed.bwlimit_restore = v;
                            if (k === 'default') parsed.bwlimit_default = v;
                        });
                    }
                }
                
                // Tag access - can be string "user-allow=free" or object
                const userTagAccess = opts['user-tag-access'] || opts.user_tag_access;
                if (userTagAccess) {
                    if (typeof userTagAccess === 'string' && userTagAccess.includes('=')) {
                        // Parse "user-allow=free" format
                        userTagAccess.split(',').forEach(part => {
                            const [k, v] = part.split('=');
                            if (k === 'user-allow') parsed.user_tag_access = v;
                        });
                    } else if (typeof userTagAccess === 'object' && userTagAccess['user-allow']) {
                        parsed.user_tag_access = userTagAccess['user-allow'];
                    } else {
                        parsed.user_tag_access = userTagAccess;
                    }
                }
                
                // Registered tags
                const regTags = opts['registered-tags'] || opts.registered_tags;
                if (regTags) parsed.registered_tags = regTags;
                
                // Tag style: can be object or string
                const tagStyle = opts['tag-style'] || opts.tag_style;
                if (tagStyle) {
                    if (typeof tagStyle === 'object') {
                        parsed.tag_style_shape = tagStyle.shape || '';
                        parsed.tag_style_color_map = tagStyle['color-map'] || '';
                        parsed.tag_style_ordering = tagStyle.ordering || '';
                    } else if (typeof tagStyle === 'string') {
                        tagStyle.split(',').forEach(part => {
                            const [k, v] = part.split('=');
                            if (k === 'shape') parsed.tag_style_shape = v;
                            if (k === 'color-map') parsed.tag_style_color_map = v;
                            if (k === 'ordering') parsed.tag_style_ordering = v;
                        });
                    }
                }
                
                return parsed;
            };
            
            // MK: Load datacenter options from API
            const loadOptions = async () => {
                try {
                    const res = await authFetch(`${API_URL}/clusters/${clusterId}/datacenter/options`);
                    if (res?.ok) {
                        const opts = await res.json();
                        setDcOptions(opts);
                        setEditingOptions(parseOptionsForEdit(opts));
                    }
                } catch(e) {
                    console.error('Failed to load datacenter options:', e);
                }
            };

            useEffect(() => {
                fetchAllData();
            }, [clusterId]);
            
            // NS: Dedicated function to refresh only storage list without full reload
            const refreshStorage = async () => {
                try {
                    const res = await authFetch(`${API_URL}/clusters/${clusterId}/datacenter/storage`);
                    if (res?.ok) {
                        const storageData = await res.json();
                        console.log('Refreshed storage data:', storageData?.length || 0, 'items');
                        setStorage(storageData);
                    }
                } catch (e) {
                    console.error('Error refreshing storage:', e);
                }
            };

            const fetchAllData = async () => {
                setLoading(true);
                try {
                    // fetch everything in parallel
                    const results = await Promise.all([
                        authFetch(`${API_URL}/clusters/${clusterId}/datacenter/status`),
                        authFetch(`${API_URL}/clusters/${clusterId}/datacenter/cluster-info`),
                        authFetch(`${API_URL}/clusters/${clusterId}/datacenter/options`),
                        authFetch(`${API_URL}/clusters/${clusterId}/datacenter/storage`),
                        authFetch(`${API_URL}/clusters/${clusterId}/datacenter/backup`),
                        authFetch(`${API_URL}/clusters/${clusterId}/datacenter/replication`),
                        authFetch(`${API_URL}/clusters/${clusterId}/datacenter/firewall/options`),
                        authFetch(`${API_URL}/clusters/${clusterId}/datacenter/firewall/rules`),
                        authFetch(`${API_URL}/clusters/${clusterId}/datacenter/join-info`),
                        // MK: HA Data
                        authFetch(`${API_URL}/clusters/${clusterId}/datacenter/ha/status`),
                        authFetch(`${API_URL}/clusters/${clusterId}/proxmox-ha/resources`),
                        authFetch(`${API_URL}/clusters/${clusterId}/proxmox-ha/groups`)
                    ]);
                    
                    const [r1, r2, r3, r4, r5, r6, r7, r8, r9, r10, r11, r12] = results;

                    if (r1?.ok) setDcStatus(await r1.json());
                    if (r2?.ok) {
                        const tmp = await r2.json();
                        
                        // Fetch summary for each node - NS Jan 2026
                        const nodesWithSummary = await Promise.all((tmp || []).map(async (node) => {
                            try {
                                const res = await authFetch(`${API_URL}/clusters/${clusterId}/nodes/${node.node || node.name}/summary`);
                                if (res?.ok) {
                                    const summary = await res.json();
                                    return { ...node, summary, name: node.node || node.name };
                                }
                            } catch(e) { console.error('Failed to load node summary:', e); }
                            return { ...node, summary: null, name: node.node || node.name };
                        }));
                        
                        setClusterNodes(nodesWithSummary);
                        
                        // Fetch CPU info for each online node
                        const online = (nodesWithSummary || []).filter(n => n.online !== 0);
                        const cpuPromises = online.map(async (node) => {
                            try {
                                // Use already fetched summary if available
                                if (node.summary) {
                                    const cpuModel = node.summary.cpuinfo?.model || 'Unknown';
                                    const detected = detectCpuGeneration(cpuModel);
                                    return {
                                        node: node.name,
                                        model: cpuModel,
                                        cores: node.summary.cpuinfo?.cores || 0,
                                        sockets: node.summary.cpuinfo?.sockets || 1,
                                        detectedLevel: detected.level,
                                        generation: detected.generation
                                    };
                                }
                                const res = await authFetch(`${API_URL}/clusters/${clusterId}/nodes/${node.name}/summary`);
                                if (res?.ok) {
                                    const s = await res.json();
                                    const cpuModel = s.cpuinfo?.model || 'Unknown';
                                    const detected = detectCpuGeneration(cpuModel);
                                    return {
                                        node: node.name,
                                        model: cpuModel,
                                        cores: s.cpuinfo?.cores || 0,
                                        sockets: s.cpuinfo?.sockets || 1,
                                        detectedLevel: detected.level,
                                        generation: detected.generation
                                    };
                                }
                            } catch(e) {}
                            return null;
                        });
                        
                        const cpuResults = (await Promise.all(cpuPromises)).filter(Boolean);
                        setCpuInfo(cpuResults);
                        setRecommendedCpu(calculateRecommendedCpu(cpuResults));
                    }
                    if (r3?.ok) {
                        const opts = await r3.json();
                        setDcOptions(opts);
                        setEditingOptions(parseOptionsForEdit(opts));
                    }
                    if (r4?.ok) {
                        const storageData = await r4.json();
                        console.log('Fetched storage data:', storageData?.length || 0, 'items');
                        setStorage(storageData);
                    }
                    if (r5?.ok) setBackupJobs(await r5.json());
                    if (r6?.ok) setReplicationJobs(await r6.json());
                    if (r7?.ok) setFirewallOptions(await r7.json());
                    if (r8?.ok) setFirewallRules(await r8.json());
                    if (r9?.ok) setJoinInfo(await r9.json());
                    // MK: HA Data
                    if (r10?.ok) setHaManagerStatus(await r10.json());
                    if (r11?.ok) setHaResources(await r11.json());
                    if (r12?.ok) setHaGroups(await r12.json());
                } catch(error) {
                    console.error('fetching datacenter data:', error);
                } finally {
                    setLoading(false);
                }
            };

            const fetchJoinInfo = async () => {
                try {
                    const res = await authFetch(`${API_URL}/clusters/${clusterId}/datacenter/join-info`);
                    if (res && res.ok) {
                        const data = await res.json();
                        setJoinInfo(data);
                        setShowJoinInfo(true);
                    }
                } catch(e) { console.error(e); }
            };

            // NS: added PB for large storages, using toFixed(2) for more precision
            const formatBytes = (bytes) => {
                if (!bytes) return '0 B';
                const k = 1024;
                const sizes = ['B', 'KB', 'MB', 'GB', 'TB', 'PB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return (bytes / Math.pow(k, i)).toFixed(2) + ' ' + sizes[i];
            };

            const saveOptions = async () => {
                try {
                    const payload = {};
                    
                    // === Basic Settings ===
                    if (editingOptions.keyboard && editingOptions.keyboard !== '') {
                        payload.keyboard = editingOptions.keyboard;
                    }
                    
                    const validConsoleValues = ['vv', 'html5', 'xtermjs'];
                    if (editingOptions.console && validConsoleValues.includes(editingOptions.console)) {
                        payload.console = editingOptions.console;
                    }
                    
                    if (editingOptions.http_proxy && editingOptions.http_proxy.trim() !== '') {
                        payload.http_proxy = editingOptions.http_proxy;
                    }
                    
                    if (editingOptions.email_from && editingOptions.email_from.includes('@') && !editingOptions.email_from.includes('$')) {
                        payload.email_from = editingOptions.email_from;
                    }
                    
                    if (editingOptions.mac_prefix && /^[A-Fa-f0-9]{2}(:[A-Fa-f0-9]{2})*$/.test(editingOptions.mac_prefix)) {
                        payload.mac_prefix = editingOptions.mac_prefix.toUpperCase();
                    }
                    
                    if (editingOptions.max_workers && !isNaN(editingOptions.max_workers)) {
                        payload.max_workers = Math.max(1, Math.min(64, parseInt(editingOptions.max_workers)));
                    }
                    
                    // === Migration Settings ===
                    const migrationParts = [];
                    if (editingOptions.migration_type && editingOptions.migration_type !== '') {
                        migrationParts.push(`type=${editingOptions.migration_type}`);
                    }
                    if (editingOptions.migration_network && editingOptions.migration_network.trim() !== '') {
                        migrationParts.push(`network=${editingOptions.migration_network}`);
                    }
                    if (migrationParts.length > 0) {
                        payload.migration = migrationParts.join(',');
                    }
                    
                    // === HA Settings ===
                    if (editingOptions.ha_shutdown_policy && editingOptions.ha_shutdown_policy !== '') {
                        payload.ha = `shutdown_policy=${editingOptions.ha_shutdown_policy}`;
                    }
                    
                    // === CRS Settings ===
                    const crsParts = [];
                    if (editingOptions.crs_ha_rebalance === '1') {
                        crsParts.push('ha-rebalance-on-start=1');
                    }
                    if (editingOptions.crs_mode && editingOptions.crs_mode !== '') {
                        crsParts.push(`scheduling=${editingOptions.crs_mode}`);
                    }
                    if (crsParts.length > 0) {
                        payload.crs = crsParts.join(',');
                    }
                    
                    // === Next ID Range ===
                    const nextIdParts = [];
                    if (editingOptions.next_id_lower && !isNaN(editingOptions.next_id_lower)) {
                        nextIdParts.push(`lower=${editingOptions.next_id_lower}`);
                    }
                    if (editingOptions.next_id_upper && !isNaN(editingOptions.next_id_upper)) {
                        nextIdParts.push(`upper=${editingOptions.next_id_upper}`);
                    }
                    if (nextIdParts.length > 0) {
                        payload['next-id'] = nextIdParts.join(',');
                    }
                    
                    // === Bandwidth Limits ===
                    const bwParts = [];
                    if (editingOptions.bwlimit_clone && editingOptions.bwlimit_clone !== '' && editingOptions.bwlimit_clone !== '0') {
                        bwParts.push(`clone=${editingOptions.bwlimit_clone}`);
                    }
                    if (editingOptions.bwlimit_migration && editingOptions.bwlimit_migration !== '' && editingOptions.bwlimit_migration !== '0') {
                        bwParts.push(`migration=${editingOptions.bwlimit_migration}`);
                    }
                    if (editingOptions.bwlimit_move && editingOptions.bwlimit_move !== '' && editingOptions.bwlimit_move !== '0') {
                        bwParts.push(`move=${editingOptions.bwlimit_move}`);
                    }
                    if (editingOptions.bwlimit_restore && editingOptions.bwlimit_restore !== '' && editingOptions.bwlimit_restore !== '0') {
                        bwParts.push(`restore=${editingOptions.bwlimit_restore}`);
                    }
                    if (editingOptions.bwlimit_default && editingOptions.bwlimit_default !== '' && editingOptions.bwlimit_default !== '0') {
                        bwParts.push(`default=${editingOptions.bwlimit_default}`);
                    }
                    if (bwParts.length > 0) {
                        payload.bwlimit = bwParts.join(',');
                    }
                    
                    // === Tag Settings ===
                    // MK: user-tag-access is complex - Proxmox API is picky about format
                    // Skip for now - "free" is default anyway
                    // TODO: Implement proper format if needed
                    
                    // registered-tags is simpler - just semicolon-separated list
                    
                    if (editingOptions.registered_tags && editingOptions.registered_tags.trim() !== '') {
                        payload['registered-tags'] = editingOptions.registered_tags;
                    }
                    
                    // === Tag Style ===
                    const tagStyleParts = [];
                    if (editingOptions.tag_style_shape && editingOptions.tag_style_shape !== '') {
                        tagStyleParts.push(`shape=${editingOptions.tag_style_shape}`);
                    }
                    if (editingOptions.tag_style_color_map && editingOptions.tag_style_color_map !== '') {
                        tagStyleParts.push(`color-map=${editingOptions.tag_style_color_map}`);
                    }
                    if (editingOptions.tag_style_ordering && editingOptions.tag_style_ordering !== '') {
                        tagStyleParts.push(`ordering=${editingOptions.tag_style_ordering}`);
                    }
                    if (tagStyleParts.length > 0) {
                        payload['tag-style'] = tagStyleParts.join(',');
                    }
                    
                    console.log('Sending datacenter options:', payload);
                    
                    const res = await fetch(`${API_URL}/clusters/${clusterId}/datacenter/options`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify(payload)
                    });
                    if (res.ok) {
                        // Refresh options from server to get latest state
                        await loadOptions();
                        setShowEditOptions(false);
                        addToast(t('optionsSaved') || 'Options saved', 'success');
                    } else {
                        const err = await res.json();
                        console.error('Datacenter options error:', err);
                        addToast(err.errors ? JSON.stringify(err.errors) : (err.error || 'Failed to save options'), 'error');
                    }
                } catch(e) { 
                    console.error(e); 
                    addToast('Failed to save options', 'error');
                }
            };

            const createStorage = async () => {
                // NS: Improved validation - Dec 2025
                // Validate required fields based on storage type
                const requiredFields = {
                    dir: ['path'],
                    nfs: ['server', 'export'],
                    cifs: ['server', 'share'],
                    lvm: ['vgname'],
                    lvmthin: ['vgname', 'thinpool'],
                    iscsi: ['portal', 'target'],
                    rbd: ['pool', 'monhost'],
                    cephfs: ['monhost'],
                    zfspool: ['pool'],
                    zfs: ['portal', 'target', 'pool'],
                    pbs: ['server', 'datastore', 'username', 'password'],
                    btrfs: ['path'],
                };
                
                const required = requiredFields[newStorage.type] || [];
                const missing = required.filter(f => !newStorage[f]);
                
                if (!newStorage.storage) {
                    addToast(t('storageIdRequired') || 'Storage ID is required', 'error');
                    return;
                }
                
                // Validate storage ID format
                if (!/^[a-zA-Z][a-zA-Z0-9\-\_\.]*$/.test(newStorage.storage)) {
                    addToast(t('invalidStorageId') || 'Storage ID must start with a letter and contain only letters, numbers, -, _, .', 'error');
                    return;
                }
                
                if (missing.length > 0) {
                    addToast(`${t('missingFields') || 'Missing required fields'}: ${missing.join(', ')}`, 'error');
                    return;
                }
                
                // NS: Additional validation for Shared LVM - need base (storage:lun) when baseStorage is set
                if (newStorage.type === 'lvm' && newStorage.baseStorage && !newStorage.base) {
                    addToast('Please select a LUN for Shared LVM', 'error');
                    return;
                }
                
                try {
                    // Build storage data based on type
                    const storageData = { ...newStorage };
                    
                    // Remove UI-only fields that shouldn't be sent to API
                    delete storageData.baseStorage; // LW: This is UI-only, 'base' contains the actual value
                    
                    // Remove empty fields
                    Object.keys(storageData).forEach(key => {
                        if (storageData[key] === '' || storageData[key] === undefined) {
                            delete storageData[key];
                        }
                    });
                    
                    // Convert enabled to disable (Proxmox uses disable=1 to disable)
                    if (storageData.enabled === false) {
                        storageData.disable = 1;
                    }
                    delete storageData.enabled;
                    
                    // NS: Debug output for troubleshooting
                    console.log('=== Storage Creation Debug ===');
                    console.log('Type:', storageData.type);
                    console.log('ID:', storageData.storage);
                    console.log('Base:', storageData.base);
                    console.log('VGName:', storageData.vgname);
                    console.log('Full data:', JSON.stringify(storageData, null, 2));
                    
                    const res = await fetch(`${API_URL}/clusters/${clusterId}/datacenter/storage`, {
                        method: 'POST',
                        headers: { ...authHeaders, 'Content-Type': 'application/json' },
                        body: JSON.stringify(storageData)
                    });
                    
                    const data = await res.json();
                    console.log('Create storage response:', res.status, data);
                    
                    if (res.ok && data.success) {
                        setShowAddStorage(false);
                        setNewStorage({ type: 'dir', storage: '', path: '', content: 'images,rootdir', enabled: true });
                        setScanResults([]); // Clear scan results
                        addToast(t('storageCreated') || 'Storage created successfully', 'success');
                        // NS: Only refresh storage list, not everything
                        await refreshStorage();
                    } else {
                        console.error('Storage creation failed:', data);
                        const errorMsg = data.error || data.message || 'Failed to create storage';
                        addToast(`Error: ${errorMsg}`, 'error');
                    }
                } catch(e) { 
                    console.error('Create storage error:', e);
                    addToast(`Error creating storage: ${e.message}`, 'error');
                }
            };
            
            // NS: Scan storage targets (iSCSI, NFS, CIFS, etc.)
            const [scanning, setScanning] = useState(false);
            const [scanResults, setScanResults] = useState([]);
            
            const scanStorage = async (type) => {
                setScanning(true);
                setScanResults([]);
                
                try {
                    const scanData = { type };
                    
                    // Add required params for each type
                    if (type === 'iscsi' && newStorage.portal) {
                        scanData.portal = newStorage.portal;
                    } else if (type === 'nfs' && newStorage.server) {
                        scanData.server = newStorage.server;
                    } else if (type === 'cifs' && newStorage.server) {
                        scanData.server = newStorage.server;
                        if (newStorage.username) scanData.username = newStorage.username;
                        if (newStorage.password) scanData.password = newStorage.password;
                        if (newStorage.domain) scanData.domain = newStorage.domain;
                    } else if (type === 'lvmthin' && newStorage.vgname) {
                        scanData.vgname = newStorage.vgname;
                    } else if (type === 'lvm') {
                        // No extra params needed
                    } else if (type === 'zfs') {
                        // No extra params needed
                    } else {
                        addToast(t('enterServerFirst') || 'Please enter server/portal address first', 'warning');
                        setScanning(false);
                        return;
                    }
                    
                    const res = await fetch(`${API_URL}/clusters/${clusterId}/storage/scan`, {
                        method: 'POST',
                        headers: { ...authHeaders, 'Content-Type': 'application/json' },
                        body: JSON.stringify(scanData)
                    });
                    
                    const data = await res.json();
                    
                    if (res.ok && data.success) {
                        setScanResults(data.data || []);
                        if (data.data?.length === 0) {
                            addToast(t('noTargetsFound') || 'No targets found', 'warning');
                        }
                    } else {
                        addToast(`Scan failed: ${data.error}`, 'error');
                    }
                } catch (e) {
                    console.error('Scan error:', e);
                    addToast(`Scan error: ${e.message}`, 'error');
                } finally {
                    setScanning(false);
                }
            };

            const deleteStorage = async (storageId) => {
                if (!confirm(t('deleteStorageConfirm'))) return;
                try {
                    const res = await fetch(`${API_URL}/clusters/${clusterId}/datacenter/storage/${storageId}`, { 
                        method: 'DELETE',
                        headers: authHeaders
                    });
                    if (res.ok) {
                        setStorage(storage.filter(s => s.storage !== storageId));
                    }else{
                        const data = await res.json();
                        alert(`Error: ${data.error || 'Failed to delete storage'}`);
                    }
                } catch(e) { 
                    console.error('Delete storage error:', e);
                    // dont show alert here, too annoying
                }
            };

            // NS: backup job stuff below
            const deleteBackupJob = async (jobId) => {
                if (!confirm(t('deleteBackupJobConfirm'))) return;
                try {
                    const res = await fetch(`${API_URL}/clusters/${clusterId}/datacenter/backup/${jobId}`, { 
                        method: 'DELETE',
                        headers: authHeaders
                    });
                    if (res.ok) setBackupJobs(backupJobs.filter(j => j.id !== jobId));
                } catch(e) { /* ignore */ }
            };

            const createBackupJob = async () => {
                try {
                    const jobData = { ...newBackupJob };
                    // Convert schedule to Proxmox systemd calender format
                    // Proxmox uses systemd calender events, not cron!
                    const scheduleMap = {
                        'daily': '02:00',           // Daily at 2 AM
                        'weekly': 'sun 02:00',      // Sunday at 2 AM
                        'monthly': '*-*-01 02:00',  // First of month at 2 AM
                        'hourly': '*:00'            // Every hour
                    };
                    if(scheduleMap[jobData.schedule]) {
                        jobData.schedule = scheduleMap[jobData.schedule];
                    }
                    
                    // handle vmid: if empty or 'all', set all=1 flag
                    if(!jobData.vmid || jobData.vmid === '' || jobData.vmid === 'all') {
                        jobData.all = 1;
                        delete jobData.vmid;
                    }
                    
                    // Remove empty fileds (but not 'all')
                    Object.keys(jobData).forEach(key => {
                        if(key !== 'all' && (jobData[key] === '' || jobData[key] === null)) {
                            delete jobData[key];
                        }
                    });
                    
                    const res = await fetch(`${API_URL}/clusters/${clusterId}/datacenter/backup`, {
                        method: 'POST',
                        headers: { ...authHeaders, 'Content-Type': 'application/json' },
                        body: JSON.stringify(jobData)
                    });
                    
                    if(res.ok) {
                        setShowAddBackupJob(false);
                        setNewBackupJob({
                            enabled: 1, schedule: 'daily', storage: '', mode: 'snapshot',
                            compress: 'zstd', vmid: '', node: '', mailnotification: 'always', mailto: ''
                        });
                        // Reload backup jobs
                        const backupRes = await authFetch(`${API_URL}/clusters/${clusterId}/datacenter/backup`);
                        if(backupRes && backupRes.ok) setBackupJobs(await backupRes.json());
                    }else{
                        const err = await res.json();
                        alert(err.error || 'Failed');
                    }
                } catch(e) {
                    console.error(e);
                }
            };

            const deleteFirewallRule = async (pos) => {
                if(!confirm(t('deleteRuleConfirm'))) return;
                try {
                    const res = await fetch(`${API_URL}/clusters/${clusterId}/datacenter/firewall/rules/${pos}`, { 
                        method: 'DELETE',
                        headers: authHeaders
                    });
                    if (res.ok) setFirewallRules(firewallRules.filter(r => r.pos !== pos));
                } catch(e) { console.error(e); }
            };

            if (loading) {
                return (
                    <div className="flex items-center justify-center h-64">
                        <Icons.RotateCw />
                        <span className="ml-2">{t('loadingDatacenter') || 'Loading datacenter data / Lade Datacenter Daten...'}</span>
                    </div>
                );
            }

            return (
                <div className="flex gap-6">
                    {/* Sidebar */}
                    <div className="w-48 flex-shrink-0">
                        <div className="bg-proxmox-card border border-proxmox-border rounded-xl p-3 sticky top-6">
                            <nav className="space-y-1">
                                {sections.map(section => (
                                    <button
                                        key={section.id}
                                        onClick={() => setActiveSection(section.id)}
                                        className={`w-full flex items-center gap-2 px-3 py-2 rounded-lg text-sm transition-all ${
                                            activeSection === section.id
                                                ? 'bg-proxmox-orange text-white'
                                                : 'text-gray-400 hover:bg-proxmox-dark hover:text-white'
                                        }`}
                                    >
                                        <section.icon />
                                        {t(section.labelKey)}
                                    </button>
                                ))}
                            </nav>
                        </div>
                    </div>

                    {/* Content */}
                    <div className="flex-1 space-y-6">
                        {/* Summary */}
                        {activeSection === 'summary' && dcStatus && (
                            <>
                                <div className="grid grid-cols-2 gap-6">
                                    <div className="bg-proxmox-card border border-proxmox-border rounded-xl p-6">
                                        <h3 className="text-lg font-semibold mb-4 text-green-400">Status</h3>
                                        <div className="flex items-center justify-center">
                                            <div className={`w-20 h-20 rounded-full flex items-center justify-center text-3xl ${dcStatus.cluster?.quorate ? 'bg-green-500/20 text-green-400' : 'bg-red-500/20 text-red-400'}`}>
                                                {dcStatus.cluster?.quorate ? '‚úì' : '‚úó'}
                                            </div>
                                        </div>
                                        <p className="text-center mt-4 text-sm text-gray-400">
                                            {dcStatus.cluster?.name} | Quorate: {dcStatus.cluster?.quorate ? 'Yes' : 'No'}
                                        </p>
                                    </div>
                                    <div className="bg-proxmox-card border border-proxmox-border rounded-xl p-6">
                                        <h3 className="text-lg font-semibold mb-4">Nodes</h3>
                                        <div className="space-y-3">
                                            <div className="flex justify-between"><span className="text-green-400">‚óè Online</span><span className="font-bold text-xl">{dcStatus.nodes?.online || 0}</span></div>
                                            <div className="flex justify-between"><span className="text-red-400">‚úó Offline</span><span className="font-bold text-xl">{dcStatus.nodes?.offline || 0}</span></div>
                                        </div>
                                    </div>
                                </div>

                                <div className="bg-proxmox-card border border-proxmox-border rounded-xl p-6">
                                    <h3 className="text-lg font-semibold mb-4 text-cyan-400">Guests</h3>
                                    <div className="grid grid-cols-2 gap-6">
                                        <div>
                                            <h4 className="font-medium mb-3">Virtual Machines</h4>
                                            <div className="space-y-2 text-sm">
                                                <div className="flex justify-between"><span className="text-green-400">‚óè Running</span><span>{dcStatus.guests?.vms?.running || 0}</span></div>
                                                <div className="flex justify-between"><span className="text-gray-400">‚óã Stopped</span><span>{dcStatus.guests?.vms?.stopped || 0}</span></div>
                                            </div>
                                        </div>
                                        <div>
                                            <h4 className="font-medium mb-3">LXC Container</h4>
                                            <div className="space-y-2 text-sm">
                                                <div className="flex justify-between"><span className="text-green-400">‚óè Running</span><span>{dcStatus.guests?.containers?.running || 0}</span></div>
                                                <div className="flex justify-between"><span className="text-gray-400">‚óã Stopped</span><span>{dcStatus.guests?.containers?.stopped || 0}</span></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div className="bg-proxmox-card border border-proxmox-border rounded-xl p-6">
                                    <h3 className="text-lg font-semibold mb-4 text-yellow-400">Resources</h3>
                                    <div className="grid grid-cols-3 gap-6">
                                        {['cpu', 'memory', 'storage'].map(type => (
                                            <div key={type} className="text-center">
                                                <h4 className="font-medium mb-3 capitalize">{type}</h4>
                                                <div className="text-3xl font-bold text-blue-400">{dcStatus.resources?.[type]?.percent || 0}%</div>
                                                <p className="text-xs text-gray-500 mt-2">
                                                    {type === 'cpu' ? `${dcStatus.resources?.cpu?.total || 0} CPU(s)` : formatBytes(dcStatus.resources?.[type]?.total)}
                                                </p>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </>
                        )}

                        {/* Cluster Nodes */}
                        {activeSection === 'cluster' && (
                            <div className="space-y-4">
                                {/* Cluster Information Card */}
                                <div className="bg-proxmox-card border border-proxmox-border rounded-xl overflow-hidden">
                                    <div className="p-4 border-b border-proxmox-border">
                                        <h3 className="font-semibold flex items-center gap-2">
                                            <Icons.Info />
                                            Cluster Information
                                        </h3>
                                    </div>
                                    <div className="p-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label className="block text-xs text-gray-500 mb-1">Cluster Name</label>
                                            <div className="flex items-center gap-2">
                                                <input 
                                                    readOnly 
                                                    value={joinInfo?.cluster_name || dcStatus?.cluster?.name || 'Loading...'} 
                                                    className="flex-1 bg-proxmox-dark border border-proxmox-border rounded px-3 py-2 font-mono text-sm"
                                                />
                                                <button 
                                                    onClick={() => navigator.clipboard.writeText(joinInfo?.cluster_name || dcStatus?.cluster?.name || '')}
                                                    className="p-2 bg-proxmox-dark hover:bg-proxmox-border rounded transition-colors"
                                                    title="Copy"
                                                >
                                                    <Icons.Copy />
                                                </button>
                                            </div>
                                        </div>
                                        <div>
                                            <label className="block text-xs text-gray-500 mb-1">Cluster IP / Join Address</label>
                                            <div className="flex items-center gap-2">
                                                <input 
                                                    readOnly 
                                                    value={joinInfo?.preferred_node || clusterNodes[0]?.ring0_addr || clusterNodes[0]?.ip || 'Loading...'} 
                                                    className="flex-1 bg-proxmox-dark border border-proxmox-border rounded px-3 py-2 font-mono text-sm"
                                                />
                                                <button 
                                                    onClick={() => navigator.clipboard.writeText(joinInfo?.preferred_node || clusterNodes[0]?.ring0_addr || '')}
                                                    className="p-2 bg-proxmox-dark hover:bg-proxmox-border rounded transition-colors"
                                                    title="Copy"
                                                >
                                                    <Icons.Copy />
                                                </button>
                                            </div>
                                        </div>
                                        <div className="md:col-span-2">
                                            <label className="block text-xs text-gray-500 mb-1">Fingerprint</label>
                                            <div className="flex items-center gap-2">
                                                <textarea 
                                                    readOnly 
                                                    value={joinInfo?.fingerprint || 'Loading... (If empty, run "pvecm status" on a node)'} 
                                                    className="flex-1 bg-proxmox-dark border border-proxmox-border rounded px-3 py-2 font-mono text-xs h-16 resize-none"
                                                />
                                                <button 
                                                    onClick={() => navigator.clipboard.writeText(joinInfo?.fingerprint || '')}
                                                    className="p-2 bg-proxmox-dark hover:bg-proxmox-border rounded transition-colors self-start"
                                                    title="Copy"
                                                >
                                                    <Icons.Copy />
                                                </button>
                                            </div>
                                        </div>
                                        {joinInfo?.nodelist && joinInfo.nodelist.length > 0 && (
                                            <div className="md:col-span-2">
                                                <label className="block text-xs text-gray-500 mb-1">Available Join Nodes</label>
                                                <div className="flex flex-wrap gap-2">
                                                    {joinInfo.nodelist.map((node, idx) => (
                                                        <div key={idx} className="px-3 py-1.5 bg-proxmox-dark border border-proxmox-border rounded-lg text-sm font-mono">
                                                            {node.name}: {node.ring0_addr || node.pve_addr}
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                    <div className="px-4 pb-4">
                                        <p className="text-xs text-gray-500">
                                            üí° Um einen neuen Node hinzuzuf√ºgen, f√ºhre auf dem neuen Node aus: <code className="bg-proxmox-dark px-1 rounded">pvecm add {joinInfo?.preferred_node || clusterNodes[0]?.ring0_addr || 'IP'}</code>
                                        </p>
                                    </div>
                                </div>

                                {/* Cluster Nodes Table */}
                                <div className="bg-proxmox-card border border-proxmox-border rounded-xl overflow-hidden">
                                    <div className="p-4 border-b border-proxmox-border flex justify-between items-center">
                                        <h3 className="font-semibold">Cluster Nodes</h3>
                                        <div className="flex items-center gap-3">
                                            <span className="text-sm text-gray-400">{clusterNodes.length} Node(s)</span>
                                            <button onClick={() => setShowNodeJoinWizard(true)} className="flex items-center gap-2 px-3 py-1.5 bg-proxmox-orange hover:bg-orange-600 rounded-lg text-sm text-white"><Icons.Plus className="w-4 h-4" />Add Node</button>
                                        </div>
                                    </div>
                                    <table className="w-full">
                                        <thead className="bg-proxmox-dark">
                                            <tr>
                                                <th className="text-left p-3 text-sm text-gray-400">Nodename</th>
                                                <th className="text-left p-3 text-sm text-gray-400">ID</th>
                                                <th className="text-left p-3 text-sm text-gray-400">Votes</th>
                                                <th className="text-left p-3 text-sm text-gray-400">Ring 0 Address</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {clusterNodes.map((node, idx) => (
                                                <tr key={idx} className="border-t border-proxmox-border hover:bg-proxmox-dark/50">
                                                    <td className="p-3 font-medium">{node.name}</td>
                                                    <td className="p-3">{node.nodeid}</td>
                                                    <td className="p-3">{node.quorum_votes || 1}</td>
                                                    <td className="p-3 font-mono text-sm">{node.ring0_addr || node.ip || '-'}</td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        )}
                        
                        
                        {/* Options */}
                        {activeSection === 'options' && (
                            <div className="bg-proxmox-card border border-proxmox-border rounded-xl overflow-hidden">
                                <div className="p-4 border-b border-proxmox-border flex justify-between items-center">
                                    <h3 className="font-semibold">Datacenter Options</h3>
                                    <button onClick={() => {
                                        if (!showEditOptions) {
                                            // MK: Parse complex options when opening edit form
                                            setEditingOptions(parseOptionsForEdit(dcOptions));
                                        }
                                        setShowEditOptions(!showEditOptions);
                                    }} className="flex items-center gap-2 px-3 py-1.5 bg-proxmox-dark hover:bg-proxmox-border rounded-lg text-sm">
                                        <Icons.Edit /> Edit
                                    </button>
                                </div>
                                {showEditOptions ? (
                                    <div className="p-4 space-y-4">
                                        <div className="grid grid-cols-2 gap-4">
                                            {/* Basic Settings */}
                                            <div>
                                                <label className="block text-sm text-gray-400 mb-1">Keyboard Layout</label>
                                                <select value={editingOptions.keyboard || 'de'} onChange={e => setEditingOptions({...editingOptions, keyboard: e.target.value})} className="w-full bg-proxmox-dark border border-proxmox-border rounded p-2 text-sm">
                                                    <option value="de">German (de)</option>
                                                    <option value="de-ch">German (Swiss)</option>
                                                    <option value="en-us">English (US)</option>
                                                    <option value="en-gb">English (GB)</option>
                                                    <option value="fr">French</option>
                                                    <option value="fr-ch">French (Swiss)</option>
                                                    <option value="es">Spanish</option>
                                                    <option value="it">Italian</option>
                                                    <option value="nl">Dutch</option>
                                                    <option value="pl">Polish</option>
                                                    <option value="pt">Portuguese</option>
                                                    <option value="pt-br">Portuguese (Brazil)</option>
                                                    <option value="ru">Russian</option>
                                                    <option value="ja">Japanese</option>
                                                    <option value="sv">Swedish</option>
                                                    <option value="no">Norwegian</option>
                                                    <option value="da">Danish</option>
                                                    <option value="fi">Finnish</option>
                                                    <option value="tr">Turkish</option>
                                                </select>
                                            </div>
                                            <div>
                                                <label className="block text-sm text-gray-400 mb-1">Console Viewer</label>
                                                <select value={editingOptions.console || ''} onChange={e => setEditingOptions({...editingOptions, console: e.target.value})} className="w-full bg-proxmox-dark border border-proxmox-border rounded p-2 text-sm">
                                                    <option value="">Default (xterm.js)</option>
                                                    <option value="xtermjs">xterm.js</option>
                                                    <option value="html5">noVNC</option>
                                                    <option value="vv">SPICE (virt-viewer)</option>
                                                </select>
                                            </div>
                                            <div>
                                                <label className="block text-sm text-gray-400 mb-1">HTTP Proxy</label>
                                                <input value={editingOptions.http_proxy || ''} onChange={e => setEditingOptions({...editingOptions, http_proxy: e.target.value})} placeholder="http://proxy:port" className="w-full bg-proxmox-dark border border-proxmox-border rounded p-2 text-sm" />
                                            </div>
                                            <div>
                                                <label className="block text-sm text-gray-400 mb-1">Email from address</label>
                                                <input value={editingOptions.email_from || ''} onChange={e => setEditingOptions({...editingOptions, email_from: e.target.value})} placeholder="root@$hostname" className="w-full bg-proxmox-dark border border-proxmox-border rounded p-2 text-sm" />
                                            </div>
                                            <div>
                                                <label className="block text-sm text-gray-400 mb-1">MAC address prefix</label>
                                                <input value={editingOptions.mac_prefix || ''} onChange={e => setEditingOptions({...editingOptions, mac_prefix: e.target.value})} placeholder="BC:24:11" className="w-full bg-proxmox-dark border border-proxmox-border rounded p-2 text-sm font-mono" />
                                            </div>
                                            <div>
                                                <label className="block text-sm text-gray-400 mb-1">Max Workers/bulk-action</label>
                                                <input type="number" min="1" max="64" value={editingOptions.max_workers || 4} onChange={e => setEditingOptions({...editingOptions, max_workers: parseInt(e.target.value) || 4})} className="w-full bg-proxmox-dark border border-proxmox-border rounded p-2 text-sm" />
                                            </div>
                                        </div>
                                        
                                        {/* Migration Settings */}
                                        <div className="border-t border-proxmox-border pt-4">
                                            <h4 className="text-sm font-medium text-gray-300 mb-3">Migration Settings</h4>
                                            <div className="grid grid-cols-2 gap-4">
                                                <div>
                                                    <label className="block text-sm text-gray-400 mb-1">Migration Type</label>
                                                    <select value={editingOptions.migration_type || ''} onChange={e => setEditingOptions({...editingOptions, migration_type: e.target.value})} className="w-full bg-proxmox-dark border border-proxmox-border rounded p-2 text-sm">
                                                        <option value="">Default (secure)</option>
                                                        <option value="secure">Secure (encrypted)</option>
                                                        <option value="insecure">Insecure (faster)</option>
                                                    </select>
                                                </div>
                                                <div>
                                                    <label className="block text-sm text-gray-400 mb-1">Migration Network</label>
                                                    <input value={editingOptions.migration_network || ''} onChange={e => setEditingOptions({...editingOptions, migration_network: e.target.value})} placeholder="e.g. 10.0.0.0/24" className="w-full bg-proxmox-dark border border-proxmox-border rounded p-2 text-sm font-mono" />
                                                    <span className="text-xs text-gray-500">CIDR network for migration traffic</span>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        {/* HA Settings */}
                                        <div className="border-t border-proxmox-border pt-4">
                                            <h4 className="text-sm font-medium text-gray-300 mb-3">HA Settings</h4>
                                            <div className="grid grid-cols-2 gap-4">
                                                <div>
                                                    <label className="block text-sm text-gray-400 mb-1">Shutdown Policy</label>
                                                    <select value={editingOptions.ha_shutdown_policy || ''} onChange={e => setEditingOptions({...editingOptions, ha_shutdown_policy: e.target.value})} className="w-full bg-proxmox-dark border border-proxmox-border rounded p-2 text-sm">
                                                        <option value="">Default (conditional)</option>
                                                        <option value="freeze">Freeze - keep resources frozen on shutdown</option>
                                                        <option value="failover">Failover - migrate to other node</option>
                                                        <option value="migrate">Migrate - always migrate</option>
                                                        <option value="conditional">Conditional - migrate if possible</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        {/* Cluster Resource Scheduling */}
                                        <div className="border-t border-proxmox-border pt-4">
                                            <h4 className="text-sm font-medium text-gray-300 mb-3">Cluster Resource Scheduling (CRS)</h4>
                                            <div className="grid grid-cols-2 gap-4">
                                                <div>
                                                    <label className="block text-sm text-gray-400 mb-1">HA Rebalance on Start</label>
                                                    <select value={editingOptions.crs_ha_rebalance || ''} onChange={e => setEditingOptions({...editingOptions, crs_ha_rebalance: e.target.value})} className="w-full bg-proxmox-dark border border-proxmox-border rounded p-2 text-sm">
                                                        <option value="">Disabled</option>
                                                        <option value="1">Enabled - auto-rebalance HA resources on node start</option>
                                                    </select>
                                                </div>
                                                <div>
                                                    <label className="block text-sm text-gray-400 mb-1">CRS Scheduling Mode</label>
                                                    <select value={editingOptions.crs_mode || ''} onChange={e => setEditingOptions({...editingOptions, crs_mode: e.target.value})} className="w-full bg-proxmox-dark border border-proxmox-border rounded p-2 text-sm">
                                                        <option value="">Default (basic)</option>
                                                        <option value="basic">Basic - simple load distribution</option>
                                                        <option value="static">Static - consider static resource config</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        {/* VMID Range */}
                                        <div className="border-t border-proxmox-border pt-4">
                                            <h4 className="text-sm font-medium text-gray-300 mb-3">Next Free VMID Range</h4>
                                            <div className="grid grid-cols-2 gap-4">
                                                <div>
                                                    <label className="block text-sm text-gray-400 mb-1">Lower Bound</label>
                                                    <input type="number" min="100" max="999999999" value={editingOptions.next_id_lower || 100} onChange={e => setEditingOptions({...editingOptions, next_id_lower: parseInt(e.target.value) || 100})} className="w-full bg-proxmox-dark border border-proxmox-border rounded p-2 text-sm" />
                                                </div>
                                                <div>
                                                    <label className="block text-sm text-gray-400 mb-1">Upper Bound</label>
                                                    <input type="number" min="100" max="999999999" value={editingOptions.next_id_upper || 999999999} onChange={e => setEditingOptions({...editingOptions, next_id_upper: parseInt(e.target.value) || 999999999})} className="w-full bg-proxmox-dark border border-proxmox-border rounded p-2 text-sm" />
                                                </div>
                                            </div>
                                        </div>
                                        
                                        {/* Bandwidth Limits */}
                                        <div className="border-t border-proxmox-border pt-4">
                                            <h4 className="text-sm font-medium text-gray-300 mb-3">Bandwidth Limits (MiB/s, 0 = unlimited)</h4>
                                            <div className="grid grid-cols-3 gap-4">
                                                <div>
                                                    <label className="block text-sm text-gray-400 mb-1">Clone</label>
                                                    <input type="number" min="0" value={editingOptions.bwlimit_clone || ''} onChange={e => setEditingOptions({...editingOptions, bwlimit_clone: e.target.value})} placeholder="0" className="w-full bg-proxmox-dark border border-proxmox-border rounded p-2 text-sm" />
                                                </div>
                                                <div>
                                                    <label className="block text-sm text-gray-400 mb-1">Migration</label>
                                                    <input type="number" min="0" value={editingOptions.bwlimit_migration || ''} onChange={e => setEditingOptions({...editingOptions, bwlimit_migration: e.target.value})} placeholder="0" className="w-full bg-proxmox-dark border border-proxmox-border rounded p-2 text-sm" />
                                                </div>
                                                <div>
                                                    <label className="block text-sm text-gray-400 mb-1">Move</label>
                                                    <input type="number" min="0" value={editingOptions.bwlimit_move || ''} onChange={e => setEditingOptions({...editingOptions, bwlimit_move: e.target.value})} placeholder="0" className="w-full bg-proxmox-dark border border-proxmox-border rounded p-2 text-sm" />
                                                </div>
                                                <div>
                                                    <label className="block text-sm text-gray-400 mb-1">Restore</label>
                                                    <input type="number" min="0" value={editingOptions.bwlimit_restore || ''} onChange={e => setEditingOptions({...editingOptions, bwlimit_restore: e.target.value})} placeholder="0" className="w-full bg-proxmox-dark border border-proxmox-border rounded p-2 text-sm" />
                                                </div>
                                                <div>
                                                    <label className="block text-sm text-gray-400 mb-1">Default</label>
                                                    <input type="number" min="0" value={editingOptions.bwlimit_default || ''} onChange={e => setEditingOptions({...editingOptions, bwlimit_default: e.target.value})} placeholder="0" className="w-full bg-proxmox-dark border border-proxmox-border rounded p-2 text-sm" />
                                                </div>
                                            </div>
                                        </div>
                                        
                                        {/* Tags */}
                                        <div className="border-t border-proxmox-border pt-4">
                                            <h4 className="text-sm font-medium text-gray-300 mb-3">Tag Settings</h4>
                                            <div className="grid grid-cols-2 gap-4">
                                                <div>
                                                    <label className="block text-sm text-gray-400 mb-1">User Tag Access</label>
                                                    <select value={editingOptions.user_tag_access || 'free'} disabled className="w-full bg-proxmox-dark border border-proxmox-border rounded p-2 text-sm opacity-50 cursor-not-allowed">
                                                        <option value="free">Free - users can create any tags</option>
                                                        <option value="existing">Existing - only use existing tags</option>
                                                        <option value="list">List - only use registered tags</option>
                                                        <option value="none">None - no tag editing allowed</option>
                                                    </select>
                                                    <span className="text-xs text-gray-500">Edit via Proxmox UI</span>
                                                </div>
                                                <div>
                                                    <label className="block text-sm text-gray-400 mb-1">Registered Tags</label>
                                                    <input value={editingOptions.registered_tags || ''} onChange={e => setEditingOptions({...editingOptions, registered_tags: e.target.value})} placeholder="tag1;tag2;tag3" className="w-full bg-proxmox-dark border border-proxmox-border rounded p-2 text-sm" />
                                                    <span className="text-xs text-gray-500">Semicolon-separated list of allowed tags</span>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        {/* Tag Style */}
                                        <div className="border-t border-proxmox-border pt-4">
                                            <h4 className="text-sm font-medium text-gray-300 mb-3">Tag Style Override</h4>
                                            <div className="grid grid-cols-3 gap-4">
                                                <div>
                                                    <label className="block text-sm text-gray-400 mb-1">Shape</label>
                                                    <select value={editingOptions.tag_style_shape || ''} onChange={e => setEditingOptions({...editingOptions, tag_style_shape: e.target.value})} className="w-full bg-proxmox-dark border border-proxmox-border rounded p-2 text-sm">
                                                        <option value="">Default</option>
                                                        <option value="full">Full</option>
                                                        <option value="circle">Circle</option>
                                                        <option value="dense">Dense</option>
                                                        <option value="none">None</option>
                                                    </select>
                                                </div>
                                                <div>
                                                    <label className="block text-sm text-gray-400 mb-1">Color Mode</label>
                                                    <select value={editingOptions.tag_style_color_map || ''} onChange={e => setEditingOptions({...editingOptions, tag_style_color_map: e.target.value})} className="w-full bg-proxmox-dark border border-proxmox-border rounded p-2 text-sm">
                                                        <option value="">Default</option>
                                                        <option value="auto">Auto - generate from tag name</option>
                                                    </select>
                                                </div>
                                                <div>
                                                    <label className="block text-sm text-gray-400 mb-1">Ordering</label>
                                                    <select value={editingOptions.tag_style_ordering || ''} onChange={e => setEditingOptions({...editingOptions, tag_style_ordering: e.target.value})} className="w-full bg-proxmox-dark border border-proxmox-border rounded p-2 text-sm">
                                                        <option value="">Default (config)</option>
                                                        <option value="config">Config order</option>
                                                        <option value="alphabetical">Alphabetical</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div className="flex gap-2 pt-4 border-t border-proxmox-border">
                                            <button onClick={saveOptions} className="px-4 py-2 bg-proxmox-orange hover:bg-orange-600 rounded-lg text-sm">{t('save')}</button>
                                            <button onClick={() => setShowEditOptions(false)} className="px-4 py-2 bg-proxmox-dark hover:bg-proxmox-border rounded-lg text-sm">{t('cancel')}</button>
                                        </div>
                                    </div>
                                ) : (
                                    <table className="w-full">
                                        <tbody>
                                            {(() => {
                                                // MK: Helper to safely format values - API sometimes returns objects
                                                const formatVal = (val, fallback = 'Default') => {
                                                    if (val === null || val === undefined || val === '') return fallback;
                                                    if (typeof val === 'object') {
                                                        // Convert object to readable string
                                                        return Object.entries(val).map(([k,v]) => `${k}: ${v}`).join(', ') || fallback;
                                                    }
                                                    return String(val);
                                                };
                                                return [
                                                    ['Keyboard Layout', formatVal(dcOptions.keyboard, 'German (de)')],
                                                    ['HTTP proxy', formatVal(dcOptions.http_proxy, 'none')],
                                                    ['Console Viewer', formatVal(dcOptions.console, 'Default (xterm.js)')],
                                                    ['Email from address', formatVal(dcOptions.email_from, 'root@$hostname')],
                                                    ['MAC address prefix', formatVal(dcOptions.mac_prefix, 'BC:24:11')],
                                                    ['Migration Settings', formatVal(dcOptions.migration, 'Default')],
                                                    ['HA Settings', formatVal(dcOptions.ha, 'Default')],
                                                    ['Cluster Resource Scheduling', formatVal(dcOptions.crs, 'Default')],
                                                    ['U2F Settings', formatVal(dcOptions.u2f, 'None')],
                                                    ['WebAuthn Settings', formatVal(dcOptions.webauthn, 'None')],
                                                    ['Bandwidth Limits', formatVal(dcOptions.bwlimit, 'None')],
                                                    ['Maximal Workers/bulk-action', formatVal(dcOptions.max_workers, '4')],
                                                    ['Next Free VMID Range', formatVal(dcOptions['next-id'], 'Default')],
                                                    ['Tag Style Override', formatVal(dcOptions['tag-style'], 'No Overrides')],
                                                    ['User Tag Access', formatVal(dcOptions['user-tag-access'], 'Mode: free')],
                                                    ['Registered Tags', formatVal(dcOptions['registered-tags'], 'No Registered Tags')],
                                                ].map(([key, value], idx) => (
                                                    <tr key={idx} className="border-t border-proxmox-border hover:bg-proxmox-dark/30">
                                                        <td className="p-3 text-gray-400 w-1/3">{key}</td>
                                                        <td className="p-3">{value}</td>
                                                    </tr>
                                                ));
                                            })()}
                                        </tbody>
                                    </table>
                                )}
                            </div>
                        )}

                        {/* Storage */}
                        {activeSection === 'storage' && (
                            <div className="space-y-4">
                                <div className="bg-proxmox-card border border-proxmox-border rounded-xl overflow-hidden">
                                    <div className="p-4 border-b border-proxmox-border flex justify-between items-center">
                                        <h3 className="font-semibold flex items-center gap-2">
                                            <Icons.HardDrive />
                                            Storage Configuration
                                        </h3>
                                        <div className="flex gap-2">
                                            <button 
                                                onClick={refreshStorage} 
                                                className="flex items-center gap-2 px-3 py-1.5 bg-proxmox-dark hover:bg-proxmox-hover border border-proxmox-border rounded-lg text-sm transition-colors"
                                                title="Refresh storage list"
                                            >
                                                <Icons.RefreshCw />
                                            </button>
                                            <button onClick={() => setShowAddStorage(true)} className="flex items-center gap-2 px-3 py-1.5 bg-proxmox-orange hover:bg-orange-600 rounded-lg text-sm text-white transition-colors">
                                                <Icons.Plus /> {t('add')}
                                            </button>
                                        </div>
                                    </div>
                                    <div className="overflow-x-auto">
                                        <table className="w-full">
                                            <thead className="bg-proxmox-dark">
                                                <tr>
                                                    <th className="text-left p-3 text-sm text-gray-400">ID</th>
                                                    <th className="text-left p-3 text-sm text-gray-400">{t('type')}</th>
                                                    <th className="text-left p-3 text-sm text-gray-400">Content</th>
                                                    <th className="text-left p-3 text-sm text-gray-400">Path/Server</th>
                                                    <th className="text-left p-3 text-sm text-gray-400">{t('nodes')}</th>
                                                    <th className="text-left p-3 text-sm text-gray-400">Shared</th>
                                                    <th className="text-left p-3 text-sm text-gray-400">{t('status')}</th>
                                                    <th className="text-left p-3 text-sm text-gray-400"></th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {(!storage || storage.length === 0) ? (
                                                    <tr><td colSpan="8" className="p-8 text-center text-gray-500">No storage configured</td></tr>
                                                ) : storage.map((s, idx) => (
                                                    <tr key={idx} className="border-t border-proxmox-border hover:bg-proxmox-dark/50">
                                                        <td className="p-3">
                                                            <div className="flex items-center gap-2">
                                                                <span className={`w-2 h-2 rounded-full ${s.disable ? 'bg-gray-500' : 'bg-green-500'}`}></span>
                                                                <span className="font-medium text-white">{s.storage}</span>
                                                            </div>
                                                        </td>
                                                        <td className="p-3">
                                                            <span className="px-2 py-0.5 bg-proxmox-dark rounded text-xs text-gray-300">
                                                                {s.type}
                                                            </span>
                                                        </td>
                                                        <td className="p-3 text-sm text-gray-400 max-w-48">
                                                            <div className="flex flex-wrap gap-1">
                                                                {(s.content || '').split(',').map((c, i) => (
                                                                    <span key={i} className="px-1.5 py-0.5 bg-blue-500/20 text-blue-400 rounded text-xs">
                                                                        {c.trim()}
                                                                    </span>
                                                                ))}
                                                            </div>
                                                        </td>
                                                        <td className="p-3 font-mono text-sm text-gray-400 max-w-40 truncate">
                                                            {s.path || s.server || s.pool || s.portal || s.export || '-'}
                                                        </td>
                                                        <td className="p-3 text-sm text-gray-400">
                                                            {s.nodes || <span className="text-gray-500 italic">All</span>}
                                                        </td>
                                                        <td className="p-3">
                                                            {s.shared ? (
                                                                <span className="text-green-400">‚úì</span>
                                                            ) : (
                                                                <span className="text-gray-500">-</span>
                                                            )}
                                                        </td>
                                                        <td className="p-3">
                                                            {s.disable ? (
                                                                <span className="px-2 py-0.5 bg-red-500/20 text-red-400 rounded text-xs">{t('disabled')}</span>
                                                            ) : (
                                                                <span className="px-2 py-0.5 bg-green-500/20 text-green-400 rounded text-xs">{t('enabled')}</span>
                                                            )}
                                                        </td>
                                                        <td className="p-3">
                                                            <div className="flex gap-1">
                                                                <button 
                                                                    onClick={() => {
                                                                        setNewStorage({...s, enabled: !s.disable});
                                                                        setShowAddStorage(true);
                                                                    }}
                                                                    className="p-1.5 hover:bg-blue-500/20 rounded text-blue-400 transition-colors" 
                                                                    title="Edit"
                                                                >
                                                                    <Icons.Cog />
                                                                </button>
                                                                <button 
                                                                    onClick={() => deleteStorage(s.storage)} 
                                                                    className="p-1.5 hover:bg-red-500/20 rounded text-red-400 transition-colors" 
                                                                    title={t('delete')}
                                                                >
                                                                    <Icons.Trash />
                                                                </button>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>

                                {/* Add Storage Modal */}
                                {showAddStorage && (
                                    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/70 p-4" onClick={() => setShowAddStorage(false)}>
                                        <div className="bg-proxmox-card border border-proxmox-border rounded-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto" onClick={e => e.stopPropagation()}>
                                            <div className="flex justify-between items-center p-4 border-b border-proxmox-border sticky top-0 bg-proxmox-card z-10">
                                                <h3 className="text-lg font-semibold flex items-center gap-2">
                                                    <Icons.HardDrive />
                                                    {newStorage.storage ? `Edit: ${newStorage.storage}` : `Add: ${storageTypes.find(s => s.id === newStorage.type)?.label || 'Storage'}`}
                                                </h3>
                                                <button onClick={() => setShowAddStorage(false)} className="p-1.5 hover:bg-proxmox-dark rounded-lg transition-colors"><Icons.X /></button>
                                            </div>
                                            
                                            {/* Storage Type Selection */}
                                            <div className="p-4 border-b border-proxmox-border">
                                                <label className="block text-sm text-gray-400 mb-2">Type</label>
                                                <div className="grid grid-cols-5 gap-2">
                                                    {storageTypes.map(st => (
                                                        <button key={st.id} onClick={() => {
                                                            setNewStorage({type: st.id, storage: '', content: 'images,rootdir', enabled: true});
                                                            setScanResults([]); // Clear scan results when type changes
                                                        }}
                                                            className={`p-2 rounded-lg border text-xs flex flex-col items-center gap-1 ${newStorage.type === st.id ? 'border-proxmox-orange bg-proxmox-orange/20' : 'border-proxmox-border hover:bg-proxmox-dark'}`}>
                                                            <span className="text-lg">{st.icon}</span> {st.label}
                                                        </button>
                                                    ))}
                                                </div>
                                            </div>

                                            <div className="p-4 space-y-4">
                                                {/* Common Fields */}
                                                <div className="grid grid-cols-2 gap-4">
                                                    <div>
                                                        <label className="block text-sm text-gray-400 mb-1">ID *</label>
                                                        <input value={newStorage.storage || ''} onChange={e => setNewStorage({...newStorage, storage: e.target.value})} placeholder="storage-name" className="w-full bg-proxmox-dark border border-proxmox-border rounded p-2 text-sm" />
                                                    </div>
                                                    <div>
                                                        <label className="block text-sm text-gray-400 mb-1">Nodes</label>
                                                        <select value={newStorage.nodes || ''} onChange={e => setNewStorage({...newStorage, nodes: e.target.value})} className="w-full bg-proxmox-dark border border-proxmox-border rounded p-2 text-sm">
                                                            <option value="">All (No restrictions)</option>
                                                            {clusterNodes.map(n => <option key={n.name} value={n.name}>{n.name}</option>)}
                                                        </select>
                                                    </div>
                                                </div>

                                                {/* iSCSI Fields */}
                                                {newStorage.type === 'iscsi' && (
                                                    <div className="grid grid-cols-2 gap-4">
                                                        <div>
                                                            <label className="block text-sm text-gray-400 mb-1">Portal *</label>
                                                            <div className="flex gap-2">
                                                                <input value={newStorage.portal || ''} onChange={e => setNewStorage({...newStorage, portal: e.target.value})} placeholder="192.168.1.100" className="flex-1 bg-proxmox-dark border border-proxmox-border rounded p-2 text-sm font-mono" />
                                                                <button 
                                                                    onClick={() => scanStorage('iscsi')} 
                                                                    disabled={!newStorage.portal || scanning}
                                                                    className="px-3 py-2 bg-blue-600 hover:bg-blue-700 disabled:opacity-50 rounded text-sm whitespace-nowrap"
                                                                >
                                                                    {scanning ? '...' : 'Scan'}
                                                                </button>
                                                            </div>
                                                        </div>
                                                        <div>
                                                            <label className="block text-sm text-gray-400 mb-1">Target *</label>
                                                            {scanResults.length > 0 && newStorage.type === 'iscsi' ? (
                                                                <select 
                                                                    value={newStorage.target || ''} 
                                                                    onChange={e => setNewStorage({...newStorage, target: e.target.value})} 
                                                                    className="w-full bg-proxmox-dark border border-proxmox-border rounded p-2 text-sm font-mono"
                                                                >
                                                                    <option value="">Select target...</option>
                                                                    {scanResults.map((r, i) => (
                                                                        <option key={i} value={r.target}>{r.target}</option>
                                                                    ))}
                                                                </select>
                                                            ) : (
                                                                <input value={newStorage.target || ''} onChange={e => setNewStorage({...newStorage, target: e.target.value})} placeholder="iqn.2024..." className="w-full bg-proxmox-dark border border-proxmox-border rounded p-2 text-sm font-mono" />
                                                            )}
                                                        </div>
                                                        <div className="flex items-center gap-4 col-span-2">
                                                            <label className="flex items-center gap-2 text-sm">
                                                                <input type="checkbox" checked={newStorage.enabled !== false} onChange={e => setNewStorage({...newStorage, enabled: e.target.checked})} className="rounded" /> Enable
                                                            </label>
                                                            <label className="flex items-center gap-2 text-sm">
                                                                <input type="checkbox" checked={newStorage.comstar_tg || false} onChange={e => setNewStorage({...newStorage, comstar_tg: e.target.checked})} className="rounded" /> Use LUNs directly
                                                            </label>
                                                        </div>
                                                    </div>
                                                )}

                                                {/* LVM Fields */}
                                                {newStorage.type === 'lvm' && (
                                                    <div className="grid grid-cols-2 gap-4">
                                                        <div>
                                                            <label className="block text-sm text-gray-400 mb-1">Base storage (for Shared LVM)</label>
                                                            <select value={newStorage.baseStorage || ''} onChange={e => {
                                                                const baseStorage = e.target.value;
                                                                // NS: If base storage is selected, it becomes shared automatically
                                                                setNewStorage({...newStorage, baseStorage, base: '', shared: baseStorage ? true : newStorage.shared});
                                                                // Clear scan results when base changes
                                                                setScanResults([]);
                                                            }} className="w-full bg-proxmox-dark border border-proxmox-border rounded p-2 text-sm">
                                                                <option value="">Existing volume groups (local)</option>
                                                                {storage.filter(s => s.type === 'iscsi').map(s => <option key={s.storage} value={s.storage}>iSCSI: {s.storage}</option>)}
                                                            </select>
                                                        </div>
                                                        <div className="flex items-center gap-4">
                                                            <label className="flex items-center gap-2 text-sm">
                                                                <input type="checkbox" checked={newStorage.enabled !== false} onChange={e => setNewStorage({...newStorage, enabled: e.target.checked})} className="rounded" /> Enable
                                                            </label>
                                                        </div>
                                                        
                                                        {/* Shared LVM Info */}
                                                        {newStorage.baseStorage && (
                                                            <div className="col-span-2 p-3 bg-blue-900/30 border border-blue-500/50 rounded text-sm text-blue-300">
                                                                <strong>Shared LVM:</strong> Select a LUN from "{newStorage.baseStorage}" below. 
                                                                The volume group will be created on or use the selected LUN.
                                                                All cluster nodes must have access to the iSCSI target.
                                                            </div>
                                                        )}
                                                        
                                                        {/* LUN Selection for Shared LVM */}
                                                        {newStorage.baseStorage && (
                                                            <div className="col-span-2">
                                                                <label className="block text-sm text-gray-400 mb-1">Select LUN *</label>
                                                                <div className="flex gap-2">
                                                                    <select 
                                                                        value={newStorage.base || ''} 
                                                                        onChange={e => setNewStorage({...newStorage, base: e.target.value})}
                                                                        className="flex-1 bg-proxmox-dark border border-proxmox-border rounded p-2 text-sm font-mono"
                                                                    >
                                                                        <option value="">Select LUN...</option>
                                                                        {/* NS: volid from Proxmox already includes storage name like "iscsi-storage:0.0.0.1.lun-0" */}
                                                                        {scanResults.filter(l => l.volid).map((lun, i) => (
                                                                            <option key={i} value={lun.volid}>
                                                                                {lun.volid} {lun.size ? `(${(lun.size / 1024 / 1024 / 1024).toFixed(1)} GB)` : ''}
                                                                            </option>
                                                                        ))}
                                                                    </select>
                                                                    <button 
                                                                        onClick={async () => {
                                                                            // Fetch LUNs from iSCSI storage
                                                                            setScanning(true);
                                                                            try {
                                                                                const res = await authFetch(`${API_URL}/clusters/${clusterId}/datastores/${newStorage.baseStorage}/content`);
                                                                                if (res?.ok) {
                                                                                    const luns = await res.json();
                                                                                    console.log('LUNs from', newStorage.baseStorage, ':', luns);
                                                                                    setScanResults(luns || []);
                                                                                } else {
                                                                                    addToast('Failed to scan LUNs', 'error');
                                                                                }
                                                                            } catch (e) {
                                                                                console.error('Error fetching LUNs:', e);
                                                                                addToast('Error scanning LUNs', 'error');
                                                                            }
                                                                            setScanning(false);
                                                                        }}
                                                                        disabled={scanning}
                                                                        className="px-3 py-2 bg-blue-600 hover:bg-blue-700 disabled:opacity-50 rounded text-sm whitespace-nowrap"
                                                                    >
                                                                        {scanning ? '...' : 'Scan LUNs'}
                                                                    </button>
                                                                </div>
                                                                {scanResults.length === 0 && !scanning && (
                                                                    <p className="text-xs text-gray-500 mt-1">Click "Scan LUNs" to discover available LUNs</p>
                                                                )}
                                                                {newStorage.baseStorage && !newStorage.base && scanResults.length > 0 && (
                                                                    <p className="text-xs text-yellow-400 mt-1">‚ö†Ô∏è Select a LUN to continue</p>
                                                                )}
                                                            </div>
                                                        )}
                                                        
                                                        <div>
                                                            <label className="block text-sm text-gray-400 mb-1">Volume group name *</label>
                                                            <div className="flex gap-2">
                                                                {!newStorage.baseStorage && scanResults.length > 0 && newStorage.type === 'lvm' ? (
                                                                    <select 
                                                                        value={newStorage.vgname || ''} 
                                                                        onChange={e => setNewStorage({...newStorage, vgname: e.target.value})} 
                                                                        className="flex-1 bg-proxmox-dark border border-proxmox-border rounded p-2 text-sm"
                                                                    >
                                                                        <option value="">Select VG...</option>
                                                                        {scanResults.filter(r => r.vg).map((r, i) => (
                                                                            <option key={i} value={r.vg}>{r.vg} ({(r.size / 1024 / 1024 / 1024).toFixed(1)} GB)</option>
                                                                        ))}
                                                                    </select>
                                                                ) : (
                                                                    <input 
                                                                        value={newStorage.vgname || ''} 
                                                                        onChange={e => setNewStorage({...newStorage, vgname: e.target.value})} 
                                                                        placeholder={newStorage.baseStorage ? "shared-vg" : "pve"} 
                                                                        className="flex-1 bg-proxmox-dark border border-proxmox-border rounded p-2 text-sm" 
                                                                    />
                                                                )}
                                                                {!newStorage.baseStorage && (
                                                                    <button 
                                                                        onClick={() => scanStorage('lvm')} 
                                                                        disabled={scanning}
                                                                        className="px-3 py-2 bg-blue-600 hover:bg-blue-700 disabled:opacity-50 rounded text-sm whitespace-nowrap"
                                                                    >
                                                                        {scanning ? '...' : 'Scan'}
                                                                    </button>
                                                                )}
                                                            </div>
                                                            {newStorage.baseStorage && !newStorage.vgname && (
                                                                <p className="text-xs text-yellow-400 mt-1">‚ö†Ô∏è Enter a volume group name</p>
                                                            )}
                                                        </div>
                                                        <div className="flex items-center gap-4">
                                                            <label className="flex items-center gap-2 text-sm">
                                                                <input 
                                                                    type="checkbox" 
                                                                    checked={newStorage.shared || false} 
                                                                    onChange={e => setNewStorage({...newStorage, shared: e.target.checked})} 
                                                                    disabled={!!newStorage.baseStorage}
                                                                    className="rounded" 
                                                                /> Shared {newStorage.baseStorage && '(auto)'}
                                                            </label>
                                                        </div>
                                                        <div>
                                                            <label className="block text-sm text-gray-400 mb-1">Content</label>
                                                            <select value={newStorage.content || 'images,rootdir'} onChange={e => setNewStorage({...newStorage, content: e.target.value})} className="w-full bg-proxmox-dark border border-proxmox-border rounded p-2 text-sm">
                                                                <option value="images,rootdir">Disk image, Container</option>
                                                                <option value="images">Disk image</option>
                                                                <option value="rootdir">Container</option>
                                                            </select>
                                                        </div>
                                                        <div className="flex items-center gap-4">
                                                            <label className="flex items-center gap-2 text-sm" title="Wipe disk when deleting volumes (more secure, slower)">
                                                                <input type="checkbox" checked={newStorage.saferemove || false} onChange={e => setNewStorage({...newStorage, saferemove: e.target.checked})} className="rounded" /> Wipe on Delete
                                                            </label>
                                                        </div>
                                                        
                                                        {/* Snapshot as Volume Chain - PVE 9+ Feature for LVM */}
                                                        <div className="col-span-2 p-3 bg-proxmox-dark border border-proxmox-border rounded">
                                                            <label className="flex items-center gap-2 text-sm">
                                                                <input 
                                                                    type="checkbox" 
                                                                    checked={newStorage['snapshot-as-volume-chain'] || false} 
                                                                    onChange={e => setNewStorage({...newStorage, 'snapshot-as-volume-chain': e.target.checked})} 
                                                                    className="rounded" 
                                                                />
                                                                <span className="font-medium">Snapshot as Volume Chain</span>
                                                                <span className="text-xs px-1.5 py-0.5 bg-green-600/30 text-green-400 rounded">PVE 9+</span>
                                                            </label>
                                                            <p className="text-xs text-gray-500 mt-1 ml-6">
                                                                Uses separate volumes for snapshot data instead of internal LVM snapshots. 
                                                                This provides better performance and compatibility.
                                                            </p>
                                                        </div>
                                                    </div>
                                                )}

                                                {/* LVM-Thin Fields */}
                                                {newStorage.type === 'lvmthin' && (
                                                    <div className="grid grid-cols-2 gap-4">
                                                        <div>
                                                            <label className="block text-sm text-gray-400 mb-1">Volume group *</label>
                                                            <div className="flex gap-2">
                                                                {scanResults.length > 0 && newStorage.type === 'lvmthin' && !newStorage.vgname ? (
                                                                    <select 
                                                                        value={newStorage.vgname || ''} 
                                                                        onChange={e => setNewStorage({...newStorage, vgname: e.target.value})} 
                                                                        className="flex-1 bg-proxmox-dark border border-proxmox-border rounded p-2 text-sm"
                                                                    >
                                                                        <option value="">Select VG...</option>
                                                                        {scanResults.filter(r => r.vg).map((r, i) => (
                                                                            <option key={i} value={r.vg}>{r.vg}</option>
                                                                        ))}
                                                                    </select>
                                                                ) : (
                                                                    <input value={newStorage.vgname || ''} onChange={e => setNewStorage({...newStorage, vgname: e.target.value})} placeholder="pve" className="flex-1 bg-proxmox-dark border border-proxmox-border rounded p-2 text-sm" />
                                                                )}
                                                                <button 
                                                                    onClick={() => scanStorage('lvm')} 
                                                                    disabled={scanning}
                                                                    className="px-3 py-2 bg-blue-600 hover:bg-blue-700 disabled:opacity-50 rounded text-sm whitespace-nowrap"
                                                                >
                                                                    {scanning ? '...' : 'Scan VG'}
                                                                </button>
                                                            </div>
                                                        </div>
                                                        <div className="flex items-center gap-4">
                                                            <label className="flex items-center gap-2 text-sm">
                                                                <input type="checkbox" checked={newStorage.enabled !== false} onChange={e => setNewStorage({...newStorage, enabled: e.target.checked})} className="rounded" /> Enable
                                                            </label>
                                                        </div>
                                                        <div>
                                                            <label className="block text-sm text-gray-400 mb-1">Thin Pool *</label>
                                                            <div className="flex gap-2">
                                                                {scanResults.length > 0 && newStorage.vgname && scanResults.some(r => r.lv) ? (
                                                                    <select 
                                                                        value={newStorage.thinpool || ''} 
                                                                        onChange={e => setNewStorage({...newStorage, thinpool: e.target.value})} 
                                                                        className="flex-1 bg-proxmox-dark border border-proxmox-border rounded p-2 text-sm"
                                                                    >
                                                                        <option value="">Select pool...</option>
                                                                        {scanResults.filter(r => r.lv).map((r, i) => (
                                                                            <option key={i} value={r.lv}>{r.lv} ({(r.size / 1024 / 1024 / 1024).toFixed(1)} GB, {r.used_percent}% used)</option>
                                                                        ))}
                                                                    </select>
                                                                ) : (
                                                                    <input value={newStorage.thinpool || ''} onChange={e => setNewStorage({...newStorage, thinpool: e.target.value})} placeholder="data" className="flex-1 bg-proxmox-dark border border-proxmox-border rounded p-2 text-sm" />
                                                                )}
                                                                {newStorage.vgname && (
                                                                    <button 
                                                                        onClick={() => scanStorage('lvmthin')} 
                                                                        disabled={scanning || !newStorage.vgname}
                                                                        className="px-3 py-2 bg-blue-600 hover:bg-blue-700 disabled:opacity-50 rounded text-sm whitespace-nowrap"
                                                                    >
                                                                        {scanning ? '...' : 'Scan'}
                                                                    </button>
                                                                )}
                                                            </div>
                                                        </div>
                                                        <div></div>
                                                        <div>
                                                            <label className="block text-sm text-gray-400 mb-1">Content</label>
                                                            <select value={newStorage.content || 'images,rootdir'} onChange={e => setNewStorage({...newStorage, content: e.target.value})} className="w-full bg-proxmox-dark border border-proxmox-border rounded p-2 text-sm">
                                                                <option value="images,rootdir">Disk image, Container</option>
                                                                <option value="images">Disk image</option>
                                                                <option value="rootdir">Container</option>
                                                            </select>
                                                        </div>
                                                        <div></div>
                                                        
                                                        {/* Snapshot as Volume Chain - PVE 9+ Feature */}
                                                        <div className="col-span-2 p-3 bg-proxmox-dark border border-proxmox-border rounded">
                                                            <label className="flex items-center gap-2 text-sm">
                                                                <input 
                                                                    type="checkbox" 
                                                                    checked={newStorage['snapshot-as-volume-chain'] || false} 
                                                                    onChange={e => setNewStorage({...newStorage, 'snapshot-as-volume-chain': e.target.checked})} 
                                                                    className="rounded" 
                                                                />
                                                                <span className="font-medium">Snapshot as Volume Chain</span>
                                                                <span className="text-xs px-1.5 py-0.5 bg-green-600/30 text-green-400 rounded">PVE 9+</span>
                                                            </label>
                                                            <p className="text-xs text-gray-500 mt-1 ml-6">
                                                                Uses separate volumes for snapshot data instead of internal snapshots. 
                                                                Improves performance and allows online snapshots for LVM-thin.
                                                            </p>
                                                        </div>
                                                        
                                                        {/* LVM-thin cannot be shared warning */}
                                                        <div className="col-span-2 p-2 bg-yellow-900/30 border border-yellow-500/50 rounded text-xs text-yellow-300">
                                                            ‚ö†Ô∏è LVM-thin storage cannot be shared between cluster nodes. For shared block storage, use regular LVM on iSCSI or Ceph RBD.
                                                        </div>
                                                    </div>
                                                )}

                                                {/* BTRFS Fields */}
                                                {newStorage.type === 'btrfs' && (
                                                    <div className="grid grid-cols-2 gap-4">
                                                        <div>
                                                            <label className="block text-sm text-gray-400 mb-1">Path *</label>
                                                            <input value={newStorage.path || ''} onChange={e => setNewStorage({...newStorage, path: e.target.value})} placeholder="/mnt/btrfs" className="w-full bg-proxmox-dark border border-proxmox-border rounded p-2 text-sm font-mono" />
                                                        </div>
                                                        <div className="flex items-center gap-4">
                                                            <label className="flex items-center gap-2 text-sm">
                                                                <input type="checkbox" checked={newStorage.enabled !== false} onChange={e => setNewStorage({...newStorage, enabled: e.target.checked})} className="rounded" /> Enable
                                                            </label>
                                                        </div>
                                                        <div>
                                                            <label className="block text-sm text-gray-400 mb-1">Content</label>
                                                            <select value={newStorage.content || 'images,rootdir'} onChange={e => setNewStorage({...newStorage, content: e.target.value})} className="w-full bg-proxmox-dark border border-proxmox-border rounded p-2 text-sm">
                                                                <option value="images,rootdir">Disk image, Container</option>
                                                                <option value="images">Disk image</option>
                                                                <option value="rootdir">Container</option>
                                                            </select>
                                                        </div>
                                                        <div></div>
                                                        <div className="col-span-2 p-3 bg-blue-900/30 border border-blue-500/50 rounded text-sm text-blue-300">
                                                            BTRFS integration is currently a technology preview.
                                                        </div>
                                                        <div>
                                                            <label className="block text-sm text-gray-400 mb-1">Preallocation</label>
                                                            <select value={newStorage.preallocation || ''} onChange={e => setNewStorage({...newStorage, preallocation: e.target.value})} className="w-full bg-proxmox-dark border border-proxmox-border rounded p-2 text-sm">
                                                                <option value="">Default</option>
                                                                <option value="off">Off</option>
                                                                <option value="metadata">Metadata</option>
                                                                <option value="falloc">Falloc</option>
                                                                <option value="full">Full</option>
                                                            </select>
                                                        </div>
                                                    </div>
                                                )}

                                                {/* NFS Fields */}
                                                {newStorage.type === 'nfs' && (
                                                    <div className="grid grid-cols-2 gap-4">
                                                        <div>
                                                            <label className="block text-sm text-gray-400 mb-1">Server *</label>
                                                            <div className="flex gap-2">
                                                                <input value={newStorage.server || ''} onChange={e => setNewStorage({...newStorage, server: e.target.value})} placeholder="192.168.1.100" className="flex-1 bg-proxmox-dark border border-proxmox-border rounded p-2 text-sm font-mono" />
                                                                <button 
                                                                    onClick={() => scanStorage('nfs')} 
                                                                    disabled={!newStorage.server || scanning}
                                                                    className="px-3 py-2 bg-blue-600 hover:bg-blue-700 disabled:opacity-50 rounded text-sm whitespace-nowrap"
                                                                >
                                                                    {scanning ? '...' : 'Scan'}
                                                                </button>
                                                            </div>
                                                        </div>
                                                        <div className="flex items-center gap-4">
                                                            <label className="flex items-center gap-2 text-sm">
                                                                <input type="checkbox" checked={newStorage.enabled !== false} onChange={e => setNewStorage({...newStorage, enabled: e.target.checked})} className="rounded" /> Enable
                                                            </label>
                                                        </div>
                                                        <div>
                                                            <label className="block text-sm text-gray-400 mb-1">Export *</label>
                                                            {scanResults.length > 0 && newStorage.type === 'nfs' ? (
                                                                <select 
                                                                    value={newStorage.export || ''} 
                                                                    onChange={e => setNewStorage({...newStorage, export: e.target.value})} 
                                                                    className="w-full bg-proxmox-dark border border-proxmox-border rounded p-2 text-sm font-mono"
                                                                >
                                                                    <option value="">Select export...</option>
                                                                    {scanResults.map((r, i) => (
                                                                        <option key={i} value={r.path}>{r.path} {r.options ? `(${r.options})` : ''}</option>
                                                                    ))}
                                                                </select>
                                                            ) : (
                                                                <input value={newStorage.export || ''} onChange={e => setNewStorage({...newStorage, export: e.target.value})} placeholder="/export/share" className="w-full bg-proxmox-dark border border-proxmox-border rounded p-2 text-sm font-mono" />
                                                            )}
                                                        </div>
                                                        <div></div>
                                                        <div>
                                                            <label className="block text-sm text-gray-400 mb-1">Content</label>
                                                            <select value={newStorage.content || 'images'} onChange={e => setNewStorage({...newStorage, content: e.target.value})} className="w-full bg-proxmox-dark border border-proxmox-border rounded p-2 text-sm">
                                                                <option value="images">Disk image</option>
                                                                <option value="images,rootdir">Disk image, Container</option>
                                                                <option value="backup">Backup</option>
                                                                <option value="iso">ISO image</option>
                                                                <option value="vztmpl">Container template</option>
                                                                <option value="snippets">Snippets</option>
                                                            </select>
                                                        </div>
                                                        <div>
                                                            <label className="block text-sm text-gray-400 mb-1">NFS Version</label>
                                                            <select value={newStorage.options || ''} onChange={e => setNewStorage({...newStorage, options: e.target.value})} className="w-full bg-proxmox-dark border border-proxmox-border rounded p-2 text-sm">
                                                                <option value="">Default</option>
                                                                <option value="vers=3">NFSv3</option>
                                                                <option value="vers=4">NFSv4</option>
                                                                <option value="vers=4.1">NFSv4.1</option>
                                                                <option value="vers=4.2">NFSv4.2</option>
                                                            </select>
                                                        </div>
                                                        <div className="col-span-2 p-3 bg-proxmox-dark border border-proxmox-border rounded">
                                                            <label className="flex items-center gap-2 text-sm">
                                                                <input 
                                                                    type="checkbox" 
                                                                    checked={newStorage['snapshot-as-volume-chain'] || false} 
                                                                    onChange={e => setNewStorage({...newStorage, 'snapshot-as-volume-chain': e.target.checked})} 
                                                                    className="rounded" 
                                                                />
                                                                <span className="font-medium">Snapshot as Volume Chain</span>
                                                                <span className="text-xs px-1.5 py-0.5 bg-green-600/30 text-green-400 rounded">PVE 9+</span>
                                                            </label>
                                                            <p className="text-xs text-gray-500 mt-1 ml-6">
                                                                Uses separate qcow2 files for snapshot data instead of internal qcow2 snapshots.
                                                            </p>
                                                        </div>
                                                        <div>
                                                            <label className="block text-sm text-gray-400 mb-1">Preallocation</label>
                                                            <select value={newStorage.preallocation || ''} onChange={e => setNewStorage({...newStorage, preallocation: e.target.value})} className="w-full bg-proxmox-dark border border-proxmox-border rounded p-2 text-sm">
                                                                <option value="">Default</option>
                                                                <option value="off">Off</option>
                                                                <option value="metadata">Metadata</option>
                                                                <option value="falloc">Falloc</option>
                                                                <option value="full">Full</option>
                                                            </select>
                                                        </div>
                                                    </div>
                                                )}

                                                {/* SMB/CIFS Fields */}
                                                {newStorage.type === 'cifs' && (
                                                    <div className="grid grid-cols-2 gap-4">
                                                        <div>
                                                            <label className="block text-sm text-gray-400 mb-1">Server *</label>
                                                            <input value={newStorage.server || ''} onChange={e => setNewStorage({...newStorage, server: e.target.value})} placeholder="192.168.1.100" className="w-full bg-proxmox-dark border border-proxmox-border rounded p-2 text-sm font-mono" />
                                                        </div>
                                                        <div className="flex items-center gap-4">
                                                            <label className="flex items-center gap-2 text-sm">
                                                                <input type="checkbox" checked={newStorage.enabled !== false} onChange={e => setNewStorage({...newStorage, enabled: e.target.checked})} className="rounded" /> Enable
                                                            </label>
                                                        </div>
                                                        <div>
                                                            <label className="block text-sm text-gray-400 mb-1">Username</label>
                                                            <input value={newStorage.username || ''} onChange={e => setNewStorage({...newStorage, username: e.target.value})} placeholder="Guest user" className="w-full bg-proxmox-dark border border-proxmox-border rounded p-2 text-sm" />
                                                        </div>
                                                        <div>
                                                            <label className="block text-sm text-gray-400 mb-1">Content</label>
                                                            <select value={newStorage.content || 'images'} onChange={e => setNewStorage({...newStorage, content: e.target.value})} className="w-full bg-proxmox-dark border border-proxmox-border rounded p-2 text-sm">
                                                                <option value="images">Disk image</option>
                                                                <option value="images,rootdir">Disk image, Container</option>
                                                                <option value="backup">Backup</option>
                                                                <option value="iso">ISO image</option>
                                                            </select>
                                                        </div>
                                                        <div>
                                                            <label className="block text-sm text-gray-400 mb-1">Password</label>
                                                            <input type="password" value={newStorage.password || ''} onChange={e => setNewStorage({...newStorage, password: e.target.value})} className="w-full bg-proxmox-dark border border-proxmox-border rounded p-2 text-sm" />
                                                        </div>
                                                        <div>
                                                            <label className="block text-sm text-gray-400 mb-1">Domain</label>
                                                            <input value={newStorage.domain || ''} onChange={e => setNewStorage({...newStorage, domain: e.target.value})} className="w-full bg-proxmox-dark border border-proxmox-border rounded p-2 text-sm" />
                                                        </div>
                                                        <div>
                                                            <label className="block text-sm text-gray-400 mb-1">Share *</label>
                                                            <input value={newStorage.share || ''} onChange={e => setNewStorage({...newStorage, share: e.target.value})} placeholder="share-name" className="w-full bg-proxmox-dark border border-proxmox-border rounded p-2 text-sm" />
                                                        </div>
                                                        <div>
                                                            <label className="block text-sm text-gray-400 mb-1">Subdirectory</label>
                                                            <input value={newStorage.subdir || ''} onChange={e => setNewStorage({...newStorage, subdir: e.target.value})} placeholder="/some/path" className="w-full bg-proxmox-dark border border-proxmox-border rounded p-2 text-sm font-mono" />
                                                        </div>
                                                        <div>
                                                            <label className="block text-sm text-gray-400 mb-1">Preallocation</label>
                                                            <select value={newStorage.preallocation || ''} onChange={e => setNewStorage({...newStorage, preallocation: e.target.value})} className="w-full bg-proxmox-dark border border-proxmox-border rounded p-2 text-sm">
                                                                <option value="">Default</option>
                                                                <option value="off">Off</option>
                                                                <option value="metadata">Metadata</option>
                                                                <option value="full">Full</option>
                                                            </select>
                                                        </div>
                                                        <div className="col-span-2 p-3 bg-proxmox-dark border border-proxmox-border rounded">
                                                            <label className="flex items-center gap-2 text-sm">
                                                                <input 
                                                                    type="checkbox" 
                                                                    checked={newStorage['snapshot-as-volume-chain'] || false} 
                                                                    onChange={e => setNewStorage({...newStorage, 'snapshot-as-volume-chain': e.target.checked})} 
                                                                    className="rounded" 
                                                                />
                                                                <span className="font-medium">Snapshot as Volume Chain</span>
                                                                <span className="text-xs px-1.5 py-0.5 bg-green-600/30 text-green-400 rounded">PVE 9+</span>
                                                            </label>
                                                            <p className="text-xs text-gray-500 mt-1 ml-6">
                                                                Uses separate qcow2 files for snapshot data instead of internal qcow2 snapshots.
                                                            </p>
                                                        </div>
                                                    </div>
                                                )}

                                                {/* Directory Fields */}
                                                {newStorage.type === 'dir' && (
                                                    <div className="grid grid-cols-2 gap-4">
                                                        <div>
                                                            <label className="block text-sm text-gray-400 mb-1">Directory *</label>
                                                            <input value={newStorage.path || ''} onChange={e => setNewStorage({...newStorage, path: e.target.value})} placeholder="/mnt/storage" className="w-full bg-proxmox-dark border border-proxmox-border rounded p-2 text-sm font-mono" />
                                                        </div>
                                                        <div className="flex items-center gap-4">
                                                            <label className="flex items-center gap-2 text-sm">
                                                                <input type="checkbox" checked={newStorage.enabled !== false} onChange={e => setNewStorage({...newStorage, enabled: e.target.checked})} className="rounded" /> Enable
                                                            </label>
                                                            <label className="flex items-center gap-2 text-sm">
                                                                <input type="checkbox" checked={newStorage.shared || false} onChange={e => setNewStorage({...newStorage, shared: e.target.checked})} className="rounded" /> Shared
                                                            </label>
                                                        </div>
                                                        <div>
                                                            <label className="block text-sm text-gray-400 mb-1">Content</label>
                                                            <select value={newStorage.content || 'images,rootdir,vztmpl,backup,iso,snippets'} onChange={e => setNewStorage({...newStorage, content: e.target.value})} className="w-full bg-proxmox-dark border border-proxmox-border rounded p-2 text-sm">
                                                                <option value="images,rootdir,vztmpl,backup,iso,snippets">All</option>
                                                                <option value="images,rootdir">Disk image, Container</option>
                                                                <option value="backup">Backup</option>
                                                                <option value="iso">ISO image</option>
                                                                <option value="vztmpl">Container template</option>
                                                            </select>
                                                        </div>
                                                        <div></div>
                                                        <div className="col-span-2 p-3 bg-proxmox-dark border border-proxmox-border rounded">
                                                            <label className="flex items-center gap-2 text-sm">
                                                                <input 
                                                                    type="checkbox" 
                                                                    checked={newStorage['snapshot-as-volume-chain'] || false} 
                                                                    onChange={e => setNewStorage({...newStorage, 'snapshot-as-volume-chain': e.target.checked})} 
                                                                    className="rounded" 
                                                                />
                                                                <span className="font-medium">Snapshot as Volume Chain</span>
                                                                <span className="text-xs px-1.5 py-0.5 bg-green-600/30 text-green-400 rounded">PVE 9+</span>
                                                            </label>
                                                            <p className="text-xs text-gray-500 mt-1 ml-6">
                                                                Uses separate qcow2 files for snapshot data instead of internal qcow2 snapshots.
                                                            </p>
                                                        </div>
                                                    </div>
                                                )}

                                                {/* PBS Fields */}
                                                {newStorage.type === 'pbs' && (
                                                    <div className="grid grid-cols-2 gap-4">
                                                        <div>
                                                            <label className="block text-sm text-gray-400 mb-1">Server *</label>
                                                            <input value={newStorage.server || ''} onChange={e => setNewStorage({...newStorage, server: e.target.value})} placeholder="pbs.example.com" className="w-full bg-proxmox-dark border border-proxmox-border rounded p-2 text-sm" />
                                                        </div>
                                                        <div className="flex items-center gap-4">
                                                            <label className="flex items-center gap-2 text-sm">
                                                                <input type="checkbox" checked={newStorage.enabled !== false} onChange={e => setNewStorage({...newStorage, enabled: e.target.checked})} className="rounded" /> Enable
                                                            </label>
                                                        </div>
                                                        <div>
                                                            <label className="block text-sm text-gray-400 mb-1">Username *</label>
                                                            <input value={newStorage.username || ''} onChange={e => setNewStorage({...newStorage, username: e.target.value})} placeholder="user@pbs" className="w-full bg-proxmox-dark border border-proxmox-border rounded p-2 text-sm" />
                                                        </div>
                                                        <div>
                                                            <label className="block text-sm text-gray-400 mb-1">Password *</label>
                                                            <input type="password" value={newStorage.password || ''} onChange={e => setNewStorage({...newStorage, password: e.target.value})} className="w-full bg-proxmox-dark border border-proxmox-border rounded p-2 text-sm" />
                                                        </div>
                                                        <div>
                                                            <label className="block text-sm text-gray-400 mb-1">Datastore *</label>
                                                            <input value={newStorage.datastore || ''} onChange={e => setNewStorage({...newStorage, datastore: e.target.value})} placeholder="store1" className="w-full bg-proxmox-dark border border-proxmox-border rounded p-2 text-sm" />
                                                        </div>
                                                        <div>
                                                            <label className="block text-sm text-gray-400 mb-1">Fingerprint</label>
                                                            <input value={newStorage.fingerprint || ''} onChange={e => setNewStorage({...newStorage, fingerprint: e.target.value})} placeholder="optional" className="w-full bg-proxmox-dark border border-proxmox-border rounded p-2 text-sm font-mono text-xs" />
                                                        </div>
                                                    </div>
                                                )}

                                                {/* ZFS Pool Fields */}
                                                {newStorage.type === 'zfspool' && (
                                                    <div className="grid grid-cols-2 gap-4">
                                                        <div>
                                                            <label className="block text-sm text-gray-400 mb-1">Pool *</label>
                                                            <input value={newStorage.pool || ''} onChange={e => setNewStorage({...newStorage, pool: e.target.value})} placeholder="rpool/data" className="w-full bg-proxmox-dark border border-proxmox-border rounded p-2 text-sm font-mono" />
                                                        </div>
                                                        <div className="flex items-center gap-4">
                                                            <label className="flex items-center gap-2 text-sm">
                                                                <input type="checkbox" checked={newStorage.enabled !== false} onChange={e => setNewStorage({...newStorage, enabled: e.target.checked})} className="rounded" /> Enable
                                                            </label>
                                                        </div>
                                                        <div>
                                                            <label className="block text-sm text-gray-400 mb-1">Content</label>
                                                            <select value={newStorage.content || 'images,rootdir'} onChange={e => setNewStorage({...newStorage, content: e.target.value})} className="w-full bg-proxmox-dark border border-proxmox-border rounded p-2 text-sm">
                                                                <option value="images,rootdir">Disk image, Container</option>
                                                                <option value="images">Disk image</option>
                                                                <option value="rootdir">Container</option>
                                                            </select>
                                                        </div>
                                                    </div>
                                                )}

                                                {/* ESXi Fields */}
                                                {newStorage.type === 'esxi' && (
                                                    <div className="grid grid-cols-2 gap-4">
                                                        <div>
                                                            <label className="block text-sm text-gray-400 mb-1">Server *</label>
                                                            <input value={newStorage.server || ''} onChange={e => setNewStorage({...newStorage, server: e.target.value})} placeholder="IP address or hostname" className="w-full bg-proxmox-dark border border-proxmox-border rounded p-2 text-sm font-mono" />
                                                        </div>
                                                        <div className="flex items-center gap-4">
                                                            <label className="flex items-center gap-2 text-sm">
                                                                <input type="checkbox" checked={newStorage.enabled !== false} onChange={e => setNewStorage({...newStorage, enabled: e.target.checked})} className="rounded" /> Enable
                                                            </label>
                                                        </div>
                                                        <div>
                                                            <label className="block text-sm text-gray-400 mb-1">Username *</label>
                                                            <input value={newStorage.username || ''} onChange={e => setNewStorage({...newStorage, username: e.target.value})} placeholder="root" className="w-full bg-proxmox-dark border border-proxmox-border rounded p-2 text-sm" />
                                                        </div>
                                                        <div className="flex items-center gap-4">
                                                            <label className="flex items-center gap-2 text-sm">
                                                                <input type="checkbox" checked={newStorage.skip_cert_verification || false} onChange={e => setNewStorage({...newStorage, skip_cert_verification: e.target.checked})} className="rounded" /> Skip Certificate Verification
                                                            </label>
                                                        </div>
                                                        <div>
                                                            <label className="block text-sm text-gray-400 mb-1">Password *</label>
                                                            <input type="password" value={newStorage.password || ''} onChange={e => setNewStorage({...newStorage, password: e.target.value})} className="w-full bg-proxmox-dark border border-proxmox-border rounded p-2 text-sm" />
                                                        </div>
                                                    </div>
                                                )}
                                            </div>

                                            <div className="flex justify-end gap-3 p-4 border-t border-proxmox-border sticky bottom-0 bg-proxmox-card">
                                                <button 
                                                    onClick={() => {
                                                        setShowAddStorage(false);
                                                        setNewStorage({ type: 'dir', storage: '', path: '', content: 'images,rootdir', enabled: true });
                                                    }} 
                                                    className="px-4 py-2 bg-proxmox-dark hover:bg-proxmox-hover rounded-lg text-sm transition-colors"
                                                >
                                                    {t('cancel')}
                                                </button>
                                                <button 
                                                    onClick={createStorage} 
                                                    disabled={!newStorage.storage}
                                                    className="px-4 py-2 bg-proxmox-orange hover:bg-orange-600 disabled:opacity-50 disabled:cursor-not-allowed rounded-lg text-sm text-white transition-colors"
                                                >
                                                    {newStorage.storage && storage.some(s => s.storage === newStorage.storage) ? t('save') : t('add')}
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}

                        {/* Backup */}
                        {activeSection === 'backup' && (
                            <div className="space-y-4">
                                <div className="bg-proxmox-card border border-proxmox-border rounded-xl overflow-hidden">
                                    <div className="p-4 border-b border-proxmox-border flex justify-between items-center">
                                        <h3 className="font-semibold">{t('backupJobs')}</h3>
                                        <button 
                                            onClick={() => setShowAddBackupJob(true)}
                                            className="flex items-center gap-2 px-3 py-1.5 bg-proxmox-orange hover:bg-orange-600 rounded-lg text-sm"
                                        >
                                            <Icons.Plus /> {t('add')}
                                        </button>
                                    </div>
                                    <table className="w-full">
                                        <thead className="bg-proxmox-dark">
                                            <tr>
                                                <th className="text-left p-3 text-sm text-gray-400">{t('enabled')}</th>
                                                <th className="text-left p-3 text-sm text-gray-400">Node</th>
                                                <th className="text-left p-3 text-sm text-gray-400">{t('schedule')}</th>
                                                <th className="text-left p-3 text-sm text-gray-400">Storage</th>
                                                <th className="text-left p-3 text-sm text-gray-400">Mode</th>
                                                <th className="text-left p-3 text-sm text-gray-400">VMs</th>
                                                <th className="text-left p-3 text-sm text-gray-400"></th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {backupJobs.length === 0 ? (
                                                <tr><td colSpan="7" className="p-8 text-center text-gray-500">{t('noBackupJobs')}</td></tr>
                                            ) : backupJobs.map((job, idx) => (
                                                <tr key={job.id || idx} className="border-t border-proxmox-border hover:bg-proxmox-dark/50">
                                                    <td className="p-3">{job.enabled !== 0 ? <span className="text-green-400">‚úì</span> : <span className="text-gray-500">‚úó</span>}</td>
                                                    <td className="p-3">{job.node || t('all')}</td>
                                                    <td className="p-3 font-mono text-sm">{job.schedule || '-'}</td>
                                                    <td className="p-3">{job.storage || '-'}</td>
                                                    <td className="p-3">
                                                        <span className={`px-2 py-0.5 rounded text-xs ${
                                                            job.mode === 'snapshot' ? 'bg-green-500/20 text-green-400' :
                                                            job.mode === 'suspend' ? 'bg-yellow-500/20 text-yellow-400' :
                                                            'bg-blue-500/20 text-blue-400'
                                                        }`}>
                                                            {job.mode || 'snapshot'}
                                                        </span>
                                                    </td>
                                                    <td className="p-3 text-sm">{job.vmid || t('all')}</td>
                                                    <td className="p-3">
                                                        <button onClick={() => deleteBackupJob(job.id)} className="p-1 hover:bg-red-500/20 rounded text-red-400"><Icons.Trash /></button>
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>

                                {/* Add Backup Job Modal */}
                                {showAddBackupJob && (
                                    <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/70" onClick={() => setShowAddBackupJob(false)}>
                                        <div className="w-full max-w-2xl bg-proxmox-card border border-proxmox-border rounded-xl overflow-hidden" onClick={e => e.stopPropagation()}>
                                            <div className="p-4 border-b border-proxmox-border bg-proxmox-dark">
                                                <h3 className="font-semibold text-white flex items-center gap-2">
                                                    <Icons.Clock />
                                                    {t('createBackupJob') || 'Create Backup Job'}
                                                </h3>
                                            </div>
                                            <div className="p-6 space-y-4">
                                                <div className="grid grid-cols-2 gap-4">
                                                    <div>
                                                        <label className="block text-sm text-gray-400 mb-1">Storage *</label>
                                                        <select
                                                            value={newBackupJob.storage}
                                                            onChange={e => setNewBackupJob({...newBackupJob, storage: e.target.value})}
                                                            className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white"
                                                        >
                                                            <option value="">{t('selectStorage') || 'Select Storage'}</option>
                                                            {(storage || []).filter(s => s.content?.includes('backup')).map(s => (
                                                                <option key={s.storage} value={s.storage}>{s.storage}</option>
                                                            ))}
                                                        </select>
                                                    </div>
                                                    <div>
                                                        <label className="block text-sm text-gray-400 mb-1">{t('schedule')}</label>
                                                        <select
                                                            value={['hourly', 'daily', 'weekly', 'monthly'].includes(newBackupJob.schedule) ? newBackupJob.schedule : 'custom'}
                                                            onChange={e => {
                                                                if(e.target.value === 'custom') {
                                                                    setNewBackupJob({...newBackupJob, schedule: '02:00'});
                                                                } else {
                                                                    setNewBackupJob({...newBackupJob, schedule: e.target.value});
                                                                }
                                                            }}
                                                            className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white"
                                                        >
                                                            <option value="hourly">{t('hourly') || 'Hourly'}</option>
                                                            <option value="daily">{t('daily') || 'Daily'} (02:00)</option>
                                                            <option value="weekly">{t('weekly') || 'Weekly'} (Sun 02:00)</option>
                                                            <option value="monthly">{t('monthly') || 'Monthly'} (1st 02:00)</option>
                                                            <option value="custom">{t('custom') || 'Custom'}</option>
                                                        </select>
                                                        {!['hourly', 'daily', 'weekly', 'monthly'].includes(newBackupJob.schedule) && (
                                                            <input
                                                                type="text"
                                                                value={newBackupJob.schedule}
                                                                onChange={e => setNewBackupJob({...newBackupJob, schedule: e.target.value})}
                                                                placeholder="e.g. 02:00, sat 03:00, *-*-01 04:00"
                                                                className="w-full mt-2 px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white text-sm"
                                                            />
                                                        )}
                                                    </div>
                                                </div>
                                                <div className="grid grid-cols-2 gap-4">
                                                    <div>
                                                        <label className="block text-sm text-gray-400 mb-1">Node</label>
                                                        <select
                                                            value={newBackupJob.node}
                                                            onChange={e => setNewBackupJob({...newBackupJob, node: e.target.value})}
                                                            className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white"
                                                        >
                                                            <option value="">{t('allNodes') || 'All Nodes'}</option>
                                                            {(clusterNodes || []).map(n => (
                                                                <option key={n.node} value={n.node}>{n.node}</option>
                                                            ))}
                                                        </select>
                                                    </div>
                                                    <div>
                                                        <label className="block text-sm text-gray-400 mb-1">Mode</label>
                                                        <select
                                                            value={newBackupJob.mode}
                                                            onChange={e => setNewBackupJob({...newBackupJob, mode: e.target.value})}
                                                            className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white"
                                                        >
                                                            <option value="snapshot">Snapshot</option>
                                                            <option value="suspend">Suspend</option>
                                                            <option value="stop">Stop</option>
                                                        </select>
                                                    </div>
                                                </div>
                                                <div className="grid grid-cols-2 gap-4">
                                                    <div>
                                                        <label className="block text-sm text-gray-400 mb-1">{t('compression') || 'Compression'}</label>
                                                        <select
                                                            value={newBackupJob.compress}
                                                            onChange={e => setNewBackupJob({...newBackupJob, compress: e.target.value})}
                                                            className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white"
                                                        >
                                                            <option value="0">None</option>
                                                            <option value="gzip">GZIP</option>
                                                            <option value="lzo">LZO</option>
                                                            <option value="zstd">ZSTD (recommended)</option>
                                                        </select>
                                                    </div>
                                                    <div>
                                                        <label className="block text-sm text-gray-400 mb-1">VM IDs ({t('optional')})</label>
                                                        <input
                                                            type="text"
                                                            value={newBackupJob.vmid}
                                                            onChange={e => setNewBackupJob({...newBackupJob, vmid: e.target.value})}
                                                            placeholder="100,101,102 or empty for all"
                                                            className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white"
                                                        />
                                                    </div>
                                                </div>
                                                <div className="grid grid-cols-2 gap-4">
                                                    <div>
                                                        <label className="block text-sm text-gray-400 mb-1">{t('notification') || 'Notification'}</label>
                                                        <select
                                                            value={newBackupJob.mailnotification}
                                                            onChange={e => setNewBackupJob({...newBackupJob, mailnotification: e.target.value})}
                                                            className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white"
                                                        >
                                                            <option value="always">{t('always') || 'Always'}</option>
                                                            <option value="failure">{t('onFailure') || 'On Failure'}</option>
                                                            <option value="never">{t('never') || 'Never'}</option>
                                                        </select>
                                                    </div>
                                                    <div>
                                                        <label className="block text-sm text-gray-400 mb-1">Email ({t('optional')})</label>
                                                        <input
                                                            type="email"
                                                            value={newBackupJob.mailto}
                                                            onChange={e => setNewBackupJob({...newBackupJob, mailto: e.target.value})}
                                                            placeholder="admin@example.com"
                                                            className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white"
                                                        />
                                                    </div>
                                                </div>
                                                <div className="flex items-center gap-2">
                                                    <input
                                                        type="checkbox"
                                                        checked={newBackupJob.enabled === 1}
                                                        onChange={e => setNewBackupJob({...newBackupJob, enabled: e.target.checked ? 1 : 0})}
                                                        className="rounded"
                                                    />
                                                    <label className="text-sm text-gray-300">{t('enabled')}</label>
                                                </div>
                                            </div>
                                            <div className="p-4 border-t border-proxmox-border bg-proxmox-dark flex justify-end gap-3">
                                                <button
                                                    onClick={() => setShowAddBackupJob(false)}
                                                    className="px-4 py-2 text-gray-400 hover:text-white"
                                                >
                                                    {t('cancel')}
                                                </button>
                                                <button
                                                    onClick={createBackupJob}
                                                    disabled={!newBackupJob.storage}
                                                    className="px-4 py-2 bg-proxmox-orange hover:bg-orange-600 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed"
                                                >
                                                    {t('create')}
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}

                        {/* Replication */}
                        {activeSection === 'replication' && (
                            <div className="bg-proxmox-card border border-proxmox-border rounded-xl overflow-hidden">
                                <div className="p-4 border-b border-proxmox-border">
                                    <h3 className="font-semibold">Replication Jobs</h3>
                                </div>
                                <table className="w-full">
                                    <thead className="bg-proxmox-dark">
                                        <tr>
                                            <th className="text-left p-3 text-sm text-gray-400">Enabled</th>
                                            <th className="text-left p-3 text-sm text-gray-400">Guest</th>
                                            <th className="text-left p-3 text-sm text-gray-400">Job</th>
                                            <th className="text-left p-3 text-sm text-gray-400">Target</th>
                                            <th className="text-left p-3 text-sm text-gray-400">Schedule</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {replicationJobs.length === 0 ? (
                                            <tr><td colSpan="5" className="p-8 text-center text-gray-500">{t('noReplicationJobs') || 'No Replication Jobs'}</td></tr>
                                        ) : replicationJobs.map((job, idx) => (
                                            <tr key={idx} className="border-t border-proxmox-border hover:bg-proxmox-dark/50">
                                                <td className="p-3">{job.disable ? <span className="text-gray-500">‚úó</span> : <span className="text-green-400">‚úì</span>}</td>
                                                <td className="p-3">{job.guest}</td>
                                                <td className="p-3">{job.jobnum}</td>
                                                <td className="p-3">{job.target}</td>
                                                <td className="p-3 font-mono text-sm">{job.schedule}</td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        )}

                        {/* CPU Compatibility Mode (similar to VMware EVC) */}
                        {activeSection === 'cpucompat' && (
                            <div className="space-y-6">
                                {/* Auto-detected recommendation */}
                                {recommendedCpu && cpuInfo.length > 0 && (
                                    <div className="bg-gradient-to-r from-purple-500/20 to-blue-500/20 border border-purple-500/30 rounded-xl p-6">
                                        <div className="flex items-center gap-4">
                                            <div className="p-4 bg-purple-500/20 rounded-xl">
                                                <Icons.Cpu className="w-8 h-8 text-purple-400" />
                                            </div>
                                            <div className="flex-1">
                                                <h3 className="text-lg font-semibold text-white mb-1">{t('autoDetectedRecommendation') || 'Auto-Detected Recommendation'}</h3>
                                                <p className="text-sm text-gray-300 mb-3">
                                                    {t('basedOnClusterCpus') || 'Based on the CPUs detected in your cluster, we recommend:'}
                                                </p>
                                                <div className="flex items-center gap-3">
                                                    <code className="text-xl font-bold text-purple-400 bg-proxmox-dark px-4 py-2 rounded-lg">
                                                        cpu: {recommendedCpu}
                                                    </code>
                                                    <button
                                                        onClick={() => {
                                                            navigator.clipboard.writeText(`cpu: ${recommendedCpu}`);
                                                        }}
                                                        className="px-3 py-2 bg-purple-500/20 hover:bg-purple-500/30 text-purple-400 rounded-lg text-sm transition-colors"
                                                    >
                                                        {t('copy') || 'Copy'}
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                )}

                                <div className="bg-proxmox-card border border-proxmox-border rounded-xl p-6">
                                    <div className="flex items-center gap-3 mb-4">
                                        <div className="p-3 bg-purple-500/10 rounded-lg">
                                            <Icons.Cpu className="text-purple-400" />
                                        </div>
                                        <div>
                                            <h3 className="font-semibold text-white">{t('cpuCompatibilityMode') || 'CPU Compatibility Mode'}</h3>
                                            <p className="text-sm text-gray-400">{t('cpuCompatibilityDesc') || 'Ensure live migration compatibility across different CPU generations'}</p>
                                        </div>
                                    </div>
                                    
                                    <div className="p-4 bg-blue-500/10 border border-blue-500/30 rounded-lg mb-6">
                                        <h4 className="text-blue-400 font-medium mb-2 flex items-center gap-2">
                                            <Icons.AlertTriangle className="w-4 h-4" />
                                            {t('whatIsCpuCompat') || 'What is CPU Compatibility Mode?'}
                                        </h4>
                                        <p className="text-sm text-gray-300 mb-2">
                                            {t('cpuCompatExplain') || 'When you have nodes with different CPU generations (e.g., Haswell and Skylake), live migration may fail because newer CPUs expose features that older CPUs don\'t support.'}
                                        </p>
                                        <p className="text-sm text-gray-300">
                                            {t('cpuCompatSolution') || 'By setting all VMs to use a common CPU type, you ensure they can migrate between any node in the cluster.'}
                                        </p>
                                    </div>

                                    <div className="space-y-4">
                                        <h4 className="font-medium text-white">{t('availableLevels') || 'Available Compatibility Levels'}</h4>
                                        
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            {[
                                                { id: 'x86-64-v2-AES', label: 'x86-64-v2-AES', color: 'green', tag: t('safest') || 'Safest', desc: t('broadCompatibility') || 'Broad compatibility - works with most CPUs from 2008+' },
                                                { id: 'x86-64-v3', label: 'x86-64-v3', color: 'blue', tag: t('modern') || 'Modern', desc: t('haswell') || 'Haswell and newer (2013+)' },
                                                { id: 'x86-64-v4', label: 'x86-64-v4', color: 'yellow', tag: t('newest') || 'Newest', desc: t('skylakeAvx') || 'Skylake-X with AVX-512 (2017+)' },
                                                { id: 'host', label: 'host', color: 'red', tag: t('noMigration') || 'No Migration', desc: t('hostDesc') || 'Pass-through host CPU - best performance, no migration' }
                                            ].map(level => (
                                                <div 
                                                    key={level.id}
                                                    onClick={() => navigator.clipboard.writeText(`cpu: ${level.label}`)}
                                                    className={`p-4 bg-proxmox-dark rounded-lg border transition-all cursor-pointer ${
                                                        recommendedCpu === level.id 
                                                            ? 'border-purple-500 ring-2 ring-purple-500/30' 
                                                            : 'border-proxmox-border hover:border-purple-500/50'
                                                    }`}
                                                >
                                                    <div className="flex items-center justify-between mb-2">
                                                        <span className="font-medium text-white">{level.label}</span>
                                                        <div className="flex items-center gap-2">
                                                            {recommendedCpu === level.id && (
                                                                <span className="text-xs px-2 py-1 bg-purple-500/20 text-purple-400 rounded">
                                                                    {t('recommended') || 'Recommended'}
                                                                </span>
                                                            )}
                                                            <span className={`text-xs px-2 py-1 rounded bg-${level.color}-500/20 text-${level.color}-400`}>
                                                                {level.tag}
                                                            </span>
                                                        </div>
                                                    </div>
                                                    <p className="text-xs text-gray-400 mb-2">{level.desc}</p>
                                                    <code className="text-xs bg-proxmox-darker px-2 py-1 rounded font-mono text-purple-400">cpu: {level.label}</code>
                                                </div>
                                            ))}
                                        </div>
                                    </div>

                                    {/* Detected Node CPUs */}
                                    <div className="mt-6 pt-6 border-t border-proxmox-border">
                                        <h4 className="font-medium text-white mb-4 flex items-center gap-2">
                                            <Icons.Server className="w-4 h-4" />
                                            {t('detectedClusterCpus') || 'Detected Cluster CPUs'}
                                        </h4>
                                        {cpuInfo.length > 0 ? (
                                            <div className="space-y-2">
                                                {cpuInfo.map(info => (
                                                    <div key={info.node} className="p-4 bg-proxmox-dark rounded-lg border border-proxmox-border">
                                                        <div className="flex items-center justify-between">
                                                            <div className="flex items-center gap-3">
                                                                <div className="w-2 h-2 rounded-full bg-green-500" />
                                                                <span className="font-medium text-white">{info.node}</span>
                                                            </div>
                                                            <span className={`text-xs px-2 py-1 rounded ${
                                                                info.detectedLevel === 'v4' ? 'bg-yellow-500/20 text-yellow-400' :
                                                                info.detectedLevel === 'v3' ? 'bg-blue-500/20 text-blue-400' :
                                                                'bg-green-500/20 text-green-400'
                                                            }`}>
                                                                x86-64-{info.detectedLevel}
                                                            </span>
                                                        </div>
                                                        <div className="mt-2 flex items-center justify-between text-sm">
                                                            <span className="text-gray-400 font-mono truncate max-w-md">{info.model}</span>
                                                            <span className="text-gray-500">{info.generation} ‚Ä¢ {info.sockets}x{info.cores} Cores</span>
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        ) : (
                                            <div className="text-center py-6 text-gray-500">
                                                <Icons.Cpu className="w-8 h-8 mx-auto mb-2 opacity-50" />
                                                {t('loadingCpuInfo') || 'Loading CPU information...'}
                                            </div>
                                        )}
                                    </div>

                                    <div className="mt-6 p-4 bg-yellow-500/10 border border-yellow-500/30 rounded-lg">
                                        <h4 className="text-yellow-400 font-medium mb-2 flex items-center gap-2">
                                            <Icons.AlertTriangle className="w-4 h-4" />
                                            {t('howToApply') || 'How to Apply'}
                                        </h4>
                                        <ol className="text-sm text-gray-300 space-y-1 list-decimal list-inside">
                                            <li>{t('cpuStep1') || 'Go to each VM\'s Hardware tab'}</li>
                                            <li>{t('cpuStep2') || 'Edit the CPU setting'}</li>
                                            <li>{t('cpuStep3') || 'Change "Type" to your chosen compatibility level'}</li>
                                            <li>{t('cpuStep4') || 'Restart the VM for changes to take effect'}</li>
                                        </ol>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* HA - High Availability (Proxmox Native HA) */}
                        {activeSection === 'ha' && (
                            <div className="space-y-6">
                                {/* HA Status */}
                                <div className="bg-proxmox-card border border-proxmox-border rounded-xl overflow-hidden">
                                    <div className="p-4 border-b border-proxmox-border flex justify-between items-center">
                                        <h3 className="font-semibold flex items-center gap-2">
                                            <Icons.Activity />
                                            Status
                                        </h3>
                                        <button onClick={fetchAllData} className="flex items-center gap-2 px-3 py-1.5 bg-proxmox-dark hover:bg-proxmox-border rounded-lg text-sm">
                                            <Icons.RefreshCw className="w-4 h-4" />
                                        </button>
                                    </div>
                                    <div className="p-4 space-y-4">
                                        {haManagerStatus && typeof haManagerStatus === 'object' ? (
                                            <>
                                                {/* Quorum */}
                                                {haManagerStatus.quorum && (
                                                    <div className="flex items-center gap-3 p-3 bg-proxmox-dark/50 rounded-lg">
                                                        <div className={`w-3 h-3 rounded-full ${haManagerStatus.quorum.quorate === '1' || haManagerStatus.quorum.quorate === 1 ? 'bg-green-500' : 'bg-red-500'}`}></div>
                                                        <div>
                                                            <div className="font-medium">Quorum</div>
                                                            <div className="text-sm text-gray-400">
                                                                {haManagerStatus.quorum.quorate === '1' || haManagerStatus.quorum.quorate === 1 ? 'OK' : 'NOT OK'} 
                                                                {haManagerStatus.quorum.node && ` - Node: ${haManagerStatus.quorum.node}`}
                                                            </div>
                                                        </div>
                                                    </div>
                                                )}
                                                
                                                {/* Manager Status */}
                                                {haManagerStatus.manager_status && (
                                                    <div className="p-3 bg-proxmox-dark/50 rounded-lg">
                                                        <div className="font-medium mb-2">Manager Status</div>
                                                        <div className="grid grid-cols-2 gap-2 text-sm">
                                                            <div className="text-gray-400">Master Node:</div>
                                                            <div className="text-green-400 font-mono">{String(haManagerStatus.manager_status.master_node || '-')}</div>
                                                        </div>
                                                        {haManagerStatus.manager_status.node_status && (
                                                            <div className="mt-2">
                                                                <div className="text-gray-400 text-sm mb-1">Node Status:</div>
                                                                <div className="flex flex-wrap gap-2">
                                                                    {Object.entries(haManagerStatus.manager_status.node_status).filter(([k]) => k !== '').map(([node, status]) => (
                                                                        <span key={node} className={`px-2 py-1 rounded text-xs ${status === 'online' ? 'bg-green-500/20 text-green-400' : 'bg-red-500/20 text-red-400'}`}>
                                                                            {node}: {String(status)}
                                                                        </span>
                                                                    ))}
                                                                </div>
                                                            </div>
                                                        )}
                                                    </div>
                                                )}
                                                
                                                {/* LRM Status */}
                                                {haManagerStatus.lrm_status && (
                                                    <div className="p-3 bg-proxmox-dark/50 rounded-lg">
                                                        <div className="font-medium mb-2">LRM Status (Local Resource Manager)</div>
                                                        <div className="space-y-2">
                                                            {Object.entries(haManagerStatus.lrm_status).filter(([k]) => k !== '').map(([node, data]) => (
                                                                <div key={node} className="flex items-center justify-between text-sm p-2 bg-proxmox-dark rounded">
                                                                    <span className="font-mono">{node}</span>
                                                                    <span className={`px-2 py-0.5 rounded text-xs ${data && data.mode === 'active' ? 'bg-green-500/20 text-green-400' : 'bg-yellow-500/20 text-yellow-400'}`}>
                                                                        {data ? String(data.mode || 'unknown') : 'unknown'}
                                                                    </span>
                                                                </div>
                                                            ))}
                                                        </div>
                                                    </div>
                                                )}
                                            </>
                                        ) : (
                                            <p className="text-gray-500 text-center py-4">No HA status available</p>
                                        )}
                                    </div>
                                </div>

                                {/* HA Resources */}
                                <div className="bg-proxmox-card border border-proxmox-border rounded-xl overflow-hidden">
                                    <div className="p-4 border-b border-proxmox-border flex justify-between items-center">
                                        <h3 className="font-semibold flex items-center gap-2">
                                            <Icons.Server />
                                            Resources
                                        </h3>
                                        <button onClick={async () => {
                                            // Fetch available VMs/CTs when opening modal
                                            try {
                                                var res = await authFetch(API_URL + '/clusters/' + clusterId + '/resources');
                                                if (res && res.ok) {
                                                    var allResources = await res.json();
                                                    // Filter to VMs and CTs not already in HA
                                                    var haIds = (haResources || []).map(function(r) { return r.sid; });
                                                    var available = (allResources || []).filter(function(r) {
                                                        var sid = (r.type === 'qemu' ? 'vm:' : 'ct:') + r.vmid;
                                                        return (r.type === 'qemu' || r.type === 'lxc') && !haIds.includes(sid);
                                                    });
                                                    setAvailableVmsForHa(available);
                                                }
                                            } catch(e) { console.error('Failed to fetch VMs:', e); }
                                            setNewHaResource({ sid: '', state: 'started', group: '', max_restart: 1, max_relocate: 1, comment: '' });
                                            setShowAddHaResource(true);
                                        }} className="flex items-center gap-2 px-3 py-1.5 bg-proxmox-orange hover:bg-orange-600 rounded-lg text-sm">
                                            <Icons.Plus className="w-4 h-4" /> Add
                                        </button>
                                    </div>
                                    <div className="overflow-x-auto">
                                        <table className="w-full">
                                            <thead>
                                                <tr className="text-left text-gray-400 text-sm bg-proxmox-dark/50">
                                                    <th className="p-3">ID</th>
                                                    <th className="p-3">State</th>
                                                    <th className="p-3">Node</th>
                                                    <th className="p-3">Max Restart</th>
                                                    <th className="p-3">Max Relocate</th>
                                                    <th className="p-3">Group</th>
                                                    <th className="p-3">Comment</th>
                                                    <th className="p-3">Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {haResources && Array.isArray(haResources) && haResources.length > 0 ? (
                                                    haResources.map((res, idx) => (
                                                        <tr key={idx} className="border-t border-proxmox-border hover:bg-proxmox-dark/30">
                                                            <td className="p-3 font-mono text-sm">{String(res.sid || '')}</td>
                                                            <td className="p-3">
                                                                <span className={`px-2 py-1 rounded text-xs ${
                                                                    res.state === 'started' ? 'bg-green-500/20 text-green-400' :
                                                                    res.state === 'stopped' ? 'bg-gray-500/20 text-gray-400' :
                                                                    res.state === 'error' ? 'bg-red-500/20 text-red-400' :
                                                                    'bg-yellow-500/20 text-yellow-400'
                                                                }`}>
                                                                    {String(res.state || 'unknown')}
                                                                </span>
                                                            </td>
                                                            <td className="p-3">{String(res.node || '-')}</td>
                                                            <td className="p-3">{res.max_restart !== undefined ? res.max_restart : 1}</td>
                                                            <td className="p-3">{res.max_relocate !== undefined ? res.max_relocate : 1}</td>
                                                            <td className="p-3">{String(res.group || '-')}</td>
                                                            <td className="p-3 text-gray-400 text-sm max-w-xs truncate">{String(res.comment || '-')}</td>
                                                            <td className="p-3">
                                                                <button 
                                                                    onClick={async () => {
                                                                        if (confirm('Remove ' + res.sid + ' from HA?')) {
                                                                            try {
                                                                                var r = await authFetch(API_URL + '/clusters/' + clusterId + '/proxmox-ha/resources/' + res.sid, { method: 'DELETE' });
                                                                                if (r && r.ok) { addToast('Removed', 'success'); fetchAllData(); }
                                                                                else { addToast('Failed', 'error'); }
                                                                            } catch(e) { addToast('Error', 'error'); }
                                                                        }
                                                                    }}
                                                                    className="p-1.5 hover:bg-red-500/20 rounded text-gray-400 hover:text-red-400"
                                                                    title="Remove from HA"
                                                                >
                                                                    <Icons.Trash2 className="w-4 h-4" />
                                                                </button>
                                                            </td>
                                                        </tr>
                                                    ))
                                                ) : (
                                                    <tr>
                                                        <td colSpan="8" className="p-8 text-center text-gray-500">
                                                            No HA resources configured
                                                        </td>
                                                    </tr>
                                                )}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>

                                {/* HA Groups */}
                                <div className="bg-proxmox-card border border-proxmox-border rounded-xl overflow-hidden">
                                    <div className="p-4 border-b border-proxmox-border flex justify-between items-center">
                                        <h3 className="font-semibold flex items-center gap-2">
                                            <Icons.Users />
                                            Groups
                                        </h3>
                                        <button onClick={() => setShowAddHaGroup(true)} className="flex items-center gap-2 px-3 py-1.5 bg-proxmox-orange hover:bg-orange-600 rounded-lg text-sm">
                                            <Icons.Plus className="w-4 h-4" /> Add
                                        </button>
                                    </div>
                                    <div className="overflow-x-auto">
                                        <table className="w-full">
                                            <thead>
                                                <tr className="text-left text-gray-400 text-sm bg-proxmox-dark/50">
                                                    <th className="p-3">Group</th>
                                                    <th className="p-3">Nodes</th>
                                                    <th className="p-3">Restricted</th>
                                                    <th className="p-3">No Failback</th>
                                                    <th className="p-3">Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {haGroups && Array.isArray(haGroups) && haGroups.length > 0 ? (
                                                    haGroups.map((grp, idx) => (
                                                        <tr key={idx} className="border-t border-proxmox-border hover:bg-proxmox-dark/30">
                                                            <td className="p-3 font-medium">{String(grp.group || '')}</td>
                                                            <td className="p-3 font-mono text-sm">{String(grp.nodes || '-')}</td>
                                                            <td className="p-3">
                                                                <span className={grp.restricted ? 'text-yellow-400' : 'text-gray-500'}>
                                                                    {grp.restricted ? 'Yes' : 'No'}
                                                                </span>
                                                            </td>
                                                            <td className="p-3">
                                                                <span className={grp.nofailback ? 'text-yellow-400' : 'text-gray-500'}>
                                                                    {grp.nofailback ? 'Yes' : 'No'}
                                                                </span>
                                                            </td>
                                                            <td className="p-3">
                                                                <button 
                                                                    onClick={async () => {
                                                                        if (confirm('Delete group ' + grp.group + '?')) {
                                                                            try {
                                                                                var r = await authFetch(API_URL + '/clusters/' + clusterId + '/proxmox-ha/groups/' + grp.group, { method: 'DELETE' });
                                                                                if (r && r.ok) { addToast('Deleted', 'success'); fetchAllData(); }
                                                                                else { addToast('Failed', 'error'); }
                                                                            } catch(e) { addToast('Error', 'error'); }
                                                                        }
                                                                    }}
                                                                    className="p-1.5 hover:bg-red-500/20 rounded text-gray-400 hover:text-red-400"
                                                                    title="Delete group"
                                                                >
                                                                    <Icons.Trash2 className="w-4 h-4" />
                                                                </button>
                                                            </td>
                                                        </tr>
                                                    ))
                                                ) : (
                                                    <tr>
                                                        <td colSpan="5" className="p-8 text-center text-gray-500">
                                                            No HA groups configured
                                                        </td>
                                                    </tr>
                                                )}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>

                                {/* Add Resource Modal - Full Options like Proxmox */}
                                {showAddHaResource && (
                                    <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50" onClick={() => setShowAddHaResource(false)}>
                                        <div className="bg-proxmox-card border border-proxmox-border rounded-xl p-6 w-full max-w-lg" onClick={e => e.stopPropagation()}>
                                            <h3 className="text-lg font-semibold mb-4">Add: Resource: Container/Virtual Machine</h3>
                                            <div className="grid grid-cols-2 gap-4">
                                                {/* Left Column */}
                                                <div className="space-y-4">
                                                    <div>
                                                        <label className="block text-sm text-gray-400 mb-1">VM:</label>
                                                        <select 
                                                            value={newHaResource.sid || ''} 
                                                            onChange={e => setNewHaResource({...newHaResource, sid: e.target.value})}
                                                            className="w-full bg-proxmox-dark border border-proxmox-border rounded p-2 text-sm"
                                                        >
                                                            <option value="">-- Select VM/CT --</option>
                                                            {availableVmsForHa && availableVmsForHa.map(vm => (
                                                                <option key={vm.vmid} value={(vm.type === 'qemu' ? 'vm:' : 'ct:') + vm.vmid}>
                                                                    {vm.vmid} - {vm.name || 'unnamed'} ({vm.type === 'qemu' ? 'VM' : 'CT'})
                                                                </option>
                                                            ))}
                                                        </select>
                                                    </div>
                                                    <div>
                                                        <label className="block text-sm text-gray-400 mb-1">Max. Restart:</label>
                                                        <input 
                                                            type="number" 
                                                            min="0" 
                                                            max="10" 
                                                            value={newHaResource.max_restart || 1} 
                                                            onChange={e => setNewHaResource({...newHaResource, max_restart: parseInt(e.target.value) || 0})} 
                                                            className="w-full bg-proxmox-dark border border-proxmox-border rounded p-2 text-sm" 
                                                        />
                                                    </div>
                                                    <div>
                                                        <label className="block text-sm text-gray-400 mb-1">Max. Relocate:</label>
                                                        <input 
                                                            type="number" 
                                                            min="0" 
                                                            max="10" 
                                                            value={newHaResource.max_relocate || 1} 
                                                            onChange={e => setNewHaResource({...newHaResource, max_relocate: parseInt(e.target.value) || 0})} 
                                                            className="w-full bg-proxmox-dark border border-proxmox-border rounded p-2 text-sm" 
                                                        />
                                                    </div>
                                                </div>
                                                
                                                {/* Right Column */}
                                                <div className="space-y-4">
                                                    <div>
                                                        <label className="block text-sm text-gray-400 mb-1">Group:</label>
                                                        <select 
                                                            value={newHaResource.group || ''} 
                                                            onChange={e => setNewHaResource({...newHaResource, group: e.target.value})}
                                                            className="w-full bg-proxmox-dark border border-proxmox-border rounded p-2 text-sm"
                                                        >
                                                            <option value="">-- None --</option>
                                                            {haGroups && Array.isArray(haGroups) && haGroups.map(g => (
                                                                <option key={g.group} value={g.group}>{g.group}</option>
                                                            ))}
                                                        </select>
                                                    </div>
                                                    <div>
                                                        <label className="block text-sm text-gray-400 mb-1">Request State:</label>
                                                        <select 
                                                            value={newHaResource.state || 'started'} 
                                                            onChange={e => setNewHaResource({...newHaResource, state: e.target.value})}
                                                            className="w-full bg-proxmox-dark border border-proxmox-border rounded p-2 text-sm"
                                                        >
                                                            <option value="started">started</option>
                                                            <option value="stopped">stopped</option>
                                                            <option value="ignored">ignored</option>
                                                            <option value="disabled">disabled</option>
                                                        </select>
                                                    </div>
                                                </div>
                                                
                                                {/* Comment - Full Width */}
                                                <div className="col-span-2">
                                                    <label className="block text-sm text-gray-400 mb-1">Comment:</label>
                                                    <input 
                                                        type="text"
                                                        value={newHaResource.comment || ''} 
                                                        onChange={e => setNewHaResource({...newHaResource, comment: e.target.value})}
                                                        className="w-full bg-proxmox-dark border border-proxmox-border rounded p-2 text-sm"
                                                        placeholder="Optional comment"
                                                    />
                                                </div>
                                            </div>
                                            
                                            <div className="flex justify-end gap-2 mt-6">
                                                <button onClick={() => setShowAddHaResource(false)} className="px-4 py-2 bg-proxmox-dark hover:bg-proxmox-border rounded-lg text-sm">Cancel</button>
                                                <button onClick={async function() {
                                                    var sidVal = (newHaResource.sid || '').trim();
                                                    if (!sidVal) { 
                                                        addToast('Please select a VM/CT', 'error'); 
                                                        return; 
                                                    }
                                                    
                                                    try {
                                                        var payload = { 
                                                            sid: sidVal, 
                                                            state: newHaResource.state || 'started', 
                                                            max_restart: newHaResource.max_restart || 1, 
                                                            max_relocate: newHaResource.max_relocate || 1 
                                                        };
                                                        if (newHaResource.group) payload.group = newHaResource.group;
                                                        if (newHaResource.comment) payload.comment = newHaResource.comment;
                                                        
                                                        var res = await authFetch(API_URL + '/clusters/' + clusterId + '/proxmox-ha/resources', { 
                                                            method: 'POST', 
                                                            headers: { 'Content-Type': 'application/json' }, 
                                                            body: JSON.stringify(payload) 
                                                        });
                                                        
                                                        if (res && res.ok) { 
                                                            addToast('Resource added to HA', 'success'); 
                                                            setShowAddHaResource(false); 
                                                            setNewHaResource({ sid: '', state: 'started', group: '', max_restart: 1, max_relocate: 1, comment: '' });
                                                            fetchAllData(); 
                                                        } else { 
                                                            var errData = await res.json().catch(function() { return {}; }); 
                                                            addToast(errData.error || 'Failed to add resource', 'error'); 
                                                        }
                                                    } catch(e) { 
                                                        addToast('Error: ' + e.message, 'error'); 
                                                    }
                                                }} className="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg text-sm">Add</button>
                                            </div>
                                        </div>
                                    </div>
                                )}

                                {/* Add Group Modal */}
                                {showAddHaGroup && (
                                    <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50" onClick={() => setShowAddHaGroup(false)}>
                                        <div className="bg-proxmox-card border border-proxmox-border rounded-xl p-6 w-full max-w-md" onClick={e => e.stopPropagation()}>
                                            <h3 className="text-lg font-semibold mb-4">Add HA Group</h3>
                                            <div className="space-y-4">
                                                <div>
                                                    <label className="block text-sm text-gray-400 mb-1">Group Name</label>
                                                    <input value={newHaGroup.group || ''} onChange={e => setNewHaGroup({...newHaGroup, group: e.target.value})} placeholder="e.g. production" className="w-full bg-proxmox-dark border border-proxmox-border rounded p-2 text-sm" />
                                                </div>
                                                <div>
                                                    <label className="block text-sm text-gray-400 mb-1">Nodes (with priority)</label>
                                                    <input value={newHaGroup.nodes || ''} onChange={e => setNewHaGroup({...newHaGroup, nodes: e.target.value})} placeholder="node1:1,node2:2,node3:1" className="w-full bg-proxmox-dark border border-proxmox-border rounded p-2 text-sm font-mono" />
                                                    <span className="text-xs text-gray-500">Lower priority = preferred</span>
                                                </div>
                                                <div className="flex gap-6">
                                                    <label className="flex items-center gap-2 cursor-pointer">
                                                        <input type="checkbox" checked={newHaGroup.restricted === 1} onChange={e => setNewHaGroup({...newHaGroup, restricted: e.target.checked ? 1 : 0})} className="rounded" />
                                                        <span className="text-sm">Restricted</span>
                                                    </label>
                                                    <label className="flex items-center gap-2 cursor-pointer">
                                                        <input type="checkbox" checked={newHaGroup.nofailback === 1} onChange={e => setNewHaGroup({...newHaGroup, nofailback: e.target.checked ? 1 : 0})} className="rounded" />
                                                        <span className="text-sm">No Failback</span>
                                                    </label>
                                                </div>
                                            </div>
                                            <div className="flex justify-end gap-2 mt-6">
                                                <button onClick={() => setShowAddHaGroup(false)} className="px-4 py-2 bg-proxmox-dark hover:bg-proxmox-border rounded-lg text-sm">Cancel</button>
                                                <button onClick={async () => {
                                                    if (!newHaGroup.group || !newHaGroup.nodes) { addToast('Enter group name and nodes', 'error'); return; }
                                                    try {
                                                        var res = await authFetch(API_URL + '/clusters/' + clusterId + '/proxmox-ha/groups', { 
                                                            method: 'POST', 
                                                            headers: { 'Content-Type': 'application/json' }, 
                                                            body: JSON.stringify(newHaGroup) 
                                                        });
                                                        if (res && res.ok) { 
                                                            addToast('Group created', 'success'); 
                                                            setShowAddHaGroup(false); 
                                                            setNewHaGroup({ group: '', nodes: '', restricted: 0, nofailback: 0 });
                                                            fetchAllData(); 
                                                        } else { 
                                                            var err = await res.json().catch(function() { return {}; }); 
                                                            addToast(err.error || 'Failed to create group', 'error'); 
                                                        }
                                                    } catch(e) { addToast('Error: ' + e.message, 'error'); }
                                                }} className="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg text-sm">Create</button>
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}

                        {/* Firewall */}
                        {activeSection === 'firewall' && (
                            <div className="space-y-6">
                                {/* Firewall Options Card */}
                                <div className="bg-proxmox-card border border-proxmox-border rounded-xl p-6">
                                    <div className="flex items-center justify-between mb-4">
                                        <h3 className="font-semibold flex items-center gap-2">
                                            <Icons.Shield />
                                            {t('firewallOptions')}
                                        </h3>
                                        <button
                                            onClick={async () => {
                                                const newState = !firewallOptions.enable;
                                                try {
                                                    const res = await fetch(`${API_URL}/clusters/${clusterId}/datacenter/firewall/options`, {
                                                        method: 'PUT',
                                                        headers: { ...authHeaders, 'Content-Type': 'application/json' },
                                                        credentials: 'include',
                                                        body: JSON.stringify({ enable: newState ? 1 : 0 })
                                                    });
                                                    if(res.ok) {
                                                        setFirewallOptions(prev => ({ ...prev, enable: newState }));
                                                    }
                                                } catch(e) {
                                                    console.error('updating firewall:', e);
                                                }
                                            }}
                                            className={`px-4 py-2 rounded-lg font-medium transition-colors ${
                                                firewallOptions.enable 
                                                    ? 'bg-green-500/20 text-green-400 hover:bg-green-500/30' 
                                                    : 'bg-red-500/20 text-red-400 hover:bg-red-500/30'
                                            }`}
                                        >
                                            {firewallOptions.enable ? t('enabled') : t('disabled')}
                                        </button>
                                    </div>
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <div className="bg-proxmox-dark rounded-lg p-4">
                                            <div className="text-sm text-gray-400 mb-1">Policy In</div>
                                            <select 
                                                value={firewallOptions.policy_in || 'DROP'}
                                                onChange={async (e) => {
                                                    try {
                                                        const res = await fetch(`${API_URL}/clusters/${clusterId}/datacenter/firewall/options`, {
                                                            method: 'PUT',
                                                            headers: { ...authHeaders, 'Content-Type': 'application/json' },
                                                            credentials: 'include',
                                                            body: JSON.stringify({ policy_in: e.target.value })
                                                        });
                                                        if(res.ok) setFirewallOptions(prev => ({ ...prev, policy_in: e.target.value }));
                                                    } catch(e) {}
                                                }}
                                                className="w-full bg-proxmox-darker border border-proxmox-border rounded-lg p-2 text-white"
                                            >
                                                <option value="ACCEPT">ACCEPT</option>
                                                <option value="DROP">DROP</option>
                                                <option value="REJECT">REJECT</option>
                                            </select>
                                        </div>
                                        <div className="bg-proxmox-dark rounded-lg p-4">
                                            <div className="text-sm text-gray-400 mb-1">Policy Out</div>
                                            <select 
                                                value={firewallOptions.policy_out || 'ACCEPT'}
                                                onChange={async (e) => {
                                                    try {
                                                        const res = await fetch(`${API_URL}/clusters/${clusterId}/datacenter/firewall/options`, {
                                                            method: 'PUT',
                                                            headers: { ...authHeaders, 'Content-Type': 'application/json' },
                                                            credentials: 'include',
                                                            body: JSON.stringify({ policy_out: e.target.value })
                                                        });
                                                        if(res.ok) setFirewallOptions(prev => ({ ...prev, policy_out: e.target.value }));
                                                    } catch(e) {}
                                                }}
                                                className="w-full bg-proxmox-darker border border-proxmox-border rounded-lg p-2 text-white"
                                            >
                                                <option value="ACCEPT">ACCEPT</option>
                                                <option value="DROP">DROP</option>
                                                <option value="REJECT">REJECT</option>
                                            </select>
                                        </div>
                                        <div className="bg-proxmox-dark rounded-lg p-4">
                                            <div className="text-sm text-gray-400 mb-1">Log Level</div>
                                            <select 
                                                value={firewallOptions.log_level_in || 'nolog'}
                                                onChange={async (e) => {
                                                    try {
                                                        const res = await fetch(`${API_URL}/clusters/${clusterId}/datacenter/firewall/options`, {
                                                            method: 'PUT',
                                                            headers: { ...authHeaders, 'Content-Type': 'application/json' },
                                                            credentials: 'include',
                                                            body: JSON.stringify({ log_level_in: e.target.value })
                                                        });
                                                        if(res.ok) setFirewallOptions(prev => ({ ...prev, log_level_in: e.target.value }));
                                                    } catch(e) {}
                                                }}
                                                className="w-full bg-proxmox-darker border border-proxmox-border rounded-lg p-2 text-white"
                                            >
                                                <option value="nolog">No Log</option>
                                                <option value="emerg">Emergency</option>
                                                <option value="alert">Alert</option>
                                                <option value="crit">Critical</option>
                                                <option value="err">Error</option>
                                                <option value="warning">Warning</option>
                                                <option value="notice">Notice</option>
                                                <option value="info">Info</option>
                                                <option value="debug">Debug</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>

                                {/* Firewall Rules Card */}
                                <div className="bg-proxmox-card border border-proxmox-border rounded-xl overflow-hidden">
                                    <div className="p-4 border-b border-proxmox-border flex justify-between items-center">
                                        <h3 className="font-semibold">{t('firewallRules')}</h3>
                                        <button 
                                            onClick={() => setShowAddRuleModal(true)}
                                            className="flex items-center gap-2 px-3 py-1.5 bg-proxmox-orange hover:bg-orange-600 rounded-lg text-sm text-white transition-colors"
                                        >
                                            <Icons.Plus /> {t('add')}
                                        </button>
                                    </div>
                                    <div className="overflow-x-auto">
                                        <table className="w-full">
                                            <thead className="bg-proxmox-dark">
                                                <tr>
                                                    <th className="text-left p-3 text-sm text-gray-400">#</th>
                                                    <th className="text-left p-3 text-sm text-gray-400">{t('type')}</th>
                                                    <th className="text-left p-3 text-sm text-gray-400">{t('action')}</th>
                                                    <th className="text-left p-3 text-sm text-gray-400">Macro</th>
                                                    <th className="text-left p-3 text-sm text-gray-400">{t('source')}</th>
                                                    <th className="text-left p-3 text-sm text-gray-400">Dest</th>
                                                    <th className="text-left p-3 text-sm text-gray-400">Proto</th>
                                                    <th className="text-left p-3 text-sm text-gray-400">Port</th>
                                                    <th className="text-left p-3 text-sm text-gray-400">{t('enabled')}</th>
                                                    <th className="text-left p-3 text-sm text-gray-400">{t('comment')}</th>
                                                    <th className="text-left p-3 text-sm text-gray-400"></th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {(!firewallRules || firewallRules.length === 0) ? (
                                                    <tr><td colSpan="11" className="p-8 text-center text-gray-500">{t('noFirewallRules')}</td></tr>
                                                ) : (Array.isArray(firewallRules) ? firewallRules : []).map((rule, idx) => (
                                                    <tr key={idx} className="border-t border-proxmox-border hover:bg-proxmox-dark/50">
                                                        <td className="p-3 text-gray-400">{rule.pos}</td>
                                                        <td className="p-3">
                                                            <span className={`px-2 py-0.5 rounded text-xs ${
                                                                rule.type === 'in' ? 'bg-blue-500/20 text-blue-400' : 'bg-purple-500/20 text-purple-400'
                                                            }`}>
                                                                {rule.type || 'in'}
                                                            </span>
                                                        </td>
                                                        <td className="p-3">
                                                            <span className={`px-2 py-0.5 rounded text-xs font-medium ${
                                                                rule.action === 'ACCEPT' ? 'bg-green-500/20 text-green-400' : 
                                                                rule.action === 'DROP' ? 'bg-red-500/20 text-red-400' :
                                                                'bg-yellow-500/20 text-yellow-400'
                                                            }`}>
                                                                {rule.action}
                                                            </span>
                                                        </td>
                                                        <td className="p-3 text-gray-300">{rule.macro || '-'}</td>
                                                        <td className="p-3 font-mono text-xs text-gray-300">{rule.source || '-'}</td>
                                                        <td className="p-3 font-mono text-xs text-gray-300">{rule.dest || '-'}</td>
                                                        <td className="p-3 text-gray-300">{rule.proto || '-'}</td>
                                                        <td className="p-3 font-mono text-xs text-gray-300">{rule.dport || '-'}</td>
                                                        <td className="p-3">
                                                            <button
                                                                onClick={async () => {
                                                                    try {
                                                                        const res = await fetch(`${API_URL}/clusters/${clusterId}/datacenter/firewall/rules/${rule.pos}`, {
                                                                            method: 'PUT',
                                                                            headers: { ...authHeaders, 'Content-Type': 'application/json' },
                                                                            body: JSON.stringify({ enable: rule.enable ? 0 : 1 })
                                                                        });
                                                                        if(res.ok) {
                                                                            setFirewallRules(prev => prev.map(r => 
                                                                                r.pos === rule.pos ? { ...r, enable: rule.enable ? 0 : 1 } : r
                                                                            ));
                                                                        }
                                                                    } catch(e) {}
                                                                }}
                                                                className={`w-8 h-5 rounded-full transition-colors ${rule.enable ? 'bg-green-500' : 'bg-gray-600'}`}
                                                            >
                                                                <div className={`w-4 h-4 rounded-full bg-white transition-transform ${rule.enable ? 'translate-x-3.5' : 'translate-x-0.5'}`}></div>
                                                            </button>
                                                        </td>
                                                        <td className="p-3 text-gray-500 text-xs max-w-32 truncate">{rule.comment || ''}</td>
                                                        <td className="p-3">
                                                            <button 
                                                                onClick={() => deleteFirewallRule(rule.pos)} 
                                                                className="p-1.5 hover:bg-red-500/20 rounded text-red-400 transition-colors"
                                                            >
                                                                <Icons.Trash />
                                                            </button>
                                                        </td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>

                                {/* Add Rule Modal */}
                                {showAddRuleModal && (
                                    <div className="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop" onClick={() => setShowAddRuleModal(false)}>
                                        <div className="w-full max-w-lg bg-proxmox-card border border-proxmox-border rounded-2xl shadow-2xl overflow-hidden" onClick={e => e.stopPropagation()}>
                                            <div className="p-4 border-b border-proxmox-border">
                                                <h3 className="font-semibold">Add Firewall Rule</h3>
                                            </div>
                                            <div className="p-4 space-y-4">
                                                <div className="grid grid-cols-2 gap-4">
                                                    <div>
                                                        <label className="text-sm text-gray-400 mb-1 block">Direction</label>
                                                        <select 
                                                            value={newRule.type || 'in'}
                                                            onChange={e => setNewRule(p => ({...p, type: e.target.value}))}
                                                            className="w-full bg-proxmox-dark border border-proxmox-border rounded-lg p-2"
                                                        >
                                                            <option value="in">IN</option>
                                                            <option value="out">OUT</option>
                                                        </select>
                                                    </div>
                                                    <div>
                                                        <label className="text-sm text-gray-400 mb-1 block">Action</label>
                                                        <select 
                                                            value={newRule.action || 'ACCEPT'}
                                                            onChange={e => setNewRule(p => ({...p, action: e.target.value}))}
                                                            className="w-full bg-proxmox-dark border border-proxmox-border rounded-lg p-2"
                                                        >
                                                            <option value="ACCEPT">ACCEPT</option>
                                                            <option value="DROP">DROP</option>
                                                            <option value="REJECT">REJECT</option>
                                                        </select>
                                                    </div>
                                                </div>
                                                <div className="grid grid-cols-2 gap-4">
                                                    <div>
                                                        <label className="text-sm text-gray-400 mb-1 block">Protocol</label>
                                                        <select 
                                                            value={newRule.proto || ''}
                                                            onChange={e => setNewRule(p => ({...p, proto: e.target.value}))}
                                                            className="w-full bg-proxmox-dark border border-proxmox-border rounded-lg p-2"
                                                        >
                                                            <option value="">Any</option>
                                                            <option value="tcp">TCP</option>
                                                            <option value="udp">UDP</option>
                                                            <option value="icmp">ICMP</option>
                                                        </select>
                                                    </div>
                                                    <div>
                                                        <label className="text-sm text-gray-400 mb-1 block">Dest. Port</label>
                                                        <input 
                                                            type="text"
                                                            value={newRule.dport || ''}
                                                            onChange={e => setNewRule(p => ({...p, dport: e.target.value}))}
                                                            placeholder="e.g. 22, 80, 443"
                                                            className="w-full bg-proxmox-dark border border-proxmox-border rounded-lg p-2"
                                                        />
                                                    </div>
                                                </div>
                                                <div className="grid grid-cols-2 gap-4">
                                                    <div>
                                                        <label className="text-sm text-gray-400 mb-1 block">Source</label>
                                                        <input 
                                                            type="text"
                                                            value={newRule.source || ''}
                                                            onChange={e => setNewRule(p => ({...p, source: e.target.value}))}
                                                            placeholder="e.g. 10.0.0.0/24"
                                                            className="w-full bg-proxmox-dark border border-proxmox-border rounded-lg p-2"
                                                        />
                                                    </div>
                                                    <div>
                                                        <label className="text-sm text-gray-400 mb-1 block">Destination</label>
                                                        <input 
                                                            type="text"
                                                            value={newRule.dest || ''}
                                                            onChange={e => setNewRule(p => ({...p, dest: e.target.value}))}
                                                            placeholder="e.g. 192.168.1.0/24"
                                                            className="w-full bg-proxmox-dark border border-proxmox-border rounded-lg p-2"
                                                        />
                                                    </div>
                                                </div>
                                                <div>
                                                    <label className="text-sm text-gray-400 mb-1 block">Comment</label>
                                                    <input 
                                                        type="text"
                                                        value={newRule.comment || ''}
                                                        onChange={e => setNewRule(p => ({...p, comment: e.target.value}))}
                                                        placeholder="Optional description"
                                                        className="w-full bg-proxmox-dark border border-proxmox-border rounded-lg p-2"
                                                    />
                                                </div>
                                                <label className="flex items-center gap-2">
                                                    <input 
                                                        type="checkbox"
                                                        checked={newRule.enable !== 0}
                                                        onChange={e => setNewRule(p => ({...p, enable: e.target.checked ? 1 : 0}))}
                                                        className="w-4 h-4 rounded"
                                                    />
                                                    <span>Enable rule</span>
                                                </label>
                                            </div>
                                            <div className="p-4 border-t border-proxmox-border flex gap-3 justify-end">
                                                <button
                                                    onClick={() => setShowAddRuleModal(false)}
                                                    className="px-4 py-2 bg-proxmox-dark rounded-lg hover:bg-proxmox-hover transition-colors"
                                                >
                                                    {t('cancel')}
                                                </button>
                                                <button
                                                    onClick={async () => {
                                                        try {
                                                            const res = await fetch(`${API_URL}/clusters/${clusterId}/datacenter/firewall/rules`, {
                                                                method: 'POST',
                                                                headers: { ...authHeaders, 'Content-Type': 'application/json' },
                                                                body: JSON.stringify(newRule)
                                                            });
                                                            if(res.ok) {
                                                                // Refresh rules
                                                                const rulesRes = await authFetch(`${API_URL}/clusters/${clusterId}/datacenter/firewall/rules`);
                                                                if(rulesRes.ok) setFirewallRules(await rulesRes.json());
                                                                setShowAddRuleModal(false);
                                                                setNewRule({ type: 'in', action: 'ACCEPT', enable: 1 });
                                                            }
                                                        } catch(e) {}
                                                    }}
                                                    className="px-4 py-2 bg-proxmox-orange rounded-lg text-white hover:bg-orange-600 transition-colors"
                                                >
                                                    {t('add')}
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}
                    </div>
                    
                    {/* Node Join Wizard Modal */}
                    {showNodeJoinWizard && <NodeJoinWizard isOpen={showNodeJoinWizard} onClose={() => setShowNodeJoinWizard(false)} clusterId={clusterId} onSuccess={() => { fetchAllData(); }} addToast={addToast} />}
                    
                    {/* Remove Node Modal */}
                    {showRemoveNodeModal && nodeToRemove && <RemoveNodeConfirmModal isOpen={showRemoveNodeModal} onClose={() => { setShowRemoveNodeModal(false); setNodeToRemove(null); }} node={nodeToRemove} clusterId={clusterId} onSuccess={() => { fetchAllData(); }} addToast={addToast} />}
                </div>
            );
        }

        // Security Settings Section Component (for PegaProx Settings)
        // LW: The locked IPs table was AI-generated (Claude), I just styled it - Oct 2025
        function SecuritySettingsSection({ addToast }) {
            const { t } = useTranslation();
            const { getAuthHeaders, isAdmin } = useAuth();
            const [settings, setSettings] = useState({
                login_max_attempts: 5,
                login_lockout_time: 300,
                login_attempt_window: 600,
                password_min_length: 8,
                password_require_uppercase: true,
                password_require_lowercase: true,
                password_require_numbers: true,
                password_require_special: false,
                session_timeout: 86400,
                // LW: Password expiry - Dec 2025
                password_expiry_enabled: false,
                password_expiry_days: 90,
                password_expiry_warning_days: 14,
                password_expiry_email_enabled: true,
                password_expiry_include_admins: false  // NS: opt-in for admins
            });
            const [lockedIps, setLockedIps] = useState([]);
            const [lockedUsers, setLockedUsers] = useState([]);  // NS: Username lockout support
            const [loading, setLoading] = useState(true);
            const [resetAllLoading, setResetAllLoading] = useState(false);
            const [showResetConfirm, setShowResetConfirm] = useState(false);
            const [includeAdmins, setIncludeAdmins] = useState(false);

            useEffect(() => {
                fetchSettings();
                fetchLockedIps();
            }, []);

            const fetchSettings = async () => {
                try {
                    const res = await fetch(`${API_URL}/settings/server`, {
                        credentials: 'include',
                        headers: getAuthHeaders()
                    });
                    if(res.ok) {
                        const data = await res.json();
                        setSettings(prev => ({
                            ...prev,
                            login_max_attempts: data.login_max_attempts || 5,
                            login_lockout_time: data.login_lockout_time || 300,
                            login_attempt_window: data.login_attempt_window || 600,
                            password_min_length: data.password_min_length || 8,
                            password_require_uppercase: data.password_require_uppercase !== false,
                            password_require_lowercase: data.password_require_lowercase !== false,
                            password_require_numbers: data.password_require_numbers !== false,
                            password_require_special: data.password_require_special || false,
                            session_timeout: data.session_timeout || 86400,
                            // LW: Password expiry
                            password_expiry_enabled: data.password_expiry_enabled || false,
                            password_expiry_days: data.password_expiry_days || 90,
                            password_expiry_warning_days: data.password_expiry_warning_days || 14,
                            password_expiry_email_enabled: data.password_expiry_email_enabled !== false,
                            password_expiry_include_admins: data.password_expiry_include_admins || false
                        }));
                    }
                } catch(e) {
                    console.error('to fetch security settings:', e);
                } finally {
                    setLoading(false);
                }
            };

            const fetchLockedIps = async () => {
                try {
                    const res = await fetch(`${API_URL}/security/locked-ips`, {
                        credentials: 'include',
                        headers: getAuthHeaders()
                    });
                    if(res.ok) {
                        const data = await res.json();
                        setLockedIps(data.locked_ips || []);
                        setLockedUsers(data.locked_users || []);  // NS: Also get locked users
                    }
                } catch(e) {
                    console.error('to fetch locked IPs:', e);
                }
            };
            
            // LW: Reset all user passwords - for security incidents
            // NS: This was scary to implement lol, triple-confirmed it works right
            const resetAllPasswords = async () => {
                setResetAllLoading(true);
                try {
                    const res = await fetch(`${API_URL}/security/password-expiry/reset-all`, {
                        method: 'POST',
                        credentials: 'include',
                        headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
                        body: JSON.stringify({ include_admins: includeAdmins })
                    });
                    if(res.ok) {
                        const data = await res.json();
                        addToast(data.message || `${data.reset_count} users will need to change their password`, 'success');
                        setShowResetConfirm(false);
                        setIncludeAdmins(false);  // reset checkbox
                    } else {
                        const err = await res.json();
                        addToast(err.error || 'Failed to reset passwords', 'error');
                    }
                } catch(e) {
                    console.error('reset all passwords failed:', e);
                    addToast('Connection error', 'error');
                } finally {
                    setResetAllLoading(false);
                }
            };

            const saveSettings = async (newSettings) => {
                try {
                    const res = await fetch(`${API_URL}/settings/server`, {
                        method: 'POST',
                        credentials: 'include',
                        headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
                        body: JSON.stringify(newSettings)
                    });
                    if(res.ok) {
                        setSettings(newSettings);
                        addToast(t('settingsSaved'), 'success');
                    }
                } catch(e) {
                    addToast(t('failedToSaveSettings'), 'error');
                }
            };

            const unlockIp = async (ip) => {
                try {
                    const res = await fetch(`${API_URL}/security/locked-ips/${encodeURIComponent(ip)}`, {
                        method: 'DELETE',
                        credentials: 'include',
                        headers: getAuthHeaders()
                    });
                    if(res.ok) {
                        setLockedIps(prev => prev.filter(l => l.ip !== ip));
                        addToast(`IP ${ip} ${t('unlocked')}`, 'success');
                    }
                } catch(e) {
                    addToast(t('failedToUnlockIp'), 'error');
                }
            };

            // NS: Unlock a specific username
            const unlockUser = async (username) => {
                try {
                    const res = await fetch(`${API_URL}/security/locked-users/${encodeURIComponent(username)}`, {
                        method: 'DELETE',
                        credentials: 'include',
                        headers: getAuthHeaders()
                    });
                    if(res.ok) {
                        setLockedUsers(prev => prev.filter(l => l.username !== username));
                        addToast(`${t('user')} ${username} ${t('unlocked')}`, 'success');
                    }
                } catch(e) {
                    addToast(t('failedToUnlockUser') || 'Failed to unlock user', 'error');
                }
            };

            const unlockAll = async () => {
                if(!confirm(t('unlockAllConfirm'))) return;
                try {
                    const res = await fetch(`${API_URL}/security/locked-ips`, {
                        method: 'DELETE',
                        credentials: 'include',
                        headers: getAuthHeaders()
                    });
                    if(res.ok) {
                        setLockedIps([]);
                        addToast(t('allIpsUnlocked'), 'success');
                    }
                } catch(e) {
                    addToast(t('failedToUnlockAllIps'), 'error');
                }
            };

            // NS: Unlock all usernames
            const unlockAllUsers = async () => {
                if(!confirm(t('unlockAllUsersConfirm') || 'Unlock all users?')) return;
                try {
                    const res = await fetch(`${API_URL}/security/locked-users`, {
                        method: 'DELETE',
                        credentials: 'include',
                        headers: getAuthHeaders()
                    });
                    if(res.ok) {
                        setLockedUsers([]);
                        addToast(t('allUsersUnlocked') || 'All users unlocked', 'success');
                    }
                } catch(e) {
                    addToast(t('failedToUnlockAllUsers') || 'Failed to unlock all users', 'error');
                }
            };

            if(!isAdmin) return null;

            return (
                <div className="space-y-6">
                    {/* Header with badge */}
                    <div className="flex items-center justify-between">
                        <div className="flex items-center gap-3">
                            <div className="p-2 bg-red-500/10 rounded-lg">
                                <Icons.Shield />
                            </div>
                            <div>
                                <h3 className="text-lg font-semibold text-white">{t('bruteForceProtection')}</h3>
                                <p className="text-xs text-gray-500">{t('bruteForceProtectionDesc') || 'Configure login attempt limits and lockout settings'}</p>
                            </div>
                        </div>
                        {(lockedIps.length > 0 || lockedUsers.length > 0) && (
                            <div className="flex gap-2">
                                {lockedIps.length > 0 && (
                                    <span className="px-3 py-1.5 bg-red-500/20 text-red-400 rounded-full text-sm font-medium">
                                        {lockedIps.length} IP{lockedIps.length !== 1 ? 's' : ''}
                                    </span>
                                )}
                                {lockedUsers.length > 0 && (
                                    <span className="px-3 py-1.5 bg-orange-500/20 text-orange-400 rounded-full text-sm font-medium">
                                        {lockedUsers.length} {t('user')}{lockedUsers.length !== 1 ? 's' : ''}
                                    </span>
                                )}
                            </div>
                        )}
                    </div>

                    {/* Settings */}
                    <div className="bg-proxmox-dark border border-proxmox-border rounded-xl p-4">
                        <h4 className="font-medium text-white mb-4">{t('loginProtection') || 'Login Protection'}</h4>
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label className="block text-sm text-gray-400 mb-2">{t('maxLoginAttempts')}</label>
                                <input
                                    type="number"
                                    value={settings.login_max_attempts}
                                    onChange={e => setSettings(prev => ({...prev, login_max_attempts: parseInt(e.target.value) || 5}))}
                                    onBlur={() => saveSettings(settings)}
                                    min={1}
                                    max={20}
                                    className="w-full bg-proxmox-darker border border-proxmox-border rounded-lg p-2 text-white"
                                />
                                <p className="text-xs text-gray-500 mt-1">{t('maxLoginAttemptsDesc')}</p>
                            </div>
                            <div>
                                <label className="block text-sm text-gray-400 mb-2">{t('lockoutTime')}</label>
                                <div className="flex gap-2">
                                    <input
                                        type="number"
                                        value={settings.login_lockout_time}
                                        onChange={e => setSettings(prev => ({...prev, login_lockout_time: parseInt(e.target.value) || 300}))}
                                        onBlur={() => saveSettings(settings)}
                                        min={60}
                                        max={3600}
                                        step={60}
                                        className="flex-1 bg-proxmox-darker border border-proxmox-border rounded-lg p-2 text-white"
                                    />
                                    <span className="flex items-center text-gray-500 text-sm">sec</span>
                                </div>
                                <p className="text-xs text-gray-500 mt-1">{Math.round(settings.login_lockout_time / 60)} {t('minutes')}</p>
                            </div>
                            <div>
                                <label className="block text-sm text-gray-400 mb-2">{t('attemptWindow')}</label>
                                <div className="flex gap-2">
                                    <input
                                        type="number"
                                        value={settings.login_attempt_window}
                                        onChange={e => setSettings(prev => ({...prev, login_attempt_window: parseInt(e.target.value) || 600}))}
                                        onBlur={() => saveSettings(settings)}
                                        min={60}
                                        max={3600}
                                        step={60}
                                        className="flex-1 bg-proxmox-darker border border-proxmox-border rounded-lg p-2 text-white"
                                    />
                                    <span className="flex items-center text-gray-500 text-sm">sec</span>
                                </div>
                                <p className="text-xs text-gray-500 mt-1">{Math.round(settings.login_attempt_window / 60)} {t('minutes')}</p>
                            </div>
                        </div>
                    </div>

                    {/* Password Policy */}
                    <div className="bg-proxmox-dark border border-proxmox-border rounded-xl p-4">
                        <h4 className="font-medium text-white mb-4 flex items-center gap-2">
                            <Icons.Key />
                            {t('passwordPolicy') || 'Password Policy'}
                        </h4>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label className="block text-sm text-gray-400 mb-2">{t('minPasswordLength') || 'Minimum Length'}</label>
                                <input
                                    type="number"
                                    value={settings.password_min_length || 8}
                                    onChange={e => setSettings(prev => ({...prev, password_min_length: parseInt(e.target.value) || 8}))}
                                    onBlur={() => saveSettings(settings)}
                                    min={4}
                                    max={32}
                                    className="w-full bg-proxmox-darker border border-proxmox-border rounded-lg p-2 text-white"
                                />
                            </div>
                            <div>
                                <label className="block text-sm text-gray-400 mb-2">{t('sessionTimeout') || 'Session Timeout'}</label>
                                <div className="flex gap-2">
                                    <input
                                        type="number"
                                        value={Math.round((settings.session_timeout || 86400) / 3600)}
                                        onChange={e => setSettings(prev => ({...prev, session_timeout: (parseInt(e.target.value) || 24) * 3600}))}
                                        onBlur={() => saveSettings(settings)}
                                        min={1}
                                        max={168}
                                        className="flex-1 bg-proxmox-darker border border-proxmox-border rounded-lg p-2 text-white"
                                    />
                                    <span className="flex items-center text-gray-500 text-sm">{t('hours') || 'hours'}</span>
                                </div>
                            </div>
                        </div>
                        <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mt-4">
                            <label className="flex items-center gap-2 cursor-pointer">
                                <input
                                    type="checkbox"
                                    checked={settings.password_require_uppercase !== false}
                                    onChange={e => {
                                        const newSettings = {...settings, password_require_uppercase: e.target.checked};
                                        setSettings(newSettings);
                                        saveSettings(newSettings);
                                    }}
                                    className="rounded"
                                />
                                <span className="text-sm text-gray-300">{t('requireUppercase') || 'Uppercase'}</span>
                            </label>
                            <label className="flex items-center gap-2 cursor-pointer">
                                <input
                                    type="checkbox"
                                    checked={settings.password_require_lowercase !== false}
                                    onChange={e => {
                                        const newSettings = {...settings, password_require_lowercase: e.target.checked};
                                        setSettings(newSettings);
                                        saveSettings(newSettings);
                                    }}
                                    className="rounded"
                                />
                                <span className="text-sm text-gray-300">{t('requireLowercase') || 'Lowercase'}</span>
                            </label>
                            <label className="flex items-center gap-2 cursor-pointer">
                                <input
                                    type="checkbox"
                                    checked={settings.password_require_numbers !== false}
                                    onChange={e => {
                                        const newSettings = {...settings, password_require_numbers: e.target.checked};
                                        setSettings(newSettings);
                                        saveSettings(newSettings);
                                    }}
                                    className="rounded"
                                />
                                <span className="text-sm text-gray-300">{t('requireNumbers') || 'Numbers'}</span>
                            </label>
                            <label className="flex items-center gap-2 cursor-pointer">
                                <input
                                    type="checkbox"
                                    checked={settings.password_require_special || false}
                                    onChange={e => {
                                        const newSettings = {...settings, password_require_special: e.target.checked};
                                        setSettings(newSettings);
                                        saveSettings(newSettings);
                                    }}
                                    className="rounded"
                                />
                                <span className="text-sm text-gray-300">{t('requireSpecial') || 'Special chars'}</span>
                            </label>
                        </div>
                    </div>

                    {/* LW: Password Expiry Settings - Dec 2025
                        NS: Good feature request from IT-Sec team. They wanted this for compliance.
                        MK: Admins exempt because otherwise you could lock yourself out lol */}
                    <div className="bg-proxmox-dark border border-proxmox-border rounded-xl p-4">
                        <div className="flex items-center justify-between mb-4">
                            <h4 className="font-medium text-white flex items-center gap-2">
                                <Icons.Clock />
                                {t('passwordExpiry') || 'Password Expiry'}
                            </h4>
                            <label className="flex items-center gap-2 cursor-pointer">
                                <input
                                    type="checkbox"
                                    checked={settings.password_expiry_enabled || false}
                                    onChange={e => {
                                        const newSettings = {...settings, password_expiry_enabled: e.target.checked};
                                        setSettings(newSettings);
                                        saveSettings(newSettings);
                                    }}
                                    className="rounded"
                                />
                                <span className="text-sm text-gray-300">{t('enabled')}</span>
                            </label>
                        </div>
                        
                        <p className="text-sm text-gray-400 mb-4">
                            {t('passwordExpiryDesc') || 'Force users to change their password after a specified number of days.'}
                        </p>
                        
                        {/* only show options when enabled - saves screen space */}
                        {settings.password_expiry_enabled && (
                            <div className="space-y-4">
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label className="block text-sm text-gray-400 mb-2">{t('expiryDays') || 'Password expires after'}</label>
                                        <div className="flex gap-2">
                                            <input
                                                type="number"
                                                value={settings.password_expiry_days || 90}
                                                onChange={e => setSettings(prev => ({...prev, password_expiry_days: parseInt(e.target.value) || 90}))}
                                                onBlur={() => saveSettings(settings)}
                                                min={7}
                                                max={365}
                                                className="flex-1 bg-proxmox-darker border border-proxmox-border rounded-lg p-2 text-white"
                                            />
                                            <span className="flex items-center text-gray-500 text-sm">{t('days') || 'days'}</span>
                                        </div>
                                        {/* NS: 90 days is a common default, but some orgs want 30 or 60 */}
                                    </div>
                                    <div>
                                        <label className="block text-sm text-gray-400 mb-2">{t('warningDays') || 'Warn users before'}</label>
                                        <div className="flex gap-2">
                                            <input
                                                type="number"
                                                value={settings.password_expiry_warning_days || 14}
                                                onChange={e => setSettings(prev => ({...prev, password_expiry_warning_days: parseInt(e.target.value) || 14}))}
                                                onBlur={() => saveSettings(settings)}
                                                min={1}
                                                max={30}
                                                className="flex-1 bg-proxmox-darker border border-proxmox-border rounded-lg p-2 text-white"
                                            />
                                            <span className="flex items-center text-gray-500 text-sm">{t('days') || 'days'}</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <label className="flex items-center gap-2 cursor-pointer">
                                    <input
                                        type="checkbox"
                                        checked={settings.password_expiry_email_enabled !== false}
                                        onChange={e => {
                                            const newSettings = {...settings, password_expiry_email_enabled: e.target.checked};
                                            setSettings(newSettings);
                                            saveSettings(newSettings);
                                        }}
                                        className="rounded"
                                    />
                                    <span className="text-sm text-gray-300">{t('sendExpiryEmails') || 'Send email notifications when password is about to expire'}</span>
                                </label>
                                
                                {/* NS: Include admins checkbox - requested by IT-Sec team */}
                                <label className="flex items-center gap-2 cursor-pointer p-3 bg-yellow-500/10 border border-yellow-500/30 rounded-lg">
                                    <input
                                        type="checkbox"
                                        checked={settings.password_expiry_include_admins || false}
                                        onChange={e => {
                                            const newSettings = {...settings, password_expiry_include_admins: e.target.checked};
                                            setSettings(newSettings);
                                            saveSettings(newSettings);
                                        }}
                                        className="rounded"
                                    />
                                    <div>
                                        <span className="text-sm text-yellow-400 font-medium">{t('includeAdminsInExpiry') || 'Include admin accounts'}</span>
                                        <p className="text-xs text-gray-500">{t('includeAdminsInExpiryDesc') || 'Admins will also need to change their passwords regularly'}</p>
                                    </div>
                                </label>
                                
                                <div className="p-3 bg-blue-500/10 border border-blue-500/30 rounded-lg">
                                    <p className="text-sm text-blue-400">
                                        üí° {t('passwordExpiryHint') || 'Users receive email reminders at 14, 7, 3, and 1 day(s) before expiry. A warning banner is shown in the UI. SMTP must be configured for emails.'}
                                    </p>
                                </div>
                                
                                {/* LW: Emergency reset button - NS wanted this after a security scare */}
                                <div className="pt-4 border-t border-proxmox-border">
                                    <div className="flex items-center justify-between">
                                        <div>
                                            <h5 className="text-sm font-medium text-white">{t('forcePasswordReset') || 'Force Password Reset'}</h5>
                                            <p className="text-xs text-gray-500 mt-1">{t('forcePasswordResetDesc') || 'Expire all user passwords immediately. Use after security incidents.'}</p>
                                        </div>
                                        <button
                                            onClick={() => setShowResetConfirm(true)}
                                            className="px-4 py-2 bg-red-500/20 text-red-400 hover:bg-red-500/30 rounded-lg text-sm font-medium transition-colors"
                                        >
                                            {t('resetAllPasswords') || 'Reset All'}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                    
                    {/* Reset All Passwords Confirmation Modal */}
                    {showResetConfirm && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/70">
                            <div className="bg-proxmox-dark border border-proxmox-border rounded-xl p-6 max-w-md w-full mx-4 shadow-2xl">
                                <div className="flex items-center gap-3 mb-4">
                                    <div className="p-2 bg-red-500/20 rounded-lg">
                                        <Icons.AlertTriangle className="w-6 h-6 text-red-400" />
                                    </div>
                                    <h3 className="text-lg font-semibold text-white">{t('confirmPasswordReset') || 'Confirm Password Reset'}</h3>
                                </div>
                                
                                <p className="text-gray-400 mb-4">
                                    {t('resetAllWarning') || 'This will force ALL users to change their passwords on next login. This action cannot be undone.'}
                                </p>
                                
                                <label className="flex items-center gap-2 cursor-pointer mb-6 p-3 bg-yellow-500/10 border border-yellow-500/30 rounded-lg">
                                    <input
                                        type="checkbox"
                                        checked={includeAdmins}
                                        onChange={e => setIncludeAdmins(e.target.checked)}
                                        className="rounded"
                                    />
                                    <div>
                                        <span className="text-sm text-yellow-400 font-medium">{t('includeAdmins') || 'Include admin accounts'}</span>
                                        <p className="text-xs text-gray-500">{t('includeAdminsWarning') || 'Warning: You will also need to change your password!'}</p>
                                    </div>
                                </label>
                                
                                <div className="flex gap-3">
                                    <button
                                        onClick={() => {
                                            setShowResetConfirm(false);
                                            setIncludeAdmins(false);
                                        }}
                                        className="flex-1 px-4 py-2 bg-proxmox-hover hover:bg-proxmox-border rounded-lg text-white transition-colors"
                                        disabled={resetAllLoading}
                                    >
                                        {t('cancel')}
                                    </button>
                                    <button
                                        onClick={resetAllPasswords}
                                        disabled={resetAllLoading}
                                        className="flex-1 px-4 py-2 bg-red-500 hover:bg-red-600 rounded-lg text-white font-medium transition-colors disabled:opacity-50 flex items-center justify-center gap-2"
                                    >
                                        {resetAllLoading ? (
                                            <>
                                                <Icons.RotateCw className="w-4 h-4 animate-spin" />
                                                {t('processing') || 'Processing...'}
                                            </>
                                        ) : (
                                            t('resetAllPasswords') || 'Reset All Passwords'
                                        )}
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Locked IPs */}
                    <div className="bg-proxmox-dark border border-proxmox-border rounded-xl p-4">
                        <div className="flex items-center justify-between mb-4">
                            <h4 className="font-medium text-white flex items-center gap-2">
                                <Icons.Shield />
                                {t('lockedIps')}
                            </h4>
                            <div className="flex items-center gap-2">
                                <button
                                    onClick={fetchLockedIps}
                                    className="p-2 hover:bg-proxmox-hover rounded-lg text-gray-400 hover:text-white transition-colors"
                                    title="Refresh"
                                >
                                    <Icons.RefreshCw />
                                </button>
                                {lockedIps.length > 0 && (
                                    <button
                                        onClick={unlockAll}
                                        className="px-3 py-1.5 bg-red-500/20 text-red-400 hover:bg-red-500/30 rounded-lg text-sm transition-colors"
                                    >
                                        {t('unlockAll')}
                                    </button>
                                )}
                            </div>
                        </div>
                        {lockedIps.length === 0 ? (
                            <div className="text-center py-8 text-gray-500">
                                <Icons.CheckCircle className="w-12 h-12 mx-auto mb-3 text-green-500/50" />
                                <p>{t('noLockedIps')}</p>
                                <p className="text-xs mt-1">{t('allClear') || 'All systems operational'}</p>
                            </div>
                        ) : (
                            <div className="space-y-2">
                                {lockedIps.map(item => (
                                    <div key={item.ip} className="flex items-center justify-between p-3 bg-proxmox-darker rounded-lg border border-red-500/20">
                                        <div className="flex items-center gap-3">
                                            <div className="w-2 h-2 rounded-full bg-red-500 animate-pulse" />
                                            <div>
                                                <span className="font-mono text-white">{item.ip}</span>
                                                <div className="text-xs text-gray-500">
                                                    {item.attempt_count} {t('attempts')} ‚Ä¢ {item.remaining_seconds}s {t('remaining')}
                                                </div>
                                            </div>
                                        </div>
                                        <button
                                            onClick={() => unlockIp(item.ip)}
                                            className="px-4 py-2 bg-green-500/20 text-green-400 hover:bg-green-500/30 rounded-lg text-sm font-medium transition-colors"
                                        >
                                            {t('unlock')}
                                        </button>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>

                    {/* MK: Locked Users - username-based lockout protection */}
                    <div className="bg-proxmox-dark border border-proxmox-border rounded-xl p-4">
                        <div className="flex items-center justify-between mb-4">
                            <h4 className="font-medium text-white flex items-center gap-2">
                                <Icons.User />
                                {t('lockedUsers') || 'Locked Users'}
                            </h4>
                            <div className="flex items-center gap-2">
                                <button
                                    onClick={fetchLockedIps}
                                    className="p-2 hover:bg-proxmox-hover rounded-lg text-gray-400 hover:text-white transition-colors"
                                    title="Refresh"
                                >
                                    <Icons.RefreshCw />
                                </button>
                                {lockedUsers.length > 0 && (
                                    <button
                                        onClick={unlockAllUsers}
                                        className="px-3 py-1.5 bg-orange-500/20 text-orange-400 hover:bg-orange-500/30 rounded-lg text-sm transition-colors"
                                    >
                                        {t('unlockAll')}
                                    </button>
                                )}
                            </div>
                        </div>
                        <p className="text-xs text-gray-500 mb-3">
                            {t('lockedUsersDesc') || 'Accounts locked due to too many failed login attempts from any IP address.'}
                        </p>
                        {lockedUsers.length === 0 ? (
                            <div className="text-center py-6 text-gray-500">
                                <Icons.CheckCircle className="w-10 h-10 mx-auto mb-2 text-green-500/50" />
                                <p className="text-sm">{t('noLockedUsers') || 'No locked accounts'}</p>
                            </div>
                        ) : (
                            <div className="space-y-2">
                                {lockedUsers.map(item => (
                                    <div key={item.username} className="flex items-center justify-between p-3 bg-proxmox-darker rounded-lg border border-orange-500/20">
                                        <div className="flex items-center gap-3">
                                            <div className="w-2 h-2 rounded-full bg-orange-500 animate-pulse" />
                                            <div>
                                                <span className="font-medium text-white">{item.username}</span>
                                                <div className="text-xs text-gray-500">
                                                    {item.attempt_count} {t('attempts')} ‚Ä¢ {item.remaining_seconds}s {t('remaining')}
                                                </div>
                                            </div>
                                        </div>
                                        <button
                                            onClick={() => unlockUser(item.username)}
                                            className="px-4 py-2 bg-green-500/20 text-green-400 hover:bg-green-500/30 rounded-lg text-sm font-medium transition-colors"
                                        >
                                            {t('unlock')}
                                        </button>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>

                    {/* IP Whitelisting */}
                    <div className="bg-proxmox-dark rounded-xl p-6 border border-proxmox-border">
                        <h3 className="text-lg font-semibold text-white mb-4 flex items-center gap-2">
                            <Icons.Shield className="w-5 h-5 text-blue-400" />
                            {t('ipWhitelisting') || 'IP Whitelisting'}
                        </h3>
                        <IPWhitelistSection addToast={addToast} />
                    </div>

                    {/* Config Backup/Restore */}
                    <div className="bg-proxmox-dark rounded-xl p-6 border border-proxmox-border">
                        <h3 className="text-lg font-semibold text-white mb-4 flex items-center gap-2">
                            <Icons.Database className="w-5 h-5 text-green-400" />
                            {t('configBackupRestore') || 'Configuration Backup & Restore'}
                        </h3>
                        <ConfigBackupSection addToast={addToast} />
                    </div>
                </div>
            );
        }

        // Compliance & Key Management Section (HIPAA/ISO 27001)
        function ComplianceSection({ addToast }) {
            const { t } = useTranslation();
            const { getAuthHeaders, isAdmin } = useAuth();
            const [compliance, setCompliance] = useState(null);
            const [auditIntegrity, setAuditIntegrity] = useState(null);
            const [keyInfo, setKeyInfo] = useState(null);
            const [corsInfo, setCorsInfo] = useState(null);
            const [loading, setLoading] = useState(true);
            const [rotating, setRotating] = useState(false);
            const [checking, setChecking] = useState(false);

            useEffect(() => {
                fetchComplianceStatus();
            }, []);

            const fetchComplianceStatus = async () => {
                setLoading(true);
                try {
                    const [compRes, keyRes, corsRes] = await Promise.all([
                        fetch(`${API_URL}/security/compliance`, { credentials: 'include', headers: getAuthHeaders() }),
                        fetch(`${API_URL}/security/key-info`, { credentials: 'include', headers: getAuthHeaders() }),
                        fetch(`${API_URL}/security/cors`, { credentials: 'include', headers: getAuthHeaders() })
                    ]);
                    
                    if (compRes.ok) setCompliance(await compRes.json());
                    if (keyRes.ok) setKeyInfo(await keyRes.json());
                    if (corsRes.ok) setCorsInfo(await corsRes.json());
                } catch (e) {
                    console.error('Failed to fetch compliance status:', e);
                } finally {
                    setLoading(false);
                }
            };

            const checkAuditIntegrity = async () => {
                setChecking(true);
                try {
                    const res = await fetch(`${API_URL}/audit/integrity`, {
                        credentials: 'include',
                        headers: getAuthHeaders()
                    });
                    if (res.ok) {
                        const data = await res.json();
                        setAuditIntegrity(data);
                        if (data.potentially_tampered > 0) {
                            addToast(`‚ö†Ô∏è WARNING: ${data.potentially_tampered} audit entries may have been tampered!`, 'error');
                        } else {
                            addToast(`‚úì Audit log integrity verified: ${data.verified}/${data.total_entries} entries`, 'success');
                        }
                    }
                } catch (e) {
                    addToast('Failed to check audit integrity', 'error');
                } finally {
                    setChecking(false);
                }
            };

            const rotateKey = async () => {
                if (!confirm('Are you sure you want to rotate the encryption key?\n\nThis will re-encrypt all sensitive data with a new key.\nThe old key will be backed up.')) {
                    return;
                }
                
                setRotating(true);
                try {
                    const res = await fetch(`${API_URL}/security/key-rotate`, {
                        method: 'POST',
                        credentials: 'include',
                        headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
                        body: JSON.stringify({ confirm: true })
                    });
                    const data = await res.json();
                    
                    if (data.success) {
                        addToast(`Key rotation completed: ${data.users_rotated} users, ${data.clusters_rotated} clusters re-encrypted`, 'success');
                        fetchComplianceStatus();
                    } else {
                        addToast(`Key rotation failed: ${data.error}`, 'error');
                    }
                } catch (e) {
                    addToast('Key rotation failed', 'error');
                } finally {
                    setRotating(false);
                }
            };

            if (loading) {
                return (
                    <div className="flex justify-center py-8">
                        <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-proxmox-orange"></div>
                    </div>
                );
            }

            const getScoreColor = (score) => {
                if (score >= 90) return 'text-green-400';
                if (score >= 70) return 'text-yellow-400';
                return 'text-red-400';
            };

            return (
                <div className="space-y-6">
                    {/* Compliance Score */}
                    <div className="bg-proxmox-dark rounded-xl p-6 border border-proxmox-border">
                        <div className="flex items-center justify-between mb-4">
                            <h3 className="text-lg font-semibold text-white flex items-center gap-2">
                                <Icons.Check /> {t('complianceStatus') || 'Compliance Status'} (HIPAA/ISO 27001)
                            </h3>
                            {compliance && (
                                <div className={`text-3xl font-bold ${getScoreColor(compliance.compliance_score)}`}>
                                    {compliance.compliance_score}%
                                </div>
                            )}
                        </div>
                        
                        {compliance && (
                            <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                                {Object.entries(compliance.checks || {}).map(([key, value]) => (
                                    <div key={key} className={`p-3 rounded-lg ${value ? 'bg-green-500/10 border border-green-500/30' : 'bg-red-500/10 border border-red-500/30'}`}>
                                        <div className="flex items-center gap-2">
                                            {value ? <span className="text-green-400">‚úì</span> : <span className="text-red-400">‚úó</span>}
                                            <span className="text-sm text-gray-300">{key.replace(/_/g, ' ')}</span>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                        
                        {compliance?.recommendations?.length > 0 && (
                            <div className="mt-4 p-4 bg-yellow-500/10 border border-yellow-500/30 rounded-lg">
                                <h4 className="text-yellow-400 font-medium mb-2">{t('recommendations') || 'Recommendations'}</h4>
                                <ul className="text-sm text-gray-300 space-y-1">
                                    {compliance.recommendations.map((rec, i) => (
                                        <li key={i}>‚Ä¢ {rec}</li>
                                    ))}
                                </ul>
                            </div>
                        )}
                    </div>

                    {/* Audit Log Integrity */}
                    <div className="bg-proxmox-dark rounded-xl p-6 border border-proxmox-border">
                        <div className="flex items-center justify-between mb-4">
                            <h3 className="text-lg font-semibold text-white">{t('auditLogIntegrity') || 'Audit Log Integrity'} (HMAC-SHA256)</h3>
                            <button
                                onClick={checkAuditIntegrity}
                                disabled={checking}
                                className="px-4 py-2 bg-blue-500/20 text-blue-400 hover:bg-blue-500/30 rounded-lg text-sm font-medium transition-colors disabled:opacity-50"
                            >
                                {checking ? t('checking') || 'Checking...' : t('verifyIntegrity') || 'Verify Integrity'}
                            </button>
                        </div>
                        
                        {auditIntegrity && (
                            <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <div className="p-4 bg-proxmox-card rounded-lg border border-proxmox-border">
                                    <div className="text-2xl font-bold text-white">{auditIntegrity.total_entries}</div>
                                    <div className="text-sm text-gray-400">{t('totalEntries') || 'Total Entries'}</div>
                                </div>
                                <div className="p-4 bg-green-500/10 rounded-lg border border-green-500/30">
                                    <div className="text-2xl font-bold text-green-400">{auditIntegrity.verified}</div>
                                    <div className="text-sm text-gray-400">{t('verified') || 'Verified'}</div>
                                </div>
                                <div className="p-4 bg-yellow-500/10 rounded-lg border border-yellow-500/30">
                                    <div className="text-2xl font-bold text-yellow-400">{auditIntegrity.unsigned}</div>
                                    <div className="text-sm text-gray-400">{t('unsigned') || 'Unsigned (old)'}</div>
                                </div>
                                <div className={`p-4 rounded-lg border ${auditIntegrity.potentially_tampered > 0 ? 'bg-red-500/20 border-red-500' : 'bg-proxmox-card border-proxmox-border'}`}>
                                    <div className={`text-2xl font-bold ${auditIntegrity.potentially_tampered > 0 ? 'text-red-400' : 'text-gray-400'}`}>
                                        {auditIntegrity.potentially_tampered}
                                    </div>
                                    <div className="text-sm text-gray-400">{t('tampered') || 'Potentially Tampered'}</div>
                                </div>
                            </div>
                        )}
                    </div>

                    {/* Encryption Key Management */}
                    <div className="bg-proxmox-dark rounded-xl p-6 border border-proxmox-border">
                        <div className="flex items-center justify-between mb-4">
                            <h3 className="text-lg font-semibold text-white">{t('encryptionKey') || 'Encryption Key'} (AES-256-GCM)</h3>
                            <button
                                onClick={rotateKey}
                                disabled={rotating}
                                className="px-4 py-2 bg-orange-500/20 text-orange-400 hover:bg-orange-500/30 rounded-lg text-sm font-medium transition-colors disabled:opacity-50"
                            >
                                {rotating ? t('rotating') || 'Rotating...' : t('rotateKey') || 'Rotate Key'}
                            </button>
                        </div>
                        
                        {keyInfo && (
                            <div className="space-y-3">
                                <div className="flex justify-between text-sm">
                                    <span className="text-gray-400">{t('algorithm') || 'Algorithm'}:</span>
                                    <span className="text-white font-mono">{keyInfo.algorithm || 'AES-256-GCM'}</span>
                                </div>
                                <div className="flex justify-between text-sm">
                                    <span className="text-gray-400">{t('keySize') || 'Key Size'}:</span>
                                    <span className="text-white">{keyInfo.key_size_bits || 256} bits</span>
                                </div>
                                <div className="flex justify-between text-sm">
                                    <span className="text-gray-400">{t('created') || 'Created'}:</span>
                                    <span className="text-white">{keyInfo.created ? new Date(keyInfo.created).toLocaleString() : 'Unknown'}</span>
                                </div>
                                <div className="flex justify-between text-sm">
                                    <span className="text-gray-400">{t('lastRotation') || 'Last Rotation'}:</span>
                                    <span className="text-white">{keyInfo.last_modified ? new Date(keyInfo.last_modified).toLocaleString() : 'Never'}</span>
                                </div>
                                <div className="flex justify-between text-sm">
                                    <span className="text-gray-400">{t('backups') || 'Backups'}:</span>
                                    <span className="text-white">{keyInfo.backups?.length || 0}</span>
                                </div>
                            </div>
                        )}
                    </div>

                    {/* CORS Configuration */}
                    <div className="bg-proxmox-dark rounded-xl p-6 border border-proxmox-border">
                        <h3 className="text-lg font-semibold text-white mb-4">{t('corsConfiguration') || 'CORS Configuration'}</h3>
                        
                        {corsInfo && (
                            <div className="space-y-3">
                                <div className="flex justify-between text-sm">
                                    <span className="text-gray-400">{t('mode') || 'Mode'}:</span>
                                    <span className={`font-medium ${corsInfo.mode === 'same-origin' ? 'text-green-400' : 'text-yellow-400'}`}>
                                        {corsInfo.mode === 'same-origin' ? 'üîí Same-Origin Only (Most Secure)' : '‚öôÔ∏è Configured Origins'}
                                    </span>
                                </div>
                                
                                {corsInfo.all_allowed?.length > 0 && (
                                    <div>
                                        <span className="text-gray-400 text-sm">{t('allowedOrigins') || 'Allowed Origins'}:</span>
                                        <div className="mt-2 space-y-1">
                                            {corsInfo.all_allowed.map((origin, i) => (
                                                <div key={i} className="text-sm font-mono bg-proxmox-card px-3 py-1 rounded border border-proxmox-border">
                                                    {origin}
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}
                                
                                <div className="mt-4 p-3 bg-blue-500/10 border border-blue-500/30 rounded-lg text-sm text-gray-300">
                                    <strong className="text-blue-400">Tip:</strong> For permanent CORS configuration, set the environment variable:
                                    <code className="block mt-1 bg-proxmox-card px-2 py-1 rounded font-mono text-xs">
                                        export PEGAPROX_ALLOWED_ORIGINS="https://your-domain.com"
                                    </code>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        // IP Whitelist Management Component
        // LW: Jan 2026 - Enterprise feature, be careful with this
        // NS: Make sure you add your own IP before enabling lol
        function IPWhitelistSection({ addToast }) {
            const { t } = useTranslation();
            const { getAuthHeaders } = useAuth();
            const [config, setConfig] = useState(null);
            const [loading, setLoading] = useState(true);
            const [saving, setSaving] = useState(false);
            const [newWhitelistIP, setNewWhitelistIP] = useState('');
            const [newBlacklistIP, setNewBlacklistIP] = useState('');
            const [testIP, setTestIP] = useState('');
            const [testResult, setTestResult] = useState(null);

            useEffect(() => {
                fetchConfig();
            }, []);

            const fetchConfig = async () => {
                try {
                    const res = await fetch(`${API_URL}/security/ip-whitelist`, {
                        credentials: 'include',
                        headers: getAuthHeaders()
                    });
                    if (res.ok) {
                        setConfig(await res.json());
                    }
                } catch (e) {
                    console.error('Failed to fetch IP whitelist:', e);
                } finally {
                    setLoading(false);
                }
            };

            const saveConfig = async (newConfig) => {
                setSaving(true);
                try {
                    const res = await fetch(`${API_URL}/security/ip-whitelist`, {
                        method: 'POST',
                        credentials: 'include',
                        headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
                        body: JSON.stringify(newConfig)
                    });
                    const data = await res.json();
                    
                    if (res.ok) {
                        addToast(t('saved') || 'Saved successfully', 'success');
                        fetchConfig();
                    } else {
                        addToast(data.error || 'Failed to save', 'error');
                    }
                } catch (e) {
                    addToast('Failed to save', 'error');
                } finally {
                    setSaving(false);
                }
            };

            const addToWhitelist = () => {
                if (!newWhitelistIP.trim()) return;
                const updated = [...(config?.whitelist || []), newWhitelistIP.trim()];
                saveConfig({ ...config, whitelist: updated });
                setNewWhitelistIP('');
            };

            const removeFromWhitelist = (ip) => {
                const updated = (config?.whitelist || []).filter(i => i !== ip);
                saveConfig({ ...config, whitelist: updated });
            };

            const addToBlacklist = () => {
                if (!newBlacklistIP.trim()) return;
                const updated = [...(config?.blacklist || []), newBlacklistIP.trim()];
                saveConfig({ ...config, blacklist: updated });
                setNewBlacklistIP('');
            };

            const removeFromBlacklist = (ip) => {
                const updated = (config?.blacklist || []).filter(i => i !== ip);
                saveConfig({ ...config, blacklist: updated });
            };

            const testIPAccess = async () => {
                if (!testIP.trim()) return;
                try {
                    const res = await fetch(`${API_URL}/security/ip-whitelist/test`, {
                        method: 'POST',
                        credentials: 'include',
                        headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
                        body: JSON.stringify({ ip: testIP.trim() })
                    });
                    if (res.ok) {
                        setTestResult(await res.json());
                    }
                } catch (e) {
                    console.error('Test failed:', e);
                }
            };

            if (loading) {
                return <div className="animate-pulse h-20 bg-proxmox-card rounded"></div>;
            }

            // Show error state if config failed to load
            if (!config) {
                return (
                    <div className="p-4 bg-red-500/10 border border-red-500/30 rounded-lg text-red-400">
                        <p>{t('failedToLoad') || 'Failed to load IP whitelist configuration.'}</p>
                        <button 
                            onClick={fetchConfig}
                            className="mt-2 px-3 py-1 bg-red-500/20 hover:bg-red-500/30 rounded text-sm"
                        >
                            {t('retry') || 'Retry'}
                        </button>
                    </div>
                );
            }

            return (
                <div className="space-y-4">
                    {/* Enable/Disable Toggle */}
                    <div className="flex items-center justify-between p-4 bg-proxmox-card rounded-lg border border-proxmox-border">
                        <div>
                            <div className="font-medium text-white">{t('enableIPWhitelist') || 'Enable IP Whitelist'}</div>
                            <div className="text-sm text-gray-400">{t('ipWhitelistDesc') || 'Only allow access from specific IP addresses'}</div>
                        </div>
                        <button
                            onClick={() => saveConfig({ ...config, enabled: !config?.enabled })}
                            disabled={saving}
                            className={`relative w-12 h-6 rounded-full transition-colors ${
                                config?.enabled ? 'bg-green-500' : 'bg-gray-600'
                            }`}
                        >
                            <span className={`absolute top-0.5 left-0.5 w-5 h-5 bg-white rounded-full transition-transform shadow ${
                                config?.enabled ? 'translate-x-6' : 'translate-x-0'
                            }`}></span>
                        </button>
                    </div>

                    {/* Your IP */}
                    <div className="p-3 bg-blue-500/10 border border-blue-500/30 rounded-lg text-sm">
                        <span className="text-gray-400">{t('yourIP') || 'Your current IP'}:</span>
                        <span className="ml-2 font-mono text-white">{config?.your_ip}</span>
                    </div>

                    {/* Whitelist */}
                    <div className="space-y-2">
                        <label className="text-sm font-medium text-gray-300">{t('whitelist') || 'Whitelist'} ({t('allowedIPs') || 'Allowed IPs'})</label>
                        <div className="flex gap-2">
                            <input
                                type="text"
                                value={newWhitelistIP}
                                onChange={(e) => setNewWhitelistIP(e.target.value)}
                                placeholder="192.168.1.0/24 or 10.0.0.*"
                                className="flex-1 px-3 py-2 bg-proxmox-card border border-proxmox-border rounded-lg text-white text-sm"
                                onKeyDown={(e) => e.key === 'Enter' && addToWhitelist()}
                            />
                            <button
                                onClick={addToWhitelist}
                                disabled={saving || !newWhitelistIP.trim()}
                                className="px-4 py-2 bg-green-500/20 text-green-400 hover:bg-green-500/30 rounded-lg text-sm disabled:opacity-50"
                            >
                                {t('add') || 'Add'}
                            </button>
                        </div>
                        {config?.whitelist?.length > 0 && (
                            <div className="flex flex-wrap gap-2 mt-2">
                                {config.whitelist.map((ip, i) => (
                                    <span key={i} className="inline-flex items-center gap-1 px-3 py-1 bg-green-500/10 border border-green-500/30 rounded-full text-sm text-green-400">
                                        {ip}
                                        <button onClick={() => removeFromWhitelist(ip)} className="ml-1 text-red-400 hover:text-red-300">√ó</button>
                                    </span>
                                ))}
                            </div>
                        )}
                    </div>

                    {/* Blacklist */}
                    <div className="space-y-2">
                        <label className="text-sm font-medium text-gray-300">{t('blacklist') || 'Blacklist'} ({t('blockedIPs') || 'Always Blocked'})</label>
                        <div className="flex gap-2">
                            <input
                                type="text"
                                value={newBlacklistIP}
                                onChange={(e) => setNewBlacklistIP(e.target.value)}
                                placeholder="192.168.1.100"
                                className="flex-1 px-3 py-2 bg-proxmox-card border border-proxmox-border rounded-lg text-white text-sm"
                                onKeyDown={(e) => e.key === 'Enter' && addToBlacklist()}
                            />
                            <button
                                onClick={addToBlacklist}
                                disabled={saving || !newBlacklistIP.trim()}
                                className="px-4 py-2 bg-red-500/20 text-red-400 hover:bg-red-500/30 rounded-lg text-sm disabled:opacity-50"
                            >
                                {t('add') || 'Add'}
                            </button>
                        </div>
                        {config?.blacklist?.length > 0 && (
                            <div className="flex flex-wrap gap-2 mt-2">
                                {config.blacklist.map((ip, i) => (
                                    <span key={i} className="inline-flex items-center gap-1 px-3 py-1 bg-red-500/10 border border-red-500/30 rounded-full text-sm text-red-400">
                                        {ip}
                                        <button onClick={() => removeFromBlacklist(ip)} className="ml-1 text-gray-400 hover:text-gray-300">√ó</button>
                                    </span>
                                ))}
                            </div>
                        )}
                    </div>

                    {/* Test IP */}
                    <div className="space-y-2 pt-4 border-t border-proxmox-border">
                        <label className="text-sm font-medium text-gray-300">{t('testIP') || 'Test IP Access'}</label>
                        <div className="flex gap-2">
                            <input
                                type="text"
                                value={testIP}
                                onChange={(e) => setTestIP(e.target.value)}
                                placeholder="Enter IP to test"
                                className="flex-1 px-3 py-2 bg-proxmox-card border border-proxmox-border rounded-lg text-white text-sm"
                                onKeyDown={(e) => e.key === 'Enter' && testIPAccess()}
                            />
                            <button
                                onClick={testIPAccess}
                                disabled={!testIP.trim()}
                                className="px-4 py-2 bg-blue-500/20 text-blue-400 hover:bg-blue-500/30 rounded-lg text-sm disabled:opacity-50"
                            >
                                {t('test') || 'Test'}
                            </button>
                        </div>
                        {testResult && (
                            <div className={`p-3 rounded-lg text-sm ${testResult.allowed ? 'bg-green-500/10 border border-green-500/30 text-green-400' : 'bg-red-500/10 border border-red-500/30 text-red-400'}`}>
                                <strong>{testResult.ip}:</strong> {testResult.allowed ? '‚úì Allowed' : '‚úó Blocked'} - {testResult.reason}
                            </div>
                        )}
                    </div>

                    {/* Supported Formats */}
                    <div className="text-xs text-gray-500 mt-2">
                        {t('supportedFormats') || 'Supported formats'}: Single IP (192.168.1.100), CIDR (192.168.1.0/24), Wildcard (192.168.1.*)
                    </div>
                </div>
            );
        }

        // Config Backup/Restore Component
        // NS: Jan 2026 - encrypted backups with AES-256-GCM
        // NS: Double password (user + backup) for security
        function ConfigBackupSection({ addToast }) {
            const { t } = useTranslation();
            const { getAuthHeaders } = useAuth();
            const [exporting, setExporting] = useState(false);
            const [importing, setImporting] = useState(false);
            const [includeSecrets, setIncludeSecrets] = useState(false);  // LW: off by default for safety
            const [includeUsers, setIncludeUsers] = useState(true);
            const [includeAudit, setIncludeAudit] = useState(false);
            const [restoreMode, setRestoreMode] = useState('merge');  // NS: merge is safer than overwrite
            const [restoreUsers, setRestoreUsers] = useState(false);
            const [dryRun, setDryRun] = useState(true);  // NS: dry run by default, dont want accidents
            const [lastResult, setLastResult] = useState(null);
            const fileInputRef = React.useRef(null);
            
            // Security: Password fields
            const [showExportModal, setShowExportModal] = useState(false);
            const [showImportModal, setShowImportModal] = useState(false);
            const [userPassword, setUserPassword] = useState('');
            const [backupPassword, setBackupPassword] = useState('');
            const [backupPasswordConfirm, setBackupPasswordConfirm] = useState('');
            const [selectedFile, setSelectedFile] = useState(null);

            const exportConfig = async () => {
                if (!userPassword) {
                    addToast(t('passwordRequired') || 'Password required', 'error');
                    return;
                }
                if (!backupPassword || backupPassword.length < 8) {
                    addToast(t('backupPasswordMin8') || 'Backup password must be at least 8 characters', 'error');
                    return;
                }
                if (backupPassword !== backupPasswordConfirm) {
                    addToast(t('passwordsNoMatch') || 'Passwords do not match', 'error');
                    return;
                }
                
                setExporting(true);
                try {
                    const res = await fetch(`${API_URL}/config/backup`, {
                        method: 'POST',
                        credentials: 'include',
                        headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            user_password: userPassword,
                            backup_password: backupPassword,
                            include_secrets: includeSecrets,
                            include_users: includeUsers,
                            include_audit: includeAudit
                        })
                    });
                    
                    if (res.ok) {
                        const blob = await res.blob();
                        if (blob.size === 0) {
                            addToast('Backup file is empty', 'error');
                            return;
                        }
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `pegaprox-backup-${new Date().toISOString().split('T')[0]}.pegabackup`;
                        a.style.display = 'none';
                        document.body.appendChild(a);
                        a.click();
                        setTimeout(() => {
                            window.URL.revokeObjectURL(url);
                            a.remove();
                        }, 100);
                        addToast(t('backupDownloaded') || 'Encrypted backup downloaded', 'success');
                        setShowExportModal(false);
                        setUserPassword('');
                        setBackupPassword('');
                        setBackupPasswordConfirm('');
                    } else {
                        // Try to parse error response
                        let errMsg = `Export failed (${res.status})`;
                        try {
                            const err = await res.json();
                            errMsg = err.error || errMsg;
                        } catch (e) {
                            // Response might not be JSON
                            const text = await res.text();
                            if (text) errMsg = text;
                        }
                        addToast(errMsg, 'error');
                    }
                } catch (e) {
                    console.error('Backup export error:', e);
                    addToast('Export failed: ' + e.message, 'error');
                } finally {
                    setExporting(false);
                }
            };

            const importConfig = async () => {
                if (!userPassword) {
                    addToast(t('passwordRequired') || 'Password required', 'error');
                    return;
                }
                if (!backupPassword) {
                    addToast(t('backupPasswordRequired') || 'Backup password required', 'error');
                    return;
                }
                if (!selectedFile) {
                    addToast(t('selectFile') || 'Please select a file', 'error');
                    return;
                }
                
                setImporting(true);
                setLastResult(null);
                try {
                    const formData = new FormData();
                    formData.append('user_password', userPassword);
                    formData.append('backup_password', backupPassword);
                    formData.append('backup_file', selectedFile);
                    formData.append('mode', restoreMode);
                    formData.append('restore_users', restoreUsers);
                    formData.append('dry_run', dryRun);
                    
                    const res = await fetch(`${API_URL}/config/restore`, {
                        method: 'POST',
                        credentials: 'include',
                        headers: getAuthHeaders(),  // Don't set Content-Type for FormData
                        body: formData
                    });
                    
                    const result = await res.json().catch(() => ({ error: `Server error (${res.status})` }));
                    setLastResult(result);
                    
                    if (res.ok) {
                        if (dryRun) {
                            addToast(t('dryRunComplete') || 'Dry run complete - check results below', 'info');
                        } else {
                            addToast(t('restoreComplete') || 'Configuration restored', 'success');
                        }
                        setShowImportModal(false);
                        setUserPassword('');
                        setBackupPassword('');
                        setSelectedFile(null);
                    } else {
                        console.error('Restore error:', result);
                        addToast(result.error || `Restore failed (${res.status})`, 'error');
                    }
                } catch (e) {
                    console.error('Import exception:', e);
                    addToast('Import failed: ' + e.message, 'error');
                } finally {
                    setImporting(false);
                    if (fileInputRef.current) fileInputRef.current.value = '';
                }
            };

            return (
                <div className="space-y-6">
                    {/* Security Notice */}
                    <div className="p-3 bg-green-500/10 border border-green-500/30 rounded-lg text-sm text-gray-300">
                        <strong className="text-green-400">üîí {t('secureBackup') || 'Secure Backup'}:</strong> {t('secureBackupDesc') || 'Backups are encrypted with AES-256-GCM. You must provide your password and a backup encryption password.'}
                    </div>
                    
                    {/* Export Section */}
                    <div className="space-y-4">
                        <h4 className="font-medium text-white">{t('exportConfig') || 'Export Configuration'}</h4>
                        
                        <div className="space-y-2">
                            <label className="flex items-center gap-2 text-sm text-gray-300 cursor-pointer">
                                <input
                                    type="checkbox"
                                    checked={includeUsers}
                                    onChange={(e) => setIncludeUsers(e.target.checked)}
                                    className="rounded border-gray-600 bg-proxmox-card text-proxmox-orange focus:ring-proxmox-orange"
                                />
                                {t('includeUsers') || 'Include user accounts'}
                            </label>
                            <label className="flex items-center gap-2 text-sm text-gray-300 cursor-pointer">
                                <input
                                    type="checkbox"
                                    checked={includeSecrets}
                                    onChange={(e) => setIncludeSecrets(e.target.checked)}
                                    className="rounded border-gray-600 bg-proxmox-card text-proxmox-orange focus:ring-proxmox-orange"
                                />
                                {t('includeSecrets') || 'Include passwords & secrets'} 
                                <span className="text-yellow-500 text-xs">(‚ö†Ô∏è {t('sensitive') || 'Sensitive'})</span>
                            </label>
                            <label className="flex items-center gap-2 text-sm text-gray-300 cursor-pointer">
                                <input
                                    type="checkbox"
                                    checked={includeAudit}
                                    onChange={(e) => setIncludeAudit(e.target.checked)}
                                    className="rounded border-gray-600 bg-proxmox-card text-proxmox-orange focus:ring-proxmox-orange"
                                />
                                {t('includeAuditLog') || 'Include audit log'} 
                                <span className="text-gray-500 text-xs">({t('canBeLarge') || 'Can be large'})</span>
                            </label>
                        </div>
                        
                        <button
                            onClick={() => setShowExportModal(true)}
                            className="flex items-center gap-2 px-4 py-2 bg-blue-500/20 text-blue-400 hover:bg-blue-500/30 rounded-lg text-sm font-medium transition-colors"
                        >
                            <Icons.Download className="w-4 h-4" /> {t('createBackup') || 'Create Backup'}
                        </button>
                    </div>

                    {/* Import Section */}
                    <div className="space-y-4 pt-4 border-t border-proxmox-border">
                        <h4 className="font-medium text-white">{t('importConfig') || 'Import Configuration'}</h4>
                        
                        <div className="space-y-3">
                            <div className="flex gap-4">
                                <label className="flex items-center gap-2 text-sm text-gray-300 cursor-pointer">
                                    <input
                                        type="radio"
                                        name="restoreMode"
                                        checked={restoreMode === 'merge'}
                                        onChange={() => setRestoreMode('merge')}
                                        className="border-gray-600 bg-proxmox-card text-proxmox-orange focus:ring-proxmox-orange"
                                    />
                                    {t('merge') || 'Merge'} <span className="text-gray-500 text-xs">({t('keepExisting') || 'Keep existing'})</span>
                                </label>
                                <label className="flex items-center gap-2 text-sm text-gray-300 cursor-pointer">
                                    <input
                                        type="radio"
                                        name="restoreMode"
                                        checked={restoreMode === 'overwrite'}
                                        onChange={() => setRestoreMode('overwrite')}
                                        className="border-gray-600 bg-proxmox-card text-proxmox-orange focus:ring-proxmox-orange"
                                    />
                                    {t('overwrite') || 'Overwrite'} <span className="text-red-500 text-xs">({t('replaceAll') || 'Replace all'})</span>
                                </label>
                            </div>
                            
                            <label className="flex items-center gap-2 text-sm text-gray-300 cursor-pointer">
                                <input
                                    type="checkbox"
                                    checked={restoreUsers}
                                    onChange={(e) => setRestoreUsers(e.target.checked)}
                                    className="rounded border-gray-600 bg-proxmox-card text-proxmox-orange focus:ring-proxmox-orange"
                                />
                                {t('restoreUsers') || 'Restore user accounts'} 
                                <span className="text-yellow-500 text-xs">(‚ö†Ô∏è {t('notAdmin') || 'Excluding admin'})</span>
                            </label>
                            
                            <label className="flex items-center gap-2 text-sm text-gray-300 cursor-pointer">
                                <input
                                    type="checkbox"
                                    checked={dryRun}
                                    onChange={(e) => setDryRun(e.target.checked)}
                                    className="rounded border-gray-600 bg-proxmox-card text-proxmox-orange focus:ring-proxmox-orange"
                                />
                                {t('dryRun') || 'Dry run'} 
                                <span className="text-green-500 text-xs">({t('validateOnly') || 'Validate only, don\'t apply'})</span>
                            </label>
                        </div>
                        
                        <button
                            onClick={() => setShowImportModal(true)}
                            className="flex items-center gap-2 px-4 py-2 bg-orange-500/20 text-orange-400 hover:bg-orange-500/30 rounded-lg text-sm font-medium transition-colors"
                        >
                            <Icons.Upload className="w-4 h-4" /> {t('restoreBackup') || 'Restore from Backup'}
                        </button>
                    </div>

                    {/* Results */}
                    {lastResult && (
                        <div className={`p-4 rounded-lg border ${lastResult.errors?.length > 0 ? 'bg-yellow-500/10 border-yellow-500/30' : 'bg-green-500/10 border-green-500/30'}`}>
                            <h5 className="font-medium text-white mb-2">
                                {lastResult.dry_run ? (t('dryRunResults') || 'Dry Run Results') : (t('restoreResults') || 'Restore Results')}
                            </h5>
                            <div className="text-sm text-gray-300 space-y-1">
                                <div>{t('backupVersion') || 'Backup version'}: {lastResult.backup_version}</div>
                                <div>{t('backupDate') || 'Backup date'}: {new Date(lastResult.backup_date).toLocaleString()}</div>
                                <div>{t('backupBy') || 'Created by'}: {lastResult.backup_by}</div>
                                <div>{t('mode') || 'Mode'}: {lastResult.mode}</div>
                                
                                {Object.keys(lastResult.restored || {}).length > 0 && (
                                    <div className="mt-2">
                                        <strong className="text-green-400">{t('restored') || 'Restored'}:</strong>
                                        <ul className="ml-4">
                                            {Object.entries(lastResult.restored).map(([key, val]) => (
                                                <li key={key}>{key}: {val === true ? '‚úì' : val}</li>
                                            ))}
                                        </ul>
                                    </div>
                                )}
                                
                                {Object.keys(lastResult.skipped || {}).length > 0 && (
                                    <div className="mt-2">
                                        <strong className="text-yellow-400">{t('skipped') || 'Skipped'}:</strong>
                                        <ul className="ml-4">
                                            {Object.entries(lastResult.skipped).map(([key, val]) => (
                                                <li key={key}>{key}: {val}</li>
                                            ))}
                                        </ul>
                                    </div>
                                )}
                                
                                {lastResult.errors?.length > 0 && (
                                    <div className="mt-2">
                                        <strong className="text-red-400">{t('errors') || 'Errors'}:</strong>
                                        <ul className="ml-4 text-red-300">
                                            {lastResult.errors.map((err, i) => (
                                                <li key={i}>{err}</li>
                                            ))}
                                        </ul>
                                    </div>
                                )}
                            </div>
                        </div>
                    )}

                    {/* Export Modal */}
                    {showExportModal && (
                        <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50">
                            <div className="bg-proxmox-dark border border-proxmox-border rounded-xl p-6 max-w-md w-full mx-4 space-y-4">
                                <div className="flex justify-between items-center">
                                    <h3 className="text-lg font-semibold text-white">üîê {t('securityVerification') || 'Security Verification'}</h3>
                                    <button onClick={() => { setShowExportModal(false); setUserPassword(''); setBackupPassword(''); setBackupPasswordConfirm(''); }} className="text-gray-400 hover:text-white">√ó</button>
                                </div>
                                
                                <p className="text-sm text-gray-400">{t('exportSecurityDesc') || 'To create an encrypted backup, please verify your identity and set a backup password.'}</p>
                                
                                <div className="space-y-3">
                                    <div>
                                        <label className="block text-sm font-medium text-gray-300 mb-1">{t('yourPassword') || 'Your Password'}</label>
                                        <input
                                            type="password"
                                            value={userPassword}
                                            onChange={(e) => setUserPassword(e.target.value)}
                                            placeholder={t('enterYourPassword') || 'Enter your account password'}
                                            className="w-full px-3 py-2 bg-proxmox-card border border-proxmox-border rounded-lg text-white"
                                        />
                                    </div>
                                    
                                    <div>
                                        <label className="block text-sm font-medium text-gray-300 mb-1">{t('backupPassword') || 'Backup Password'}</label>
                                        <input
                                            type="password"
                                            value={backupPassword}
                                            onChange={(e) => setBackupPassword(e.target.value)}
                                            placeholder={t('backupPasswordPlaceholder') || 'Min. 8 characters - remember this!'}
                                            className="w-full px-3 py-2 bg-proxmox-card border border-proxmox-border rounded-lg text-white"
                                        />
                                    </div>
                                    
                                    <div>
                                        <label className="block text-sm font-medium text-gray-300 mb-1">{t('confirmBackupPassword') || 'Confirm Backup Password'}</label>
                                        <input
                                            type="password"
                                            value={backupPasswordConfirm}
                                            onChange={(e) => setBackupPasswordConfirm(e.target.value)}
                                            placeholder={t('repeatBackupPassword') || 'Repeat backup password'}
                                            className={`w-full px-3 py-2 bg-proxmox-card border rounded-lg text-white ${backupPasswordConfirm && backupPassword !== backupPasswordConfirm ? 'border-red-500' : 'border-proxmox-border'}`}
                                        />
                                    </div>
                                </div>
                                
                                <div className="p-3 bg-yellow-500/10 border border-yellow-500/30 rounded-lg text-sm text-yellow-300">
                                    ‚ö†Ô∏è {t('rememberBackupPassword') || 'Remember the backup password! Without it, you cannot restore the backup.'}
                                </div>
                                
                                <div className="flex gap-3 pt-2">
                                    <button
                                        onClick={() => { setShowExportModal(false); setUserPassword(''); setBackupPassword(''); setBackupPasswordConfirm(''); }}
                                        className="flex-1 px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-500"
                                    >
                                        {t('cancel') || 'Cancel'}
                                    </button>
                                    <button
                                        onClick={exportConfig}
                                        disabled={exporting || !userPassword || backupPassword.length < 8 || backupPassword !== backupPasswordConfirm}
                                        className="flex-1 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 disabled:opacity-50 disabled:cursor-not-allowed"
                                    >
                                        {exporting ? t('exporting') || 'Exporting...' : t('downloadBackup') || 'Download Backup'}
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Import Modal */}
                    {showImportModal && (
                        <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50">
                            <div className="bg-proxmox-dark border border-proxmox-border rounded-xl p-6 max-w-md w-full mx-4 space-y-4">
                                <div className="flex justify-between items-center">
                                    <h3 className="text-lg font-semibold text-white">üîê {t('restoreFromBackup') || 'Restore from Backup'}</h3>
                                    <button onClick={() => { setShowImportModal(false); setUserPassword(''); setBackupPassword(''); setSelectedFile(null); }} className="text-gray-400 hover:text-white">√ó</button>
                                </div>
                                
                                <p className="text-sm text-gray-400">{t('importSecurityDesc') || 'To restore a backup, please verify your identity and enter the backup password.'}</p>
                                
                                <div className="space-y-3">
                                    <div>
                                        <label className="block text-sm font-medium text-gray-300 mb-1">{t('backupFile') || 'Backup File'}</label>
                                        <input
                                            ref={fileInputRef}
                                            type="file"
                                            accept=".pegabackup,.json"
                                            onChange={(e) => setSelectedFile(e.target.files?.[0] || null)}
                                            className="w-full px-3 py-2 bg-proxmox-card border border-proxmox-border rounded-lg text-white file:mr-4 file:py-1 file:px-3 file:rounded file:border-0 file:bg-proxmox-orange file:text-white file:cursor-pointer"
                                        />
                                        {selectedFile && (
                                            <p className="text-xs text-gray-400 mt-1">üìé {selectedFile.name} ({(selectedFile.size / 1024).toFixed(1)} KB)</p>
                                        )}
                                    </div>
                                    
                                    <div>
                                        <label className="block text-sm font-medium text-gray-300 mb-1">{t('yourPassword') || 'Your Password'}</label>
                                        <input
                                            type="password"
                                            value={userPassword}
                                            onChange={(e) => setUserPassword(e.target.value)}
                                            placeholder={t('enterYourPassword') || 'Enter your account password'}
                                            className="w-full px-3 py-2 bg-proxmox-card border border-proxmox-border rounded-lg text-white"
                                        />
                                    </div>
                                    
                                    <div>
                                        <label className="block text-sm font-medium text-gray-300 mb-1">{t('backupPassword') || 'Backup Password'}</label>
                                        <input
                                            type="password"
                                            value={backupPassword}
                                            onChange={(e) => setBackupPassword(e.target.value)}
                                            placeholder={t('backupPasswordUsedWhenCreating') || 'Password used when creating backup'}
                                            className="w-full px-3 py-2 bg-proxmox-card border border-proxmox-border rounded-lg text-white"
                                        />
                                    </div>
                                </div>
                                
                                <div className="flex gap-3 pt-2">
                                    <button
                                        onClick={() => { setShowImportModal(false); setUserPassword(''); setBackupPassword(''); setSelectedFile(null); }}
                                        className="flex-1 px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-500"
                                    >
                                        {t('cancel') || 'Cancel'}
                                    </button>
                                    <button
                                        onClick={importConfig}
                                        disabled={importing || !userPassword || !backupPassword || !selectedFile}
                                        className="flex-1 px-4 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 disabled:opacity-50 disabled:cursor-not-allowed"
                                    >
                                        {importing ? t('importing') || 'Importing...' : (dryRun ? t('validateBackup') || 'Validate Backup' : t('restoreBackup') || 'Restore Backup')}
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }
        
        // NS: Excluded VMs List Component for Balancing Config
        // LW: Users wanted to exclude certain VMs from auto-migration (pinned VMs, etc)
        // TODO(MK): Add bulk exclude/include
        function ExcludedVMsList({ clusterId, clusterMetrics, addToast, getAuthHeaders }) {
            const { t } = useTranslation();
            const [excludedVMs, setExcludedVMs] = useState([]);
            const [loading, setLoading] = useState(true);
            const [allVMs, setAllVMs] = useState([]);
            
            // Fetch excluded VMs
            const fetchExcludedVMs = async () => {
                try {
                    const res = await fetch(`${API_URL}/clusters/${clusterId}/excluded-vms`, {
                        credentials: 'include',
                        headers: getAuthHeaders()
                    });
                    if (res.ok) {
                        const data = await res.json();
                        setExcludedVMs(data.excluded_vms || []);
                    }
                } catch (e) {
                    console.error('Error fetching excluded VMs:', e);
                }
                setLoading(false);
            };
            
            // Fetch all VMs for dropdown
            const fetchAllVMs = async () => {
                try {
                    const res = await fetch(`${API_URL}/clusters/${clusterId}/vms`, {
                        credentials: 'include',
                        headers: getAuthHeaders()
                    });
                    if (res.ok) {
                        const data = await res.json();
                        setAllVMs(data.vms || data || []);
                    }
                } catch (e) {
                    console.error('Error fetching VMs:', e);
                }
            };
            
            useEffect(() => {
                fetchExcludedVMs();
                fetchAllVMs();
            }, [clusterId]);
            
            const excludeVM = async (vmid, vmName) => {
                try {
                    const res = await fetch(`${API_URL}/clusters/${clusterId}/excluded-vms/${vmid}`, {
                        method: 'POST',
                        credentials: 'include',
                        headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
                        body: JSON.stringify({ reason: 'Manually excluded' })
                    });
                    if (res.ok) {
                        addToast(`${vmName || vmid} ${t('excludedFromBalancing') || 'excluded from balancing'}`, 'success');
                        fetchExcludedVMs();
                    }
                } catch (e) {
                    console.error(e);
                }
            };
            
            const includeVM = async (vmid, vmName) => {
                try {
                    const res = await fetch(`${API_URL}/clusters/${clusterId}/excluded-vms/${vmid}`, {
                        method: 'DELETE',
                        credentials: 'include',
                        headers: getAuthHeaders()
                    });
                    if (res.ok) {
                        addToast(`${vmName || vmid} ${t('reincludedInBalancing') || 're-included in balancing'}`, 'success');
                        fetchExcludedVMs();
                    }
                } catch (e) {
                    console.error(e);
                }
            };
            
            const excludedVmIds = excludedVMs.map(v => v.vmid);
            const availableVMs = allVMs.filter(vm => !excludedVmIds.includes(vm.vmid));
            
            if (loading) {
                return <div className="text-xs text-gray-500">{t('loading')}...</div>;
            }
            
            return (
                <div>
                    {/* Current excluded VMs */}
                    {excludedVMs.length > 0 ? (
                        <div className="space-y-2 mb-3">
                            {excludedVMs.map(vm => (
                                <div key={vm.vmid} className="flex items-center justify-between bg-proxmox-dark rounded-lg p-2">
                                    <div className="flex items-center gap-2">
                                        <Icons.Monitor className="w-4 h-4 text-red-400" />
                                        <span className="text-sm">{vm.name || `VM ${vm.vmid}`}</span>
                                        <span className="text-xs text-gray-500">({vm.vmid})</span>
                                    </div>
                                    <button
                                        onClick={() => includeVM(vm.vmid, vm.name)}
                                        className="text-xs text-green-400 hover:text-green-300"
                                    >
                                        {t('include') || 'Include'}
                                    </button>
                                </div>
                            ))}
                        </div>
                    ) : (
                        <div className="text-xs text-gray-600 mb-3 p-2 bg-proxmox-dark rounded-lg">
                            {t('noExcludedVMs') || 'No VMs excluded'}
                        </div>
                    )}
                    
                    {/* Add VM dropdown */}
                    <div className="flex gap-2">
                        <select
                            id={`excludeVMSelect-${clusterId}`}
                            className="flex-1 bg-proxmox-dark border border-proxmox-border rounded-lg px-3 py-2 text-sm"
                            defaultValue=""
                        >
                            <option value="" disabled>{t('selectVMToExclude') || 'Select VM to exclude...'}</option>
                            {availableVMs.map(vm => (
                                <option key={vm.vmid} value={vm.vmid}>
                                    {vm.name || `VM ${vm.vmid}`} ({vm.vmid}) - {vm.node}
                                </option>
                            ))}
                        </select>
                        <button
                            onClick={() => {
                                const select = document.getElementById(`excludeVMSelect-${clusterId}`);
                                const vmid = parseInt(select?.value);
                                if (!vmid) return;
                                const vm = availableVMs.find(v => v.vmid === vmid);
                                excludeVM(vmid, vm?.name);
                                select.value = '';
                            }}
                            className="px-3 py-2 bg-red-500/20 text-red-400 rounded-lg hover:bg-red-500/30 text-sm flex items-center gap-1"
                        >
                            <Icons.Ban className="w-4 h-4" />
                            {t('exclude') || 'Exclude'}
                        </button>
                    </div>
                </div>
            );
        }

        // update Manager Section Component (for Settings tab)
        function UpdateManagerSection({ clusterId, addToast }) {
            const { t } = useTranslation();
            const { getAuthHeaders, isAdmin } = useAuth();
            const [loading, setLoading] = useState(false);
            const [checking, setChecking] = useState(false);
            const [updateStatus, setUpdateStatus] = useState(null);
            const [rollingUpdate, setRollingUpdate] = useState(null);
            const [includeReboot, setIncludeReboot] = useState(true);
            const [skipUpToDate, setSkipUpToDate] = useState(true);  // NS: Skip nodes without updates
            const [skipEvacuation, setSkipEvacuation] = useState(false);  // NS: Issue #22 - skip VM evacuation (NOT RECOMMENDED)
            const [evacuationTimeout, setEvacuationTimeout] = useState(1800);  // NS: 30 min default
            const [showAdvancedOptions, setShowAdvancedOptions] = useState(false);  // NS: Toggle for timeouts
            const [showConfirm, setShowConfirm] = useState(false);
            const [expanded, setExpanded] = useState(false);
            const [selectedNode, setSelectedNode] = useState(null);
            const [updatingNode, setUpdatingNode] = useState(null);
            const [showNodeUpdateConfirm, setShowNodeUpdateConfirm] = useState(null);
            const [nodeReboot, setNodeReboot] = useState(true);
            
            // NS: Auto-Update Scheduling
            const [showScheduleModal, setShowScheduleModal] = useState(false);
            const [updateSchedule, setUpdateSchedule] = useState(null);
            const [scheduleEnabled, setScheduleEnabled] = useState(false);
            const [scheduleType, setScheduleType] = useState('recurring');  // 'once' or 'recurring'
            const [scheduleDay, setScheduleDay] = useState('sunday');
            const [scheduleTime, setScheduleTime] = useState('03:00');
            const [scheduleReboot, setScheduleReboot] = useState(true);
            const [scheduleSkipEvacuation, setScheduleSkipEvacuation] = useState(false);
            const [scheduleSaving, setScheduleSaving] = useState(false);

            // check if node has kernel updates
            const nodeHasKernelUpdates = (nodeData) => {
                return (nodeData?.updates || []).some(pkg => 
                    pkg.Package?.includes('linux-image') || 
                    pkg.Package?.includes('pve-kernel') ||
                    pkg.Package?.includes('proxmox-kernel')
                );
            };

            // check if node has security updates
            const nodeHasSecurityUpdates = (nodeData) => {
                return (nodeData?.updates || []).some(pkg => 
                    pkg.Origin?.includes('security') ||
                    pkg.Section?.includes('security')
                );
            };

            // update single node
            const updateSingleNode = async (nodeName, withReboot) => {
                setShowNodeUpdateConfirm(null);
                setUpdatingNode(nodeName);
                try {
                    // First try normal update (requires maintenance mode)
                    let response = await fetch(`${API_URL}/clusters/${clusterId}/nodes/${nodeName}/update`, {
                        method: 'POST',
                        credentials: 'include',
                        headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
                        body: JSON.stringify({ reboot: withReboot })
                    });
                    let data = await response.json();
                    
                    // If node not in maintenance mode, ask user if they want to force
                    if (!response.ok && data.error?.includes('Wartungsmodus')) {
                        const forceUpdate = confirm(
                            `${t('nodeNotInMaintenance') || 'Node is not in maintenance mode.'}\n\n` +
                            `${t('forceUpdateWarning') || 'Running VMs on this node may be affected if a reboot is performed.'}\n\n` +
                            `${t('continueAnyway') || 'Continue anyway?'}`
                        );
                        
                        if (forceUpdate) {
                            response = await fetch(`${API_URL}/clusters/${clusterId}/nodes/${nodeName}/update`, {
                                method: 'POST',
                                credentials: 'include',
                                headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
                                body: JSON.stringify({ reboot: withReboot, force: true })
                            });
                            data = await response.json();
                        } else {
                            setUpdatingNode(null);
                            return;
                        }
                    }
                    
                    if (data.success || response.ok) {
                        addToast(`${t('updateStarted') || 'Update started'}: ${nodeName}`, 'success');
                        
                        // Poll for update completion and refresh list
                        const pollUpdateStatus = setInterval(async () => {
                            try {
                                const statusRes = await fetch(`${API_URL}/clusters/${clusterId}/nodes/${nodeName}/update`, {
                                    credentials: 'include',
                                    headers: getAuthHeaders()
                                });
                                if (statusRes.ok) {
                                    const statusData = await statusRes.json();
                                    if (statusData.status === 'completed' || statusData.status === 'failed') {
                                        clearInterval(pollUpdateStatus);
                                        setUpdatingNode(null);
                                        if (statusData.status === 'completed') {
                                            addToast(`${t('updateCompleted') || 'Update completed'}: ${nodeName}`, 'success');
                                            // Clear cache and re-check updates
                                            localStorage.removeItem(`updateCheck_${clusterId}`);
                                            setTimeout(() => checkUpdates(), 2000);
                                        }
                                    }
                                }
                            } catch (e) {
                                // Ignore polling errors
                            }
                        }, 5000);
                        
                        // Stop polling after 15 minutes max
                        setTimeout(() => {
                            clearInterval(pollUpdateStatus);
                            setUpdatingNode(null);
                        }, 15 * 60 * 1000);
                    } else {
                        addToast(data.error || 'Error starting update', 'error');
                        setUpdatingNode(null);
                    }
                } catch (error) {
                    addToast(t('connectionError'), 'error');
                    setUpdatingNode(null);
                }
            };

            // Check for updates with progress
            const [checkProgress, setCheckProgress] = useState(null);
            
            const checkUpdates = async () => {
                setChecking(true);
                setCheckProgress({ status: 'checking', message: t('checkingNodes') || 'Checking nodes for updates...' });
                
                try {
                    const res = await fetch(`${API_URL}/clusters/${clusterId}/updates/check`, {
                        method: 'POST',
                        credentials: 'include',
                        headers: getAuthHeaders()
                    });
                    
                    const json = await res.json();
                    
                    if (json.success) {
                        setUpdateStatus(json);
                        localStorage.setItem(`updateCheck_${clusterId}`, JSON.stringify({
                            time: new Date().toISOString(),
                            summary: json.summary,
                            nodes: json.nodes
                        }));
                        if (json.summary?.total_updates > 0) {
                            addToast(`${json.summary.total_updates} ${t('updatesAvailable')}`, 'info');
                        } else {
                            addToast(t('noUpdatesAvailable'), 'success');
                        }
                    } else {
                        addToast(json.error || 'Error checking updates', 'error');
                    }
                } catch (err) {
                    console.error('Update check error:', err);
                    addToast('Connection error checking updates', 'error');
                }
                setChecking(false);
                setCheckProgress(null);
            };
            
            // NS: Load update schedule for this cluster
            const loadUpdateSchedule = async () => {
                try {
                    const res = await fetch(`${API_URL}/clusters/${clusterId}/updates/schedule`, {
                        credentials: 'include',
                        headers: getAuthHeaders()
                    });
                    if (res.ok) {
                        const data = await res.json();
                        setUpdateSchedule(data);
                        setScheduleEnabled(data.enabled || false);
                        setScheduleType(data.schedule_type || 'recurring');
                        setScheduleDay(data.day || 'sunday');
                        setScheduleTime(data.time || '03:00');
                        setScheduleReboot(data.include_reboot !== false);
                        setScheduleSkipEvacuation(data.skip_evacuation || false);
                    }
                } catch (e) {
                    console.error('Error loading update schedule:', e);
                }
            };
            
            // NS: Save update schedule
            const saveUpdateSchedule = async () => {
                setScheduleSaving(true);
                try {
                    const res = await fetch(`${API_URL}/clusters/${clusterId}/updates/schedule`, {
                        method: 'POST',
                        credentials: 'include',
                        headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            enabled: scheduleEnabled,
                            schedule_type: scheduleType,
                            day: scheduleDay,
                            time: scheduleTime,
                            include_reboot: scheduleReboot,
                            skip_evacuation: scheduleSkipEvacuation,
                            skip_up_to_date: true,
                            evacuation_timeout: 1800
                        })
                    });
                    if (res.ok) {
                        addToast(t('scheduleSaved') || 'Update schedule saved', 'success');
                        setShowScheduleModal(false);
                        loadUpdateSchedule();
                    } else {
                        const err = await res.json();
                        addToast(err.error || 'Error saving schedule', 'error');
                    }
                } catch (e) {
                    addToast('Error saving schedule', 'error');
                }
                setScheduleSaving(false);
            };
            
            // Load schedule on mount
            useEffect(() => {
                loadUpdateSchedule();
            }, [clusterId]);

            // Get rolling update status
            const getRollingStatus = async () => {
                try {
                    const r = await fetch(`${API_URL}/clusters/${clusterId}/updates/status`, {
                        credentials: 'include',
                        headers: getAuthHeaders()
                    });
                    if (!r.ok) {
                        setRollingUpdate(null);
                        return;
                    }
                    const d = await r.json();
                    // Backend already clears old/invalid status, just use what it returns
                    if (d.success && d.rolling_update) {
                        setRollingUpdate(d.rolling_update);
                    } else {
                        setRollingUpdate(null);
                    }
                } catch (e) {
                    console.error('getting rolling update status:', e);
                    setRollingUpdate(null);
                }
            };

            // start rolling update
            const startRollingUpdate = async () => {
                setShowConfirm(false);
                try {
                    const response = await fetch(`${API_URL}/clusters/${clusterId}/updates/rolling`, {
                        method: 'POST',
                        credentials: 'include',
                        headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            include_reboot: includeReboot,
                            skip_up_to_date: skipUpToDate,
                            skip_evacuation: skipEvacuation,  // NS: Issue #22 - skip VM evacuation (NOT RECOMMENDED)
                            evacuation_timeout: evacuationTimeout
                        })
                    });
                    const data = await response.json();
                    if (data.success) {
                        addToast(t('rollingUpdateInProgress'), 'info');
                        setExpanded(true); // Auto-expand to show progress
                        // Immediately fetch status to show progress UI
                        setTimeout(() => getRollingStatus(), 500);
                        setTimeout(() => getRollingStatus(), 1500);
                    } else {
                        addToast(data.error || 'Error starting rolling update', 'error');
                    }
                } catch (error) {
                    addToast(t('connectionError'), 'error');
                }
            };

            // Cancel rolling update
            const cancelRollingUpdate = async () => {
                try {
                    const response = await fetch(`${API_URL}/clusters/${clusterId}/updates/rolling`, {
                        method: 'DELETE',
                        credentials: 'include',
                        headers: getAuthHeaders()
                    });
                    const data = await response.json();
                    if (data.success) {
                        addToast(t('cancelRollingUpdate') + ' ‚úì', 'info');
                        setRollingUpdate(null);
                    }
                } catch (error) {
                    addToast(t('connectionError'), 'error');
                }
            };

            // Load cached update status and check daily
            useEffect(() => {
                // Reset state when cluster changes
                setUpdateStatus(null);
                setRollingUpdate(null);
                setSelectedNode(null);
                setUpdatingNode(null);
                setExpanded(false);
                
                // Check rolling update status
                getRollingStatus();
                
                // Load cached status from localStorage
                const cached = localStorage.getItem(`updateCheck_${clusterId}`);
                if (cached) {
                    try {
                        const data = JSON.parse(cached);
                        // Show cached data immediately
                        if (data.summary) {
                            setUpdateStatus({ summary: data.summary, nodes: data.nodes || {} });
                        }
                        // Check if cache is older than 24 hours
                        const lastCheck = new Date(data.time);
                        const hoursSince = (Date.now() - lastCheck.getTime()) / (1000 * 60 * 60);
                        if (hoursSince > 24) {
                            checkUpdates();
                        }
                    } catch (e) {
                        checkUpdates();
                    }
                } else {
                    // No cache - do initial check
                    checkUpdates();
                }
                
                // Poll for rolling update status every 3 seconds (always poll, let the function decide)
                const interval = setInterval(() => {
                    getRollingStatus();
                }, 3000);
                return () => clearInterval(interval);
            }, [clusterId]);

            const totalUpdates = updateStatus?.summary?.total_updates || 0;
            const nodesWithUpdates = updateStatus?.summary?.nodes_with_updates || 0;
            
            // Check for kernel updates
            // NS: kernel updates require reboot, so we flag them seperately
            const hasKernelUpdates = updateStatus && Object.values(updateStatus.nodes || {}).some(node => 
                (node.updates || []).some(pkg => 
                    pkg.Package?.includes('linux-image') || pkg.Package?.includes('pve-kernel')
                )
            );

            // Get last check info
            const lastCheckInfo = (() => {
                const cached = localStorage.getItem(`updateCheck_${clusterId}`);
                if (cached) {
                    try {
                        const data = JSON.parse(cached);
                        return new Date(data.time).toLocaleString();
                    } catch (e) {}
                }
                return t('neverChecked');
            })();

            return(
                <div className="bg-proxmox-card border border-proxmox-border rounded-xl overflow-hidden">
                    {/* Header - always visible */}
                    <div 
                        className="p-4 flex items-center justify-between cursor-pointer hover:bg-proxmox-hover/50 transition-colors"
                        onClick={() => setExpanded(!expanded)}
                    >
                        <div className="flex items-center gap-3">
                            <div className="w-10 h-10 rounded-lg bg-proxmox-dark flex items-center justify-center">
                                <Icons.Download />
                            </div>
                            <div>
                                <h3 className="font-semibold text-white">{t('updateManager')}</h3>
                                <p className="text-xs text-gray-400">
                                    {totalUpdates > 0 ? (
                                        <span className="text-yellow-400">{totalUpdates} {t('updatesAvailable')}</span>
                                    ) : updateStatus ? (
                                        <span className="text-green-400">{t('noUpdatesAvailable')}</span>
                                    ) : (
                                        <span>{t('lastChecked')}: {lastCheckInfo}</span>
                                    )}
                                </p>
                            </div>
                        </div>
                        <div className="flex items-center gap-2">
                            {totalUpdates > 0 && (
                                <span className="px-2 py-1 bg-yellow-500/20 text-yellow-400 rounded-full text-xs font-medium">
                                    {totalUpdates}
                                </span>
                            )}
                            {hasKernelUpdates && (
                                <span className="px-2 py-1 bg-red-500/20 text-red-400 rounded-full text-xs font-medium">
                                    Kernel
                                </span>
                            )}
                            <Icons.ChevronDown className={`transition-transform ${expanded ? 'rotate-180' : ''}`} />
                        </div>
                    </div>

                    {/* Expanded content */}
                    {expanded && (
                        <div className="border-t border-proxmox-border p-4 space-y-4">
                            {/* Actions */}
                            <div className="flex items-center gap-3">
                                <button
                                    onClick={(e) => { e.stopPropagation(); checkUpdates(); }}
                                    disabled={checking}
                                    className="px-4 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-sm hover:border-proxmox-orange transition-colors flex items-center gap-2 disabled:opacity-50"
                                >
                                    {checking ? (
                                        <div className="animate-spin w-4 h-4 border-2 border-proxmox-orange border-t-transparent rounded-full"></div>
                                    ) : (
                                        <Icons.RefreshCw />
                                    )}
                                    {t('checkForUpdates')}
                                </button>
                                
                                {/* MK: Schedule button */}
                                {isAdmin && (
                                    <button
                                        onClick={(e) => { e.stopPropagation(); setShowScheduleModal(true); }}
                                        className={`px-4 py-2 rounded-lg text-sm transition-colors flex items-center gap-2 ${
                                            scheduleEnabled 
                                                ? 'bg-green-500/20 border border-green-500/50 text-green-400 hover:bg-green-500/30' 
                                                : 'bg-proxmox-dark border border-proxmox-border text-gray-400 hover:bg-proxmox-hover'
                                        }`}
                                        title={scheduleEnabled ? `${t('scheduledFor') || 'Scheduled for'}: ${scheduleDay} ${scheduleTime}` : t('scheduleUpdates') || 'Schedule Updates'}
                                    >
                                        <Icons.Clock />
                                        {scheduleEnabled ? (
                                            <span className="hidden sm:inline">{scheduleDay.charAt(0).toUpperCase() + scheduleDay.slice(1)} {scheduleTime}</span>
                                        ) : (
                                            <span className="hidden sm:inline">{t('schedule') || 'Schedule'}</span>
                                        )}
                                    </button>
                                )}
                                
                                {isAdmin && totalUpdates > 0 && !rollingUpdate && (
                                    <button
                                        onClick={(e) => { e.stopPropagation(); setShowConfirm(true); }}
                                        className="px-4 py-2 bg-proxmox-orange rounded-lg text-white text-sm hover:bg-orange-600 transition-colors flex items-center gap-2"
                                    >
                                        <Icons.Play />
                                        {t('startRollingUpdate')}
                                    </button>
                                )}
                            </div>

                            {/* Check Progress Indicator */}
                            {checking && checkProgress && (
                                <div className="p-4 bg-blue-500/10 border border-blue-500/30 rounded-lg">
                                    <div className="flex items-center gap-3">
                                        <div className="relative">
                                            <div className="animate-spin w-8 h-8 border-3 border-blue-400 border-t-transparent rounded-full"></div>
                                            <Icons.Server className="absolute inset-0 m-auto w-4 h-4 text-blue-400" />
                                        </div>
                                        <div>
                                            <div className="text-blue-400 font-medium">{t('checkingForUpdates') || 'Checking for Updates'}</div>
                                            <div className="text-sm text-gray-400">{checkProgress.message}</div>
                                        </div>
                                    </div>
                                    <div className="mt-3 w-full bg-proxmox-dark rounded-full h-1.5 overflow-hidden">
                                        <div className="bg-blue-400 h-full rounded-full animate-pulse" style={{width: '100%'}}></div>
                                    </div>
                                </div>
                            )}

                            {/* Kernel Update Warning */}
                            {hasKernelUpdates && (
                                <div className="p-3 bg-red-500/10 border border-red-500/30 rounded-lg flex items-start gap-2">
                                    <span className="text-red-400">‚ö†Ô∏è</span>
                                    <div>
                                        <p className="text-red-400 text-sm font-medium">Kernel Update Available</p>
                                        <p className="text-red-300/70 text-xs">{t('includeRebootHint')}</p>
                                    </div>
                                </div>
                            )}

                            {/* Node Status Cards */}
                            {updateStatus && (
                                <div className="space-y-2">
                                    {Object.entries(updateStatus.nodes || {}).map(([nodeName, nodeData]) => {
                                        const hasKernel = nodeHasKernelUpdates(nodeData);
                                        const hasSecurity = nodeHasSecurityUpdates(nodeData);
                                        const isExpanded = selectedNode === nodeName;
                                        const isUpdating = updatingNode === nodeName;
                                        
                                        return (
                                            <div key={nodeName} className="bg-proxmox-dark rounded-lg border border-proxmox-border overflow-hidden">
                                                {/* Node Header */}
                                                <div 
                                                    className="p-3 flex items-center justify-between cursor-pointer hover:bg-proxmox-hover/30 transition-colors"
                                                    onClick={() => setSelectedNode(isExpanded ? null : nodeName)}
                                                >
                                                    <div className="flex items-center gap-3">
                                                        <Icons.Server className="w-4 h-4 text-gray-400" />
                                                        <span className="text-sm font-medium text-white">{nodeName}</span>
                                                        {hasKernel && (
                                                            <span className="px-1.5 py-0.5 bg-red-500/20 text-red-400 rounded text-xs">
                                                                Kernel
                                                            </span>
                                                        )}
                                                        {hasSecurity && (
                                                            <span className="px-1.5 py-0.5 bg-orange-500/20 text-orange-400 rounded text-xs">
                                                                Security
                                                            </span>
                                                        )}
                                                    </div>
                                                    <div className="flex items-center gap-2">
                                                        {isUpdating && (
                                                            <div className="flex items-center gap-2 text-blue-400 text-xs">
                                                                <div className="animate-spin w-3 h-3 border-2 border-blue-400 border-t-transparent rounded-full"></div>
                                                                Updating...
                                                            </div>
                                                        )}
                                                        <span className={`text-xs px-2 py-0.5 rounded-full ${
                                                            nodeData.count > 0 ? 'bg-yellow-500/20 text-yellow-400' : 'bg-green-500/20 text-green-400'
                                                        }`}>
                                                            {nodeData.count || 0} {t('updates') || 'updates'}
                                                        </span>
                                                        <Icons.ChevronDown className={`w-4 h-4 text-gray-400 transition-transform ${isExpanded ? 'rotate-180' : ''}`} />
                                                    </div>
                                                </div>
                                                
                                                {/* Expanded Package List */}
                                                {isExpanded && (
                                                    <div className="border-t border-proxmox-border">
                                                        {nodeData.count > 0 ? (
                                                            <>
                                                                {/* Update Actions */}
                                                                {isAdmin && (
                                                                    <div className="p-3 bg-proxmox-darker border-b border-proxmox-border flex items-center gap-2">
                                                                        <button
                                                                            onClick={(e) => { 
                                                                                e.stopPropagation(); 
                                                                                setNodeReboot(hasKernel);
                                                                                setShowNodeUpdateConfirm(nodeName); 
                                                                            }}
                                                                            disabled={isUpdating}
                                                                            className="px-3 py-1.5 bg-proxmox-orange hover:bg-orange-600 rounded text-white text-xs font-medium transition-colors disabled:opacity-50 flex items-center gap-1"
                                                                        >
                                                                            <Icons.Download className="w-3 h-3" />
                                                                            {t('updateThisNode') || 'Update this Node'}
                                                                        </button>
                                                                        {hasKernel && (
                                                                            <span className="text-xs text-red-400 flex items-center gap-1">
                                                                                <Icons.AlertTriangle className="w-3 h-3" />
                                                                                {t('rebootRequired') || 'Reboot required for kernel'}
                                                                            </span>
                                                                        )}
                                                                    </div>
                                                                )}
                                                                
                                                                {/* Package List */}
                                                                <div className="max-h-64 overflow-y-auto">
                                                                    <table className="w-full text-xs">
                                                                        <thead className="bg-proxmox-darker sticky top-0">
                                                                            <tr>
                                                                                <th className="text-left p-2 text-gray-400 font-medium">{t('package') || 'Package'}</th>
                                                                                <th className="text-left p-2 text-gray-400 font-medium">{t('currentVersion') || 'Current'}</th>
                                                                                <th className="text-left p-2 text-gray-400 font-medium">{t('newVersion') || 'New'}</th>
                                                                                <th className="text-left p-2 text-gray-400 font-medium">{t('type') || 'Type'}</th>
                                                                            </tr>
                                                                        </thead>
                                                                        <tbody>
                                                                            {(nodeData.updates || []).map((pkg, idx) => {
                                                                                const isKernelPkg = pkg.Package?.includes('linux-image') || pkg.Package?.includes('kernel');
                                                                                const isSecurityPkg = pkg.Origin?.includes('security') || pkg.Section?.includes('security');
                                                                                
                                                                                return (
                                                                                    <tr key={idx} className="border-t border-gray-700/50 hover:bg-proxmox-hover/20">
                                                                                        <td className="p-2 font-mono text-white">
                                                                                            {pkg.Package || 'unknown'}
                                                                                        </td>
                                                                                        <td className="p-2 font-mono text-gray-400 truncate max-w-24" title={pkg.OldVersion}>
                                                                                            {pkg.OldVersion?.substring(0, 15) || '-'}
                                                                                        </td>
                                                                                        <td className="p-2 font-mono text-green-400 truncate max-w-24" title={pkg.Version}>
                                                                                            {pkg.Version?.substring(0, 15) || '-'}
                                                                                        </td>
                                                                                        <td className="p-2">
                                                                                            {isKernelPkg ? (
                                                                                                <span className="px-1.5 py-0.5 bg-red-500/20 text-red-400 rounded">Kernel</span>
                                                                                            ) : isSecurityPkg ? (
                                                                                                <span className="px-1.5 py-0.5 bg-orange-500/20 text-orange-400 rounded">Security</span>
                                                                                            ) : (
                                                                                                <span className="px-1.5 py-0.5 bg-blue-500/20 text-blue-400 rounded">Update</span>
                                                                                            )}
                                                                                        </td>
                                                                                    </tr>
                                                                                );
                                                                            })}
                                                                        </tbody>
                                                                    </table>
                                                                </div>
                                                            </>
                                                        ) : (
                                                            <div className="p-4 text-center text-gray-500 text-sm">
                                                                <Icons.CheckCircle className="w-6 h-6 mx-auto mb-2 text-green-400" />
                                                                {t('noUpdatesForNode') || 'This node is up to date'}
                                                            </div>
                                                        )}
                                                    </div>
                                                )}
                                            </div>
                                        );
                                    })}
                                </div>
                            )}

                            {/* Single Node Update Confirm Modal */}
                            {showNodeUpdateConfirm && (
                                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop" onClick={() => setShowNodeUpdateConfirm(null)}>
                                    <div className="bg-proxmox-card border border-proxmox-border rounded-xl p-5 max-w-md w-full animate-scale-in" onClick={e => e.stopPropagation()}>
                                        <h3 className="text-lg font-semibold text-white mb-3 flex items-center gap-2">
                                            <Icons.Download />
                                            {t('updateNode') || 'Update Node'}: {showNodeUpdateConfirm}
                                        </h3>
                                        
                                        <p className="text-gray-400 text-sm mb-4">
                                            {t('updateNodeDesc') || 'This will run apt update && apt dist-upgrade on the node.'}
                                        </p>
                                        
                                        {nodeHasKernelUpdates(updateStatus?.nodes?.[showNodeUpdateConfirm]) && (
                                            <div className="p-3 bg-red-500/10 border border-red-500/30 rounded-lg mb-4 flex items-start gap-2">
                                                <Icons.AlertTriangle className="w-4 h-4 text-red-400 mt-0.5" />
                                                <div className="text-xs">
                                                    <p className="text-red-400 font-medium">{t('kernelUpdateDetected') || 'Kernel update detected'}</p>
                                                    <p className="text-red-300/70">{t('rebootRecommended') || 'A reboot is recommended to apply kernel changes.'}</p>
                                                </div>
                                            </div>
                                        )}
                                        
                                        <label className="flex items-center gap-2 mb-4 cursor-pointer">
                                            <input
                                                type="checkbox"
                                                checked={nodeReboot}
                                                onChange={(e) => setNodeReboot(e.target.checked)}
                                                className="rounded"
                                            />
                                            <span className="text-sm text-gray-300">{t('rebootAfterUpdate') || 'Reboot after update'}</span>
                                        </label>
                                        
                                        <div className="flex gap-2">
                                            <button
                                                onClick={() => setShowNodeUpdateConfirm(null)}
                                                className="flex-1 px-4 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-gray-400 hover:text-white transition-colors"
                                            >
                                                {t('cancel')}
                                            </button>
                                            <button
                                                onClick={() => updateSingleNode(showNodeUpdateConfirm, nodeReboot)}
                                                className="flex-1 px-4 py-2 bg-proxmox-orange hover:bg-orange-600 rounded-lg text-white font-medium transition-colors"
                                            >
                                                {t('startUpdate') || 'Start Update'}
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {/* Rolling Update Progress */}
                            {rollingUpdate && rollingUpdate.status === 'running' && (
                                <div className="p-4 bg-blue-500/10 border border-blue-500/30 rounded-lg space-y-4">
                                    {/* Header with cancel button */}
                                    <div className="flex items-center justify-between">
                                        <div className="flex items-center gap-2">
                                            <div className="animate-spin w-5 h-5 border-2 border-blue-400 border-t-transparent rounded-full"></div>
                                            <span className="text-blue-400 font-semibold text-lg">{t('rollingUpdateInProgress')}</span>
                                        </div>
                                        <button
                                            onClick={cancelRollingUpdate}
                                            className="px-3 py-1.5 text-sm bg-red-500/20 text-red-400 rounded-lg hover:bg-red-500/30 transition-colors flex items-center gap-1"
                                        >
                                            <Icons.X className="w-4 h-4" />
                                            {t('cancel')}
                                        </button>
                                    </div>
                                    
                                    {/* Current status */}
                                    <div className="bg-proxmox-dark rounded-lg p-4">
                                        <div className="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm mb-4">
                                            <div>
                                                <span className="text-gray-400">{t('currentNode')}:</span>
                                                <div className="text-white font-mono font-semibold">{rollingUpdate.current_node || '-'}</div>
                                            </div>
                                            <div>
                                                <span className="text-gray-400">{t('currentStep')}:</span>
                                                <div className="text-yellow-400 font-medium capitalize">{rollingUpdate.current_step || '-'}</div>
                                            </div>
                                            <div>
                                                <span className="text-gray-400">{t('progress')}:</span>
                                                <div className="text-white font-mono">{(rollingUpdate.current_index || 0) + 1} / {rollingUpdate.nodes?.length || 0}</div>
                                            </div>
                                            <div>
                                                <span className="text-gray-400">{t('started')}:</span>
                                                <div className="text-gray-300 text-xs">{rollingUpdate.started_at || '-'}</div>
                                            </div>
                                        </div>
                                        
                                        {/* Progress bar */}
                                        <div className="w-full bg-proxmox-darker rounded-full h-3 overflow-hidden">
                                            <div 
                                                className="bg-gradient-to-r from-blue-500 to-blue-400 h-full rounded-full transition-all duration-500 relative"
                                                style={{ width: `${((rollingUpdate.current_index || 0) + 1) / (rollingUpdate.nodes?.length || 1) * 100}%` }}
                                            >
                                                <div className="absolute inset-0 bg-white/20 animate-pulse"></div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    {/* Node status overview */}
                                    <div className="flex flex-wrap gap-2">
                                        {(rollingUpdate.nodes || []).map((nodeName, idx) => {
                                            const isCompleted = (rollingUpdate.completed_nodes || []).includes(nodeName);
                                            const isFailed = (rollingUpdate.failed_nodes || []).some(f => f.node === nodeName);
                                            const isCurrent = rollingUpdate.current_node === nodeName;
                                            const isPending = !isCompleted && !isFailed && !isCurrent;
                                            
                                            return (
                                                <div 
                                                    key={nodeName}
                                                    className={`px-3 py-1.5 rounded-lg text-sm font-medium flex items-center gap-1.5 ${
                                                        isCompleted ? 'bg-green-500/20 text-green-400' :
                                                        isFailed ? 'bg-red-500/20 text-red-400' :
                                                        isCurrent ? 'bg-blue-500/20 text-blue-400 animate-pulse' :
                                                        'bg-gray-500/20 text-gray-400'
                                                    }`}
                                                >
                                                    {isCompleted && <Icons.CheckCircle className="w-3 h-3" />}
                                                    {isFailed && <Icons.XCircle className="w-3 h-3" />}
                                                    {isCurrent && <div className="w-2 h-2 bg-blue-400 rounded-full animate-ping"></div>}
                                                    {isPending && <Icons.Clock className="w-3 h-3" />}
                                                    {nodeName}
                                                </div>
                                            );
                                        })}
                                    </div>
                                    
                                    {/* Logs */}
                                    {rollingUpdate.logs && rollingUpdate.logs.length > 0 && (
                                        <div className="bg-proxmox-darker rounded-lg overflow-hidden">
                                            <div className="px-3 py-2 bg-proxmox-dark border-b border-proxmox-border flex items-center justify-between">
                                                <span className="text-sm font-medium text-gray-300 flex items-center gap-2">
                                                    <Icons.Terminal className="w-4 h-4" />
                                                    {t('updateLogs')}
                                                </span>
                                                <span className="text-xs text-gray-500">{rollingUpdate.logs.length} entries</span>
                                            </div>
                                            <div className="max-h-48 overflow-y-auto p-3 font-mono text-xs space-y-1">
                                                {rollingUpdate.logs.map((log, idx) => (
                                                    <div 
                                                        key={idx} 
                                                        className={`${
                                                            log.includes('ERROR') ? 'text-red-400' :
                                                            log.includes('successfully') || log.includes('completed') ? 'text-green-400' :
                                                            log.includes('Starting') ? 'text-blue-400' :
                                                            'text-gray-400'
                                                        }`}
                                                    >
                                                        {log}
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    )}
                                </div>
                            )}

                            {/* Rolling Update Completed - only show if recent (< 10 min) */}
                            {rollingUpdate && rollingUpdate.status === 'completed' && rollingUpdate.completed_at && (() => {
                                const completedTime = new Date(rollingUpdate.completed_at.replace(' ', 'T'));
                                const ageMinutes = (Date.now() - completedTime.getTime()) / 1000 / 60;
                                return !isNaN(ageMinutes) && ageMinutes < 10;
                            })() && (
                                <div className="p-3 bg-green-500/10 border border-green-500/30 rounded-lg flex items-center justify-between">
                                    <div className="flex items-center gap-2 text-green-400">
                                        <Icons.CheckCircle />
                                        <span>{t('updateCompleted')}</span>
                                    </div>
                                    <button
                                        onClick={async () => {
                                            setRollingUpdate(null);
                                            // Clear backend status too
                                            try {
                                                await fetch(`${API_URL}/clusters/${clusterId}/updates/rolling/clear`, {
                                                    method: 'POST',
                                                    credentials: 'include',
                                                    headers: getAuthHeaders()
                                                });
                                            } catch (e) {}
                                            // Clear cache and re-check updates
                                            localStorage.removeItem(`updateCheck_${clusterId}`);
                                            checkUpdates();
                                        }}
                                        className="text-xs text-gray-400 hover:text-white"
                                    >
                                        {t('dismiss') || 'Dismiss'}
                                    </button>
                                </div>
                            )}

                            {/* Rolling Update Failed */}
                            {rollingUpdate && rollingUpdate.status === 'failed' && (
                                <div className="p-4 bg-red-500/10 border border-red-500/30 rounded-lg space-y-3">
                                    <div className="flex items-center justify-between">
                                        <div className="flex items-center gap-2 text-red-400">
                                            <Icons.XCircle />
                                            <span className="font-semibold">{t('updateFailed') || 'Update Failed'}</span>
                                        </div>
                                        <button
                                            onClick={async () => {
                                                setRollingUpdate(null);
                                                try {
                                                    await fetch(`${API_URL}/clusters/${clusterId}/updates/rolling/clear`, {
                                                        method: 'POST',
                                                        credentials: 'include',
                                                        headers: getAuthHeaders()
                                                    });
                                                } catch (e) {}
                                                localStorage.removeItem(`updateCheck_${clusterId}`);
                                                checkUpdates();
                                            }}
                                            className="text-xs text-gray-400 hover:text-white"
                                        >
                                            {t('dismiss') || 'Dismiss'}
                                        </button>
                                    </div>
                                    
                                    {/* Error message */}
                                    {rollingUpdate.error && (
                                        <div className="p-2 bg-red-500/20 rounded text-red-300 text-sm font-mono">
                                            {rollingUpdate.error}
                                        </div>
                                    )}
                                    
                                    {/* Failed nodes with their errors */}
                                    {rollingUpdate.failed_nodes && rollingUpdate.failed_nodes.length > 0 && (
                                        <div className="space-y-2">
                                            <span className="text-sm text-gray-400">{t('failedNodes') || 'Failed Nodes'}:</span>
                                            {rollingUpdate.failed_nodes.map((fn, idx) => (
                                                <div key={idx} className="p-2 bg-proxmox-dark rounded-lg">
                                                    <div className="flex items-center gap-2 text-red-400 text-sm font-medium">
                                                        <Icons.Server className="w-4 h-4" />
                                                        {fn.node}
                                                    </div>
                                                    {fn.error && (
                                                        <pre className="mt-1 text-xs text-red-300/70 whitespace-pre-wrap max-h-24 overflow-auto">
                                                            {fn.error}
                                                        </pre>
                                                    )}
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                    
                                    {/* Warning about maintenance mode */}
                                    <div className="p-2 bg-yellow-500/10 border border-yellow-500/30 rounded text-yellow-300 text-xs flex items-start gap-2">
                                        <span className="mt-0.5">‚ö†Ô∏è</span>
                                        <span>{t('maintenanceModeWarning') || 'Some nodes may still be in maintenance mode. Check the Nodes tab and exit maintenance mode manually if needed.'}</span>
                                    </div>
                                    
                                    {/* Logs expandable */}
                                    {rollingUpdate.logs && rollingUpdate.logs.length > 0 && (
                                        <details className="bg-proxmox-dark rounded-lg overflow-hidden">
                                            <summary className="px-3 py-2 cursor-pointer text-sm text-gray-400 hover:text-white">
                                                {t('viewLogs') || 'View Logs'} ({rollingUpdate.logs.length})
                                            </summary>
                                            <div className="max-h-48 overflow-y-auto p-3 font-mono text-xs space-y-1 border-t border-proxmox-border">
                                                {rollingUpdate.logs.map((log, idx) => (
                                                    <div 
                                                        key={idx} 
                                                        className={`${
                                                            log.includes('ERROR') || log.includes('‚úó') ? 'text-red-400' :
                                                            log.includes('‚úì') || log.includes('successfully') ? 'text-green-400' :
                                                            log.includes('Starting') ? 'text-blue-400' :
                                                            'text-gray-400'
                                                        }`}
                                                    >
                                                        {log}
                                                    </div>
                                                ))}
                                            </div>
                                        </details>
                                    )}
                                </div>
                            )}
                        </div>
                    )}

                    {/* Confirm Modal */}
                    {showConfirm && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop" onClick={() => setShowConfirm(false)}>
                            <div className="bg-proxmox-card border border-proxmox-border rounded-2xl p-6 max-w-md w-full animate-scale-in" onClick={e => e.stopPropagation()}>
                                <h3 className="text-lg font-semibold text-white mb-2">{t('confirmRollingUpdate')}</h3>
                                <p className="text-gray-400 text-sm mb-4">{t('rollingUpdateWarning')}</p>
                                
                                <div className="space-y-3 mb-4">
                                    <label className="flex items-center gap-2 cursor-pointer">
                                        <input
                                            type="checkbox"
                                            checked={includeReboot}
                                            onChange={(e) => setIncludeReboot(e.target.checked)}
                                            className="w-4 h-4 rounded border-proxmox-border bg-proxmox-dark text-proxmox-orange focus:ring-proxmox-orange"
                                        />
                                        <span className="text-white">{t('includeReboot')}</span>
                                        {hasKernelUpdates && <span className="text-xs text-red-400">(Recommended)</span>}
                                    </label>
                                    
                                    
                                    <label className="flex items-center gap-2 cursor-pointer">
                                        <input
                                            type="checkbox"
                                            checked={skipUpToDate}
                                            onChange={(e) => setSkipUpToDate(e.target.checked)}
                                            className="w-4 h-4 rounded border-proxmox-border bg-proxmox-dark text-proxmox-orange focus:ring-proxmox-orange"
                                        />
                                        <span className="text-white">{t('skipUpToDate') || 'Skip up-to-date nodes'}</span>
                                    </label>
                                    
                                    {/* MK: Skip evacuation - moved from advanced options for visibility */}
                                    <label className="flex items-center gap-2 cursor-pointer">
                                        <input
                                            type="checkbox"
                                            checked={skipEvacuation}
                                            onChange={(e) => setSkipEvacuation(e.target.checked)}
                                            className="w-4 h-4 rounded border-proxmox-border bg-proxmox-dark text-red-500 focus:ring-red-500"
                                        />
                                        <span className="text-red-400">{t('skipEvacuation') || 'Skip VM evacuation'}</span>
                                        <span className="text-xs bg-red-900/30 text-red-400 px-1.5 py-0.5 rounded">{t('notRecommended') || 'NOT RECOMMENDED'}</span>
                                    </label>
                                    {skipEvacuation && (
                                        <div className="ml-6 p-2 bg-red-900/20 border border-red-800 rounded text-xs text-red-400">
                                            {t('skipEvacuationWarning') || '‚ö†Ô∏è Warning: VMs may crash if something goes wrong during the update!'}
                                        </div>
                                    )}
                                    
                                    {/* NS: Advanced options toggle */}
                                    <button
                                        onClick={() => setShowAdvancedOptions(!showAdvancedOptions)}
                                        className="text-xs text-gray-500 hover:text-gray-300 flex items-center gap-1"
                                    >
                                        <Icons.ChevronRight className={`w-3 h-3 transition-transform ${showAdvancedOptions ? 'rotate-90' : ''}`} />
                                        {t('advancedOptions') || 'Advanced Options'}
                                    </button>
                                    
                                    {showAdvancedOptions && (
                                        <div className="ml-4 space-y-3 p-3 bg-proxmox-dark rounded-lg">
                                            <div>
                                                <label className="text-xs text-gray-400 block mb-1">
                                                    {t('evacuationTimeout') || 'Evacuation Timeout'} ({t('seconds') || 'seconds'})
                                                </label>
                                                <select
                                                    value={evacuationTimeout}
                                                    onChange={(e) => setEvacuationTimeout(parseInt(e.target.value))}
                                                    className="w-full bg-proxmox-darker border border-proxmox-border rounded px-3 py-1.5 text-sm text-white"
                                                    disabled={skipEvacuation}
                                                >
                                                    <option value={300}>5 {t('minutes') || 'minutes'}</option>
                                                    <option value={600}>10 {t('minutes') || 'minutes'}</option>
                                                    <option value={1200}>20 {t('minutes') || 'minutes'}</option>
                                                    <option value={1800}>30 {t('minutes') || 'minutes'} ({t('default') || 'default'})</option>
                                                    <option value={3600}>1 {t('hour') || 'hour'}</option>
                                                    <option value={7200}>2 {t('hours') || 'hours'}</option>
                                                </select>
                                                <p className="text-xs text-gray-500 mt-1">
                                                    {t('evacuationTimeoutHint') || 'How long to wait for VMs to migrate before timeout'}
                                                </p>
                                            </div>
                                        </div>
                                    )}
                                </div>
                                
                                <div className="bg-proxmox-dark rounded-lg p-3 mb-4 text-sm">
                                    <div className="flex justify-between text-gray-400">
                                        <span>{t('nodes')}:</span>
                                        <span className="text-white">{updateStatus?.summary?.total_nodes || 0}</span>
                                    </div>
                                    <div className="flex justify-between text-gray-400">
                                        <span>{t('packagesAvailable')}:</span>
                                        <span className="text-yellow-400">{totalUpdates}</span>
                                    </div>
                                    <div className="flex justify-between text-gray-400">
                                        <span>{t('estimatedTime')}:</span>
                                        <span className="text-white">~{(updateStatus?.summary?.total_nodes || 1) * (includeReboot ? 10 : 5)} {t('minutes')}</span>
                                    </div>
                                    {skipUpToDate && (
                                        <div className="flex justify-between text-gray-400 mt-1">
                                            <span>{t('note') || 'Note'}:</span>
                                            <span className="text-green-400 text-xs">{t('skipUpToDateHint') || 'Up-to-date nodes will be skipped'}</span>
                                        </div>
                                    )}
                                </div>
                                
                                <div className="flex gap-3 justify-end">
                                    <button
                                        onClick={() => setShowConfirm(false)}
                                        className="px-4 py-2 bg-proxmox-dark text-gray-300 rounded-lg hover:bg-proxmox-hover transition-colors"
                                    >
                                        {t('cancel')}
                                    </button>
                                    <button
                                        onClick={startRollingUpdate}
                                        className="px-4 py-2 bg-proxmox-orange text-white rounded-lg hover:bg-orange-600 transition-colors"
                                    >
                                        {t('startRollingUpdate')}
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {/* MK: Schedule Modal */}
                    {showScheduleModal && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop" onClick={() => setShowScheduleModal(false)}>
                            <div className="bg-proxmox-card border border-proxmox-border rounded-2xl p-6 max-w-md w-full animate-scale-in" onClick={e => e.stopPropagation()}>
                                <div className="flex items-center gap-3 mb-4">
                                    <div className="p-2 rounded-lg bg-blue-500/20">
                                        <Icons.Clock className="text-blue-400" />
                                    </div>
                                    <div>
                                        <h3 className="text-lg font-semibold text-white">{t('scheduleUpdates') || 'Schedule Automatic Updates'}</h3>
                                        <span className="text-xs bg-yellow-500/20 text-yellow-400 px-2 py-0.5 rounded">{t('experimental') || 'EXPERIMENTAL'}</span>
                                    </div>
                                </div>
                                
                                {/* Experimental Warning */}
                                <div className="mb-4 p-3 bg-yellow-500/10 border border-yellow-500/30 rounded-lg">
                                    <div className="flex items-start gap-2">
                                        <Icons.AlertTriangle className="text-yellow-400 mt-0.5 flex-shrink-0" />
                                        <div className="text-sm text-yellow-300">
                                            {t('experimentalWarning') || 'Use with caution - this feature is currently experimental. Test in non-production environments first.'}
                                        </div>
                                    </div>
                                </div>
                                
                                <div className="space-y-4">
                                    {/* Enable/Disable Toggle */}
                                    <label className="flex items-center justify-between p-3 bg-proxmox-dark rounded-lg cursor-pointer">
                                        <div>
                                            <div className="text-white font-medium">{t('enableAutoUpdate') || 'Enable Automatic Updates'}</div>
                                            <div className="text-xs text-gray-500">{t('autoUpdateDesc') || 'Automatically run rolling updates on schedule'}</div>
                                        </div>
                                        <div 
                                            className={`w-12 h-6 rounded-full p-1 transition-colors cursor-pointer ${scheduleEnabled ? 'bg-green-500' : 'bg-proxmox-border'}`}
                                            onClick={() => setScheduleEnabled(!scheduleEnabled)}
                                        >
                                            <div className={`w-4 h-4 rounded-full bg-white transition-transform ${scheduleEnabled ? 'translate-x-6' : 'translate-x-0'}`} />
                                        </div>
                                    </label>
                                    
                                    {scheduleEnabled && (
                                        <>
                                            {/* Schedule Type Selection */}
                                            <div>
                                                <label className="text-xs text-gray-400 block mb-1">{t('scheduleType') || 'Schedule Type'}</label>
                                                <div className="grid grid-cols-2 gap-2">
                                                    <button
                                                        onClick={() => setScheduleType('once')}
                                                        className={`p-3 rounded-lg border text-sm font-medium transition-colors ${
                                                            scheduleType === 'once' 
                                                                ? 'bg-proxmox-orange/20 border-proxmox-orange text-proxmox-orange' 
                                                                : 'bg-proxmox-dark border-proxmox-border text-gray-400 hover:border-gray-500'
                                                        }`}
                                                    >
                                                        {t('runOnce') || 'Run Once'}
                                                    </button>
                                                    <button
                                                        onClick={() => setScheduleType('recurring')}
                                                        className={`p-3 rounded-lg border text-sm font-medium transition-colors ${
                                                            scheduleType === 'recurring' 
                                                                ? 'bg-proxmox-orange/20 border-proxmox-orange text-proxmox-orange' 
                                                                : 'bg-proxmox-dark border-proxmox-border text-gray-400 hover:border-gray-500'
                                                        }`}
                                                    >
                                                        {t('recurring') || 'Recurring'}
                                                    </button>
                                                </div>
                                            </div>
                                            
                                            {/* Day Selection */}
                                            <div>
                                                <label className="text-xs text-gray-400 block mb-1">{t('updateDay') || 'Update Day'}</label>
                                                <select
                                                    value={scheduleDay}
                                                    onChange={(e) => setScheduleDay(e.target.value)}
                                                    className="w-full bg-proxmox-dark border border-proxmox-border rounded-lg px-3 py-2 text-white"
                                                >
                                                    <option value="monday">{t('monday') || 'Monday'}</option>
                                                    <option value="tuesday">{t('tuesday') || 'Tuesday'}</option>
                                                    <option value="wednesday">{t('wednesday') || 'Wednesday'}</option>
                                                    <option value="thursday">{t('thursday') || 'Thursday'}</option>
                                                    <option value="friday">{t('friday') || 'Friday'}</option>
                                                    <option value="saturday">{t('saturday') || 'Saturday'}</option>
                                                    <option value="sunday">{t('sunday') || 'Sunday'}</option>
                                                    {scheduleType === 'recurring' && <option value="daily">{t('daily') || 'Daily'}</option>}
                                                </select>
                                            </div>
                                            
                                            {/* Time Selection */}
                                            <div>
                                                <label className="text-xs text-gray-400 block mb-1">{t('updateTime') || 'Update Time'}</label>
                                                <input
                                                    type="time"
                                                    value={scheduleTime}
                                                    onChange={(e) => setScheduleTime(e.target.value)}
                                                    className="w-full bg-proxmox-dark border border-proxmox-border rounded-lg px-3 py-2 text-white"
                                                />
                                                <p className="text-xs text-gray-500 mt-1">{t('serverTimezone') || 'Server timezone'}</p>
                                            </div>
                                            
                                            {/* Options */}
                                            <div className="space-y-2 pt-2 border-t border-proxmox-border">
                                                <label className="flex items-center gap-2 cursor-pointer">
                                                    <input
                                                        type="checkbox"
                                                        checked={scheduleReboot}
                                                        onChange={(e) => setScheduleReboot(e.target.checked)}
                                                        className="rounded bg-proxmox-darker border-proxmox-border text-proxmox-orange focus:ring-proxmox-orange"
                                                    />
                                                    <span className="text-white text-sm">{t('includeReboot') || 'Include reboot after update'}</span>
                                                </label>
                                                
                                                <label className="flex items-center gap-2 cursor-pointer">
                                                    <input
                                                        type="checkbox"
                                                        checked={scheduleSkipEvacuation}
                                                        onChange={(e) => setScheduleSkipEvacuation(e.target.checked)}
                                                        className="rounded bg-proxmox-darker border-proxmox-border text-red-500 focus:ring-red-500"
                                                    />
                                                    <span className="text-red-400 text-sm">{t('skipEvacuation') || 'Skip VM evacuation'}</span>
                                                    <span className="text-xs bg-red-900/30 text-red-400 px-1.5 py-0.5 rounded">{t('notRecommended') || 'NOT RECOMMENDED'}</span>
                                                </label>
                                            </div>
                                            
                                            {/* Info Box */}
                                            <div className="bg-blue-500/10 border border-blue-500/30 rounded-lg p-3 text-sm">
                                                <div className="flex items-start gap-2">
                                                    <Icons.Info className="text-blue-400 mt-0.5 flex-shrink-0" />
                                                    <div className="text-blue-300">
                                                        {scheduleType === 'once' 
                                                            ? (t('runOnceInfo') || 'The update will run once at the scheduled time and then disable itself.')
                                                            : (t('autoUpdateInfo') || 'Nodes will be updated one by one. VMs will be automatically migrated during maintenance. Up-to-date nodes are skipped.')
                                                        }
                                                    </div>
                                                </div>
                                            </div>
                                        </>
                                    )}
                                </div>
                                
                                <div className="flex gap-3 justify-end mt-6">
                                    <button
                                        onClick={() => setShowScheduleModal(false)}
                                        className="px-4 py-2 bg-proxmox-dark text-gray-300 rounded-lg hover:bg-proxmox-hover transition-colors"
                                    >
                                        {t('cancel')}
                                    </button>
                                    <button
                                        onClick={saveUpdateSchedule}
                                        disabled={scheduleSaving}
                                        className="px-4 py-2 bg-proxmox-orange text-white rounded-lg hover:bg-orange-600 transition-colors disabled:opacity-50 flex items-center gap-2"
                                    >
                                        {scheduleSaving && <Icons.RotateCw className="animate-spin" />}
                                        {t('save')}
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // SMBIOS Auto-Config Section Component
        // LW: this whole feature started because Windows kept complaining about hardware changes after migrations
        function SmbiosAutoConfigSection({ clusterId, selectedCluster, updateConfig, addToast }) {
            const { t } = useTranslation();
            const { getAuthHeaders } = useAuth();
            const [smbiosStatus, setSmbiosStatus] = useState({});
            const [smbiosLoading, setSmbiosLoading] = useState(false);
            const [smbiosActionLoading, setSmbiosActionLoading] = useState({});  // per-node loading state
            
            // Local authFetch for this component - NS Jan 2026
            const authFetch = (url, opts = {}) => fetch(url, { ...opts, credentials: 'include', headers: { ...opts.headers, ...getAuthHeaders() } });
            
            // Load status for all nodes - chatgpt suggested polling but thats overkill imo
            const loadSmbiosStatus = async () => {
                if (!clusterId) return;
                setSmbiosLoading(true);
                try {
                    const res = await authFetch(`${API_URL}/clusters/${clusterId}/smbios-autoconfig/status-all`);
                    if (res && res.ok) {
                        const data = await res.json();
                        setSmbiosStatus(data || {});
                    }
                } catch (e) {
                    console.error('Error loading SMBIOS status:', e);
                }
                setSmbiosLoading(false);
            };
            
            // Load status on mount
            useEffect(() => {
                if (clusterId) {
                    loadSmbiosStatus();
                }
            }, [clusterId]);
            
            // Control service (start/stop/restart)
            const controlService = async (node, action) => {
                setSmbiosActionLoading(prev => ({...prev, [node]: action}));
                try {
                    const res = await authFetch(`${API_URL}/clusters/${clusterId}/nodes/${node}/smbios-autoconfig/control`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ action })
                    });
                    const result = await res.json();
                    if (result.success) {
                        addToast(result.message, 'success');
                        await loadSmbiosStatus();
                    } else {
                        addToast(result.error || 'Action failed', 'error');
                    }
                } catch (e) {
                    addToast('Error: ' + e.message, 'error');
                }
                setSmbiosActionLoading(prev => ({...prev, [node]: null}));
            };
            
            // Remove from node
            const removeFromNode = async (node) => {
                if (!confirm(`Remove SMBIOS Auto-Config from ${node}?`)) return;
                setSmbiosActionLoading(prev => ({...prev, [node]: 'remove'}));
                try {
                    const res = await authFetch(`${API_URL}/clusters/${clusterId}/nodes/${node}/smbios-autoconfig`, {
                        method: 'DELETE'
                    });
                    const result = await res.json();
                    if (result.success) {
                        addToast(result.message, 'success');
                        await loadSmbiosStatus();
                    } else {
                        addToast(result.error || 'Remove failed', 'error');
                    }
                } catch (e) {
                    addToast('Error: ' + e.message, 'error');
                }
                setSmbiosActionLoading(prev => ({...prev, [node]: null}));
            };
            
            // Deploy to all nodes
            const deployToAll = async () => {
                if (!confirm(t('deploySmbiosConfirm') || 'Deploy SMBIOS Auto-Config to all nodes?')) return;
                setSmbiosLoading(true);
                try {
                    // Save config first
                    await authFetch(`${API_URL}/clusters/${clusterId}/smbios-autoconfig`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            manufacturer: selectedCluster?.smbios_manufacturer || 'Proxmox',
                            product: selectedCluster?.smbios_product || 'PegaProxManagment',
                            version: selectedCluster?.smbios_version || 'v1',
                            family: selectedCluster?.smbios_family || 'ProxmoxVE'
                        })
                    });
                    
                    // Deploy
                    const res = await authFetch(`${API_URL}/clusters/${clusterId}/smbios-autoconfig/deploy-all`, {
                        method: 'POST'
                    });
                    const result = await res.json();
                    if (result.success) {
                        addToast(result.message, 'success');
                        if (updateConfig) updateConfig('smbios_enabled', true);
                        await loadSmbiosStatus();
                    } else {
                        addToast(result.error || 'Deploy failed', 'error');
                    }
                } catch (e) {
                    addToast('Error: ' + e.message, 'error');
                }
                setSmbiosLoading(false);
            };
            
            // Count running nodes
            const nodeCount = Object.keys(smbiosStatus).length;
            const runningCount = Object.values(smbiosStatus).filter(s => s.running).length;
            const installedCount = Object.values(smbiosStatus).filter(s => s.installed).length;
            
            return (
                <>
                    <div className="flex items-center justify-between mb-4">
                        <h3 className="font-semibold flex items-center gap-2">
                            <Icons.Cpu className="w-5 h-5" />
                            SMBIOS Auto-Configurator
                        </h3>
                        <div className="flex items-center gap-2">
                            <button
                                onClick={loadSmbiosStatus}
                                disabled={smbiosLoading}
                                className="p-1.5 rounded-lg hover:bg-proxmox-dark text-gray-400 hover:text-white transition-colors"
                                title={t('refresh') || 'Refresh'}
                            >
                                <Icons.RefreshCw className={`w-4 h-4 ${smbiosLoading ? 'animate-spin' : ''}`} />
                            </button>
                            {nodeCount > 0 && (
                                <span className={`px-2 py-1 rounded-full text-xs font-medium ${
                                    runningCount === nodeCount && runningCount > 0
                                        ? 'bg-green-500/20 text-green-400'
                                        : runningCount > 0
                                            ? 'bg-yellow-500/20 text-yellow-400'
                                            : installedCount > 0
                                                ? 'bg-orange-500/20 text-orange-400'
                                                : 'bg-gray-500/20 text-gray-400'
                                }`}>
                                    {runningCount}/{nodeCount} {t('running') || 'running'}
                                </span>
                            )}
                        </div>
                    </div>
                    
                    <p className="text-sm text-gray-400 mb-4">
                        {t('smbiosAutoDesc') || 'Automatically configures SMBIOS data (Manufacturer, Product, Serial) for new VMs and VMs without SMBIOS configuration. Useful for Windows licensing.'}
                    </p>
                    
                    {/* Settings */}
                    <div className="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label className="block text-xs text-gray-400 mb-1">Manufacturer</label>
                            <input 
                                type="text" 
                                value={selectedCluster?.smbios_manufacturer || 'Proxmox'} 
                                onChange={(e) => updateConfig && updateConfig('smbios_manufacturer', e.target.value)}
                                className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white text-sm"
                            />
                        </div>
                        <div>
                            <label className="block text-xs text-gray-400 mb-1">Product</label>
                            <input 
                                type="text" 
                                value={selectedCluster?.smbios_product || 'PegaProxManagment'} 
                                onChange={(e) => updateConfig && updateConfig('smbios_product', e.target.value)}
                                className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white text-sm"
                            />
                        </div>
                        <div>
                            <label className="block text-xs text-gray-400 mb-1">Version</label>
                            <input 
                                type="text" 
                                value={selectedCluster?.smbios_version || 'v1'} 
                                onChange={(e) => updateConfig && updateConfig('smbios_version', e.target.value)}
                                className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white text-sm"
                            />
                        </div>
                        <div>
                            <label className="block text-xs text-gray-400 mb-1">Family</label>
                            <input 
                                type="text" 
                                value={selectedCluster?.smbios_family || 'ProxmoxVE'} 
                                onChange={(e) => updateConfig && updateConfig('smbios_family', e.target.value)}
                                className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white text-sm"
                            />
                        </div>
                    </div>
                    
                    {/* Deploy Button */}
                    <div className="flex gap-3 mb-4">
                        <button
                            onClick={deployToAll}
                            disabled={smbiosLoading}
                            className="flex items-center gap-2 px-4 py-2 bg-green-600 rounded-lg text-white text-sm font-medium hover:bg-green-500 transition-colors disabled:opacity-50"
                        >
                            {smbiosLoading ? <Icons.RotateCw className="w-4 h-4 animate-spin" /> : <Icons.Download className="w-4 h-4" />}
                            {installedCount > 0 ? (t('updateAllNodes') || 'Update All Nodes') : (t('deployToAllNodes') || 'Deploy to All Nodes')}
                        </button>
                    </div>
                    
                    {/* Per-Node Status */}
                    {nodeCount > 0 && (
                        <div className="space-y-2">
                            <div className="text-xs text-gray-500 font-medium">{t('nodeStatus') || 'Node Status'}:</div>
                            {Object.entries(smbiosStatus).map(([nodeName, status]) => (
                                <div key={nodeName} className="bg-proxmox-dark rounded-lg border border-proxmox-border overflow-hidden">
                                    <div className="flex items-center justify-between p-3">
                                        <div className="flex items-center gap-3">
                                            <div className={`w-2 h-2 rounded-full ${
                                                status.running ? 'bg-green-500' : status.installed ? 'bg-yellow-500' : 'bg-gray-500'
                                            }`} />
                                            <span className="text-sm text-white font-medium">{nodeName}</span>
                                            <span className={`text-xs px-2 py-0.5 rounded ${
                                                status.running ? 'bg-green-500/20 text-green-400' : 
                                                status.installed ? 'bg-yellow-500/20 text-yellow-400' : 
                                                'bg-gray-500/20 text-gray-400'
                                            }`}>
                                                {status.running ? t('running') || 'Running' : status.installed ? t('stopped') || 'Stopped' : t('notInstalled') || 'Not Installed'}
                                            </span>
                                            {status.error && (
                                                <span className="text-xs text-red-400">{status.error}</span>
                                            )}
                                        </div>
                                        {status.installed && (
                                            <div className="flex items-center gap-1">
                                            {status.running ? (
                                                <button
                                                    onClick={() => controlService(nodeName, 'stop')}
                                                    disabled={smbiosActionLoading[nodeName]}
                                                    className="p-1.5 rounded hover:bg-red-500/20 text-gray-400 hover:text-red-400 transition-colors disabled:opacity-50"
                                                    title={t('stop') || 'Stop'}
                                                >
                                                    {smbiosActionLoading[nodeName] === 'stop' ? <Icons.RotateCw className="w-4 h-4 animate-spin" /> : <Icons.Square className="w-4 h-4" />}
                                                </button>
                                            ) : (
                                                <button
                                                    onClick={() => controlService(nodeName, 'start')}
                                                    disabled={smbiosActionLoading[nodeName]}
                                                    className="p-1.5 rounded hover:bg-green-500/20 text-gray-400 hover:text-green-400 transition-colors disabled:opacity-50"
                                                    title={t('start') || 'Start'}
                                                >
                                                    {smbiosActionLoading[nodeName] === 'start' ? <Icons.RotateCw className="w-4 h-4 animate-spin" /> : <Icons.Play className="w-4 h-4" />}
                                                </button>
                                            )}
                                            <button
                                                onClick={() => controlService(nodeName, 'restart')}
                                                disabled={smbiosActionLoading[nodeName]}
                                                className="p-1.5 rounded hover:bg-orange-500/20 text-gray-400 hover:text-orange-400 transition-colors disabled:opacity-50"
                                                title={t('restart') || 'Restart'}
                                            >
                                                {smbiosActionLoading[nodeName] === 'restart' ? <Icons.RotateCw className="w-4 h-4 animate-spin" /> : <Icons.RefreshCw className="w-4 h-4" />}
                                            </button>
                                            <button
                                                onClick={() => controlService(nodeName, 'rescan')}
                                                disabled={smbiosActionLoading[nodeName]}
                                                className="p-1.5 rounded hover:bg-blue-500/20 text-gray-400 hover:text-blue-400 transition-colors disabled:opacity-50"
                                                title={t('rescanAllVms') || 'Rescan all VMs'}
                                            >
                                                {smbiosActionLoading[nodeName] === 'rescan' ? <Icons.RotateCw className="w-4 h-4 animate-spin" /> : <Icons.Search className="w-4 h-4" />}
                                            </button>
                                            <button
                                                onClick={() => removeFromNode(nodeName)}
                                                disabled={smbiosActionLoading[nodeName]}
                                                className="p-1.5 rounded hover:bg-red-500/20 text-gray-400 hover:text-red-400 transition-colors disabled:opacity-50"
                                                title={t('remove') || 'Remove'}
                                            >
                                                {smbiosActionLoading[nodeName] === 'remove' ? <Icons.RotateCw className="w-4 h-4 animate-spin" /> : <Icons.Trash className="w-4 h-4" />}
                                            </button>
                                        </div>
                                    )}
                                    </div>
                                    {/* Logs - show last entries */}
                                    {status.logs && status.logs !== 'No logs yet' && (
                                        <div className="px-3 pb-3 pt-0">
                                            <details className="text-xs">
                                                <summary className="cursor-pointer text-gray-500 hover:text-gray-400">
                                                    {t('showLogs') || 'Show logs'}
                                                </summary>
                                                <pre className="mt-2 p-2 bg-black/50 rounded text-[10px] text-gray-400 overflow-x-auto max-h-32 overflow-y-auto font-mono whitespace-pre-wrap">
                                                    {status.logs}
                                                </pre>
                                            </details>
                                        </div>
                                    )}
                                </div>
                            ))}
                        </div>
                    )}
                    
                    {nodeCount === 0 && !smbiosLoading && (
                        <div className="text-center py-4 text-gray-500 text-sm">
                            {t('clickDeployToStart') || 'Click "Deploy to All Nodes" to get started'}
                        </div>
                    )}
                </>
            );
        }

        // Datastore Tab Component - with Storage Clusters for balancing
        function DatastoreTab({ clusterId, addToast }) {
            const { t } = useTranslation();
            const { getAuthHeaders, isAdmin } = useAuth();
            const [loading, setLoading] = useState(true);
            const [datastores, setDatastores] = useState({ shared: [], local: {}, nodes: [] });
            const [selectedStorage, setSelectedStorage] = useState(null);
            const [storageContent, setStorageContent] = useState([]);
            const [contentLoading, setContentLoading] = useState(false);
            const [expandedNodes, setExpandedNodes] = useState({});
            const [activeTab, setActiveTab] = useState('browse'); // browse, balancing
            const [uploadModalOpen, setUploadModalOpen] = useState(false);
            const [uploadFile, setUploadFile] = useState(null);
            const [uploading, setUploading] = useState(false);
            const [uploadProgress, setUploadProgress] = useState(0);
            const [uploadSpeed, setUploadSpeed] = useState(0);
            const [deleteConfirm, setDeleteConfirm] = useState(null);
            const [isRefreshing, setIsRefreshing] = useState(false);  // not used
            const lastFetchTime = useRef(0);  // for rate limiting, not implemented
            
            // NS: URL Download state - Jan 2026
            const [downloadUrlModalOpen, setDownloadUrlModalOpen] = useState(false);
            const [downloadUrl, setDownloadUrl] = useState('');
            const [downloadFilename, setDownloadFilename] = useState('');
            const [urlDownloading, setUrlDownloading] = useState(false);
            const [urlDownloadProgress, setUrlDownloadProgress] = useState(null);
            
            // NS: Template download state - Jan 2026
            const [showTemplateModal, setShowTemplateModal] = useState(false);
            const [availableTemplates, setAvailableTemplates] = useState([]);
            const [templatesLoading, setTemplatesLoading] = useState(false);
            const [templateFilter, setTemplateFilter] = useState('');
            const [downloadingTemplate, setDownloadingTemplate] = useState(null);
            
            // Refs to prevent unnecessary re-renders and track state
            const datastoresRef = useRef(null);
            const fetchingRef = useRef(false);
            const initialLoadDone = useRef(false);
            const _mountedRef = useRef(true);  // cleanup
            
            // Storage Clusters state
            const [storageClusters, setStorageClusters] = useState([]);
            const [selectedCluster, setSelectedCluster] = useState(null);
            const [clusterStatus, setClusterStatus] = useState(null);
            const [showCreateCluster, setShowCreateCluster] = useState(false);
            const [newClusterName, setNewClusterName] = useState('');
            const [newClusterStorages, setNewClusterStorages] = useState([]);
            const [newClusterThreshold, setNewClusterThreshold] = useState(20);
            const [balancingLoading, setBalancingLoading] = useState(false);
            
            // NS: ESXi Integration state - Dec 2025
            const [esxiHosts, setEsxiHosts] = useState([]);
            const [showAddEsxi, setShowAddEsxi] = useState(false);
            const [esxiForm, setEsxiForm] = useState({ host: '', username: 'root', password: '' });
            const [esxiLoading, setEsxiLoading] = useState(false);
            const [selectedEsxi, setSelectedEsxi] = useState(null);
            const [esxiVms, setEsxiVms] = useState([]);
            const [esxiVmsLoading, setEsxiVmsLoading] = useState(false);
            
            // Debounce timer for threshold updates
            const thresholdTimer = useRef(null);
            
            /* LW: wrapped fetch with auth headers + error handling
               returns null on failure so you can do: if(!res) return; */
            const authFetch = async (url, opts = {}) => {
                try {
                    const res = await fetch(url, { ...opts, credentials: 'include', headers: { ...opts.headers, ...getAuthHeaders() } });
                    return res;
                } catch (e) {
                    console.error('fetch failed:', e);
                    return null;
                }
            };
            
            // old helper, keeping for now
            const _authFetchOld = async (url, options) => {
                return fetch(url, { ...options, headers: { ...options?.headers, ...getAuthHeaders() } })
                  .catch(err => { console.error(err); return null })
            };
            
            // NS: Load available templates from Proxmox repository
            const loadAvailableTemplates = async () => {
                setTemplatesLoading(true);
                try {
                    const res = await authFetch(`${API_URL}/clusters/${clusterId}/templates/available`);
                    if (res?.ok) {
                        const data = await res.json();
                        setAvailableTemplates(data || []);
                    } else {
                        console.error('Failed to load templates');
                    }
                } catch (e) {
                    console.error('Error loading templates:', e);
                }
                setTemplatesLoading(false);
            };
            
            // NS: Download template to storage
            const downloadTemplate = async (template, storage) => {
                setDownloadingTemplate(template.template);
                try {
                    const res = await authFetch(`${API_URL}/clusters/${clusterId}/templates/download`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            storage: storage,
                            template: template.template
                        })
                    });
                    if (res?.ok) {
                        const data = await res.json();
                        addToast(`${t('downloadStarted') || 'Download started'}: ${template.package || template.template}`, 'success');
                        // Refresh storage content after a short delay
                        setTimeout(() => {
                            if (selectedStorage?.name === storage) {
                                loadStorageContent(storage, selectedStorage.node);
                            }
                        }, 2000);
                    } else {
                        const err = await res.json();
                        addToast(`${t('downloadFailed') || 'Download failed'}: ${err.error || 'Unknown error'}`, 'error');
                    }
                } catch (e) {
                    console.error('Error downloading template:', e);
                    addToast(`${t('error') || 'Error'}: ${e.message}`, 'error');
                }
                setDownloadingTemplate(null);
            };
            
            // Stable sort function - always sorts alphabetically
            const stableSortData = (data) => {
                if (!data) return data;
                
                // sort shared alphabeticaly
                const sortedShared = [...(data.shared || [])].sort((a, b) => 
                    (a.storage || '').localeCompare(b.storage || '')
                );
                
                // sort nodes  
                const sortedNodes = [...(data.nodes || [])].sort((a, b) => a.localeCompare(b));
                
                // sort local per node
                const sortedLocal = {};
                for (const node of sortedNodes) {
                    if (data.local && data.local[node]) {
                        sortedLocal[node] = [...data.local[node]].sort((a, b) => 
                            (a.storage || '').localeCompare(b.storage || '')
                        );
                    }
                }
                
                return {
                    shared: sortedShared,
                    local: sortedLocal,
                    nodes: sortedNodes
                };
            };
            
            useEffect(() => {
                // LW: Reset ALL cluster-specific state when cluster changes
                // This prevents showing stale data from previous cluster
                setSelectedStorage(null);
                setStorageContent([]);
                setStorageClusters([]);  // NS: also reset storage clusters
                setSelectedCluster(null);
                setClusterStatus(null);
                setEsxiHosts([]);  // NS: reset ESXi hosts too
                setSelectedEsxi(null);
                setEsxiVms([]);
                
                // Reset refs
                initialLoadDone.current = false;  // Allow loading spinner again
                datastoresRef.current = null;  // Clear cached data
                fetchingRef.current = false;  // Reset fetch lock
                
                fetchDatastores();
                fetchStorageClusters();
            }, [clusterId]);
            
            const fetchDatastores = async () => {
                // prevent concurrent fetches
                if (fetchingRef.current) return;
                fetchingRef.current = true;
                
                // Only show loading spinner on initial load
                if (!initialLoadDone.current) {
                    setLoading(true);
                }
                
                try {
                    const resp = await authFetch(`${API_URL}/clusters/${clusterId}/datastores`);
                    if (resp && resp.ok) {
                        const rawData = await resp.json();
                        // console.log('datastores raw:', rawData);
                        
                        // Apply stable sorting
                        const data = stableSortData(rawData);
                        
                        // Create a comparable string (only compare essential data, not usage which changes)
                        // ns: this is kinda hacky but prevents flickering
                        const getEssentialData = (d) => ({
                            shared: d.shared?.map(s => s.storage).sort(),
                            nodes: d.nodes?.sort(),
                            localKeys: Object.keys(d.local || {}).sort()
                        });
                        
                        const currentEssential = JSON.stringify(getEssentialData(data));
                        const prevEssential = datastoresRef.current ? 
                            JSON.stringify(getEssentialData(datastoresRef.current)) : null;
                        
                        // Only update if structure changed (not just usage percentages)
                        if (currentEssential !== prevEssential || !initialLoadDone.current) {
                            datastoresRef.current = data;
                            setDatastores(data);
                            
                            // Only set expanded nodes on first load
                            if (!initialLoadDone.current) {
                                const expanded = { shared: true };
                                data.nodes?.forEach(n => expanded[n] = true);
                                setExpandedNodes(expanded);
                            }
                        } else {
                            // update usage data without triggering re-render of structure
                            datastoresRef.current = data;
                            setDatastores(data);  // prev => data
                        }
                        
                        initialLoadDone.current = true;
                    }
                } catch (err) {
                    console.error('fetching datastores:', err);
                } finally {
                    setLoading(false);
                    fetchingRef.current = false;
                }
            };
            
            // storage clusters (ceph etc)
            const fetchStorageClusters = async () => {
                try {
                    const r = await authFetch(`${API_URL}/clusters/${clusterId}/storage-clusters`);
                    if (r?.ok) {
                        setStorageClusters(await r.json());
                    }
                } catch (e) {
                    console.error('fetching storage clusters:', e);
                }
            };
            
            const loadClusterStatus = async (scId) => {
                setBalancingLoading(true);
                try {
                    const response = await authFetch(`${API_URL}/clusters/${clusterId}/storage-clusters/${scId}/status`);
                    if (response && response.ok) {
                        setClusterStatus(await response.json());
                    }
                } catch (error) {
                    console.error('loading cluster status:', error);
                } finally {
                    setBalancingLoading(false);
                }
            };
            
            const createStorageCluster = async () => {
                if (!newClusterName.trim() || newClusterStorages.length < 2) {
                    alert(t('needTwoStorages') || 'Need at least 2 storages');
                    return;
                }
                try {
                    const response = await authFetch(`${API_URL}/clusters/${clusterId}/storage-clusters`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            name: newClusterName,
                            storages: newClusterStorages,
                            threshold: newClusterThreshold
                        })
                    });
                    if (response && response.ok) {
                        setShowCreateCluster(false);
                        setNewClusterName('');
                        setNewClusterStorages([]);
                        setNewClusterThreshold(20);
                        fetchStorageClusters();
                    } else {
                        const err = await response.json();
                        alert(err.error || 'Failed to create');
                    }
                } catch (error) {
                    console.error('creating storage cluster:', error);
                }
            };
            
            const updateClusterThreshold = (scId, threshold) => {
                // update local state immediately
                setStorageClusters(prev => prev.map(sc => 
                    sc.id === scId ? { ...sc, threshold } : sc
                ));
                if (clusterStatus?.id === scId) {
                    setClusterStatus(prev => prev ? { ...prev, threshold } : null);
                }
                
                // Debounce API call
                if (thresholdTimer.current) clearTimeout(thresholdTimer.current);
                thresholdTimer.current = setTimeout(async () => {
                    try {
                        await authFetch(`${API_URL}/clusters/${clusterId}/storage-clusters/${scId}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ threshold })
                        });
                    } catch (error) {
                        console.error('updating threshold:', error);
                    }
                }, 500);
            };
            
            const toggleClusterEnabled = async (scId, enabled) => {
                try {
                    await authFetch(`${API_URL}/clusters/${clusterId}/storage-clusters/${scId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ enabled })
                    });
                    setStorageClusters(prev => prev.map(sc => 
                        sc.id === scId ? { ...sc, enabled } : sc
                    ));
                } catch (error) {
                    console.error('toggling cluster:', error);
                }
            };
            
            const toggleAutoBalance = async (scId, auto_balance) => {
                try {
                    await authFetch(`${API_URL}/clusters/${clusterId}/storage-clusters/${scId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ auto_balance })
                    });
                    setStorageClusters(prev => prev.map(sc => 
                        sc.id === scId ? { ...sc, auto_balance } : sc
                    ));
                } catch (error) {
                    console.error('toggling auto-balance:', error);
                }
            };
            
            const deleteStorageCluster = async (scId) => {
                if (!confirm(t('confirmDeleteCluster') || 'Delete this storage cluster?')) return;
                try {
                    const response = await authFetch(`${API_URL}/clusters/${clusterId}/storage-clusters/${scId}`, {
                        method: 'DELETE'
                    });
                    if (response && response.ok) {
                        setStorageClusters(prev => prev.filter(sc => sc.id !== scId));
                        if (selectedCluster === scId) {
                            setSelectedCluster(null);
                            setClusterStatus(null);
                        }
                    }
                } catch (error) {
                    console.error('deleting storage cluster:', error);
                }
            };
            
            const addStorageToCluster = async (scId, storageName) => {
                const cluster = storageClusters.find(sc => sc.id === scId);
                if (!cluster) return;
                
                const newStorages = [...cluster.storages, storageName];
                try {
                    await authFetch(`${API_URL}/clusters/${clusterId}/storage-clusters/${scId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ storages: newStorages })
                    });
                    fetchStorageClusters();
                    if (selectedCluster === scId) loadClusterStatus(scId);
                } catch (error) {
                    console.error('adding storage:', error);
                }
            };
            
            const removeStorageFromCluster = async (scId, storageName) => {
                const cluster = storageClusters.find(sc => sc.id === scId);
                if (!cluster || cluster.storages.length <= 2) {
                    alert(t('minTwoStorages') || 'Minimum 2 storages required');
                    return;
                }
                
                const newStorages = cluster.storages.filter(s => s !== storageName);
                try {
                    await authFetch(`${API_URL}/clusters/${clusterId}/storage-clusters/${scId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ storages: newStorages })
                    });
                    fetchStorageClusters();
                    if (selectedCluster === scId) loadClusterStatus(scId);
                } catch (error) {
                    console.error('removing storage:', error);
                }
            };
            
            const executeMigration = async (rec) => {
                if (!confirm(`Move ${rec.disk} of ${rec.vm_name} from ${rec.source} to ${rec.target}?`)) return;
                try {
                    const response = await authFetch(`${API_URL}/clusters/${clusterId}/storage-balancing/migrate`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            vmid: rec.vmid,
                            disk: rec.disk,
                            target: rec.target
                        })
                    });
                    if (response && response.ok) {
                        alert(t('migrationStarted') || 'Migration started!');
                        if (selectedCluster) loadClusterStatus(selectedCluster);
                    } else {
                        const err = await response.json();
                        alert(err.error || 'Migration failed');
                    }
                } catch (error) {
                    console.error('executing migration:', error);
                }
            };
            
            const loadStorageContent = async (storageName, node) => {
                setContentLoading(true);
                setSelectedStorage({ name: storageName, node });
                try {
                    const url = node 
                        ? `${API_URL}/clusters/${clusterId}/datastores/${storageName}/content?node=${node}`
                        : `${API_URL}/clusters/${clusterId}/datastores/${storageName}/content`;
                    const response = await authFetch(url);
                    if (response && response.ok) {
                        setStorageContent(await response.json());
                    }
                } catch (error) {
                    console.error('loading content:', error);
                } finally {
                    setContentLoading(false);
                }
            };
            
            const handleDelete = async (item) => {
                try {
                    const url = `${API_URL}/clusters/${clusterId}/datastores/${selectedStorage.name}/content/${encodeURIComponent(item.volid)}?node=${selectedStorage.node || ''}`;
                    const response = await authFetch(url, { method: 'DELETE' });
                    
                    if (response && response.ok) {
                        setStorageContent(prev => prev.filter(i => i.volid !== item.volid));
                        setDeleteConfirm(null);
                    } else {
                        const err = await response.json();
                        alert(err.error || 'Delete failed');
                    }
                } catch (error) {
                    console.error('deleting:', error);
                    alert('Delete failed');
                }
            };
            
            const handleUpload = async () => {
                if (!uploadFile || !selectedStorage) return;
                
                setUploading(true);
                setUploadProgress(0);
                setUploadSpeed(0);
                
                const formData = new FormData();
                formData.append('file', uploadFile);
                formData.append('content', 'iso');
                if (selectedStorage.node) {
                    formData.append('node', selectedStorage.node);
                }
                
                // Use XMLHttpRequest for progress tracking
                const xhr = new XMLHttpRequest();
                const startTime = Date.now();
                let lastLoaded = 0;
                let lastTime = startTime;
                
                xhr.upload.addEventListener('progress', (e) => {
                    if (e.lengthComputable) {
                        const percent = Math.round((e.loaded / e.total) * 100);
                        setUploadProgress(percent);
                        
                        // calc speed
                        const now = Date.now();
                        const timeDiff = (now - lastTime) / 1000; // seconds
                        if (timeDiff > 0.5) { // update speed every 500ms
                            const bytesDiff = e.loaded - lastLoaded;
                            const speed = bytesDiff / timeDiff; // bytes per second
                            setUploadSpeed(speed);
                            lastLoaded = e.loaded;
                            lastTime = now;
                        }
                    }
                });
                
                xhr.addEventListener('load', () => {
                    if (xhr.status >= 200 && xhr.status < 300) {
                        setUploadModalOpen(false);
                        setUploadFile(null);
                        setUploadProgress(0);
                        setUploadSpeed(0);
                        // refresh after delay
                        setTimeout(() => loadStorageContent(selectedStorage.name, selectedStorage.node), 2000);
                    } else {
                        try {
                            const err = JSON.parse(xhr.responseText);
                            alert(err.error || 'Upload failed');
                        } catch {
                            alert('Upload failed');
                        }
                    }
                    setUploading(false);
                });
                
                xhr.addEventListener('error', () => {
                    console.error('Upload error');
                    alert('Upload failed - network error');
                    setUploading(false);
                    setUploadProgress(0);
                    setUploadSpeed(0);
                });
                
                xhr.addEventListener('abort', () => {
                    setUploading(false);
                    setUploadProgress(0);
                    setUploadSpeed(0);
                });
                
                xhr.open('POST', `${API_URL}/clusters/${clusterId}/datastores/${selectedStorage.name}/upload`);
                
                // auth headers
                const headers = getAuthHeaders();
                for (const [key, value] of Object.entries(headers)) {
                    xhr.setRequestHeader(key, value);
                }
                
                xhr.send(formData);
            };
            
            const formatSpeed = (bytesPerSec) => {
                if (!bytesPerSec) return '0 B/s';
                const units = ['B/s', 'KB/s', 'MB/s', 'GB/s'];
                let i = 0;
                while (bytesPerSec >= 1024 && i < units.length - 1) { 
                    bytesPerSec /= 1024; 
                    i++; 
                }
                return `${bytesPerSec.toFixed(1)} ${units[i]}`;
            };
            
            // NS: Download ISO from URL - Jan 2026 (like Proxmox)
            const handleDownloadFromUrl = async () => {
                if (!downloadUrl || !selectedStorage) return;
                
                // Extract filename from URL if not provided
                let filename = downloadFilename.trim();
                if (!filename) {
                    try {
                        const urlPath = new URL(downloadUrl).pathname;
                        filename = urlPath.split('/').pop() || 'download.iso';
                    } catch {
                        filename = 'download.iso';
                    }
                }
                
                // Ensure .iso extension
                if (!filename.toLowerCase().endsWith('.iso') && !filename.toLowerCase().endsWith('.img')) {
                    filename += '.iso';
                }
                
                setUrlDownloading(true);
                setUrlDownloadProgress({ status: 'starting', percent: 0, message: t('startingDownload') || 'Starting download...' });
                
                try {
                    const response = await authFetch(`${API_URL}/clusters/${clusterId}/datastores/${selectedStorage.name}/download-url`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            url: downloadUrl,
                            filename: filename,
                            node: selectedStorage.node || ''
                        })
                    });
                    
                    if (response && response.ok) {
                        const data = await response.json();
                        const taskId = data.task_id;
                        
                        // Poll for progress
                        const pollInterval = setInterval(async () => {
                            try {
                                const statusResp = await authFetch(`${API_URL}/clusters/${clusterId}/datastores/${selectedStorage.name}/download-status/${taskId}`);
                                if (statusResp && statusResp.ok) {
                                    const status = await statusResp.json();
                                    setUrlDownloadProgress(status);
                                    
                                    if (status.status === 'completed') {
                                        clearInterval(pollInterval);
                                        setUrlDownloading(false);
                                        setDownloadUrlModalOpen(false);
                                        setDownloadUrl('');
                                        setDownloadFilename('');
                                        // Refresh content
                                        setTimeout(() => loadStorageContent(selectedStorage.name, selectedStorage.node), 1000);
                                    } else if (status.status === 'error') {
                                        clearInterval(pollInterval);
                                        setUrlDownloading(false);
                                        alert(status.message || t('downloadFailed') || 'Download failed');
                                    }
                                }
                            } catch (e) {
                                console.error('Polling download status:', e);
                            }
                        }, 1000);
                        
                        // Cleanup after 30 min max
                        setTimeout(() => clearInterval(pollInterval), 30 * 60 * 1000);
                        
                    } else {
                        const err = await response.json();
                        alert(err.error || t('downloadFailed') || 'Download failed');
                        setUrlDownloading(false);
                    }
                } catch (error) {
                    console.error('Download from URL error:', error);
                    alert(t('downloadFailed') || 'Download failed');
                    setUrlDownloading(false);
                }
            };
            
            // NS: ESXi Integration functions - Dec 2025
            const fetchEsxiHosts = async () => {
                try {
                    const r = await authFetch(`${API_URL}/clusters/${clusterId}/esxi-hosts`);
                    if (r?.ok) setEsxiHosts(await r.json());
                } catch (e) {
                    console.error('fetching esxi hosts:', e);
                }
            };
            
            const connectEsxiHost = async () => {
                if (!esxiForm.host || !esxiForm.password) {
                    alert(t('fillAllFields') || 'Please fill all fields');
                    return;
                }
                setEsxiLoading(true);
                try {
                    const r = await authFetch(`${API_URL}/clusters/${clusterId}/esxi-hosts`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(esxiForm)
                    });
                    if (r?.ok) {
                        setShowAddEsxi(false);
                        setEsxiForm({ host: '', username: 'root', password: '' });
                        fetchEsxiHosts();
                    } else {
                        const err = await r.json();
                        alert(err.error || 'Connection failed');
                    }
                } catch (e) {
                    alert('Connection failed');
                } finally {
                    setEsxiLoading(false);
                }
            };
            
            const disconnectEsxiHost = async (hostId) => {
                if (!confirm(t('confirmDisconnect') || 'Disconnect this ESXi host?')) return;
                try {
                    const r = await authFetch(`${API_URL}/clusters/${clusterId}/esxi-hosts/${hostId}`, {
                        method: 'DELETE'
                    });
                    if (r?.ok) {
                        setEsxiHosts(prev => prev.filter(h => h.id !== hostId));
                        if (selectedEsxi === hostId) {
                            setSelectedEsxi(null);
                            setEsxiVms([]);
                        }
                    }
                } catch (e) {
                    console.error('disconnecting esxi:', e);
                }
            };
            
            const fetchEsxiVms = async (hostId) => {
                setSelectedEsxi(hostId);
                setEsxiVmsLoading(true);
                try {
                    const r = await authFetch(`${API_URL}/clusters/${clusterId}/esxi-hosts/${hostId}/vms`);
                    if (r?.ok) setEsxiVms(await r.json());
                } catch (e) {
                    console.error('fetching esxi vms:', e);
                } finally {
                    setEsxiVmsLoading(false);
                }
            };
            
            // NS: Migrate VM from ESXi to Proxmox using native import
            const migrateEsxiVm = async (vm) => {
                // NS: using volid now since thats what proxmox uses
                const volid = vm.volid || vm.id;
                const vmName = vm.name || volid;
                
                if (!confirm(`${t('migrateToProxmox')} "${vmName}"?\n\n${t('esxiMigrationHint') || 'Make sure the VM is powered off on ESXi!'}`)) return;
                
                try {
                    const r = await authFetch(`${API_URL}/clusters/${clusterId}/esxi-hosts/${selectedEsxi}/migrate`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            volid: volid,
                            storage: 'local-lvm'  // TODO: make this configurable
                        })
                    });
                    if (r?.ok) {
                        const result = await r.json();
                        alert(`${t('esxiMigrationStarted') || 'Import started'}\n\nVMID: ${result.vmid || '?'}`);
                        // dont refresh the list, import takes a while
                    } else {
                        const err = await r.json();
                        alert(err.error || 'Import failed');
                    }
                } catch (e) {
                    console.error('esxi import failed:', e);
                    alert('Import failed - check console');
                }
            };
            
            // load esxi hosts on mount
            useEffect(() => {
                fetchEsxiHosts();
            }, [clusterId]);
            
            const toggleNode = (nodeKey) => {
                setExpandedNodes(prev => ({ ...prev, [nodeKey]: !prev[nodeKey] }));
            };
            
            const formatSize = (bytes) => {
                if (!bytes) return '0 B';
                const units = ['B', 'KB', 'MB', 'GB', 'TB'];
                let i = 0;
                while (bytes >= 1024 && i < units.length - 1) { bytes /= 1024; i++; }
                return `${bytes.toFixed(1)} ${units[i]}`;
            };
            
            const getContentIcon = (content) => {
                if (content?.includes('iso')) return 'üíø';
                if (content?.includes('images') || content?.includes('rootdir')) return 'üíæ';
                if (content?.includes('backup')) return 'üì¶';
                if (content?.includes('vztmpl')) return 'üìã';
                return 'üìÅ';
            };
            
            const getTypeColor = (type) => {
                const colors = {
                    'zfspool': 'text-blue-400', 'lvmthin': 'text-purple-400', 'lvm': 'text-purple-400',
                    'dir': 'text-green-400', 'nfs': 'text-yellow-400', 'cifs': 'text-yellow-400',
                    'cephfs': 'text-red-400', 'rbd': 'text-red-400',
                };
                return colors[type] || 'text-gray-400';
            };
            
            const canUploadTo = (storage) => {
                return storage?.content?.includes('iso') || storage?.content?.includes('vztmpl');
            };
            
            if (loading) {
                return (
                    <div className="flex items-center justify-center py-12">
                        <Icons.RotateCw className="animate-spin" />
                        <span className="ml-2">{t('loading')}</span>
                    </div>
                );
            }
            
            const StorageRow = ({ storage, node, isShared }) => {
                const usedPercent = storage.total ? (storage.used / storage.total * 100) : 0;
                const isSelected = selectedStorage?.name === storage.storage && selectedStorage?.node === node;
                
                return (
                    <div 
                        className={`flex items-center justify-between p-3 rounded-lg cursor-pointer transition-all ${
                            isSelected ? 'bg-proxmox-orange/20 border border-proxmox-orange/50' : 'bg-proxmox-dark hover:bg-proxmox-hover'
                        }`}
                        onClick={() => loadStorageContent(storage.storage, node)}
                    >
                        <div className="flex items-center gap-3">
                            <span className="text-lg">{getContentIcon(storage.content)}</span>
                            <div>
                                <div className="font-medium text-white">{storage.storage}</div>
                                <div className="text-xs text-gray-500">
                                    <span className={getTypeColor(storage.type)}>{storage.type}</span>
                                </div>
                            </div>
                        </div>
                        <div className="text-right">
                            <div className="text-sm text-white">{formatSize(storage.used)} / {formatSize(storage.total)}</div>
                            <div className="w-24 h-1.5 bg-proxmox-border rounded-full mt-1">
                                <div 
                                    className={`h-full rounded-full ${usedPercent > 90 ? 'bg-red-500' : usedPercent > 70 ? 'bg-yellow-500' : 'bg-green-500'}`}
                                    style={{ width: `${Math.min(usedPercent, 100)}%` }}
                                />
                            </div>
                        </div>
                    </div>
                );
            };
            
            return (
                <div className="space-y-4">
                    {/* Tab Switcher */}
                    <div className="flex gap-2">
                        <button
                            onClick={() => setActiveTab('browse')}
                            className={`px-4 py-2 rounded-lg text-sm font-medium transition-all ${
                                activeTab === 'browse' ? 'bg-proxmox-orange text-white' : 'bg-proxmox-card text-gray-400 hover:text-white'
                            }`}
                        >
                            <Icons.Folder className="inline mr-2" />
                            {t('browse') || 'Browse'}
                        </button>
                        <button
                            onClick={() => { setActiveTab('balancing'); fetchStorageClusters(); }}
                            className={`px-4 py-2 rounded-lg text-sm font-medium transition-all ${
                                activeTab === 'balancing' ? 'bg-proxmox-orange text-white' : 'bg-proxmox-card text-gray-400 hover:text-white'
                            }`}
                        >
                            <Icons.Zap className="inline mr-2" />
                            Storage Balancing
                        </button>
                    </div>
                    
                    {activeTab === 'browse' ? (
                        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            {/* Storage Tree */}
                            <div className="lg:col-span-1 bg-proxmox-card border border-proxmox-border rounded-xl overflow-hidden">
                                <div className="p-4 border-b border-proxmox-border bg-proxmox-dark">
                                    <h3 className="font-semibold flex items-center gap-2">
                                        <Icons.Database />
                                        {t('datastores') || 'Datastores'}
                                    </h3>
                                </div>
                                <div className="p-4 space-y-4 max-h-[600px] overflow-y-auto">
                                    {/* Shared Storage */}
                                    {datastores.shared?.length > 0 && (
                                        <div>
                                            <button 
                                                className="flex items-center gap-2 w-full text-left p-2 rounded-lg hover:bg-proxmox-hover"
                                                onClick={() => toggleNode('shared')}
                                            >
                                                <span className={`transform transition-transform ${expandedNodes.shared ? 'rotate-90' : ''}`}>‚ñ∂</span>
                                                <Icons.Globe />
                                                <span className="font-medium text-yellow-400">{t('sharedStorage') || 'Shared Storage'}</span>
                                                <span className="text-xs text-gray-500 ml-auto">{datastores.shared.length}</span>
                                            </button>
                                            {expandedNodes.shared && (
                                                <div className="ml-6 mt-2 space-y-2">
                                                    {datastores.shared.map(storage => (
                                                        <StorageRow key={storage.storage} storage={storage} isShared={true} />
                                                    ))}
                                                </div>
                                            )}
                                        </div>
                                    )}
                                    
                                    {/* Local Storage per Node */}
                                    {datastores.nodes?.map(node => (
                                        <div key={node}>
                                            <button 
                                                className="flex items-center gap-2 w-full text-left p-2 rounded-lg hover:bg-proxmox-hover"
                                                onClick={() => toggleNode(node)}
                                            >
                                                <span className={`transform transition-transform ${expandedNodes[node] ? 'rotate-90' : ''}`}>‚ñ∂</span>
                                                <Icons.Server />
                                                <span className="font-medium">{node}</span>
                                                <span className="text-xs text-gray-500 ml-auto">{datastores.local[node]?.length || 0}</span>
                                            </button>
                                            {expandedNodes[node] && datastores.local[node] && (
                                                <div className="ml-6 mt-2 space-y-2">
                                                    {datastores.local[node].map(storage => (
                                                        <StorageRow key={`${node}-${storage.storage}`} storage={storage} node={node} />
                                                    ))}
                                                </div>
                                            )}
                                        </div>
                                    ))}
                                    
                                    {/* NS: ESXi Hosts Section - Dec 2025 */}
                                    <div className="mt-4 pt-4 border-t border-proxmox-border">
                                        <div className="flex items-center justify-between mb-2">
                                            <button 
                                                className="flex items-center gap-2 text-left p-2 rounded-lg hover:bg-proxmox-hover flex-1"
                                                onClick={() => toggleNode('esxi')}
                                            >
                                                <span className={`transform transition-transform ${expandedNodes.esxi ? 'rotate-90' : ''}`}>‚ñ∂</span>
                                                <span className="text-lg">üñ•Ô∏è</span>
                                                <span className="font-medium text-cyan-400">{t('esxiHosts') || 'ESXi Hosts'}</span>
                                                <span className="text-xs text-gray-500 ml-auto">{esxiHosts.length}</span>
                                            </button>
                                            {isAdmin && (
                                                <button
                                                    onClick={() => setShowAddEsxi(true)}
                                                    className="p-1.5 hover:bg-proxmox-hover rounded-lg text-gray-400 hover:text-cyan-400"
                                                    title={t('connectEsxi') || 'Connect ESXi'}
                                                >
                                                    <Icons.Plus />
                                                </button>
                                            )}
                                        </div>
                                        {expandedNodes.esxi && (
                                            <div className="ml-6 space-y-2">
                                                {esxiHosts.length === 0 ? (
                                                    <p className="text-xs text-gray-500 py-2">{t('noEsxiHosts') || 'No ESXi hosts connected'}</p>
                                                ) : (
                                                    esxiHosts.map(host => (
                                                        <div 
                                                            key={host.id}
                                                            className={`flex items-center gap-2 p-2 rounded-lg cursor-pointer transition-colors ${
                                                                selectedEsxi === host.id ? 'bg-cyan-500/20 border border-cyan-500/30' : 'hover:bg-proxmox-hover'
                                                            }`}
                                                            onClick={() => fetchEsxiVms(host.id)}
                                                        >
                                                            <span className={`w-2 h-2 rounded-full ${host.connected ? 'bg-green-500' : 'bg-red-500'}`} />
                                                            <span className="text-sm">{host.host}</span>
                                                            {isAdmin && (
                                                                <button
                                                                    onClick={(e) => { e.stopPropagation(); disconnectEsxiHost(host.id); }}
                                                                    className="ml-auto p-1 hover:bg-red-500/20 rounded text-gray-500 hover:text-red-400"
                                                                    title={t('esxiDisconnect')}
                                                                >
                                                                    <Icons.X className="w-3 h-3" />
                                                                </button>
                                                            )}
                                                        </div>
                                                    ))
                                                )}
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </div>
                            
                            {/* Storage Content / ESXi VMs Panel */}
                            <div className="lg:col-span-2 bg-proxmox-card border border-proxmox-border rounded-xl overflow-hidden">
                                {selectedEsxi ? (
                                    /* LW: ESXi VMs Panel */
                                    <>
                                        <div className="p-4 border-b border-proxmox-border bg-proxmox-dark flex justify-between items-center">
                                            <h3 className="font-semibold flex items-center gap-2">
                                                <span className="text-lg">üñ•Ô∏è</span>
                                                {t('esxiVms') || 'ESXi VMs'}
                                                <span className="text-xs text-gray-500">({esxiHosts.find(h => h.id === selectedEsxi)?.host})</span>
                                            </h3>
                                            <button
                                                onClick={() => { setSelectedEsxi(null); setEsxiVms([]); }}
                                                className="p-1.5 hover:bg-proxmox-hover rounded-lg text-gray-400"
                                            >
                                                <Icons.X />
                                            </button>
                                        </div>
                                        <div className="p-4">
                                            {/* Experimental hint */}
                                            <div className="p-2 bg-cyan-500/10 border border-cyan-500/30 rounded-lg mb-4 flex items-center gap-2">
                                                <span>üß™</span>
                                                <span className="text-xs text-cyan-400">{t('esxiExperimental') || 'ESXi integration is experimental'}</span>
                                            </div>
                                            
                                            {esxiVmsLoading ? (
                                                <div className="flex items-center justify-center py-12">
                                                    <Icons.RotateCw className="animate-spin" />
                                                </div>
                                            ) : esxiVms.length === 0 ? (
                                                <div className="text-center py-12 text-gray-500">
                                                    <p>{t('esxiNoVms') || 'No VMs on this ESXi host'}</p>
                                                </div>
                                            ) : (
                                                <div className="space-y-2">
                                                    {esxiVms.map(vm => (
                                                        <div key={vm.id} className="p-3 bg-proxmox-dark rounded-lg border border-proxmox-border">
                                                            <div className="flex items-center justify-between">
                                                                <div className="flex items-center gap-3">
                                                                    <span className="w-3 h-3 rounded-full bg-gray-500" />
                                                                    <div>
                                                                        <p className="font-medium text-white">{vm.name}</p>
                                                                        <p className="text-xs text-gray-500">
                                                                            {vm.guest_os !== 'Unknown' ? `${vm.guest_os} ‚Ä¢ ` : ''}
                                                                            {vm.num_cpu > 0 ? `${vm.num_cpu} vCPU ‚Ä¢ ` : ''}
                                                                            {vm.memory_mb > 0 ? `${Math.round(vm.memory_mb / 1024)} GB RAM` : ''}
                                                                        </p>
                                                                        {/* LW: show volid for debugging */}
                                                                        <p className="text-xs text-gray-600 font-mono truncate max-w-xs">{vm.volid || vm.id}</p>
                                                                    </div>
                                                                </div>
                                                                <div className="flex items-center gap-2">
                                                                    <button
                                                                        onClick={() => migrateEsxiVm(vm)}
                                                                        className="flex items-center gap-1 px-3 py-1.5 bg-cyan-500/20 hover:bg-cyan-500/30 border border-cyan-500/30 rounded-lg text-cyan-400 text-sm"
                                                                        title={t('esxiMigrationHint') || 'VM should be powered off'}
                                                                    >
                                                                        <Icons.ArrowRight className="w-4 h-4" />
                                                                        {t('migrateToProxmox') || 'Import'}
                                                                    </button>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>
                                            )}
                                        </div>
                                    </>
                                ) : (
                                    /* Original Storage Content */
                                    <>
                                        <div className="p-4 border-b border-proxmox-border bg-proxmox-dark flex justify-between items-center">
                                            <h3 className="font-semibold flex items-center gap-2">
                                                <Icons.Folder />
                                                {selectedStorage ? (
                                                    <>{t('content') || 'Content'}: {selectedStorage.name}</>
                                                ) : (
                                                    t('selectStorage') || 'Select a storage'
                                                )}
                                            </h3>
                                            {selectedStorage && isAdmin && (
                                                <div className="flex gap-2">
                                                    {/* NS: Download Templates button - only for vztmpl storage */}
                                                    {(() => {
                                                        const storage = datastores.shared.find(s => s.storage === selectedStorage.name) || 
                                                                       datastores.local[selectedStorage.node]?.find(s => s.storage === selectedStorage.name);
                                                        return storage?.content?.includes('vztmpl');
                                                    })() && (
                                                        <button
                                                            onClick={() => { setShowTemplateModal(true); loadAvailableTemplates(); }}
                                                            className="flex items-center gap-1 px-3 py-1.5 bg-blue-600 hover:bg-blue-700 rounded-lg text-sm"
                                                        >
                                                            <Icons.Download /> Templates
                                                        </button>
                                                    )}
                                                    {/* NS: Download from URL - for ISO storage (like Proxmox) */}
                                                    {(() => {
                                                        const storage = datastores.shared.find(s => s.storage === selectedStorage.name) || 
                                                                       datastores.local[selectedStorage.node]?.find(s => s.storage === selectedStorage.name);
                                                        return storage?.content?.includes('iso');
                                                    })() && (
                                                        <button
                                                            onClick={() => setDownloadUrlModalOpen(true)}
                                                            className="flex items-center gap-1 px-3 py-1.5 bg-green-600 hover:bg-green-700 rounded-lg text-sm"
                                                            title={t('downloadFromUrl') || 'Download from URL'}
                                                        >
                                                            <Icons.Link /> {t('fromUrl') || 'From URL'}
                                                        </button>
                                                    )}
                                                    {canUploadTo(datastores.shared.find(s => s.storage === selectedStorage.name) || 
                                                                 datastores.local[selectedStorage.node]?.find(s => s.storage === selectedStorage.name)) && (
                                                        <button
                                                            onClick={() => setUploadModalOpen(true)}
                                                            className="flex items-center gap-1 px-3 py-1.5 bg-proxmox-orange hover:bg-orange-600 rounded-lg text-sm"
                                                        >
                                                            <Icons.Upload /> {t('upload') || 'Upload'}
                                                        </button>
                                                    )}
                                                    <button
                                                        onClick={() => loadStorageContent(selectedStorage.name, selectedStorage.node)}
                                                        className="p-1.5 hover:bg-proxmox-hover rounded-lg text-gray-400 hover:text-white"
                                                    >
                                                        <Icons.RotateCw />
                                                    </button>
                                                </div>
                                            )}
                                        </div>
                                        <div className="p-4">
                                            {contentLoading ? (
                                                <div className="flex items-center justify-center py-12">
                                                    <Icons.RotateCw className="animate-spin" />
                                                </div>
                                            ) : !selectedStorage ? (
                                                <div className="text-center py-12 text-gray-500">
                                                    <Icons.Database className="mx-auto mb-2 opacity-50" />
                                                    <p>{t('clickStorageToView') || 'Click on a storage to view its contents'}</p>
                                                </div>
                                            ) : storageContent.length === 0 ? (
                                                <div className="text-center py-12 text-gray-500">
                                                    <Icons.Folder className="mx-auto mb-2 opacity-50" />
                                                    <p>{t('storageEmpty') || 'This storage is empty'}</p>
                                                </div>
                                            ) : (
                                                <div className="space-y-1 max-h-[500px] overflow-y-auto">
                                                    <table className="w-full">
                                                        <thead className="sticky top-0 bg-proxmox-card">
                                                            <tr className="text-left text-xs text-gray-500 uppercase">
                                                                <th className="p-2">{t('name') || 'Name'}</th>
                                                                <th className="p-2">{t('type') || 'Type'}</th>
                                                                <th className="p-2">{t('format') || 'Format'}</th>
                                                        <th className="p-2 text-right">{t('size') || 'Size'}</th>
                                                        {isAdmin && <th className="p-2 w-10"></th>}
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {storageContent.map((item, idx) => (
                                                        <tr key={idx} className="border-t border-proxmox-border hover:bg-proxmox-hover">
                                                            <td className="p-2">
                                                                <div className="flex items-center gap-2">
                                                                    <span>{item.content === 'iso' ? 'üíø' : item.content === 'backup' ? 'üì¶' : 'üíæ'}</span>
                                                                    <span className="font-mono text-sm truncate max-w-xs" title={item.volid}>
                                                                        {item.volid?.split('/').pop() || item.volid}
                                                                    </span>
                                                                    {item.vmid && (
                                                                        <span className="text-xs text-blue-400 bg-blue-500/10 px-1.5 py-0.5 rounded">
                                                                            VM {item.vmid}
                                                                        </span>
                                                                    )}
                                                                </div>
                                                            </td>
                                                            <td className="p-2 text-sm text-gray-400">{item.content}</td>
                                                            <td className="p-2 text-sm text-gray-400">{item.format || '-'}</td>
                                                            <td className="p-2 text-sm text-right">{item.size_human || formatSize(item.size)}</td>
                                                            {isAdmin && (
                                                                <td className="p-2">
                                                                    {/* LW: allow deleting backups even with vmid - vzdumps always have vmid attached */}
                                                                    {(item.content === 'backup' || (!item.vmid && (item.content === 'iso' || item.content === 'vztmpl'))) && (
                                                                        <button
                                                                            onClick={() => setDeleteConfirm(item)}
                                                                            className="p-1 hover:bg-red-500/20 rounded text-gray-500 hover:text-red-400"
                                                                            title={t('delete') || 'Delete'}
                                                                        >
                                                                            <Icons.Trash />
                                                                        </button>
                                                                    )}
                                                                </td>
                                                            )}
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        </div>
                                    )}
                                </div>
                            </>
                        )}
                    </div>
                </div>
            ) : (
                /* Storage Balancing Tab with Storage Clusters */
                <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    {/* Experimental warning */}
                    <div className="lg:col-span-3 p-3 bg-yellow-500/10 border border-yellow-500/30 rounded-xl flex items-center gap-3">
                        <span className="text-2xl">üß™</span>
                        <div>
                            <p className="text-yellow-400 font-medium">{t('experimentalFeature') || 'Experimental Feature'}</p>
                            <p className="text-yellow-300/70 text-sm">{t('storageBalancingExperimental') || 'Storage Balancing is still experimental. We appreciate your feedback!'}</p>
                        </div>
                    </div>
                    
                    {/* Storage Clusters List */}
                            <div className="lg:col-span-1 bg-proxmox-card border border-proxmox-border rounded-xl overflow-hidden">
                                <div className="p-4 border-b border-proxmox-border bg-proxmox-dark flex justify-between items-center">
                                    <h3 className="font-semibold flex items-center gap-2">
                                        <Icons.Zap className="text-yellow-400" />
                                        Storage Clusters
                                    </h3>
                                    {isAdmin && (
                                        <button
                                            onClick={() => setShowCreateCluster(true)}
                                            className="p-1.5 bg-proxmox-orange hover:bg-orange-600 rounded-lg"
                                            title={t('createCluster') || 'Create Cluster'}
                                        >
                                            <Icons.Plus />
                                        </button>
                                    )}
                                </div>
                                <div className="p-4 space-y-3 max-h-[500px] overflow-y-auto">
                                    {storageClusters.length === 0 ? (
                                        <div className="text-center py-8 text-gray-500">
                                            <Icons.Database className="mx-auto mb-2 opacity-50" />
                                            <p>{t('noStorageClusters') || 'No storage clusters configured'}</p>
                                            <p className="text-xs mt-1">{t('createStorageClusterHint') || 'Create a cluster to balance storage across multiple volumes'}</p>
                                        </div>
                                    ) : (
                                        storageClusters.map(sc => (
                                            <div 
                                                key={sc.id}
                                                className={`p-3 rounded-lg cursor-pointer transition-all ${
                                                    selectedCluster === sc.id 
                                                        ? 'bg-proxmox-orange/20 border border-proxmox-orange/50' 
                                                        : 'bg-proxmox-dark hover:bg-proxmox-hover'
                                                }`}
                                                onClick={() => { setSelectedCluster(sc.id); loadClusterStatus(sc.id); }}
                                            >
                                                <div className="flex items-center justify-between">
                                                    <div className="flex items-center gap-2">
                                                        <span className={`w-2 h-2 rounded-full ${sc.enabled ? 'bg-green-500' : 'bg-gray-500'}`} />
                                                        <span className="font-medium">{sc.name}</span>
                                                    </div>
                                                    {isAdmin && (
                                                        <button
                                                            onClick={(e) => { e.stopPropagation(); deleteStorageCluster(sc.id); }}
                                                            className="p-1 hover:bg-red-500/20 rounded text-gray-500 hover:text-red-400"
                                                        >
                                                            <Icons.Trash />
                                                        </button>
                                                    )}
                                                </div>
                                                <div className="text-xs text-gray-500 mt-1">
                                                    {sc.storages?.length || 0} {t('storages') || 'storages'} ‚Ä¢ {t('threshold')}: {sc.threshold}%
                                                </div>
                                            </div>
                                        ))
                                    )}
                                </div>
                            </div>
                            
                            {/* Storage Cluster Details */}
                            <div className="lg:col-span-2 bg-proxmox-card border border-proxmox-border rounded-xl overflow-hidden">
                                <div className="p-4 border-b border-proxmox-border bg-proxmox-dark">
                                    <h3 className="font-semibold">
                                        {clusterStatus ? clusterStatus.name : (t('selectCluster') || 'Select a storage cluster')}
                                    </h3>
                                </div>
                                <div className="p-4">
                                    {balancingLoading ? (
                                        <div className="flex items-center justify-center py-12">
                                            <Icons.RotateCw className="animate-spin" />
                                        </div>
                                    ) : !clusterStatus ? (
                                        <div className="text-center py-12 text-gray-500">
                                            <Icons.Zap className="mx-auto mb-2 opacity-50" />
                                            <p>{t('selectClusterToView') || 'Select a storage cluster to view balancing status'}</p>
                                        </div>
                                    ) : (
                                        <div className="space-y-6">
                                            {/* Cluster Settings */}
                                            <div className="flex items-center justify-between gap-4 p-4 bg-proxmox-dark rounded-lg flex-wrap">
                                                <Toggle
                                                    checked={clusterStatus.enabled}
                                                    onChange={(v) => toggleClusterEnabled(clusterStatus.id, v)}
                                                    label={t('enabled') || 'Enabled'}
                                                />
                                                <div className="flex items-center gap-4">
                                                    <Toggle
                                                        checked={storageClusters.find(sc => sc.id === clusterStatus.id)?.auto_balance || false}
                                                        onChange={(v) => toggleAutoBalance(clusterStatus.id, v)}
                                                        label={t('autoBalance') || 'Auto-Balance'}
                                                    />
                                                    <button
                                                        onClick={() => loadClusterStatus(clusterStatus.id)}
                                                        className="p-2 hover:bg-proxmox-hover rounded-lg text-gray-400 hover:text-white"
                                                    >
                                                        <Icons.RotateCw />
                                                    </button>
                                                </div>
                                            </div>
                                            
                                            {/* Auto-Balance Info */}
                                            {storageClusters.find(sc => sc.id === clusterStatus.id)?.auto_balance && (
                                                <div className="p-4 bg-green-500/10 border border-green-500/30 rounded-lg">
                                                    <div className="flex items-center gap-2 text-green-400 mb-2">
                                                        <Icons.Zap />
                                                        <span className="font-medium">{t('autoBalanceActive') || 'Auto-Balance Active'}</span>
                                                    </div>
                                                    <p className="text-sm text-gray-400">
                                                        {t('autoBalanceDesc') || 'Disks will be automatically migrated when imbalance exceeds threshold. VMs with active snapshots/backups are skipped.'}
                                                    </p>
                                                </div>
                                            )}
                                            
                                            {/* Threshold Slider */}
                                            <div className="p-4 bg-proxmox-dark rounded-lg">
                                                <Slider
                                                    label={t('balancingThreshold') || 'Balancing Threshold'}
                                                    description={t('thresholdDesc') || 'Trigger balancing when imbalance exceeds this value'}
                                                    value={clusterStatus.threshold}
                                                    onChange={(v) => updateClusterThreshold(clusterStatus.id, v)}
                                                    min={5}
                                                    max={50}
                                                    step={5}
                                                />
                                            </div>
                                            
                                            {/* Imbalance Status */}
                                            <div className="flex items-center gap-4 p-4 bg-proxmox-dark rounded-lg">
                                                <div className="flex-1">
                                                    <div className="text-sm text-gray-400">{t('currentImbalance') || 'Current Imbalance'}</div>
                                                    <div className={`text-2xl font-bold ${clusterStatus.imbalance > clusterStatus.threshold ? 'text-yellow-400' : 'text-green-400'}`}>
                                                        {clusterStatus.imbalance}%
                                                    </div>
                                                </div>
                                                <div className={`px-4 py-2 rounded-lg ${clusterStatus.imbalance > clusterStatus.threshold ? 'bg-yellow-500/20 text-yellow-400' : 'bg-green-500/20 text-green-400'}`}>
                                                    {clusterStatus.imbalance > clusterStatus.threshold ? '‚ö†Ô∏è ' + (t('actionRecommended') || 'Action Recommended') : '‚úì ' + (t('balanced') || 'Balanced')}
                                                </div>
                                            </div>
                                            
                                            {/* Storages in Cluster */}
                                            <div>
                                                <div className="flex items-center justify-between mb-3">
                                                    <h4 className="text-sm font-medium text-gray-400">{t('storagesInCluster') || 'Storages in Cluster'}</h4>
                                                    {isAdmin && datastores.shared?.length > (clusterStatus.storages?.length || 0) && (
                                                        <select
                                                            className="px-2 py-1 bg-proxmox-dark border border-proxmox-border rounded text-sm"
                                                            onChange={(e) => { if (e.target.value) { addStorageToCluster(clusterStatus.id, e.target.value); e.target.value = ''; }}}
                                                            defaultValue=""
                                                        >
                                                            <option value="">{t('addStorage') || '+ Add Storage'}</option>
                                                            {datastores.shared?.filter(s => !clusterStatus.storages?.some(cs => cs.storage === s.storage)).map(s => (
                                                                <option key={s.storage} value={s.storage}>{s.storage}</option>
                                                            ))}
                                                        </select>
                                                    )}
                                                </div>
                                                <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                                                    {clusterStatus.storages?.map(storage => (
                                                        <div key={storage.storage} className="p-3 bg-proxmox-dark rounded-lg">
                                                            <div className="flex justify-between items-center mb-2">
                                                                <span className="font-medium">{storage.storage}</span>
                                                                <div className="flex items-center gap-2">
                                                                    <span className={`text-sm ${storage.usage_percent > 90 ? 'text-red-400' : storage.usage_percent > 70 ? 'text-yellow-400' : 'text-green-400'}`}>
                                                                        {storage.usage_percent}%
                                                                    </span>
                                                                    {isAdmin && clusterStatus.storages.length > 2 && (
                                                                        <button
                                                                            onClick={() => removeStorageFromCluster(clusterStatus.id, storage.storage)}
                                                                            className="p-1 hover:bg-red-500/20 rounded text-gray-500 hover:text-red-400"
                                                                            title={t('remove') || 'Remove'}
                                                                        >
                                                                            <Icons.X />
                                                                        </button>
                                                                    )}
                                                                </div>
                                                            </div>
                                                            <div className="w-full h-2 bg-proxmox-border rounded-full">
                                                                <div 
                                                                    className={`h-full rounded-full ${storage.usage_percent > 90 ? 'bg-red-500' : storage.usage_percent > 70 ? 'bg-yellow-500' : 'bg-green-500'}`}
                                                                    style={{ width: `${storage.usage_percent}%` }}
                                                                />
                                                            </div>
                                                            <div className="text-xs text-gray-500 mt-1">
                                                                {formatSize(storage.used)} / {formatSize(storage.total)}
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                            
                                            {/* Recommendations */}
                                            {clusterStatus.recommendations?.length > 0 && (
                                                <div>
                                                    <h4 className="text-sm font-medium text-gray-400 mb-3">{t('recommendations') || 'Recommendations'}</h4>
                                                    <div className="space-y-2">
                                                        {clusterStatus.recommendations.map((rec, idx) => (
                                                            <div key={idx} className="flex items-center justify-between p-3 bg-proxmox-dark rounded-lg">
                                                                <div className="flex items-center gap-3">
                                                                    <div className={`p-2 rounded-lg ${rec.vm_status === 'running' ? 'bg-green-500/20' : 'bg-gray-500/20'}`}>
                                                                        <Icons.HardDrive />
                                                                    </div>
                                                                    <div>
                                                                        <div className="font-medium">{rec.vm_name} <span className="text-gray-500">({rec.disk})</span></div>
                                                                        <div className="text-xs text-gray-500">{rec.reason}</div>
                                                                    </div>
                                                                </div>
                                                                {isAdmin && (
                                                                    <button
                                                                        onClick={() => executeMigration(rec)}
                                                                        className="px-3 py-1.5 bg-proxmox-orange hover:bg-orange-600 rounded-lg text-sm"
                                                                    >
                                                                        {t('migrate') || 'Migrate'}
                                                                    </button>
                                                                )}
                                                            </div>
                                                        ))}
                                                    </div>
                                                </div>
                                            )}
                                            
                                            {clusterStatus.recommendations?.length === 0 && clusterStatus.imbalance <= clusterStatus.threshold && (
                                                <div className="text-center py-6 text-gray-500">
                                                    <Icons.Check className="mx-auto mb-2 text-green-400" />
                                                    <p>{t('storageBalanced') || 'Storage is well balanced. No action needed.'}</p>
                                                </div>
                                            )}
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {/* Create Storage Cluster Modal */}
                    {showCreateCluster && (
                        <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50">
                            <div className="bg-proxmox-card border border-proxmox-border rounded-xl p-6 w-full max-w-lg">
                                <h3 className="text-lg font-semibold mb-4">{t('createStorageCluster') || 'Create Storage Cluster'}</h3>
                                <div className="space-y-4">
                                    <div>
                                        <label className="block text-sm text-gray-400 mb-2">{t('clusterName') || 'Cluster Name'}</label>
                                        <input
                                            type="text"
                                            value={newClusterName}
                                            onChange={(e) => setNewClusterName(e.target.value)}
                                            placeholder="e.g. Production Storage"
                                            className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white"
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm text-gray-400 mb-2">{t('selectStorages') || 'Select Storages'} ({t('minTwo') || 'min. 2'})</label>
                                        <div className="grid grid-cols-2 gap-2 max-h-48 overflow-y-auto p-2 bg-proxmox-dark rounded-lg">
                                            {datastores.shared?.map(storage => (
                                                <label key={storage.storage} className="flex items-center gap-2 p-2 hover:bg-proxmox-hover rounded cursor-pointer">
                                                    <input
                                                        type="checkbox"
                                                        checked={newClusterStorages.includes(storage.storage)}
                                                        onChange={(e) => {
                                                            if (e.target.checked) {
                                                                setNewClusterStorages(prev => [...prev, storage.storage]);
                                                            } else {
                                                                setNewClusterStorages(prev => prev.filter(s => s !== storage.storage));
                                                            }
                                                        }}
                                                        className="rounded"
                                                    />
                                                    <span>{storage.storage}</span>
                                                </label>
                                            ))}
                                        </div>
                                        {datastores.shared?.length === 0 && (
                                            <div className="text-center py-4 text-gray-500 text-sm">
                                                {t('noSharedStorages') || 'No shared storages available'}
                                            </div>
                                        )}
                                    </div>
                                    <div>
                                        <Slider
                                            label={t('balancingThreshold') || 'Balancing Threshold'}
                                            value={newClusterThreshold}
                                            onChange={setNewClusterThreshold}
                                            min={5}
                                            max={50}
                                            step={5}
                                        />
                                    </div>
                                    <div className="flex gap-2 justify-end pt-4">
                                        <button
                                            onClick={() => { setShowCreateCluster(false); setNewClusterName(''); setNewClusterStorages([]); }}
                                            className="px-4 py-2 bg-proxmox-dark hover:bg-proxmox-hover rounded-lg"
                                        >
                                            {t('cancel') || 'Cancel'}
                                        </button>
                                        <button
                                            onClick={createStorageCluster}
                                            disabled={!newClusterName.trim() || newClusterStorages.length < 2}
                                            className="px-4 py-2 bg-proxmox-orange hover:bg-orange-600 rounded-lg disabled:opacity-50"
                                        >
                                            {t('create') || 'Create'}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {/* Template downloads */}
                    {showTemplateModal && (
                        <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
                            <div className="bg-proxmox-card border border-proxmox-border rounded-xl w-full max-w-4xl max-h-[85vh] flex flex-col">
                                <div className="p-4 border-b border-proxmox-border flex justify-between items-center">
                                    <h3 className="text-lg font-semibold flex items-center gap-2">
                                        <Icons.Download />
                                        {t('downloadTemplates') || 'Download Container Templates'}
                                    </h3>
                                    <button
                                        onClick={() => setShowTemplateModal(false)}
                                        className="p-1.5 hover:bg-proxmox-hover rounded-lg text-gray-400 hover:text-white"
                                    >
                                        <Icons.X />
                                    </button>
                                </div>
                                
                                {/* Search filter */}
                                <div className="p-4 border-b border-proxmox-border">
                                    <input
                                        type="text"
                                        placeholder={t('searchTemplates') || 'Search templates...'}
                                        value={templateFilter}
                                        onChange={(e) => setTemplateFilter(e.target.value)}
                                        className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white placeholder-gray-500"
                                    />
                                </div>
                                
                                {/* Template list */}
                                <div className="flex-1 overflow-y-auto p-4">
                                    {templatesLoading ? (
                                        <div className="flex items-center justify-center py-12">
                                            <Icons.RotateCw className="animate-spin mr-2" />
                                            Loading templates...
                                        </div>
                                    ) : availableTemplates.length === 0 ? (
                                        <div className="text-center py-12 text-gray-500">
                                            <Icons.Package className="mx-auto mb-2 opacity-50" />
                                            <p>{t('noTemplatesAvailable') || 'No templates available'}</p>
                                        </div>
                                    ) : (
                                        <div className="space-y-2">
                                            {/* Group by section */}
                                            {Object.entries(
                                                availableTemplates
                                                    .filter(t => !templateFilter || 
                                                        t.package?.toLowerCase().includes(templateFilter.toLowerCase()) ||
                                                        t.headline?.toLowerCase().includes(templateFilter.toLowerCase()) ||
                                                        t.os?.toLowerCase().includes(templateFilter.toLowerCase())
                                                    )
                                                    .reduce((acc, t) => {
                                                        const section = t.section || 'Other';
                                                        if (!acc[section]) acc[section] = [];
                                                        acc[section].push(t);
                                                        return acc;
                                                    }, {})
                                            ).map(([section, templates]) => (
                                                <div key={section} className="mb-4">
                                                    <h4 className="text-sm font-semibold text-gray-400 uppercase mb-2 sticky top-0 bg-proxmox-card py-1">
                                                        {section} ({templates.length})
                                                    </h4>
                                                    <div className="space-y-1">
                                                        {templates.map((tmpl, idx) => (
                                                            <div 
                                                                key={idx}
                                                                className="flex items-center justify-between p-3 bg-proxmox-dark rounded-lg hover:bg-proxmox-hover group"
                                                            >
                                                                <div className="flex-1 min-w-0">
                                                                    <div className="flex items-center gap-2">
                                                                        <span className="font-medium text-white truncate">
                                                                            {tmpl.package || tmpl.template}
                                                                        </span>
                                                                        {tmpl.version && (
                                                                            <span className="text-xs bg-blue-500/20 text-blue-400 px-1.5 py-0.5 rounded">
                                                                                {tmpl.version}
                                                                            </span>
                                                                        )}
                                                                    </div>
                                                                    {tmpl.headline && (
                                                                        <p className="text-sm text-gray-400 truncate">{tmpl.headline}</p>
                                                                    )}
                                                                    <div className="flex items-center gap-2 mt-1 text-xs text-gray-500">
                                                                        {tmpl.os && <span>OS: {tmpl.os}</span>}
                                                                        {tmpl.infopage && (
                                                                            <a 
                                                                                href={tmpl.infopage} 
                                                                                target="_blank" 
                                                                                rel="noopener noreferrer"
                                                                                className="text-blue-400 hover:underline"
                                                                            >
                                                                                Info
                                                                            </a>
                                                                        )}
                                                                    </div>
                                                                </div>
                                                                <button
                                                                    onClick={() => downloadTemplate(tmpl, selectedStorage.name)}
                                                                    disabled={downloadingTemplate === tmpl.template}
                                                                    className="flex items-center gap-1 px-3 py-1.5 bg-green-600 hover:bg-green-700 disabled:opacity-50 rounded-lg text-sm ml-2 whitespace-nowrap"
                                                                >
                                                                    {downloadingTemplate === tmpl.template ? (
                                                                        <><Icons.RotateCw className="animate-spin w-4 h-4" /> ...</>
                                                                    ) : (
                                                                        <><Icons.Download className="w-4 h-4" /> Download</>
                                                                    )}
                                                                </button>
                                                            </div>
                                                        ))}
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                                
                                {/* Footer */}
                                <div className="p-4 border-t border-proxmox-border bg-proxmox-dark flex justify-between items-center text-sm text-gray-400">
                                    <span>
                                        {availableTemplates.length} {t('templatesAvailable') || 'templates available'}
                                    </span>
                                    <span>
                                        {t('downloadTo') || 'Download to'}: <strong className="text-white">{selectedStorage?.name}</strong>
                                    </span>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {/* Upload Modal */}
                    {uploadModalOpen && (
                        <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50">
                            <div className="bg-proxmox-card border border-proxmox-border rounded-xl p-6 w-full max-w-md">
                                <h3 className="text-lg font-semibold mb-4">{t('uploadIso') || 'Upload ISO'}</h3>
                                <div className="space-y-4">
                                    <div>
                                        <label className="block text-sm text-gray-400 mb-2">{t('selectFile') || 'Select File'}</label>
                                        <input
                                            type="file"
                                            accept=".iso"
                                            onChange={(e) => setUploadFile(e.target.files[0])}
                                            disabled={uploading}
                                            className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white disabled:opacity-50"
                                        />
                                    </div>
                                    {uploadFile && (
                                        <div className="text-sm text-gray-400">
                                            üìÑ {uploadFile.name} ({formatSize(uploadFile.size)})
                                        </div>
                                    )}
                                    
                                    {/* Upload Progress */}
                                    {uploading && (
                                        <div className="space-y-2">
                                            <div className="flex justify-between text-sm">
                                                <span className="text-gray-400">
                                                    {uploadProgress < 100 ? 'Uploading...' : 'Processing...'}
                                                </span>
                                                <span className="text-proxmox-orange font-mono">
                                                    {uploadProgress}%
                                                </span>
                                            </div>
                                            <div className="w-full bg-proxmox-dark rounded-full h-3 overflow-hidden">
                                                <div 
                                                    className="h-full bg-gradient-to-r from-proxmox-orange to-orange-400 transition-all duration-300 ease-out"
                                                    style={{ width: `${uploadProgress}%` }}
                                                />
                                            </div>
                                            <div className="flex justify-between text-xs text-gray-500">
                                                <span>{formatSize(uploadFile.size * uploadProgress / 100)} / {formatSize(uploadFile.size)}</span>
                                                <span>{formatSpeed(uploadSpeed)}</span>
                                            </div>
                                        </div>
                                    )}
                                    
                                    <div className="flex gap-2 justify-end">
                                        <button
                                            onClick={() => { setUploadModalOpen(false); setUploadFile(null); setUploadProgress(0); }}
                                            disabled={uploading}
                                            className="px-4 py-2 bg-proxmox-dark hover:bg-proxmox-hover rounded-lg disabled:opacity-50"
                                        >
                                            {t('cancel') || 'Cancel'}
                                        </button>
                                        <button
                                            onClick={handleUpload}
                                            disabled={!uploadFile || uploading}
                                            className="px-4 py-2 bg-proxmox-orange hover:bg-orange-600 rounded-lg disabled:opacity-50 flex items-center gap-2"
                                        >
                                            {uploading ? (
                                                <>
                                                    <Icons.RotateCw className="animate-spin w-4 h-4" />
                                                    <span>{uploadProgress}%</span>
                                                </>
                                            ) : (
                                                <>
                                                    <Icons.Upload className="w-4 h-4" />
                                                    <span>{t('upload') || 'Upload'}</span>
                                                </>
                                            )}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {/* Download from URL Modal - NS Jan 2026 */}
                    {downloadUrlModalOpen && (
                        <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50">
                            <div className="bg-proxmox-card border border-proxmox-border rounded-xl p-6 w-full max-w-lg">
                                <h3 className="text-lg font-semibold mb-4 flex items-center gap-2">
                                    <Icons.Link className="w-5 h-5" />
                                    {t('downloadFromUrl') || 'Download from URL'}
                                </h3>
                                <div className="space-y-4">
                                    <div>
                                        <label className="block text-sm text-gray-400 mb-2">{t('isoUrl') || 'ISO URL'}</label>
                                        <input
                                            type="url"
                                            value={downloadUrl}
                                            onChange={(e) => setDownloadUrl(e.target.value)}
                                            placeholder="https://releases.ubuntu.com/22.04/ubuntu-22.04-live-server-amd64.iso"
                                            disabled={urlDownloading}
                                            className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white disabled:opacity-50 text-sm"
                                        />
                                        <p className="text-xs text-gray-500 mt-1">
                                            {t('isoUrlHint') || 'Direct link to ISO file (http/https)'}
                                        </p>
                                    </div>
                                    
                                    <div>
                                        <label className="block text-sm text-gray-400 mb-2">{t('filename') || 'Filename'} ({t('optional') || 'optional'})</label>
                                        <input
                                            type="text"
                                            value={downloadFilename}
                                            onChange={(e) => setDownloadFilename(e.target.value)}
                                            placeholder={t('autoDetect') || 'Auto-detect from URL'}
                                            disabled={urlDownloading}
                                            className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white disabled:opacity-50 text-sm"
                                        />
                                    </div>
                                    
                                    <div className="bg-proxmox-dark/50 rounded-lg p-3 text-sm">
                                        <p className="text-gray-400">
                                            <strong>{t('storage') || 'Storage'}:</strong> {selectedStorage?.name}
                                            {selectedStorage?.node && <span className="text-gray-500"> ({selectedStorage.node})</span>}
                                        </p>
                                    </div>
                                    
                                    {/* Download Progress */}
                                    {urlDownloading && urlDownloadProgress && (
                                        <div className="space-y-2">
                                            <div className="flex justify-between text-sm">
                                                <span className="text-gray-400">
                                                    {urlDownloadProgress.message || 'Downloading...'}
                                                </span>
                                                {urlDownloadProgress.percent !== undefined && (
                                                    <span className="text-green-400 font-mono">
                                                        {urlDownloadProgress.percent}%
                                                    </span>
                                                )}
                                            </div>
                                            <div className="w-full bg-proxmox-dark rounded-full h-3 overflow-hidden">
                                                <div 
                                                    className="h-full bg-gradient-to-r from-green-500 to-green-400 transition-all duration-300 ease-out"
                                                    style={{ width: `${urlDownloadProgress.percent || 0}%` }}
                                                />
                                            </div>
                                            {urlDownloadProgress.downloaded && urlDownloadProgress.total && (
                                                <div className="flex justify-between text-xs text-gray-500">
                                                    <span>{formatSize(urlDownloadProgress.downloaded)} / {formatSize(urlDownloadProgress.total)}</span>
                                                    {urlDownloadProgress.speed && <span>{formatSpeed(urlDownloadProgress.speed)}</span>}
                                                </div>
                                            )}
                                        </div>
                                    )}
                                    
                                    <div className="flex gap-2 justify-end">
                                        <button
                                            onClick={() => { setDownloadUrlModalOpen(false); setDownloadUrl(''); setDownloadFilename(''); setUrlDownloadProgress(null); }}
                                            disabled={urlDownloading}
                                            className="px-4 py-2 bg-proxmox-dark hover:bg-proxmox-hover rounded-lg disabled:opacity-50"
                                        >
                                            {t('cancel') || 'Cancel'}
                                        </button>
                                        <button
                                            onClick={handleDownloadFromUrl}
                                            disabled={!downloadUrl || urlDownloading}
                                            className="px-4 py-2 bg-green-600 hover:bg-green-700 rounded-lg disabled:opacity-50 flex items-center gap-2"
                                        >
                                            {urlDownloading ? (
                                                <>
                                                    <Icons.RotateCw className="animate-spin w-4 h-4" />
                                                    <span>{t('downloading') || 'Downloading...'}</span>
                                                </>
                                            ) : (
                                                <>
                                                    <Icons.Download className="w-4 h-4" />
                                                    <span>{t('download') || 'Download'}</span>
                                                </>
                                            )}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {/* Delete Confirm Modal */}
                    {deleteConfirm && (
                        <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50">
                            <div className="bg-proxmox-card border border-proxmox-border rounded-xl p-6 w-full max-w-md">
                                <h3 className="text-lg font-semibold mb-4 text-red-400">{t('confirmDelete') || 'Confirm Delete'}</h3>
                                <p className="text-gray-300 mb-4">
                                    {t('deleteConfirmText') || 'Are you sure you want to delete'}:<br/>
                                    <span className="font-mono text-sm">{deleteConfirm.volid?.split('/').pop()}</span>
                                </p>
                                <div className="flex gap-2 justify-end">
                                    <button
                                        onClick={() => setDeleteConfirm(null)}
                                        className="px-4 py-2 bg-proxmox-dark hover:bg-proxmox-hover rounded-lg"
                                    >
                                        {t('cancel') || 'Cancel'}
                                    </button>
                                    <button
                                        onClick={() => handleDelete(deleteConfirm)}
                                        className="px-4 py-2 bg-red-600 hover:bg-red-700 rounded-lg"
                                    >
                                        {t('delete') || 'Delete'}
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {/* MK: ESXi Connect Modal - Dec 2025 */}
                    {showAddEsxi && (
                        <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50" onClick={() => setShowAddEsxi(false)}>
                            <div className="bg-proxmox-card border border-proxmox-border rounded-xl p-6 w-full max-w-md" onClick={e => e.stopPropagation()}>
                                <h3 className="text-lg font-semibold mb-4 flex items-center gap-2">
                                    <span className="text-xl">üñ•Ô∏è</span>
                                    {t('connectEsxi') || 'Connect ESXi Host'}
                                </h3>
                                
                                {/* Experimental warning */}
                                <div className="p-2 bg-yellow-500/10 border border-yellow-500/30 rounded-lg mb-4 flex items-center gap-2">
                                    <span>üß™</span>
                                    <span className="text-xs text-yellow-400">{t('esxiExperimental') || 'ESXi integration is experimental'}</span>
                                </div>
                                
                                <div className="space-y-4">
                                    <div>
                                        <label className="block text-sm text-gray-400 mb-2">{t('esxiHostname') || 'ESXi Hostname/IP'}</label>
                                        <input
                                            type="text"
                                            value={esxiForm.host}
                                            onChange={e => setEsxiForm({...esxiForm, host: e.target.value})}
                                            placeholder="192.168.1.100 oder esxi.local"
                                            className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white"
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm text-gray-400 mb-2">{t('esxiUsername') || 'Username'}</label>
                                        <input
                                            type="text"
                                            value={esxiForm.username}
                                            onChange={e => setEsxiForm({...esxiForm, username: e.target.value})}
                                            placeholder="root"
                                            className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white"
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm text-gray-400 mb-2">{t('esxiPassword') || 'Password'}</label>
                                        <input
                                            type="password"
                                            value={esxiForm.password}
                                            onChange={e => setEsxiForm({...esxiForm, password: e.target.value})}
                                            className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white"
                                        />
                                    </div>
                                    
                                    <div className="flex gap-2 justify-end pt-2">
                                        <button
                                            onClick={() => setShowAddEsxi(false)}
                                            className="px-4 py-2 bg-proxmox-dark hover:bg-proxmox-hover rounded-lg"
                                        >
                                            {t('cancel') || 'Cancel'}
                                        </button>
                                        <button
                                            onClick={connectEsxiHost}
                                            disabled={esxiLoading || !esxiForm.host || !esxiForm.password}
                                            className="px-4 py-2 bg-cyan-600 hover:bg-cyan-700 rounded-lg disabled:opacity-50 flex items-center gap-2"
                                        >
                                            {esxiLoading && <Icons.RotateCw className="animate-spin w-4 h-4" />}
                                            {t('connect') || 'Connect'}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // Node Card Component
        function NodeCard({ name, metrics, index, clusterId, onMaintenanceToggle, onStartUpdate, onOpenNodeConfig, onNodeAction }) {
            const { t } = useTranslation();
            const { getAuthHeaders } = useAuth();
            const historyRef = useRef({
                cpu: Array(20).fill(0),
                mem: Array(20).fill(0),
                disk: Array(20).fill(0),
                netin: Array(20).fill(0),
                netout: Array(20).fill(0)
            });
            const [, forceUpdate] = useState(0);
            const [showMaintenanceConfirm, setShowMaintenanceConfirm] = useState(false);
            const [showUpdateConfirm, setShowUpdateConfirm] = useState(false);
            const [updateWithReboot, setUpdateWithReboot] = useState(true);
            const [showUpdateLog, setShowUpdateLog] = useState(false);
            const [showRebootConfirm, setShowRebootConfirm] = useState(false);
            const [showShutdownConfirm, setShowShutdownConfirm] = useState(false);
            const [actionLoading, setActionLoading] = useState(null);
            const [expanded, setExpanded] = useState(false);
            const lastMetricsRef = useRef(null);
            const lastNetRef = useRef({ netin: 0, netout: 0, time: Date.now() });

            useEffect(() => {
                if (metrics && metrics !== lastMetricsRef.current) {
                    lastMetricsRef.current = metrics;
                    
                    // calc network rate
                    const now = Date.now();
                    const timeDiff = (now - lastNetRef.current.time) / 1000;
                    const netinRate = timeDiff > 0 ? Math.max(0, (metrics.netin - lastNetRef.current.netin) / timeDiff) : 0;
                    const netoutRate = timeDiff > 0 ? Math.max(0, (metrics.netout - lastNetRef.current.netout) / timeDiff) : 0;
                    lastNetRef.current = { netin: metrics.netin || 0, netout: metrics.netout || 0, time: now };
                    
                    historyRef.current = {
                        cpu: [...historyRef.current.cpu.slice(1), metrics.cpu_percent || 0],
                        mem: [...historyRef.current.mem.slice(1), metrics.mem_percent || 0],
                        disk: [...historyRef.current.disk.slice(1), metrics.disk_percent || 0],
                        netin: [...historyRef.current.netin.slice(1), netinRate / 1048576], // MB/s
                        netout: [...historyRef.current.netout.slice(1), netoutRate / 1048576]
                    };
                    forceUpdate(n => n + 1);
                }
            }, [metrics?.cpu_percent, metrics?.mem_percent, metrics?.netin, metrics?.netout]);
            
            const history = historyRef.current;

            const formatBytes = (bytes) => {
                const gb = bytes / 1073741824;
                return gb >= 1 ? `${gb.toFixed(1)} GB` : `${(bytes / 1048576).toFixed(1)} MB`;
            };

            const formatUptime = (seconds) => {
                const days = Math.floor(seconds / 86400);
                const hours = Math.floor((seconds % 86400) / 3600);
                const mins = Math.floor((seconds % 3600) / 60);
                if (days > 0) return `${days}d ${hours}h`;
                if (hours > 0) return `${hours}h ${mins}m`;
                return `${mins}m`;
            };

            if (!metrics) return null;

            const isInMaintenance = metrics.maintenance_mode;
            const maintenanceTask = metrics.maintenance_task;
            const isUpdating = metrics.is_updating;
            const updateTask = metrics.update_task;
            const isOffline = metrics.offline || metrics.status === 'offline';
            
            // Can only update if in maintenance and evacuation complete
            const canUpdate = isInMaintenance && 
                maintenanceTask?.status && 
                ['completed', 'completed_with_errors'].includes(maintenanceTask.status) &&
                !isUpdating;

            // Show simplified card for offline nodes
            if (isOffline) {
                return (
                    <div 
                        className="relative card-hover bg-proxmox-card border-2 border-red-500/50 rounded-xl p-5 animate-slide-up"
                        style={{ animationDelay: `${index * 100}ms` }}
                    >
                        <div className="absolute top-2 right-2">
                            <span className="px-2 py-1 bg-red-500 text-white text-xs font-bold rounded animate-pulse">
                                OFFLINE
                            </span>
                        </div>
                        <div className="flex items-center gap-3 mb-4">
                            <div className="p-2 bg-red-500/20 rounded-lg">
                                <Icons.Server className="text-red-400" />
                            </div>
                            <div>
                                <h3 className="font-semibold text-white">{name}</h3>
                                <div className="flex items-center gap-2 mt-1">
                                    <span className="w-2 h-2 rounded-full bg-red-500 animate-pulse" />
                                    <span className="text-xs text-red-400">offline</span>
                                </div>
                            </div>
                        </div>
                        <div className="space-y-3 opacity-50">
                            <div>
                                <div className="flex justify-between text-xs mb-1">
                                    <span className="text-gray-500">CPU</span>
                                    <span className="text-gray-500">--</span>
                                </div>
                                <div className="h-2 bg-proxmox-dark rounded-full" />
                            </div>
                            <div>
                                <div className="flex justify-between text-xs mb-1">
                                    <span className="text-gray-500">RAM</span>
                                    <span className="text-gray-500">--</span>
                                </div>
                                <div className="h-2 bg-proxmox-dark rounded-full" />
                            </div>
                        </div>
                        {metrics.last_seen && (
                            <div className="mt-4 pt-3 border-t border-red-500/30 text-xs text-red-400">
                                <Icons.AlertTriangle className="inline w-3 h-3 mr-1" />
                                {t('lastSeen') || 'Last seen'}: {new Date(metrics.last_seen).toLocaleString()}
                            </div>
                        )}
                    </div>
                );
            }

            return(
                <div 
                    className={`card-hover bg-proxmox-card border rounded-xl p-5 animate-slide-up ${
                        isUpdating ? 'border-blue-500/50 bg-blue-500/5' :
                        isInMaintenance ? 'border-yellow-500/50 bg-yellow-500/5' : 'border-proxmox-border'
                    }`}
                    style={{ animationDelay: `${index * 100}ms` }}
                >
                    {/* Update Banner */}
                    {isUpdating && updateTask && (
                        <div className="mb-4 -mt-1 -mx-1">
                            <div className={`${
                                updateTask.status === 'failed' ? 'bg-red-500/10 border-red-500/30' : 
                                updateTask.status === 'completed' ? 'bg-green-500/10 border-green-500/30' :
                                'bg-blue-500/10 border-blue-500/30'
                            } border rounded-lg p-3`}>
                                <div className="flex items-center justify-between mb-2">
                                    <div className="flex items-center gap-2">
                                        {updateTask.status === 'completed' ? (
                                            <Icons.CheckCircle className="text-green-400" />
                                        ) : updateTask.status === 'failed' ? (
                                            <Icons.XCircle className="text-red-400" />
                                        ) : (
                                            <Icons.RotateCw className="animate-spin" />
                                        )}
                                        <span className={`${
                                            updateTask.status === 'failed' ? 'text-red-400' : 
                                            updateTask.status === 'completed' ? 'text-green-400' :
                                            'text-blue-400'
                                        } font-semibold text-sm`}>
                                            {updateTask.status === 'failed' ? t('updateFailed') : 
                                             updateTask.status === 'completed' ? t('updateCompleted') :
                                             t('updateRunning')}
                                        </span>
                                    </div>
                                    <div className="flex items-center gap-2">
                                        <span className={`text-xs px-2 py-0.5 rounded ${
                                            updateTask.status === 'completed' ? 'bg-green-500/20 text-green-400' :
                                            updateTask.status === 'failed' ? 'bg-red-500/20 text-red-400' :
                                            'bg-blue-500/20 text-blue-400'
                                        }`}>
                                            {updateTask.phase === 'apt_update' ? 'apt update' :
                                             updateTask.phase === 'apt_upgrade' ? 'apt upgrade' :
                                             updateTask.phase === 'reboot' ? 'Reboot' :
                                             updateTask.phase === 'wait_online' ? t('waitingForNode') :
                                             updateTask.phase === 'done' ? t('done') :
                                             updateTask.status}
                                        </span>
                                        {/* Dismiss button for completed/failed */}
                                        {(updateTask.status === 'completed' || updateTask.status === 'failed') && (
                                            <button
                                                onClick={async (e) => {
                                                    e.stopPropagation();
                                                    try {
                                                        await fetch(`${API_URL}/clusters/${clusterId}/nodes/${name}/update`, { 
                                                            method: 'DELETE',
                                                            headers: getAuthHeaders()
                                                        });
                                                    } catch (e) {}
                                                }}
                                                className="text-xs text-gray-400 hover:text-white px-2 py-0.5 hover:bg-proxmox-hover rounded transition-colors"
                                            >
                                                ‚úï
                                            </button>
                                        )}
                                    </div>
                                </div>
                                
                                {/* Log Output */}
                                <div 
                                    className="bg-proxmox-darker rounded p-2 font-mono text-xs max-h-32 overflow-y-auto cursor-pointer"
                                    onClick={() => setShowUpdateLog(true)}
                                >
                                    {updateTask.output_lines?.slice(-5).map((line, idx) => (
                                        <div key={idx} className="text-gray-400 truncate">
                                            {line.text}
                                        </div>
                                    ))}
                                </div>
                                
                                {updateTask.status === 'completed' && (
                                    <div className="mt-2 text-xs text-green-400">
                                        ‚úÖ {t('updateCompleted')} {updateTask.packages_upgraded} {t('packagesUpdated')}
                                    </div>
                                )}
                                
                                {updateTask.status === 'failed' && (
                                    <div className="mt-2 space-y-2">
                                        <div className="text-xs text-red-400">
                                            ‚ùå {t('error')}: {updateTask.error}
                                        </div>
                                        <button
                                            onClick={async () => {
                                                // First clear the update status
                                                try {
                                                    await fetch(`${API_URL}/clusters/${clusterId}/nodes/${name}/update`, { 
                                                        method: 'DELETE',
                                                        headers: getAuthHeaders()
                                                    });
                                                } catch (e) {}
                                                // Then exit maintenance mode
                                                if (onMaintenanceToggle) onMaintenanceToggle(name, false);
                                            }}
                                            className="w-full px-3 py-1.5 bg-red-500/20 hover:bg-red-500/30 border border-red-500/30 rounded-lg text-red-400 text-xs font-medium transition-colors"
                                        >
                                            {t('cancelAndExitMaintenance')}
                                        </button>
                                    </div>
                                )}
                            </div>
                        </div>
                    )}

                    {/* Maintenance Banner */}
                    {isInMaintenance && !isUpdating && (
                        <div className="mb-4 -mt-1 -mx-1">
                            <div className="bg-yellow-500/10 border border-yellow-500/30 rounded-lg p-3">
                                <div className="flex items-center justify-between mb-2">
                                    <div className="flex items-center gap-2">
                                        <Icons.Wrench />
                                        <span className="text-yellow-400 font-semibold text-sm">{t('maintenanceMode')}</span>
                                    </div>
                                    <span className={`text-xs px-2 py-0.5 rounded ${
                                        maintenanceTask?.status === 'completed' ? 'bg-green-500/20 text-green-400' :
                                        maintenanceTask?.status === 'completed_with_errors' ? 'bg-orange-500/20 text-orange-400' :
                                        maintenanceTask?.status === 'evacuating' ? 'bg-blue-500/20 text-blue-400' :
                                        maintenanceTask?.status === 'failed' ? 'bg-red-500/20 text-red-400' :
                                        'bg-yellow-500/20 text-yellow-400'
                                    }`}>
                                        {maintenanceTask?.status === 'completed' ? t('ready') :
                                         maintenanceTask?.status === 'completed_with_errors' ? t('completedWithErrors') :
                                         maintenanceTask?.status === 'evacuating' ? t('evacuating') :
                                         maintenanceTask?.status === 'failed' ? t('failed') :
                                         t('starting')}
                                    </span>
                                </div>
                                
                                {maintenanceTask && maintenanceTask.status === 'evacuating' && (
                                    <>
                                        <div className="mb-2">
                                            <div className="flex justify-between text-xs text-gray-400 mb-1">
                                                <span>{t('progress')}</span>
                                                <span>{maintenanceTask.migrated_vms} / {maintenanceTask.total_vms} VMs</span>
                                            </div>
                                            <div className="h-2 bg-proxmox-dark rounded-full overflow-hidden">
                                                <div 
                                                    className="h-full bg-gradient-to-r from-yellow-500 to-yellow-400 transition-all duration-500"
                                                    style={{ width: `${maintenanceTask.progress_percent}%` }}
                                                />
                                            </div>
                                        </div>
                                        {maintenanceTask.current_vm && (
                                            <div className="text-xs text-gray-400">
                                                {t('migrating')}: <span className="text-white font-mono">{maintenanceTask.current_vm.name}</span>
                                            </div>
                                        )}
                                    </>
                                )}
                                
                                {/* Completed with errors - some VMs could not migrate (e.g. local storage) */}
                                {maintenanceTask?.status === 'completed_with_errors' && !metrics.maintenance_acknowledged && (
                                    <div className="space-y-3 mt-2">
                                        {/* Warning banner about failed migrations */}
                                        <div className="p-3 bg-orange-500/10 border border-orange-500/30 rounded-lg">
                                            <div className="flex items-start gap-2 text-orange-400 text-xs">
                                                <Icons.AlertTriangle className="w-4 h-4 mt-0.5 flex-shrink-0" />
                                                <div>
                                                    <p className="font-medium">{t('migrationIncomplete') || 'Migration Incomplete'}</p>
                                                    <p className="text-orange-300/80 mt-1">
                                                        {t('someVmsOnLocalStorage') || 'Some VMs could not be migrated (likely local storage). They will be stopped during reboot.'}
                                                    </p>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        {/* Show which VMs failed */}
                                        {maintenanceTask?.failed_vms?.length > 0 && (
                                            <div className="p-2 bg-proxmox-dark rounded-lg">
                                                <p className="text-xs text-gray-400 mb-1">{t('failedToMigrate') || 'Failed to migrate'}:</p>
                                                <div className="flex flex-wrap gap-1">
                                                    {maintenanceTask.failed_vms.slice(0, 5).map((vm, idx) => (
                                                        <span key={idx} className="px-2 py-0.5 bg-red-500/20 text-red-400 text-xs rounded font-mono">
                                                            {vm.name || vm.vmid || `VM ${idx + 1}`}
                                                        </span>
                                                    ))}
                                                    {maintenanceTask.failed_vms.length > 5 && (
                                                        <span className="px-2 py-0.5 bg-gray-500/20 text-gray-400 text-xs rounded">
                                                            +{maintenanceTask.failed_vms.length - 5} {t('more') || 'more'}
                                                        </span>
                                                    )}
                                                </div>
                                            </div>
                                        )}
                                        
                                        {/* Proceed or Exit buttons */}
                                        <div className="flex gap-2">
                                            <button
                                                onClick={async () => {
                                                    if (confirm(t('forceMaintenanceWarning') || '‚ö†Ô∏è WARNING: Proceeding will allow actions that may stop the remaining VMs. Continue?')) {
                                                        // Acknowledge the warning - unlock full menu
                                                        try {
                                                            await fetch(`${API_URL}/clusters/${clusterId}/nodes/${name}/maintenance/acknowledge`, {
                                                                method: 'POST',
                                                                headers: { 'Content-Type': 'application/json' }
                                                            });
                                                        } catch (e) { console.error(e); }
                                                    }
                                                }}
                                                className="flex-1 flex items-center justify-center gap-2 px-3 py-1.5 bg-orange-500/20 hover:bg-orange-500/30 border border-orange-500/30 rounded-lg text-orange-400 text-xs font-medium transition-colors"
                                            >
                                                <Icons.AlertTriangle />
                                                {t('proceedAnyway') || 'Proceed Anyway'}
                                            </button>
                                            <button
                                                onClick={() => onMaintenanceToggle(name, false)}
                                                className="flex-1 px-3 py-1.5 bg-gray-500/20 hover:bg-gray-500/30 border border-gray-500/30 rounded-lg text-gray-400 text-xs font-medium transition-colors"
                                            >
                                                {t('exitMaintenance')}
                                            </button>
                                        </div>
                                    </div>
                                )}
                                
                                {/* After acknowledging completed_with_errors OR normal completed - show full menu */}
                                {(maintenanceTask?.status === 'completed' || (maintenanceTask?.status === 'completed_with_errors' && metrics.maintenance_acknowledged)) && (
                                    <div className="space-y-2 mt-2">
                                        {/* Show warning reminder if there were errors */}
                                        {maintenanceTask?.status === 'completed_with_errors' && maintenanceTask?.failed_vms?.length > 0 && (
                                            <div className="p-2 bg-orange-500/10 border border-orange-500/20 rounded-lg text-xs text-orange-400 flex items-center gap-2">
                                                <Icons.AlertTriangle className="w-3 h-3" />
                                                {maintenanceTask.failed_vms.length} {t('vmsWillBeStopped') || 'VM(s) will be stopped during reboot'}
                                            </div>
                                        )}
                                        <div className="flex gap-2">
                                            <button
                                                onClick={() => setShowUpdateConfirm(true)}
                                                className="flex-1 flex items-center justify-center gap-2 px-3 py-1.5 bg-blue-500/20 hover:bg-blue-500/30 border border-blue-500/30 rounded-lg text-blue-400 text-xs font-medium transition-colors"
                                            >
                                                <Icons.Download />
                                                {t('updateAndReboot')}
                                            </button>
                                            <button
                                                onClick={() => onMaintenanceToggle(name, false)}
                                                className="flex-1 px-3 py-1.5 bg-green-500/20 hover:bg-green-500/30 border border-green-500/30 rounded-lg text-green-400 text-xs font-medium transition-colors"
                                            >
                                                {t('exitMaintenance')}
                                            </button>
                                        </div>
                                        <div className="flex gap-2">
                                            <button
                                                onClick={() => setShowRebootConfirm(true)}
                                                disabled={actionLoading}
                                                className="flex-1 flex items-center justify-center gap-2 px-3 py-1.5 bg-orange-500/20 hover:bg-orange-500/30 border border-orange-500/30 rounded-lg text-orange-400 text-xs font-medium transition-colors disabled:opacity-50"
                                            >
                                                <Icons.RefreshCw />
                                                {t('rebootNode')}
                                            </button>
                                            <button
                                                onClick={() => setShowShutdownConfirm(true)}
                                                disabled={actionLoading}
                                                className="flex-1 flex items-center justify-center gap-2 px-3 py-1.5 bg-red-500/20 hover:bg-red-500/30 border border-red-500/30 rounded-lg text-red-400 text-xs font-medium transition-colors disabled:opacity-50"
                                            >
                                                <Icons.Power />
                                                {t('shutdownNode')}
                                            </button>
                                        </div>
                                    </div>
                                )}
                                
                                {maintenanceTask?.failed_vms?.length > 0 && !['completed', 'completed_with_errors'].includes(maintenanceTask?.status) && (
                                    <div className="mt-2 text-xs text-red-400">
                                        ‚ö†Ô∏è {maintenanceTask.failed_vms.length} {t('vmsCouldNotMigrate')}
                                    </div>
                                )}
                            </div>
                        </div>
                    )}

                    <div className="flex items-center justify-between mb-4">
                        <div className="flex items-center gap-3">
                            <div className={`p-2 rounded-lg ${
                                isUpdating ? 'bg-blue-500/10' :
                                isInMaintenance ? 'bg-yellow-500/10' : 'bg-proxmox-orange/10'
                            }`}>
                                {isUpdating ? <Icons.RotateCw /> : isInMaintenance ? <Icons.Wrench /> : <Icons.Server />}
                            </div>
                            <div>
                                <h3 className="font-semibold text-white">{name}</h3>
                                <div className="flex items-center gap-2 mt-0.5">
                                    <span className={`w-2 h-2 rounded-full ${
                                        isUpdating ? 'bg-blue-500 animate-pulse' :
                                        isInMaintenance ? 'bg-yellow-500' :
                                        metrics.status === 'online' ? 'bg-green-500 status-online' : 'bg-gray-500'
                                    }`} />
                                    <span className="text-xs text-gray-400">
                                        {isUpdating ? t('updating') : isInMaintenance ? t('maintenance') : metrics.status}
                                    </span>
                                </div>
                            </div>
                        </div>
                        <div className="flex items-center gap-2">
                            {!isInMaintenance && !isUpdating && (
                                <button
                                    onClick={() => setShowMaintenanceConfirm(true)}
                                    className="p-2 rounded-lg bg-proxmox-dark hover:bg-yellow-500/20 text-gray-400 hover:text-yellow-400 transition-all"
                                    title={t('enterMaintenance')}
                                >
                                    <Icons.Wrench />
                                </button>
                            )}
                            <button
                                onClick={() => onOpenNodeConfig && onOpenNodeConfig(name)}
                                className="p-2 rounded-lg bg-proxmox-dark hover:bg-proxmox-orange/20 text-gray-400 hover:text-proxmox-orange transition-all"
                                title={t('nodeConfiguration')}
                            >
                                <Icons.Cog />
                            </button>
                            <div className="text-right">
                                <div className="text-xs text-gray-500">Score</div>
                                <div className={`font-mono font-bold text-lg ${
                                    metrics.score < 100 ? 'text-green-400' : metrics.score < 150 ? 'text-yellow-400' : 'text-red-400'
                                }`}>
                                    {metrics.score.toFixed(0)}
                                </div>
                            </div>
                        </div>
                    </div>

                    <div className="grid grid-cols-2 gap-4 mb-4">
                        <Gauge value={metrics.cpu_percent} label="CPU" />
                        <Gauge value={metrics.mem_percent} label="RAM" />
                    </div>

                    <div className="space-y-3 pt-3 border-t border-proxmox-border">
                        <div className="flex items-center justify-between">
                            <span className="text-xs text-gray-500 flex items-center gap-2">
                                <Icons.Cpu /> {t('cpuHistory')}
                            </span>
                            <Sparkline data={history.cpu} width={80} height={24} />
                        </div>
                        <div className="flex items-center justify-between">
                            <span className="text-xs text-gray-500 flex items-center gap-2">
                                <Icons.Memory /> {t('ramHistory')}
                            </span>
                            <Sparkline data={history.mem} width={80} height={24} />
                        </div>
                        <div className="flex items-center justify-between text-xs">
                            <span className="text-gray-500">{t('ramUsage')}</span>
                            <span className="text-gray-300 font-mono">
                                {formatBytes(metrics.mem_used)} / {formatBytes(metrics.mem_total)}
                            </span>
                        </div>
                        
                        {/* Expandable Details */}
                        <button 
                            onClick={() => setExpanded(!expanded)}
                            className="w-full flex items-center justify-center gap-1 text-xs text-gray-500 hover:text-gray-300 transition-colors pt-2"
                        >
                            {expanded ? t('showLess') : t('showMore')}
                            <Icons.ChevronDown className={`w-3 h-3 transition-transform ${expanded ? 'rotate-180' : ''}`} />
                        </button>
                        
                        {expanded && (
                            <div className="space-y-3 pt-2 border-t border-gray-700/50 animate-fade-in">
                                {/* Disk Usage */}
                                <div className="flex items-center justify-between text-xs">
                                    <span className="text-gray-500 flex items-center gap-2">
                                        <Icons.HardDrive /> {t('disk')}
                                    </span>
                                    <div className="flex items-center gap-2">
                                        <div className="w-16 h-1.5 bg-proxmox-dark rounded-full overflow-hidden">
                                            <div 
                                                className={`h-full rounded-full ${
                                                    metrics.disk_percent > 90 ? 'bg-red-500' : 
                                                    metrics.disk_percent > 75 ? 'bg-yellow-500' : 'bg-green-500'
                                                }`}
                                                style={{ width: `${metrics.disk_percent || 0}%` }}
                                            />
                                        </div>
                                        <span className="text-gray-300 font-mono w-12 text-right">
                                            {(metrics.disk_percent || 0).toFixed(1)}%
                                        </span>
                                    </div>
                                </div>
                                <div className="flex items-center justify-between text-xs">
                                    <span className="text-gray-500">{t('diskUsage')}</span>
                                    <span className="text-gray-300 font-mono">
                                        {formatBytes(metrics.disk_used || 0)} / {formatBytes(metrics.disk_total || 0)}
                                    </span>
                                </div>
                                
                                {/* Network */}
                                <div className="flex items-center justify-between text-xs">
                                    <span className="text-gray-500 flex items-center gap-2">
                                        <Icons.Network /> Network In
                                    </span>
                                    <div className="flex items-center gap-2">
                                        <Sparkline data={history.netin} width={50} height={16} color="#22c55e" />
                                        <span className="text-green-400 font-mono w-16 text-right">
                                            {history.netin[history.netin.length-1]?.toFixed(1) || '0.0'} MB/s
                                        </span>
                                    </div>
                                </div>
                                <div className="flex items-center justify-between text-xs">
                                    <span className="text-gray-500 flex items-center gap-2">
                                        <Icons.Network /> Network Out
                                    </span>
                                    <div className="flex items-center gap-2">
                                        <Sparkline data={history.netout} width={50} height={16} color="#f97316" />
                                        <span className="text-orange-400 font-mono w-16 text-right">
                                            {history.netout[history.netout.length-1]?.toFixed(1) || '0.0'} MB/s
                                        </span>
                                    </div>
                                </div>
                                
                                {/* Load Average */}
                                {metrics.loadavg && (
                                    <div className="flex items-center justify-between text-xs">
                                        <span className="text-gray-500 flex items-center gap-2">
                                            <Icons.Activity /> Load Avg
                                        </span>
                                        <span className="text-gray-300 font-mono">
                                            {Array.isArray(metrics.loadavg) ? 
                                                metrics.loadavg.map(l => l.toFixed(2)).join(' / ') :
                                                typeof metrics.loadavg === 'number' ? metrics.loadavg.toFixed(2) : '-'
                                            }
                                        </span>
                                    </div>
                                )}
                                
                                {/* CPU Info */}
                                {metrics.cpuinfo && (
                                    <div className="flex items-center justify-between text-xs">
                                        <span className="text-gray-500">{t('cores')}</span>
                                        <span className="text-gray-300">
                                            {metrics.cpuinfo.cores || metrics.cpuinfo.cpus || '-'} √ó {metrics.cpuinfo.sockets || 1} Socket
                                        </span>
                                    </div>
                                )}
                                
                                {/* Kernel Version */}
                                {metrics.kversion && (
                                    <div className="flex items-center justify-between text-xs">
                                        <span className="text-gray-500">Kernel</span>
                                        <span className="text-gray-400 font-mono text-[10px] truncate max-w-32">
                                            {metrics.kversion.split(' ')[0] || metrics.kversion}
                                        </span>
                                    </div>
                                )}
                                
                                {/* PVE Version */}
                                {metrics.pveversion && (
                                    <div className="flex items-center justify-between text-xs">
                                        <span className="text-gray-500">PVE</span>
                                        <span className="text-gray-400 font-mono text-[10px]">
                                            {metrics.pveversion}
                                        </span>
                                    </div>
                                )}
                            </div>
                        )}
                        
                        {metrics.uptime > 0 && (
                            <div className="flex items-center justify-between text-xs">
                                <span className="text-gray-500 flex items-center gap-1">
                                    <Icons.Clock /> {t('uptime')}
                                </span>
                                <span className="text-gray-300 font-mono">{formatUptime(metrics.uptime)}</span>
                            </div>
                        )}
                    </div>

                    {/* Maintenance Confirmation Modal */}
                    {showMaintenanceConfirm && (
                        <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/60" onClick={() => setShowMaintenanceConfirm(false)}>
                            <div 
                                className="w-full max-w-md bg-proxmox-card border border-proxmox-border rounded-2xl shadow-2xl overflow-hidden"
                                onClick={e => e.stopPropagation()}
                            >
                                <div className="p-6 border-b border-proxmox-border">
                                    <div className="flex items-center gap-3">
                                        <div className="p-3 bg-yellow-500/10 rounded-xl">
                                            <Icons.Wrench />
                                        </div>
                                        <div>
                                            <h2 className="text-lg font-bold text-white">{t('maintenanceModeTitle')}</h2>
                                            <p className="text-sm text-gray-400">{name}</p>
                                        </div>
                                    </div>
                                </div>
                                <div className="p-6">
                                    <div className="bg-yellow-500/10 border border-yellow-500/30 rounded-lg p-4 mb-4">
                                        <p className="text-sm text-yellow-200">
                                            <strong>{t('warning')}:</strong> {t('maintenanceWarning').replace('Warning: ', '')}
                                        </p>
                                    </div>
                                    <p className="text-sm text-gray-400 mb-6">
                                        {t('maintenanceDesc')}
                                    </p>
                                    <div className="flex gap-3">
                                        <button
                                            onClick={() => setShowMaintenanceConfirm(false)}
                                            className="flex-1 px-4 py-2.5 bg-proxmox-dark border border-proxmox-border rounded-lg text-gray-300 font-medium hover:bg-proxmox-hover transition-colors"
                                        >
                                            {t('cancel')}
                                        </button>
                                        <button
                                            onClick={() => {
                                                setShowMaintenanceConfirm(false);
                                                onMaintenanceToggle(name, true);
                                            }}
                                            className="flex-1 px-4 py-2.5 bg-yellow-500 hover:bg-yellow-600 rounded-lg text-black font-medium transition-colors"
                                        >
                                            {t('startMaintenance')}
                                        </button>
                                    </div>
                                    
                                    {/* Remove Node Option - MK: Jan 2026 */}
                                    <div className="mt-6 pt-4 border-t border-proxmox-border">
                                        <button
                                            onClick={() => {
                                                setShowMaintenanceConfirm(false);
                                                onOpenNodeConfig && onOpenNodeConfig(name);
                                            }}
                                            className="w-full text-left px-3 py-2 text-sm text-red-400 hover:bg-red-500/10 rounded-lg transition-colors flex items-center gap-2"
                                        >
                                            <Icons.Trash className="w-4 h-4" />
                                            {t('removeNodeFromCluster') || 'Remove Node from Cluster'}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Update Confirmation Modal */}
                    {showUpdateConfirm && (
                        <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/60" onClick={() => setShowUpdateConfirm(false)}>
                            <div 
                                className="w-full max-w-md bg-proxmox-card border border-proxmox-border rounded-2xl shadow-2xl overflow-hidden"
                                onClick={e => e.stopPropagation()}
                            >
                                <div className="p-6 border-b border-proxmox-border">
                                    <div className="flex items-center gap-3">
                                        <div className="p-3 bg-blue-500/10 rounded-xl">
                                            <Icons.Download />
                                        </div>
                                        <div>
                                            <h2 className="text-lg font-bold text-white">{t('updateNode')}</h2>
                                            <p className="text-sm text-gray-400">{name}</p>
                                        </div>
                                    </div>
                                </div>
                                <div className="p-6">
                                    <div className="bg-blue-500/10 border border-blue-500/30 rounded-lg p-4 mb-4">
                                        <p className="text-sm text-blue-200">
                                            {t('updateCommand')}
                                        </p>
                                    </div>
                                    
                                    <label className="flex items-center gap-3 mb-6 cursor-pointer">
                                        <input 
                                            type="checkbox" 
                                            checked={updateWithReboot}
                                            onChange={(e) => setUpdateWithReboot(e.target.checked)}
                                            className="w-5 h-5 rounded border-proxmox-border bg-proxmox-dark text-blue-500 focus:ring-blue-500"
                                        />
                                        <div>
                                            <span className="text-white font-medium">{t('rebootAfterUpdate')}</span>
                                            <p className="text-xs text-gray-500">{t('recommendedForKernel')}</p>
                                        </div>
                                    </label>
                                    
                                    <div className="flex gap-3">
                                        <button
                                            onClick={() => setShowUpdateConfirm(false)}
                                            className="flex-1 px-4 py-2.5 bg-proxmox-dark border border-proxmox-border rounded-lg text-gray-300 font-medium hover:bg-proxmox-hover transition-colors"
                                        >
                                            {t('cancel')}
                                        </button>
                                        <button
                                            onClick={() => {
                                                setShowUpdateConfirm(false);
                                                onStartUpdate(name, updateWithReboot);
                                            }}
                                            className="flex-1 px-4 py-2.5 bg-blue-500 hover:bg-blue-600 rounded-lg text-white font-medium transition-colors"
                                        >
                                            {t('startUpdate')}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Update Log Modal */}
                    {showUpdateLog && updateTask && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop bg-black/60" onClick={() => setShowUpdateLog(false)}>
                            <div 
                                className="w-full max-w-2xl bg-proxmox-card border border-proxmox-border rounded-2xl shadow-2xl animate-scale-in overflow-hidden"
                                onClick={e => e.stopPropagation()}
                            >
                                <div className="p-4 border-b border-proxmox-border flex items-center justify-between">
                                    <div className="flex items-center gap-3">
                                        <Icons.Terminal />
                                        <h2 className="font-bold text-white">Update Log - {name}</h2>
                                    </div>
                                    <button
                                        onClick={() => setShowUpdateLog(false)}
                                        className="p-2 hover:bg-proxmox-hover rounded-lg transition-colors"
                                    >
                                        <Icons.X />
                                    </button>
                                </div>
                                <div className="p-4 bg-proxmox-darker font-mono text-xs max-h-96 overflow-y-auto">
                                    {updateTask.output_lines?.map((line, idx) => (
                                        <div key={idx} className="py-0.5 text-gray-300 hover:bg-proxmox-card/50">
                                            <span className="text-gray-600 mr-2">{new Date(line.timestamp).toLocaleTimeString('de-DE')}</span>
                                            {line.text}
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Reboot Confirmation Modal */}
                    {showRebootConfirm && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop bg-black/60" onClick={() => setShowRebootConfirm(false)}>
                            <div 
                                className="w-full max-w-md bg-proxmox-card border border-orange-500/30 rounded-2xl shadow-2xl animate-scale-in overflow-hidden"
                                onClick={e => e.stopPropagation()}
                            >
                                <div className="p-6 border-b border-orange-500/30 bg-orange-500/10">
                                    <div className="flex items-center gap-3">
                                        <div className="p-3 bg-orange-500/20 rounded-xl">
                                            <Icons.RefreshCw />
                                        </div>
                                        <div>
                                            <h2 className="text-lg font-bold text-white">{t('rebootNode')}</h2>
                                            <p className="text-sm text-orange-400">{name}</p>
                                        </div>
                                    </div>
                                </div>
                                <div className="p-6">
                                    <div className="bg-orange-500/10 border border-orange-500/30 rounded-lg p-4 mb-4">
                                        <p className="text-sm text-orange-200">
                                            {t('rebootNodeWarning')}
                                        </p>
                                    </div>
                                    <div className="flex gap-3">
                                        <button
                                            onClick={() => setShowRebootConfirm(false)}
                                            className="flex-1 px-4 py-2.5 bg-proxmox-dark border border-proxmox-border rounded-lg text-gray-300 font-medium hover:bg-proxmox-hover transition-colors"
                                        >
                                            {t('cancel')}
                                        </button>
                                        <button
                                            onClick={async () => {
                                                setActionLoading('reboot');
                                                setShowRebootConfirm(false);
                                                if (onNodeAction) await onNodeAction(name, 'reboot');
                                                setActionLoading(null);
                                            }}
                                            disabled={actionLoading}
                                            className="flex-1 flex items-center justify-center gap-2 px-4 py-2.5 bg-orange-500 hover:bg-orange-600 rounded-lg text-white font-medium transition-colors disabled:opacity-50"
                                        >
                                            {actionLoading === 'reboot' ? <Icons.RotateCw /> : <Icons.RefreshCw />}
                                            {t('rebootNow')}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Shutdown Confirmation Modal */}
                    {showShutdownConfirm && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop bg-black/60" onClick={() => setShowShutdownConfirm(false)}>
                            <div 
                                className="w-full max-w-md bg-proxmox-card border border-red-500/30 rounded-2xl shadow-2xl animate-scale-in overflow-hidden"
                                onClick={e => e.stopPropagation()}
                            >
                                <div className="p-6 border-b border-red-500/30 bg-red-500/10">
                                    <div className="flex items-center gap-3">
                                        <div className="p-3 bg-red-500/20 rounded-xl">
                                            <Icons.Power />
                                        </div>
                                        <div>
                                            <h2 className="text-lg font-bold text-white">{t('shutdownNode')}</h2>
                                            <p className="text-sm text-red-400">{name}</p>
                                        </div>
                                    </div>
                                </div>
                                <div className="p-6">
                                    <div className="bg-red-500/10 border border-red-500/30 rounded-lg p-4 mb-4">
                                        <p className="text-sm text-red-200">
                                            {t('shutdownNodeWarning')}
                                        </p>
                                    </div>
                                    <div className="flex gap-3">
                                        <button
                                            onClick={() => setShowShutdownConfirm(false)}
                                            className="flex-1 px-4 py-2.5 bg-proxmox-dark border border-proxmox-border rounded-lg text-gray-300 font-medium hover:bg-proxmox-hover transition-colors"
                                        >
                                            {t('cancel')}
                                        </button>
                                        <button
                                            onClick={async () => {
                                                setActionLoading('shutdown');
                                                setShowShutdownConfirm(false);
                                                if (onNodeAction) await onNodeAction(name, 'shutdown');
                                                setActionLoading(null);
                                            }}
                                            disabled={actionLoading}
                                            className="flex-1 flex items-center justify-center gap-2 px-4 py-2.5 bg-red-500 hover:bg-red-600 rounded-lg text-white font-medium transition-colors disabled:opacity-50"
                                        >
                                            {actionLoading === 'shutdown' ? <Icons.RotateCw /> : <Icons.Power />}
                                            {t('shutdownNow')}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // Resource Table Component
        // LW: The main VM/CT list - supports cards, table, and detail view
        // NS: Added bulk select for mass operations (migration, etc.)
        // This component does a lot... might need to split it up eventually
        // FIXME: rerenders too often, useMemo wuold help probably
        function ResourceTable({ resources, clusterId, clusters, sourceCluster, onVmAction, onOpenConsole, onOpenConfig, onMigrate, onBulkMigrate, onDelete, onClone, onForceStop, onCrossClusterMigrate, nodes, onOpenTags, highlightedVm, addToast }) {
            const { t } = useTranslation();
            const [search, setSearch] = useState('');
            const [filter, setFilter] = useState('all');
            const [sortBy, setSortBy] = useState('vmid');
            const [sortDir, setSortDir] = useState('asc');
            const [viewMode, setViewMode] = useState('cards'); // 'cards', 'table', or 'detail'
            // const [viewMode, setViewMode] = useState('table'); // old default
            const [actionLoading, setActionLoading] = useState({});
            const [selectedVms, setSelectedVms] = useState([]);
            const [showMigrateModal, setShowMigrateModal] = useState(null);
            const [showBulkMigrate, setShowBulkMigrate] = useState(false);
            const [showDeleteConfirm, setShowDeleteConfirm] = useState(null);
            const [showCloneModal, setShowCloneModal] = useState(null);
            const [selectedDetailVm, setSelectedDetailVm] = useState(null); // For detail view
            const highlightedRowRef = useRef(null);
            
            // Pagination states - MK Jan 2026
            // LW: Moved up 25.01.2026 - must be declared before useEffect that uses them
            // This was breaking pre-compiled builds (GitHub Issue #4)
            // Browser-Babel was more forgiving but compiled JS enforces strict declaration order
            const [currentPage, setCurrentPage] = useState(1);
            const [itemsPerPage, setItemsPerPage] = useState(50); // Default 50, options: 50, 100, 200, 500
            
            // NS: scroll to highlighted VM from global search
            // claude helped with the pagination math here - kept getting off-by-one errors
            useEffect(() => {
                if (highlightedVm) {
                    // clear filters first
                    setSearch('');
                    setFilter('all');
                    
                    // jump to correct page
                    const vmIndex = resources.findIndex(r => r.vmid === highlightedVm.vmid);
                    if (vmIndex !== -1) {
                        const targetPage = Math.floor(vmIndex / itemsPerPage) + 1;
                        setCurrentPage(targetPage);
                    }
                    
                    // wait for render then scroll
                    setTimeout(() => {
                        if (highlightedRowRef.current) {
                            highlightedRowRef.current.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                    }, 100);
                }
            }, [highlightedVm, resources, itemsPerPage]);
            const [showCrossClusterMigrate, setShowCrossClusterMigrate] = useState(null);
            const [showMetricsModal, setShowMetricsModal] = useState(null); // For VM metrics
            const [openDropdown, setOpenDropdown] = useState(null); // action dropdown menu
            const prevResources = useRef(resources);  // for comparison, not really used

            const filterLabels = {
                all: t('all'),
                running: t('active'),
                stopped: t('stopped'),
                vm: 'VM',
                lxc: 'LXC'
            };

            // LW: filter + sort in one useMemo for perf
            // TODO: maybe split this up, its getting complex
            const filteredResources = useMemo(() => {
                let filtered = resources.filter(r => {
                    // search by name or vmid
                    const matchesSearch = 
                        r.name?.toLowerCase().includes(search.toLowerCase()) ||
                        r.vmid?.toString().includes(search);
                    const matchesFilter = 
                        filter === 'all' ||
                        (filter === 'running' && r.status === 'running') ||
                        (filter === 'stopped' && r.status === 'stopped') ||
                        (filter === 'vm' && r.type === 'qemu') ||
                        (filter === 'lxc' && r.type === 'lxc');
                    return matchesSearch && matchesFilter;
                });
                
                // sort
                filtered.sort((a, b) => {
                    const aVal = a[sortBy];
                    const bVal = b[sortBy];
                    const dir = sortDir === 'asc' ? 1 : -1;
                    if (typeof aVal === 'number') return(aVal - bVal) * dir;
                    return String(aVal).localeCompare(String(bVal)) * dir;
                });
                
                return filtered;
            }, [resources, search, filter, sortBy, sortDir]);
            
            // Reset page when filters change - MK Jan 2026
            useEffect(() => {
                setCurrentPage(1);
            }, [search, filter, sortBy, sortDir, itemsPerPage]);
            
            // Paginated resources - MK Jan 2026
            const totalPages = Math.ceil(filteredResources.length / itemsPerPage);
            const paginatedResources = useMemo(() => {
                const startIndex = (currentPage - 1) * itemsPerPage;
                return filteredResources.slice(startIndex, startIndex + itemsPerPage);
            }, [filteredResources, currentPage, itemsPerPage]);

            const handleSort = (col) => {
                if (sortBy === col) {
                    setSortDir(sortDir === 'asc' ? 'desc' : 'asc');
                } else {
                    setSortBy(col);
                    setSortDir('asc');  // reset to asc on new column
                }
            };

            // NS: 1073741824 = 1024^3 (GB), 1048576 = 1024^2 (MB)
            const formatBytes = (bytes) => {
                const gb = bytes / 1073741824;
                return gb >= 1 ? `${gb.toFixed(1)} GB` : `${(bytes / 1048576).toFixed(0)} MB`;
            };
            
            // old version for reference
            // const formatBytes2 = (b) => b >= 1073741824 ? `${(b/1073741824).toFixed(1)} GB` : `${(b/1048576).toFixed(0)} MB`;

            const handleAction = async (resource, action) => {
                const key = `${resource.vmid}-${action}`;
                setActionLoading(prev => ({ ...prev, [key]: true }));
                await onVmAction(resource, action);
                setActionLoading(prev => ({ ...prev, [key]: false }));
            };

            const toggleSelect = (resource) => {
                setSelectedVms(prev => {
                    const exists = prev.find(v => v.vmid === resource.vmid);
                    if (exists) {
                        return prev.filter(v => v.vmid !== resource.vmid);
                    }
                    return [...prev, { vmid: resource.vmid, node: resource.node, type: resource.type, name: resource.name }];
                });
            };

            const toggleSelectAll = () => {
                if (selectedVms.length === filteredResources.length) {
                    setSelectedVms([]);
                } else {
                    setSelectedVms(filteredResources.map(r => ({ vmid: r.vmid, node: r.node, type: r.type, name: r.name })));
                }
            };

            const groupedByNode = useMemo(() => {
                const groups = {};
                filteredResources.forEach(r => {
                    if (!groups[r.node]) groups[r.node] = [];
                    groups[r.node].push(r);
                });
                return groups;
            }, [filteredResources]);

            return(
                <div className="space-y-4">
                    <div className="flex flex-wrap items-center gap-3">
                        <div className="relative flex-1 min-w-[200px]">
                            <Icons.Search />
                            <input
                                type="text"
                                placeholder={t('searchByNameOrId')}
                                value={search}
                                onChange={(e) => setSearch(e.target.value)}
                                className="w-full pl-10 pr-4 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-sm text-white placeholder-gray-500 focus:outline-none focus:border-proxmox-orange transition-colors"
                            />
                            <div className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500">
                                <Icons.Search />
                            </div>
                        </div>
                        <div className="flex items-center gap-2">
                            {['all', 'running', 'stopped', 'vm', 'lxc'].map(f => (
                                <button
                                    key={f}
                                    onClick={() => setFilter(f)}
                                    className={`px-3 py-1.5 text-xs font-medium rounded-lg transition-all ${
                                        filter === f 
                                            ? 'bg-proxmox-orange text-white' 
                                            : 'bg-proxmox-dark text-gray-400 hover:text-white border border-proxmox-border'
                                    }`}
                                >
                                    {filterLabels[f]}
                                </button>
                            ))}
                        </div>
                        <div className="flex items-center gap-1 p-1 bg-proxmox-dark rounded-lg border border-proxmox-border">
                            <button
                                onClick={() => setViewMode('cards')}
                                className={`p-1.5 rounded transition-colors ${viewMode === 'cards' ? 'bg-proxmox-orange text-white' : 'text-gray-400 hover:text-white'}`}
                                title={t('gridView')}
                            >
                                <Icons.Grid />
                            </button>
                            <button
                                onClick={() => setViewMode('table')}
                                className={`p-1.5 rounded transition-colors ${viewMode === 'table' ? 'bg-proxmox-orange text-white' : 'text-gray-400 hover:text-white'}`}
                                title={t('listView')}
                            >
                                <Icons.List />
                            </button>
                            <button
                                onClick={() => setViewMode('detail')}
                                className={`p-1.5 rounded transition-colors ${viewMode === 'detail' ? 'bg-proxmox-orange text-white' : 'text-gray-400 hover:text-white'}`}
                                title={t('compactView')}
                            >
                                <Icons.Eye />
                            </button>
                        </div>
                    </div>

                    {/* Bulk Actions Bar */}
                    {selectedVms.length > 0 && (
                        <div className="flex items-center gap-3 p-3 bg-proxmox-orange/10 border border-proxmox-orange/30 rounded-lg">
                            <span className="text-sm text-proxmox-orange font-medium">
                                {selectedVms.length} {t('selectedItems')}
                            </span>
                            <button
                                onClick={() => setShowBulkMigrate(true)}
                                className="flex items-center gap-2 px-3 py-1.5 bg-blue-600 rounded-lg text-white text-sm hover:bg-blue-700"
                            >
                                <Icons.ArrowRight />
                                {t('migrate')}
                            </button>
                            <button
                                onClick={() => setSelectedVms([])}
                                className="px-3 py-1.5 text-gray-400 hover:text-white text-sm"
                            >
                                {t('deselectAll')}
                            </button>
                        </div>
                    )}

                    {/* Cards View */}
                    {viewMode === 'cards' && (
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                            {paginatedResources.length === 0 ? (
                                <div className="col-span-full text-center py-12 text-gray-500">
                                    {t('noResults')}
                                </div>
                            ) : (
                                paginatedResources.map((resource, idx) => (
                                    <div 
                                        key={resource.vmid}
                                        ref={highlightedVm?.vmid === resource.vmid ? highlightedRowRef : null}
                                        className={`bg-proxmox-card border rounded-xl overflow-hidden transition-all hover:border-proxmox-orange/50 animate-fade-in ${
                                            selectedVms.find(v => v.vmid === resource.vmid) 
                                                ? 'border-proxmox-orange bg-proxmox-orange/5' 
                                                : highlightedVm?.vmid === resource.vmid
                                                    ? 'ring-2 ring-proxmox-orange border-proxmox-orange bg-proxmox-orange/20'
                                                    : 'border-proxmox-border'
                                        }`}
                                        style={{ animationDelay: `${idx * 30}ms` }}
                                    >
                                        {/* Card Header */}
                                        <div className="flex items-center justify-between p-4 border-b border-proxmox-border bg-proxmox-dark/50">
                                            <div className="flex items-center gap-3">
                                                <input 
                                                    type="checkbox"
                                                    checked={!!selectedVms.find(v => v.vmid === resource.vmid)}
                                                    onChange={() => toggleSelect(resource)}
                                                    className="w-4 h-4 rounded border-proxmox-border bg-proxmox-dark text-proxmox-orange"
                                                />
                                                <div className={`p-2 rounded-lg ${resource.type === 'qemu' ? 'bg-blue-500/10' : 'bg-purple-500/10'}`}>
                                                    {resource.type === 'qemu' ? <Icons.VM /> : <Icons.Container />}
                                                </div>
                                                <div>
                                                    <div className="font-medium text-white truncate max-w-[150px]">
                                                        {resource.name || `${resource.type === 'qemu' ? 'VM' : 'CT'} ${resource.vmid}`}
                                                    </div>
                                                    <div className="text-xs text-gray-500">ID: {resource.vmid}</div>
                                                </div>
                                            </div>
                                            <span className={`w-2.5 h-2.5 rounded-full ${
                                                resource.status === 'running' ? 'bg-green-500 animate-pulse' : 'bg-red-500'
                                            }`} />
                                        </div>
                                        
                                        {/* Card Body */}
                                        <div className="p-4 space-y-3">
                                            <div className="flex items-center justify-between text-sm">
                                                <span className="text-gray-500">{t('node')}</span>
                                                <span className="text-gray-300 font-mono">{resource.node}</span>
                                            </div>
                                            <div className="flex items-center justify-between text-sm">
                                                <span className="text-gray-500">{t('status')}</span>
                                                <span className={`px-2 py-0.5 rounded text-xs font-medium ${
                                                    resource.status === 'running' 
                                                        ? 'bg-green-500/10 text-green-400' 
                                                        : 'bg-red-500/10 text-red-400'
                                                }`}>
                                                    {resource.status === 'running' ? t('running') : t('stopped')}
                                                </span>
                                            </div>
                                            {/* VM Tags */}
                                            {resource.tags && (
                                                <div className="flex flex-wrap gap-1">
                                                    {resource.tags.split(';').filter(t => t.trim()).map((tag, i) => (
                                                        <span key={i} className="px-1.5 py-0.5 text-xs rounded bg-proxmox-orange/20 text-proxmox-orange">
                                                            {tag.trim()}
                                                        </span>
                                                    ))}
                                                </div>
                                            )}
                                            <div>
                                                <div className="flex items-center justify-between text-xs mb-1">
                                                    <span className="text-gray-500">{t('ram')}</span>
                                                    <span className="text-gray-400 font-mono">
                                                        {formatBytes(resource.mem)} / {formatBytes(resource.maxmem)}
                                                    </span>
                                                </div>
                                                <div className="h-1.5 rounded-full bg-proxmox-border overflow-hidden">
                                                    <div 
                                                        className="h-full rounded-full transition-all"
                                                        style={{
                                                            width: `${resource.mem_percent || 0}%`,
                                                            background: resource.mem_percent < 50 ? '#22c55e' : resource.mem_percent < 80 ? '#eab308' : '#ef4444'
                                                        }}
                                                    />
                                                </div>
                                            </div>
                                            <div>
                                                <div className="flex items-center justify-between text-xs mb-1">
                                                    <span className="text-gray-500">{t('cpu')}</span>
                                                    <span className="text-gray-400 font-mono">
                                                        {(resource.cpu_percent || 0).toFixed(1)}% {resource.maxcpu && `(${resource.maxcpu} ${t('cores')})`}
                                                    </span>
                                                </div>
                                                <div className="h-1.5 rounded-full bg-proxmox-border overflow-hidden">
                                                    <div 
                                                        className="h-full rounded-full transition-all"
                                                        style={{
                                                            width: `${Math.min(resource.cpu_percent || 0, 100)}%`,
                                                            background: (resource.cpu_percent || 0) < 50 ? '#3b82f6' : (resource.cpu_percent || 0) < 80 ? '#eab308' : '#ef4444'
                                                        }}
                                                    />
                                                </div>
                                            </div>
                                        </div>
                                        
                                        {/* Card Actions */}
                                        <div className="flex items-center justify-between p-3 border-t border-proxmox-border bg-proxmox-dark/30">
                                            {/* Primary Actions - Always visible */}
                                            <div className="flex items-center gap-1">
                                                {resource.status === 'stopped' ? (
                                                    <button
                                                        onClick={() => handleAction(resource, 'start')}
                                                        disabled={actionLoading[`${resource.vmid}-start`]}
                                                        className="p-1.5 rounded-lg hover:bg-green-500/20 text-gray-400 hover:text-green-400 transition-all disabled:opacity-50"
                                                        title={t('start')}
                                                    >
                                                        {actionLoading[`${resource.vmid}-start`] ? <Icons.RotateCw className="animate-spin" /> : <Icons.PlayCircle />}
                                                    </button>
                                                ) : (
                                                    <>
                                                        <button
                                                            onClick={() => handleAction(resource, 'shutdown')}
                                                            disabled={actionLoading[`${resource.vmid}-shutdown`]}
                                                            className="p-1.5 rounded-lg hover:bg-yellow-500/20 text-gray-400 hover:text-yellow-400 transition-all disabled:opacity-50"
                                                            title={t('shutdown')}
                                                        >
                                                            {actionLoading[`${resource.vmid}-shutdown`] ? <Icons.RotateCw className="animate-spin" /> : <Icons.Power />}
                                                        </button>
                                                        <button
                                                            onClick={() => handleAction(resource, 'reboot')}
                                                            disabled={actionLoading[`${resource.vmid}-reboot`]}
                                                            className="p-1.5 rounded-lg hover:bg-orange-500/20 text-gray-400 hover:text-orange-400 transition-all disabled:opacity-50"
                                                            title={t('reboot')}
                                                        >
                                                            {actionLoading[`${resource.vmid}-reboot`] ? <Icons.RotateCw className="animate-spin" /> : <Icons.RefreshCw />}
                                                        </button>
                                                    </>
                                                )}
                                                {resource.status === 'running' && (
                                                    <button
                                                        onClick={() => onOpenConsole(resource)}
                                                        className="p-1.5 rounded-lg hover:bg-blue-500/20 text-gray-400 hover:text-blue-400 transition-all"
                                                        title={t('console')}
                                                    >
                                                        <Icons.Monitor />
                                                    </button>
                                                )}
                                                <button
                                                    onClick={() => onOpenConfig(resource)}
                                                    className="p-1.5 rounded-lg hover:bg-purple-500/20 text-gray-400 hover:text-purple-400 transition-all"
                                                    title={t('configuration')}
                                                >
                                                    <Icons.Cog />
                                                </button>
                                                <button
                                                    onClick={() => setShowMigrateModal(resource)}
                                                    className="p-1.5 rounded-lg hover:bg-cyan-500/20 text-gray-400 hover:text-cyan-400 transition-all"
                                                    title={t('migrate')}
                                                >
                                                    <Icons.ArrowRight />
                                                </button>
                                            </div>
                                            
                                            {/* More Actions Dropdown */}
                                            <div className="relative">
                                                <button
                                                    onClick={(e) => {
                                                        e.stopPropagation();
                                                        setOpenDropdown(openDropdown === resource.vmid ? null : resource.vmid);
                                                    }}
                                                    className="p-1.5 rounded-lg hover:bg-proxmox-hover text-gray-400 hover:text-white transition-all"
                                                    title={t('moreActions')}
                                                >
                                                    <Icons.MoreVertical />
                                                </button>
                                                
                                                {openDropdown === resource.vmid && (
                                                    <>
                                                        <div className="fixed inset-0 z-40" onClick={() => setOpenDropdown(null)} />
                                                        <div className="absolute right-0 bottom-full mb-1 w-48 bg-proxmox-card border border-proxmox-border rounded-lg shadow-xl z-50 py-1 animate-fade-in">
                                                            <button
                                                                onClick={() => { setShowMigrateModal(resource); setOpenDropdown(null); }}
                                                                className="w-full px-3 py-2 text-left text-sm text-gray-300 hover:bg-proxmox-hover flex items-center gap-2"
                                                            >
                                                                <Icons.ArrowRight className="w-4 h-4" />
                                                                {t('migrate')}
                                                            </button>
                                                            {clusters && clusters.length > 1 && (
                                                                <button
                                                                    onClick={() => { setShowCrossClusterMigrate(resource); setOpenDropdown(null); }}
                                                                    className="w-full px-3 py-2 text-left text-sm text-gray-300 hover:bg-proxmox-hover flex items-center gap-2"
                                                                >
                                                                    <Icons.Globe className="w-4 h-4" />
                                                                    {t('crossClusterMigrate')}
                                                                </button>
                                                            )}
                                                            <button
                                                                onClick={() => { setShowMetricsModal(resource); setOpenDropdown(null); }}
                                                                className="w-full px-3 py-2 text-left text-sm text-gray-300 hover:bg-proxmox-hover flex items-center gap-2"
                                                            >
                                                                <Icons.BarChart className="w-4 h-4" />
                                                                {t('performance')}
                                                            </button>
                                                            <button
                                                                onClick={() => { setShowCloneModal(resource); setOpenDropdown(null); }}
                                                                className="w-full px-3 py-2 text-left text-sm text-gray-300 hover:bg-proxmox-hover flex items-center gap-2"
                                                            >
                                                                <Icons.Copy className="w-4 h-4" />
                                                                {t('clone')}
                                                            </button>
                                                            {resource.status === 'running' && (
                                                                <>
                                                                    {/* Force Reset - QEMU only */}
                                                                    {resource.type === 'qemu' && (
                                                                        <button
                                                                            onClick={() => { onVmAction(resource, 'reset'); setOpenDropdown(null); }}
                                                                            className="w-full px-3 py-2 text-left text-sm text-yellow-400 hover:bg-yellow-500/10 flex items-center gap-2"
                                                                        >
                                                                            <Icons.Zap className="w-4 h-4" />
                                                                            {t('forceReset')}
                                                                        </button>
                                                                    )}
                                                                    <button
                                                                        onClick={() => { onForceStop(resource); setOpenDropdown(null); }}
                                                                        className="w-full px-3 py-2 text-left text-sm text-yellow-400 hover:bg-yellow-500/10 flex items-center gap-2"
                                                                    >
                                                                        <Icons.XCircle className="w-4 h-4" />
                                                                        {t('forceStop')}
                                                                    </button>
                                                                </>
                                                            )}
                                                            <div className="border-t border-proxmox-border my-1" />
                                                            <button
                                                                onClick={() => { setShowDeleteConfirm(resource); setOpenDropdown(null); }}
                                                                className="w-full px-3 py-2 text-left text-sm text-red-400 hover:bg-red-500/10 flex items-center gap-2"
                                                            >
                                                                <Icons.Trash className="w-4 h-4" />
                                                                {t('delete')}
                                                            </button>
                                                        </div>
                                                    </>
                                                )}
                                            </div>
                                        </div>
                                    </div>
                                ))
                            )}
                        </div>
                    )}

                    {/* Table View */}
                    {viewMode === 'table' && (
                        <div className="overflow-hidden rounded-xl border border-proxmox-border">
                            <table className="w-full">
                                <thead>
                                    <tr className="bg-proxmox-dark text-left">
                                        <th className="px-4 py-3 w-10">
                                            <input 
                                                type="checkbox" 
                                                checked={selectedVms.length === filteredResources.length && filteredResources.length > 0}
                                                onChange={toggleSelectAll}
                                                className="w-4 h-4 rounded border-proxmox-border bg-proxmox-dark text-proxmox-orange focus:ring-proxmox-orange"
                                            />
                                        </th>
                                        {[
                                            { key: 'vmid', label: 'ID' },
                                            { key: 'name', label: 'Name' },
                                            { key: 'type', label: 'Typ' },
                                            { key: 'node', label: 'Node' },
                                            { key: 'mem', label: 'RAM' },
                                            { key: 'status', label: 'Status' },
                                            { key: 'actions', label: 'Aktionen' },
                                        ].map(col => (
                                            <th 
                                                key={col.key}
                                                onClick={() => col.key !== 'actions' && handleSort(col.key)}
                                                className={`px-4 py-3 text-xs font-semibold text-gray-400 uppercase tracking-wider ${col.key !== 'actions' ? 'cursor-pointer hover:text-white' : ''} transition-colors`}
                                            >
                                                <div className="flex items-center gap-1">
                                                    {col.label}
                                                    {sortBy === col.key && (
                                                        <span className="text-proxmox-orange">{sortDir === 'asc' ? '‚Üë' : '‚Üì'}</span>
                                                    )}
                                                </div>
                                            </th>
                                        ))}
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-proxmox-border">
                                    {paginatedResources.length === 0 ? (
                                        <tr>
                                            <td colSpan={8} className="px-4 py-8 text-center text-gray-500">
                                                {t('noResults')}
                                            </td>
                                        </tr>
                                    ) : (
                                        paginatedResources.map((resource, idx) => (
                                            <tr 
                                                key={resource.vmid}
                                                ref={highlightedVm?.vmid === resource.vmid ? highlightedRowRef : null}
                                                className={`table-row-hover bg-proxmox-card animate-fade-in ${selectedVms.find(v => v.vmid === resource.vmid) ? 'bg-proxmox-orange/5' : ''} ${highlightedVm?.vmid === resource.vmid ? 'ring-2 ring-proxmox-orange bg-proxmox-orange/20' : ''}`}
                                                style={{ animationDelay: `${idx * 30}ms` }}
                                            >
                                                <td className="px-4 py-3">
                                                    <input 
                                                        type="checkbox"
                                                        checked={!!selectedVms.find(v => v.vmid === resource.vmid)}
                                                        onChange={() => toggleSelect(resource)}
                                                        className="w-4 h-4 rounded border-proxmox-border bg-proxmox-dark text-proxmox-orange focus:ring-proxmox-orange"
                                                    />
                                                </td>
                                                <td className="px-4 py-3">
                                                    <span className="font-mono text-sm text-gray-300">{resource.vmid}</span>
                                                </td>
                                                <td className="px-4 py-3">
                                                    <div>
                                                        <span className="font-medium text-white">{resource.name || '‚Äî'}</span>
                                                        {resource.tags && (
                                                            <div className="flex flex-wrap gap-1 mt-1">
                                                                {resource.tags.split(';').filter(t => t.trim()).slice(0, 3).map((tag, i) => (
                                                                    <span key={i} className="px-1.5 py-0.5 text-xs rounded bg-proxmox-orange/20 text-proxmox-orange">
                                                                        {tag.trim()}
                                                                    </span>
                                                                ))}
                                                                {resource.tags.split(';').filter(t => t.trim()).length > 3 && (
                                                                    <span className="px-1.5 py-0.5 text-xs rounded bg-gray-500/20 text-gray-400">
                                                                        +{resource.tags.split(';').filter(t => t.trim()).length - 3}
                                                                    </span>
                                                                )}
                                                            </div>
                                                        )}
                                                    </div>
                                                </td>
                                                <td className="px-4 py-3">
                                                    <span className={`inline-flex items-center gap-1.5 px-2 py-1 rounded-md text-xs font-medium ${
                                                        resource.type === 'qemu' 
                                                            ? 'bg-blue-500/10 text-blue-400 border border-blue-500/20'
                                                            : 'bg-purple-500/10 text-purple-400 border border-purple-500/20'
                                                    }`}>
                                                        {resource.type === 'qemu' ? <Icons.VM /> : <Icons.Container />}
                                                        {resource.type === 'qemu' ? 'VM' : 'LXC'}
                                                    </span>
                                                </td>
                                                <td className="px-4 py-3">
                                                    <span className="text-sm text-gray-300">{resource.node}</span>
                                                </td>
                                                <td className="px-4 py-3">
                                                    <div className="flex items-center gap-2">
                                                        <div className="flex-1 max-w-[100px]">
                                                            <div className="h-1.5 rounded-full bg-proxmox-border overflow-hidden">
                                                                <div 
                                                                    className="h-full rounded-full transition-all"
                                                                    style={{
                                                                        width: `${resource.mem_percent || 0}%`,
                                                                        background: resource.mem_percent < 50 ? '#22c55e' : resource.mem_percent < 80 ? '#eab308' : '#ef4444'
                                                                    }}
                                                                />
                                                            </div>
                                                        </div>
                                                        <span className="text-xs text-gray-400 font-mono whitespace-nowrap">
                                                            {formatBytes(resource.mem)} / {formatBytes(resource.maxmem)}
                                                        </span>
                                                    </div>
                                                </td>
                                                <td className="px-4 py-3">
                                                    <span className={`inline-flex items-center gap-1.5 px-2 py-1 rounded-md text-xs font-medium ${
                                                        resource.status === 'running'
                                                            ? 'bg-green-500/10 text-green-400 border border-green-500/20'
                                                            : resource.status === 'stopped'
                                                            ? 'bg-red-500/10 text-red-400 border border-red-500/20'
                                                            : 'bg-gray-500/10 text-gray-400 border border-gray-500/20'
                                                    }`}>
                                                        <span className={`w-1.5 h-1.5 rounded-full ${
                                                            resource.status === 'running' ? 'bg-green-400' : 'bg-red-400'
                                                        }`} />
                                                        {resource.status}
                                                    </span>
                                                </td>
                                                <td className="px-4 py-3">
                                                    <div className="flex items-center gap-1">
                                                        <button
                                                            onClick={() => onOpenConfig(resource)}
                                                            className="p-1.5 rounded-lg bg-proxmox-dark hover:bg-purple-500/20 text-gray-400 hover:text-purple-400 transition-all"
                                                            title="Konfiguration"
                                                        >
                                                            <Icons.Cog />
                                                        </button>
                                                        <button
                                                            onClick={() => onOpenTags && onOpenTags(resource)}
                                                            className="p-1.5 rounded-lg bg-proxmox-dark hover:bg-yellow-500/20 text-gray-400 hover:text-yellow-400 transition-all"
                                                            title="Tags"
                                                        >
                                                            <Icons.Tag />
                                                        </button>
                                                        <button
                                                            onClick={() => setShowMetricsModal(resource)}
                                                            className="p-1.5 rounded-lg bg-proxmox-dark hover:bg-blue-500/20 text-gray-400 hover:text-blue-400 transition-all"
                                                            title="Metrics"
                                                        >
                                                            <Icons.BarChart />
                                                        </button>
                                                        <button
                                                            onClick={() => setShowMigrateModal(resource)}
                                                            className="p-1.5 rounded-lg bg-proxmox-dark hover:bg-cyan-500/20 text-gray-400 hover:text-cyan-400 transition-all"
                                                            title="Migrieren"
                                                        >
                                                            <Icons.ArrowRight />
                                                        </button>
                                                        {clusters && clusters.length > 1 && (
                                                            <button
                                                                onClick={() => setShowCrossClusterMigrate(resource)}
                                                                className="p-1.5 rounded-lg bg-proxmox-dark hover:bg-emerald-500/20 text-gray-400 hover:text-emerald-400 transition-all"
                                                                title="Cross-Cluster"
                                                            >
                                                                <Icons.Globe />
                                                            </button>
                                                        )}
                                                        {resource.status === 'running' && (
                                                            <button
                                                                onClick={() => onOpenConsole(resource)}
                                                                className="p-1.5 rounded-lg bg-proxmox-dark hover:bg-blue-500/20 text-gray-400 hover:text-blue-400 transition-all"
                                                                title="Konsole √∂ffnen"
                                                            >
                                                                <Icons.Monitor />
                                                            </button>
                                                        )}
                                                        {resource.status === 'stopped' ? (
                                                            <button
                                                                onClick={() => handleAction(resource, 'start')}
                                                                disabled={actionLoading[`${resource.vmid}-start`]}
                                                                className="p-1.5 rounded-lg bg-proxmox-dark hover:bg-green-500/20 text-gray-400 hover:text-green-400 transition-all disabled:opacity-50"
                                                                title="Starten"
                                                            >
                                                                {actionLoading[`${resource.vmid}-start`] ? <Icons.RotateCw /> : <Icons.PlayCircle />}
                                                            </button>
                                                        ) : (
                                                            <>
                                                                <button
                                                                    onClick={() => handleAction(resource, 'shutdown')}
                                                                    disabled={actionLoading[`${resource.vmid}-shutdown`]}
                                                                    className="p-1.5 rounded-lg bg-proxmox-dark hover:bg-yellow-500/20 text-gray-400 hover:text-yellow-400 transition-all disabled:opacity-50"
                                                                    title="Herunterfahren"
                                                                >
                                                                    {actionLoading[`${resource.vmid}-shutdown`] ? <Icons.RotateCw /> : <Icons.Power />}
                                                                </button>
                                                                <button
                                                                    onClick={() => onForceStop(resource)}
                                                                    disabled={actionLoading[`${resource.vmid}-stop`]}
                                                                    className="p-1.5 rounded-lg bg-proxmox-dark hover:bg-red-500/20 text-gray-400 hover:text-red-400 transition-all disabled:opacity-50"
                                                                    title="Sofort ausschalten (Force Stop)"
                                                                >
                                                                    {actionLoading[`${resource.vmid}-stop`] ? <Icons.RotateCw /> : <Icons.XCircle />}
                                                                </button>
                                                                <button
                                                                    onClick={() => handleAction(resource, 'reboot')}
                                                                    disabled={actionLoading[`${resource.vmid}-reboot`]}
                                                                    className="p-1.5 rounded-lg bg-proxmox-dark hover:bg-orange-500/20 text-gray-400 hover:text-orange-400 transition-all disabled:opacity-50"
                                                                    title="Neustarten (Graceful)"
                                                                >
                                                                    {actionLoading[`${resource.vmid}-reboot`] ? <Icons.RotateCw /> : <Icons.RefreshCw />}
                                                                </button>
                                                                {/* Force Reset - QEMU only */}
                                                                {resource.type === 'qemu' && (
                                                                    <button
                                                                        onClick={() => handleAction(resource, 'reset')}
                                                                        disabled={actionLoading[`${resource.vmid}-reset`]}
                                                                        className="p-1.5 rounded-lg bg-proxmox-dark hover:bg-orange-500/20 text-gray-400 hover:text-orange-400 transition-all disabled:opacity-50"
                                                                        title="Force Reset (Hard)"
                                                                    >
                                                                        {actionLoading[`${resource.vmid}-reset`] ? <Icons.RotateCw /> : <Icons.Zap />}
                                                                    </button>
                                                                )}
                                                            </>
                                                        )}
                                                        <button
                                                            onClick={() => setShowCloneModal(resource)}
                                                            className="p-1.5 rounded-lg bg-proxmox-dark hover:bg-blue-500/20 text-gray-400 hover:text-blue-400 transition-all"
                                                            title="Klonen"
                                                        >
                                                            <Icons.Copy />
                                                        </button>
                                                        <button
                                                            onClick={() => setShowDeleteConfirm(resource)}
                                                            className="p-1.5 rounded-lg bg-proxmox-dark hover:bg-red-500/20 text-gray-400 hover:text-red-400 transition-all"
                                                            title="L√∂schen"
                                                        >
                                                            <Icons.Trash />
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                        ))
                                    )}
                                </tbody>
                            </table>
                        </div>
                    )}

                    {/* Detail View - Split Panel */}
                    {viewMode === 'detail' && (
                        <div className="grid grid-cols-1 lg:grid-cols-3 gap-4">
                            {/* VM List */}
                            <div className="lg:col-span-1 bg-proxmox-card border border-proxmox-border rounded-xl overflow-hidden">
                                <div className="p-3 border-b border-proxmox-border bg-proxmox-dark/50">
                                    <h3 className="text-sm font-medium text-gray-300">VMs & Container ({filteredResources.length})</h3>
                                </div>
                                <div className="max-h-[600px] overflow-y-auto">
                                    {paginatedResources.map(resource => (
                                        <div
                                            key={resource.vmid}
                                            onClick={() => setSelectedDetailVm(resource)}
                                            className={`flex items-center gap-3 p-3 cursor-pointer transition-all border-b border-gray-700/50 ${
                                                selectedDetailVm?.vmid === resource.vmid
                                                    ? 'bg-proxmox-orange/10 border-l-2 border-l-proxmox-orange'
                                                    : 'hover:bg-proxmox-dark/50'
                                            }`}
                                        >
                                            <div className={`p-1.5 rounded ${resource.type === 'qemu' ? 'bg-blue-500/10' : 'bg-purple-500/10'}`}>
                                                {resource.type === 'qemu' ? <Icons.VM /> : <Icons.Container />}
                                            </div>
                                            <div className="flex-1 min-w-0">
                                                <div className="font-medium text-white text-sm truncate">
                                                    {resource.name || `${resource.type === 'qemu' ? 'VM' : 'CT'} ${resource.vmid}`}
                                                </div>
                                                <div className="text-xs text-gray-500">ID: {resource.vmid} ¬∑ {resource.node}</div>
                                                {resource.tags && (
                                                    <div className="flex flex-wrap gap-1 mt-1">
                                                        {resource.tags.split(';').filter(t => t.trim()).slice(0, 2).map((tag, i) => (
                                                            <span key={i} className="px-1 py-0.5 text-xs rounded bg-proxmox-orange/20 text-proxmox-orange">
                                                                {tag.trim()}
                                                            </span>
                                                        ))}
                                                        {resource.tags.split(';').filter(t => t.trim()).length > 2 && (
                                                            <span className="px-1 py-0.5 text-xs rounded bg-gray-500/20 text-gray-400">
                                                                +{resource.tags.split(';').filter(t => t.trim()).length - 2}
                                                            </span>
                                                        )}
                                                    </div>
                                                )}
                                            </div>
                                            <span className={`w-2 h-2 rounded-full ${
                                                resource.status === 'running' ? 'bg-green-500' : 'bg-red-500'
                                            }`} />
                                        </div>
                                    ))}
                                </div>
                            </div>

                            {/* Detail Panel */}
                            <div className="lg:col-span-2">
                                {selectedDetailVm ? (
                                    <VmDetailPanel
                                        vm={selectedDetailVm}
                                        clusterId={clusterId}
                                        onAction={handleAction}
                                        onOpenConsole={onOpenConsole}
                                        onOpenConfig={onOpenConfig}
                                        onMigrate={() => setShowMigrateModal(selectedDetailVm)}
                                        onClone={() => setShowCloneModal(selectedDetailVm)}
                                        onForceStop={onForceStop}
                                        onDelete={() => setShowDeleteConfirm(selectedDetailVm)}
                                        onCrossClusterMigrate={(vm) => setShowCrossClusterMigrate(vm)}
                                        showCrossCluster={clusters && clusters.length > 1}
                                        actionLoading={actionLoading}
                                        onShowMetrics={(vm) => setShowMetricsModal(vm)}
                                        addToast={addToast}
                                    />
                                ) : (
                                    <div className="h-full flex items-center justify-center bg-proxmox-card border border-proxmox-border rounded-xl p-12">
                                        <div className="text-center text-gray-500">
                                            <Icons.Eye />
                                            <p className="mt-2">W√§hle eine VM aus der Liste</p>
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>
                    )}

                    {/* Pagination Controls - MK Jan 2026 */}
                    <div className="flex flex-wrap items-center justify-between gap-4 text-sm text-gray-400 py-2">
                        <div className="flex items-center gap-4">
                            <span>
                                {t('showing')} {((currentPage - 1) * itemsPerPage) + 1}-{Math.min(currentPage * itemsPerPage, filteredResources.length)} {t('of')} {filteredResources.length} {t('resources')}
                                {filteredResources.length !== resources.length && ` (${resources.length} ${t('total')})`}
                            </span>
                            <div className="flex items-center gap-2">
                                <span className="text-gray-500">{t('perPage')}:</span>
                                <select
                                    value={itemsPerPage}
                                    onChange={(e) => setItemsPerPage(Number(e.target.value))}
                                    className="bg-proxmox-dark border border-proxmox-border rounded px-2 py-1 text-sm"
                                >
                                    <option value={50}>50</option>
                                    <option value={100}>100</option>
                                    <option value={200}>200</option>
                                    <option value={500}>500</option>
                                </select>
                            </div>
                        </div>
                        
                        {totalPages > 1 && (
                            <div className="flex items-center gap-1">
                                <button
                                    onClick={() => setCurrentPage(1)}
                                    disabled={currentPage === 1}
                                    className="px-2 py-1 rounded bg-proxmox-dark border border-proxmox-border disabled:opacity-30 hover:bg-proxmox-hover disabled:hover:bg-proxmox-dark"
                                    title="First page"
                                >
                                    ¬´¬´
                                </button>
                                <button
                                    onClick={() => setCurrentPage(p => Math.max(1, p - 1))}
                                    disabled={currentPage === 1}
                                    className="px-2 py-1 rounded bg-proxmox-dark border border-proxmox-border disabled:opacity-30 hover:bg-proxmox-hover disabled:hover:bg-proxmox-dark"
                                >
                                    ¬´
                                </button>
                                
                                {/* Page numbers */}
                                {Array.from({ length: Math.min(5, totalPages) }, (_, i) => {
                                    let pageNum;
                                    if (totalPages <= 5) {
                                        pageNum = i + 1;
                                    } else if (currentPage <= 3) {
                                        pageNum = i + 1;
                                    } else if (currentPage >= totalPages - 2) {
                                        pageNum = totalPages - 4 + i;
                                    } else {
                                        pageNum = currentPage - 2 + i;
                                    }
                                    return (
                                        <button
                                            key={pageNum}
                                            onClick={() => setCurrentPage(pageNum)}
                                            className={`px-3 py-1 rounded border ${
                                                currentPage === pageNum
                                                    ? 'bg-proxmox-orange text-white border-proxmox-orange'
                                                    : 'bg-proxmox-dark border-proxmox-border hover:bg-proxmox-hover'
                                            }`}
                                        >
                                            {pageNum}
                                        </button>
                                    );
                                })}
                                
                                <button
                                    onClick={() => setCurrentPage(p => Math.min(totalPages, p + 1))}
                                    disabled={currentPage === totalPages}
                                    className="px-2 py-1 rounded bg-proxmox-dark border border-proxmox-border disabled:opacity-30 hover:bg-proxmox-hover disabled:hover:bg-proxmox-dark"
                                >
                                    ¬ª
                                </button>
                                <button
                                    onClick={() => setCurrentPage(totalPages)}
                                    disabled={currentPage === totalPages}
                                    className="px-2 py-1 rounded bg-proxmox-dark border border-proxmox-border disabled:opacity-30 hover:bg-proxmox-hover disabled:hover:bg-proxmox-dark"
                                    title="Last page"
                                >
                                    ¬ª¬ª
                                </button>
                            </div>
                        )}
                        
                        <span className="text-gray-500">{Object.keys(groupedByNode).length} Nodes</span>
                    </div>

                    {/* Delete Confirmation Modal */}
                    {showDeleteConfirm && (
                        <DeleteVmModal
                            vm={showDeleteConfirm}
                            clusterId={clusterId}
                            onDelete={onDelete}
                            onClose={() => setShowDeleteConfirm(null)}
                        />
                    )}

                    {/* Clone VM Modal */}
                    {showCloneModal && (
                        <CloneVmModal
                            vm={showCloneModal}
                            nodes={nodes}
                            clusterId={clusterId}
                            onClone={onClone}
                            onClose={() => setShowCloneModal(null)}
                        />
                    )}

                    {/* Single VM Migrate Modal */}
                    {showMigrateModal && (
                        <MigrateModal
                            vm={showMigrateModal}
                            nodes={nodes}
                            clusterId={clusterId}
                            onMigrate={onMigrate}
                            onClose={() => setShowMigrateModal(null)}
                        />
                    )}

                    {/* Bulk Migrate Modal */}
                    {showBulkMigrate && (
                        <BulkMigrateModal
                            vms={selectedVms}
                            nodes={nodes}
                            clusterId={clusterId}
                            onMigrate={onBulkMigrate}
                            onClose={() => {
                                setShowBulkMigrate(false);
                                setSelectedVms([]);
                            }}
                        />
                    )}

                    {/* Cross-Cluster Migrate Modal */}
                    {showCrossClusterMigrate && clusters && clusters.length > 1 && (
                        <CrossClusterMigrateModal
                            vm={showCrossClusterMigrate}
                            sourceCluster={sourceCluster}
                            clusters={clusters}
                            onMigrate={onCrossClusterMigrate}
                            onClose={() => setShowCrossClusterMigrate(null)}
                        />
                    )}

                    {/* VM Metrics Modal */}
                    {showMetricsModal && (
                        <VmMetricsModal
                            vm={showMetricsModal}
                            clusterId={clusterId}
                            onClose={() => setShowMetricsModal(null)}
                        />
                    )}
                </div>
            );
        }

        // Delete VM Modal Component
        // NS: Added confirmation input after someone accidentally deleted prod VM
        // Better safe than sorry...
        function DeleteVmModal({ vm, clusterId, onDelete, onClose }) {
            const { t } = useTranslation();
            const [confirmName, setConfirmName] = useState('');
            const [purge, setPurge] = useState(false);
            const [destroyUnreferenced, setDestroyUnreferenced] = useState(false);
            const [loading, setLoading] = useState(false);

            const isQemu = vm.type === 'qemu';
            const displayName = vm.name || `${isQemu ? 'VM' : 'CT'} ${vm.vmid}`;
            const canDelete = confirmName === vm.vmid.toString();

            const handleDelete = async () => {
                if (!canDelete) return;
                setLoading(true);
                await onDelete(vm, { purge, destroyUnreferenced });
                setLoading(false);
                onClose();
            };

            return(
                <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/80">
                    <div className="w-full max-w-md bg-proxmox-card border border-red-500/30 rounded-xl overflow-hidden animate-scale-in">
                        <div className="p-6 border-b border-red-500/30 bg-red-500/10">
                            <div className="flex items-center gap-3">
                                <div className="p-3 rounded-full bg-red-500/20">
                                    <Icons.Trash />
                                </div>
                                <div>
                                    <h3 className="text-lg font-semibold text-white">
                                        {isQemu ? 'VM' : 'Container'} {t('delete')}
                                    </h3>
                                    <p className="text-sm text-red-400">{t('deleteCannotBeUndone')}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div className="p-6 space-y-4">
                            <div className="p-4 bg-proxmox-dark rounded-lg border border-proxmox-border">
                                <div className="flex items-center gap-3">
                                    <div className={`p-2 rounded-lg ${isQemu ? 'bg-blue-500/10' : 'bg-purple-500/10'}`}>
                                        {isQemu ? <Icons.VM /> : <Icons.Container />}
                                    </div>
                                    <div>
                                        <div className="font-medium text-white">{displayName}</div>
                                        <div className="text-xs text-gray-500">ID: {vm.vmid} ¬∑ Node: {vm.node}</div>
                                    </div>
                                    <span className={`ml-auto px-2 py-1 rounded text-xs ${
                                        vm.status === 'running' 
                                            ? 'bg-green-500/10 text-green-400' 
                                            : 'bg-red-500/10 text-red-400'
                                    }`}>
                                        {vm.status}
                                    </span>
                                </div>
                            </div>

                            {vm.status === 'running' && (
                                <div className="p-3 bg-yellow-500/10 border border-yellow-500/30 rounded-lg text-sm text-yellow-400">
                                    ‚ö†Ô∏è {isQemu ? t('vmStillRunning') : t('ctStillRunning')}
                                </div>
                            )}

                            <div className="space-y-3">
                                <label className="flex items-center gap-2 text-sm text-gray-300">
                                    <input
                                        type="checkbox"
                                        checked={purge}
                                        onChange={(e) => setPurge(e.target.checked)}
                                        className="rounded"
                                    />
                                    {t('purgeDisks')}
                                </label>
                                {isQemu && (
                                    <label className="flex items-center gap-2 text-sm text-gray-300">
                                        <input
                                            type="checkbox"
                                            checked={destroyUnreferenced}
                                            onChange={(e) => setDestroyUnreferenced(e.target.checked)}
                                            className="rounded"
                                        />
                                        {t('destroyUnreferencedDisks')}
                                    </label>
                                )}
                            </div>

                            <div>
                                <label className="block text-sm text-gray-400 mb-2">
                                    {t('enterToConfirm')} <span className="font-mono text-red-400">{vm.vmid}</span>:
                                </label>
                                <input
                                    type="text"
                                    value={confirmName}
                                    onChange={(e) => setConfirmName(e.target.value)}
                                    placeholder={vm.vmid.toString()}
                                    className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white focus:border-red-500"
                                    autoFocus
                                />
                            </div>
                        </div>

                        <div className="flex items-center justify-end gap-3 p-4 border-t border-proxmox-border bg-proxmox-dark">
                            <button onClick={onClose} className="px-4 py-2 text-gray-300 hover:text-white">
                                {t('cancel')}
                            </button>
                            <button
                                onClick={handleDelete}
                                disabled={loading || !canDelete}
                                className="flex items-center gap-2 px-4 py-2 bg-red-600 rounded-lg text-white hover:bg-red-700 disabled:opacity-50 disabled:cursor-not-allowed"
                            >
                                {loading && <Icons.RotateCw />}
                                <Icons.Trash />
                                {t('deletePermanently')}
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        // Clone VM Modal
        // LW: Supports both linked clones and full clones
        // Full clone takes longer but is independent from source
        function CloneVmModal({ vm, nodes, clusterId, onClone, onClose }) {
            const { t } = useTranslation();
            const { getAuthHeaders } = useAuth();
            
            // NS: same pattern as everywhere else, maybe extract to hook someday
            async function authFetch(url, opts) {
                try { return await fetch(url, { ...opts, headers: { ...opts?.headers, ...getAuthHeaders() } }) }
                catch(e) { console.error(e); return null }
            }
            
            const [cloneConfig, setCloneConfig] = useState({
                name: `${vm.name || vm.vmid}-clone`,
                newid: '',
                full: true,  // default to full clone
                target_node: vm.node,
                description: '',
            });
            const [loading, setLoading] = useState(false);
            const [loadingVmid, setLoadingVmid] = useState(true);

            const isQemu = vm.type === 'qemu';

            // Get next available VMID on mount
            useEffect(() => {
                (async () => {
                    try {
                        const r = await authFetch(`${API_URL}/clusters/${clusterId}/nextid`);
                        if (r?.ok) {
                            const d = await r.json();
                            setCloneConfig(prev => ({ ...prev, newid: d.vmid.toString() }));
                        }
                    } catch (err) {
                        console.error('to get next VMID:', err);
                    }
                    setLoadingVmid(false);
                })();
            }, [clusterId]);

            const handleClone = async () => {
                if (!cloneConfig.newid) return;
                setLoading(true);
                await onClone(vm, cloneConfig);
                setLoading(false);
            };

            return(
                <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/80">
                    <div className="w-full max-w-lg bg-proxmox-card border border-blue-500/30 rounded-xl overflow-hidden animate-scale-in">
                        <div className="p-6 border-b border-blue-500/30 bg-blue-500/10">
                            <div className="flex items-center gap-3">
                                <div className="p-3 rounded-full bg-blue-500/20">
                                    <Icons.Copy />
                                </div>
                                <div>
                                    <h3 className="text-lg font-semibold text-white">
                                        {isQemu ? 'VM' : 'Container'} {t('clone')}
                                    </h3>
                                    <p className="text-sm text-blue-400">
                                        {vm.name || vm.vmid} {t('willBeCloned')}
                                    </p>
                                </div>
                            </div>
                        </div>
                        
                        <div className="p-6 space-y-4">
                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-xs text-gray-400 mb-1">{t('newVmId')}</label>
                                    <input
                                        type="number"
                                        value={cloneConfig.newid}
                                        onChange={(e) => setCloneConfig({...cloneConfig, newid: e.target.value})}
                                        className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white text-sm"
                                        placeholder={loadingVmid ? t('loading') : 'VMID'}
                                        disabled={loadingVmid}
                                    />
                                </div>
                                <div>
                                    <label className="block text-xs text-gray-400 mb-1">{t('name')}</label>
                                    <input
                                        type="text"
                                        value={cloneConfig.name}
                                        onChange={(e) => setCloneConfig({...cloneConfig, name: e.target.value})}
                                        className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white text-sm"
                                        placeholder="clone-name"
                                    />
                                </div>
                            </div>

                            <div>
                                <label className="block text-xs text-gray-400 mb-1">{t('targetNode')}</label>
                                <select
                                    value={cloneConfig.target_node}
                                    onChange={(e) => setCloneConfig({...cloneConfig, target_node: e.target.value})}
                                    className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white text-sm"
                                >
                                    {(nodes || []).map(node => {
                                        const nodeName = typeof node === 'string' ? node : node.name;
                                        const isSameNode = nodeName === vm.node;
                                        return(
                                            <option key={nodeName} value={nodeName}>
                                                {nodeName} {isSameNode ? `(${t('sameNode')})` : ''}
                                            </option>
                                        );
                                    })}
                                </select>
                                {cloneConfig.target_node !== vm.node && (
                                    <p className="text-xs text-yellow-400 mt-1">
                                        ‚ö†Ô∏è {t('crossNodeCloneWarning')}
                                    </p>
                                )}
                            </div>

                            <div>
                                <label className="block text-xs text-gray-400 mb-2">{t('cloneMode')}</label>
                                <div className="grid grid-cols-2 gap-3">
                                    <button
                                        onClick={() => setCloneConfig({...cloneConfig, full: true})}
                                        className={`p-3 rounded-lg border text-left transition-all ${
                                            cloneConfig.full
                                                ? 'border-blue-500 bg-blue-500/10'
                                                : 'border-proxmox-border hover:border-gray-600'
                                        }`}
                                    >
                                        <div className="font-medium text-white text-sm">{t('fullClone')}</div>
                                        <div className="text-xs text-gray-500 mt-1">{t('fullCloneDesc')}</div>
                                    </button>
                                    <button
                                        onClick={() => setCloneConfig({...cloneConfig, full: false})}
                                        disabled={!isQemu}
                                        className={`p-3 rounded-lg border text-left transition-all ${
                                            !cloneConfig.full
                                                ? 'border-blue-500 bg-blue-500/10'
                                                : 'border-proxmox-border hover:border-gray-600'
                                        } ${!isQemu ? 'opacity-50 cursor-not-allowed' : ''}`}
                                    >
                                        <div className="font-medium text-white text-sm">{t('linkedClone')}</div>
                                        <div className="text-xs text-gray-500 mt-1">
                                            {isQemu ? t('linkedCloneDesc') : t('onlyForVms')}
                                        </div>
                                    </button>
                                </div>
                            </div>

                            <div>
                                <label className="block text-xs text-gray-400 mb-1">{t('description')} ({t('optional')})</label>
                                <textarea
                                    value={cloneConfig.description}
                                    onChange={(e) => setCloneConfig({...cloneConfig, description: e.target.value})}
                                    className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white text-sm resize-none"
                                    rows="2"
                                    placeholder={t('cloneNotes')}
                                />
                            </div>
                        </div>

                        <div className="flex items-center justify-end gap-3 p-4 border-t border-proxmox-border bg-proxmox-dark">
                            <button onClick={onClose} className="px-4 py-2 text-gray-300 hover:text-white">
                                {t('cancel')}
                            </button>
                            <button
                                onClick={handleClone}
                                disabled={loading || !cloneConfig.newid}
                                className="flex items-center gap-2 px-4 py-2 bg-blue-600 rounded-lg text-white hover:bg-blue-700 disabled:opacity-50"
                            >
                                {loading && <Icons.RotateCw />}
                                <Icons.Copy />
                                {t('startClone')}
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        // VM Detail Modal Component
        function VmDetailModal({ vm, clusterId, onAction, onOpenConsole, onOpenConfig, onMigrate, onClone, onForceStop, onDelete, onClose }) {
            const [loading, setLoading] = useState({});
            const isQemu = vm.type === 'qemu';
            const displayName = vm.name || `${isQemu ? 'VM' : 'CT'} ${vm.vmid}`;

            // copypaste from somewhere else lol
            function formatBytes(bytes) {
                if (!bytes) return '0 B';
                const k = 1024;
                const s = ['B', 'KB', 'MB', 'GB', 'TB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return(bytes / Math.pow(k, i)).toFixed(1) + ' ' + s[i];
            }

            const handleAction = async (action) => {
                setLoading(prev => ({...prev, [action]: true}));
                await onAction(vm, action);
                setLoading(prev => ({...prev, [action]: false}));
            };

            // TODO: this is also duplicated somewhere
            const formatUptime = (uptime) => {
                if (!uptime) return '-';
                const d = Math.floor(uptime / 86400);
                const h = Math.floor((uptime % 86400) / 3600);
                const m = Math.floor((uptime % 3600) / 60);
                if (d > 0) return `${d}d ${h}h ${m}m`;
                if (h > 0) return `${h}h ${m}m`;
                return `${m}m`;
            };

            return(
                <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/80" onClick={onClose}>
                    <div 
                        className="w-full max-w-2xl bg-proxmox-card border border-proxmox-border rounded-xl overflow-hidden animate-scale-in"
                        onClick={e => e.stopPropagation()}
                    >
                        {/* Header */}
                        <div className="p-6 border-b border-proxmox-border bg-gradient-to-r from-proxmox-dark to-proxmox-card">
                            <div className="flex items-center justify-between">
                                <div className="flex items-center gap-4">
                                    <div className={`p-3 rounded-xl ${isQemu ? 'bg-blue-500/20' : 'bg-purple-500/20'}`}>
                                        {isQemu ? <Icons.VM /> : <Icons.Container />}
                                    </div>
                                    <div>
                                        <h2 className="text-xl font-bold text-white">{displayName}</h2>
                                        <div className="flex items-center gap-3 text-sm text-gray-400">
                                            <span>ID: {vm.vmid}</span>
                                            <span>‚Ä¢</span>
                                            <span>{isQemu ? 'QEMU VM' : 'LXC Container'}</span>
                                            <span>‚Ä¢</span>
                                            <span>{vm.node}</span>
                                        </div>
                                    </div>
                                </div>
                                <div className="flex items-center gap-3">
                                    <span className={`px-3 py-1.5 rounded-full text-sm font-medium ${
                                        vm.status === 'running' 
                                            ? 'bg-green-500/20 text-green-400' 
                                            : 'bg-red-500/20 text-red-400'
                                    }`}>
                                        {vm.status === 'running' ? '‚óè L√§uft' : '‚óã Gestoppt'}
                                    </span>
                                    <button onClick={onClose} className="p-2 hover:bg-proxmox-dark rounded-lg text-gray-400 hover:text-white">
                                        <Icons.X />
                                    </button>
                                </div>
                            </div>
                        </div>

                        {/* Stats Grid */}
                        <div className="p-6 grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div className="bg-proxmox-dark rounded-lg p-4">
                                <div className="text-xs text-gray-500 mb-1">CPU</div>
                                <div className="text-lg font-bold text-white">{(vm.cpu_percent || 0).toFixed(1)}%</div>
                                <div className="text-xs text-gray-500">{vm.maxcpu || 1} Cores</div>
                                <div className="mt-2 h-1.5 rounded-full bg-proxmox-border overflow-hidden">
                                    <div 
                                        className="h-full rounded-full transition-all"
                                        style={{
                                            width: `${Math.min(vm.cpu_percent || 0, 100)}%`,
                                            background: (vm.cpu_percent || 0) < 50 ? '#3b82f6' : (vm.cpu_percent || 0) < 80 ? '#eab308' : '#ef4444'
                                        }}
                                    />
                                </div>
                            </div>
                            <div className="bg-proxmox-dark rounded-lg p-4">
                                <div className="text-xs text-gray-500 mb-1">RAM</div>
                                <div className="text-lg font-bold text-white">{(vm.mem_percent || 0).toFixed(1)}%</div>
                                <div className="text-xs text-gray-500">{formatBytes(vm.mem)} / {formatBytes(vm.maxmem)}</div>
                                <div className="mt-2 h-1.5 rounded-full bg-proxmox-border overflow-hidden">
                                    <div 
                                        className="h-full rounded-full transition-all"
                                        style={{
                                            width: `${vm.mem_percent || 0}%`,
                                            background: (vm.mem_percent || 0) < 50 ? '#22c55e' : (vm.mem_percent || 0) < 80 ? '#eab308' : '#ef4444'
                                        }}
                                    />
                                </div>
                            </div>
                            <div className="bg-proxmox-dark rounded-lg p-4">
                                <div className="text-xs text-gray-500 mb-1">Disk</div>
                                <div className="text-lg font-bold text-white">{formatBytes(vm.disk || 0)}</div>
                                <div className="text-xs text-gray-500">von {formatBytes(vm.maxdisk || 0)}</div>
                            </div>
                            <div className="bg-proxmox-dark rounded-lg p-4">
                                <div className="text-xs text-gray-500 mb-1">Uptime</div>
                                <div className="text-lg font-bold text-white">{formatUptime(vm.uptime)}</div>
                                <div className="text-xs text-gray-500">{vm.status === 'running' ? t('sinceStart') : t('offline')}</div>
                            </div>
                        </div>

                        {/* Quick Actions */}
                        <div className="px-6 pb-6">
                            <div className="text-xs text-gray-500 mb-3">{t('quickActions')}</div>
                            <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                                {vm.status === 'stopped' ? (
                                    <button
                                        onClick={() => handleAction('start')}
                                        disabled={loading.start}
                                        className="flex items-center justify-center gap-2 p-3 bg-green-500/10 hover:bg-green-500/20 border border-green-500/30 rounded-lg text-green-400 transition-all disabled:opacity-50"
                                    >
                                        {loading.start ? <Icons.RotateCw /> : <Icons.PlayCircle />}
                                        Starten
                                    </button>
                                ) : (
                                    <>
                                        <button
                                            onClick={() => handleAction('shutdown')}
                                            disabled={loading.shutdown}
                                            className="flex items-center justify-center gap-2 p-3 bg-yellow-500/10 hover:bg-yellow-500/20 border border-yellow-500/30 rounded-lg text-yellow-400 transition-all disabled:opacity-50"
                                        >
                                            {loading.shutdown ? <Icons.RotateCw /> : <Icons.Power />}
                                            Shutdown
                                        </button>
                                        <button
                                            onClick={() => handleAction('reboot')}
                                            disabled={loading.reboot}
                                            className="flex items-center justify-center gap-2 p-3 bg-orange-500/10 hover:bg-orange-500/20 border border-orange-500/30 rounded-lg text-orange-400 transition-all disabled:opacity-50"
                                        >
                                            {loading.reboot ? <Icons.RotateCw /> : <Icons.RefreshCw />}
                                            Reboot
                                        </button>
                                    </>
                                )}
                                <button
                                    onClick={() => { onClose(); onOpenConsole(vm); }}
                                    className="flex items-center justify-center gap-2 p-3 bg-blue-500/10 hover:bg-blue-500/20 border border-blue-500/30 rounded-lg text-blue-400 transition-all"
                                >
                                    <Icons.Monitor />
                                    Konsole
                                </button>
                                <button
                                    onClick={() => { onClose(); onOpenConfig(vm); }}
                                    className="flex items-center justify-center gap-2 p-3 bg-proxmox-dark hover:bg-proxmox-border border border-proxmox-border rounded-lg text-gray-300 transition-all"
                                >
                                    <Icons.Cog />
                                    Konfiguration
                                </button>
                            </div>
                        </div>

                        {/* More Actions */}
                        <div className="px-6 pb-6">
                            <div className="text-xs text-gray-500 mb-3">{t('moreActions')}</div>
                            <div className="flex flex-wrap gap-2">
                                <button
                                    onClick={() => { onClose(); onMigrate(vm); }}
                                    className="flex items-center gap-2 px-3 py-2 bg-proxmox-dark hover:bg-proxmox-border border border-proxmox-border rounded-lg text-sm text-gray-300 transition-all"
                                >
                                    <Icons.ArrowRight />
                                    Migrieren
                                </button>
                                <button
                                    onClick={() => { onClose(); onClone(vm); }}
                                    className="flex items-center gap-2 px-3 py-2 bg-proxmox-dark hover:bg-proxmox-border border border-proxmox-border rounded-lg text-sm text-gray-300 transition-all"
                                >
                                    <Icons.Copy />
                                    Klonen
                                </button>
                                {vm.status === 'running' && (
                                    <>
                                        {/* Force Reset - QEMU only */}
                                        {isQemu && (
                                            <button
                                                onClick={() => onAction(vm, 'reset')}
                                                className="flex items-center gap-2 px-3 py-2 bg-orange-500/10 hover:bg-orange-500/20 border border-orange-500/30 rounded-lg text-sm text-orange-400 transition-all"
                                            >
                                                <Icons.Zap />
                                                {t('forceReset')}
                                            </button>
                                        )}
                                        <button
                                            onClick={() => onForceStop(vm)}
                                            className="flex items-center gap-2 px-3 py-2 bg-red-500/10 hover:bg-red-500/20 border border-red-500/30 rounded-lg text-sm text-red-400 transition-all"
                                        >
                                            <Icons.XCircle />
                                            {t('forceStop')}
                                        </button>
                                    </>
                                )}
                                <button
                                    onClick={() => { onClose(); onDelete(vm); }}
                                    className="flex items-center gap-2 px-3 py-2 bg-red-500/10 hover:bg-red-500/20 border border-red-500/30 rounded-lg text-sm text-red-400 transition-all"
                                >
                                    <Icons.Trash />
                                    L√∂schen
                                </button>
                            </div>
                        </div>

                        {/* Tags */}
                        {vm.tags && (
                            <div className="px-6 pb-6">
                                <div className="text-xs text-gray-500 mb-2">Tags</div>
                                <div className="flex flex-wrap gap-2">
                                    {vm.tags.split(';').map(tag => (
                                        <span key={tag} className="px-2 py-1 bg-proxmox-dark rounded text-xs text-gray-400">
                                            {tag}
                                        </span>
                                    ))}
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        // VM Detail Panel Component (inline, not modal)
        // LW: this shows when you click a VM in detail view mode
        function VmDetailPanel({ vm, clusterId, onAction, onOpenConsole, onOpenConfig, onMigrate, onClone, onForceStop, onDelete, onCrossClusterMigrate, showCrossCluster, actionLoading, onShowMetrics, addToast }) {
            const { t } = useTranslation();
            const { getAuthHeaders } = useAuth();
            
            // some quick helpers
            const isQemu = vm.type === 'qemu';
            const displayName = vm.name || `${isQemu ? 'VM' : 'CT'} ${vm.vmid}`;
            
            const [haEnabled, setHaEnabled] = useState(false);
            const [haLoading, setHaLoading] = useState(false);
            const [haResources, setHaResources] = useState([]);
            
            // NS: Lock status for VMs
            const [lockInfo, setLockInfo] = useState({ locked: false, lock_reason: null, lock_description: null, unlock_command: null });
            const [unlockLoading, setUnlockLoading] = useState(false);
            const [showUnlockConfirm, setShowUnlockConfirm] = useState(false);

            // LW: inline arrow fn, less boilerplate
            const authFetch = async (url, opts = {}) => {
                try { return await fetch(url, { ...opts, credentials: 'include', headers: { ...opts.headers, ...getAuthHeaders() } }); }
                catch(e) { console.error(e); return null; }
            };

            // LW: these could be extracted to utils but w/e
            const formatBytes = b => {
                if(!b) return '0 B';
                const k = 1024, sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
                const i = Math.floor(Math.log(b) / Math.log(k));
                return `${(b / Math.pow(k, i)).toFixed(1)} ${sizes[i]}`;
            };

            const formatUptime = (uptime) => {
                if(!uptime) return '-';
                const days = Math.floor(uptime / 86400);
                const hours = Math.floor((uptime % 86400) / 3600);
                const mins = Math.floor((uptime % 3600) / 60);
                if(days > 0) return `${days}d ${hours}h ${mins}m`;
                if(hours > 0) return `${hours}h ${mins}m`;
                return `${mins}m`;
            };

            const handleAction = async (action) => {
                await onAction(vm, action);
            };
            
            // NS: Fetch lock status
            const fetchLockStatus = async () => {
                try {
                    const response = await authFetch(`${API_URL}/clusters/${clusterId}/vms/${vm.node}/${vm.type}/${vm.vmid}/lock`);
                    if (response && response.ok) {
                        const data = await response.json();
                        // NS: Ensure we have valid data structure
                        setLockInfo({
                            locked: data.locked || false,
                            lock_reason: data.lock_reason || null,
                            lock_description: data.lock_description || null,
                            unlock_command: data.unlock_command || null
                        });
                    } else {
                        // API error - assume not locked
                        setLockInfo({ locked: false, lock_reason: null, lock_description: null, unlock_command: null });
                    }
                } catch (error) {
                    console.error('Error fetching lock status:', error);
                    // On error, assume not locked
                    setLockInfo({ locked: false, lock_reason: null, lock_description: null, unlock_command: null });
                }
            };
            
            // NS: Unlock VM
            const handleUnlock = async () => {
                setUnlockLoading(true);
                try {
                    const response = await authFetch(`${API_URL}/clusters/${clusterId}/vms/${vm.node}/${vm.type}/${vm.vmid}/unlock`, {
                        method: 'POST'
                    });
                    if (response && response.ok) {
                        const data = await response.json();
                        if (addToast) addToast(t('vmUnlocked') || `VM ${vm.vmid} unlocked successfully`, 'success');
                        setLockInfo({ locked: false, lock_reason: null, lock_description: null, unlock_command: null });
                        setShowUnlockConfirm(false);
                    } else {
                        const err = await response.json();
                        if (addToast) addToast(err.error || 'Unlock failed', 'error');
                    }
                } catch (error) {
                    if (addToast) addToast('Unlock failed', 'error');
                }
                setUnlockLoading(false);
            };
            
            // Fetch lock status on mount
            useEffect(() => {
                fetchLockStatus();
            }, [vm.vmid, clusterId]);

            // Check HA status for this VM
            useEffect(() => {
                const checkHaStatus = async () => {
                    try {
                        const response = await authFetch(`${API_URL}/clusters/${clusterId}/proxmox-ha/resources`);
                        if(response && response.ok) {
                            const resources = await response.json();
                            setHaResources(resources);
                            const vmType = isQemu ? 'vm' : 'ct';
                            const isInHa = resources.some(r => r.sid === `${vmType}:${vm.vmid}`);
                            setHaEnabled(isInHa);
                        }
                    } catch (error) {
                        console.error('checking HA status:', error);
                    }
                };
                checkHaStatus();
            }, [vm.vmid, clusterId]);

            const toggleProxmoxHa = async () => {
                setHaLoading(true);
                try {
                    const vmType = isQemu ? 'vm' : 'ct';
                    if(haEnabled) {
                        // Remove from HA
                        const response = await authFetch(`${API_URL}/clusters/${clusterId}/proxmox-ha/resources/${vmType}:${vm.vmid}`, {
                            method: 'DELETE'
                        });
                        if(response && response.ok) {
                            setHaEnabled(false);
                        }
                    }else{
                        // Add to HA
                        const response = await authFetch(`${API_URL}/clusters/${clusterId}/proxmox-ha/resources`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                vmid: vm.vmid,
                                type: vmType,
                                max_restart: 3,
                                max_relocate: 3
                            })
                        });
                        if(response && response.ok) {
                            setHaEnabled(true);
                        }
                    }
                } catch (error) {
                    console.error('toggling HA:', error);
                } finally {
                    setHaLoading(false);
                }
            };

            return (
                <div className="bg-proxmox-card border border-proxmox-border rounded-xl overflow-hidden">
                    {/* Header */}
                    <div className="p-6 border-b border-proxmox-border bg-gradient-to-r from-proxmox-dark to-proxmox-card">
                        <div className="flex items-center justify-between">
                            <div className="flex items-center gap-4">
                                <div className={`p-3 rounded-xl ${isQemu ? 'bg-blue-500/20' : 'bg-purple-500/20'}`}>
                                    {isQemu ? <Icons.VM /> : <Icons.Container />}
                                </div>
                                <div>
                                    <h2 className="text-xl font-bold text-white">{displayName}</h2>
                                    <div className="flex items-center gap-3 text-sm text-gray-400">
                                        <span>ID: {vm.vmid}</span>
                                        <span>‚Ä¢</span>
                                        <span>{isQemu ? 'QEMU VM' : 'LXC Container'}</span>
                                        <span>‚Ä¢</span>
                                        <span>{vm.node}</span>
                                    </div>
                                </div>
                            </div>
                            <div className="flex items-center gap-2">
                                {/* MK: Lock indicator */}
                                {lockInfo?.locked && (
                                    <span 
                                        className="px-2 py-1 rounded-full text-xs font-medium bg-red-500/20 text-red-400 border border-red-500/30 flex items-center gap-1 cursor-pointer hover:bg-red-500/30 transition-colors"
                                        onClick={() => setShowUnlockConfirm(true)}
                                        title={lockInfo?.lock_description || 'Locked'}
                                    >
                                        <Icons.Lock />
                                        {lockInfo?.lock_reason || 'Locked'}
                                    </span>
                                )}
                                {haEnabled && (
                                    <span className="px-2 py-1 rounded-full text-xs font-medium bg-cyan-500/20 text-cyan-400 border border-cyan-500/30 flex items-center gap-1">
                                        <Icons.Shield />
                                        HA
                                    </span>
                                )}
                                <span className={`px-3 py-1.5 rounded-full text-sm font-medium ${
                                    vm.status === 'running' 
                                        ? 'bg-green-500/20 text-green-400' 
                                        : 'bg-red-500/20 text-red-400'
                                }`}>
                                    {vm.status === 'running' ? '‚óè ' + t('running') : '‚óã ' + t('stopped')}
                                </span>
                            </div>
                        </div>
                    </div>
                    
                    {/* MK: Unlock Confirmation Modal */}
                    {showUnlockConfirm && lockInfo?.locked && (
                        <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50" onClick={() => setShowUnlockConfirm(false)}>
                            <div className="bg-proxmox-card border border-proxmox-border rounded-xl p-6 max-w-md w-full mx-4" onClick={e => e.stopPropagation()}>
                                <div className="flex items-center gap-3 mb-4">
                                    <div className="p-2 rounded-lg bg-red-500/20">
                                        <Icons.AlertTriangle className="text-red-400" />
                                    </div>
                                    <h3 className="text-lg font-bold text-white">{t('unlockVm') || 'Unlock VM'}</h3>
                                </div>
                                
                                <div className="space-y-4">
                                    <div className="bg-proxmox-dark rounded-lg p-4">
                                        <div className="text-sm text-gray-400 mb-2">{t('lockReason') || 'Lock Reason'}:</div>
                                        <div className="text-white font-medium">{lockInfo?.lock_description || 'Unknown'}</div>
                                        <div className="text-xs text-gray-500 mt-1">({lockInfo?.lock_reason || 'unknown'})</div>
                                    </div>
                                    
                                    <div className="bg-yellow-500/10 border border-yellow-500/30 rounded-lg p-4">
                                        <div className="flex items-start gap-2">
                                            <Icons.AlertTriangle className="text-yellow-400 mt-0.5 flex-shrink-0" />
                                            <div className="text-sm text-yellow-300">
                                                {t('unlockWarning') || 'Warning: Unlocking a VM during an active operation may cause data corruption or other issues. Only proceed if you are sure the operation has failed or been cancelled.'}
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div className="bg-proxmox-dark rounded-lg p-3">
                                        <div className="text-xs text-gray-500 mb-1">CLI {t('command') || 'Command'}:</div>
                                        <code className="text-sm text-green-400 font-mono">{lockInfo?.unlock_command || `qm unlock ${vm.vmid}`}</code>
                                    </div>
                                </div>
                                
                                <div className="flex gap-3 mt-6">
                                    <button
                                        onClick={() => setShowUnlockConfirm(false)}
                                        className="flex-1 px-4 py-2 bg-proxmox-dark text-gray-300 rounded-lg hover:bg-proxmox-hover transition-colors"
                                    >
                                        {t('cancel')}
                                    </button>
                                    <button
                                        onClick={handleUnlock}
                                        disabled={unlockLoading}
                                        className="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors disabled:opacity-50 flex items-center justify-center gap-2"
                                    >
                                        {unlockLoading ? <Icons.RotateCw className="animate-spin" /> : <Icons.Unlock />}
                                        {t('unlock') || 'Unlock'}
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Stats Grid */}
                    <div className="p-6 grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div className="bg-proxmox-dark rounded-lg p-4">
                            <div className="text-xs text-gray-500 mb-1">CPU</div>
                            <div className="text-lg font-bold text-white">{(vm.cpu_percent || 0).toFixed(1)}%</div>
                            <div className="text-xs text-gray-500">{vm.maxcpu || 1} {t('cores')}</div>
                            <div className="mt-2 h-1.5 rounded-full bg-proxmox-border overflow-hidden">
                                <div 
                                    className="h-full rounded-full transition-all"
                                    style={{
                                        width: `${Math.min(vm.cpu_percent || 0, 100)}%`,
                                        background: (vm.cpu_percent || 0) < 50 ? '#3b82f6' : (vm.cpu_percent || 0) < 80 ? '#eab308' : '#ef4444'
                                    }}
                                />
                            </div>
                        </div>
                        <div className="bg-proxmox-dark rounded-lg p-4">
                            <div className="text-xs text-gray-500 mb-1">RAM</div>
                            <div className="text-lg font-bold text-white">{(vm.mem_percent || 0).toFixed(1)}%</div>
                            <div className="text-xs text-gray-500">{formatBytes(vm.mem)} / {formatBytes(vm.maxmem)}</div>
                            <div className="mt-2 h-1.5 rounded-full bg-proxmox-border overflow-hidden">
                                <div 
                                    className="h-full rounded-full transition-all"
                                    style={{
                                        width: `${vm.mem_percent || 0}%`,
                                        background: (vm.mem_percent || 0) < 50 ? '#22c55e' : (vm.mem_percent || 0) < 80 ? '#eab308' : '#ef4444'
                                    }}
                                />
                            </div>
                        </div>
                        <div className="bg-proxmox-dark rounded-lg p-4">
                            <div className="text-xs text-gray-500 mb-1">Disk</div>
                            <div className="text-lg font-bold text-white">{formatBytes(vm.disk || 0)}</div>
                            <div className="text-xs text-gray-500">{t('of')} {formatBytes(vm.maxdisk || 0)}</div>
                        </div>
                        <div className="bg-proxmox-dark rounded-lg p-4">
                            <div className="text-xs text-gray-500 mb-1">{t('uptime')}</div>
                            <div className="text-lg font-bold text-white">{formatUptime(vm.uptime)}</div>
                            <div className="text-xs text-gray-500">{vm.status === 'running' ? t('sinceStart') : t('offline')}</div>
                        </div>
                    </div>

                    {/* Quick Actions */}
                    <div className="px-6 pb-6">
                        <div className="text-xs text-gray-500 mb-3">{t('quickActions')}</div>
                        <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                            {vm.status === 'stopped' ? (
                                <button
                                    onClick={() => handleAction('start')}
                                    disabled={actionLoading?.[`${vm.vmid}-start`]}
                                    className="flex items-center justify-center gap-2 p-3 bg-green-500/10 hover:bg-green-500/20 border border-green-500/30 rounded-lg text-green-400 transition-all disabled:opacity-50"
                                >
                                    {actionLoading?.[`${vm.vmid}-start`] ? <Icons.RotateCw /> : <Icons.PlayCircle />}
                                    {t('start')}
                                </button>
                            ) : (
                                <>
                                    <button
                                        onClick={() => handleAction('shutdown')}
                                        disabled={actionLoading?.[`${vm.vmid}-shutdown`]}
                                        className="flex items-center justify-center gap-2 p-3 bg-yellow-500/10 hover:bg-yellow-500/20 border border-yellow-500/30 rounded-lg text-yellow-400 transition-all disabled:opacity-50"
                                    >
                                        {actionLoading?.[`${vm.vmid}-shutdown`] ? <Icons.RotateCw /> : <Icons.Power />}
                                        {t('shutdown')}
                                    </button>
                                    <button
                                        onClick={() => handleAction('reboot')}
                                        disabled={actionLoading?.[`${vm.vmid}-reboot`]}
                                        className="flex items-center justify-center gap-2 p-3 bg-orange-500/10 hover:bg-orange-500/20 border border-orange-500/30 rounded-lg text-orange-400 transition-all disabled:opacity-50"
                                    >
                                        {actionLoading?.[`${vm.vmid}-reboot`] ? <Icons.RotateCw /> : <Icons.RefreshCw />}
                                        {t('reboot')}
                                    </button>
                                </>
                            )}
                            <button
                                onClick={() => onOpenConsole(vm)}
                                className="flex items-center justify-center gap-2 p-3 bg-blue-500/10 hover:bg-blue-500/20 border border-blue-500/30 rounded-lg text-blue-400 transition-all"
                            >
                                <Icons.Monitor />
                                {t('console')}
                            </button>
                            <button
                                onClick={() => onOpenConfig(vm)}
                                className="flex items-center justify-center gap-2 p-3 bg-proxmox-dark hover:bg-proxmox-border border border-proxmox-border rounded-lg text-gray-300 transition-all"
                            >
                                <Icons.Cog />
                                {t('configuration')}
                            </button>
                        </div>
                    </div>

                    {/* More Actions */}
                    <div className="px-6 pb-6">
                        <div className="text-xs text-gray-500 mb-3">{t('moreActions')}</div>
                        <div className="flex flex-wrap gap-2">
                            <button
                                onClick={() => onShowMetrics && onShowMetrics(vm)}
                                className="flex items-center gap-2 px-3 py-2 bg-indigo-500/10 hover:bg-indigo-500/20 border border-indigo-500/30 rounded-lg text-sm text-indigo-400 transition-all"
                            >
                                <Icons.BarChart />
                                {t('performanceMetrics')}
                            </button>
                            <button
                                onClick={onMigrate}
                                className="flex items-center gap-2 px-3 py-2 bg-proxmox-dark hover:bg-proxmox-border border border-proxmox-border rounded-lg text-sm text-gray-300 transition-all"
                            >
                                <Icons.ArrowRight />
                                {t('migrate')}
                            </button>
                            {showCrossCluster && (
                                <button
                                    onClick={() => onCrossClusterMigrate(vm)}
                                    className="flex items-center gap-2 px-3 py-2 bg-cyan-500/10 hover:bg-cyan-500/20 border border-cyan-500/30 rounded-lg text-sm text-cyan-400 transition-all"
                                >
                                    <Icons.Globe />
                                    {t('crossClusterMigrate')}
                                </button>
                            )}
                            <button
                                onClick={onClone}
                                className="flex items-center gap-2 px-3 py-2 bg-proxmox-dark hover:bg-proxmox-border border border-proxmox-border rounded-lg text-sm text-gray-300 transition-all"
                            >
                                <Icons.Copy />
                                {t('clone')}
                            </button>
                            {vm.status === 'running' && (
                                <>
                                    {/* Force Reset - QEMU only (LXC doesn't support it) */}
                                    {isQemu && (
                                        <button
                                            onClick={() => handleAction('reset')}
                                            disabled={actionLoading?.[`${vm.vmid}-reset`]}
                                            className="flex items-center gap-2 px-3 py-2 bg-orange-500/10 hover:bg-orange-500/20 border border-orange-500/30 rounded-lg text-sm text-orange-400 transition-all disabled:opacity-50"
                                        >
                                            {actionLoading?.[`${vm.vmid}-reset`] ? <Icons.RotateCw className="animate-spin" /> : <Icons.Zap />}
                                            {t('forceReset') || 'Force Reset'}
                                        </button>
                                    )}
                                    <button
                                        onClick={() => onForceStop(vm)}
                                        className="flex items-center gap-2 px-3 py-2 bg-red-500/10 hover:bg-red-500/20 border border-red-500/30 rounded-lg text-sm text-red-400 transition-all"
                                    >
                                        <Icons.XCircle />
                                        {t('forceStop')}
                                    </button>
                                </>
                            )}
                            <button
                                onClick={onDelete}
                                className="flex items-center gap-2 px-3 py-2 bg-red-500/10 hover:bg-red-500/20 border border-red-500/30 rounded-lg text-sm text-red-400 transition-all"
                            >
                                <Icons.Trash />
                                {t('delete')}
                            </button>
                        </div>
                    </div>

                    {/* Proxmox HA Section */}
                    <div className="px-6 pb-6">
                        <div className="text-xs text-gray-500 mb-3">{t('proxmoxHa')}</div>
                        <div className="p-4 bg-proxmox-dark rounded-lg border border-proxmox-border">
                            <div className="flex items-center justify-between">
                                <div className="flex items-center gap-3">
                                    <div className={`p-2 rounded-lg ${haEnabled ? 'bg-green-500/20' : 'bg-gray-500/20'}`}>
                                        <Icons.Shield />
                                    </div>
                                    <div>
                                        <div className="text-sm font-medium text-white">
                                            {t('proxmoxHa')} {haEnabled ? t('active') : t('haInactive').replace('Proxmox HA ', '')}
                                        </div>
                                        <div className="text-xs text-gray-500">
                                            {haEnabled 
                                                ? t('haMonitorDesc').split('.')[0] 
                                                : t('enableNativeHa')}
                                        </div>
                                    </div>
                                </div>
                                <button
                                    onClick={toggleProxmoxHa}
                                    disabled={haLoading}
                                    className={`px-4 py-2 rounded-lg text-sm font-medium transition-all disabled:opacity-50 ${
                                        haEnabled
                                            ? 'bg-red-500/20 hover:bg-red-500/30 text-red-400 border border-red-500/30'
                                            : 'bg-green-500/20 hover:bg-green-500/30 text-green-400 border border-green-500/30'
                                    }`}
                                >
                                    {haLoading ? (
                                        <Icons.RotateCw />
                                    ) : haEnabled ? (
                                        t('disable') + ' HA'
                                    ) : (
                                        t('haActivate')
                                    )}
                                </button>
                            </div>
                            {haEnabled && (
                                <div className="mt-3 pt-3 border-t border-gray-700/50 grid grid-cols-2 gap-4 text-xs">
                                    <div>
                                        <span className="text-gray-500">Max. Restarts:</span>
                                        <span className="ml-2 text-white">3</span>
                                    </div>
                                    <div>
                                        <span className="text-gray-500">Max. Relocate:</span>
                                        <span className="ml-2 text-white">3</span>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>

                    {/* Tags */}
                    {vm.tags && (
                        <div className="px-6 pb-6">
                            <div className="text-xs text-gray-500 mb-2">Tags</div>
                            <div className="flex flex-wrap gap-2">
                                {vm.tags.split(';').map(tag => (
                                    <span key={tag} className="px-2 py-1 bg-proxmox-dark rounded text-xs text-gray-400">
                                        {tag}
                                    </span>
                                ))}
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // Proxmox Native HA Section for Settings
        function ProxmoxHaSection({ clusterId }) {
            const { t } = useTranslation();
            const { getAuthHeaders } = useAuth();
            const [resources, setResources] = useState([]);
            const [loading, setLoading] = useState(true);

            // Local authFetch helper
            const authFetch = async (url, options = {}) => {
                try {
                    return await fetch(url, {
                        ...options,
                        credentials: 'include',
                        headers: { ...options.headers, ...getAuthHeaders() }
                    });
                } catch (err) {
                    console.error('Auth fetch error:', err);
                    return null;
                }
            };

            useEffect(() => {
                const fetchData = async () => {
                    try {
                        const response = await authFetch(`${API_URL}/clusters/${clusterId}/proxmox-ha/resources`);
                        if(response && response.ok) {
                            setResources(await response.json());
                        }
                    } catch (error) {
                        console.error('fetching HA data:', error);
                    } finally {
                        setLoading(false);
                    }
                };
                fetchData();
            }, [clusterId]);

            const removeFromHa = async (sid) => {
                try {
                    const res = await authFetch(`${API_URL}/clusters/${clusterId}/proxmox-ha/resources/${sid}`, {
                        method: 'DELETE'
                    });
                    if(res && res.ok) {
                        setResources(resources.filter(r => r.sid !== sid));
                    }
                } catch(e) {
                    console.error('removing from HA:', e);
                }
            };

            if(loading) {
                return (
                    <div className="flex items-center gap-2 text-gray-500 text-sm">
                        <Icons.RotateCw />
                        {t('loading')}
                    </div>
                );
            }

            return (
                <div className="space-y-3">
                    <div className="flex items-center justify-between">
                        <span className="text-sm text-gray-400">{resources.length} {t('vmsWithHa')}</span>
                    </div>
                    
                    {resources.length === 0 ? (
                        <div className="text-xs text-gray-600 p-3 bg-proxmox-dark rounded-lg">
                            {t('noVmsWithHa')}
                        </div>
                    ) : (
                        <div className="space-y-2 max-h-48 overflow-y-auto">
                            {resources.map(resource => {
                                const [type, vmid] = (resource.sid || '').split(':');
                                return (
                                    <div key={resource.sid} className="flex items-center justify-between p-2 bg-proxmox-dark rounded-lg text-sm">
                                        <div className="flex items-center gap-2">
                                            <span className={type === 'vm' ? 'text-blue-400' : 'text-purple-400'}>
                                                {type === 'vm' ? 'VM' : 'CT'} {vmid}
                                            </span>
                                            <span className="text-xs text-gray-500">
                                                Max Restart: {resource.max_restart || 3}
                                            </span>
                                        </div>
                                        <button
                                            onClick={() => removeFromHa(resource.sid)}
                                            className="p-1 rounded hover:bg-red-500/20 text-gray-500 hover:text-red-400"
                                            title={t('removeFromHa')}
                                        >
                                            <Icons.X />
                                        </button>
                                    </div>
                                );
                            })}
                        </div>
                    )}
                </div>
            );
        }

        // Migrate Modal Component
        // LW: This thing was a nightmare to debug. ISO detection finally works now!
        // See also: CrossClusterMigrateModal below (similar logic)
        function MigrateModal({ vm, nodes, clusterId, onMigrate, onClose }) {
            const { t } = useTranslation();
            const { getAuthHeaders } = useAuth();
            const [targetNode, setTargetNode] = useState('');
            const [targetStorage, setTargetStorage] = useState('');
            const [online, setOnline] = useState(true);
            const [withLocalDisks, setWithLocalDisks] = useState(false);
            const [forceConntrack, setForceConntrack] = useState(false);
            const [loading, setLoading] = useState(false);
            const [storages, setStorages] = useState([]);
            const [loadingStorages, setLoadingStorages] = useState(false);
            const [hasLocalDisks, setHasLocalDisks] = useState(false);
            const [hasCdDvd, setHasCdDvd] = useState(false);
            const [detectedIsos, setDetectedIsos] = useState([]);
            const [bootOrderIssues, setBootOrderIssues] = useState([]);

            const availableNodes = nodes.filter(n => n !== vm.node);
            const isContainer = vm.type === 'lxc';

            // check if VM has local disks, CD/DVD, and boot order issues on mount
            useEffect(() => {
                if(!vm || !vm.node || !clusterId) return;
                
                const checkVmConfig = async () => {
                    try {
                        const response = await fetch(`${API_URL}/clusters/${clusterId}/vms/${vm.node}/${vm.type}/${vm.vmid}/config`, {
                            headers: getAuthHeaders()
                        });
                        if(response && response.ok) {
                            const data = await response.json();
                            const config = data.raw || data;
                            
                            // Check all disk entries for local storage
                            const diskKeys = Object.keys(config).filter(k => 
                                k.match(/^(scsi|sata|virtio|ide|mp|rootfs)\d*$/)
                            );
                            const hasLocal = diskKeys.some(key => {
                                const diskValue = config[key];
                                if(typeof diskValue === 'string') {
                                    return diskValue.includes('shared=0') || 
                                           diskValue.startsWith('local:') ||
                                           diskValue.startsWith('local-lvm:') ||
                                           diskValue.startsWith('local-zfs:');
                                }
                                return false;
                            });
                            setHasLocalDisks(hasLocal);
                            if(hasLocal) {
                                setWithLocalDisks(true);
                            }
                            
                            // Check for CD/DVD drives with ISO mounted (especially from local storage)
                            const cdDvdKeys = Object.keys(config).filter(k => 
                                k.match(/^(ide|sata|scsi)\d*$/)
                            );
                            const foundIsos = [];
                            cdDvdKeys.forEach(key => {
                                const value = config[key];
                                if(typeof value === 'string' && value.includes('media=cdrom')) {
                                    const isoMatch = value.match(/^([^,]+)/);
                                    if(isoMatch && isoMatch[1] && !isoMatch[1].includes('none')) {
                                        const isoPath = isoMatch[1];
                                        const isLocalStorage = isoPath.startsWith('local:') || 
                                            isoPath.startsWith('local-lvm:') ||
                                            isoPath.startsWith('local-zfs:');
                                        foundIsos.push({ device: key, iso: isoPath, isLocal: isLocalStorage });
                                    }
                                }
                            });
                            setHasCdDvd(foundIsos.length > 0);
                            setDetectedIsos(foundIsos);
                            
                            // Check boot order for non-existent disks
                            const bootOrder = config.boot || '';
                            const bootDevices = bootOrder.includes('order=') 
                                ? bootOrder.split('order=')[1].split(';')[0].split(',')
                                : [];
                            const issues = [];
                            bootDevices.forEach(device => {
                                if(device && !config[device] && device !== 'net0') {
                                    issues.push(device);
                                }
                            });
                            setBootOrderIssues(issues);
                        }
                    } catch (err) {
                        console.error('checking VM config:', err);
                    }
                };
                checkVmConfig();
            }, [vm, clusterId]);

            // Fetch storages when target node changes
            useEffect(() => {
                if(targetNode) {
                    fetchStorages(targetNode);
                }else{
                    setStorages([]);
                    setTargetStorage('');
                }
            }, [targetNode]);

            const fetchStorages = async (node) => {
                setLoadingStorages(true);
                try {
                    const response = await fetch(`${API_URL}/clusters/${clusterId}/nodes/${node}/storage`, {
                        headers: getAuthHeaders()
                    });
                    if(response && response.ok) {
                        const data = await response.json();
                        // Filter storages that can hold VM/CT images
                        const validStorages = data.filter(s => 
                            s.content && (s.content.includes('images') || s.content.includes('rootdir'))
                        );
                        setStorages(validStorages);
                    }
                } catch (err) {
                    console.error('fetching storages:', err);
                }
                setLoadingStorages(false);
            };

            const handleMigrate = async () => {
                if(!targetNode) return;
                setLoading(true);
                
                const options = {
                    online,
                    targetStorage: targetStorage || null,
                    withLocalDisks,
                    forceConntrack: isContainer ? forceConntrack : null
                };
                
                await onMigrate(vm, targetNode, online, options);
                setLoading(false);
                onClose();
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/80">
                    <div className="w-full max-w-md bg-proxmox-card border border-proxmox-border rounded-xl p-6 animate-scale-in">
                        <h3 className="text-lg font-semibold text-white mb-4">{t('migrateVm')}</h3>
                        <div className="space-y-4">
                            <div className="p-3 bg-proxmox-dark rounded-lg">
                                <div className="flex items-center gap-3">
                                    {vm.type === 'qemu' ? <Icons.VM /> : <Icons.Container />}
                                    <div>
                                        <div className="font-medium text-white">{vm.name || `VM ${vm.vmid}`}</div>
                                        <div className="text-xs text-gray-400">ID {vm.vmid} {t('on')} {vm.node}</div>
                                    </div>
                                </div>
                            </div>
                            
                            {/* Migration Warnings */}
                            {(hasCdDvd || bootOrderIssues.length > 0) && (
                                <div className="space-y-2">
                                    {hasCdDvd && (
                                        <div className="p-3 bg-red-500/10 border border-red-500/30 rounded-lg">
                                            <div className="flex items-start gap-2">
                                                <span className="text-red-400 text-lg">üíø</span>
                                                <div className="flex-1">
                                                    <p className="text-red-400 font-medium text-sm">{t('isoMounted') || 'ISO/CD-ROM Mounted'}</p>
                                                    <p className="text-red-300/70 text-xs mt-1">
                                                        {t('isoMigrationWarning') || 'Migration may fail if the ISO is not available on the target node. Eject the CD/DVD or ensure the ISO exists on shared storage.'}
                                                    </p>
                                                    {detectedIsos && detectedIsos.length > 0 && (
                                                        <div className="mt-2 space-y-1">
                                                            {detectedIsos.map((iso, idx) => (
                                                                <div key={idx} className="flex items-center gap-2 text-xs flex-wrap">
                                                                    <span className="text-gray-400">{iso.device}:</span>
                                                                    <code className="text-red-300 bg-red-500/10 px-1 rounded break-all">{iso.iso}</code>
                                                                    {iso.isLocal && (
                                                                        <span className="px-1.5 py-0.5 bg-red-500/20 text-red-400 rounded text-[10px]">
                                                                            {t('localStorage') || 'Local'}
                                                                        </span>
                                                                    )}
                                                                </div>
                                                            ))}
                                                        </div>
                                                    )}
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                    {bootOrderIssues.length > 0 && (
                                        <div className="p-3 bg-yellow-500/10 border border-yellow-500/30 rounded-lg flex items-start gap-2">
                                            <span className="text-yellow-400 text-lg">‚ö†Ô∏è</span>
                                            <div>
                                                <p className="text-yellow-400 font-medium text-sm">{t('bootOrderIssue') || 'Boot Order Issue'}</p>
                                                <p className="text-yellow-300/70 text-xs">
                                                    {t('bootOrderWarning') || 'Boot order references non-existent disks'}: <code className="bg-yellow-500/10 px-1 rounded">{bootOrderIssues.join(', ')}</code>
                                                </p>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            )}
                            
                            {/* Target Node */}
                            <div>
                                <label className="block text-sm text-gray-400 mb-2">{t('targetNode')}</label>
                                <select
                                    value={targetNode}
                                    onChange={(e) => setTargetNode(e.target.value)}
                                    className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white"
                                >
                                    <option value="">{t('selectNode')}...</option>
                                    {availableNodes.map(node => (
                                        <option key={node} value={node}>{node}</option>
                                    ))}
                                </select>
                            </div>
                            
                            {/* Target Storage */}
                            <div>
                                <label className="block text-sm text-gray-400 mb-2">{t('targetStorage')}</label>
                                <select
                                    value={targetStorage}
                                    onChange={(e) => setTargetStorage(e.target.value)}
                                    disabled={!targetNode || loadingStorages}
                                    className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white disabled:opacity-50"
                                >
                                    <option value="">{t('sameAsSource')}</option>
                                    {storages.map(storage => (
                                        <option key={storage.storage} value={storage.storage}>
                                            {storage.storage} ({storage.type}) - {Math.round((storage.avail || 0) / 1073741824)} GB {t('free')}
                                        </option>
                                    ))}
                                </select>
                                {loadingStorages && (
                                    <p className="text-xs text-gray-500 mt-1">{t('loadingStorages')}...</p>
                                )}
                            </div>
                            
                            {/* Migration Options */}
                            <div className="space-y-3 pt-2 border-t border-proxmox-border">
                                <label className="flex items-center gap-3 text-sm text-gray-300 cursor-pointer">
                                    <input
                                        type="checkbox"
                                        checked={online}
                                        onChange={(e) => setOnline(e.target.checked)}
                                        className="w-4 h-4 rounded"
                                    />
                                    <div>
                                        <span>{t('liveMigration')}</span>
                                        {isContainer && (
                                            <p className="text-xs text-yellow-500 mt-0.5">‚ö†Ô∏è {t('containerNoLiveMigration')}</p>
                                        )}
                                    </div>
                                </label>
                                
                                {/* Local Disks Warning */}
                                {hasLocalDisks && (
                                    <div className="p-2 bg-yellow-500/10 border border-yellow-500/30 rounded-lg">
                                        <p className="text-xs text-yellow-400">
                                            ‚ö†Ô∏è {t('localDisksDetected') || 'This VM has local disks. Migration requires copying disk data.'}
                                        </p>
                                    </div>
                                )}
                                
                                <label className="flex items-center gap-3 text-sm text-gray-300 cursor-pointer">
                                    <input
                                        type="checkbox"
                                        checked={withLocalDisks}
                                        onChange={(e) => setWithLocalDisks(e.target.checked)}
                                        className="w-4 h-4 rounded"
                                    />
                                    <div>
                                        <span>{t('withLocalDisks')}</span>
                                        <p className="text-xs text-gray-500">{t('withLocalDisksDesc')}</p>
                                        {hasLocalDisks && <p className="text-xs text-yellow-400">{t('requiredForThisVm') || 'Required for this VM'}</p>}
                                    </div>
                                </label>
                                
                                {isContainer && (
                                    <label className="flex items-center gap-3 text-sm text-gray-300 cursor-pointer">
                                        <input
                                            type="checkbox"
                                            checked={forceConntrack}
                                            onChange={(e) => setForceConntrack(e.target.checked)}
                                            className="w-4 h-4 rounded"
                                        />
                                        <div>
                                            <span>{t('forceConntrack')}</span>
                                            <p className="text-xs text-gray-500">{t('forceConntrackDesc')}</p>
                                        </div>
                                    </label>
                                )}
                            </div>
                        </div>
                        <div className="flex justify-end gap-3 mt-6">
                            <button onClick={onClose} className="px-4 py-2 text-gray-300 hover:text-white">{t('cancel')}</button>
                            <button
                                onClick={handleMigrate}
                                disabled={!targetNode || loading}
                                className="flex items-center gap-2 px-4 py-2 bg-blue-600 rounded-lg text-white hover:bg-blue-700 disabled:opacity-50"
                            >
                                {loading && <Icons.RotateCw />}
                                {t('migrate')}
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        // Bulk Migrate Modal Component
        // NS: For evacuating nodes before maintenance
        // Migrations run sequentially to avoid overloading the network
        function BulkMigrateModal({ vms, nodes, clusterId, onMigrate, onClose }) {
            const { t } = useTranslation();  // MK: Fix missing translation hook
            const [targetNode, setTargetNode] = useState('');
            const [online, setOnline] = useState(true);
            const [loading, setLoading] = useState(false);

            // Get all unique current nodes
            const currentNodes = [...new Set(vms.map(v => v.node))];
            const availableNodes = nodes.filter(n => !currentNodes.includes(n) || currentNodes.length > 1);

            const handleMigrate = async () => {
                if(!targetNode) return;
                setLoading(true);
                await onMigrate(vms, targetNode, online);
                setLoading(false);
                onClose();
            };

            return(
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/80">
                    <div className="w-full max-w-lg bg-proxmox-card border border-proxmox-border rounded-xl p-6 animate-scale-in">
                        <h3 className="text-lg font-semibold text-white mb-4">{t('bulkMigration')}</h3>
                        <div className="space-y-4">
                            <div className="p-3 bg-proxmox-dark rounded-lg max-h-48 overflow-y-auto">
                                <div className="text-sm text-gray-400 mb-2">{vms.length} {t('vmsSelected')}:</div>
                                <div className="space-y-1">
                                    {vms.map(vm => (
                                        <div key={vm.vmid} className="flex items-center gap-2 text-sm">
                                            <span className="text-proxmox-orange font-mono">{vm.vmid}</span>
                                            <span className="text-white">{vm.name || '‚Äî'}</span>
                                            <span className="text-gray-500">({vm.node})</span>
                                        </div>
                                    ))}
                                </div>
                            </div>
                            <div>
                                <label className="block text-sm text-gray-400 mb-2">{t('targetNode')}</label>
                                <select
                                    value={targetNode}
                                    onChange={(e) => setTargetNode(e.target.value)}
                                    className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white"
                                >
                                    <option value="">{t('selectNode')}</option>
                                    {availableNodes.map(node => (
                                        <option key={node} value={node}>{node}</option>
                                    ))}
                                </select>
                            </div>
                            <label className="flex items-center gap-3 text-sm text-gray-300">
                                <input
                                    type="checkbox"
                                    checked={online}
                                    onChange={(e) => setOnline(e.target.checked)}
                                    className="w-4 h-4 rounded"
                                />
                                {t('liveMigration')}
                            </label>
                            <div className="p-3 bg-yellow-500/10 border border-yellow-500/30 rounded-lg text-sm text-yellow-400">
                                {t('bulkMigrationNote') || 'Migrations will be performed sequentially. This may take some time.'}
                            </div>
                        </div>
                        <div className="flex justify-end gap-3 mt-6">
                            <button onClick={onClose} className="px-4 py-2 text-gray-300 hover:text-white">{t('cancel')}</button>
                            <button
                                onClick={handleMigrate}
                                disabled={!targetNode || loading}
                                className="flex items-center gap-2 px-4 py-2 bg-blue-600 rounded-lg text-white hover:bg-blue-700 disabled:opacity-50"
                            >
                                {loading && <Icons.RotateCw />}
                                {vms.length} {t('migrateVms')}
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        // Cross-Cluster Migration Modal
        // NS: The big one - SSH tunnel based migration between clusters
        // Uses same ISO detection logic as MigrateModal (copy-paste, I know...)
        function CrossClusterMigrateModal({ vm, sourceCluster, clusters, onMigrate, onClose }) {
            const { getAuthHeaders } = useAuth();
            const { t } = useTranslation();
            const [targetCluster, setTargetCluster] = useState('');
            const [targetNode, setTargetNode] = useState('');
            const [targetStorage, setTargetStorage] = useState('');
            const [targetBridge, setTargetBridge] = useState('vmbr0');
            const [targetVmid, setTargetVmid] = useState('');
            const [online, setOnline] = useState(true);
            const [deleteSource, setDeleteSource] = useState(true);
            const [loading, setLoading] = useState(false);
            const [targetNodes, setTargetNodes] = useState([]);
            const [targetStorages, setTargetStorages] = useState([]);
            const [targetBridges, setTargetBridges] = useState([]);
            const [loadingTarget, setLoadingTarget] = useState(false);
            const [hasCdDvd, setHasCdDvd] = useState(false);
            const [detectedIsos, setDetectedIsos] = useState([]);
            const [bootOrderIssues, setBootOrderIssues] = useState([]);

            const availableClusters = clusters.filter(c => c.id !== sourceCluster.id);
            const isQemu = vm.type === 'qemu';
            
            // Local authFetch helper
            const authFetch = async (url, options = {}) => {
                try {
                    const response = await fetch(url, {
                        ...options,
                        credentials: 'include',
                        headers: {
                            ...options.headers,
                            ...getAuthHeaders()
                        }
                    });
                    return response;
                } catch (err) {
                    console.error('Auth fetch error:', err);
                    return null;
                }
            };
            
            // Check for CD/DVD and boot order issues
            useEffect(() => {
                const checkVmConfig = async () => {
                    try {
                        const response = await authFetch(`${API_URL}/clusters/${sourceCluster.id}/vms/${vm.node}/${vm.type}/${vm.vmid}/config`);
                        if(response && response.ok) {
                            const data = await response.json();
                            const config = data.raw || data;
                            
                            // Check for CD/DVD drives with ISO mounted
                            const cdDvdKeys = Object.keys(config).filter(k => 
                                k.match(/^(ide|sata|scsi)\d*$/)
                            );
                            const foundIsos = [];
                            cdDvdKeys.forEach(key => {
                                const value = config[key];
                                if(typeof value === 'string' && value.includes('media=cdrom')) {
                                    const isoMatch = value.match(/^([^,]+)/);
                                    if(isoMatch && isoMatch[1] && !isoMatch[1].includes('none')) {
                                        const isoPath = isoMatch[1];
                                        const isLocal = isoPath.startsWith('local:') || 
                                                       isoPath.startsWith('local-lvm:') ||
                                                       isoPath.startsWith('local-zfs:');
                                        foundIsos.push({ device: key, iso: isoPath, isLocal });
                                    }
                                }
                            });
                            setHasCdDvd(foundIsos.length > 0);
                            setDetectedIsos(foundIsos);
                            
                            // Check boot order for non-existent disks
                            const bootOrder = config.boot || '';
                            const bootDevices = bootOrder.includes('order=') 
                                ? bootOrder.split('order=')[1].split(';')[0].split(',')
                                : [];
                            const issues = [];
                            bootDevices.forEach(device => {
                                if(device && !config[device] && device !== 'net0') {
                                    issues.push(device);
                                }
                            });
                            setBootOrderIssues(issues);
                        }
                    } catch (err) {
                        console.error('checking VM config:', err);
                    }
                };
                checkVmConfig();
            }, [vm, sourceCluster.id]);

            // Load target cluster nodes when cluster selected
            useEffect(() => {
                if(targetCluster) {
                    loadTargetNodes();
                }else{
                    setTargetNodes([]);
                    setTargetNode('');
                }
            }, [targetCluster]);

            // Load target node resources when node selected
            useEffect(() => {
                if(targetCluster && targetNode) {
                    loadTargetResources();
                }else{
                    setTargetStorages([]);
                    setTargetBridges([]);
                }
            }, [targetNode]);

            const loadTargetNodes = async () => {
                setLoadingTarget(true);
                try {
                    const nodesRes = await authFetch(`${API_URL}/clusters/${targetCluster}/nodes`);
                    if(nodesRes && nodesRes.ok) {
                        const nodes = await nodesRes.json();
                        setTargetNodes(nodes);
                        // Auto-select first online node
                        const onlineNode = nodes.find(n => n.status === 'online');
                        if(onlineNode) {
                            setTargetNode(onlineNode.node);
                        }
                    }
                } catch (error) {
                    console.error('to load target nodes:', error);
                }
                setLoadingTarget(false);
            };

            const loadTargetResources = async () => {
                setLoadingTarget(true);
                try {
                    // Get storage list for selected node
                    const storageRes = await authFetch(`${API_URL}/clusters/${targetCluster}/nodes/${targetNode}/storage`);
                    if(storageRes && storageRes.ok) {
                        setTargetStorages(await storageRes.json());
                    }
                    
                    // Get network list for selected node
                    const networkRes = await authFetch(`${API_URL}/clusters/${targetCluster}/nodes/${targetNode}/networks`);
                    if(networkRes && networkRes.ok) {
                        const networks = await networkRes.json();
                        setTargetBridges(networks.filter(n => n.type === 'bridge'));
                    }
                } catch (error) {
                    console.error('to load target resources:', error);
                }
                setLoadingTarget(false);
            };

            const handleMigrate = async () => {
                if (!targetCluster || !targetNode || !targetStorage || !targetBridge) return;
                setLoading(true);
                await onMigrate({
                    source_cluster: sourceCluster.id,
                    target_cluster: targetCluster,
                    vmid: vm.vmid,
                    vm_type: vm.type,
                    source_node: vm.node,
                    target_node: targetNode,
                    target_storage: targetStorage,
                    target_bridge: targetBridge,
                    target_vmid: targetVmid ? parseInt(targetVmid) : null,
                    online,
                    delete_source: deleteSource
                });
                setLoading(false);
                onClose();
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/80 overflow-y-auto">
                    <div className="w-full max-w-xl bg-proxmox-card border border-proxmox-border rounded-xl overflow-hidden animate-scale-in my-8">
                        <div className="px-6 py-4 border-b border-proxmox-border bg-gradient-to-r from-cyan-500/10 to-blue-500/10">
                            <div className="flex items-center justify-between">
                                <div className="flex items-center gap-3">
                                    <div className="p-2 rounded-lg bg-cyan-500/20">
                                        <Icons.Globe />
                                    </div>
                                    <div>
                                        <h3 className="text-lg font-semibold text-white">{t('crossClusterMigration')}</h3>
                                        <p className="text-sm text-gray-400">{t('crossClusterMigrateDesc')}</p>
                                    </div>
                                </div>
                                <button onClick={onClose} className="p-2 hover:bg-proxmox-border rounded-lg text-gray-400 hover:text-white">
                                    <Icons.X />
                                </button>
                            </div>
                        </div>
                        
                        <div className="p-6 space-y-4 max-h-[60vh] overflow-y-auto">
                            {/* Source VM Info */}
                            <div className="p-4 bg-proxmox-dark rounded-lg border border-proxmox-border">
                                <div className="text-xs text-gray-500 mb-2">{t('sourceVm')}</div>
                                <div className="flex items-center gap-3">
                                    <div className={`p-2 rounded-lg ${isQemu ? 'bg-blue-500/10' : 'bg-purple-500/10'}`}>
                                        {isQemu ? <Icons.VM /> : <Icons.Container />}
                                    </div>
                                    <div>
                                        <div className="font-medium text-white">{vm.name || `${isQemu ? 'VM' : 'CT'} ${vm.vmid}`}</div>
                                        <div className="text-xs text-gray-400">
                                            ID {vm.vmid} ¬∑ {vm.node} ¬∑ {sourceCluster.name}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            {/* Migration Warnings */}
                            {(hasCdDvd || bootOrderIssues.length > 0) && (
                                <div className="space-y-2">
                                    {hasCdDvd && (
                                        <div className="p-3 bg-red-500/10 border border-red-500/30 rounded-lg">
                                            <div className="flex items-start gap-2">
                                                <span className="text-red-400 text-lg">üíø</span>
                                                <div className="flex-1">
                                                    <p className="text-red-400 font-medium text-sm">{t('isoMounted') || 'ISO/CD-ROM Mounted'}</p>
                                                    <p className="text-red-300/70 text-xs mt-1">
                                                        {t('isoMigrationWarning') || 'Migration may fail if the ISO is not available on the target node. Eject the CD/DVD or ensure the ISO exists on shared storage.'}
                                                    </p>
                                                    {detectedIsos && detectedIsos.length > 0 && (
                                                        <div className="mt-2 space-y-1">
                                                            {detectedIsos.map((iso, idx) => (
                                                                <div key={idx} className="flex items-center gap-2 text-xs flex-wrap">
                                                                    <span className="text-gray-400">{iso.device}:</span>
                                                                    <code className="text-red-300 bg-red-500/10 px-1 rounded break-all">{iso.iso}</code>
                                                                    {iso.isLocal && (
                                                                        <span className="px-1.5 py-0.5 bg-red-500/20 text-red-400 rounded text-[10px]">
                                                                            {t('localStorage') || 'Local'}
                                                                        </span>
                                                                    )}
                                                                </div>
                                                            ))}
                                                        </div>
                                                    )}
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                    {bootOrderIssues.length > 0 && (
                                        <div className="p-3 bg-yellow-500/10 border border-yellow-500/30 rounded-lg flex items-start gap-2">
                                            <span className="text-yellow-400 text-lg">‚ö†Ô∏è</span>
                                            <div>
                                                <p className="text-yellow-400 font-medium text-sm">{t('bootOrderIssue') || 'Boot Order Issue'}</p>
                                                <p className="text-yellow-300/70 text-xs">
                                                    {t('bootOrderWarning') || 'Boot order references non-existent disks'}: <code className="bg-yellow-500/10 px-1 rounded">{bootOrderIssues.join(', ')}</code>
                                                </p>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            )}

                            {/* Target Cluster */}
                            <div>
                                <label className="block text-sm text-gray-400 mb-2">{t('targetCluster')}</label>
                                <select
                                    value={targetCluster}
                                    onChange={(e) => setTargetCluster(e.target.value)}
                                    className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white"
                                >
                                    <option value="">{t('selectCluster')}</option>
                                    {availableClusters.map(c => (
                                        <option key={c.id} value={c.id}>{c.name}</option>
                                    ))}
                                </select>
                            </div>

                            {targetCluster && (
                                <>
                                    {loadingTarget && targetNodes.length === 0 ? (
                                        <div className="flex items-center justify-center py-4 text-gray-400">
                                            <Icons.RotateCw />
                                            <span className="ml-2">{t('loadingNodes')}</span>
                                        </div>
                                    ) : (
                                        <>
                                            {/* Target Node */}
                                            <div>
                                                <label className="block text-sm text-gray-400 mb-2">{t('targetNode')}</label>
                                                <select
                                                    value={targetNode}
                                                    onChange={(e) => setTargetNode(e.target.value)}
                                                    className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white"
                                                >
                                                    <option value="">{t('selectNode')}...</option>
                                                    {targetNodes.map(n => (
                                                        <option key={n.node} value={n.node}>
                                                            {n.node} ({n.status}) - CPU: {n.cpu_percent?.toFixed(1)}% RAM: {n.mem_percent?.toFixed(1)}%
                                                        </option>
                                                    ))}
                                                </select>
                                            </div>

                                            {targetNode && (
                                                <>
                                                    {loadingTarget ? (
                                                        <div className="flex items-center justify-center py-4 text-gray-400">
                                                            <Icons.RotateCw />
                                                            <span className="ml-2">{t('loadingStorageNetwork')}</span>
                                                        </div>
                                                    ) : (
                                                        <>
                                                            {/* Target Storage */}
                                                            <div>
                                                                <label className="block text-sm text-gray-400 mb-2">{t('targetStorage')}</label>
                                                                <select
                                                                    value={targetStorage}
                                                                    onChange={(e) => setTargetStorage(e.target.value)}
                                                                    className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white"
                                                                >
                                                                    <option value="">{t('selectStorage')}</option>
                                                                    {targetStorages.map(s => (
                                                                        <option key={s.storage} value={s.storage}>
                                                                            {s.storage} ({s.type})
                                                                        </option>
                                                                    ))}
                                                                </select>
                                                            </div>

                                                            {/* Target Bridge */}
                                                            <div>
                                                                <label className="block text-sm text-gray-400 mb-2">{t('targetBridge')}</label>
                                                                <select
                                                                    value={targetBridge}
                                                                    onChange={(e) => setTargetBridge(e.target.value)}
                                                                    className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white"
                                                                >
                                                                    {targetBridges.length === 0 && <option value="vmbr0">vmbr0</option>}
                                                                    {targetBridges.map(b => (
                                                                        <option key={b.iface} value={b.iface}>{b.iface}{b.comments ? ` - ${b.comments}` : ''}</option>
                                                                    ))}
                                                                </select>
                                                            </div>

                                                            {/* Target VMID (optional) */}
                                                            <div>
                                                                <label className="block text-sm text-gray-400 mb-2">{t('newVmid')}</label>
                                                                <input
                                                                    type="number"
                                                                    value={targetVmid}
                                                                    onChange={(e) => setTargetVmid(e.target.value)}
                                                                    placeholder={`${t('sameIdPlaceholder')} (${vm.vmid})`}
                                                                    className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white"
                                                                />
                                                            </div>

                                                            {/* Options */}
                                                            <div className="space-y-2">
                                                                {isQemu && (
                                                                    <label className="flex items-center gap-3 text-sm text-gray-300">
                                                                        <input
                                                                            type="checkbox"
                                                                            checked={online}
                                                                            onChange={(e) => setOnline(e.target.checked)}
                                                                            className="w-4 h-4 rounded"
                                                                        />
                                                                        {t('liveMigrationOption')}
                                                                    </label>
                                                                )}
                                                                <label className="flex items-center gap-3 text-sm text-gray-300">
                                                                    <input
                                                                        type="checkbox"
                                                                        checked={deleteSource}
                                                                        onChange={(e) => setDeleteSource(e.target.checked)}
                                                                        className="w-4 h-4 rounded"
                                                                    />
                                                                    {t('deleteSourceAfter')}
                                                                </label>
                                                            </div>
                                                        </>
                                                    )}
                                                </>
                                            )}
                                        </>
                                    )}
                                </>
                            )}

                            <div className="p-3 bg-green-500/10 border border-green-500/30 rounded-lg text-sm text-green-400">
                                ‚úì <strong>{t('autoTokenInfo').split('.')[0]}.</strong> {t('autoTokenInfo').split('.').slice(1).join('.')}
                            </div>
                            
                            <div className="p-3 bg-blue-500/10 border border-blue-500/30 rounded-lg text-sm text-blue-400">
                                üí° {t('clusterReachableInfo')}
                            </div>
                        </div>

                        <div className="flex justify-end gap-3 px-6 py-4 border-t border-proxmox-border bg-proxmox-dark">
                            <button onClick={onClose} className="px-4 py-2 text-gray-300 hover:text-white">
                                {t('cancel')}
                            </button>
                            <button
                                onClick={handleMigrate}
                                disabled={!targetCluster || !targetNode || !targetStorage || loading}
                                className="flex items-center gap-2 px-4 py-2 bg-cyan-600 rounded-lg text-white hover:bg-cyan-700 disabled:opacity-50"
                            >
                                {loading && <Icons.RotateCw />}
                                <Icons.Globe />
                                {t('crossClusterMigrate')}
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        // Migration History Component
        // LW: Limited to 10 items by default (GitHub Issue - list was too long)
        function MigrationHistory({ logs, maxItems = 10 }) {
            const { t } = useTranslation();
            
            if (!logs || logs.length === 0) {
                return (
                    <div className="text-center py-8 text-gray-500">
                        <Icons.Activity />
                        <p className="mt-2">{t('noMigrationsYet')}</p>
                    </div>
                );
            }
            
            // LW: Only show last 10 migrations (newest first)
            const reversedLogs = logs.slice().reverse();
            const displayLogs = reversedLogs.slice(0, maxItems);
            const hiddenCount = reversedLogs.length - maxItems;

            return (
                <div className="space-y-4">
                    <div className="relative space-y-4">
                        <div className="timeline-line" />
                        {displayLogs.map((log, idx) => (
                            <div 
                                key={idx} 
                                className="relative pl-12 animate-slide-in"
                                style={{ animationDelay: `${idx * 50}ms` }}
                            >
                                <div className={`absolute left-2 w-6 h-6 rounded-full flex items-center justify-center ${
                                    log.success 
                                        ? 'bg-green-500/20 text-green-400 border border-green-500/30' 
                                        : 'bg-red-500/20 text-red-400 border border-red-500/30'
                                }`}>
                                    {log.success ? <Icons.Check /> : <Icons.X />}
                                </div>
                                <div className="bg-proxmox-dark border border-proxmox-border rounded-lg p-4">
                                    <div className="flex items-center justify-between mb-2">
                                        <span className="font-medium text-white">{log.vm}</span>
                                        {log.dry_run && (
                                            <span className="text-xs bg-yellow-500/10 text-yellow-400 px-2 py-0.5 rounded border border-yellow-500/20">
                                                Dry Run
                                            </span>
                                        )}
                                    </div>
                                    <div className="flex items-center gap-2 text-sm text-gray-400">
                                        <span className="font-mono">{log.from_node}</span>
                                        <Icons.ArrowRight />
                                        <span className="font-mono">{log.to_node}</span>
                                    </div>
                                    <div className="mt-2 text-xs text-gray-500">
                                        {new Date(log.timestamp).toLocaleString('de-DE')}
                                    </div>
                                </div>
                            </div>
                        ))}
                    </div>
                    
                    {/* LW: Show count of hidden older migrations */}
                    {hiddenCount > 0 && (
                        <div className="text-center py-2 text-xs text-gray-500">
                            + {hiddenCount} {t('olderMigrations') || 'older migrations'}
                        </div>
                    )}
                </div>
            );
        }

        // LW: All Clusters Overview - GitHub Feature Request #16
        // added a bunch of stuff here - storage, sparklines, sorting etc
        function AllClustersOverview({ clusters, allMetrics, clusterGroups = [], topGuests = [], onSelectCluster, onSelectVm }) {
            const { t } = useTranslation();
            const [sortBy, setSortBy] = useState('name');
            const [sortDir, setSortDir] = useState('asc');
            const [cpuHistory, setCpuHistory] = useState({});
            const [ramHistory, setRamHistory] = useState({});
            
            // sparkline history
            useEffect(() => {
                clusters.forEach(cluster => {
                    const status = allMetrics[cluster.id]?.data || {};
                    const cpu = status.resources?.cpu?.percent || 0;
                    const ram = status.resources?.memory?.percent || 0;
                    
                    setCpuHistory(prev => ({
                        ...prev,
                        [cluster.id]: [...(prev[cluster.id] || []).slice(-9), cpu]
                    }));
                    setRamHistory(prev => ({
                        ...prev,
                        [cluster.id]: [...(prev[cluster.id] || []).slice(-9), ram]
                    }));
                });
            }, [allMetrics]);
            
            // stats per cluster
            const clusterStats = clusters.map(cluster => {
                const status = allMetrics[cluster.id]?.data || {};
                const lastUpdate = allMetrics[cluster.id]?.lastUpdate;
                const nodes = status.nodes || {};
                const guests = status.guests || {};
                const resources = status.resources || {};
                
                const nodeCount = nodes.total || 0;
                const onlineNodes = nodes.online || 0;
                const offlineNodes = nodes.offline || 0;
                const avgCpu = resources.cpu?.percent || 0;
                const avgMem = resources.memory?.percent || 0;
                const avgStorage = resources.storage?.percent || 0;
                
                const vmsRunning = (guests.vms?.running || 0) + (guests.containers?.running || 0);
                const vmsStopped = (guests.vms?.stopped || 0) + (guests.containers?.stopped || 0);
                const totalVms = vmsRunning + vmsStopped;
                
                // health score calculation - cpu/ram/storage weighted
                const healthScore = cluster.connected 
                    ? Math.max(0, 100 - (avgCpu * 0.3 + avgMem * 0.3 + avgStorage * 0.2 + (nodeCount > 0 ? (offlineNodes / nodeCount) * 100 * 0.2 : 0)))
                    : 0;
                
                // Count alerts/warnings
                const alerts = [];
                if (!cluster.connected) alerts.push({ type: 'error', msg: 'Offline' });
                if (offlineNodes > 0) alerts.push({ type: 'warning', msg: `${offlineNodes} node(s) offline` });
                if (avgCpu > 90) alerts.push({ type: 'error', msg: 'CPU critical' });
                else if (avgCpu > 80) alerts.push({ type: 'warning', msg: 'CPU high' });
                if (avgMem > 90) alerts.push({ type: 'error', msg: 'RAM critical' });
                else if (avgMem > 80) alerts.push({ type: 'warning', msg: 'RAM high' });
                if (avgStorage > 90) alerts.push({ type: 'error', msg: 'Storage critical' });
                else if (avgStorage > 80) alerts.push({ type: 'warning', msg: 'Storage high' });
                
                return {
                    ...cluster,
                    nodeCount, onlineNodes, offlineNodes,
                    avgCpu, avgMem, avgStorage,
                    totalVms, runningVms: vmsRunning,
                    healthScore: Math.round(healthScore),
                    hasMetrics: nodeCount > 0 || cluster.connected,
                    lastUpdate,
                    alerts,
                    cpuHistory: cpuHistory[cluster.id] || [],
                    ramHistory: ramHistory[cluster.id] || []
                };
            });
            
            // sorting
            const sortedStats = [...clusterStats].sort((a, b) => {
                let aVal, bVal;
                switch (sortBy) {
                    case 'health': aVal = a.healthScore; bVal = b.healthScore; break;
                    case 'nodes': aVal = a.nodeCount; bVal = b.nodeCount; break;
                    case 'vms': aVal = a.totalVms; bVal = b.totalVms; break;
                    case 'cpu': aVal = a.avgCpu; bVal = b.avgCpu; break;
                    case 'ram': aVal = a.avgMem; bVal = b.avgMem; break;
                    default: aVal = (a.display_name || a.name).toLowerCase(); bVal = (b.display_name || b.name).toLowerCase();
                }
                if (typeof aVal === 'string') return sortDir === 'asc' ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
                return sortDir === 'asc' ? aVal - bVal : bVal - aVal;
            });
            
            // group by cluster group
            const groupedClusters = {};
            const ungroupedClusters = [];
            sortedStats.forEach(cluster => {
                const group = clusterGroups.find(g => g.id === cluster.group_id);
                if (group) {
                    if (!groupedClusters[group.id]) groupedClusters[group.id] = { group, clusters: [] };
                    groupedClusters[group.id].clusters.push(cluster);
                } else {
                    ungroupedClusters.push(cluster);
                }
            });
            
            // totals for the header cards
            const totals = {
                clusters: clusters.length,
                connectedClusters: clusters.filter(c => c.connected).length,
                totalNodes: clusterStats.reduce((acc, c) => acc + c.nodeCount, 0),
                onlineNodes: clusterStats.reduce((acc, c) => acc + c.onlineNodes, 0),
                totalVms: clusterStats.reduce((acc, c) => acc + c.totalVms, 0),
                runningVms: clusterStats.reduce((acc, c) => acc + c.runningVms, 0),
                avgCpu: clusterStats.filter(c => c.hasMetrics).length > 0 ? clusterStats.reduce((acc, c) => acc + c.avgCpu, 0) / clusterStats.filter(c => c.hasMetrics).length : 0,
                avgMem: clusterStats.filter(c => c.hasMetrics).length > 0 ? clusterStats.reduce((acc, c) => acc + c.avgMem, 0) / clusterStats.filter(c => c.hasMetrics).length : 0,
                avgStorage: clusterStats.filter(c => c.hasMetrics).length > 0 ? clusterStats.reduce((acc, c) => acc + c.avgStorage, 0) / clusterStats.filter(c => c.hasMetrics).length : 0,
                totalAlerts: clusterStats.reduce((acc, c) => acc + c.alerts.length, 0)
            };
            
            // NS: sparkline svg - kept it simple
            const Sparkline = ({ data, color, height = 20, width = 60 }) => {
                if (!data || data.length < 2) return <div style={{ width, height }} className="bg-proxmox-dark/50 rounded" />;
                const max = Math.max(...data, 1);
                const min = Math.min(...data, 0);
                const range = max - min || 1;
                const points = data.map((v, i) => `${(i / (data.length - 1)) * width},${height - ((v - min) / range) * height}`).join(' ');
                return (
                    <svg width={width} height={height} className="overflow-visible">
                        <polyline fill="none" stroke={color} strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round" points={points} />
                        <circle cx={width} cy={height - ((data[data.length - 1] - min) / range) * height} r="2" fill={color} />
                    </svg>
                );
            };
            
            // circular progress - reusable
            const CircularProgress = ({ value, size = 60, strokeWidth = 6, color }) => {
                const radius = (size - strokeWidth) / 2;
                const circumference = radius * 2 * Math.PI;
                const offset = circumference - (value / 100) * circumference;
                return (
                    <div className="relative flex-shrink-0" style={{ width: size, height: size }}>
                        <svg className="transform -rotate-90 overflow-visible" width={size} height={size}>
                            <circle cx={size / 2} cy={size / 2} r={radius} fill="none" stroke="currentColor" strokeWidth={strokeWidth} className="text-gray-700" />
                            <circle cx={size / 2} cy={size / 2} r={radius} fill="none" stroke={color} strokeWidth={strokeWidth} strokeLinecap="round" strokeDasharray={circumference} strokeDashoffset={offset} className="transition-all duration-500" />
                        </svg>
                        <div className="absolute inset-0 flex items-center justify-center">
                            <span className="text-xs font-bold text-white">{value.toFixed(0)}%</span>
                        </div>
                    </div>
                );
            };
            
            const getHealthColor = (score) => {
                if (score >= 80) return { bg: 'bg-green-500/20', text: 'text-green-400', border: 'border-green-500/30', color: '#22c55e' };
                if (score >= 60) return { bg: 'bg-yellow-500/20', text: 'text-yellow-400', border: 'border-yellow-500/30', color: '#eab308' };
                if (score >= 40) return { bg: 'bg-orange-500/20', text: 'text-orange-400', border: 'border-orange-500/30', color: '#f97316' };
                return { bg: 'bg-red-500/20', text: 'text-red-400', border: 'border-red-500/30', color: '#ef4444' };
            };
            
            const formatLastUpdate = (date) => {
                if (!date) return '-';
                const now = new Date();
                const diff = Math.floor((now - new Date(date)) / 1000);
                if (diff < 10) return t('justNow') || 'just now';
                if (diff < 60) return `${diff}s ago`;
                if (diff < 3600) return `${Math.floor(diff / 60)}m ago`;
                return new Date(date).toLocaleTimeString();
            };
            
            const SortButton = ({ field, label }) => (
                <button
                    onClick={() => { setSortBy(field); setSortDir(sortBy === field && sortDir === 'asc' ? 'desc' : 'asc'); }}
                    className={`px-3 py-1.5 text-sm rounded-lg transition-colors ${sortBy === field ? 'bg-proxmox-orange/20 text-proxmox-orange font-medium' : 'text-gray-400 hover:text-white hover:bg-proxmox-dark'}`}
                >
                    {label} {sortBy === field && (sortDir === 'asc' ? '‚Üë' : '‚Üì')}
                </button>
            );
            
            // cluster card component
            const ClusterCard = ({ cluster }) => {
                const healthColors = getHealthColor(cluster.healthScore);
                const hasAlerts = cluster.alerts.length > 0;
                const errorCount = cluster.alerts.filter(a => a.type === 'error').length;
                
                return (
                    <div
                        onClick={() => onSelectCluster(cluster)}
                        className="group relative bg-proxmox-card border border-proxmox-border rounded-xl overflow-hidden cursor-pointer hover:border-proxmox-orange/50 transition-all duration-300 hover:shadow-lg hover:shadow-proxmox-orange/10"
                    >
                        <div className={`h-1.5 ${cluster.connected ? 'bg-gradient-to-r from-green-500 via-emerald-500 to-green-500' : 'bg-gradient-to-r from-red-500 via-red-600 to-red-500'}`} />
                        
                        <div className="p-5">
                            {/* Header */}
                            <div className="flex items-start justify-between mb-4">
                                <div className="flex items-center gap-3">
                                    <div className={`relative w-12 h-12 rounded-xl ${cluster.connected ? 'bg-gradient-to-br from-green-500/20 to-emerald-500/20' : 'bg-gradient-to-br from-red-500/20 to-red-600/20'} flex items-center justify-center`}>
                                        <Icons.Server className={`w-6 h-6 ${cluster.connected ? 'text-green-400' : 'text-red-400'}`} />
                                        {cluster.connected && <div className="absolute -top-1 -right-1 w-3 h-3 bg-green-500 rounded-full border-2 border-proxmox-card animate-pulse" />}
                                    </div>
                                    <div>
                                        <h3 className="font-semibold text-white text-base group-hover:text-proxmox-orange transition-colors">
                                            {cluster.display_name || cluster.name}
                                        </h3>
                                        <p className="text-xs text-gray-500">{cluster.host}</p>
                                    </div>
                                </div>
                                
                                <div className="flex items-center gap-2">
                                    {/* Alerts Badge */}
                                    {hasAlerts && (
                                        <div className="relative group/alerts">
                                            <div className={`px-2.5 py-1 rounded-lg flex items-center gap-1.5 ${errorCount > 0 ? 'bg-red-500/20 border border-red-500/30' : 'bg-yellow-500/20 border border-yellow-500/30'}`}>
                                                <Icons.AlertTriangle className={`w-3.5 h-3.5 ${errorCount > 0 ? 'text-red-400' : 'text-yellow-400'}`} />
                                                <span className={`text-xs font-medium ${errorCount > 0 ? 'text-red-400' : 'text-yellow-400'}`}>{cluster.alerts.length}</span>
                                            </div>
                                            {/* tooltip */}
                                            <div className="absolute right-0 top-full mt-1 z-50 hidden group-hover/alerts:block">
                                                <div className="bg-proxmox-dark border border-proxmox-border rounded-lg p-2 shadow-xl min-w-[160px]">
                                                    {cluster.alerts.map((alert, i) => (
                                                        <div key={i} className={`text-xs py-0.5 ${alert.type === 'error' ? 'text-red-400' : 'text-yellow-400'}`}>
                                                            ‚Ä¢ {alert.msg}
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                    
                                    {/* Health Badge */}
                                    {cluster.connected && (
                                        <div className={`px-2.5 py-1 rounded-lg ${healthColors.bg} ${healthColors.border} border`}>
                                            <span className={`text-xs font-semibold ${healthColors.text}`}>{cluster.healthScore}%</span>
                                        </div>
                                    )}
                                    {!cluster.connected && (
                                        <div className="px-2.5 py-1 rounded-lg bg-red-500/20 border border-red-500/30">
                                            <span className="text-xs font-semibold text-red-400">Offline</span>
                                        </div>
                                    )}
                                </div>
                            </div>
                            
                            {/* Stats Grid */}
                            {cluster.hasMetrics ? (
                                <div className="grid grid-cols-5 gap-3">
                                    {/* Nodes */}
                                    <div className="text-center p-3 rounded-xl bg-proxmox-dark/50">
                                        <div className={`text-xl font-bold ${cluster.onlineNodes === cluster.nodeCount ? 'text-green-400' : 'text-yellow-400'}`}>
                                            {cluster.onlineNodes}/{cluster.nodeCount}
                                        </div>
                                        <div className="text-[10px] text-gray-500 uppercase mt-1">{t('nodes')}</div>
                                    </div>
                                    
                                    {/* CPU */}
                                    <div className="text-center p-3 rounded-xl bg-proxmox-dark/50">
                                        <div className="flex flex-col items-center gap-1">
                                            <CircularProgress value={cluster.avgCpu} size={44} strokeWidth={4} color={cluster.avgCpu > 80 ? '#ef4444' : cluster.avgCpu > 60 ? '#eab308' : '#22c55e'} />
                                            <Sparkline data={cluster.cpuHistory} color={cluster.avgCpu > 80 ? '#ef4444' : '#22c55e'} height={14} width={40} />
                                        </div>
                                        <div className="text-[10px] text-gray-500 uppercase mt-1">CPU</div>
                                    </div>
                                    
                                    {/* RAM */}
                                    <div className="text-center p-3 rounded-xl bg-proxmox-dark/50">
                                        <div className="flex flex-col items-center gap-1">
                                            <CircularProgress value={cluster.avgMem} size={44} strokeWidth={4} color={cluster.avgMem > 80 ? '#ef4444' : cluster.avgMem > 60 ? '#eab308' : '#3b82f6'} />
                                            <Sparkline data={cluster.ramHistory} color={cluster.avgMem > 80 ? '#ef4444' : '#3b82f6'} height={14} width={40} />
                                        </div>
                                        <div className="text-[10px] text-gray-500 uppercase mt-1">RAM</div>
                                    </div>
                                    
                                    {/* Storage */}
                                    <div className="text-center p-3 rounded-xl bg-proxmox-dark/50">
                                        <div className="flex justify-center">
                                            <CircularProgress value={cluster.avgStorage} size={44} strokeWidth={4} color={cluster.avgStorage > 80 ? '#ef4444' : cluster.avgStorage > 60 ? '#eab308' : '#8b5cf6'} />
                                        </div>
                                        <div className="text-[10px] text-gray-500 uppercase mt-1">{t('storage') || 'Disk'}</div>
                                    </div>
                                    
                                    {/* VMs */}
                                    <div className="text-center p-3 rounded-xl bg-proxmox-dark/50">
                                        <div className="text-xl font-bold">
                                            <span className="text-green-400">{cluster.runningVms}</span>
                                            <span className="text-gray-500 text-sm">/{cluster.totalVms}</span>
                                        </div>
                                        <div className="text-[10px] text-gray-500 uppercase mt-1">{t('vms')}</div>
                                    </div>
                                </div>
                            ) : (
                                <div className="flex items-center justify-center h-20 text-gray-500 text-sm">
                                    <Icons.AlertTriangle className="w-4 h-4 mr-2" />
                                    {t('noDataAvailable') || 'No data available'}
                                </div>
                            )}
                            
                            {/* Footer */}
                            <div className="mt-4 pt-3 border-t border-proxmox-border/50 flex items-center justify-between">
                                <span className="text-xs text-gray-500">
                                    {t('updated') || 'Updated'}: {formatLastUpdate(cluster.lastUpdate)}
                                </span>
                                <Icons.ArrowRight className="w-4 h-4 text-gray-500 group-hover:text-proxmox-orange transition-colors" />
                            </div>
                        </div>
                    </div>
                );
            };
            
            return (
                <div className="space-y-6">
                    {/* Header */}
                    <div className="relative overflow-hidden bg-gradient-to-r from-proxmox-card via-proxmox-dark to-proxmox-card border border-proxmox-border rounded-2xl p-6">
                        <div className="absolute inset-0 bg-gradient-to-r from-proxmox-orange/5 via-transparent to-blue-500/5" />
                        <div className="relative flex items-center justify-between flex-wrap gap-4">
                            <div className="flex items-center gap-4">
                                <div className="w-14 h-14 rounded-xl bg-gradient-to-br from-proxmox-orange to-orange-600 flex items-center justify-center shadow-lg shadow-orange-500/20">
                                    <Icons.Grid className="w-7 h-7 text-white" />
                                </div>
                                <div>
                                    <h1 className="text-2xl font-bold text-white">{t('allClustersOverview') || 'All Clusters Overview'}</h1>
                                    <p className="text-gray-400 text-sm">{t('multiClusterSummary') || 'Summary of all managed clusters'}</p>
                                </div>
                            </div>
                            
                            <div className="flex items-center gap-3">
                                {/* alerts */}
                                {totals.totalAlerts > 0 && (
                                    <div className="flex items-center gap-2 px-3 py-1.5 bg-red-500/10 border border-red-500/30 rounded-lg">
                                        <Icons.AlertTriangle className="w-4 h-4 text-red-400" />
                                        <span className="text-sm text-red-400 font-medium">{totals.totalAlerts} {t('alerts') || 'Alerts'}</span>
                                    </div>
                                )}
                                
                                {/* Live indicator */}
                                <div className="flex items-center gap-2 px-3 py-1.5 bg-green-500/10 border border-green-500/30 rounded-full">
                                    <div className="w-2 h-2 rounded-full bg-green-500 animate-pulse" />
                                    <span className="text-xs text-green-400 font-medium">Live</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    {/* Stats Grid */}
                    <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-4">
                        {[
                            { icon: Icons.Server, value: `${totals.connectedClusters}/${totals.clusters}`, label: t('clusters'), color: 'proxmox-orange', hoverColor: 'proxmox-orange' },
                            { icon: Icons.Cpu, value: `${totals.onlineNodes}/${totals.totalNodes}`, label: t('nodesOnline') || 'Nodes', color: 'blue-400', hoverColor: 'blue-500' },
                            { icon: Icons.Play, value: totals.runningVms, label: t('vmsRunning') || 'Running', color: 'green-400', hoverColor: 'green-500', valueColor: 'text-green-400' },
                            { icon: Icons.Square, value: totals.totalVms - totals.runningVms, label: t('vmsStopped') || 'Stopped', color: 'gray-400', hoverColor: 'gray-500' },
                        ].map((stat, i) => (
                            <div key={i} className={`bg-gradient-to-br from-proxmox-card to-proxmox-dark border border-proxmox-border rounded-xl p-4 hover:border-${stat.hoverColor}/30 transition-all group`}>
                                <div className="flex items-center gap-3">
                                    <div className={`w-10 h-10 rounded-lg bg-${stat.color}/20 flex items-center justify-center group-hover:scale-110 transition-transform`}>
                                        <stat.icon className={`w-5 h-5 text-${stat.color}`} />
                                    </div>
                                    <div>
                                        <div className={`text-xl font-bold ${stat.valueColor || 'text-white'}`}>{stat.value}</div>
                                        <div className="text-xs text-gray-500">{stat.label}</div>
                                    </div>
                                </div>
                            </div>
                        ))}
                        
                        {/* circular gauges */}
                        {[
                            { value: totals.avgCpu, label: 'CPU', color: totals.avgCpu > 80 ? '#ef4444' : totals.avgCpu > 60 ? '#eab308' : '#22c55e' },
                            { value: totals.avgMem, label: 'RAM', color: totals.avgMem > 80 ? '#ef4444' : totals.avgMem > 60 ? '#eab308' : '#3b82f6' },
                            { value: totals.avgStorage, label: t('storage') || 'Disk', color: totals.avgStorage > 80 ? '#ef4444' : totals.avgStorage > 60 ? '#eab308' : '#8b5cf6' },
                        ].map((stat, i) => (
                            <div key={i} className="bg-gradient-to-br from-proxmox-card to-proxmox-dark border border-proxmox-border rounded-xl p-4 hover:border-proxmox-border transition-all">
                                <div className="flex items-center gap-3">
                                    <CircularProgress value={stat.value || 0} size={44} strokeWidth={4} color={stat.color} />
                                    <div>
                                        <div className="text-sm font-bold text-white">{stat.label}</div>
                                        <div className="text-xs text-gray-500">{t('average') || 'Avg'}</div>
                                    </div>
                                </div>
                            </div>
                        ))}
                    </div>
                    
                    {/* Sort Controls */}
                    <div className="flex items-center justify-between">
                        <div className="flex items-center gap-2 flex-wrap">
                            <span className="text-sm text-gray-500 mr-1">{t('sortBy') || 'Sort by'}:</span>
                            <SortButton field="name" label={t('name') || 'Name'} />
                            <SortButton field="health" label={t('health') || 'Health'} />
                            <SortButton field="nodes" label={t('nodes') || 'Nodes'} />
                            <SortButton field="vms" label="VMs" />
                            <SortButton field="cpu" label="CPU" />
                            <SortButton field="ram" label="RAM" />
                        </div>
                    </div>
                    
                    {/* Grouped Clusters */}
                    {Object.values(groupedClusters).map(({ group, clusters: groupClusters }) => (
                        <div key={group.id} className="space-y-4">
                            <div className="flex items-center gap-3 px-1">
                                <div className="w-4 h-4 rounded" style={{ backgroundColor: group.color || '#E86F2D' }} />
                                <h3 className="text-base font-semibold text-white">{group.name}</h3>
                                <span className="text-sm text-gray-500">({groupClusters.length} {t('clusters')})</span>
                            </div>
                            <div className="grid grid-cols-1 lg:grid-cols-2 gap-4">
                                {groupClusters.map(cluster => <ClusterCard key={cluster.id} cluster={cluster} />)}
                            </div>
                        </div>
                    ))}
                    
                    {/* Ungrouped Clusters */}
                    {ungroupedClusters.length > 0 && (
                        <div className="space-y-4">
                            {Object.keys(groupedClusters).length > 0 && (
                                <div className="flex items-center gap-3 px-1">
                                    <Icons.Folder className="w-4 h-4 text-gray-500" />
                                    <h3 className="text-base font-semibold text-white">{t('ungrouped') || 'Ungrouped'}</h3>
                                    <span className="text-sm text-gray-500">({ungroupedClusters.length})</span>
                                </div>
                            )}
                            <div className="grid grid-cols-1 lg:grid-cols-2 gap-4">
                                {ungroupedClusters.map(cluster => <ClusterCard key={cluster.id} cluster={cluster} />)}
                            </div>
                        </div>
                    )}
                    
                    {/* top vms table */}
                    {topGuests.length > 0 && (
                        <div className="bg-proxmox-card border border-proxmox-border rounded-xl overflow-hidden">
                            <div className="p-4 border-b border-proxmox-border flex items-center justify-between">
                                <div className="flex items-center gap-3">
                                    <div className="w-10 h-10 rounded-lg bg-cyan-500/20 flex items-center justify-center">
                                        <Icons.Activity className="w-5 h-5 text-cyan-400" />
                                    </div>
                                    <div>
                                        <h3 className="font-semibold text-white">{t('topResources') || 'Top Resources'}</h3>
                                        <p className="text-xs text-gray-500">{t('highestCpuUsage') || 'Highest CPU and RAM usage across all clusters'}</p>
                                    </div>
                                </div>
                                <span className="text-xs text-gray-500 bg-proxmox-dark px-2 py-1 rounded">Top 10</span>
                            </div>
                            <div className="overflow-x-auto">
                                <table className="w-full">
                                    <thead className="bg-proxmox-dark/50">
                                        <tr className="text-left text-xs text-gray-400">
                                            <th className="px-4 py-3 font-medium">{t('type')}</th>
                                            <th className="px-4 py-3 font-medium">{t('name')}</th>
                                            <th className="px-4 py-3 font-medium">{t('cluster')}</th>
                                            <th className="px-4 py-3 font-medium">{t('node')}</th>
                                            <th className="px-4 py-3 font-medium">CPU</th>
                                            <th className="px-4 py-3 font-medium">RAM</th>
                                            <th className="px-4 py-3 font-medium">{t('status')}</th>
                                            <th className="px-4 py-3 w-10"></th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-proxmox-border/50">
                                        {topGuests.map((guest, idx) => {
                                            const cpuPercent = ((guest.cpu || 0) * 100).toFixed(1);
                                            const memPercent = guest.maxmem > 0 ? ((guest.mem / guest.maxmem) * 100).toFixed(1) : 0;
                                            const isVM = guest.type === 'qemu';
                                            const guestCluster = clusters.find(c => c.id === guest.cluster_id);
                                            
                                            return (
                                                <tr 
                                                    key={`${guest.cluster_id}-${guest.vmid}`} 
                                                    className="hover:bg-proxmox-hover/50 transition-colors cursor-pointer group"
                                                    onClick={() => {
                                                        if (guestCluster && onSelectVm) {
                                                            onSelectVm(guestCluster, guest.vmid, guest.node);
                                                        }
                                                    }}
                                                    title={t('clickToOpenVm') || 'Click to open VM'}
                                                >
                                                    <td className="px-4 py-3">
                                                        <div className={`w-8 h-8 rounded-lg flex items-center justify-center ${isVM ? 'bg-blue-500/20' : 'bg-purple-500/20'}`}>
                                                            {isVM ? (
                                                                <Icons.Monitor className="w-4 h-4 text-blue-400" />
                                                            ) : (
                                                                <Icons.Layers className="w-4 h-4 text-purple-400" />
                                                            )}
                                                        </div>
                                                    </td>
                                                    <td className="px-4 py-3">
                                                        <div className="font-medium text-white group-hover:text-proxmox-orange transition-colors">{guest.name || `VM ${guest.vmid}`}</div>
                                                        <div className="text-xs text-gray-500">ID: {guest.vmid}</div>
                                                    </td>
                                                    <td className="px-4 py-3">
                                                        <span className="text-sm text-gray-300">{guest.cluster_name}</span>
                                                    </td>
                                                    <td className="px-4 py-3">
                                                        <span className="text-sm text-gray-400">{guest.node}</span>
                                                    </td>
                                                    <td className="px-4 py-3">
                                                        <div className="flex items-center gap-2">
                                                            <div className="w-16 h-2 bg-proxmox-dark rounded-full overflow-hidden">
                                                                <div 
                                                                    className={`h-full rounded-full transition-all ${cpuPercent > 80 ? 'bg-red-500' : cpuPercent > 60 ? 'bg-yellow-500' : 'bg-green-500'}`}
                                                                    style={{ width: `${Math.min(cpuPercent, 100)}%` }}
                                                                />
                                                            </div>
                                                            <span className={`text-xs font-medium ${cpuPercent > 80 ? 'text-red-400' : cpuPercent > 60 ? 'text-yellow-400' : 'text-green-400'}`}>
                                                                {cpuPercent}%
                                                            </span>
                                                        </div>
                                                    </td>
                                                    <td className="px-4 py-3">
                                                        <div className="flex items-center gap-2">
                                                            <div className="w-16 h-2 bg-proxmox-dark rounded-full overflow-hidden">
                                                                <div 
                                                                    className={`h-full rounded-full transition-all ${memPercent > 80 ? 'bg-red-500' : memPercent > 60 ? 'bg-yellow-500' : 'bg-blue-500'}`}
                                                                    style={{ width: `${Math.min(memPercent, 100)}%` }}
                                                                />
                                                            </div>
                                                            <span className="text-xs text-gray-400">{memPercent}%</span>
                                                        </div>
                                                    </td>
                                                    <td className="px-4 py-3">
                                                        <span className={`inline-flex items-center gap-1.5 px-2 py-0.5 rounded-full text-xs font-medium ${
                                                            guest.status === 'running' ? 'bg-green-500/20 text-green-400' : 'bg-gray-500/20 text-gray-400'
                                                        }`}>
                                                            <div className={`w-1.5 h-1.5 rounded-full ${guest.status === 'running' ? 'bg-green-400' : 'bg-gray-400'}`} />
                                                            {guest.status === 'running' ? t('running') : t('stopped')}
                                                        </span>
                                                    </td>
                                                    <td className="px-4 py-3">
                                                        <Icons.ArrowRight className="w-4 h-4 text-gray-500 group-hover:text-proxmox-orange transition-colors" />
                                                    </td>
                                                </tr>
                                            );
                                        })}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    )}
                    
                    {/* Empty State */}
                    {clusters.length === 0 && (
                        <div className="bg-proxmox-card border border-proxmox-border rounded-xl p-12 text-center">
                            <div className="w-16 h-16 mx-auto mb-4 rounded-2xl bg-gradient-to-br from-proxmox-orange/20 to-orange-600/20 flex items-center justify-center">
                                <Icons.Server className="w-8 h-8 text-proxmox-orange" />
                            </div>
                            <h3 className="text-lg font-semibold text-white mb-2">{t('noClustersConfigured') || 'No clusters configured'}</h3>
                            <p className="text-gray-500 text-sm">{t('addClusterToStart') || 'Add a cluster to get started'}</p>
                        </div>
                    )}
                </div>
            );
        }

        // Cluster Health Widget
        function ClusterHealth({ metrics }) {
            const { t } = useTranslation();
            const nodes = Object.entries(metrics);
            if (nodes.length === 0) return null;

            const avgCpu = nodes.reduce((acc, [, m]) => acc + m.cpu_percent, 0) / nodes.length;
            const avgMem = nodes.reduce((acc, [, m]) => acc + m.mem_percent, 0) / nodes.length;
            const avgScore = nodes.reduce((acc, [, m]) => acc + m.score, 0) / nodes.length;
            const onlineNodes = nodes.filter(([, m]) => m.status === 'online' && !m.maintenance_mode).length;
            const maintenanceNodes = nodes.filter(([, m]) => m.maintenance_mode).length;

            const healthScore = Math.max(0, 100 - (avgScore / 2));
            const healthLabel = healthScore >= 80 ? t('excellent') : healthScore >= 60 ? t('good') : healthScore >= 40 ? t('warning') : t('critical');
            const healthColor = healthScore >= 80 ? '#22c55e' : healthScore >= 60 ? '#84cc16' : healthScore >= 40 ? '#eab308' : '#ef4444';

            return (
                <div className="bg-proxmox-card border border-proxmox-border rounded-xl p-5">
                    <h3 className="text-sm font-semibold text-gray-400 uppercase tracking-wider mb-4">{t('clusterHealth')}</h3>
                    
                    <div className="flex items-center justify-center mb-6">
                        <div className="relative">
                            <svg viewBox="0 0 100 100" className="w-32 h-32">
                                <circle cx="50" cy="50" r="45" fill="none" stroke="#30363D" strokeWidth="8" />
                                <circle 
                                    cx="50" 
                                    cy="50" 
                                    r="45" 
                                    fill="none" 
                                    stroke={healthColor}
                                    strokeWidth="8"
                                    strokeLinecap="round"
                                    strokeDasharray={`${healthScore * 2.83} 283`}
                                    transform="rotate(-90 50 50)"
                                    className="transition-all duration-1000"
                                />
                            </svg>
                            <div className="absolute inset-0 flex flex-col items-center justify-center">
                                <span className="text-2xl font-bold text-white">{healthScore.toFixed(0)}</span>
                                <span className="text-xs text-gray-400">{healthLabel}</span>
                            </div>
                        </div>
                    </div>

                    <div className="grid grid-cols-2 gap-4">
                        <div className="text-center">
                            <div className="text-2xl font-bold text-white">{onlineNodes}/{nodes.length}</div>
                            <div className="text-xs text-gray-500">{t('nodesOnline')}</div>
                        </div>
                        <div className="text-center">
                            <div className="text-2xl font-bold text-white">{avgScore.toFixed(0)}</div>
                            <div className="text-xs text-gray-500">{t('avgScore')}</div>
                        </div>
                        <div className="text-center">
                            <div className="text-2xl font-bold text-white">{avgCpu.toFixed(1)}%</div>
                            <div className="text-xs text-gray-500">{t('avgCpu')}</div>
                        </div>
                        <div className="text-center">
                            <div className="text-2xl font-bold text-white">{avgMem.toFixed(1)}%</div>
                            <div className="text-xs text-gray-500">{t('avgRam')}</div>
                        </div>
                    </div>

                    {maintenanceNodes > 0 && (
                        <div className="mt-4 pt-4 border-t border-proxmox-border">
                            <div className="flex items-center justify-center gap-2 text-yellow-400">
                                <Icons.Wrench />
                                <span className="text-sm font-medium">{maintenanceNodes} Node(s) {t('maintenance')}</span>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // Create Snapshot Modal
        function CreateSnapshotModal({ isQemu, onSubmit, onClose, loading }) {
            const { t } = useTranslation();
            const [snapname, setSnapname] = useState(`snap_${Date.now()}`);
            const [description, setDescription] = useState('');
            const [vmstate, setVmstate] = useState(false);

            const handleSubmit = () => {
                if (!snapname.trim()) return;
                onSubmit(snapname.trim(), description, vmstate);
            };

            return (
                <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/60">
                    <div className="w-full max-w-md bg-proxmox-card border border-proxmox-border rounded-xl p-6 animate-scale-in">
                        <h3 className="text-lg font-semibold text-white mb-4">{t('createSnapshot')}</h3>
                        <div className="space-y-4">
                            <div>
                                <label className="block text-sm text-gray-400 mb-1">{t('name')}</label>
                                <input
                                    type="text"
                                    value={snapname}
                                    onChange={(e) => setSnapname(e.target.value)}
                                    className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white"
                                    placeholder="snapshot-name"
                                />
                            </div>
                            <div>
                                <label className="block text-sm text-gray-400 mb-1">{t('description')} ({t('optional')})</label>
                                <input
                                    type="text"
                                    value={description}
                                    onChange={(e) => setDescription(e.target.value)}
                                    className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white"
                                    placeholder={t('snapshotDescription')}
                                />
                            </div>
                            {isQemu && (
                                <label className="flex items-center gap-2 text-sm text-gray-300">
                                    <input
                                        type="checkbox"
                                        checked={vmstate}
                                        onChange={(e) => setVmstate(e.target.checked)}
                                        className="rounded"
                                    />
                                    {t('saveRamState')}
                                </label>
                            )}
                        </div>
                        <div className="flex justify-end gap-3 mt-6">
                            <button onClick={onClose} className="px-4 py-2 text-gray-300 hover:text-white">
                                {t('cancel')}
                            </button>
                            <button
                                onClick={handleSubmit}
                                disabled={loading || !snapname.trim()}
                                className="flex items-center gap-2 px-4 py-2 bg-green-600 rounded-lg text-white hover:bg-green-700 disabled:opacity-50"
                            >
                                {loading && <Icons.RotateCw />}
                                {t('create')}
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        // Create Replication Modal
        function CreateReplicationModal({ nodes, onSubmit, onClose, loading }) {
            const { t } = useTranslation();
            const [target, setTarget] = useState(nodes[0] || '');
            const [schedule, setSchedule] = useState('*/15');
            const [rate, setRate] = useState('');
            const [comment, setComment] = useState('');

            const scheduleOptions = [
                { value: '*/5', label: t('every5min') },
                { value: '*/15', label: t('every15min') },
                { value: '*/30', label: t('every30min') },
                { value: '0 *', label: t('hourly') },
                { value: '0 */2', label: t('every2hours') },
                { value: '0 */4', label: t('every4hours') },
                { value: '0 */6', label: t('every6hours') },
                { value: '0 */12', label: t('every12hours') },
                { value: '0 0', label: t('daily') },
            ];

            const handleSubmit = () => {
                if (!target) return;
                onSubmit(target, schedule, rate ? parseInt(rate) : null, comment);
            };

            return (
                <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/60">
                    <div className="w-full max-w-md bg-proxmox-card border border-proxmox-border rounded-xl p-6 animate-scale-in">
                        <h3 className="text-lg font-semibold text-white mb-4">{t('createReplicationJob')}</h3>
                        <div className="space-y-4">
                            <div>
                                <label className="block text-sm text-gray-400 mb-1">{t('targetNode')}</label>
                                <select
                                    value={target}
                                    onChange={(e) => setTarget(e.target.value)}
                                    className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white"
                                >
                                    {nodes.map(n => <option key={n} value={n}>{n}</option>)}
                                </select>
                            </div>
                            <div>
                                <label className="block text-sm text-gray-400 mb-1">Schedule</label>
                                <select
                                    value={schedule}
                                    onChange={(e) => setSchedule(e.target.value)}
                                    className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white"
                                >
                                    {scheduleOptions.map(opt => (
                                        <option key={opt.value} value={opt.value}>{opt.label}</option>
                                    ))}
                                </select>
                            </div>
                            <div>
                                <label className="block text-sm text-gray-400 mb-1">{t('rateLimit')} ({t('optional')})</label>
                                <input
                                    type="number"
                                    value={rate}
                                    onChange={(e) => setRate(e.target.value)}
                                    className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white"
                                    placeholder={t('unlimited')}
                                    min="1"
                                />
                            </div>
                            <div>
                                <label className="block text-sm text-gray-400 mb-1">{t('comment')} ({t('optional')})</label>
                                <input
                                    type="text"
                                    value={comment}
                                    onChange={(e) => setComment(e.target.value)}
                                    className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white"
                                    placeholder={t('commentPlaceholder')}
                                />
                            </div>
                        </div>
                        <div className="flex justify-end gap-3 mt-6">
                            <button onClick={onClose} className="px-4 py-2 text-gray-300 hover:text-white">
                                {t('cancel')}
                            </button>
                            <button
                                onClick={handleSubmit}
                                disabled={loading || !target}
                                className="flex items-center gap-2 px-4 py-2 bg-green-600 rounded-lg text-white hover:bg-green-700 disabled:opacity-50"
                            >
                                {loading && <Icons.RotateCw />}
                                {t('create')}
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        // Shared form components (defined outside ConfigModal to prevent re-creation)
        // ns: could use a form library but this is fine for now
        const ConfigInputField = ({ label, value, onChange, type = 'text', disabled = false, suffix = '', options = null, placeholder = '', needsRestart = false }) => (
            <div>
                <label className="block text-xs font-medium text-gray-400 mb-1">
                    {label}
                    {needsRestart && <span className="ml-2 text-[10px] px-1.5 py-0.5 bg-red-500/20 text-red-400 rounded font-medium">RESTART</span>}
                </label>
                {options ? (
                    <select
                        value={value}
                        onChange={e => onChange(e.target.value)}
                        disabled={disabled}
                        className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white text-sm focus:outline-none focus:border-proxmox-orange disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                        {options.map(opt => (
                            <option key={typeof opt === 'string' ? opt : opt.value} value={typeof opt === 'string' ? opt : opt.value}>
                                {typeof opt === 'string' ? opt : opt.label}
                            </option>
                        ))}
                    </select>
                ) : (
                    <div className="relative">
                        <input
                            type={type}
                            value={value}
                            onChange={e => onChange(type === 'number' ? +e.target.value : e.target.value)}
                            disabled={disabled}
                            placeholder={placeholder}
                            className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white text-sm focus:outline-none focus:border-proxmox-orange disabled:opacity-50 disabled:cursor-not-allowed"
                        />
                        {suffix && (
                            <span className="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 text-sm">{suffix}</span>
                        )}
                    </div>
                )}
            </div>
        );

        // checkbox version
        const ConfigCheckboxField = ({ label, checked, onChange, disabled = false, needsRestart = false, t }) => (
            <label className="flex items-center gap-3 cursor-pointer">
                <input
                    type="checkbox"
                    checked={checked}
                    onChange={e => onChange(e.target.checked ? 1 : 0)}
                    disabled={disabled}
                    className="w-4 h-4 rounded border-proxmox-border bg-proxmox-dark text-proxmox-orange focus:ring-proxmox-orange"
                />
                <span className="text-sm text-gray-300">{label}</span>
                {needsRestart && <span className="text-[10px] px-1.5 py-0.5 bg-red-500/20 text-red-400 rounded font-medium">{t ? t('needsRestart') : 'RESTART'}</span>}
            </label>
        );

        // LW: Memory input with MB/GB unit selector - makes it easier to set RAM values
        const MemoryInputField = ({ label, value, onChange, disabled = false, needsRestart = false, minMB = 128, stepMB = 128 }) => {
            // value is always in MB internally
            const [unit, setUnit] = useState(value >= 1024 ? 'GB' : 'MB');
            
            const displayValue = unit === 'GB' ? (value / 1024) : value;
            const step = unit === 'GB' ? 0.5 : stepMB;
            const min = unit === 'GB' ? (minMB / 1024) : minMB;
            
            const handleValueChange = (newValue) => {
                // Convert back to MB for storage
                const mbValue = unit === 'GB' ? Math.round(newValue * 1024) : newValue;
                onChange(mbValue);
            };
            
            const handleUnitChange = (newUnit) => {
                setUnit(newUnit);
                // Value stays the same in MB, just display changes
            };
            
            return (
                <div>
                    <label className="block text-xs font-medium text-gray-400 mb-1">
                        {label}
                        {needsRestart && <span className="ml-2 text-[10px] px-1.5 py-0.5 bg-red-500/20 text-red-400 rounded font-medium">RESTART</span>}
                    </label>
                    <div className="flex gap-2">
                        <input
                            type="number"
                            value={displayValue}
                            onChange={e => handleValueChange(parseFloat(e.target.value) || 0)}
                            min={min}
                            step={step}
                            disabled={disabled}
                            className="flex-1 px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white text-sm focus:outline-none focus:border-proxmox-orange disabled:opacity-50"
                        />
                        <select
                            value={unit}
                            onChange={e => handleUnitChange(e.target.value)}
                            disabled={disabled}
                            className="w-20 px-2 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white text-sm focus:outline-none focus:border-proxmox-orange"
                        >
                            <option value="MB">MB</option>
                            <option value="GB">GB</option>
                        </select>
                    </div>
                    <p className="text-xs text-gray-500 mt-1">
                        {unit === 'MB' ? `${(value / 1024).toFixed(1)} GB` : `${value} MB`}
                    </p>
                </div>
            );
        };

        // VM/Container Config Modal
        // LW: This is the big one - handles all VM/CT configuration
        // Tabs: General, Hardware (disks/NICs), Options, Snapshots, Replication
        // Sep 2025: Major refactor to support both QEMU and LXC properly
        function ConfigModal({ vm, clusterId, onClose, addToast }) {
            const { t } = useTranslation();
            const { getAuthHeaders } = useAuth();
            const [config, setConfig] = useState(null);
            const [configError, setConfigError] = useState(null);  // MK: Track config load errors
            const [loading, setLoading] = useState(true);
            const [saving, setSaving] = useState(false);
            const [activeTab, setActiveTab] = useState('general');
            const [changes, setChanges] = useState({});
            const [hasChanges, setHasChanges] = useState(false);
            
            // Additional states for hardware options and lists
            const [hardwareOptions, setHardwareOptions] = useState(null);
            const [storageList, setStorageList] = useState([]);
            const [bridgeList, setBridgeList] = useState([]);
            const [isoList, setIsoList] = useState([]);
            
            // Snapshot states
            const [snapshots, setSnapshots] = useState([]);
            const [snapshotLoading, setSnapshotLoading] = useState(false);
            const [showCreateSnapshot, setShowCreateSnapshot] = useState(false);
            
            // Replication states
            const [replications, setReplications] = useState([]);
            
            // NS: Backup states - Dec 2025
            const [vmBackups, setVmBackups] = useState([]);
            const [backupLoading, setBackupLoading] = useState(false);
            const [showCreateBackup, setShowCreateBackup] = useState(false);
            const [showRestoreBackup, setShowRestoreBackup] = useState(null);
            
            // MK: History states - Jan 2026
            const [vmProxmoxTasks, setVmProxmoxTasks] = useState([]);
            const [vmPegaproxActions, setVmPegaproxActions] = useState([]);
            const [historyLoading, setHistoryLoading] = useState(false);
            const [historySubTab, setHistorySubTab] = useState('proxmox');
            
            // Local authFetch helper
            const authFetch = async (url, options = {}) => {
                try {
                    const response = await fetch(url, {
                        ...options,
                        credentials: 'include',
                        headers: {
                            ...options.headers,
                            ...getAuthHeaders()
                        }
                    });
                    return response;
                } catch (err) {
                    console.error('Auth fetch error:', err);
                    return null;
                }
            };
            const [replicationLoading, setReplicationLoading] = useState(false);
            const [showCreateReplication, setShowCreateReplication] = useState(false);
            const [clusterNodes, setClusterNodes] = useState([]);
            const [allClusterNodes, setAllClusterNodes] = useState([]);
            
            // Modal states for sub-dialogs
            const [showAddDisk, setShowAddDisk] = useState(false);
            const [showAddNetwork, setShowAddNetwork] = useState(false);
            const [showEditNetwork, setShowEditNetwork] = useState(null);
            const [showMoveDisk, setShowMoveDisk] = useState(null);
            const [showResizeDisk, setShowResizeDisk] = useState(null);
            const [showEditDisk, setShowEditDisk] = useState(null);  // NS: Edit disk bus type
            const [showReattachDisk, setShowReattachDisk] = useState(null);  // MK: Reattach unused disk modal
            const [showMountISO, setShowMountISO] = useState(false);
            const [showImportDisk, setShowImportDisk] = useState(false);  // MK: Import disk from storage
            const [showReassignOwner, setShowReassignOwner] = useState(null);  // MK: Reassign disk to another VM
            const [importableDisks, setImportableDisks] = useState([]);  // MK: List of importable disk images
            
            // PCI/USB/Serial Passthrough states
            const [passthrough, setPassthrough] = useState({ pci: [], usb: [], serial: [] });
            const [availablePci, setAvailablePci] = useState([]);
            const [availableUsb, setAvailableUsb] = useState([]);
            const [showAddPci, setShowAddPci] = useState(false);
            const [showAddUsb, setShowAddUsb] = useState(false);
            const [showAddSerial, setShowAddSerial] = useState(false);
            const [showAddEfiDisk, setShowAddEfiDisk] = useState(false);  // NS: EFI Disk modal
            const [showAddTpm, setShowAddTpm] = useState(false);          // NS: TPM modal
            const [efiStorage, setEfiStorage] = useState('');             // NS: Selected storage for EFI
            const [tpmStorage, setTpmStorage] = useState('');             // NS: Selected storage for TPM
            const [selectedPciDevice, setSelectedPciDevice] = useState(null);
            const [selectedUsbDevice, setSelectedUsbDevice] = useState(null);
            const [pciOptions, setPciOptions] = useState({ pcie: true, rombar: true });
            const [usbOptions, setUsbOptions] = useState({ usb3: false });
            const [serialType, setSerialType] = useState('socket');
            const [passthroughLoading, setPassthroughLoading] = useState(false);

            const isQemu = vm.type === 'qemu';

            useEffect(() => {
                fetchConfig();
                fetchHardwareOptions();
                fetchStorageList();
                fetchBridgeList();
                if (isQemu) {
                    fetchISOList();
                    fetchPassthrough();
                }
                fetchSnapshots();
                fetchReplications();
                fetchBackups();
                fetchClusterNodes();
            }, [vm, clusterId]);

            // MK: Auto-fetch history when history tab is selected
            useEffect(() => {
                if (activeTab === 'history') {
                    fetchHistory();
                }
            }, [activeTab]);

            const fetchPassthrough = async () => {
                if (vm.type !== 'qemu') return;
                try {
                    // Fetch current passthrough config
                    const ptRes = await authFetch(`${API_URL}/clusters/${clusterId}/vms/${vm.node}/qemu/${vm.vmid}/passthrough`);
                    if (ptRes && ptRes.ok) {
                        setPassthrough(await ptRes.json());
                    }
                    
                    // Fetch available PCI devices
                    const pciRes = await authFetch(`${API_URL}/clusters/${clusterId}/nodes/${vm.node}/hardware/pci`);
                    if (pciRes && pciRes.ok) {
                        setAvailablePci(await pciRes.json());
                    }
                    
                    // Fetch available USB devices
                    const usbRes = await authFetch(`${API_URL}/clusters/${clusterId}/nodes/${vm.node}/hardware/usb`);
                    if (usbRes && usbRes.ok) {
                        setAvailableUsb(await usbRes.json());
                    }
                } catch (error) {
                    console.error('to load passthrough:', error);
                }
            };

            const handleAddPciDevice = async () => {
                if (!selectedPciDevice) return;
                setPassthroughLoading(true);
                try {
                    const response = await authFetch(`${API_URL}/clusters/${clusterId}/vms/${vm.node}/qemu/${vm.vmid}/passthrough/pci`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            device_id: selectedPciDevice.id,
                            pcie: pciOptions.pcie,
                            rombar: pciOptions.rombar
                        })
                    });
                    if (response && response.ok) {
                        setShowAddPci(false);
                        setSelectedPciDevice(null);
                        fetchPassthrough();
                        addToast(t('deviceAdded'));
                    }else{
                        const err = await response.json();
                        addToast(err.error || t('operationFailed'), 'error');
                    }
                } catch (error) {
                    addToast(t('connectionError'), 'error');
                }
                setPassthroughLoading(false);
            };

            const handleAddUsbDevice = async () => {
                if (!selectedUsbDevice) return;
                setPassthroughLoading(true);
                try {
                    const response = await authFetch(`${API_URL}/clusters/${clusterId}/vms/${vm.node}/qemu/${vm.vmid}/passthrough/usb`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            vendorid: selectedUsbDevice.vendid,
                            productid: selectedUsbDevice.prodid,
                            usb3: usbOptions.usb3
                        })
                    });
                    if (response && response.ok) {
                        setShowAddUsb(false);
                        setSelectedUsbDevice(null);
                        fetchPassthrough();
                        addToast(t('deviceAdded'));
                    }else{
                        const err = await response.json();
                        addToast(err.error || t('operationFailed'), 'error');
                    }
                } catch (error) {
                    addToast(t('connectionError'), 'error');
                }
                setPassthroughLoading(false);
            };

            const handleAddSerialPort = async () => {
                setPassthroughLoading(true);
                try {
                    const response = await authFetch(`${API_URL}/clusters/${clusterId}/vms/${vm.node}/qemu/${vm.vmid}/passthrough/serial`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ type: serialType })
                    });
                    if (response && response.ok) {
                        setShowAddSerial(false);
                        fetchPassthrough();
                        addToast(t('deviceAdded'));
                    }else{
                        const err = await response.json();
                        addToast(err.error || t('operationFailed'), 'error');
                    }
                } catch (error) {
                    addToast(t('connectionError'), 'error');
                }
                setPassthroughLoading(false);
            };

            const handleRemovePassthrough = async (type, key) => {
                if (!confirm(`${key} ${t('remove')}?`)) return;
                setPassthroughLoading(true);
                try {
                    const response = await authFetch(
                        `${API_URL}/clusters/${clusterId}/vms/${vm.node}/qemu/${vm.vmid}/passthrough/${type}/${key}`,
                        { method: 'DELETE' }
                    );
                    if (response && response.ok) {
                        fetchPassthrough();
                        addToast(t('deviceRemoved'));
                    }else{
                        addToast(t('operationFailed'), 'error');
                    }
                } catch (error) {
                    addToast(t('connectionError'), 'error');
                }
                setPassthroughLoading(false);
            };

            const fetchConfig = async (retryCount = 0) => {
                setLoading(true);
                try {
                    const response = await authFetch(
                        `${API_URL}/clusters/${clusterId}/vms/${vm.node}/${vm.type}/${vm.vmid}/config`
                    );
                    if (response && response.ok) {
                        const data = await response.json();
                        setConfig(data);
                        setConfigError(null);  // LW: Clear any previous error
                    } else if (response) {
                        // MK: API returned error status
                        const errText = await response.text();
                        setConfigError(t('configLoadError') || 'Could not load configuration');
                        console.error('Config load failed:', errText);
                    }
                } catch (error) {
                    console.error('Failed to load config:', error);
                    // LW: Retry up to 2 times with increasing delay
                    if (retryCount < 2) {
                        setTimeout(() => fetchConfig(retryCount + 1), 1000 * (retryCount + 1));
                        return;
                    }
                    setConfigError(t('configLoadError') || 'Could not load configuration');
                }
                setLoading(false);
            };

            const fetchHardwareOptions = async () => {
                try {
                    const response = await authFetch(`${API_URL}/hardware-options`);
                    if (response && response.ok) {
                        setHardwareOptions(await response.json());
                    }
                } catch (error) {
                    console.error('to load hardware options:', error);
                }
            };

            const fetchStorageList = async () => {
                try {
                    const response = await authFetch(`${API_URL}/clusters/${clusterId}/nodes/${vm.node}/storage`);
                    if (response && response.ok) {
                        setStorageList(await response.json());
                    }
                } catch (error) {
                    console.error('to load storage list:', error);
                }
            };

            const fetchBridgeList = async () => {
                try {
                    const response = await authFetch(`${API_URL}/clusters/${clusterId}/nodes/${vm.node}/networks`);
                    if (response && response.ok) {
                        setBridgeList(await response.json());
                    }
                } catch (error) {
                    console.error('to load bridge list:', error);
                }
            };

            const fetchISOList = async () => {
                try {
                    const response = await authFetch(`${API_URL}/clusters/${clusterId}/nodes/${vm.node}/isos`);
                    if (response && response.ok) {
                        setIsoList(await response.json());
                    }
                } catch (error) {
                    console.error('to load ISO list:', error);
                }
            };

            const fetchSnapshots = async () => {
                try {
                    const response = await authFetch(`${API_URL}/clusters/${clusterId}/vms/${vm.node}/${vm.type}/${vm.vmid}/snapshots`);
                    if (response && response.ok) {
                        setSnapshots(await response.json());
                    }
                } catch (error) {
                    console.error('to load snapshots:', error);
                }
            };

            const fetchReplications = async () => {
                try {
                    const response = await authFetch(`${API_URL}/clusters/${clusterId}/replication?vmid=${vm.vmid}`);
                    if (response && response.ok) {
                        setReplications(await response.json());
                    }
                } catch (error) {
                    console.error('to load replications:', error);
                }
            };
            
            // NS: Fetch backups for this VM
            const fetchBackups = async () => {
                setBackupLoading(true);
                try {
                    const response = await authFetch(`${API_URL}/clusters/${clusterId}/vms/${vm.node}/${vm.type}/${vm.vmid}/backups`);
                    if (response && response.ok) {
                        setVmBackups(await response.json());
                    }
                } catch (error) {
                    console.error('failed to load backups:', error);
                } finally {
                    setBackupLoading(false);
                }
            };

            // MK: Fetch VM History (Proxmox Tasks + PegaProx Audit)
            const fetchHistory = async () => {
                setHistoryLoading(true);
                try {
                    // Fetch Proxmox tasks for this VM
                    const tasksRes = await authFetch(`${API_URL}/clusters/${clusterId}/nodes/${vm.node}/tasks?vmid=${vm.vmid}&limit=50`);
                    if (tasksRes && tasksRes.ok) {
                        setVmProxmoxTasks(await tasksRes.json());
                    }
                    
                    // Fetch PegaProx audit log for this VM
                    const auditRes = await authFetch(`${API_URL}/clusters/${clusterId}/audit?vmid=${vm.vmid}&limit=50`);
                    if (auditRes && auditRes.ok) {
                        setVmPegaproxActions(await auditRes.json());
                    }
                } catch (error) {
                    console.error('Failed to load history:', error);
                } finally {
                    setHistoryLoading(false);
                }
            };

            const fetchClusterNodes = async () => {
                try {
                    const response = await authFetch(`${API_URL}/clusters/${clusterId}/metrics`);
                    if (response && response.ok) {
                        const metrics = await response.json();
                        const allNodes = Object.keys(metrics);
                        setAllClusterNodes(allNodes);
                        setClusterNodes(allNodes.filter(n => n !== vm.node));
                    }
                } catch (error) {
                    console.error('to load cluster nodes:', error);
                }
            };

            // Snapshot operations
            const handleCreateSnapshot = async (snapname, description, vmstate) => {
                setSnapshotLoading(true);
                try {
                    const response = await authFetch(
                        `${API_URL}/clusters/${clusterId}/vms/${vm.node}/${vm.type}/${vm.vmid}/snapshots`,
                        {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ snapname, description, vmstate })
                        }
                    );
                    if (response && response.ok) {
                        addToast(`${t('snapshotCreated') || 'Snapshot created'}: '${snapname}'`);
                        setShowCreateSnapshot(false);
                        await fetchSnapshots();
                    } else if (response) {
                        const err = await response.json();
                        addToast(err.error || t('snapshotFailed'), 'error');
                    }
                } catch (error) {
                    addToast(t('connectionError'), 'error');
                }
                setSnapshotLoading(false);
            };

            // NS: quick confirm before delete, then refresh list
            const handleDeleteSnapshot = async (snapname) => {
                if (!confirm(`${t('confirmDelete')} '${snapname}'?`)) return;
                setSnapshotLoading(true);
                try {
                    const response = await authFetch(
                        `${API_URL}/clusters/${clusterId}/vms/${vm.node}/${vm.type}/${vm.vmid}/snapshots/${snapname}`,
                        { method: 'DELETE' }
                    );
                    if (response?.ok) {
                        addToast(t('snapshotDeleted'));
                        await fetchSnapshots();
                    } else if (response) {
                        const err = await response.json();
                        addToast(err.error || t('deleteFailed'), 'error');
                    }
                } catch (error) {
                    addToast(t('connectionError'), 'error');
                }
                setSnapshotLoading(false);
            };

            const handleRollbackSnapshot = async (snapname) => {
                if (!confirm(`${snapname}: ${t('rollbackConfirm')}`)) return;
                setSnapshotLoading(true);
                try {
                    const response = await authFetch(
                        `${API_URL}/clusters/${clusterId}/vms/${vm.node}/${vm.type}/${vm.vmid}/snapshots/${snapname}/rollback`,
                        { method: 'POST' }
                    );
                    if (response && response.ok) {
                        addToast(`${t('rollbackStarted') || 'Rollback started'}: '${snapname}'`);
                    } else if (response) {
                        const err = await response.json();
                        addToast(err.error || t('rollbackFailed'), 'error');
                    }
                } catch (error) {
                    addToast(t('connectionError'), 'error');
                }
                setSnapshotLoading(false);
            };
            
            // NS: Backup operations - Dec 2025
            // finally got around to implementing this, been on the TODO list forever
            const handleCreateBackup = async (storage, mode, compress, notes) => {
                setBackupLoading(true);
                try {
                    const response = await authFetch(
                        `${API_URL}/clusters/${clusterId}/vms/${vm.node}/${vm.type}/${vm.vmid}/backups/create`,
                        {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ storage, mode, compress, notes })
                        }
                    );
                    if (response && response.ok) {
                        addToast(t('backupStarted') || 'Backup started');
                        setShowCreateBackup(false);
                        // TODO: maybe auto-refresh backup list after a delay?
                    } else if (response) {
                        const err = await response.json();
                        addToast(err.error || 'Backup failed', 'error');
                    }
                } catch (error) {
                    addToast(t('connectionError'), 'error');
                }
                setBackupLoading(false);
            };
            
            const handleRestoreBackup = async (volid, targetVmid, storage, startAfter) => {
                // LW: confirmation before restore - learned this the hard way lol
                if (!confirm(t('confirmRestore') || `Really restore this backup? ${targetVmid === vm.vmid ? 'VM will be overwritten!' : ''}`)) return;
                
                setBackupLoading(true);
                try {
                    const response = await authFetch(
                        `${API_URL}/clusters/${clusterId}/vms/${vm.node}/${vm.type}/${vm.vmid}/backups/restore`,
                        {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ volid, target_vmid: targetVmid, storage, start: startAfter })
                        }
                    );
                    if (response && response.ok) {
                        const result = await response.json();
                        addToast(t('restoreStarted') || `Restore started (VMID: ${result.vmid})`);
                        setShowRestoreBackup(null);
                    } else if (response) {
                        const err = await response.json();
                        addToast(err.error || 'Restore failed', 'error');
                    }
                } catch (error) {
                    addToast(t('connectionError'), 'error');
                }
                setBackupLoading(false);
            };
            
            const handleDeleteBackup = async (volid) => {
                if (!confirm(t('confirmDeleteBackup') || 'Really delete this backup?')) return;
                
                setBackupLoading(true);
                try {
                    const response = await authFetch(
                        `${API_URL}/clusters/${clusterId}/vms/${vm.node}/${vm.type}/${vm.vmid}/backups/${encodeURIComponent(volid)}`,
                        { method: 'DELETE' }
                    );
                    if (response && response.ok) {
                        addToast(t('backupDeleted') || 'Backup deleted');
                        await fetchBackups();
                    } else if (response) {
                        const err = await response.json();
                        addToast(err.error || 'Delete failed', 'error');
                    }
                } catch (error) {
                    addToast(t('connectionError'), 'error');
                }
                setBackupLoading(false);
            };

            // Replication operations
            const handleCreateReplication = async (target, schedule, rate, comment) => {
                setReplicationLoading(true);
                try {
                    const response = await authFetch(
                        `${API_URL}/clusters/${clusterId}/replication`,
                        {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ vmid: vm.vmid, target, schedule, rate, comment })
                        }
                    );
                    if (response && response.ok) {
                        addToast(t('replicationCreated'), 'success');
                        setShowCreateReplication(false);
                        await fetchReplications();
                    } else if (response) {
                        const err = await response.json();
                        addToast(err.error || 'Creation failed', 'error');
                    }
                } catch (error) {
                    addToast(t('connectionError'), 'error');
                }
                setReplicationLoading(false);
            };

            const handleDeleteReplication = async (jobId) => {
                if (!confirm(t('confirmDeleteReplication') || `Really delete replication job '${jobId}'?`)) return;
                setReplicationLoading(true);
                try {
                    const response = await authFetch(
                        `${API_URL}/clusters/${clusterId}/replication/${jobId}`,
                        { method: 'DELETE' }
                    );
                    if (response && response.ok) {
                        addToast(t('replicationDeleted'), 'success');
                        await fetchReplications();
                    } else if (response) {
                        const err = await response.json();
                        addToast(err.error || 'Delete failed', 'error');
                    }
                } catch(error) {
                    addToast(t('connectionError'), 'error');
                }
                setReplicationLoading(false);
            };

            const handleRunReplicationNow = async (jobId) => {
                setReplicationLoading(true);
                try {
                    const response = await authFetch(
                        `${API_URL}/clusters/${clusterId}/replication/${jobId}/run`,
                        { method: 'POST' }
                    );
                    if (response && response.ok) {
                        addToast(t('replicationStarted'), 'success');
                    } else if (response) {
                        const err = await response.json();
                        addToast(err.error || t('startFailed'), 'error');
                    }
                } catch(error) {
                    addToast(t('connectionError'), 'error');
                }
                setReplicationLoading(false);
            };

            const handleChange = (section, key, value) => {
                setChanges(prev => ({
                    ...prev,
                    [key]: value
                }));
                setHasChanges(true);
            };

            const handleSave = async () => {
                if (Object.keys(changes).length === 0) return;
                
                setSaving(true);
                try {
                    const response = await authFetch(
                        `${API_URL}/clusters/${clusterId}/vms/${vm.node}/${vm.type}/${vm.vmid}/config`,
                        {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(changes)
                        }
                    );
                    
                    if (response && response.ok) {
                        addToast(t('configSaved'), 'success');
                        setChanges({});
                        setHasChanges(false);
                        await fetchConfig();
                    } else {
                        const err = await response.json();
                        addToast(err.error || t('saveFailed'), 'error');
                    }
                } catch(error) {
                    addToast(t('connectionError'), 'error');
                }
                setSaving(false);
            };

            // Disk operations - LW: refactored this like 3 times, finally happy with it
            // NS: Just don't touch the size parsing, that took forever to get right
            const handleAddDisk = async (diskConfig) => {
                try {
                    const response = await authFetch(
                        `${API_URL}/clusters/${clusterId}/vms/${vm.node}/${vm.type}/${vm.vmid}/disks`,
                        {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(diskConfig)
                        }
                    );
                    if (response && response.ok) {
                        addToast(t('diskAdded') || 'Disk added');
                        setShowAddDisk(false);
                        // MK: Small delay to allow Proxmox to allocate the disk
                        await new Promise(resolve => setTimeout(resolve, 500));
                        await fetchConfig();
                    } else if (response) {
                        const err = await response.json();
                        addToast(err.error || t('error'), 'error');
                    }
                } catch(error) {
                    addToast(t('connectionError'), 'error');
                }
            };

            const handleRemoveDisk = async (diskId) => {
                if (!confirm(`${t('removeDiskConfirm') || 'Really remove disk'} ${diskId}? ${t('dataWillBeDeleted') || 'Data will be permanently deleted!'}`)) return;
                try {
                    const response = await authFetch(
                        `${API_URL}/clusters/${clusterId}/vms/${vm.node}/${vm.type}/${vm.vmid}/disks/${diskId}?delete_data=true`,
                        { method: 'DELETE' }
                    );
                    if (response && response.ok) {
                        addToast(t('diskDeleted') || 'Disk deleted');
                        await fetchConfig();
                    } else if (response) {
                        const err = await response.json();
                        addToast(err.error || t('error'), 'error');
                    }
                } catch(error) {
                    addToast(t('connectionError'), 'error');
                }
            };

            // MK: Detach disk - removes from VM but keeps as unused
            const handleDetachDisk = async (diskId) => {
                if (!confirm(`${t('detachDiskConfirm') || 'Really detach disk?'} ${diskId}`)) return;
                try {
                    const response = await authFetch(
                        `${API_URL}/clusters/${clusterId}/vms/${vm.node}/${vm.type}/${vm.vmid}/disks/${diskId}`,
                        { method: 'DELETE' }
                    );
                    if (response && response.ok) {
                        addToast(t('diskDetached') || 'Disk detached');
                        await fetchConfig();
                    } else if (response) {
                        const err = await response.json();
                        addToast(err.error || t('error'), 'error');
                    }
                } catch(error) {
                    addToast(t('connectionError'), 'error');
                }
            };

            const handleResizeDisk = async (diskId, newSize) => {
                try {
                    const response = await authFetch(
                        `${API_URL}/clusters/${clusterId}/vms/${vm.node}/${vm.type}/${vm.vmid}/resize`,
                        {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ disk: diskId, size: newSize })
                        }
                    );
                    if (response && response.ok) {
                        addToast('Festplatte vergroessert');
                        setShowResizeDisk(null);
                        await fetchConfig();
                    } else if (response) {
                        const err = await response.json();
                        addToast(err.error || t('error'), 'error');
                    }
                } catch(error) {
                    addToast(t('connectionError'), 'error');
                }
            };

            const handleMoveDisk = async (diskId, targetStorage) => {
                try {
                    const response = await authFetch(
                        `${API_URL}/clusters/${clusterId}/vms/${vm.node}/${vm.type}/${vm.vmid}/disks/${diskId}/move`,
                        {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ storage: targetStorage })
                        }
                    );
                    if (response && response.ok) {
                        addToast(t('moveStarted') || 'Move started');
                        setShowMoveDisk(null);
                        await fetchConfig();
                    } else if (response) {
                        const err = await response.json();
                        addToast(err.error || t('error'), 'error');
                    }
                } catch(error) {
                    addToast(t('connectionError'), 'error');
                }
            };

            // CD-ROM operations
            const handleMountISO = async (isoPath, drive = 'ide2') => {
                try {
                    const response = await authFetch(
                        `${API_URL}/clusters/${clusterId}/vms/${vm.node}/qemu/${vm.vmid}/cdrom`,
                        {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ iso: isoPath, drive: drive })
                        }
                    );
                    if (response && response.ok) {
                        addToast(isoPath ? `ISO auf ${drive} eingebunden` : `${drive} ausgeworfen`);
                        setShowMountISO(false);
                        await fetchConfig();
                    } else if (response) {
                        const err = await response.json();
                        addToast(err.error || t('error'), 'error');
                    }
                } catch(error) {
                    addToast(t('connectionError'), 'error');
                }
            };

            // Network operations
            const handleAddNetwork = async (netConfig) => {
                try {
                    const response = await authFetch(
                        `${API_URL}/clusters/${clusterId}/vms/${vm.node}/${vm.type}/${vm.vmid}/networks`,
                        {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(netConfig)
                        }
                    );
                    if (response && response.ok) {
                        addToast(t('vmNetworkAdded'));
                        setShowAddNetwork(false);
                        await fetchConfig();
                    } else if (response) {
                        const err = await response.json();
                        addToast(err.error || t('error'), 'error');
                    }
                } catch(error) {
                    addToast(t('connectionError'), 'error');
                }
            };

            const handleUpdateNetwork = async (netId, netConfig) => {
                try {
                    const response = await authFetch(
                        `${API_URL}/clusters/${clusterId}/vms/${vm.node}/${vm.type}/${vm.vmid}/networks/${netId}`,
                        {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(netConfig)
                        }
                    );
                    if (response && response.ok) {
                        addToast(t('vmNetworkUpdated'));
                        setShowEditNetwork(null);
                        await fetchConfig();
                    } else if (response) {
                        const err = await response.json();
                        addToast(err.error || t('error'), 'error');
                    }
                } catch(error) {
                    addToast(t('connectionError'), 'error');
                }
            };

            const handleRemoveNetwork = async (netId) => {
                if (!confirm(`${t('removeNetworkConfirm') || 'Really remove network'} ${netId}?`)) return;
                try {
                    const response = await authFetch(
                        `${API_URL}/clusters/${clusterId}/vms/${vm.node}/${vm.type}/${vm.vmid}/networks/${netId}`,
                        { method: 'DELETE' }
                    );
                    if (response && response.ok) {
                        addToast(t('vmNetworkRemoved'));
                        await fetchConfig();
                    } else if (response) {
                        const err = await response.json();
                        addToast(err.error || t('error'), 'error');
                    }
                } catch(error) {
                    addToast(t('connectionError'), 'error');
                }
            };

            // LW: Toggle network link_down state (simulates cable unplug)
            const handleToggleNetworkLink = async (netId, currentLinkDown) => {
                try {
                    const newLinkDown = !currentLinkDown;
                    const response = await authFetch(
                        `${API_URL}/clusters/${clusterId}/vms/${vm.node}/${vm.type}/${vm.vmid}/networks/${netId}/link`,
                        {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ link_down: newLinkDown })
                        }
                    );
                    if (response && response.ok) {
                        addToast(newLinkDown ? t('networkDisconnected') : t('connectNetwork'), newLinkDown ? 'warning' : 'success');
                        await fetchConfig();
                    } else if (response) {
                        const err = await response.json();
                        addToast(err.error || t('error'), 'error');
                    }
                } catch(error) {
                    addToast(t('connectionError'), 'error');
                }
            };

            // Helper functions
            const generateMAC = () => {
                const hex = '0123456789ABCDEF';
                let mac = '02';
                for (let i = 0; i < 5; i++) {
                    mac += ':' + hex[Math.floor(Math.random() * 16)] + hex[Math.floor(Math.random() * 16)];
                }
                return mac;
            };

            const getNextDiskId = (busType = 'scsi') => {
                const existing = config?.disks?.filter(d => d.id.startsWith(busType)).map(d => parseInt(d.id.replace(busType, ''))) || [];
                for (let i = 0; i < 30; i++) {
                    if (!existing.includes(i)) return `${busType}${i}`;
                }
                return `${busType}0`;
            };

            const getNextNetId = () => {
                const existing = config?.networks?.map(n => parseInt(n.id.replace('net', ''))) || [];
                for (let i = 0; i < 10; i++) {
                    if (!existing.includes(i)) return `net${i}`;
                }
                return 'net0';
            };

            const getValue = (section, key) => {
                if (key in changes) return changes[key];
                // Try parsed section first, then raw config as fallback
                const parsedValue = config?.[section]?.[key];
                if (parsedValue !== undefined && parsedValue !== '') return parsedValue;
                // Fallback to raw config
                return config?.raw?.[key] ?? '';
            };

            const tabs = isQemu
                ? [
                    { id: 'general', labelKey: 'generalTab', icon: Icons.Server },
                    { id: 'hardware', labelKey: 'hardware', icon: Icons.Cpu },
                    { id: 'disks', labelKey: 'disks', icon: Icons.HardDrive },
                    { id: 'network', labelKey: 'networkTab', icon: Icons.Network },
                    { id: 'snapshots', labelKey: 'snapshotsTab', icon: Icons.Clock },
                    { id: 'backups', labelKey: 'backupsTab', icon: Icons.Database },
                    { id: 'replication', labelKey: 'replicationTab', icon: Icons.RefreshCw },
                    { id: 'history', labelKey: 'historyTab', icon: Icons.List },
                    { id: 'options', labelKey: 'optionsTab', icon: Icons.Settings },
                ]
                : [
                    { id: 'general', labelKey: 'generalTab', icon: Icons.Server },
                    { id: 'resources', labelKey: 'resourcesTab', icon: Icons.Cpu },
                    { id: 'disks', labelKey: 'storageTab', icon: Icons.HardDrive },
                    { id: 'network', labelKey: 'networkTab', icon: Icons.Network },
                    { id: 'snapshots', labelKey: 'snapshotsTab', icon: Icons.Clock },
                    { id: 'backups', labelKey: 'backupsTab', icon: Icons.Database },
                    { id: 'replication', labelKey: 'replicationTab', icon: Icons.RefreshCw },
                    { id: 'history', labelKey: 'historyTab', icon: Icons.List },
                    { id: 'options', labelKey: 'optionsTab', icon: Icons.Settings },
                ];

            return(
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop bg-black/80">
                    <div className="w-full max-w-4xl max-h-[90vh] bg-proxmox-card border border-proxmox-border rounded-2xl shadow-2xl animate-scale-in overflow-hidden flex flex-col">
                        {/* Header */}
                        <div className="flex items-center justify-between px-6 py-4 border-b border-proxmox-border bg-proxmox-dark">
                            <div className="flex items-center gap-3">
                                <div className={`p-2 rounded-lg ${isQemu ? 'bg-blue-500/10' : 'bg-purple-500/10'}`}>
                                    {isQemu ? <Icons.VM /> : <Icons.Container />}
                                </div>
                                <div>
                                    <h2 className="font-semibold text-white">{vm.name || `${isQemu ? 'VM' : 'CT'} ${vm.vmid}`}</h2>
                                    <p className="text-xs text-gray-400">
                                        {isQemu ? 'QEMU Virtual Machine' : 'LXC Container'} ¬∑ ID {vm.vmid} ¬∑ {vm.node}
                                    </p>
                                </div>
                            </div>
                            <div className="flex items-center gap-2">
                                {hasChanges && (
                                    <span className="text-xs text-yellow-400 bg-yellow-500/10 px-2 py-1 rounded">
                                        {t('unsavedChanges') || 'Unsaved Changes'}
                                    </span>
                                )}
                                <button
                                    onClick={onClose}
                                    className="p-2 rounded-lg hover:bg-red-500/20 text-gray-400 hover:text-red-400 transition-colors"
                                >
                                    <Icons.X />
                                </button>
                            </div>
                        </div>

                        {/* Tabs */}
                        <div className="flex items-center gap-1 px-6 py-3 border-b border-proxmox-border bg-proxmox-dark/50 overflow-x-auto">
                            {tabs.map(tab => (
                                <button
                                    key={tab.id}
                                    onClick={() => setActiveTab(tab.id)}
                                    className={`flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium transition-all whitespace-nowrap ${
                                        activeTab === tab.id
                                            ? 'bg-proxmox-orange text-white'
                                            : 'text-gray-400 hover:text-white hover:bg-proxmox-hover'
                                    }`}
                                >
                                    <tab.icon />
                                    {t(tab.labelKey)}
                                </button>
                            ))}
                        </div>

                        {/* Content */}
                        <div className="flex-1 overflow-y-auto p-6">
                            {loading ? (
                                <div className="flex items-center justify-center h-64">
                                    <div className="animate-spin w-8 h-8 border-2 border-proxmox-orange border-t-transparent rounded-full"></div>
                                </div>
                            ) : configError ? (
                                /* MK: Show error when config fails to load */
                                <div className="flex flex-col items-center justify-center h-64 text-center">
                                    <Icons.AlertTriangle className="w-12 h-12 text-red-400 mb-4" />
                                    <p className="text-red-400 font-medium mb-2">{configError}</p>
                                    <p className="text-gray-500 text-sm mb-4">{t('checkConnectionAndRetry') || 'Please check your connection and try again.'}</p>
                                    <button 
                                        onClick={() => { setConfigError(null); fetchConfig(); }}
                                        className="px-4 py-2 bg-proxmox-orange rounded-lg text-white hover:bg-orange-600 flex items-center gap-2"
                                    >
                                        <Icons.RotateCw className="w-4 h-4" />
                                        {t('retry') || 'Retry'}
                                    </button>
                                </div>
                            ) : config ? (
                                <>
                                    {/* General Tab */}
                                    {activeTab === 'general' && (
                                        <div className="space-y-6">
                                            <div className="grid grid-cols-2 gap-4">
                                                <ConfigInputField
                                                    label={isQemu ? t('name') : t('hostname')}
                                                    value={getValue('general', isQemu ? 'name' : 'hostname')}
                                                    onChange={(v) => handleChange('general', isQemu ? 'name' : 'hostname', v)}
                                                />
                                                <ConfigInputField
                                                    label={t('tags')}
                                                    value={getValue('general', 'tags')}
                                                    onChange={(v) => handleChange('general', 'tags', v)}
                                                />
                                            </div>
                                            <div>
                                                <label className="block text-xs font-medium text-gray-400 mb-1">{t('description')}</label>
                                                <textarea
                                                    value={getValue('general', 'description')}
                                                    onChange={(e) => handleChange('general', 'description', e.target.value)}
                                                    rows={3}
                                                    className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white text-sm focus:outline-none focus:border-proxmox-orange resize-none"
                                                />
                                            </div>
                                            {config.status && (
                                                <div className="grid grid-cols-3 gap-4 p-4 bg-proxmox-dark rounded-lg">
                                                    <div>
                                                        <div className="text-xs text-gray-500">{t('status')}</div>
                                                        <div className={`font-medium ${config.status.status === 'running' ? 'text-green-400' : 'text-red-400'}`}>
                                                            {config.status.status === 'running' ? t('running') : t('stopped')}
                                                        </div>
                                                    </div>
                                                    <div>
                                                        <div className="text-xs text-gray-500">{t('cpuUsage')}</div>
                                                        <div className="font-medium text-white">{((config.status.cpu || 0) * 100).toFixed(1)}%</div>
                                                    </div>
                                                    <div>
                                                        <div className="text-xs text-gray-500">{t('ramUsage')}</div>
                                                        <div className="font-medium text-white">
                                                            {((config.status.mem || 0) / 1073741824).toFixed(1)} GB
                                                        </div>
                                                    </div>
                                                </div>
                                            )}
                                            
                                            {/* Lock Warning and Unlock Button */}
                                            {config.lock?.locked && (
                                                <div className="p-4 bg-yellow-500/10 border border-yellow-500/30 rounded-lg">
                                                    <div className="flex items-center justify-between">
                                                        <div className="flex items-center gap-2">
                                                            <Icons.AlertTriangle className="text-yellow-400" />
                                                            <div>
                                                                <div className="text-yellow-400 font-medium">{t('vmLocked')}</div>
                                                                <div className="text-xs text-yellow-300/70">{config.lock?.description || config.lock?.reason || 'Locked'}</div>
                                                            </div>
                                                        </div>
                                                        <button
                                                            onClick={async () => {
                                                                try {
                                                                    const response = await authFetch(`${API_URL}/clusters/${clusterId}/vms/${vm.node}/${vm.type}/${vm.vmid}/unlock`, {
                                                                        method: 'POST'
                                                                    });
                                                                    if (response && response.ok) {
                                                                        addToast(t('vmUnlocked'), 'success');
                                                                        fetchConfig(); // Reload config
                                                                    } else {
                                                                        const err = await response.json();
                                                                        addToast(err.error || t('deleteFailed'), 'error');
                                                                    }
                                                                } catch(e) {
                                                                    addToast(t('connectionError'), 'error');
                                                                }
                                                            }}
                                                            className="px-3 py-1.5 bg-yellow-500/20 hover:bg-yellow-500/30 border border-yellow-500/30 rounded-lg text-yellow-400 text-sm font-medium transition-colors"
                                                        >
                                                            {t('unlockVm')}
                                                        </button>
                                                    </div>
                                                    <div className="mt-2 text-xs text-gray-500">
                                                        CLI: <code className="text-green-400">{config.lock?.unlock_command}</code>
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    )}

                                    {/* Hardware/Resources Tab */}
                                    {(activeTab === 'hardware' || activeTab === 'resources') && (
                                        <div className="space-y-6">
                                            <div className="grid grid-cols-2 gap-4">
                                                <ConfigInputField
                                                    label={t('cpuCores')}
                                                    type="number"
                                                    value={getValue('hardware', 'cores')}
                                                    onChange={(v) => handleChange('hardware', 'cores', v)}
                                                    needsRestart={vm.status === 'running'}
                                                />
                                                {isQemu && (
                                                    <ConfigInputField
                                                        label={t('sockets')}
                                                        type="number"
                                                        value={getValue('hardware', 'sockets')}
                                                        onChange={(v) => handleChange('hardware', 'sockets', v)}
                                                        needsRestart={true}
                                                    />
                                                )}
                                                {!isQemu && (
                                                    <ConfigInputField
                                                        label={t('cpuLimit')}
                                                        type="number"
                                                        value={getValue('hardware', 'cpulimit')}
                                                        onChange={(v) => handleChange('hardware', 'cpulimit', v)}
                                                        suffix={t('cores')}
                                                    />
                                                )}
                                            </div>
                                            <div className="grid grid-cols-2 gap-4">
                                                <MemoryInputField
                                                    label={t('memory')}
                                                    value={getValue('hardware', 'memory') || 2048}
                                                    onChange={(v) => handleChange('hardware', 'memory', v)}
                                                    minMB={128}
                                                    stepMB={128}
                                                    needsRestart={vm.status === 'running'}
                                                />
                                                {isQemu ? (
                                                    <MemoryInputField
                                                        label={t('ballooningMinimum')}
                                                        value={getValue('hardware', 'balloon') || 0}
                                                        onChange={(v) => handleChange('hardware', 'balloon', v)}
                                                        minMB={0}
                                                        stepMB={128}
                                                    />
                                                ) : (
                                                    <MemoryInputField
                                                        label={t('swap')}
                                                        value={getValue('hardware', 'swap') || 512}
                                                        onChange={(v) => handleChange('hardware', 'swap', v)}
                                                        minMB={0}
                                                        stepMB={64}
                                                    />
                                                )}
                                            </div>
                                            {isQemu && (
                                                <>
                                                    <div className="grid grid-cols-2 gap-4">
                                                        <ConfigInputField
                                                            label={t('cpuType')}
                                                            value={getValue('hardware', 'cpu')}
                                                            onChange={(v) => handleChange('hardware', 'cpu', v)}
                                                            options={hardwareOptions?.cpu_types || ['host', 'kvm64', 'qemu64']}
                                                            needsRestart={true}
                                                        />
                                                        <ConfigInputField
                                                            label="VGA"
                                                            value={getValue('hardware', 'vga')}
                                                            onChange={(v) => handleChange('hardware', 'vga', v)}
                                                            options={[
                                                                { value: 'std', label: 'Standard VGA' },
                                                                { value: 'virtio', label: 'VirtIO-GPU' },
                                                                { value: 'virtio-gl', label: 'VirtIO-GPU (virgl)' },
                                                                { value: 'qxl', label: 'SPICE (QXL)' },
                                                                { value: 'vmware', label: 'VMware compatible' },
                                                                { value: 'cirrus', label: 'Cirrus Logic' },
                                                                { value: 'none', label: t('none') },
                                                            ]}
                                                            needsRestart={true}
                                                        />
                                                    </div>
                                                    <div className="grid grid-cols-2 gap-4">
                                                        <ConfigInputField
                                                            label="BIOS"
                                                            value={getValue('hardware', 'bios')}
                                                            onChange={(v) => handleChange('hardware', 'bios', v)}
                                                            options={[
                                                                { value: 'seabios', label: 'SeaBIOS (Legacy)' },
                                                                { value: 'ovmf', label: 'OVMF (UEFI)' },
                                                            ]}
                                                            needsRestart={true}
                                                        />
                                                        <ConfigInputField
                                                            label={t('scsiController')}
                                                            value={getValue('hardware', 'scsihw')}
                                                            onChange={(v) => handleChange('hardware', 'scsihw', v)}
                                                            options={hardwareOptions?.scsi_controllers || [
                                                                { value: 'virtio-scsi-pci', label: 'VirtIO SCSI' },
                                                                { value: 'virtio-scsi-single', label: 'VirtIO SCSI Single' },
                                                                { value: 'lsi', label: 'LSI 53C895A' },
                                                            ]}
                                                            needsRestart={true}
                                                        />
                                                    </div>
                                                    <div className="grid grid-cols-2 gap-4">
                                                        <ConfigInputField
                                                            label={t('machineType')}
                                                            value={getValue('hardware', 'machine')}
                                                            onChange={(v) => handleChange('hardware', 'machine', v)}
                                                            options={hardwareOptions?.machine_types || [
                                                                { value: '', label: t('default') },
                                                                // q35 versions
                                                                { value: 'q35', label: 'q35 (Latest)' },
                                                                { value: 'pc-q35-10.1', label: 'q35 10.1' },
                                                                { value: 'pc-q35-10.0+pve1', label: 'q35 10.0+pve1' },
                                                                { value: 'pc-q35-10.0', label: 'q35 10.0' },
                                                                { value: 'pc-q35-9.2+pve1', label: 'q35 9.2+pve1' },
                                                                { value: 'pc-q35-9.2', label: 'q35 9.2' },
                                                                { value: 'pc-q35-9.1', label: 'q35 9.1' },
                                                                { value: 'pc-q35-9.0', label: 'q35 9.0' },
                                                                { value: 'pc-q35-8.2', label: 'q35 8.2' },
                                                                { value: 'pc-q35-8.1', label: 'q35 8.1' },
                                                                { value: 'pc-q35-8.0', label: 'q35 8.0' },
                                                                { value: 'pc-q35-7.2', label: 'q35 7.2' },
                                                                { value: 'pc-q35-7.1', label: 'q35 7.1' },
                                                                { value: 'pc-q35-7.0', label: 'q35 7.0' },
                                                                { value: 'pc-q35-6.2', label: 'q35 6.2' },
                                                                { value: 'pc-q35-6.1', label: 'q35 6.1' },
                                                                { value: 'pc-q35-6.0', label: 'q35 6.0' },
                                                                { value: 'pc-q35-5.2', label: 'q35 5.2' },
                                                                { value: 'pc-q35-5.1', label: 'q35 5.1' },
                                                                { value: 'pc-q35-5.0', label: 'q35 5.0' },
                                                                { value: 'pc-q35-4.2', label: 'q35 4.2' },
                                                                { value: 'pc-q35-4.1', label: 'q35 4.1' },
                                                                { value: 'pc-q35-4.0', label: 'q35 4.0' },
                                                                { value: 'pc-q35-3.1', label: 'q35 3.1' },
                                                                { value: 'pc-q35-3.0', label: 'q35 3.0' },
                                                                { value: 'pc-q35-2.12', label: 'q35 2.12' },
                                                                { value: 'pc-q35-2.11', label: 'q35 2.11' },
                                                                { value: 'pc-q35-2.10', label: 'q35 2.10' },
                                                                // i440fx versions
                                                                { value: 'i440fx', label: 'i440fx (Latest)' },
                                                                { value: 'pc-i440fx-10.1', label: 'i440fx 10.1' },
                                                                { value: 'pc-i440fx-10.0+pve1', label: 'i440fx 10.0+pve1' },
                                                                { value: 'pc-i440fx-10.0', label: 'i440fx 10.0' },
                                                                { value: 'pc-i440fx-9.2+pve1', label: 'i440fx 9.2+pve1' },
                                                                { value: 'pc-i440fx-9.2', label: 'i440fx 9.2' },
                                                                { value: 'pc-i440fx-9.1', label: 'i440fx 9.1' },
                                                                { value: 'pc-i440fx-9.0', label: 'i440fx 9.0' },
                                                                { value: 'pc-i440fx-8.2', label: 'i440fx 8.2' },
                                                                { value: 'pc-i440fx-8.1', label: 'i440fx 8.1' },
                                                                { value: 'pc-i440fx-8.0', label: 'i440fx 8.0' },
                                                                { value: 'pc-i440fx-7.2', label: 'i440fx 7.2' },
                                                                { value: 'pc-i440fx-7.1', label: 'i440fx 7.1' },
                                                                { value: 'pc-i440fx-7.0', label: 'i440fx 7.0' },
                                                                { value: 'pc-i440fx-6.2', label: 'i440fx 6.2' },
                                                                { value: 'pc-i440fx-6.1', label: 'i440fx 6.1' },
                                                                { value: 'pc-i440fx-6.0', label: 'i440fx 6.0' },
                                                                { value: 'pc-i440fx-5.2', label: 'i440fx 5.2' },
                                                                { value: 'pc-i440fx-5.1', label: 'i440fx 5.1' },
                                                                { value: 'pc-i440fx-5.0', label: 'i440fx 5.0' },
                                                                { value: 'pc-i440fx-4.2', label: 'i440fx 4.2' },
                                                                { value: 'pc-i440fx-4.1', label: 'i440fx 4.1' },
                                                                { value: 'pc-i440fx-4.0', label: 'i440fx 4.0' },
                                                                { value: 'pc-i440fx-3.1', label: 'i440fx 3.1' },
                                                                { value: 'pc-i440fx-3.0', label: 'i440fx 3.0' },
                                                                { value: 'pc-i440fx-2.12', label: 'i440fx 2.12' },
                                                                { value: 'pc-i440fx-2.11', label: 'i440fx 2.11' },
                                                                { value: 'pc-i440fx-2.10', label: 'i440fx 2.10' },
                                                            ]}
                                                            needsRestart={true}
                                                        />
                                                        {/* LW: vIOMMU for nested virt and GPU passthrough
                                                            MK: Appends to machine string like "q35,viommu=intel" */}
                                                        <ConfigInputField
                                                            label="vIOMMU"
                                                            value={getValue('hardware', 'machine')?.includes('viommu=') ? getValue('hardware', 'machine').split('viommu=')[1]?.split(',')[0] : ''}
                                                            onChange={(v) => {
                                                                const currentMachine = getValue('hardware', 'machine') || '';
                                                                const baseMachine = currentMachine.split(',')[0];
                                                                if (v && v !== 'none') {
                                                                    handleChange('hardware', 'machine', `${baseMachine},viommu=${v}`);
                                                                } else {
                                                                    handleChange('hardware', 'machine', baseMachine);
                                                                }
                                                            }}
                                                            options={[
                                                                { value: '', label: t('default') + ' (None)' },
                                                                { value: 'intel', label: 'Intel (VT-d)' },
                                                                { value: 'virtio', label: 'VirtIO' },
                                                            ]}
                                                            needsRestart={true}
                                                        />
                                                    </div>
                                                    <div className="grid grid-cols-2 gap-4">
                                                        <div className="flex items-center gap-4 pt-2">
                                                            <ConfigCheckboxField
                                                                label={t('enableNuma')}
                                                                checked={getValue('hardware', 'numa') == 1}
                                                                onChange={(v) => handleChange('hardware', 'numa', v)}
                                                                needsRestart={true}
                                                                t={t}
                                                            />
                                                        </div>
                                                        <div></div>
                                                    </div>
                                                    
                                                    {/* EFI Disk & TPM Section - MK: For UEFI and Windows 11 */}
                                                    {getValue('hardware', 'bios') === 'ovmf' && (
                                                        <div className="mt-6 pt-6 border-t border-proxmox-border">
                                                            <h3 className="text-white font-medium mb-4 flex items-center gap-2">
                                                                üîê {t('efiTpmSettings') || 'EFI & TPM Settings'}
                                                                {vm.status === 'running' && (
                                                                    <span className="text-xs text-yellow-400 bg-yellow-500/10 px-2 py-0.5 rounded">
                                                                        {t('changesAfterRestart')}
                                                                    </span>
                                                                )}
                                                            </h3>
                                                            
                                                            {/* EFI Disk */}
                                                            <div className="mb-4">
                                                                <div className="flex justify-between items-center mb-2">
                                                                    <span className="text-sm text-gray-400">{t('efiDisk') || 'EFI Disk'}</span>
                                                                </div>
                                                                {config?.raw?.efidisk0 ? (
                                                                    <div className="p-3 bg-proxmox-dark rounded-lg">
                                                                        <div className="flex items-center justify-between">
                                                                            <div className="flex items-center gap-2">
                                                                                <Icons.HardDrive className="w-4 h-4 text-blue-400" />
                                                                                <span className="text-sm font-mono text-gray-300">{config.raw.efidisk0}</span>
                                                                            </div>
                                                                            <div className="flex items-center gap-2">
                                                                                <span className="text-xs text-green-400 bg-green-500/10 px-2 py-0.5 rounded">{t('configured') || 'Configured'}</span>
                                                                                <button
                                                                                    onClick={async () => {
                                                                                        if (!confirm(t('confirmDeleteEfiDisk') || 'Delete EFI disk? This may prevent the VM from booting.')) return;
                                                                                        try {
                                                                                            const res = await fetch(`${API_URL}/clusters/${clusterId}/vms/${vm.node}/${vm.type}/${vm.vmid}/config`, {
                                                                                                method: 'PUT',
                                                                                                credentials: 'include',
                                                                                                headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
                                                                                                body: JSON.stringify({ delete: 'efidisk0' })
                                                                                            });
                                                                                            if (res.ok) {
                                                                                                addToast(t('efiDiskDeleted') || 'EFI disk deleted', 'success');
                                                                                                fetchConfig();
                                                                                            } else {
                                                                                                const err = await res.json();
                                                                                                addToast(err.error || 'Error deleting EFI disk', 'error');
                                                                                            }
                                                                                        } catch (e) {
                                                                                            addToast('Error deleting EFI disk', 'error');
                                                                                        }
                                                                                    }}
                                                                                    className="text-xs px-2 py-1 text-red-400 hover:bg-red-500/20 rounded"
                                                                                    title={t('delete')}
                                                                                >
                                                                                    <Icons.Trash className="w-3.5 h-3.5" />
                                                                                </button>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                ) : (
                                                                    <div className="p-3 bg-proxmox-dark rounded-lg border border-dashed border-proxmox-border">
                                                                        <div className="flex items-center justify-between">
                                                                            <span className="text-sm text-gray-500">{t('noEfiDisk') || 'No EFI disk configured'}</span>
                                                                            <button
                                                                                onClick={() => setShowAddEfiDisk(true)}
                                                                                className="text-xs px-3 py-1.5 bg-blue-500/20 text-blue-400 rounded hover:bg-blue-500/30 flex items-center gap-1"
                                                                            >
                                                                                <Icons.Plus className="w-3 h-3" />
                                                                                {t('addEfiDisk') || 'Add EFI Disk'}
                                                                            </button>
                                                                        </div>
                                                                        <p className="text-xs text-gray-600 mt-2">{t('efiDiskRequired') || 'Required for UEFI boot. Will be created automatically on first boot if not configured.'}</p>
                                                                    </div>
                                                                )}
                                                            </div>
                                                            
                                                            {/* TPM */}
                                                            <div>
                                                                <div className="flex justify-between items-center mb-2">
                                                                    <span className="text-sm text-gray-400">{t('tpmChip') || 'TPM Chip'}</span>
                                                                </div>
                                                                {config?.raw?.tpmstate0 ? (
                                                                    <div className="p-3 bg-proxmox-dark rounded-lg">
                                                                        <div className="flex items-center justify-between">
                                                                            <div className="flex items-center gap-2">
                                                                                <Icons.Shield className="w-4 h-4 text-green-400" />
                                                                                <span className="text-sm font-mono text-gray-300">{config.raw.tpmstate0}</span>
                                                                            </div>
                                                                            <div className="flex items-center gap-2">
                                                                                <span className="text-xs text-green-400 bg-green-500/10 px-2 py-0.5 rounded">TPM 2.0</span>
                                                                                <button
                                                                                    onClick={async () => {
                                                                                        if (!confirm(t('confirmDeleteTpm') || 'Delete TPM? Windows 11 and BitLocker will stop working.')) return;
                                                                                        try {
                                                                                            const res = await fetch(`${API_URL}/clusters/${clusterId}/vms/${vm.node}/${vm.type}/${vm.vmid}/config`, {
                                                                                                method: 'PUT',
                                                                                                credentials: 'include',
                                                                                                headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
                                                                                                body: JSON.stringify({ delete: 'tpmstate0' })
                                                                                            });
                                                                                            if (res.ok) {
                                                                                                addToast(t('tpmDeleted') || 'TPM deleted', 'success');
                                                                                                fetchConfig();
                                                                                            } else {
                                                                                                const err = await res.json();
                                                                                                addToast(err.error || 'Error deleting TPM', 'error');
                                                                                            }
                                                                                        } catch (e) {
                                                                                            addToast('Error deleting TPM', 'error');
                                                                                        }
                                                                                    }}
                                                                                    className="text-xs px-2 py-1 text-red-400 hover:bg-red-500/20 rounded"
                                                                                    title={t('delete')}
                                                                                >
                                                                                    <Icons.Trash className="w-3.5 h-3.5" />
                                                                                </button>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                ) : (
                                                                    <div className="p-3 bg-proxmox-dark rounded-lg border border-dashed border-proxmox-border">
                                                                        <div className="flex items-center justify-between">
                                                                            <span className="text-sm text-gray-500">{t('noTpm') || 'No TPM configured'}</span>
                                                                            <button
                                                                                onClick={() => setShowAddTpm(true)}
                                                                                className="text-xs px-3 py-1.5 bg-green-500/20 text-green-400 rounded hover:bg-green-500/30 flex items-center gap-1"
                                                                            >
                                                                                <Icons.Plus className="w-3 h-3" />
                                                                                {t('addTpm') || 'Add TPM'}
                                                                            </button>
                                                                        </div>
                                                                        <p className="text-xs text-yellow-500 mt-2 flex items-center gap-1">
                                                                            <Icons.AlertTriangle className="w-3 h-3" />
                                                                            {t('win11NeedsTpm') || 'Windows 11 requires TPM 2.0'}
                                                                        </p>
                                                                    </div>
                                                                )}
                                                            </div>
                                                        </div>
                                                    )}
                                                    
                                                    {/* PCI/USB/Serial Passthrough Section */}
                                                    <div className="mt-6 pt-6 border-t border-proxmox-border">
                                                        <h3 className="text-white font-medium mb-4 flex items-center gap-2">
                                                            üîå {t('devicePassthrough')}
                                                            {vm.status === 'running' && (
                                                                <span className="text-xs text-yellow-400 bg-yellow-500/10 px-2 py-0.5 rounded">
                                                                    {t('changesAfterRestart')}
                                                                </span>
                                                            )}
                                                        </h3>
                                                        
                                                        {/* PCI Devices */}
                                                        <div className="mb-4">
                                                            <div className="flex justify-between items-center mb-2">
                                                                <span className="text-sm text-gray-400">{t('pciDevices')}</span>
                                                                <button
                                                                    onClick={() => setShowAddPci(true)}
                                                                    className="text-xs px-2 py-1 bg-proxmox-orange/20 text-proxmox-orange rounded hover:bg-proxmox-orange/30"
                                                                >
                                                                    + {t('addPci')}
                                                                </button>
                                                            </div>
                                                            {passthrough.pci?.length > 0 ? (
                                                                <div className="space-y-1">
                                                                    {passthrough.pci.map((dev, idx) => (
                                                                        <div key={idx} className="flex items-center justify-between p-2 bg-proxmox-dark rounded text-sm">
                                                                            <span className="font-mono text-gray-300">{dev.key}: {dev.value}</span>
                                                                            <button
                                                                                onClick={() => handleRemovePassthrough('pci', dev.key)}
                                                                                className="text-red-400 hover:text-red-300 p-1"
                                                                            >
                                                                                <Icons.Trash className="w-3 h-3" />
                                                                            </button>
                                                                        </div>
                                                                    ))}
                                                                </div>
                                                            ) : (
                                                                <div className="text-xs text-gray-500 italic">{t('noPciDevices')}</div>
                                                            )}
                                                        </div>
                                                        
                                                        {/* USB Devices */}
                                                        <div className="mb-4">
                                                            <div className="flex justify-between items-center mb-2">
                                                                <span className="text-sm text-gray-400">{t('usbDevices')}</span>
                                                                <button
                                                                    onClick={() => setShowAddUsb(true)}
                                                                    className="text-xs px-2 py-1 bg-proxmox-orange/20 text-proxmox-orange rounded hover:bg-proxmox-orange/30"
                                                                >
                                                                    + {t('addUsb')}
                                                                </button>
                                                            </div>
                                                            {passthrough.usb?.length > 0 ? (
                                                                <div className="space-y-1">
                                                                    {passthrough.usb.map((dev, idx) => (
                                                                        <div key={idx} className="flex items-center justify-between p-2 bg-proxmox-dark rounded text-sm">
                                                                            <span className="font-mono text-gray-300">{dev.key}: {dev.value}</span>
                                                                            <button
                                                                                onClick={() => handleRemovePassthrough('usb', dev.key)}
                                                                                className="text-red-400 hover:text-red-300 p-1"
                                                                            >
                                                                                <Icons.Trash className="w-3 h-3" />
                                                                            </button>
                                                                        </div>
                                                                    ))}
                                                                </div>
                                                            ) : (
                                                                <div className="text-xs text-gray-500 italic">{t('noUsbDevices')}</div>
                                                            )}
                                                        </div>
                                                        
                                                        {/* Serial Ports */}
                                                        <div>
                                                            <div className="flex justify-between items-center mb-2">
                                                                <span className="text-sm text-gray-400">{t('serialPorts')}</span>
                                                                <button
                                                                    onClick={() => setShowAddSerial(true)}
                                                                    className="text-xs px-2 py-1 bg-proxmox-orange/20 text-proxmox-orange rounded hover:bg-proxmox-orange/30"
                                                                >
                                                                    + {t('addSerial')}
                                                                </button>
                                                            </div>
                                                            {passthrough.serial?.length > 0 ? (
                                                                <div className="space-y-1">
                                                                    {passthrough.serial.map((dev, idx) => (
                                                                        <div key={idx} className="flex items-center justify-between p-2 bg-proxmox-dark rounded text-sm">
                                                                            <span className="font-mono text-gray-300">{dev.key}: {dev.value}</span>
                                                                            <button
                                                                                onClick={() => handleRemovePassthrough('serial', dev.key)}
                                                                                className="text-red-400 hover:text-red-300 p-1"
                                                                            >
                                                                                <Icons.Trash className="w-3 h-3" />
                                                                            </button>
                                                                        </div>
                                                                    ))}
                                                                </div>
                                                            ) : (
                                                                <div className="text-xs text-gray-500 italic">{t('noSerialPorts')}</div>
                                                            )}
                                                        </div>
                                                    </div>
                                                </>
                                            )}
                                        </div>
                                    )}

                                    {/* Disks Tab */}
                                    {activeTab === 'disks' && (
                                        <div className="space-y-4">
                                            <div className="flex justify-between items-center">
                                                <h3 className="font-medium text-white">{t('disks')}</h3>
                                                <div className="flex gap-2">
                                                    {isQemu && (
                                                        <button
                                                            onClick={() => setShowMountISO(true)}
                                                            className="flex items-center gap-2 px-3 py-1.5 bg-proxmox-dark border border-proxmox-border rounded-lg text-sm text-gray-300 hover:text-white hover:border-proxmox-orange transition-colors"
                                                        >
                                                            <Icons.Play />
                                                            {t('mountIso')}
                                                        </button>
                                                    )}
                                                    <button
                                                        onClick={() => setShowAddDisk(true)}
                                                        className="flex items-center gap-2 px-3 py-1.5 bg-proxmox-orange rounded-lg text-sm text-white hover:bg-orange-600 transition-colors"
                                                    >
                                                        <Icons.Plus />
                                                        {t('addDisk')}
                                                    </button>
                                                    {isQemu && (
                                                        <button
                                                            onClick={() => setShowImportDisk(true)}
                                                            className="flex items-center gap-2 px-3 py-1.5 bg-proxmox-dark border border-proxmox-border rounded-lg text-sm text-gray-300 hover:text-white hover:border-proxmox-orange transition-colors"
                                                        >
                                                            <Icons.Download />
                                                            {t('importDisk') || 'Import Disk'}
                                                        </button>
                                                    )}
                                                </div>
                                            </div>
                                            
                                            {config.disks?.length > 0 ? (
                                                config.disks.map((disk) => (
                                                    <div key={disk.id} className="p-4 bg-proxmox-dark rounded-lg border border-proxmox-border">
                                                        <div className="flex items-center justify-between mb-3">
                                                            <div className="flex items-center gap-3">
                                                                <Icons.HardDrive />
                                                                <span className="font-medium text-white">{disk.id}</span>
                                                                <span className="text-xs text-gray-500 bg-proxmox-card px-2 py-0.5 rounded">{disk.storage}</span>
                                                            </div>
                                                            <div className="flex items-center gap-2">
                                                                <span className="text-sm text-proxmox-orange font-mono mr-2">{disk.size}</span>
                                                                {/* MK: Edit disk bus type */}
                                                                {isQemu && disk.id !== 'rootfs' && !disk.id.includes('efidisk') && !disk.id.includes('tpmstate') && (
                                                                    <button
                                                                        onClick={() => setShowEditDisk(disk)}
                                                                        className="p-1.5 rounded hover:bg-proxmox-hover text-gray-400 hover:text-yellow-400 transition-colors"
                                                                        title={t('editDiskType') || 'Change Bus Type'}
                                                                    >
                                                                        <Icons.Edit />
                                                                    </button>
                                                                )}
                                                                <button
                                                                    onClick={() => setShowResizeDisk(disk)}
                                                                    className="p-1.5 rounded hover:bg-proxmox-hover text-gray-400 hover:text-green-400 transition-colors"
                                                                    title={t('resize')}
                                                                >
                                                                    <Icons.Plus />
                                                                </button>
                                                                <button
                                                                    onClick={() => setShowMoveDisk(disk)}
                                                                    className="p-1.5 rounded hover:bg-proxmox-hover text-gray-400 hover:text-blue-400 transition-colors"
                                                                    title={t('move')}
                                                                >
                                                                    <Icons.ArrowRight />
                                                                </button>
                                                                {disk.id !== 'rootfs' && !disk.id.includes('efidisk') && !disk.id.includes('tpmstate') && (
                                                                    <>
                                                                        {/* MK: Only show reassign for real disks, not CD-ROM/ISO */}
                                                                        {isQemu && !disk.volume?.includes('iso') && !disk.media?.includes('cdrom') && !String(disk.value || '').includes('media=cdrom') && (
                                                                            <button
                                                                                onClick={() => setShowReassignOwner(disk)}
                                                                                className="p-1.5 rounded hover:bg-proxmox-hover text-gray-400 hover:text-purple-400 transition-colors"
                                                                                title={t('reassignOwner') || 'Reassign Owner'}
                                                                            >
                                                                                <Icons.Users />
                                                                            </button>
                                                                        )}
                                                                        <button
                                                                            onClick={() => handleDetachDisk(disk.id)}
                                                                            className="p-1.5 rounded hover:bg-proxmox-hover text-gray-400 hover:text-yellow-400 transition-colors"
                                                                            title={t('detachDisk') || 'Detach'}
                                                                        >
                                                                            <Icons.Unplug />
                                                                        </button>
                                                                        <button
                                                                            onClick={() => handleRemoveDisk(disk.id)}
                                                                            className="p-1.5 rounded hover:bg-proxmox-hover text-gray-400 hover:text-red-400 transition-colors"
                                                                            title={t('remove')}
                                                                        >
                                                                            <Icons.Trash />
                                                                        </button>
                                                                    </>
                                                                )}
                                                            </div>
                                                        </div>
                                                        <div className="grid grid-cols-4 gap-4 text-sm">
                                                            <div>
                                                                <span className="text-gray-500">Volume:</span>
                                                                <span className="ml-2 text-gray-300 font-mono text-xs">{disk.volume}</span>
                                                            </div>
                                                            {disk.cache && (
                                                                <div>
                                                                    <span className="text-gray-500">Cache:</span>
                                                                    <span className="ml-2 text-gray-300">{disk.cache}</span>
                                                                </div>
                                                            )}
                                                            {disk.iothread ? (
                                                                <div><span className="text-green-400">IOthread</span></div>
                                                            ) : null}
                                                            {disk.ssd ? (
                                                                <div><span className="text-blue-400">SSD</span></div>
                                                            ) : null}
                                                            {disk.mountpoint && (
                                                                <div>
                                                                    <span className="text-gray-500">Mount:</span>
                                                                    <span className="ml-2 text-gray-300">{disk.mountpoint}</span>
                                                                </div>
                                                            )}
                                                        </div>
                                                    </div>
                                                ))
                                            ) : (
                                                <div className="text-center py-8 text-gray-500">
                                                    {t('noDisksConfigured')}
                                                </div>
                                            )}
                                            
                                            {/* MK: Unused Disks Section - detached disks that can be reattached or deleted */}
                                            {config.unused_disks?.length > 0 && (
                                                <div className="mt-6 pt-4 border-t border-proxmox-border">
                                                    <div className="flex items-center gap-2 mb-3">
                                                        <Icons.AlertTriangle className="w-4 h-4 text-yellow-500" />
                                                        <h4 className="font-medium text-yellow-400">{t('unusedDisks') || 'Unused Disks'}</h4>
                                                        <span className="text-xs text-gray-500">({config.unused_disks.length})</span>
                                                    </div>
                                                    <p className="text-xs text-gray-500 mb-3">
                                                        {t('unusedDisksDesc') || 'These disks are detached but still exist. You can reattach or delete them.'}
                                                    </p>
                                                    {config.unused_disks.map((disk) => (
                                                        <div key={disk.id} className="p-3 bg-yellow-500/5 rounded-lg border border-yellow-500/30 mb-2">
                                                            <div className="flex items-center justify-between">
                                                                <div className="flex items-center gap-3">
                                                                    <Icons.HardDrive className="text-yellow-500" />
                                                                    <span className="font-medium text-yellow-400">{disk.id}</span>
                                                                    <span className="text-xs text-gray-400 font-mono">{disk.value}</span>
                                                                </div>
                                                                <div className="flex items-center gap-2">
                                                                    {/* MK: Open reattach modal */}
                                                                    <button
                                                                        onClick={() => setShowReattachDisk(disk)}
                                                                        className="px-2 py-1 text-xs bg-green-600/20 text-green-400 rounded hover:bg-green-600/30 transition-colors"
                                                                        title={t('reattachDisk') || 'Reattach disk'}
                                                                    >
                                                                        {t('reattach') || 'Reattach'}
                                                                    </button>
                                                                    {/* MK: Delete permanently */}
                                                                    <button
                                                                        onClick={async () => {
                                                                            if (!confirm(t('deleteUnusedDiskConfirm') || `Permanently delete ${disk.id}? This cannot be undone!`)) return;
                                                                            try {
                                                                                // First delete the unused reference, then purge the actual volume
                                                                                const res = await authFetch(`${API_URL}/clusters/${clusterId}/vms/${vm.node}/${vm.type}/${vm.vmid}/config`, {
                                                                                    method: 'PUT',
                                                                                    headers: { 'Content-Type': 'application/json' },
                                                                                    body: JSON.stringify({ delete: disk.id })
                                                                                });
                                                                                if (res && res.ok) {
                                                                                    addToast(t('unusedDiskDeleted') || 'Unused disk deleted', 'success');
                                                                                    fetchConfig();
                                                                                } else {
                                                                                    const err = await res.json();
                                                                                    addToast(err.error || 'Error deleting disk', 'error');
                                                                                }
                                                                            } catch (e) {
                                                                                addToast('Error deleting disk', 'error');
                                                                            }
                                                                        }}
                                                                        className="px-2 py-1 text-xs bg-red-600/20 text-red-400 rounded hover:bg-red-600/30 transition-colors"
                                                                        title={t('deletePermanently') || 'Delete permanently'}
                                                                    >
                                                                        {t('delete')}
                                                                    </button>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>
                                            )}
                                        </div>
                                    )}

                                    {/* Network Tab */}
                                    {activeTab === 'network' && (
                                        <div className="space-y-4">
                                            <div className="flex justify-between items-center">
                                                <h3 className="font-medium text-white">{t('networkInterfaces')}</h3>
                                                <button
                                                    onClick={() => setShowAddNetwork(true)}
                                                    className="flex items-center gap-2 px-3 py-1.5 bg-proxmox-orange rounded-lg text-sm text-white hover:bg-orange-600 transition-colors"
                                                >
                                                    <Icons.Plus />
                                                    {t('addNetwork')}
                                                </button>
                                            </div>
                                            
                                            {config.networks?.length > 0 ? (
                                                config.networks.map((net) => (
                                                    <div key={net.id} className={`p-4 bg-proxmox-dark rounded-lg border ${net.link_down ? 'border-red-500/50' : 'border-proxmox-border'}`}>
                                                        <div className="flex items-center justify-between mb-3">
                                                            <div className="flex items-center gap-3">
                                                                <Icons.Network className={net.link_down ? 'text-red-400' : ''} />
                                                                <span className="font-medium text-white">{net.id}</span>
                                                                {net.bridge && (
                                                                    <span className="text-xs text-gray-500 bg-proxmox-card px-2 py-0.5 rounded" title={bridgeList.find(b => b.iface === net.bridge)?.comments || ''}>
                                                                        {net.bridge}{bridgeList.find(b => b.iface === net.bridge)?.comments ? ` (${bridgeList.find(b => b.iface === net.bridge).comments})` : ''}
                                                                    </span>
                                                                )}
                                                                {/* LW: Show disconnected status */}
                                                                {net.link_down && (
                                                                    <span className="text-xs text-red-400 bg-red-500/10 px-2 py-0.5 rounded flex items-center gap-1">
                                                                        <Icons.WifiOff className="w-3 h-3" />
                                                                        {t('networkDisconnected')}
                                                                    </span>
                                                                )}
                                                            </div>
                                                            <div className="flex items-center gap-2">
                                                                {net.firewall ? (
                                                                    <span className="text-xs text-green-400 bg-green-500/10 px-2 py-0.5 rounded">Firewall</span>
                                                                ) : null}
                                                                {/* NS: Connect/Disconnect toggle (QEMU only - hot-pluggable) */}
                                                                {isQemu && (
                                                                    <button
                                                                        onClick={() => handleToggleNetworkLink(net.id, net.link_down)}
                                                                        className={`p-1.5 rounded hover:bg-proxmox-hover transition-colors ${net.link_down ? 'text-red-400 hover:text-green-400' : 'text-gray-400 hover:text-red-400'}`}
                                                                        title={net.link_down ? t('connectNetwork') : t('disconnectNetwork')}
                                                                    >
                                                                        {net.link_down ? <Icons.Plug /> : <Icons.Unplug />}
                                                                    </button>
                                                                )}
                                                                <button
                                                                    onClick={() => setShowEditNetwork(net)}
                                                                    className="p-1.5 rounded hover:bg-proxmox-hover text-gray-400 hover:text-blue-400 transition-colors"
                                                                    title={t('edit')}
                                                                >
                                                                    <Icons.Cog />
                                                                </button>
                                                                <button
                                                                    onClick={() => handleRemoveNetwork(net.id)}
                                                                    className="p-1.5 rounded hover:bg-proxmox-hover text-gray-400 hover:text-red-400 transition-colors"
                                                                    title={t('remove')}
                                                                >
                                                                    <Icons.Trash />
                                                                </button>
                                                            </div>
                                                        </div>
                                                        <div className="grid grid-cols-3 gap-4 text-sm">
                                                            {isQemu ? (
                                                                <>
                                                                    <div><span className="text-gray-500">Model:</span><span className="ml-2 text-gray-300">{net.model || 'virtio'}</span></div>
                                                                    <div><span className="text-gray-500">MAC:</span><span className="ml-2 text-gray-300 font-mono text-xs">{net.macaddr || 'auto'}</span></div>
                                                                    {net.queues && <div><span className="text-gray-500">Queues:</span><span className="ml-2 text-gray-300">{net.queues}</span></div>}
                                                                </>
                                                            ) : (
                                                                <>
                                                                    <div><span className="text-gray-500">{t('name')}:</span><span className="ml-2 text-gray-300">{net.name || 'eth0'}</span></div>
                                                                    <div><span className="text-gray-500">IP:</span><span className="ml-2 text-gray-300 font-mono">{net.ip || 'dhcp'}</span></div>
                                                                    {net.gw && <div><span className="text-gray-500">Gateway:</span><span className="ml-2 text-gray-300 font-mono">{net.gw}</span></div>}
                                                                </>
                                                            )}
                                                            {net.tag && <div><span className="text-gray-500">VLAN:</span><span className="ml-2 text-gray-300">{net.tag}</span></div>}
                                                            {net.rate && <div><span className="text-gray-500">Rate:</span><span className="ml-2 text-gray-300">{net.rate} MB/s</span></div>}
                                                            {net.mtu && <div><span className="text-gray-500">MTU:</span><span className="ml-2 text-gray-300">{net.mtu}</span></div>}
                                                        </div>
                                                    </div>
                                                ))
                                            ) : (
                                                <div className="text-center py-8 text-gray-500">
                                                    {t('noNetworksConfigured')}
                                                </div>
                                            )}
                                        </div>
                                    )}

                                    {/* Snapshots Tab */}
                                    {activeTab === 'snapshots' && (
                                        <div className="space-y-6">
                                            <div className="flex items-center justify-between">
                                                <h3 className="text-sm font-semibold text-gray-300">Snapshots</h3>
                                                <button
                                                    onClick={() => setShowCreateSnapshot(true)}
                                                    className="flex items-center gap-2 px-3 py-1.5 bg-green-600 rounded-lg text-white text-sm hover:bg-green-700"
                                                >
                                                    <Icons.Plus />
                                                    {t('createSnapshot')}
                                                </button>
                                            </div>
                                            
                                            {snapshots.length > 0 ? (
                                                <div className="space-y-3">
                                                    {snapshots.map(snap => (
                                                        <div key={snap.name} className="p-4 bg-proxmox-dark rounded-lg border border-proxmox-border">
                                                            <div className="flex items-center justify-between">
                                                                <div className="flex items-center gap-3">
                                                                    <div className="p-2 bg-blue-500/10 rounded-lg">
                                                                        <Icons.Clock />
                                                                    </div>
                                                                    <div>
                                                                        <div className="font-medium text-white">{snap.name}</div>
                                                                        <div className="text-xs text-gray-400">
                                                                            {snap.snaptime ? new Date(snap.snaptime * 1000).toLocaleString() : t('unknown')}
                                                                            {snap.vmstate && <span className="ml-2 text-blue-400">+ RAM</span>}
                                                                        </div>
                                                                        {snap.description && (
                                                                            <div className="text-sm text-gray-500 mt-1">{snap.description}</div>
                                                                        )}
                                                                    </div>
                                                                </div>
                                                                <div className="flex items-center gap-2">
                                                                    <button
                                                                        onClick={() => handleRollbackSnapshot(snap.name)}
                                                                        disabled={snapshotLoading}
                                                                        className="p-2 rounded-lg bg-yellow-500/10 hover:bg-yellow-500/20 text-yellow-400 transition-colors disabled:opacity-50"
                                                                        title={t('rollback')}
                                                                    >
                                                                        <Icons.RotateCcw />
                                                                    </button>
                                                                    <button
                                                                        onClick={() => handleDeleteSnapshot(snap.name)}
                                                                        disabled={snapshotLoading}
                                                                        className="p-2 rounded-lg bg-red-500/10 hover:bg-red-500/20 text-red-400 transition-colors disabled:opacity-50"
                                                                        title={t('delete')}
                                                                    >
                                                                        <Icons.Trash />
                                                                    </button>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>
                                            ) : (
                                                <div className="text-center py-8 text-gray-500">
                                                    <Icons.Clock />
                                                    <p className="mt-2">{t('noSnapshots')}</p>
                                                </div>
                                            )}

                                            {/* Create Snapshot Modal */}
                                            {showCreateSnapshot && (
                                                <CreateSnapshotModal
                                                    isQemu={isQemu}
                                                    onSubmit={handleCreateSnapshot}
                                                    onClose={() => setShowCreateSnapshot(false)}
                                                    loading={snapshotLoading}
                                                />
                                            )}
                                        </div>
                                    )}
                                    
                                    {/* LW: Backups Tab - Dec 2025 */}
                                    {activeTab === 'backups' && (
                                        <div className="space-y-6">
                                            <div className="flex items-center justify-between">
                                                <h3 className="text-sm font-semibold text-gray-300">{t('backupsTab') || 'Backups'}</h3>
                                                <div className="flex items-center gap-2">
                                                    <button
                                                        onClick={fetchBackups}
                                                        disabled={backupLoading}
                                                        className="p-2 hover:bg-proxmox-hover rounded-lg text-gray-400"
                                                        title={t('refresh')}
                                                    >
                                                        <Icons.RotateCw className={backupLoading ? 'animate-spin' : ''} />
                                                    </button>
                                                    <button
                                                        onClick={() => setShowCreateBackup(true)}
                                                        className="flex items-center gap-2 px-3 py-1.5 bg-green-600 rounded-lg text-white text-sm hover:bg-green-700"
                                                    >
                                                        <Icons.Plus />
                                                        {t('createBackup') || 'Create Backup'}
                                                    </button>
                                                </div>
                                            </div>
                                            
                                            {backupLoading ? (
                                                <div className="flex items-center justify-center py-8">
                                                    <Icons.RotateCw className="animate-spin text-gray-400" />
                                                </div>
                                            ) : vmBackups.length > 0 ? (
                                                <div className="space-y-3">
                                                    {vmBackups.map(backup => (
                                                        <div key={backup.volid} className="p-4 bg-proxmox-dark rounded-lg border border-proxmox-border">
                                                            <div className="flex items-center justify-between">
                                                                <div className="flex items-center gap-3">
                                                                    <div className="p-2 bg-purple-500/10 rounded-lg">
                                                                        <Icons.Database className="text-purple-400" />
                                                                    </div>
                                                                    <div>
                                                                        <div className="font-medium text-white">{backup.filename}</div>
                                                                        <div className="text-xs text-gray-400">
                                                                            {backup.ctime ? new Date(backup.ctime * 1000).toLocaleString() : ''}
                                                                            <span className="mx-2">‚Ä¢</span>
                                                                            {(backup.size / (1024*1024*1024)).toFixed(2)} GB
                                                                            <span className="mx-2">‚Ä¢</span>
                                                                            <span className="text-gray-500">{backup.storage}</span>
                                                                        </div>
                                                                        {backup.notes && (
                                                                            <div className="text-sm text-gray-500 mt-1">{backup.notes}</div>
                                                                        )}
                                                                    </div>
                                                                </div>
                                                                <div className="flex items-center gap-2">
                                                                    <button
                                                                        onClick={() => setShowRestoreBackup(backup)}
                                                                        disabled={backupLoading}
                                                                        className="p-2 rounded-lg bg-blue-500/10 hover:bg-blue-500/20 text-blue-400 transition-colors disabled:opacity-50"
                                                                        title={t('restore') || 'Restore'}
                                                                    >
                                                                        <Icons.RotateCcw />
                                                                    </button>
                                                                    <button
                                                                        onClick={() => handleDeleteBackup(backup.volid)}
                                                                        disabled={backupLoading}
                                                                        className="p-2 rounded-lg bg-red-500/10 hover:bg-red-500/20 text-red-400 transition-colors disabled:opacity-50"
                                                                        title={t('delete')}
                                                                    >
                                                                        <Icons.Trash />
                                                                    </button>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>
                                            ) : (
                                                <div className="text-center py-8 text-gray-500">
                                                    <Icons.Database className="mx-auto opacity-50" />
                                                    <p className="mt-2">{t('noBackups') || 'No backups found'}</p>
                                                    <p className="text-xs mt-1">{t('noBackupsHint') || 'Create a backup or check your backup storages'}</p>
                                                </div>
                                            )}
                                            
                                            {/* MK: Create Backup Modal */}
                                            {showCreateBackup && (
                                                <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50">
                                                    <div className="bg-proxmox-card border border-proxmox-border rounded-xl p-6 w-full max-w-md">
                                                        <h3 className="text-lg font-semibold mb-4">{t('createBackup') || 'Create Backup'}</h3>
                                                        <div className="space-y-4">
                                                            <div>
                                                                <label className="block text-sm text-gray-400 mb-2">{t('storage') || 'Storage'}</label>
                                                                <select
                                                                    id="backup-storage"
                                                                    defaultValue="local"
                                                                    className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white"
                                                                >
                                                                    {storageList.filter(s => s.content?.includes('backup')).map(s => (
                                                                        <option key={s.storage} value={s.storage}>{s.storage}</option>
                                                                    ))}
                                                                    {!storageList.some(s => s.content?.includes('backup')) && (
                                                                        <option value="local">local</option>
                                                                    )}
                                                                </select>
                                                            </div>
                                                            <div>
                                                                <label className="block text-sm text-gray-400 mb-2">{t('backupMode') || 'Mode'}</label>
                                                                <select
                                                                    id="backup-mode"
                                                                    defaultValue="snapshot"
                                                                    className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white"
                                                                >
                                                                    <option value="snapshot">{t('backupModeSnapshot') || 'Snapshot (no stop)'}</option>
                                                                    <option value="suspend">{t('backupModeSuspend') || 'Suspend (brief pause)'}</option>
                                                                    <option value="stop">{t('backupModeStop') || 'Stop (VM will stop)'}</option>
                                                                </select>
                                                            </div>
                                                            <div>
                                                                <label className="block text-sm text-gray-400 mb-2">{t('compression') || 'Compression'}</label>
                                                                <select
                                                                    id="backup-compress"
                                                                    defaultValue="zstd"
                                                                    className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white"
                                                                >
                                                                    <option value="zstd">{t('compressZstd') || 'ZSTD (recommended)'}</option>
                                                                    <option value="lzo">{t('compressLzo') || 'LZO (fast)'}</option>
                                                                    <option value="gzip">{t('compressGzip') || 'GZIP'}</option>
                                                                    <option value="0">{t('compressNone') || 'None'}</option>
                                                                </select>
                                                            </div>
                                                            {/* NS: Notes/Description field */}
                                                            <div>
                                                                <label className="block text-sm text-gray-400 mb-2">{t('backupNotes') || 'Notes (optional)'}</label>
                                                                <textarea
                                                                    id="backup-notes"
                                                                    placeholder={t('backupNotesPlaceholder') || 'e.g. Before major update, weekly backup...'}
                                                                    className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white resize-none"
                                                                    rows={2}
                                                                />
                                                            </div>
                                                            <div className="flex gap-2 justify-end pt-2">
                                                                <button
                                                                    onClick={() => setShowCreateBackup(false)}
                                                                    className="px-4 py-2 bg-proxmox-dark hover:bg-proxmox-hover rounded-lg"
                                                                >
                                                                    {t('cancel')}
                                                                </button>
                                                                <button
                                                                    onClick={() => {
                                                                        const storage = document.getElementById('backup-storage').value;
                                                                        const mode = document.getElementById('backup-mode').value;
                                                                        const compress = document.getElementById('backup-compress').value;
                                                                        const notes = document.getElementById('backup-notes').value;
                                                                        handleCreateBackup(storage, mode, compress, notes);
                                                                    }}
                                                                    disabled={backupLoading}
                                                                    className="px-4 py-2 bg-green-600 hover:bg-green-700 rounded-lg disabled:opacity-50"
                                                                >
                                                                    {backupLoading ? t('loading') : t('create') || 'Create'}
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            )}
                                            
                                            {/* NS: Restore Backup Modal */}
                                            {showRestoreBackup && (
                                                <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50">
                                                    <div className="bg-proxmox-card border border-proxmox-border rounded-xl p-6 w-full max-w-md">
                                                        <h3 className="text-lg font-semibold mb-4">{t('restoreBackup') || 'Restore Backup'}</h3>
                                                        <div className="space-y-4">
                                                            <div className="p-3 bg-proxmox-dark rounded-lg">
                                                                <p className="text-sm text-gray-400">{t('selectedBackup') || 'Selected Backup'}:</p>
                                                                <p className="font-mono text-sm truncate">{showRestoreBackup.filename}</p>
                                                            </div>
                                                            <div>
                                                                <label className="block text-sm text-gray-400 mb-2">{t('targetVmid') || 'Target VMID'}</label>
                                                                <input
                                                                    type="number"
                                                                    id="restore-vmid"
                                                                    defaultValue={vm.vmid}
                                                                    className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white"
                                                                />
                                                                <p className="text-xs text-yellow-400 mt-1">
                                                                    {t('sameVmidWarning') || 'Same VMID = VM will be overwritten!'}
                                                                </p>
                                                            </div>
                                                            <div>
                                                                <label className="block text-sm text-gray-400 mb-2">{t('targetStorage') || 'Target Storage (optional)'}</label>
                                                                <select
                                                                    id="restore-storage"
                                                                    defaultValue=""
                                                                    className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white"
                                                                >
                                                                    <option value="">{t('originalStorage') || 'Keep original'}</option>
                                                                    {storageList.filter(s => s.content?.includes('images')).map(s => (
                                                                        <option key={s.storage} value={s.storage}>{s.storage}</option>
                                                                    ))}
                                                                </select>
                                                            </div>
                                                            <div className="flex items-center gap-2">
                                                                <input
                                                                    type="checkbox"
                                                                    id="restore-start"
                                                                    className="w-4 h-4 rounded"
                                                                />
                                                                <label htmlFor="restore-start" className="text-sm text-gray-300">
                                                                    {t('startAfterRestore') || 'Start after restore'}
                                                                </label>
                                                            </div>
                                                            <div className="flex gap-2 justify-end pt-2">
                                                                <button
                                                                    onClick={() => setShowRestoreBackup(null)}
                                                                    className="px-4 py-2 bg-proxmox-dark hover:bg-proxmox-hover rounded-lg"
                                                                >
                                                                    {t('cancel')}
                                                                </button>
                                                                <button
                                                                    onClick={() => {
                                                                        const targetVmid = parseInt(document.getElementById('restore-vmid').value);
                                                                        const storage = document.getElementById('restore-storage').value;
                                                                        const startAfter = document.getElementById('restore-start').checked;
                                                                        handleRestoreBackup(showRestoreBackup.volid, targetVmid, storage, startAfter);
                                                                    }}
                                                                    disabled={backupLoading}
                                                                    className="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg disabled:opacity-50"
                                                                >
                                                                    {backupLoading ? t('loading') : t('restore') || 'Restore'}
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    )}

                                    {/* Replication Tab */}
                                    {activeTab === 'replication' && (
                                        <div className="space-y-6">
                                            <div className="flex items-center justify-between">
                                                <h3 className="text-sm font-semibold text-gray-300">Replication Jobs</h3>
                                                <button
                                                    onClick={() => setShowCreateReplication(true)}
                                                    disabled={allClusterNodes.length < 2}
                                                    className="flex items-center gap-2 px-3 py-1.5 bg-green-600 rounded-lg text-white text-sm hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed"
                                                >
                                                    <Icons.Plus />
                                                    {t('createReplication')}
                                                </button>
                                            </div>
                                            
                                            {allClusterNodes.length < 2 && (
                                                <div className="p-3 bg-yellow-500/10 border border-yellow-500/30 rounded-lg text-sm text-yellow-400">
                                                    ‚ö†Ô∏è {t('replicationNeedsTwoNodes')}
                                                </div>
                                            )}
                                            
                                            {replications.length > 0 ? (
                                                <div className="space-y-3">
                                                    {replications.map(job => (
                                                        <div key={job.id} className="p-4 bg-proxmox-dark rounded-lg border border-proxmox-border">
                                                            <div className="flex items-center justify-between">
                                                                <div className="flex items-center gap-3">
                                                                    <div className={`p-2 rounded-lg ${job.error ? 'bg-red-500/10' : 'bg-green-500/10'}`}>
                                                                        <Icons.RefreshCw />
                                                                    </div>
                                                                    <div>
                                                                        <div className="font-medium text-white">
                                                                            ‚Üí {job.target}
                                                                        </div>
                                                                        <div className="text-xs text-gray-400">
                                                                            Schedule: {job.schedule || '*/15'} | 
                                                                            {job.last_sync ? ` ${t('lastSync')}: ${new Date(job.last_sync * 1000).toLocaleString()}` : ` ${t('neverSynced')}`}
                                                                        </div>
                                                                        {job.error && (
                                                                            <div className="text-xs text-red-400 mt-1">{t('error')}: {job.error}</div>
                                                                        )}
                                                                        {job.comment && (
                                                                            <div className="text-sm text-gray-500 mt-1">{job.comment}</div>
                                                                        )}
                                                                    </div>
                                                                </div>
                                                                <div className="flex items-center gap-2">
                                                                    <button
                                                                        onClick={() => handleRunReplicationNow(job.id)}
                                                                        disabled={replicationLoading}
                                                                        className="p-2 rounded-lg bg-blue-500/10 hover:bg-blue-500/20 text-blue-400 transition-colors disabled:opacity-50"
                                                                        title={t('syncNow')}
                                                                    >
                                                                        <Icons.PlayCircle />
                                                                    </button>
                                                                    <button
                                                                        onClick={() => handleDeleteReplication(job.id)}
                                                                        disabled={replicationLoading}
                                                                        className="p-2 rounded-lg bg-red-500/10 hover:bg-red-500/20 text-red-400 transition-colors disabled:opacity-50"
                                                                        title={t('delete')}
                                                                    >
                                                                        <Icons.Trash />
                                                                    </button>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>
                                            ) : (
                                                <div className="text-center py-8 text-gray-500">
                                                    <Icons.RefreshCw />
                                                    <p className="mt-2">{t('noReplicationJobs')}</p>
                                                </div>
                                            )}

                                            {/* Create Replication Modal */}
                                            {showCreateReplication && (
                                                <CreateReplicationModal
                                                    nodes={clusterNodes}
                                                    onSubmit={handleCreateReplication}
                                                    onClose={() => setShowCreateReplication(false)}
                                                    loading={replicationLoading}
                                                />
                                            )}
                                        </div>
                                    )}

                                    {/* History Tab - MK Jan 2026 */}
                                    {activeTab === 'history' && (
                                        <div className="space-y-4">
                                            {/* Sub-tabs */}
                                            <div className="flex gap-2 border-b border-proxmox-border pb-2">
                                                <button 
                                                    onClick={() => { setHistorySubTab('proxmox'); fetchHistory(); }}
                                                    className={`px-4 py-2 rounded-t-lg text-sm font-medium transition-colors ${historySubTab === 'proxmox' ? 'bg-proxmox-orange text-white' : 'text-gray-400 hover:text-white hover:bg-proxmox-dark'}`}
                                                >
                                                    {t('proxmoxTasks')}
                                                </button>
                                                <button 
                                                    onClick={() => { setHistorySubTab('pegaprox'); fetchHistory(); }}
                                                    className={`px-4 py-2 rounded-t-lg text-sm font-medium transition-colors ${historySubTab === 'pegaprox' ? 'bg-proxmox-orange text-white' : 'text-gray-400 hover:text-white hover:bg-proxmox-dark'}`}
                                                >
                                                    {t('pegaproxActions')}
                                                </button>
                                                <button 
                                                    onClick={fetchHistory}
                                                    className="ml-auto p-2 hover:bg-proxmox-dark rounded-lg text-gray-400 hover:text-white"
                                                    title="Refresh"
                                                >
                                                    <Icons.RefreshCw className={`w-4 h-4 ${historyLoading ? 'animate-spin' : ''}`} />
                                                </button>
                                            </div>

                                            {historyLoading ? (
                                                <div className="flex items-center justify-center py-8">
                                                    <Icons.RotateCw className="w-6 h-6 animate-spin text-proxmox-orange" />
                                                </div>
                                            ) : (
                                                <>
                                                    {/* Proxmox Tasks */}
                                                    {historySubTab === 'proxmox' && (
                                                        <div className="space-y-2">
                                                            <h4 className="text-sm font-medium text-gray-400 mb-2">Proxmox Tasks for {isQemu ? 'VM' : 'CT'} {vm.vmid}</h4>
                                                            {vmProxmoxTasks && vmProxmoxTasks.length > 0 ? (
                                                                <div className="overflow-x-auto max-h-96 overflow-y-auto">
                                                                    <table className="w-full text-sm">
                                                                        <thead className="sticky top-0 bg-proxmox-dark">
                                                                            <tr className="text-left text-gray-400">
                                                                                <th className="p-2">Time</th>
                                                                                <th className="p-2">Type</th>
                                                                                <th className="p-2">User</th>
                                                                                <th className="p-2">Status</th>
                                                                                <th className="p-2">Node</th>
                                                                            </tr>
                                                                        </thead>
                                                                        <tbody>
                                                                            {vmProxmoxTasks.map((task, idx) => (
                                                                                <tr key={idx} className="border-t border-proxmox-border hover:bg-proxmox-dark/50">
                                                                                    <td className="p-2 text-gray-300 whitespace-nowrap">
                                                                                        {task.starttime ? new Date(task.starttime * 1000).toLocaleString() : '-'}
                                                                                    </td>
                                                                                    <td className="p-2 font-mono text-xs">
                                                                                        <span className="px-2 py-0.5 bg-blue-500/20 text-blue-400 rounded">{task.type || '-'}</span>
                                                                                    </td>
                                                                                    <td className="p-2 text-gray-300">{task.user || '-'}</td>
                                                                                    <td className="p-2">
                                                                                        <span className={`px-2 py-0.5 rounded text-xs ${
                                                                                            task.status === 'OK' ? 'bg-green-500/20 text-green-400' :
                                                                                            task.status && task.status.includes('ERROR') ? 'bg-red-500/20 text-red-400' :
                                                                                            task.exitstatus === 'OK' ? 'bg-green-500/20 text-green-400' :
                                                                                            !task.endtime ? 'bg-yellow-500/20 text-yellow-400' :
                                                                                            'bg-gray-500/20 text-gray-400'
                                                                                        }`}>
                                                                                            {task.status || task.exitstatus || (task.endtime ? 'completed' : 'running')}
                                                                                        </span>
                                                                                    </td>
                                                                                    <td className="p-2 text-gray-400 font-mono text-xs">{task.node || vm.node}</td>
                                                                                </tr>
                                                                            ))}
                                                                        </tbody>
                                                                    </table>
                                                                </div>
                                                            ) : (
                                                                <div className="text-center py-8 text-gray-500">
                                                                    <Icons.List className="w-8 h-8 mx-auto mb-2 opacity-50" />
                                                                    <p>No Proxmox tasks found for this {isQemu ? 'VM' : 'Container'}</p>
                                                                </div>
                                                            )}
                                                        </div>
                                                    )}

                                                    {/* PegaProx Actions */}
                                                    {historySubTab === 'pegaprox' && (
                                                        <div className="space-y-2">
                                                            <h4 className="text-sm font-medium text-gray-400 mb-2">PegaProx Actions for {isQemu ? 'VM' : 'CT'} {vm.vmid}</h4>
                                                            {vmPegaproxActions && vmPegaproxActions.length > 0 ? (
                                                                <div className="overflow-x-auto max-h-96 overflow-y-auto">
                                                                    <table className="w-full text-sm">
                                                                        <thead className="sticky top-0 bg-proxmox-dark">
                                                                            <tr className="text-left text-gray-400">
                                                                                <th className="p-2">Time</th>
                                                                                <th className="p-2">Action</th>
                                                                                <th className="p-2">User</th>
                                                                                <th className="p-2">Details</th>
                                                                            </tr>
                                                                        </thead>
                                                                        <tbody>
                                                                            {vmPegaproxActions.map((action, idx) => (
                                                                                <tr key={idx} className="border-t border-proxmox-border hover:bg-proxmox-dark/50">
                                                                                    <td className="p-2 text-gray-300 whitespace-nowrap">
                                                                                        {action.timestamp ? new Date(action.timestamp).toLocaleString() : '-'}
                                                                                    </td>
                                                                                    <td className="p-2">
                                                                                        <span className="px-2 py-0.5 bg-proxmox-orange/20 text-proxmox-orange rounded text-xs font-mono">
                                                                                            {action.action || '-'}
                                                                                        </span>
                                                                                    </td>
                                                                                    <td className="p-2 text-gray-300 font-medium">{action.user || '-'}</td>
                                                                                    <td className="p-2 text-gray-400 text-xs max-w-xs truncate" title={action.details || ''}>
                                                                                        {action.details || '-'}
                                                                                    </td>
                                                                                </tr>
                                                                            ))}
                                                                        </tbody>
                                                                    </table>
                                                                </div>
                                                            ) : (
                                                                <div className="text-center py-8 text-gray-500">
                                                                    <Icons.List className="w-8 h-8 mx-auto mb-2 opacity-50" />
                                                                    <p>No PegaProx actions found for this {isQemu ? 'VM' : 'Container'}</p>
                                                                </div>
                                                            )}
                                                        </div>
                                                    )}
                                                </>
                                            )}
                                        </div>
                                    )}

                                    {/* Options Tab */}
                                    {activeTab === 'options' && (
                                        <div className="space-y-6">
                                            <div className="space-y-4">
                                                <ConfigCheckboxField
                                                    label={t('startOnBoot')}
                                                    checked={getValue('options', 'onboot') == 1}
                                                    onChange={(v) => handleChange('options', 'onboot', v)}
                                                    t={t}
                                                />
                                                <ConfigCheckboxField
                                                    label={t('protection')}
                                                    checked={getValue('options', 'protection') == 1}
                                                    onChange={(v) => handleChange('options', 'protection', v)}
                                                    t={t}
                                                />
                                                {isQemu && (
                                                    <>
                                                        {/* QEMU Guest Agent Section */}
                                                        <div className="p-4 bg-proxmox-dark rounded-lg border border-proxmox-border">
                                                            <div className="flex items-center justify-between mb-2">
                                                                <label className="flex items-center gap-2">
                                                                    <input 
                                                                        type="checkbox" 
                                                                        checked={getValue('options', 'agent')?.toString().includes('1')}
                                                                        onChange={(e) => {
                                                                            const current = getValue('options', 'agent') || '';
                                                                            if (e.target.checked) {
                                                                                handleChange('options', 'agent', '1');
                                                                            } else {
                                                                                handleChange('options', 'agent', '0');
                                                                            }
                                                                        }}
                                                                        className="w-4 h-4 rounded"
                                                                    />
                                                                    <span className="text-sm font-medium text-gray-300">{t('qemuGuestAgent')}</span>
                                                                    <span className="text-[10px] px-1.5 py-0.5 bg-red-500/20 text-red-400 rounded font-medium">RESTART</span>
                                                                </label>
                                                            </div>
                                                            <p className="text-xs text-gray-500 mb-3">{t('qemuGuestAgentHint')}</p>
                                                            
                                                            {getValue('options', 'agent')?.toString().includes('1') && (
                                                                <div className="mt-3 pt-3 border-t border-proxmox-border space-y-2">
                                                                    <label className="flex items-center gap-2 text-sm text-gray-400">
                                                                        <input 
                                                                            type="checkbox"
                                                                            checked={getValue('options', 'agent')?.toString().includes('fstrim_cloned_disks=1')}
                                                                            onChange={(e) => {
                                                                                let agent = getValue('options', 'agent') || '1';
                                                                                if (e.target.checked) {
                                                                                    agent = agent.includes(',') ? agent + ',fstrim_cloned_disks=1' : '1,fstrim_cloned_disks=1';
                                                                                } else {
                                                                                    agent = agent.replace(/,?fstrim_cloned_disks=1/, '').replace(/^,/, '');
                                                                                }
                                                                                handleChange('options', 'agent', agent || '1');
                                                                            }}
                                                                            className="w-4 h-4 rounded"
                                                                        />
                                                                        {t('fstrim')}
                                                                    </label>
                                                                </div>
                                                            )}
                                                        </div>
                                                        
                                                        {/* Hotplug options */}
                                                        <div className="p-4 bg-proxmox-dark rounded-lg border border-proxmox-border">
                                                            <label className="text-sm font-medium text-gray-300 block mb-2">{t('hotplug')}</label>
                                                            <p className="text-xs text-gray-500 mb-3">{t('hotplugHint')}</p>
                                                            <div className="flex flex-wrap gap-4">
                                                                {[
                                                                    { key: 'disk', label: t('hotplugDisk') },
                                                                    { key: 'network', label: t('hotplugNetwork') },
                                                                    { key: 'usb', label: t('hotplugUsb') },
                                                                    { key: 'memory', label: t('hotplugMemory') },
                                                                    { key: 'cpu', label: t('hotplugCpu') },
                                                                ].map(hp => {
                                                                    const hotplugValue = getValue('options', 'hotplug') || 'disk,network,usb';
                                                                    const isEnabled = hotplugValue === '1' || hotplugValue.includes(hp.key);
                                                                    return (
                                                                        <label key={hp.key} className="flex items-center gap-2 text-sm text-gray-400">
                                                                            <input 
                                                                                type="checkbox"
                                                                                checked={isEnabled}
                                                                                onChange={(e) => {
                                                                                    let current = getValue('options', 'hotplug') || 'disk,network,usb';
                                                                                    if (current === '1') current = 'disk,network,usb,memory,cpu';
                                                                                    if (current === '0') current = '';
                                                                                    
                                                                                    let parts = current.split(',').filter(p => p);
                                                                                    if (e.target.checked && !parts.includes(hp.key)) {
                                                                                        parts.push(hp.key);
                                                                                    } else if (!e.target.checked) {
                                                                                        parts = parts.filter(p => p !== hp.key);
                                                                                    }
                                                                                    handleChange('options', 'hotplug', parts.join(',') || '0');
                                                                                }}
                                                                                className="w-4 h-4 rounded"
                                                                            />
                                                                            {hp.label}
                                                                        </label>
                                                                    );
                                                                })}
                                                            </div>
                                                        </div>
                                                        
                                                        <ConfigCheckboxField
                                                            label={t('kvmVirtualization')}
                                                            checked={getValue('options', 'kvm') == 1}
                                                            onChange={(v) => handleChange('options', 'kvm', v)}
                                                            needsRestart={true}
                                                            t={t}
                                                        />
                                                        <ConfigCheckboxField
                                                            label="ACPI"
                                                            checked={getValue('options', 'acpi') == 1}
                                                            onChange={(v) => handleChange('options', 'acpi', v)}
                                                            needsRestart={true}
                                                            t={t}
                                                        />
                                                    </>
                                                )}
                                                {!isQemu && (
                                                    <>
                                                        <ConfigCheckboxField
                                                            label={t('unprivilegedContainer')}
                                                            checked={getValue('options', 'unprivileged') == 1}
                                                            onChange={(v) => handleChange('options', 'unprivileged', v)}
                                                            disabled={true}
                                                            needsRestart={true}
                                                            t={t}
                                                        />
                                                    </>
                                                )}
                                            </div>
                                            {isQemu && (
                                                <div className="space-y-4">
                                                    <div className="grid grid-cols-2 gap-4">
                                                        <ConfigInputField
                                                            label={t('osType')}
                                                            value={getValue('options', 'ostype')}
                                                            onChange={(v) => handleChange('options', 'ostype', v)}
                                                            options={[
                                                                { value: 'l26', label: 'Linux 2.6+' },
                                                                { value: 'l24', label: 'Linux 2.4' },
                                                                { value: 'win11', label: 'Windows 11' },
                                                                { value: 'win10', label: 'Windows 10' },
                                                                { value: 'win8', label: 'Windows 8' },
                                                                { value: 'win7', label: 'Windows 7' },
                                                                { value: 'wxp', label: 'Windows XP' },
                                                                { value: 'other', label: t('other') },
                                                            ]}
                                                        />
                                                    </div>
                                                    
                                                    {/* NS: Boot Order UI - Dec 2025 */}
                                                    <div className="p-4 bg-proxmox-dark rounded-lg border border-proxmox-border">
                                                        <div className="flex items-center justify-between mb-3">
                                                            <label className="text-sm font-medium text-gray-300">{t('bootOrder') || 'Boot Order'}</label>
                                                            <span className="text-xs text-gray-500">{t('dragToReorder') || 'Click to toggle, drag to reorder'}</span>
                                                        </div>
                                                        
                                                        {/* Parse current boot order and available devices */}
                                                        {(() => {
                                                            const currentBoot = getValue('options', 'boot') || '';
                                                            const bootDevices = currentBoot.includes('order=') 
                                                                ? currentBoot.split('order=')[1].split(';').filter(d => d)
                                                                : [];
                                                            
                                                            // LW: Collect all bootable devices from config
                                                            const allDevices = [];
                                                            if (config.disks) {
                                                                config.disks.forEach(d => {
                                                                    if (!d.id.includes('cloudinit')) allDevices.push(d.id);
                                                                });
                                                            }
                                                            if (config.networks) {
                                                                config.networks.forEach(n => allDevices.push(n.id));
                                                            }
                                                            // Add common devices that might not be in disks array
                                                            ['ide2', 'ide0', 'sata0', 'scsi0', 'virtio0', 'net0'].forEach(dev => {
                                                                if (!allDevices.includes(dev)) {
                                                                    // Check if device exists in raw config
                                                                    if (config[dev]) allDevices.push(dev);
                                                                }
                                                            });
                                                            
                                                            // Sort: boot devices first in order, then others
                                                            const sortedDevices = [
                                                                ...bootDevices.filter(d => allDevices.includes(d)),
                                                                ...allDevices.filter(d => !bootDevices.includes(d))
                                                            ].filter((v, i, a) => a.indexOf(v) === i); // unique
                                                            
                                                            const toggleDevice = (device) => {
                                                                const newOrder = bootDevices.includes(device)
                                                                    ? bootDevices.filter(d => d !== device)
                                                                    : [...bootDevices, device];
                                                                handleChange('options', 'boot', newOrder.length > 0 ? 'order=' + newOrder.join(';') : '');
                                                            };
                                                            
                                                            const moveDevice = (device, direction) => {
                                                                const idx = bootDevices.indexOf(device);
                                                                if (idx === -1) return;
                                                                const newOrder = [...bootDevices];
                                                                const newIdx = direction === 'up' ? idx - 1 : idx + 1;
                                                                if (newIdx < 0 || newIdx >= newOrder.length) return;
                                                                [newOrder[idx], newOrder[newIdx]] = [newOrder[newIdx], newOrder[idx]];
                                                                handleChange('options', 'boot', 'order=' + newOrder.join(';'));
                                                            };
                                                            
                                                            return (
                                                                <div className="space-y-2">
                                                                    {sortedDevices.map((device, idx) => {
                                                                        const isEnabled = bootDevices.includes(device);
                                                                        const bootIdx = bootDevices.indexOf(device);
                                                                        const isFirst = bootIdx === 0;
                                                                        const isLast = bootIdx === bootDevices.length - 1;
                                                                        
                                                                        // NS: Determine device type icon
                                                                        const isDisk = device.match(/^(scsi|virtio|ide|sata)\d+$/);
                                                                        const isNet = device.match(/^net\d+$/);
                                                                        const isCdrom = device === 'ide2' || (config[device] && String(config[device]).includes('media=cdrom'));
                                                                        
                                                                        return (
                                                                            <div 
                                                                                key={device}
                                                                                className={`flex items-center gap-3 p-2 rounded-lg transition-colors ${
                                                                                    isEnabled ? 'bg-proxmox-orange/10 border border-proxmox-orange/30' : 'bg-proxmox-darker'
                                                                                }`}
                                                                            >
                                                                                <input
                                                                                    type="checkbox"
                                                                                    checked={isEnabled}
                                                                                    onChange={() => toggleDevice(device)}
                                                                                    className="w-4 h-4 rounded border-gray-600 text-proxmox-orange focus:ring-proxmox-orange"
                                                                                />
                                                                                <span className="text-gray-400 w-6 text-center text-sm">
                                                                                    {isEnabled ? `${bootIdx + 1}.` : '-'}
                                                                                </span>
                                                                                <span className="text-lg">
                                                                                    {isCdrom ? 'üíø' : isNet ? 'üåê' : isDisk ? 'üíæ' : 'üì¶'}
                                                                                </span>
                                                                                <span className={`font-mono text-sm ${isEnabled ? 'text-white' : 'text-gray-500'}`}>
                                                                                    {device}
                                                                                </span>
                                                                                {isEnabled && (
                                                                                    <div className="ml-auto flex items-center gap-1">
                                                                                        <button
                                                                                            onClick={() => moveDevice(device, 'up')}
                                                                                            disabled={isFirst}
                                                                                            className="p-1 rounded hover:bg-proxmox-hover disabled:opacity-30 disabled:cursor-not-allowed"
                                                                                            title="Move up"
                                                                                        >
                                                                                            <Icons.ChevronUp />
                                                                                        </button>
                                                                                        <button
                                                                                            onClick={() => moveDevice(device, 'down')}
                                                                                            disabled={isLast}
                                                                                            className="p-1 rounded hover:bg-proxmox-hover disabled:opacity-30 disabled:cursor-not-allowed"
                                                                                            title="Move down"
                                                                                        >
                                                                                            <Icons.ChevronDown />
                                                                                        </button>
                                                                                    </div>
                                                                                )}
                                                                            </div>
                                                                        );
                                                                    })}
                                                                    {sortedDevices.length === 0 && (
                                                                        <div className="text-center py-4 text-gray-500 text-sm">
                                                                            {t('noBootDevices') || 'No boot devices found'}
                                                                        </div>
                                                                    )}
                                                                </div>
                                                            );
                                                        })()}
                                                    </div>
                                                    
                                                    {/* SMBIOS Configuration */}
                                                    <div className="p-4 bg-proxmox-dark rounded-lg border border-proxmox-border">
                                                        <div className="flex items-center justify-between mb-3">
                                                            <label className="text-sm font-medium text-gray-300 flex items-center gap-2">
                                                                <Icons.Cpu />
                                                                {t('smbiosSettings') || 'SMBIOS Settings'}
                                                            </label>
                                                            <span className="text-[10px] px-1.5 py-0.5 bg-red-500/20 text-red-400 rounded font-medium">{t('requiresRestart') || 'RESTART'}</span>
                                                        </div>
                                                        <p className="text-xs text-gray-500 mb-4">{t('smbiosHint') || 'System Management BIOS settings - useful for Windows licensing and VM identification'}</p>
                                                        
                                                        {/* Current SMBIOS value display */}
                                                        {getValue('options', 'smbios1') && (
                                                            <div className="mb-4 p-3 bg-black/50 rounded-lg border border-green-500/30">
                                                                <label className="block text-[10px] text-green-400 mb-1 font-medium">{t('currentValue') || 'Current Value'} (smbios1):</label>
                                                                <code className="text-xs text-green-300 font-mono break-all">
                                                                    {getValue('options', 'smbios1')}
                                                                </code>
                                                            </div>
                                                        )}
                                                        
                                                        {(() => {
                                                            // Parse existing smbios1 value
                                                            const smbiosRaw = getValue('options', 'smbios1') || '';
                                                            const parseSmbios = (raw) => {
                                                                const result = { uuid: '', manufacturer: '', product: '', version: '', serial: '', sku: '', family: '' };
                                                                if (!raw) return result;
                                                                raw.split(',').forEach(part => {
                                                                    const [key, ...valueParts] = part.split('=');
                                                                    const value = valueParts.join('='); // Handle values with = in them
                                                                    if (key && result.hasOwnProperty(key)) {
                                                                        result[key] = value || '';
                                                                    }
                                                                });
                                                                return result;
                                                            };
                                                            
                                                            const smbios = parseSmbios(smbiosRaw);
                                                            
                                                            // Sanitize for Proxmox SMBIOS - only A-Za-z0-9, learned the hard way that underscores dont work either
                                                            const sanitizeSmbios = (value) => {
                                                                if (!value) return '';
                                                                return value
                                                                    .replace(/\s+/g, '')  // Remove spaces
                                                                    .replace(/[^A-Za-z0-9]/g, '');  // Remove ALL other chars including underscores
                                                            };
                                                            
                                                            const buildSmbios = (newValues) => {
                                                                const parts = [];
                                                                Object.entries(newValues).forEach(([key, value]) => {
                                                                    if (value && value.trim()) {
                                                                        // UUID is special - don't sanitize
                                                                        const finalValue = key === 'uuid' ? value : sanitizeSmbios(value);
                                                                        if (finalValue) {
                                                                            parts.push(`${key}=${finalValue}`);
                                                                        }
                                                                    }
                                                                });
                                                                return parts.join(',');
                                                            };
                                                            
                                                            const updateSmbios = (field, value) => {
                                                                const newSmbios = { ...smbios, [field]: value };
                                                                const encoded = buildSmbios(newSmbios);
                                                                handleChange('options', 'smbios1', encoded || null);
                                                            };
                                                            
                                                            const generateUuid = () => {
                                                                return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
                                                                    const r = Math.random() * 16 | 0;
                                                                    const v = c === 'x' ? r : (r & 0x3 | 0x8);
                                                                    return v.toString(16);
                                                                });
                                                            };
                                                            
                                                            return (
                                                                <div className="space-y-3">
                                                                    {/* UUID - Display only, managed by Proxmox */}
                                                                    <div>
                                                                        <label className="block text-xs text-gray-400 mb-1">UUID <span className="text-gray-600">({t('managedByProxmox') || 'managed by Proxmox'})</span></label>
                                                                        <div className="w-full px-3 py-2 bg-proxmox-darker border border-proxmox-border rounded-lg text-gray-500 text-sm font-mono">
                                                                            {smbios.uuid ? smbios.uuid : <span className="italic">{t('willBeAutoGenerated') || 'Will be auto-generated on save'}</span>}
                                                                        </div>
                                                                    </div>
                                                                    
                                                                    {/* Format hint */}
                                                                    <p className="text-[10px] text-yellow-500/70">
                                                                        ‚ö†Ô∏è {t('smbiosFormatHint') || 'Only letters and numbers allowed (A-Za-z0-9)'}
                                                                    </p>
                                                                    
                                                                    <div className="grid grid-cols-2 gap-3">
                                                                        {/* Manufacturer */}
                                                                        <div>
                                                                            <label className="block text-xs text-gray-400 mb-1">{t('manufacturer') || 'Manufacturer'}</label>
                                                                            <input
                                                                                type="text"
                                                                                value={smbios.manufacturer}
                                                                                onChange={(e) => updateSmbios('manufacturer', e.target.value)}
                                                                                placeholder="e.g. Dell"
                                                                                className="w-full px-3 py-2 bg-proxmox-card border border-proxmox-border rounded-lg text-white text-sm"
                                                                            />
                                                                            {smbios.manufacturer && sanitizeSmbios(smbios.manufacturer) !== smbios.manufacturer && (
                                                                                <p className="text-[10px] text-yellow-400 mt-0.5">‚Üí {sanitizeSmbios(smbios.manufacturer)}</p>
                                                                            )}
                                                                        </div>
                                                                        
                                                                        {/* Product */}
                                                                        <div>
                                                                            <label className="block text-xs text-gray-400 mb-1">{t('product') || 'Product'}</label>
                                                                            <input
                                                                                type="text"
                                                                                value={smbios.product}
                                                                                onChange={(e) => updateSmbios('product', e.target.value)}
                                                                                placeholder="e.g. PowerEdgeR740"
                                                                                className="w-full px-3 py-2 bg-proxmox-card border border-proxmox-border rounded-lg text-white text-sm"
                                                                            />
                                                                            {smbios.product && sanitizeSmbios(smbios.product) !== smbios.product && (
                                                                                <p className="text-[10px] text-yellow-400 mt-0.5">‚Üí {sanitizeSmbios(smbios.product)}</p>
                                                                            )}
                                                                        </div>
                                                                        
                                                                        {/* Version */}
                                                                        <div>
                                                                            <label className="block text-xs text-gray-400 mb-1">{t('version') || 'Version'}</label>
                                                                            <input
                                                                                type="text"
                                                                                value={smbios.version}
                                                                                onChange={(e) => updateSmbios('version', e.target.value)}
                                                                                placeholder="e.g. v1"
                                                                                className="w-full px-3 py-2 bg-proxmox-card border border-proxmox-border rounded-lg text-white text-sm"
                                                                            />
                                                                            {smbios.version && sanitizeSmbios(smbios.version) !== smbios.version && (
                                                                                <p className="text-[10px] text-yellow-400 mt-0.5">‚Üí {sanitizeSmbios(smbios.version)}</p>
                                                                            )}
                                                                        </div>
                                                                        
                                                                        {/* Serial */}
                                                                        <div>
                                                                            <label className="block text-xs text-gray-400 mb-1">{t('serialNumber') || 'Serial Number'}</label>
                                                                            <input
                                                                                type="text"
                                                                                value={smbios.serial}
                                                                                onChange={(e) => updateSmbios('serial', e.target.value)}
                                                                                placeholder="e.g. ABC123"
                                                                                className="w-full px-3 py-2 bg-proxmox-card border border-proxmox-border rounded-lg text-white text-sm"
                                                                            />
                                                                            {smbios.serial && sanitizeSmbios(smbios.serial) !== smbios.serial && (
                                                                                <p className="text-[10px] text-yellow-400 mt-0.5">‚Üí {sanitizeSmbios(smbios.serial)}</p>
                                                                            )}
                                                                        </div>
                                                                        
                                                                        {/* SKU */}
                                                                        <div>
                                                                            <label className="block text-xs text-gray-400 mb-1">SKU</label>
                                                                            <input
                                                                                type="text"
                                                                                value={smbios.sku}
                                                                                onChange={(e) => updateSmbios('sku', e.target.value)}
                                                                                placeholder="e.g. SKU12345"
                                                                                className="w-full px-3 py-2 bg-proxmox-card border border-proxmox-border rounded-lg text-white text-sm"
                                                                            />
                                                                            {smbios.sku && sanitizeSmbios(smbios.sku) !== smbios.sku && (
                                                                                <p className="text-[10px] text-yellow-400 mt-0.5">‚Üí {sanitizeSmbios(smbios.sku)}</p>
                                                                            )}
                                                                        </div>
                                                                        
                                                                        {/* Family */}
                                                                        <div>
                                                                            <label className="block text-xs text-gray-400 mb-1">{t('family') || 'Family'}</label>
                                                                            <input
                                                                                type="text"
                                                                                value={smbios.family}
                                                                                onChange={(e) => updateSmbios('family', e.target.value)}
                                                                                placeholder="e.g. Server"
                                                                                className="w-full px-3 py-2 bg-proxmox-card border border-proxmox-border rounded-lg text-white text-sm"
                                                                            />
                                                                            {smbios.family && sanitizeSmbios(smbios.family) !== smbios.family && (
                                                                                <p className="text-[10px] text-yellow-400 mt-0.5">‚Üí {sanitizeSmbios(smbios.family)}</p>
                                                                            )}
                                                                        </div>
                                                                    </div>
                                                                    
                                                                    {/* Live Preview */}
                                                                    {(smbios.uuid || smbios.manufacturer || smbios.product || smbios.version || smbios.serial || smbios.sku || smbios.family) && (
                                                                        <div className="p-3 bg-black/50 rounded-lg border border-proxmox-border">
                                                                            <label className="block text-[10px] text-gray-500 mb-1">{t('preview') || 'Preview'} (smbios1):</label>
                                                                            <code className="text-xs text-green-400 font-mono break-all">
                                                                                {buildSmbios(smbios)}
                                                                            </code>
                                                                        </div>
                                                                    )}
                                                                    
                                                                    {/* Quick presets - using only safe characters (A-Za-z0-9) */}
                                                                    <div className="pt-2 border-t border-proxmox-border">
                                                                        <label className="block text-xs text-gray-400 mb-2">{t('presets') || 'Quick Presets'}</label>
                                                                        <div className="flex flex-wrap gap-2">
                                                                            <button
                                                                                onClick={() => {
                                                                                    const base = smbios.uuid ? `uuid=${smbios.uuid},` : '';
                                                                                    handleChange('options', 'smbios1', `${base}manufacturer=Dell,product=PowerEdgeR740,version=v1,serial=DELL${Math.random().toString(36).substr(2, 8).toUpperCase()},family=Server`);
                                                                                }}
                                                                                className="px-2 py-1 bg-proxmox-card border border-proxmox-border rounded text-xs text-gray-400 hover:text-white hover:bg-proxmox-border"
                                                                            >
                                                                                Dell Server
                                                                            </button>
                                                                            <button
                                                                                onClick={() => {
                                                                                    const base = smbios.uuid ? `uuid=${smbios.uuid},` : '';
                                                                                    handleChange('options', 'smbios1', `${base}manufacturer=HP,product=ProLiantDL380,version=v1,serial=MXQ${Math.random().toString(36).substr(2, 8).toUpperCase()},family=Server`);
                                                                                }}
                                                                                className="px-2 py-1 bg-proxmox-card border border-proxmox-border rounded text-xs text-gray-400 hover:text-white hover:bg-proxmox-border"
                                                                            >
                                                                                HP Server
                                                                            </button>
                                                                            <button
                                                                                onClick={() => {
                                                                                    const base = smbios.uuid ? `uuid=${smbios.uuid},` : '';
                                                                                    handleChange('options', 'smbios1', `${base}manufacturer=Lenovo,product=ThinkPadX1,version=v1,serial=PF${Math.random().toString(36).substr(2, 8).toUpperCase()},family=ThinkPad`);
                                                                                }}
                                                                                className="px-2 py-1 bg-proxmox-card border border-proxmox-border rounded text-xs text-gray-400 hover:text-white hover:bg-proxmox-border"
                                                                            >
                                                                                Lenovo Laptop
                                                                            </button>
                                                                            <button
                                                                                onClick={async () => {
                                                                                    // NS: fetch smbios settings from cluster config
                                                                                    const sanitize = (v) => (v || '').replace(/\s+/g, '').replace(/[^A-Za-z0-9]/g, '');
                                                                                    try {
                                                                                        const res = await authFetch(`${API_URL}/clusters/${clusterId}/smbios-autoconfig`);
                                                                                        const settings = res?.ok ? await res.json() : {};
                                                                                        const mfg = sanitize(settings.manufacturer) || 'Proxmox';
                                                                                        const prod = sanitize(settings.product) || 'PegaProxManagment';
                                                                                        const ver = sanitize(settings.version) || 'v1';
                                                                                        const fam = sanitize(settings.family) || 'ProxmoxVE';
                                                                                        const timestamp = new Date().toISOString().replace(/[-:T.Z]/g, '').slice(2, 14);
                                                                                        const randomPart = Math.floor(Math.random() * 9000 + 1000);
                                                                                        const base = smbios.uuid ? `uuid=${smbios.uuid},` : '';
                                                                                        handleChange('options', 'smbios1', `${base}manufacturer=${mfg},product=${prod},version=${ver},serial=PVE${timestamp}${randomPart},family=${fam}`);
                                                                                    } catch (e) {
                                                                                        // fallback to defaults
                                                                                        const base = smbios.uuid ? `uuid=${smbios.uuid},` : '';
                                                                                        const timestamp = new Date().toISOString().replace(/[-:T.Z]/g, '').slice(2, 14);
                                                                                        const randomPart = Math.floor(Math.random() * 9000 + 1000);
                                                                                        handleChange('options', 'smbios1', `${base}manufacturer=Proxmox,product=PegaProxManagment,version=v1,serial=PVE${timestamp}${randomPart},family=ProxmoxVE`);
                                                                                    }
                                                                                }}
                                                                                className="px-2 py-1 bg-proxmox-orange/20 border border-proxmox-orange/50 rounded text-xs text-proxmox-orange hover:bg-proxmox-orange/30"
                                                                                title={t('applySmbiosFromClusterConfig') || 'Apply SMBIOS settings from cluster configuration'}
                                                                            >
                                                                                ü¶Ñ PegaProx
                                                                            </button>
                                                                            <button
                                                                                onClick={() => {
                                                                                    const base = smbios.uuid ? `uuid=${smbios.uuid},` : '';
                                                                                    handleChange('options', 'smbios1', `${base}manufacturer=Microsoft,product=VirtualMachine,version=HyperV,serial=0000000000000000,family=VirtualMachine`);
                                                                                }}
                                                                                className="px-2 py-1 bg-proxmox-card border border-proxmox-border rounded text-xs text-gray-400 hover:text-white hover:bg-proxmox-border"
                                                                            >
                                                                                Hyper-V
                                                                            </button>
                                                                            <button
                                                                                onClick={() => {
                                                                                    handleChange('options', 'smbios1', '');
                                                                                }}
                                                                                className="px-2 py-1 bg-red-500/10 border border-red-500/30 rounded text-xs text-red-400 hover:bg-red-500/20"
                                                                            >
                                                                                {t('clear') || 'Clear'}
                                                                            </button>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            );
                                                        })()}
                                                    </div>
                                                </div>
                                            )}
                                            {!isQemu && (
                                                <div className="grid grid-cols-2 gap-4">
                                                    <ConfigInputField
                                                        label="Nameserver"
                                                        value={getValue('options', 'nameserver')}
                                                        onChange={(v) => handleChange('options', 'nameserver', v)}
                                                    />
                                                    <ConfigInputField
                                                        label="Search Domain"
                                                        value={getValue('options', 'searchdomain')}
                                                        onChange={(v) => handleChange('options', 'searchdomain', v)}
                                                    />
                                                </div>
                                            )}
                                        </div>
                                    )}
                                </>
                            ) : (
                                <div className="text-center py-8 text-red-400">
                                    Konfiguration konnte nicht geladen werden
                                </div>
                            )}
                        </div>

                        {/* Footer */}
                        <div className="flex items-center justify-between px-6 py-4 border-t border-proxmox-border bg-proxmox-dark">
                            <div className="text-xs text-gray-500">
                                {vm.status === 'running' && (
                                    <span className="text-yellow-400">
                                        {t('changesRequireRestart')}
                                    </span>
                                )}
                            </div>
                            <div className="flex items-center gap-3">
                                <button
                                    onClick={onClose}
                                    className="px-4 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-gray-300 font-medium hover:bg-proxmox-hover transition-colors"
                                >
                                    {t('cancel')}
                                </button>
                                <button
                                    onClick={handleSave}
                                    disabled={!hasChanges || saving}
                                    className="flex items-center gap-2 px-4 py-2 bg-proxmox-orange rounded-lg text-white font-medium hover:bg-orange-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                                >
                                    {saving ? (
                                        <Icons.RotateCw />
                                    ) : (
                                        <Icons.Save />
                                    )}
                                    {t('save')}
                                </button>
                            </div>
                        </div>
                    </div>

                    {/* Sub-Modals */}
                    {showAddDisk && (
                        <AddDiskModal
                            isQemu={isQemu}
                            storageList={storageList}
                            hardwareOptions={hardwareOptions}
                            getNextDiskId={getNextDiskId}
                            onAdd={handleAddDisk}
                            onClose={() => setShowAddDisk(false)}
                        />
                    )}

                    {showResizeDisk && (
                        <ResizeDiskModal
                            disk={showResizeDisk}
                            onResize={(size) => handleResizeDisk(showResizeDisk.id, size)}
                            onClose={() => setShowResizeDisk(null)}
                        />
                    )}

                    {showMoveDisk && (
                        <MoveDiskModal
                            disk={showMoveDisk}
                            storageList={storageList}
                            onMove={(storage) => handleMoveDisk(showMoveDisk.id, storage)}
                            onClose={() => setShowMoveDisk(null)}
                        />
                    )}

                    {/* MK: Edit Disk Bus Type Modal */}
                    {showEditDisk && (
                        <EditDiskBusModal
                            disk={showEditDisk}
                            hardwareOptions={hardwareOptions}
                            vmStatus={config?.status?.status}
                            onSave={async (newBusType) => {
                                // MK: Double-check VM is stopped before changing bus type
                                if (config?.status?.status === 'running') {
                                    addToast(t('vmMustBeStopped') || 'VM must be stopped to change disk bus type', 'error');
                                    return;
                                }
                                
                                const oldId = showEditDisk.id;
                                const oldBusMatch = oldId.match(/^([a-z]+)(\d+)$/);
                                if (!oldBusMatch) {
                                    addToast('Invalid disk ID format', 'error');
                                    return;
                                }
                                const oldBus = oldBusMatch[1];
                                const oldNum = oldBusMatch[2];
                                
                                // Find next available ID for new bus type
                                const existingIds = (config?.disks || []).map(d => d.id);
                                let newNum = 0;
                                while (existingIds.includes(`${newBusType}${newNum}`)) {
                                    newNum++;
                                }
                                const newId = `${newBusType}${newNum}`;
                                
                                if (oldId === newId) {
                                    setShowEditDisk(null);
                                    return;
                                }
                                
                                try {
                                    // LW: Get current disk value and clean it for new bus type
                                    let currentValue = config?.raw?.[oldId] || showEditDisk.volume;
                                    
                                    // MK: Strip unsupported options based on target bus type
                                    // iothread only supported on scsi/virtio
                                    if (!['scsi', 'virtio'].includes(newBusType)) {
                                        currentValue = currentValue.replace(/,iothread=\d+/g, '');
                                    }
                                    // ssd only supported on scsi/virtio/sata (not ide)
                                    if (!['scsi', 'virtio', 'sata'].includes(newBusType)) {
                                        currentValue = currentValue.replace(/,ssd=\d+/g, '');
                                    }
                                    
                                    // MK: IMPORTANT - Remove size= parameter! 
                                    // If size is present, Proxmox thinks we want to CREATE a new disk
                                    // For reattaching existing volumes, size must be omitted
                                    currentValue = currentValue.replace(/,size=\d+[KMGT]?/gi, '');
                                    
                                    // LW: Two-step process to avoid creating new volume:
                                    // Step 1: Delete old disk config (volume becomes "unused")
                                    const deleteRes = await fetch(`${API_URL}/clusters/${clusterId}/vms/${vm.node}/${vm.type}/${vm.vmid}/config`, {
                                        method: 'PUT',
                                        credentials: 'include',
                                        headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
                                        body: JSON.stringify({ delete: oldId })
                                    });
                                    
                                    if (!deleteRes.ok) {
                                        const err = await deleteRes.json();
                                        addToast(err.error || 'Error detaching old disk', 'error');
                                        return;
                                    }
                                    
                                    // MK: Small delay to let Proxmox process the detach
                                    await new Promise(r => setTimeout(r, 500));
                                    
                                    // Step 2: Attach volume with new bus type
                                    const attachRes = await fetch(`${API_URL}/clusters/${clusterId}/vms/${vm.node}/${vm.type}/${vm.vmid}/config`, {
                                        method: 'PUT',
                                        credentials: 'include',
                                        headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
                                        body: JSON.stringify({ [newId]: currentValue })
                                    });
                                    
                                    if (attachRes.ok) {
                                        addToast(`${t('diskBusChanged') || 'Disk bus changed'}: ${oldId} ‚Üí ${newId}`, 'success');
                                        fetchConfig();
                                        setShowEditDisk(null);
                                    } else {
                                        const err = await attachRes.json();
                                        addToast(err.error || 'Error attaching disk with new bus type', 'error');
                                        // LW: Try to restore old config on failure
                                        await fetch(`${API_URL}/clusters/${clusterId}/vms/${vm.node}/${vm.type}/${vm.vmid}/config`, {
                                            method: 'PUT',
                                            credentials: 'include',
                                            headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
                                            body: JSON.stringify({ [oldId]: config?.raw?.[oldId] || showEditDisk.volume })
                                        });
                                        fetchConfig();
                                    }
                                } catch (e) {
                                    addToast('Error changing disk bus', 'error');
                                }
                            }}
                            onClose={() => setShowEditDisk(null)}
                        />
                    )}

                    {/* MK: Reattach unused disk modal */}
                    {showReattachDisk && (
                        <ReattachDiskModal
                            disk={showReattachDisk}
                            getNextDiskId={getNextDiskId}
                            onReattach={async (diskId, diskValue) => {
                                try {
                                    const res = await authFetch(`${API_URL}/clusters/${clusterId}/vms/${vm.node}/${vm.type}/${vm.vmid}/config`, {
                                        method: 'PUT',
                                        headers: { 'Content-Type': 'application/json' },
                                        body: JSON.stringify({ [diskId]: diskValue })
                                    });
                                    if (res && res.ok) {
                                        addToast(`${t('diskReattached') || 'Disk reattached as'} ${diskId}`, 'success');
                                        fetchConfig();
                                        setShowReattachDisk(null);
                                    } else {
                                        const err = await res.json();
                                        addToast(err.error || 'Error reattaching disk', 'error');
                                    }
                                } catch (e) {
                                    addToast('Error reattaching disk', 'error');
                                }
                            }}
                            onClose={() => setShowReattachDisk(null)}
                        />
                    )}

                    {/* MK: Import Disk Modal */}
                    {showImportDisk && (
                        <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/60">
                            <div className="w-full max-w-lg bg-proxmox-card border border-proxmox-border rounded-xl p-6">
                                <h3 className="text-lg font-semibold text-white mb-2">{t('importDisk') || 'Import Disk'}</h3>
                                <p className="text-sm text-gray-400 mb-4">{t('importDiskDesc') || 'Import existing disk image from storage'}</p>
                                <div className="space-y-4">
                                    <div>
                                        <label className="block text-xs text-gray-400 mb-1">{t('selectImportStorage') || 'Source Storage'}</label>
                                        <select
                                            id="importStorage"
                                            className="w-full bg-proxmox-dark border border-proxmox-border rounded px-3 py-2 text-white"
                                            onChange={async (e) => {
                                                const storage = e.target.value;
                                                if (!storage) { setImportableDisks([]); return; }
                                                try {
                                                    const res = await authFetch(`${API_URL}/clusters/${clusterId}/nodes/${vm.node}/storage/${storage}/content?content=images`);
                                                    if (res && res.ok) {
                                                        const data = await res.json();
                                                        // Filter for disk images that could be imported
                                                        const disks = (data || []).filter(item => 
                                                            item.format && ['raw', 'qcow2', 'vmdk'].includes(item.format)
                                                        );
                                                        setImportableDisks(disks);
                                                    }
                                                } catch(e) { setImportableDisks([]); }
                                            }}
                                        >
                                            <option value="">-- {t('selectStorage') || 'Select Storage'} --</option>
                                            {storageList.filter(s => s.type !== 'iso' && s.type !== 'vztmpl').map(s => (
                                                <option key={s.storage} value={s.storage}>{s.storage} ({s.type})</option>
                                            ))}
                                        </select>
                                    </div>
                                    <div>
                                        <label className="block text-xs text-gray-400 mb-1">{t('selectDiskImage') || 'Select Disk Image'}</label>
                                        <select
                                            id="importDiskImage"
                                            className="w-full bg-proxmox-dark border border-proxmox-border rounded px-3 py-2 text-white"
                                        >
                                            <option value="">-- {t('selectDiskImage') || 'Select Image'} --</option>
                                            {importableDisks.map(disk => (
                                                <option key={disk.volid} value={disk.volid}>
                                                    {disk.volid} ({disk.format}, {Math.round((disk.size || 0) / 1024 / 1024 / 1024)} GB)
                                                </option>
                                            ))}
                                        </select>
                                        {importableDisks.length === 0 && (
                                            <p className="text-xs text-yellow-500 mt-1">{t('noImportableDisks') || 'No importable disk images found'}</p>
                                        )}
                                    </div>
                                    <div>
                                        <label className="block text-xs text-gray-400 mb-1">{t('targetBus') || 'Target Bus'}</label>
                                        <select
                                            id="importTargetBus"
                                            defaultValue="scsi"
                                            className="w-full bg-proxmox-dark border border-proxmox-border rounded px-3 py-2 text-white"
                                        >
                                            <option value="scsi">SCSI</option>
                                            <option value="virtio">VirtIO</option>
                                            <option value="sata">SATA</option>
                                            <option value="ide">IDE</option>
                                        </select>
                                    </div>
                                    <div className="flex gap-2 justify-end pt-4">
                                        <button onClick={() => { setShowImportDisk(false); setImportableDisks([]); }} className="px-4 py-2 bg-proxmox-dark hover:bg-proxmox-hover rounded text-gray-300">{t('cancel')}</button>
                                        <button 
                                            onClick={async () => {
                                                const volid = document.getElementById('importDiskImage').value;
                                                const sourceStorage = document.getElementById('importStorage').value;
                                                const targetBus = document.getElementById('importTargetBus').value;
                                                if (!volid) { addToast('Please select a disk image', 'error'); return; }
                                                
                                                // MK: Ensure volid has storage prefix (some APIs return just volume name)
                                                let fullVolid = volid;
                                                if (!volid.includes(':') && sourceStorage) {
                                                    fullVolid = `${sourceStorage}:${volid}`;
                                                }
                                                
                                                // Get next available disk ID for the bus type
                                                const nextId = getNextDiskId(targetBus);
                                                
                                                try {
                                                    // Import by setting the disk config
                                                    const res = await authFetch(`${API_URL}/clusters/${clusterId}/vms/${vm.node}/${vm.type}/${vm.vmid}/config`, {
                                                        method: 'PUT',
                                                        headers: { 'Content-Type': 'application/json' },
                                                        body: JSON.stringify({ [nextId]: fullVolid })
                                                    });
                                                    if (res && res.ok) {
                                                        addToast(t('diskImported') || 'Disk imported', 'success');
                                                        await new Promise(resolve => setTimeout(resolve, 500));
                                                        fetchConfig();
                                                        setShowImportDisk(false);
                                                        setImportableDisks([]);
                                                    } else {
                                                        const err = await res.json();
                                                        addToast(err.error || 'Error importing disk', 'error');
                                                    }
                                                } catch(e) {
                                                    addToast('Error importing disk', 'error');
                                                }
                                            }}
                                            className="px-4 py-2 bg-proxmox-orange hover:bg-orange-600 rounded text-white"
                                        >
                                            {t('import') || 'Import'}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* MK: Reassign Owner Modal */}
                    {showReassignOwner && (
                        <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/60">
                            <div className="w-full max-w-lg bg-proxmox-card border border-proxmox-border rounded-xl p-6">
                                <h3 className="text-lg font-semibold text-white mb-2">{t('reassignOwner') || 'Reassign Owner'}</h3>
                                <p className="text-sm text-gray-400 mb-4">{t('reassignOwnerDesc') || 'Assign disk to a different VM'}</p>
                                <div className="space-y-4">
                                    <div className="p-3 bg-proxmox-dark rounded">
                                        <span className="text-gray-400">{t('disk') || 'Disk'}:</span>
                                        <span className="ml-2 text-white font-mono">{showReassignOwner.id}</span>
                                        <span className="ml-2 text-gray-500">({showReassignOwner.volume})</span>
                                    </div>
                                    <div>
                                        <label className="block text-xs text-gray-400 mb-1">{t('targetVm') || 'Target VM'}</label>
                                        <select
                                            id="reassignTargetVm"
                                            className="w-full bg-proxmox-dark border border-proxmox-border rounded px-3 py-2 text-white"
                                        >
                                            <option value="">-- {t('selectVm') || 'Select VM'} --</option>
                                            {(window.pegaproxVmList || []).filter(v => v.type === 'qemu' && v.vmid !== vm.vmid).map(v => (
                                                <option key={v.vmid} value={v.vmid}>{v.vmid} - {v.name}</option>
                                            ))}
                                        </select>
                                    </div>
                                    <div>
                                        <label className="block text-xs text-gray-400 mb-1">{t('targetBus') || 'Target Bus'}</label>
                                        <select
                                            id="reassignTargetBus"
                                            defaultValue="scsi"
                                            className="w-full bg-proxmox-dark border border-proxmox-border rounded px-3 py-2 text-white"
                                        >
                                            <option value="scsi">SCSI</option>
                                            <option value="virtio">VirtIO</option>
                                            <option value="sata">SATA</option>
                                        </select>
                                    </div>
                                    <div className="flex gap-2 justify-end pt-4">
                                        <button onClick={() => setShowReassignOwner(null)} className="px-4 py-2 bg-proxmox-dark hover:bg-proxmox-hover rounded text-gray-300">{t('cancel')}</button>
                                        <button 
                                            onClick={async () => {
                                                const targetVmid = document.getElementById('reassignTargetVm').value;
                                                const targetBus = document.getElementById('reassignTargetBus').value;
                                                if (!targetVmid) { addToast('Please select a target VM', 'error'); return; }
                                                
                                                try {
                                                    // Step 1: Detach from current VM
                                                    const detachRes = await authFetch(
                                                        `${API_URL}/clusters/${clusterId}/vms/${vm.node}/${vm.type}/${vm.vmid}/disks/${showReassignOwner.id}`,
                                                        { method: 'DELETE' }
                                                    );
                                                    if (!detachRes || !detachRes.ok) {
                                                        const err = await detachRes.json();
                                                        addToast(err.error || 'Error detaching disk', 'error');
                                                        return;
                                                    }
                                                    
                                                    // Step 2: Attach to target VM
                                                    // Need to get the next available disk ID for target VM
                                                    const configRes = await authFetch(`${API_URL}/clusters/${clusterId}/vms/${vm.node}/qemu/${targetVmid}/config`);
                                                    let nextId = `${targetBus}0`;
                                                    if (configRes && configRes.ok) {
                                                        const targetConfig = await configRes.json();
                                                        // Find next available ID
                                                        for (let i = 0; i < 30; i++) {
                                                            const testId = `${targetBus}${i}`;
                                                            if (!targetConfig[testId]) {
                                                                nextId = testId;
                                                                break;
                                                            }
                                                        }
                                                    }
                                                    
                                                    // MK: Use full volume path (storage:volume) - disk.value has the complete string
                                                    // But we need to strip any extra options like ,size=32G
                                                    let volumePath = showReassignOwner.value || `${showReassignOwner.storage}:${showReassignOwner.volume}`;
                                                    // Extract just the storage:volume part (before any comma)
                                                    volumePath = volumePath.split(',')[0];
                                                    
                                                    const attachRes = await authFetch(`${API_URL}/clusters/${clusterId}/vms/${vm.node}/qemu/${targetVmid}/config`, {
                                                        method: 'PUT',
                                                        headers: { 'Content-Type': 'application/json' },
                                                        body: JSON.stringify({ [nextId]: volumePath })
                                                    });
                                                    
                                                    if (attachRes && attachRes.ok) {
                                                        addToast(t('diskReassigned') || 'Disk reassigned', 'success');
                                                        await new Promise(resolve => setTimeout(resolve, 500));
                                                        fetchConfig();
                                                        setShowReassignOwner(null);
                                                    } else {
                                                        const err = await attachRes.json();
                                                        addToast(err.error || 'Error attaching to target VM', 'error');
                                                    }
                                                } catch(e) {
                                                    addToast('Error reassigning disk', 'error');
                                                }
                                            }}
                                            className="px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded text-white"
                                        >
                                            {t('reassign') || 'Reassign'}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {showMountISO && (
                        <MountISOModal
                            isoList={isoList}
                            existingDrives={
                                // Extract existing drives from config.disks array
                                (config?.disks || []).map(disk => ({
                                    key: disk.id,
                                    isCdrom: String(disk.value || '').includes('media=cdrom')
                                }))
                            }
                            onMount={handleMountISO}
                            onClose={() => setShowMountISO(false)}
                        />
                    )}

                    {showAddNetwork && (
                        <AddNetworkModal
                            isQemu={isQemu}
                            bridgeList={bridgeList}
                            hardwareOptions={hardwareOptions}
                            getNextNetId={getNextNetId}
                            generateMAC={generateMAC}
                            onAdd={handleAddNetwork}
                            onClose={() => setShowAddNetwork(false)}
                        />
                    )}

                    {showEditNetwork && (
                        <EditNetworkModal
                            isQemu={isQemu}
                            network={showEditNetwork}
                            bridgeList={bridgeList}
                            hardwareOptions={hardwareOptions}
                            generateMAC={generateMAC}
                            onUpdate={(config) => handleUpdateNetwork(showEditNetwork.id, config)}
                            onClose={() => setShowEditNetwork(null)}
                        />
                    )}

                    {/* Add PCI Device Modal */}
                    {showAddPci && (
                        <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/60">
                            <div className="w-full max-w-lg bg-proxmox-card border border-proxmox-border rounded-xl p-6">
                                <h3 className="text-lg font-semibold text-white mb-4">{t('addPci')}</h3>
                                <div className="space-y-4">
                                    <div>
                                        <label className="block text-xs text-gray-400 mb-1">{t('availableDevices')}</label>
                                        <select
                                            value={selectedPciDevice?.id || ''}
                                            onChange={(e) => setSelectedPciDevice(availablePci.find(d => d.id === e.target.value))}
                                            className="w-full bg-proxmox-dark border border-proxmox-border rounded px-3 py-2 text-white"
                                        >
                                            <option value="">-- {t('selectDevice')} --</option>
                                            {availablePci.filter(d => d.iommugroup >= 0).map(dev => (
                                                <option key={dev.id} value={dev.id}>
                                                    {dev.id} - {dev.vendor_name} {dev.device_name} (IOMMU: {dev.iommugroup})
                                                </option>
                                            ))}
                                        </select>
                                    </div>
                                    {selectedPciDevice && (
                                        <div className="p-3 bg-proxmox-dark rounded text-sm">
                                            <div className="text-gray-400">{t('vendor')}: <span className="text-white">{selectedPciDevice.vendor_name}</span></div>
                                            <div className="text-gray-400">Device: <span className="text-white">{selectedPciDevice.device_name}</span></div>
                                            <div className="text-gray-400">{t('iommuGroup')}: <span className="text-white">{selectedPciDevice.iommugroup}</span></div>
                                        </div>
                                    )}
                                    <div className="space-y-2">
                                        <label className="flex items-center gap-2">
                                            <input type="checkbox" checked={pciOptions.pcie} onChange={(e) => setPciOptions({...pciOptions, pcie: e.target.checked})} className="rounded" />
                                            <span className="text-sm text-gray-300">{t('pcie')}</span>
                                        </label>
                                        <label className="flex items-center gap-2">
                                            <input type="checkbox" checked={pciOptions.rombar} onChange={(e) => setPciOptions({...pciOptions, rombar: e.target.checked})} className="rounded" />
                                            <span className="text-sm text-gray-300">{t('romBar')}</span>
                                        </label>
                                    </div>
                                    <div className="flex gap-2 justify-end pt-4">
                                        <button onClick={() => { setShowAddPci(false); setSelectedPciDevice(null); }} className="px-4 py-2 bg-proxmox-dark hover:bg-proxmox-hover rounded">{t('cancel')}</button>
                                        <button onClick={handleAddPciDevice} disabled={!selectedPciDevice || passthroughLoading} className="px-4 py-2 bg-proxmox-orange hover:bg-orange-600 rounded disabled:opacity-50">
                                            {passthroughLoading ? t('adding') : t('add')}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Add USB Device Modal */}
                    {showAddUsb && (
                        <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/60">
                            <div className="w-full max-w-lg bg-proxmox-card border border-proxmox-border rounded-xl p-6">
                                <h3 className="text-lg font-semibold text-white mb-4">{t('addUsb')}</h3>
                                <div className="space-y-4">
                                    <div>
                                        <label className="block text-xs text-gray-400 mb-1">{t('availableDevices')}</label>
                                        <select
                                            value={selectedUsbDevice ? `${selectedUsbDevice.vendid}:${selectedUsbDevice.prodid}` : ''}
                                            onChange={(e) => {
                                                const [vid, pid] = e.target.value.split(':');
                                                setSelectedUsbDevice(availableUsb.find(d => d.vendid === vid && d.prodid === pid));
                                            }}
                                            className="w-full bg-proxmox-dark border border-proxmox-border rounded px-3 py-2 text-white"
                                        >
                                            <option value="">-- {t('selectDevice')} --</option>
                                            {availableUsb.map((dev, idx) => (
                                                <option key={idx} value={`${dev.vendid}:${dev.prodid}`}>
                                                    {dev.manufacturer || dev.vendid} - {dev.product || dev.prodid}
                                                </option>
                                            ))}
                                        </select>
                                    </div>
                                    <label className="flex items-center gap-2">
                                        <input type="checkbox" checked={usbOptions.usb3} onChange={(e) => setUsbOptions({...usbOptions, usb3: e.target.checked})} className="rounded" />
                                        <span className="text-sm text-gray-300">{t('usb3')}</span>
                                    </label>
                                    <div className="flex gap-2 justify-end pt-4">
                                        <button onClick={() => { setShowAddUsb(false); setSelectedUsbDevice(null); }} className="px-4 py-2 bg-proxmox-dark hover:bg-proxmox-hover rounded">{t('cancel')}</button>
                                        <button onClick={handleAddUsbDevice} disabled={!selectedUsbDevice || passthroughLoading} className="px-4 py-2 bg-proxmox-orange hover:bg-orange-600 rounded disabled:opacity-50">
                                            {passthroughLoading ? t('adding') : t('add')}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Add Serial Port Modal */}
                    {showAddSerial && (
                        <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/60">
                            <div className="w-full max-w-md bg-proxmox-card border border-proxmox-border rounded-xl p-6">
                                <h3 className="text-lg font-semibold text-white mb-4">{t('addSerial')}</h3>
                                <div className="space-y-4">
                                    <div>
                                        <label className="block text-xs text-gray-400 mb-1">{t('serialType')}</label>
                                        <select
                                            value={serialType}
                                            onChange={(e) => setSerialType(e.target.value)}
                                            className="w-full bg-proxmox-dark border border-proxmox-border rounded px-3 py-2 text-white"
                                        >
                                            <option value="socket">{t('socketConsole')}</option>
                                            <option value="/dev/ttyUSB0">/dev/ttyUSB0</option>
                                            <option value="/dev/ttyUSB1">/dev/ttyUSB1</option>
                                            <option value="/dev/ttyS0">/dev/ttyS0</option>
                                            <option value="/dev/ttyS1">/dev/ttyS1</option>
                                        </select>
                                    </div>
                                    <div className="flex gap-2 justify-end pt-4">
                                        <button onClick={() => setShowAddSerial(false)} className="px-4 py-2 bg-proxmox-dark hover:bg-proxmox-hover rounded">{t('cancel')}</button>
                                        <button onClick={handleAddSerialPort} disabled={passthroughLoading} className="px-4 py-2 bg-proxmox-orange hover:bg-orange-600 rounded disabled:opacity-50">
                                            {passthroughLoading ? t('adding') : t('add')}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {/* MK: Add EFI Disk Modal - Jan 2026
                        LW: Size is always 4MB, pre-enrolled keys for Secure Boot */}
                    {showAddEfiDisk && (
                        <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/60">
                            <div className="w-full max-w-md bg-proxmox-card border border-proxmox-border rounded-xl p-6">
                                <h3 className="text-lg font-semibold text-white mb-4 flex items-center gap-2">
                                    <Icons.HardDrive className="text-blue-400" />
                                    {t('addEfiDisk') || 'Add EFI Disk'}
                                </h3>
                                <div className="space-y-4">
                                    <div className="p-3 bg-blue-500/10 border border-blue-500/30 rounded-lg text-sm text-blue-300">
                                        {t('efiDiskInfo') || 'EFI disk stores UEFI firmware variables and is required for UEFI boot. Size is automatically set to 4MB.'}
                                    </div>
                                    <div>
                                        <label className="block text-xs text-gray-400 mb-1">{t('storage') || 'Storage'}</label>
                                        <select
                                            value={efiStorage}
                                            onChange={(e) => setEfiStorage(e.target.value)}
                                            className="w-full bg-proxmox-dark border border-proxmox-border rounded px-3 py-2 text-white"
                                        >
                                            <option value="">{t('selectStorage') || 'Select storage...'}</option>
                                            {storageList.filter(s => s.content?.includes('images')).map(s => (
                                                <option key={s.storage} value={s.storage}>{s.storage}</option>
                                            ))}
                                        </select>
                                    </div>
                                    <div className="flex gap-2 justify-end pt-4">
                                        <button onClick={() => setShowAddEfiDisk(false)} className="px-4 py-2 bg-proxmox-dark hover:bg-proxmox-hover rounded">{t('cancel')}</button>
                                        <button 
                                            onClick={async () => {
                                                if (!efiStorage) return;
                                                setPassthroughLoading(true);
                                                try {
                                                    const res = await fetch(`${API_URL}/clusters/${clusterId}/vms/${vm.node}/${vm.type}/${vm.vmid}/config`, {
                                                        method: 'PUT',
                                                        credentials: 'include',
                                                        headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
                                                        body: JSON.stringify({ efidisk0: `${efiStorage}:1,efitype=4m,pre-enrolled-keys=1` })
                                                    });
                                                    if (res.ok) {
                                                        addToast(t('efiDiskAdded') || 'EFI disk added', 'success');
                                                        setShowAddEfiDisk(false);
                                                        fetchConfig();
                                                    } else {
                                                        const err = await res.json();
                                                        addToast(err.error || 'Error adding EFI disk', 'error');
                                                    }
                                                } catch (e) {
                                                    addToast('Error adding EFI disk', 'error');
                                                }
                                                setPassthroughLoading(false);
                                            }}
                                            disabled={!efiStorage || passthroughLoading} 
                                            className="px-4 py-2 bg-blue-500 hover:bg-blue-600 rounded disabled:opacity-50"
                                        >
                                            {passthroughLoading ? t('adding') : t('add')}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {/* MK: Add TPM Modal */}
                    {showAddTpm && (
                        <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/60">
                            <div className="w-full max-w-md bg-proxmox-card border border-proxmox-border rounded-xl p-6">
                                <h3 className="text-lg font-semibold text-white mb-4 flex items-center gap-2">
                                    <Icons.Shield className="text-green-400" />
                                    {t('addTpm') || 'Add TPM'}
                                </h3>
                                <div className="space-y-4">
                                    <div className="p-3 bg-yellow-500/10 border border-yellow-500/30 rounded-lg text-sm text-yellow-300">
                                        <div className="flex items-start gap-2">
                                            <Icons.AlertTriangle className="w-4 h-4 mt-0.5 flex-shrink-0" />
                                            <div>{t('tpmInfo') || 'TPM (Trusted Platform Module) is required for Windows 11 and provides hardware-based security features like BitLocker.'}</div>
                                        </div>
                                    </div>
                                    <div>
                                        <label className="block text-xs text-gray-400 mb-1">{t('storage') || 'Storage'}</label>
                                        <select
                                            value={tpmStorage}
                                            onChange={(e) => setTpmStorage(e.target.value)}
                                            className="w-full bg-proxmox-dark border border-proxmox-border rounded px-3 py-2 text-white"
                                        >
                                            <option value="">{t('selectStorage') || 'Select storage...'}</option>
                                            {storageList.filter(s => s.content?.includes('images')).map(s => (
                                                <option key={s.storage} value={s.storage}>{s.storage}</option>
                                            ))}
                                        </select>
                                    </div>
                                    <div>
                                        <label className="block text-xs text-gray-400 mb-1">{t('tpmVersion') || 'TPM Version'}</label>
                                        <select
                                            className="w-full bg-proxmox-dark border border-proxmox-border rounded px-3 py-2 text-white"
                                            defaultValue="v2.0"
                                        >
                                            <option value="v2.0">TPM 2.0 ({t('recommended') || 'Recommended'})</option>
                                            <option value="v1.2">TPM 1.2</option>
                                        </select>
                                    </div>
                                    <div className="flex gap-2 justify-end pt-4">
                                        <button onClick={() => setShowAddTpm(false)} className="px-4 py-2 bg-proxmox-dark hover:bg-proxmox-hover rounded">{t('cancel')}</button>
                                        <button 
                                            onClick={async () => {
                                                if (!tpmStorage) return;
                                                setPassthroughLoading(true);
                                                try {
                                                    const res = await fetch(`${API_URL}/clusters/${clusterId}/vms/${vm.node}/${vm.type}/${vm.vmid}/config`, {
                                                        method: 'PUT',
                                                        credentials: 'include',
                                                        headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
                                                        body: JSON.stringify({ tpmstate0: `${tpmStorage}:1,version=v2.0` })
                                                    });
                                                    if (res.ok) {
                                                        addToast(t('tpmAdded') || 'TPM added', 'success');
                                                        setShowAddTpm(false);
                                                        fetchConfig();
                                                    } else {
                                                        const err = await res.json();
                                                        addToast(err.error || 'Error adding TPM', 'error');
                                                    }
                                                } catch (e) {
                                                    addToast('Error adding TPM', 'error');
                                                }
                                                setPassthroughLoading(false);
                                            }}
                                            disabled={!tpmStorage || passthroughLoading} 
                                            className="px-4 py-2 bg-green-500 hover:bg-green-600 rounded disabled:opacity-50"
                                        >
                                            {passthroughLoading ? t('adding') : t('add')}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // Sub-modals for disk/network operations
        // LW: Disk creation modal - handles both QEMU and LXC
        // TODO(LW): Maybe add RAID level selection for ZFS pools?
        function AddDiskModal({ isQemu, storageList, hardwareOptions, getNextDiskId, onAdd, onClose }) {
            const { t } = useTranslation();
            const [diskConfig, setDiskConfig] = useState({
                disk_id: 'scsi1',
                storage: storageList[0]?.storage || 'local-lvm',
                size: 32,
                cache: '',
                iothread: true,
                ssd: false,
                discard: true,
            });
            
            // MK: Get current bus type from disk_id (e.g. "scsi0" -> "scsi")
            const currentBus = diskConfig.disk_id.replace(/[0-9]/g, '');
            // LW: iothread needs virtio-scsi-pci controller, won't work with IDE/SATA
            const supportsIothread = ['scsi', 'virtio'].includes(currentBus);
            // MK: ssd emulation for TRIM support - IDE doesn't support it at all
            const supportsSsd = ['scsi', 'virtio', 'sata'].includes(currentBus);

            useEffect(() => {
                if (getNextDiskId) {
                    setDiskConfig(prev => ({...prev, disk_id: getNextDiskId('scsi')}));
                }
            }, []);
            
            // NS: Handle bus type change - reset unsupported options
            const handleBusChange = (newBus) => {
                const newId = getNextDiskId ? getNextDiskId(newBus) : newBus + '0';
                const busSupportsIothread = ['scsi', 'virtio'].includes(newBus);
                const busSupportsSsd = ['scsi', 'virtio', 'sata'].includes(newBus);
                setDiskConfig({
                    ...diskConfig, 
                    disk_id: newId,
                    iothread: busSupportsIothread ? diskConfig.iothread : false,
                    ssd: busSupportsSsd ? diskConfig.ssd : false
                });
            };
            
            // NS: Filter out unsupported options before sending to API
            const handleAdd = () => {
                const configToSend = { 
                    disk_id: diskConfig.disk_id,
                    storage: diskConfig.storage,
                    size: diskConfig.size,
                    discard: diskConfig.discard
                };
                // Only add cache if set
                if (diskConfig.cache) {
                    configToSend.cache = diskConfig.cache;
                }
                // Only add iothread for scsi/virtio
                if (supportsIothread && diskConfig.iothread) {
                    configToSend.iothread = true;
                }
                // Only add ssd for scsi/virtio/sata
                if (supportsSsd && diskConfig.ssd) {
                    configToSend.ssd = true;
                }
                onAdd(configToSend);
            };

            return(
                <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/60">
                    <div className="w-full max-w-md bg-proxmox-card border border-proxmox-border rounded-xl p-6 animate-scale-in">
                        <h3 className="text-lg font-semibold text-white mb-4">{t('addDisk')}</h3>
                        <div className="space-y-4">
                            {isQemu && hardwareOptions && (
                                <div className="grid grid-cols-2 gap-4">
                                    <div>
                                        <label className="block text-xs text-gray-400 mb-1">Bus/Device</label>
                                        <select
                                            value={currentBus}
                                            onChange={(e) => handleBusChange(e.target.value)}
                                            className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white text-sm"
                                        >
                                            {(hardwareOptions?.disk_bus_types || [{value: 'scsi', label: 'SCSI'}]).map(bus => (
                                                <option key={bus.value} value={bus.value}>{bus.label}</option>
                                            ))}
                                        </select>
                                    </div>
                                    <div>
                                        <label className="block text-xs text-gray-400 mb-1">ID</label>
                                        <input
                                            type="text"
                                            value={diskConfig.disk_id}
                                            onChange={(e) => setDiskConfig({...diskConfig, disk_id: e.target.value})}
                                            className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white text-sm"
                                        />
                                    </div>
                                </div>
                            )}
                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-xs text-gray-400 mb-1">Storage</label>
                                    <select
                                        value={diskConfig.storage}
                                        onChange={(e) => setDiskConfig({...diskConfig, storage: e.target.value})}
                                        className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white text-sm"
                                    >
                                        {storageList.map(s => {
                                            const freeBytes = s.avail || s.free || 0;
                                            const totalBytes = s.total || 0;
                                            const usedPercent = totalBytes > 0 ? Math.round((1 - freeBytes / totalBytes) * 100) : 0;
                                            const freeGB = (freeBytes / (1024 * 1024 * 1024)).toFixed(1);
                                            const totalGB = (totalBytes / (1024 * 1024 * 1024)).toFixed(1);
                                            return(
                                                <option key={s.storage} value={s.storage}>
                                                    {s.storage} ({freeGB} GB {t('free')} / {totalGB} GB - {usedPercent}% {t('used')})
                                                </option>
                                            );
                                        })}
                                    </select>
                                    {/* Show selected storage details */}
                                    {diskConfig.storage && storageList.length > 0 && (() => {
                                        const selected = storageList.find(s => s.storage === diskConfig.storage);
                                        if (!selected) return null;
                                        const freeBytes = selected.avail || selected.free || 0;
                                        const totalBytes = selected.total || 0;
                                        const usedPercent = totalBytes > 0 ? Math.round((1 - freeBytes / totalBytes) * 100) : 0;
                                        const freeGB = (freeBytes / (1024 * 1024 * 1024)).toFixed(1);
                                        return(
                                            <div className="mt-2 p-2 bg-proxmox-darker rounded-lg">
                                                <div className="flex justify-between text-xs mb-1">
                                                    <span className="text-gray-400">{t('freeSpace') || 'Free'}:</span>
                                                    <span className={`font-medium ${freeBytes < diskConfig.size * 1024 * 1024 * 1024 ? 'text-red-400' : 'text-green-400'}`}>
                                                        {freeGB} GB
                                                    </span>
                                                </div>
                                                <div className="h-1.5 bg-proxmox-dark rounded-full overflow-hidden">
                                                    <div 
                                                        className={`h-full rounded-full transition-all ${usedPercent > 90 ? 'bg-red-500' : usedPercent > 70 ? 'bg-yellow-500' : 'bg-green-500'}`}
                                                        style={{ width: `${usedPercent}%` }}
                                                    />
                                                </div>
                                                {freeBytes < diskConfig.size * 1024 * 1024 * 1024 && diskConfig.size > 0 && (
                                                    <p className="text-xs text-red-400 mt-1">‚ö†Ô∏è {t('notEnoughSpace') || 'Not enough space!'}</p>
                                                )}
                                            </div>
                                        );
                                    })()}
                                </div>
                                <div>
                                    <label className="block text-xs text-gray-400 mb-1">{t('size')} (GB)</label>
                                    <input
                                        type="number"
                                        value={diskConfig.size}
                                        onChange={(e) => setDiskConfig({...diskConfig, size: parseInt(e.target.value) || 0})}
                                        min="1"
                                        placeholder="32"
                                        className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white text-sm"
                                    />
                                </div>
                            </div>
                            {isQemu && hardwareOptions && (
                                <React.Fragment>
                                    <div>
                                        <label className="block text-xs text-gray-400 mb-1">Cache</label>
                                        <select
                                            value={diskConfig.cache}
                                            onChange={(e) => setDiskConfig({...diskConfig, cache: e.target.value})}
                                            className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white text-sm"
                                        >
                                            {(hardwareOptions?.cache_modes || [{value: '', label: 'Default'}]).map(c => (
                                                <option key={c.value} value={c.value}>{c.label}</option>
                                            ))}
                                        </select>
                                    </div>
                                    <div className="flex flex-wrap gap-4">
                                        {/* MK: IO Thread only for SCSI and VirtIO */}
                                        {supportsIothread && (
                                            <label className="flex items-center gap-2 text-sm text-gray-300">
                                                <input type="checkbox" checked={diskConfig.iothread} onChange={(e) => setDiskConfig({...diskConfig, iothread: e.target.checked})} className="rounded" />
                                                IO Thread
                                            </label>
                                        )}
                                        {/* MK: SSD Emulation for SCSI, VirtIO, SATA (not IDE) */}
                                        {supportsSsd && (
                                            <label className="flex items-center gap-2 text-sm text-gray-300">
                                                <input type="checkbox" checked={diskConfig.ssd} onChange={(e) => setDiskConfig({...diskConfig, ssd: e.target.checked})} className="rounded" />
                                                SSD Emulation
                                            </label>
                                        )}
                                        <label className="flex items-center gap-2 text-sm text-gray-300">
                                            <input type="checkbox" checked={diskConfig.discard} onChange={(e) => setDiskConfig({...diskConfig, discard: e.target.checked})} className="rounded" />
                                            Discard
                                        </label>
                                    </div>
                                </React.Fragment>
                            )}
                        </div>
                        <div className="flex justify-end gap-3 mt-6">
                            <button onClick={onClose} className="px-4 py-2 text-gray-300 hover:text-white">{t('cancel')}</button>
                            <button onClick={handleAdd} className="px-4 py-2 bg-proxmox-orange rounded-lg text-white hover:bg-orange-600">{t('add')}</button>
                        </div>
                    </div>
                </div>
            );
        }

        function ResizeDiskModal({ disk, onResize, onClose }) {
            const { t } = useTranslation();
            const [size, setSize] = useState('+10G');
            return(
                <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/60">
                    <div className="w-full max-w-sm bg-proxmox-card border border-proxmox-border rounded-xl p-6 animate-scale-in">
                        <h3 className="text-lg font-semibold text-white mb-4">Festplatte vergroessern</h3>
                        <p className="text-sm text-gray-400 mb-4">Aktuelle Groesse: {disk.size}</p>
                        <div>
                            <label className="block text-xs text-gray-400 mb-1">{t('resizeDiskHint') || 'Increase by (e.g. +10G) or new size'}</label>
                            <input
                                type="text"
                                value={size}
                                onChange={(e) => setSize(e.target.value)}
                                className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white text-sm"
                            />
                        </div>
                        <div className="flex justify-end gap-3 mt-6">
                            <button onClick={onClose} className="px-4 py-2 text-gray-300 hover:text-white">{t('cancel')}</button>
                            <button onClick={() => onResize(size)} className="px-4 py-2 bg-green-600 rounded-lg text-white hover:bg-green-700">Vergroessern</button>
                        </div>
                    </div>
                </div>
            );
        }

        // MK: Modal for reattaching unused disks with bus type selection
        // LW: Jan 2026 - Makes it easier to reattach disks with correct settings
        function ReattachDiskModal({ disk, getNextDiskId, onReattach, onClose }) {
            const { t } = useTranslation();
            const [busType, setBusType] = useState('scsi');
            const [diskId, setDiskId] = useState(getNextDiskId('scsi'));
            const [iothread, setIothread] = useState(true);
            const [ssd, setSsd] = useState(false);
            const [discard, setDiscard] = useState(true);
            const [loading, setLoading] = useState(false);
            
            // MK: Update disk ID when bus type changes
            const handleBusChange = (newBus) => {
                setBusType(newBus);
                setDiskId(getNextDiskId(newBus));
                // Reset unsupported options
                if (!['scsi', 'virtio'].includes(newBus)) {
                    setIothread(false);
                }
                if (!['scsi', 'virtio', 'sata'].includes(newBus)) {
                    setSsd(false);
                }
            };
            
            // LW: Check which options are supported
            const supportsIothread = ['scsi', 'virtio'].includes(busType);
            const supportsSsd = ['scsi', 'virtio', 'sata'].includes(busType);
            
            const busTypes = [
                { value: 'scsi', label: 'SCSI', desc: t('scsiDesc') || 'Best performance with VirtIO SCSI controller' },
                { value: 'virtio', label: 'VirtIO Block', desc: t('virtioDesc') || 'Legacy VirtIO, good performance' },
                { value: 'sata', label: 'SATA', desc: t('sataDesc') || 'Good compatibility, moderate performance' },
                { value: 'ide', label: 'IDE', desc: t('ideDesc') || 'Maximum compatibility, lowest performance' },
            ];
            
            const handleReattach = async () => {
                if (loading) return;
                setLoading(true);
                
                // MK: Build disk options string
                let options = [];
                if (supportsIothread && iothread) options.push('iothread=1');
                if (supportsSsd && ssd) options.push('ssd=1');
                if (discard) options.push('discard=on');
                
                const diskValue = options.length > 0 
                    ? `${disk.value},${options.join(',')}` 
                    : disk.value;
                
                try {
                    await onReattach(diskId, diskValue);
                } finally {
                    setLoading(false);
                }
            };
            
            return (
                <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/60">
                    <div className="w-full max-w-md bg-proxmox-card border border-proxmox-border rounded-xl p-6 animate-scale-in">
                        <h3 className="text-lg font-semibold text-white mb-2 flex items-center gap-2">
                            <Icons.HardDrive className="text-green-400" />
                            {t('reattachDisk') || 'Reattach Disk'}
                        </h3>
                        <p className="text-sm text-gray-400 mb-4">
                            {t('volume') || 'Volume'}: <span className="font-mono text-white">{disk.value}</span>
                        </p>
                        
                        {/* Bus Type Selection */}
                        <div className="mb-4">
                            <label className="block text-xs text-gray-400 mb-2">{t('selectBusType') || 'Select Bus Type'}</label>
                            <div className="grid grid-cols-2 gap-2">
                                {busTypes.map(bus => (
                                    <button
                                        key={bus.value}
                                        onClick={() => handleBusChange(bus.value)}
                                        disabled={loading}
                                        className={`p-3 rounded-lg text-left transition-all ${
                                            busType === bus.value
                                                ? 'bg-green-600/20 border border-green-500'
                                                : 'bg-proxmox-dark border border-proxmox-border hover:border-gray-500'
                                        }`}
                                    >
                                        <div className="font-medium text-white text-sm">{bus.label}</div>
                                        <div className="text-xs text-gray-500 mt-0.5">{bus.desc}</div>
                                    </button>
                                ))}
                            </div>
                        </div>
                        
                        {/* Disk ID */}
                        <div className="mb-4">
                            <label className="block text-xs text-gray-400 mb-1">{t('diskId') || 'Disk ID'}</label>
                            <input
                                type="text"
                                value={diskId}
                                onChange={(e) => setDiskId(e.target.value)}
                                disabled={loading}
                                className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white text-sm font-mono"
                            />
                            <p className="text-xs text-gray-500 mt-1">{t('nextAvailableId') || 'Next available ID for selected bus type'}</p>
                        </div>
                        
                        {/* Options */}
                        <div className="mb-4 p-3 bg-proxmox-dark rounded-lg border border-proxmox-border">
                            <label className="block text-xs text-gray-400 mb-2">{t('diskOptions') || 'Disk Options'}</label>
                            <div className="flex flex-wrap gap-4">
                                {supportsIothread && (
                                    <label className="flex items-center gap-2 text-sm text-gray-300 cursor-pointer">
                                        <input 
                                            type="checkbox" 
                                            checked={iothread} 
                                            onChange={(e) => setIothread(e.target.checked)} 
                                            disabled={loading}
                                            className="rounded" 
                                        />
                                        IO Thread
                                    </label>
                                )}
                                {supportsSsd && (
                                    <label className="flex items-center gap-2 text-sm text-gray-300 cursor-pointer">
                                        <input 
                                            type="checkbox" 
                                            checked={ssd} 
                                            onChange={(e) => setSsd(e.target.checked)} 
                                            disabled={loading}
                                            className="rounded" 
                                        />
                                        SSD Emulation
                                    </label>
                                )}
                                <label className="flex items-center gap-2 text-sm text-gray-300 cursor-pointer">
                                    <input 
                                        type="checkbox" 
                                        checked={discard} 
                                        onChange={(e) => setDiscard(e.target.checked)} 
                                        disabled={loading}
                                        className="rounded" 
                                    />
                                    Discard (TRIM)
                                </label>
                            </div>
                            {!supportsIothread && !supportsSsd && (
                                <p className="text-xs text-yellow-500 mt-2">
                                    {t('ideLimitedOptions') || 'IDE has limited options available'}
                                </p>
                            )}
                        </div>
                        
                        {/* Preview */}
                        <div className="mb-4 p-3 bg-proxmox-dark/50 rounded-lg border border-dashed border-proxmox-border">
                            <label className="block text-xs text-gray-400 mb-1">{t('preview') || 'Preview'}</label>
                            <div className="flex items-center gap-2">
                                <span className="text-green-400 font-mono font-medium">{diskId}</span>
                                <Icons.ArrowRight className="w-4 h-4 text-gray-500" />
                                <span className="text-gray-300 font-mono text-sm truncate">{disk.value}</span>
                            </div>
                        </div>
                        
                        <div className="flex justify-end gap-3">
                            <button 
                                onClick={onClose} 
                                disabled={loading}
                                className="px-4 py-2 text-gray-300 hover:text-white disabled:opacity-50"
                            >
                                {t('cancel')}
                            </button>
                            <button 
                                onClick={handleReattach}
                                disabled={loading || !diskId}
                                className="px-4 py-2 bg-green-600 rounded-lg text-white hover:bg-green-700 disabled:opacity-50 flex items-center gap-2"
                            >
                                {loading && <Icons.RotateCw className="w-4 h-4 animate-spin" />}
                                {loading ? (t('attaching') || 'Attaching...') : (t('reattach') || 'Reattach')}
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        // NS: Simple modal for moving disks between storages
        // Works with both local and shared storage
        function MoveDiskModal({ disk, storageList, onMove, onClose }) {
            const { t } = useTranslation();
            const [storage, setStorage] = useState(storageList.filter(s => s.storage !== disk.storage)[0]?.storage || '');
            return(
                <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/60">
                    <div className="w-full max-w-sm bg-proxmox-card border border-proxmox-border rounded-xl p-6 animate-scale-in">
                        <h3 className="text-lg font-semibold text-white mb-4">Festplatte verschieben</h3>
                        <p className="text-sm text-gray-400 mb-4">{disk.id} von {disk.storage}</p>
                        <div>
                            <label className="block text-xs text-gray-400 mb-1">{t('targetStorage')}</label>
                            <select
                                value={storage}
                                onChange={(e) => setStorage(e.target.value)}
                                className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white text-sm"
                            >
                                {storageList.filter(s => s.storage !== disk.storage).map(s => (
                                    <option key={s.storage} value={s.storage}>{s.storage}</option>
                                ))}
                            </select>
                        </div>
                        <div className="flex justify-end gap-3 mt-6">
                            <button onClick={onClose} className="px-4 py-2 text-gray-300 hover:text-white">{t('cancel')}</button>
                            <button onClick={() => onMove(storage)} className="px-4 py-2 bg-blue-600 rounded-lg text-white hover:bg-blue-700">Verschieben</button>
                        </div>
                    </div>
                </div>
            );
        }

        // MK: Edit Disk Bus Type Modal - allows changing disk from SCSI to IDE/SATA/VirtIO etc.
        // LW: Added Jan 2026 - users kept asking for this in Discord
        function EditDiskBusModal({ disk, hardwareOptions, vmStatus, onSave, onClose }) {
            const { t } = useTranslation();
            const currentBus = disk.id.replace(/[0-9]/g, '');
            const [newBus, setNewBus] = useState(currentBus);
            const [loading, setLoading] = useState(false);
            
            // MK: Check if VM is running - bus type change requires VM to be stopped
            const isVmRunning = vmStatus === 'running';
            
            // MK: Check which options will be stripped - use Boolean to avoid JSX rendering 0
            const hasIothread = Boolean(disk.iothread && disk.iothread > 0);
            const hasSsd = Boolean(disk.ssd && disk.ssd > 0);
            const willStripIothread = hasIothread && !['scsi', 'virtio'].includes(newBus);
            const willStripSsd = hasSsd && !['scsi', 'virtio', 'sata'].includes(newBus);
            
            const handleSave = async () => {
                if (loading || isVmRunning) return; // Prevent double-click and running VM
                setLoading(true);
                try {
                    await onSave(newBus);
                } finally {
                    setLoading(false);
                }
            };
            
            const busTypes = [
                { value: 'scsi', label: 'SCSI', desc: t('scsiDesc') || 'Best performance with VirtIO SCSI controller' },
                { value: 'virtio', label: 'VirtIO Block', desc: t('virtioDesc') || 'Legacy VirtIO, good performance' },
                { value: 'sata', label: 'SATA', desc: t('sataDesc') || 'Good compatibility, moderate performance' },
                { value: 'ide', label: 'IDE', desc: t('ideDesc') || 'Maximum compatibility, lowest performance' },
            ];
            
            return (
                <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/60">
                    <div className="w-full max-w-md bg-proxmox-card border border-proxmox-border rounded-xl p-6 animate-scale-in">
                        <h3 className="text-lg font-semibold text-white mb-2 flex items-center gap-2">
                            <Icons.Edit className="text-yellow-400" />
                            {t('changeDiskBusType') || 'Change Disk Bus Type'}
                        </h3>
                        <p className="text-sm text-gray-400 mb-4">
                            {t('currentDisk') || 'Current'}: <span className="font-mono text-white">{disk.id}</span> ({disk.size})
                            {disk.iothread && <span className="ml-2 text-xs bg-green-500/20 text-green-400 px-1.5 py-0.5 rounded">IOthread</span>}
                            {disk.ssd && <span className="ml-1 text-xs bg-blue-500/20 text-blue-400 px-1.5 py-0.5 rounded">SSD</span>}
                        </p>
                        
                        {/* MK: Error if VM is running */}
                        {isVmRunning ? (
                            <div className="p-4 bg-red-500/20 border border-red-500/50 rounded-lg mb-4">
                                <div className="flex items-start gap-3">
                                    <Icons.AlertTriangle className="w-6 h-6 text-red-400 flex-shrink-0" />
                                    <div>
                                        <div className="font-medium text-red-400 mb-1">{t('vmIsRunning') || 'VM is running'}</div>
                                        <p className="text-sm text-red-300">{t('vmMustBeStoppedForBusChange') || 'The VM must be stopped before changing the disk bus type. Please shut down the VM first.'}</p>
                                    </div>
                                </div>
                            </div>
                        ) : (
                            <div className="p-3 bg-yellow-500/10 border border-yellow-500/30 rounded-lg text-sm text-yellow-300 mb-4">
                                <div className="flex items-start gap-2">
                                    <Icons.AlertTriangle className="w-4 h-4 mt-0.5 flex-shrink-0" />
                                    <div>{t('diskBusWarning') || 'Changing the bus type requires the VM to be stopped. The guest OS may need driver updates.'}</div>
                                </div>
                            </div>
                        )}
                        
                        {/* MK: Show warning about stripped options */}
                        {(willStripIothread || willStripSsd) && !isVmRunning && (
                            <div className="p-3 bg-red-500/10 border border-red-500/30 rounded-lg text-sm text-red-300 mb-4">
                                <div className="flex items-start gap-2">
                                    <Icons.Info className="w-4 h-4 mt-0.5 flex-shrink-0" />
                                    <div>
                                        {t('optionsWillBeRemoved') || 'The following options are not supported and will be removed'}:
                                        {willStripIothread && <span className="ml-2 font-mono bg-red-500/20 px-1.5 py-0.5 rounded">IO Thread</span>}
                                        {willStripSsd && <span className="ml-2 font-mono bg-red-500/20 px-1.5 py-0.5 rounded">SSD</span>}
                                    </div>
                                </div>
                            </div>
                        )}
                        
                        <div className="space-y-2">
                            <label className="block text-xs text-gray-400 mb-2">{t('selectNewBusType') || 'Select new bus type'}</label>
                            {busTypes.map(bus => (
                                <label 
                                    key={bus.value}
                                    className={`flex items-center p-3 rounded-lg cursor-pointer transition-all ${
                                        newBus === bus.value 
                                            ? 'bg-proxmox-orange/20 border border-proxmox-orange' 
                                            : 'bg-proxmox-dark border border-proxmox-border hover:border-gray-500'
                                    } ${loading || isVmRunning ? 'opacity-50 pointer-events-none' : ''}`}
                                >
                                    <input
                                        type="radio"
                                        name="busType"
                                        value={bus.value}
                                        checked={newBus === bus.value}
                                        onChange={(e) => setNewBus(e.target.value)}
                                        disabled={loading || isVmRunning}
                                        className="mr-3"
                                    />
                                    <div className="flex-1">
                                        <div className="flex items-center gap-2">
                                            <span className="font-medium text-white">{bus.label}</span>
                                            {currentBus === bus.value && (
                                                <span className="text-xs bg-gray-600 px-2 py-0.5 rounded">{t('current') || 'Current'}</span>
                                            )}
                                        </div>
                                        <p className="text-xs text-gray-500 mt-0.5">{bus.desc}</p>
                                    </div>
                                </label>
                            ))}
                        </div>
                        
                        <div className="flex justify-end gap-3 mt-6">
                            <button onClick={onClose} disabled={loading} className="px-4 py-2 text-gray-300 hover:text-white disabled:opacity-50">{t('cancel')}</button>
                            <button 
                                onClick={handleSave} 
                                disabled={newBus === currentBus || loading || isVmRunning}
                                className="px-4 py-2 bg-yellow-600 rounded-lg text-white hover:bg-yellow-700 disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2"
                            >
                                {loading && <Icons.RotateCw className="w-4 h-4 animate-spin" />}
                                {isVmRunning ? (t('vmMustBeStopped') || 'VM must be stopped') : loading ? (t('saving') || 'Saving...') : (t('changeBusType') || 'Change Bus Type')}
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        function MountISOModal({ isoList, existingDrives, onMount, onClose }) {
            const { t } = useTranslation();
            const [iso, setIso] = useState('');
            const [driveType, setDriveType] = useState('ide');
            const [driveNum, setDriveNum] = useState('2');
            
            // calc which drives are already in use
            const usedDrives = existingDrives || [];
            
            // Available drive options
            const driveOptions = [
                { type: 'ide', nums: ['0', '1', '2', '3'], label: 'IDE' },
                { type: 'scsi', nums: ['0', '1', '2', '3', '4', '5'], label: 'SCSI' },
                { type: 'sata', nums: ['0', '1', '2', '3', '4', '5'], label: 'SATA' },
            ];
            
            const currentDrive = `${driveType}${driveNum}`;
            const currentDriveInfo = usedDrives.find(d => d.key === currentDrive);
            const isDriveUsedByDisk = currentDriveInfo && !currentDriveInfo.isCdrom;
            const isDriveCdrom = currentDriveInfo?.isCdrom;
            
            // Find first free or cdrom slot when changing drive type
            const findBestSlot = (type) => {
                const nums = driveOptions.find(o => o.type === type)?.nums || [];
                // First try to find existing CD-ROM
                for (const num of nums) {
                    const drive = `${type}${num}`;
                    const info = usedDrives.find(d => d.key === drive);
                    if (info?.isCdrom) return num;
                }
                // Then find free slot
                for (const num of nums) {
                    const drive = `${type}${num}`;
                    const info = usedDrives.find(d => d.key === drive);
                    if (!info) return num;
                }
                // Default to first
                return nums[0];
            };
            
            return(
                <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/60">
                    <div className="w-full max-w-md bg-proxmox-card border border-proxmox-border rounded-xl p-6 animate-scale-in">
                        <h3 className="text-lg font-semibold text-white mb-4">{t('mountIso')}</h3>
                        
                        <div className="space-y-4">
                            {/* ISO Selection */}
                            <div>
                                <label className="block text-xs text-gray-400 mb-1">{t('isoImage')}</label>
                                <select
                                    value={iso}
                                    onChange={(e) => setIso(e.target.value)}
                                    className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white text-sm"
                                >
                                    <option value="">-- {t('noIsoEject')} --</option>
                                    {isoList.map(i => (
                                        <option key={i.volid} value={i.volid}>{i.volid.split('/').pop()}</option>
                                    ))}
                                </select>
                            </div>
                            
                            {/* Drive Type Selection */}
                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-xs text-gray-400 mb-1">{t('busType')}</label>
                                    <select
                                        value={driveType}
                                        onChange={(e) => {
                                            const newType = e.target.value;
                                            setDriveType(newType);
                                            setDriveNum(findBestSlot(newType));
                                        }}
                                        className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white text-sm"
                                    >
                                        {driveOptions.map(opt => (
                                            <option key={opt.type} value={opt.type}>{opt.label}</option>
                                        ))}
                                    </select>
                                </div>
                                <div>
                                    <label className="block text-xs text-gray-400 mb-1">{t('device')}</label>
                                    <select
                                        value={driveNum}
                                        onChange={(e) => setDriveNum(e.target.value)}
                                        className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white text-sm"
                                    >
                                        {driveOptions.find(o => o.type === driveType)?.nums.map(num => {
                                            const drive = `${driveType}${num}`;
                                            const info = usedDrives.find(d => d.key === drive);
                                            const isUsedByDisk = info && !info.isCdrom;
                                            const isCdrom = info?.isCdrom;
                                            
                                            let label = drive;
                                            if (isCdrom) label += ` (${t('cdrom')})`;
                                            else if (isUsedByDisk) label += ` (${t('hardDisk')})`;
                                            
                                            return(
                                                <option 
                                                    key={num} 
                                                    value={num}
                                                    disabled={isUsedByDisk}
                                                    style={isUsedByDisk ? {color: '#666'} : {}}
                                                >
                                                    {label}
                                                </option>
                                            );
                                        })}
                                    </select>
                                </div>
                            </div>
                            
                            {/* Drive info */}
                            <div className="text-xs">
                                <span className="text-gray-500">{t('target')}: </span>
                                <span className="text-proxmox-orange font-mono">{currentDrive}</span>
                                {isDriveCdrom && (
                                    <span className="text-green-500 ml-2">‚úì {t('existingCdrom')}</span>
                                )}
                                {isDriveUsedByDisk && (
                                    <span className="text-red-500 ml-2">‚úó {t('hardDiskNotAvailable')}</span>
                                )}
                                {!currentDriveInfo && (
                                    <span className="text-blue-400 ml-2">‚óã {t('freeSlot')}</span>
                                )}
                            </div>
                        </div>
                        
                        <div className="flex justify-end gap-3 mt-6">
                            <button onClick={onClose} className="px-4 py-2 text-gray-300 hover:text-white">{t('cancel')}</button>
                            <button 
                                onClick={() => onMount(iso || null, currentDrive)} 
                                disabled={isDriveUsedByDisk}
                                className={`px-4 py-2 rounded-lg text-white ${
                                    isDriveUsedByDisk 
                                        ? 'bg-gray-600 cursor-not-allowed' 
                                        : 'bg-proxmox-orange hover:bg-orange-600'
                                }`}
                            >
                                {iso ? t('mount') : t('eject')}
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        function AddNetworkModal({ isQemu, bridgeList, hardwareOptions, getNextNetId, generateMAC, onAdd, onClose }) {
            const { t } = useTranslation();
            const [netConfig, setNetConfig] = useState({
                net_id: 'net1',
                bridge: bridgeList[0]?.iface || 'vmbr0',
                model: 'virtio',
                macaddr: '',
                firewall: true,
                tag: '',
                rate: '',
                mtu: '',
                queues: '',
                name: 'eth0',
                ip: 'dhcp',
                gw: '',
                ip6: '',
                gw6: '',
                hwaddr: '',
            });

            useEffect(() => {
                if (getNextNetId) {
                    setNetConfig(prev => ({...prev, net_id: getNextNetId()}));
                }
            }, []);

            return(
                <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/60">
                    <div className="w-full max-w-lg bg-proxmox-card border border-proxmox-border rounded-xl p-6 animate-scale-in max-h-[80vh] overflow-y-auto">
                        <h3 className="text-lg font-semibold text-white mb-4">{t('addNetwork')}</h3>
                        <div className="space-y-4">
                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-xs text-gray-400 mb-1">Interface ID</label>
                                    <input type="text" value={netConfig.net_id} onChange={(e) => setNetConfig({...netConfig, net_id: e.target.value})}
                                        className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white text-sm" />
                                </div>
                                <div>
                                    <label className="block text-xs text-gray-400 mb-1">Bridge</label>
                                    <select value={netConfig.bridge} onChange={(e) => setNetConfig({...netConfig, bridge: e.target.value})}
                                        className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white text-sm">
                                        {bridgeList.map(b => (<option key={b.iface} value={b.iface}>{b.iface}{b.comments ? ` - ${b.comments}` : ''}</option>))}
                                    </select>
                                </div>
                            </div>
                            {isQemu && hardwareOptions && (
                                <div className="grid grid-cols-2 gap-4">
                                    <div>
                                        <label className="block text-xs text-gray-400 mb-1">Model</label>
                                        <select value={netConfig.model} onChange={(e) => setNetConfig({...netConfig, model: e.target.value})}
                                            className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white text-sm">
                                            {(hardwareOptions?.network_models || [{value: 'virtio', label: 'VirtIO'}]).map(m => (<option key={m.value} value={m.value}>{m.label}</option>))}
                                        </select>
                                    </div>
                                    <div>
                                        <label className="block text-xs text-gray-400 mb-1">MAC Adresse</label>
                                        <div className="flex gap-2">
                                            <input type="text" value={netConfig.macaddr} onChange={(e) => setNetConfig({...netConfig, macaddr: e.target.value})}
                                                placeholder="auto" className="flex-1 px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white text-sm font-mono" />
                                            <button onClick={() => setNetConfig({...netConfig, macaddr: generateMAC()})}
                                                className="px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-gray-400 hover:text-white text-sm">
                                                <Icons.RefreshCw />
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            )}
                            {!isQemu && (
                                <>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="block text-xs text-gray-400 mb-1">Interface Name</label>
                                            <input type="text" value={netConfig.name} onChange={(e) => setNetConfig({...netConfig, name: e.target.value})}
                                                className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white text-sm" />
                                        </div>
                                        <div>
                                            <label className="block text-xs text-gray-400 mb-1">MAC Adresse</label>
                                            <div className="flex gap-2">
                                                <input type="text" value={netConfig.hwaddr} onChange={(e) => setNetConfig({...netConfig, hwaddr: e.target.value})}
                                                    placeholder="auto" className="flex-1 px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white text-sm font-mono" />
                                                <button onClick={() => setNetConfig({...netConfig, hwaddr: generateMAC()})}
                                                    className="px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-gray-400 hover:text-white">
                                                    <Icons.RefreshCw />
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="block text-xs text-gray-400 mb-1">IPv4</label>
                                            <input type="text" value={netConfig.ip} onChange={(e) => setNetConfig({...netConfig, ip: e.target.value})}
                                                placeholder="dhcp oder 10.0.0.10/24" className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white text-sm" />
                                        </div>
                                        <div>
                                            <label className="block text-xs text-gray-400 mb-1">Gateway</label>
                                            <input type="text" value={netConfig.gw} onChange={(e) => setNetConfig({...netConfig, gw: e.target.value})}
                                                className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white text-sm" />
                                        </div>
                                    </div>
                                </>
                            )}
                            <div className="grid grid-cols-3 gap-4">
                                <div>
                                    <label className="block text-xs text-gray-400 mb-1">VLAN Tag</label>
                                    <input type="text" value={netConfig.tag} onChange={(e) => setNetConfig({...netConfig, tag: e.target.value})}
                                        className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white text-sm" />
                                </div>
                                <div>
                                    <label className="block text-xs text-gray-400 mb-1">Rate (MB/s)</label>
                                    <input type="text" value={netConfig.rate} onChange={(e) => setNetConfig({...netConfig, rate: e.target.value})}
                                        className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white text-sm" />
                                </div>
                                <div>
                                    <label className="block text-xs text-gray-400 mb-1">MTU</label>
                                    <input type="text" value={netConfig.mtu} onChange={(e) => setNetConfig({...netConfig, mtu: e.target.value})}
                                        className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white text-sm" />
                                </div>
                            </div>
                            <label className="flex items-center gap-2 text-sm text-gray-300">
                                <input type="checkbox" checked={netConfig.firewall} onChange={(e) => setNetConfig({...netConfig, firewall: e.target.checked})} className="rounded" />
                                {t('enableFirewall')}
                            </label>
                        </div>
                        <div className="flex justify-end gap-3 mt-6">
                            <button onClick={onClose} className="px-4 py-2 text-gray-300 hover:text-white">{t('cancel')}</button>
                            <button onClick={() => onAdd(netConfig)} className="px-4 py-2 bg-proxmox-orange rounded-lg text-white hover:bg-orange-600">{t('add')}</button>
                        </div>
                    </div>
                </div>
            );
        }

        function EditNetworkModal({ isQemu, network, bridgeList, hardwareOptions, generateMAC, onUpdate, onClose }) {
            const { t } = useTranslation();
            const [editConfig, setEditConfig] = useState({
                bridge: network.bridge || 'vmbr0',
                model: network.model || 'virtio',
                macaddr: network.macaddr || '',
                firewall: network.firewall || false,
                tag: network.tag || '',
                rate: network.rate || '',
                mtu: network.mtu || '',
                queues: network.queues || '',  // LW: Multiqueue support
                link_down: network.link_down || false,  // NS: Disconnect checkbox
                name: network.name || 'eth0',
                ip: network.ip || 'dhcp',
                gw: network.gw || '',
                hwaddr: network.hwaddr || '',
            });

            return(
                <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/60">
                    <div className="w-full max-w-lg bg-proxmox-card border border-proxmox-border rounded-xl p-6 animate-scale-in max-h-[80vh] overflow-y-auto">
                        <h3 className="text-lg font-semibold text-white mb-4">{t('editNetwork')}: {network.id}</h3>
                        <div className="space-y-4">
                            {/* Disconnect Checkbox - prominent at top for QEMU */}
                            {isQemu && (
                                <div className={`p-3 rounded-lg border ${editConfig.link_down ? 'bg-red-500/10 border-red-500/30' : 'bg-proxmox-dark border-proxmox-border'}`}>
                                    <label className="flex items-center gap-3 cursor-pointer">
                                        <input 
                                            type="checkbox" 
                                            checked={editConfig.link_down} 
                                            onChange={(e) => setEditConfig({...editConfig, link_down: e.target.checked})} 
                                            className="w-4 h-4 rounded" 
                                        />
                                        <div>
                                            <span className={`text-sm font-medium ${editConfig.link_down ? 'text-red-400' : 'text-gray-300'}`}>
                                                {t('disconnectNetwork')}
                                            </span>
                                            <p className="text-xs text-gray-500">{t('disconnectNetworkHint')}</p>
                                        </div>
                                    </label>
                                </div>
                            )}
                            
                            <div>
                                <label className="block text-xs text-gray-400 mb-1">Bridge</label>
                                <select value={editConfig.bridge} onChange={(e) => setEditConfig({...editConfig, bridge: e.target.value})}
                                    className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white text-sm">
                                    {bridgeList.map(b => (<option key={b.iface} value={b.iface}>{b.iface}{b.comments ? ` - ${b.comments}` : ''}</option>))}
                                </select>
                            </div>
                            {isQemu && hardwareOptions && (
                                <div className="grid grid-cols-2 gap-4">
                                    <div>
                                        <label className="block text-xs text-gray-400 mb-1">Model</label>
                                        <select value={editConfig.model} onChange={(e) => setEditConfig({...editConfig, model: e.target.value})}
                                            className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white text-sm">
                                            {(hardwareOptions?.network_models || [{value: 'virtio', label: 'VirtIO'}]).map(m => (<option key={m.value} value={m.value}>{m.label}</option>))}
                                        </select>
                                    </div>
                                    <div>
                                        <label className="block text-xs text-gray-400 mb-1">MAC Adresse</label>
                                        <div className="flex gap-2">
                                            <input type="text" value={editConfig.macaddr} onChange={(e) => setEditConfig({...editConfig, macaddr: e.target.value})}
                                                className="flex-1 px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white text-sm font-mono" />
                                            <button onClick={() => setEditConfig({...editConfig, macaddr: generateMAC()})}
                                                className="px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-gray-400 hover:text-white">
                                                <Icons.RefreshCw />
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            )}
                            {!isQemu && (
                                <React.Fragment>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="block text-xs text-gray-400 mb-1">Interface Name</label>
                                            <input type="text" value={editConfig.name} onChange={(e) => setEditConfig({...editConfig, name: e.target.value})}
                                                className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white text-sm" />
                                        </div>
                                        <div>
                                            <label className="block text-xs text-gray-400 mb-1">MAC</label>
                                            <div className="flex gap-2">
                                                <input type="text" value={editConfig.hwaddr} onChange={(e) => setEditConfig({...editConfig, hwaddr: e.target.value})}
                                                    className="flex-1 px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white text-sm font-mono" />
                                                <button onClick={() => setEditConfig({...editConfig, hwaddr: generateMAC()})}
                                                    className="px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-gray-400 hover:text-white">
                                                    <Icons.RefreshCw />
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="block text-xs text-gray-400 mb-1">IPv4</label>
                                            <input type="text" value={editConfig.ip} onChange={(e) => setEditConfig({...editConfig, ip: e.target.value})}
                                                className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white text-sm" />
                                        </div>
                                        <div>
                                            <label className="block text-xs text-gray-400 mb-1">Gateway</label>
                                            <input type="text" value={editConfig.gw} onChange={(e) => setEditConfig({...editConfig, gw: e.target.value})}
                                                className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white text-sm" />
                                        </div>
                                    </div>
                                </React.Fragment>
                            )}
                            
                            {/* Network Settings Grid */}
                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-xs text-gray-400 mb-1">VLAN Tag</label>
                                    <input type="text" value={editConfig.tag} onChange={(e) => setEditConfig({...editConfig, tag: e.target.value})}
                                        placeholder="z.B. 100"
                                        className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white text-sm" />
                                </div>
                                <div>
                                    <label className="block text-xs text-gray-400 mb-1">MTU</label>
                                    <input type="number" value={editConfig.mtu} onChange={(e) => setEditConfig({...editConfig, mtu: e.target.value})}
                                        placeholder="1500"
                                        className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white text-sm" />
                                </div>
                            </div>
                            
                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-xs text-gray-400 mb-1">Rate Limit (MB/s)</label>
                                    <input type="number" value={editConfig.rate} onChange={(e) => setEditConfig({...editConfig, rate: e.target.value})}
                                        placeholder={t('unlimited')}
                                        className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white text-sm" />
                                </div>
                                {/* Multiqueue - only for QEMU with virtio */}
                                {isQemu && (
                                    <div>
                                        <label className="block text-xs text-gray-400 mb-1">Multiqueue</label>
                                        <input type="number" value={editConfig.queues} onChange={(e) => setEditConfig({...editConfig, queues: e.target.value})}
                                            placeholder="1"
                                            min="1" max="64"
                                            className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white text-sm" />
                                        <p className="text-xs text-gray-500 mt-1">1-64 Queues (nur VirtIO)</p>
                                    </div>
                                )}
                            </div>
                            
                            <label className="flex items-center gap-2 text-sm text-gray-300">
                                <input type="checkbox" checked={editConfig.firewall} onChange={(e) => setEditConfig({...editConfig, firewall: e.target.checked})} className="rounded" />
                                {t('enableFirewall')}
                            </label>
                        </div>
                        <div className="flex justify-end gap-3 mt-6">
                            <button onClick={onClose} className="px-4 py-2 text-gray-300 hover:text-white">{t('cancel')}</button>
                            <button onClick={() => onUpdate(editConfig)} className="px-4 py-2 bg-proxmox-orange rounded-lg text-white hover:bg-orange-600">{t('save')}</button>
                        </div>
                    </div>
                </div>
            );
        }

        // Node Shell Terminal Component using xterm.js with SSH
        function NodeShellTerminal({ node, clusterId, addToast }) {
            const { t } = useTranslation();
            const terminalRef = useRef(null);
            const initRef = useRef(false);
            const [status, setStatus] = useState('loading');
            const [showLogin, setShowLogin] = useState(false);
            const [nodeInfo, setNodeInfo] = useState({});
            const [sshPort, setSshPort] = useState(null);
            const [credentials, setCredentials] = useState({ 
                username: 'root', 
                password: '',
                privateKey: '',
                authMethod: 'password',  // 'password' or 'key'
                host: ''  // SSH host/IP (can be edited by user)
            });
            const wsRef = useRef(null);
            const termRef = useRef(null);
            const statusRef = useRef('loading');
            const { sessionId } = useAuth();  // NS: Get session for WebSocket auth

            // Keep statusRef in sync
            useEffect(() => {
                statusRef.current = status;
            }, [status]);

            const sendCredentials = () => {
                if (wsRef.current && wsRef.current.readyState === WebSocket.OPEN) {
                    const authData = {
                        username: credentials.username,
                        password: credentials.authMethod === 'password' ? credentials.password : '',
                        privateKey: credentials.authMethod === 'key' ? credentials.privateKey : '',
                        host: credentials.host || nodeInfo.ip  // Send host/IP
                    };
                    wsRef.current.send(JSON.stringify(authData));
                    setShowLogin(false);
                    setStatus('connecting');
                    if (termRef.current) {
                        const targetHost = credentials.host || nodeInfo.ip;
                        const method = credentials.authMethod === 'key' ? '(SSH Key)' : '';
                        termRef.current.write(`\r\nVerbinde als ${credentials.username}@${targetHost} ${method}...\r\n`);
                    }
                }
            };

            useEffect(() => {
                if (initRef.current) return;
                initRef.current = true;
                
                if (!terminalRef.current) return;

                let term = null;
                let ws = null;
                let fitAddon = null;
                let cleanup = false;

                const loadTerminal = async () => {
                    try {
                        // Load xterm CSS - try local first
                        if (!document.getElementById('xterm-css')) {
                            const link = document.createElement('link');
                            link.id = 'xterm-css';
                            link.rel = 'stylesheet';
                            link.href = '/static/css/xterm.min.css';
                            link.onerror = () => { link.href = 'https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.min.css'; };
                            document.head.appendChild(link);
                        }

                        // Load xterm.js - try local first, with SRI for CDN
                        if (!window.Terminal) {
                            await new Promise((resolve, reject) => {
                                const script = document.createElement('script');
                                script.src = '/static/js/xterm.min.js';
                                script.onload = resolve;
                                script.onerror = () => {
                                    script.src = 'https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.min.js';
                                    if (SRI_HASHES['xterm@5.3.0']) {
                                        script.integrity = SRI_HASHES['xterm@5.3.0'];
                                        script.crossOrigin = 'anonymous';
                                    }
                                    script.onload = resolve;
                                    script.onerror = reject;
                                };
                                document.head.appendChild(script);
                            });
                        }

                        // Load fit addon - try local first
                        if (!window.FitAddon) {
                            await new Promise((resolve, reject) => {
                                const script = document.createElement('script');
                                script.src = '/static/js/xterm-addon-fit.min.js';
                                script.onload = resolve;
                                script.onerror = () => {
                                    script.src = 'https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.min.js';
                                    if (SRI_HASHES['xterm-addon-fit@0.8.0']) {
                                        script.integrity = SRI_HASHES['xterm-addon-fit@0.8.0'];
                                        script.crossOrigin = 'anonymous';
                                    }
                                    script.onload = resolve;
                                    script.onerror = reject;
                                };
                                document.head.appendChild(script);
                            });
                        }

                        if (cleanup) return;

                        // Create terminal
                        term = new window.Terminal({
                            cursorBlink: true,
                            fontSize: 14,
                            fontFamily: 'Menlo, Monaco, "Courier New", monospace',
                            theme: {
                                background: '#1a1a2e',
                                foreground: '#e4e4e7',
                                cursor: '#e4e4e7',
                            }
                        });
                        termRef.current = term;

                        fitAddon = new window.FitAddon.FitAddon();
                        term.loadAddon(fitAddon);
                        term.open(terminalRef.current);
                        setTimeout(() => fitAddon && fitAddon.fit(), 50);  // idk why 50ms but it works

                        setStatus('connecting');
                        term.write('Verbinde zum Server...\r\n');
                        
                        // First, try to get the node IP via API
                        let nodeIp = '';
                        try {
                            term.write('Ermittle Node-IP...\r\n');
                            const ipResponse = await fetch(`${API_URL}/clusters/${clusterId}/nodes/${node}/ip`, {
                                headers: { 'X-Session-ID': sessionId },
                                credentials: 'include'
                            });
                            if (ipResponse.ok) {
                                const ipData = await ipResponse.json();
                                nodeIp = ipData.ip || '';
                                if (nodeIp) {
                                    term.write(`Node-IP: ${nodeIp} (${ipData.source})\r\n`);
                                }
                            }
                        } catch (e) {
                            console.log('Could not fetch node IP:', e);
                            term.write(`\x1b[33m${t('ipFetchFailed')}: ${e.message}\x1b[0m\r\n`);
                        }

                        // Connect WebSocket - Shell runs on main port + 2
                        const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                        const mainPort = parseInt(window.location.port) || (window.location.protocol === 'https:' ? 443 : 80);
                        const sshPortNum = mainPort + 2;
                        setSshPort(sshPortNum);
                        const wsUrl = `${wsProtocol}//${window.location.hostname}:${sshPortNum}/api/clusters/${clusterId}/nodes/${node}/shellws?session=${sessionId || ''}&ip=${encodeURIComponent(nodeIp)}`;
                        
                        term.write(`${t('connectingWs')} (Port ${sshPortNum})...\r\n`);
                        console.log('SSH WebSocket connecting to:', wsUrl);
                        
                        ws = new WebSocket(wsUrl);
                        wsRef.current = ws;
                        
                        ws.onopen = () => {
                            console.log('SSH WebSocket connected');
                            term.write(`${t('wsConnected')}\r\n`);
                        };

                        ws.onmessage = (event) => {
                            const data = event.data;
                            
                            // Check for JSON status messages
                            if (typeof data === 'string') {
                                // Try to parse as JSON
                                if (data.startsWith('{')) {
                                    try {
                                        const msg = JSON.parse(data);
                                        // console.log('ws msg:', msg);  // very spammy
                                        
                                        if (msg.status === 'need_credentials') {
                                            setNodeInfo({ 
                                                node: msg.node, 
                                                ip: msg.ip || '',
                                                allowManualIp: msg.allowManualIp || !msg.ip
                                            });
                                            // Pre-fill host if we have an IP
                                            if (msg.ip) {
                                                setCredentials(prev => ({...prev, host: msg.ip}));
                                            }
                                            setShowLogin(true);
                                            setStatus('login');
                                            return;
                                        } else if (msg.status === 'connecting') {
                                            term.write('SSH Verbindung wird aufgebaut...\r\n');
                                            return;
                                        } else if (msg.status === 'connected') {
                                            setStatus('connected');
                                            statusRef.current = 'connected';
                                            term.clear();
                                            return;
                                        } else if (msg.status === 'error') {
                                            term.write(`\r\n\x1b[31m${msg.message}\x1b[0m\r\n`);
                                            setStatus('error');
                                            // Show login again on auth failure
                                            if (msg.message.includes('Login') || msg.message.includes('auth') || msg.message.includes('Host')) {
                                                setTimeout(() => {
                                                    setShowLogin(true);
                                                    setStatus('login');
                                                }, 1500);
                                            }
                                            return;
                                        }
                                    } catch (e) {
                                        // Not valid JSON, write to terminal
                                        term.write(data);
                                    }
                                } else {
                                    // Regular string data
                                    term.write(data);
                                }
                            } else if (data instanceof ArrayBuffer) {
                                term.write(new TextDecoder().decode(data));
                            } else if (data instanceof Blob) {
                                data.arrayBuffer().then(buf => {
                                    term.write(new TextDecoder().decode(buf));
                                });
                            }
                        };

                        ws.onerror = (err) => {
                            console.error('WebSocket error:', err);
                            if (!cleanup) {
                                const isHttps = window.location.protocol === 'https:';
                                const displayPort = sshPort || sshPortNum;
                                
                                // Get translated messages
                                const errorTitle = t('wsConnectionFailed');
                                const certTitle = t('certInstructions');
                                const step1 = t('certStep1');
                                const step2 = t('certStep2');
                                const step3 = t('certStep3');
                                const checkLogs = t('checkServerLogs');
                                
                                term.write('\r\n\x1b[31m‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\x1b[0m\r\n');
                                term.write(`\x1b[31m  ${errorTitle}\x1b[0m\r\n`);
                                term.write('\x1b[31m‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\x1b[0m\r\n\r\n');
                                
                                if (isHttps) {
                                    term.write(`\x1b[33m‚ö†Ô∏è  ${certTitle}\x1b[0m\r\n\r\n`);
                                    term.write(`\x1b[36m${step1}\x1b[0m\r\n`);
                                    term.write(`   \x1b[4mhttps://${window.location.hostname}:${displayPort}/\x1b[0m\r\n\r\n`);
                                    term.write(`\x1b[36m${step2}\x1b[0m\r\n\r\n`);
                                    term.write(`\x1b[36m${step3}\x1b[0m\r\n\r\n`);
                                } else {
                                    term.write(`\x1b[90m${checkLogs}\x1b[0m\r\n`);
                                }
                                setStatus('error');
                            }
                        };

                        ws.onclose = (event) => {
                            console.log('WebSocket closed:', event.code, event.reason);
                            if (!cleanup) {
                                // Different messages based on close code
                                let msg = 'Verbindung beendet';
                                if (event.code === 1006) {
                                    msg = 'Verbindung unerwartet getrennt';
                                } else if (event.code === 1011) {
                                    msg = 'Server-Fehler';
                                } else if (event.reason) {
                                    msg = event.reason;
                                }
                                term.write(`\r\n\x1b[33m${msg}\x1b[0m\r\n`);
                                term.write('\x1b[90m(Tab wechseln und zur√ºck um neu zu verbinden)\x1b[0m\r\n');
                                setStatus('disconnected');
                            }
                        };

                        // Terminal input -> WebSocket (only when connected)
                        term.onData((data) => {
                            if (ws && ws.readyState === WebSocket.OPEN && statusRef.current === 'connected') {
                                ws.send(data);
                            }
                        });

                        // handle resize
                        const handleResize = () => {
                            if (fitAddon) {
                                fitAddon.fit();
                                if (ws && ws.readyState === WebSocket.OPEN && term && statusRef.current === 'connected') {
                                    ws.send(JSON.stringify({
                                        type: 'resize',
                                        cols: term.cols,
                                        rows: term.rows
                                    }));
                                }
                            }
                        };
                        window.addEventListener('resize', handleResize);

                    } catch (err) {
                        console.error('Terminal error:', err);
                        setStatus('error');
                    }
                };

                loadTerminal();

                return () => {
                    cleanup = true;
                    if (ws) ws.close();
                    if (term) term.dispose();
                };
            }, [node, clusterId]);

            return(
                <div className="w-full h-full relative">
                    <div ref={terminalRef} className="w-full h-full" />
                    
                    {/* Loading overlay */}
                    {status === 'loading' && (
                        <div className="absolute inset-0 flex items-center justify-center bg-black/80">
                            <div className="text-center">
                                <div className="animate-spin w-8 h-8 border-2 border-proxmox-orange border-t-transparent rounded-full mx-auto mb-2"></div>
                                <span className="text-gray-400">Lade Terminal...</span>
                            </div>
                        </div>
                    )}
                    
                    {/* Login form overlay - use fixed for reliable centering */}
                    {showLogin && (
                        <div className="fixed inset-0 flex items-center justify-center bg-black/90 z-[100] p-4">
                            <div className="bg-proxmox-card border border-proxmox-border rounded-xl p-6 w-full max-w-md shadow-2xl max-h-[85vh] overflow-y-auto">
                                <h3 className="text-white font-semibold mb-4 flex items-center gap-2">
                                    <Icons.Terminal />
                                    SSH Login - {nodeInfo.node}
                                </h3>
                                
                                {/* Host/IP - editable */}
                                <div className="mb-4">
                                    <label className="block text-gray-400 text-sm mb-1">
                                        Host / IP
                                        {nodeInfo.allowManualIp && (
                                            <span className="text-yellow-500 ml-2 text-xs">({t('autoDetectionFailed')})</span>
                                        )}
                                    </label>
                                    <input
                                        type="text"
                                        value={credentials.host || nodeInfo.ip || ''}
                                        onChange={(e) => setCredentials({...credentials, host: e.target.value})}
                                        className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white focus:border-proxmox-orange focus:outline-none font-mono"
                                        placeholder="192.168.1.100 oder hostname"
                                    />
                                </div>
                                
                                {/* Auth method tabs */}
                                <div className="flex mb-4 bg-proxmox-dark rounded-lg p-1">
                                    <button
                                        onClick={() => setCredentials({...credentials, authMethod: 'password'})}
                                        className={`flex-1 py-2 px-3 rounded-md text-sm font-medium transition-colors ${
                                            credentials.authMethod === 'password'
                                                ? 'bg-proxmox-orange text-white'
                                                : 'text-gray-400 hover:text-white'
                                        }`}
                                    >
                                        <Icons.Key className="inline w-4 h-4 mr-1" />
                                        Password
                                    </button>
                                    <button
                                        onClick={() => setCredentials({...credentials, authMethod: 'key'})}
                                        className={`flex-1 py-2 px-3 rounded-md text-sm font-medium transition-colors ${
                                            credentials.authMethod === 'key'
                                                ? 'bg-proxmox-orange text-white'
                                                : 'text-gray-400 hover:text-white'
                                        }`}
                                    >
                                        <Icons.FileKey className="inline w-4 h-4 mr-1" />
                                        SSH Key
                                    </button>
                                </div>
                                
                                <div className="space-y-3">
                                    <div>
                                        <label className="block text-gray-400 text-sm mb-1">Username</label>
                                        <input
                                            type="text"
                                            value={credentials.username}
                                            onChange={(e) => setCredentials({...credentials, username: e.target.value})}
                                            className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white focus:border-proxmox-orange focus:outline-none"
                                            placeholder="root"
                                        />
                                    </div>
                                    
                                    {credentials.authMethod === 'password' ? (
                                        <div>
                                            <label className="block text-gray-400 text-sm mb-1">Password</label>
                                            <input
                                                type="password"
                                                value={credentials.password}
                                                onChange={(e) => setCredentials({...credentials, password: e.target.value})}
                                                onKeyDown={(e) => e.key === 'Enter' && credentials.password && sendCredentials()}
                                                className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white focus:border-proxmox-orange focus:outline-none"
                                                placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                                            />
                                        </div>
                                    ) : (
                                        <>
                                            <div>
                                                <label className="block text-gray-400 text-sm mb-1">
                                                    Private Key
                                                    <span className="text-gray-500 ml-1 text-xs">(id_rsa, id_ed25519, etc.)</span>
                                                </label>
                                                
                                                {/* File upload area */}
                                                <div 
                                                    className="mb-2 border-2 border-dashed border-proxmox-border rounded-lg p-4 text-center cursor-pointer hover:border-proxmox-orange transition-colors"
                                                    onClick={() => document.getElementById('ssh-key-file-input').click()}
                                                    onDragOver={(e) => { e.preventDefault(); e.currentTarget.classList.add('border-proxmox-orange'); }}
                                                    onDragLeave={(e) => { e.preventDefault(); e.currentTarget.classList.remove('border-proxmox-orange'); }}
                                                    onDrop={(e) => {
                                                        e.preventDefault();
                                                        e.currentTarget.classList.remove('border-proxmox-orange');
                                                        const file = e.dataTransfer.files[0];
                                                        if (file) {
                                                            const reader = new FileReader();
                                                            reader.onload = (ev) => setCredentials({...credentials, privateKey: ev.target.result});
                                                            reader.readAsText(file);
                                                        }
                                                    }}
                                                >
                                                    <div className="w-8 h-8 mx-auto mb-2 text-gray-500">
                                                        <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                                                        </svg>
                                                    </div>
                                                    <span className="text-gray-400 text-sm">{t('dropKeyFileHere') || 'Drop key file here or click'}</span>
                                                    <input
                                                        id="ssh-key-file-input"
                                                        type="file"
                                                        className="hidden"
                                                        onChange={(e) => {
                                                            const file = e.target.files[0];
                                                            if (file) {
                                                                const reader = new FileReader();
                                                                reader.onload = (ev) => setCredentials({...credentials, privateKey: ev.target.result});
                                                                reader.readAsText(file);
                                                            }
                                                        }}
                                                    />
                                                </div>
                                                
                                                {/* Textarea for paste/edit */}
                                                <textarea
                                                    value={credentials.privateKey}
                                                    onChange={(e) => setCredentials({...credentials, privateKey: e.target.value})}
                                                    className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white focus:border-proxmox-orange focus:outline-none font-mono text-xs resize-y"
                                                    placeholder="-----BEGIN OPENSSH PRIVATE KEY-----&#10;b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAA...&#10;-----END OPENSSH PRIVATE KEY-----"
                                                    rows={8}
                                                    style={{minHeight: '120px'}}
                                                />
                                                {credentials.privateKey && (
                                                    <p className="text-xs text-green-400 mt-1">
                                                        ‚úì {t('keyLoaded') || 'Key loaded'} ({credentials.privateKey.split('\n').length} {t('lines') || 'lines'})
                                                    </p>
                                                )}
                                            </div>
                                            <div>
                                                <label className="block text-gray-400 text-sm mb-1">
                                                    {t('keyPassphrase') || 'Key Passphrase'} <span className="text-gray-500">({t('optional') || 'optional'})</span>
                                                </label>
                                                <input
                                                    type="password"
                                                    value={credentials.password}
                                                    onChange={(e) => setCredentials({...credentials, password: e.target.value})}
                                                    onKeyDown={(e) => e.key === 'Enter' && credentials.privateKey && sendCredentials()}
                                                    className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white focus:border-proxmox-orange focus:outline-none"
                                                    placeholder={t('ifKeyEncrypted') || 'If key is encrypted...'}
                                                />
                                            </div>
                                        </>
                                    )}
                                    
                                    <div className="flex gap-2 pt-2">
                                        <button
                                            onClick={() => {
                                                setShowLogin(false);
                                                setStatus('disconnected');
                                                if (wsRef.current) wsRef.current.close();
                                                if (termRef.current) termRef.current.write('\r\n\x1b[33mCancelled\x1b[0m\r\n');
                                            }}
                                            className="flex-1 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-500 transition-colors"
                                        >
                                            {t('cancel') || 'Cancel'}
                                        </button>
                                        <button
                                            onClick={sendCredentials}
                                            disabled={
                                                !(credentials.host || nodeInfo.ip) ||
                                                (credentials.authMethod === 'password' ? !credentials.password : !credentials.privateKey)
                                            }
                                            className="flex-1 py-2 bg-proxmox-orange text-white rounded-lg hover:bg-orange-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                                        >
                                            {t('connect') || 'Connect'}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // Node Management Modal Component
        // NS: Full node management - shell, network, disks, etc.
        // Shell tab uses xterm.js (web terminal), pretty cool
        // LW: I did the UI, Marcus handled the backend websocket stuff
        function NodeModal({ node, clusterId, onClose, addToast }) {
            const { t } = useTranslation();
            const { getAuthHeaders } = useAuth();  // NS: Fix - need auth!
            const [activeTab, setActiveTab] = useState('summary');
            const [loading, setLoading] = useState(true);
            const [data, setData] = useState({});
            
            // NS: Disk creation modal state - Dec 2025
            const [diskModal, setDiskModal] = useState({ open: false, type: null });
            const [diskForm, setDiskForm] = useState({
                device: '', name: '', vgname: '', thinpool: '',
                devices: [], raidlevel: 'single', compression: 'on', ashift: 12,
                filesystem: 'ext4', add_storage: true
            });
            const [diskCreating, setDiskCreating] = useState(false);
            const [perfTimeframe, setPerfTimeframe] = useState('hour'); // NS: For performance metrics
            
            const authHeaders = getAuthHeaders();  // NS: Get auth headers

            const tabs = [
                { id: 'summary', label: 'Summary', icon: Icons.Activity },
                { id: 'performance', label: 'Performance', icon: Icons.BarChart },
                { id: 'shell', label: 'Shell', icon: Icons.Terminal },
                { id: 'network', label: 'Network', icon: Icons.Network },
                { id: 'system', label: 'System', icon: Icons.Cog },
                { id: 'disks', label: 'Disks', icon: Icons.HardDrive },
                { id: 'repos', label: 'Repositories', icon: Icons.Package },
                { id: 'tasks', label: 'Tasks', icon: Icons.Play },
                { id: 'subscription', label: 'Subscription', icon: Icons.Shield },
            ];

            useEffect(() => { loadTabData(activeTab); }, [activeTab, perfTimeframe]);

            const loadTabData = async (tab) => {
                setLoading(true);
                try {
                    const endpoints = {
                        summary: [`${API_URL}/clusters/${clusterId}/nodes/${node}/summary`],
                        performance: [`${API_URL}/clusters/${clusterId}/nodes/${node}/rrddata?timeframe=${perfTimeframe}`],
                        network: [`${API_URL}/clusters/${clusterId}/nodes/${node}/network`],
                        system: [
                            `${API_URL}/clusters/${clusterId}/nodes/${node}/dns`,
                            `${API_URL}/clusters/${clusterId}/nodes/${node}/hosts`,
                            `${API_URL}/clusters/${clusterId}/nodes/${node}/time`,
                            `${API_URL}/clusters/${clusterId}/nodes/${node}/syslog?limit=100`,
                            `${API_URL}/clusters/${clusterId}/nodes/${node}/certificates`,
                        ],
                        disks: [
                            `${API_URL}/clusters/${clusterId}/nodes/${node}/disks`,
                            `${API_URL}/clusters/${clusterId}/nodes/${node}/disks/lvm`,
                            `${API_URL}/clusters/${clusterId}/nodes/${node}/disks/lvmthin`,
                            `${API_URL}/clusters/${clusterId}/nodes/${node}/disks/zfs`,
                        ],
                        repos: [`${API_URL}/clusters/${clusterId}/nodes/${node}/repos`],
                        tasks: [`${API_URL}/clusters/${clusterId}/nodes/${node}/tasks?limit=50`],
                        subscription: [`${API_URL}/clusters/${clusterId}/nodes/${node}/subscription`],
                    };
                    const urls = endpoints[tab] || [];
                    // NS: Fixed - now using auth headers and credentials!
                    const results = await Promise.all(urls.map(u => fetch(u, { credentials: 'include', headers: authHeaders }).then(r => r.ok ? r.json() : null).catch(() => null)));
                    
                    const newData = { ...data };
                    if (tab === 'summary') newData.summary = results[0];
                    else if (tab === 'network') newData.network = results[0];
                    else if (tab === 'system') {
                        newData.dns = results[0] || {};
                        newData.hosts = results[1]?.data || '';
                        newData.time = results[2] || {};
                        newData.syslog = results[3] || [];
                        newData.certificates = results[4] || [];
                    }
                    else if (tab === 'disks') {
                        newData.disks = results[0] || [];
                        newData.lvm = results[1] || [];
                        newData.lvmthin = results[2] || [];
                        newData.zfs = results[3] || [];
                    }
                    else if (tab === 'performance') newData.performance = results[0] || {};
                    else if (tab === 'repos') newData.repos = results[0]?.repositories || [];
                    else if (tab === 'tasks') newData.tasks = results[0] || [];
                    else if (tab === 'subscription') newData.subscription = results[0] || {};
                    setData(newData);
                } catch (e) { console.error(e); }
                setLoading(false);
            };

            // NS: minified helpers for this component, dont judge me
            const formatBytes = (b) => { if(!b)return'0 B';const k=1024,s=['B','KB','MB','GB','TB'],i=Math.floor(Math.log(b)/Math.log(k));return(b/Math.pow(k,i)).toFixed(1)+' '+s[i]; };
            const formatUptime = (s) => { if(!s)return'0s';const d=Math.floor(s/86400),h=Math.floor((s%86400)/3600),m=Math.floor((s%3600)/60);return`${d}d ${h}h ${m}m`; };

            const handleSave = async (endpoint, payload, msg) => {
                try {
                    const res = await fetch(`${API_URL}/clusters/${clusterId}/nodes/${node}/${endpoint}`, {
                        method: endpoint.includes('hosts') ? 'POST' : 'PUT',
                        headers: { 'Content-Type': 'application/json', ...authHeaders },
                        body: JSON.stringify(payload)
                    });
                    addToast(res.ok ? msg : t('error') || 'Error', res.ok ? 'success' : 'error');
                    if (res.ok) loadTabData(activeTab);
                } catch (e) { addToast(t('error') || 'Error', 'error'); }
            };
            
            // NS: Disk creation functions - Dec 2025
            const unusedDisks = (data.disks || []).filter(d => d.used === 'unused' || !d.used);
            
            const openDiskModal = async (type) => {
                setDiskForm({
                    device: '', name: '', vgname: '', thinpool: '',
                    devices: [], raidlevel: 'single', compression: 'on', ashift: 12,
                    filesystem: 'ext4', add_storage: true
                });
                // NS: Make sure disk data is loaded before opening modal
                if (!data.disks || data.disks.length === 0) {
                    await loadTabData('disks');
                }
                setDiskModal({ open: true, type });
            };
            
            const createDisk = async () => {
                const { type } = diskModal;
                let endpoint, body;
                
                if (type === 'lvm') {
                    if (!diskForm.device || !diskForm.name) {
                        addToast('Device and name required', 'error');
                        return;
                    }
                    endpoint = 'disks/lvm';
                    body = { device: diskForm.device, name: diskForm.name, add_storage: diskForm.add_storage };
                } else if (type === 'lvmthin') {
                    // NS: For LVM-thin, device = VG name where thin pool is created
                    if (!diskForm.vgname || !diskForm.name) {
                        addToast('Volume group and pool name required', 'error');
                        return;
                    }
                    endpoint = 'disks/lvmthin';
                    body = { device: diskForm.vgname, name: diskForm.name, add_storage: diskForm.add_storage };
                } else if (type === 'zfs') {
                    if (diskForm.devices.length === 0 || !diskForm.name) {
                        addToast('Device(s) and name required', 'error');
                        return;
                    }
                    endpoint = 'disks/zfs';
                    body = { 
                        devices: diskForm.devices, 
                        name: diskForm.name, 
                        raidlevel: diskForm.raidlevel,
                        compression: diskForm.compression,
                        ashift: diskForm.ashift,
                        add_storage: diskForm.add_storage 
                    };
                } else if (type === 'directory') {
                    if (!diskForm.device || !diskForm.name) {
                        addToast('Device and name required', 'error');
                        return;
                    }
                    endpoint = 'disks/directory';
                    body = { device: diskForm.device, name: diskForm.name, filesystem: diskForm.filesystem, add_storage: diskForm.add_storage };
                }
                
                if (!endpoint) {
                    addToast('Unknown storage type', 'error');
                    return;
                }
                
                setDiskCreating(true);
                try {
                    console.log('Creating disk:', endpoint, body);
                    const res = await fetch(`${API_URL}/clusters/${clusterId}/nodes/${node}/${endpoint}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(body)
                    });
                    const result = await res.json();
                    console.log('Create disk response:', res.status, result);
                    
                    if (res.ok) {
                        addToast(`${type.toUpperCase()} created successfully`, 'success');
                        setDiskModal({ open: false, type: null });
                        await loadTabData('disks');
                    } else {
                        addToast(result.error || 'Failed to create', 'error');
                    }
                } catch (e) {
                    console.error('Error creating storage:', e);
                    addToast('Error creating storage', 'error');
                } finally {
                    setDiskCreating(false);
                }
            };
            
            // Disk Create Modal Component
            const DiskCreateModal = () => {
                if (!diskModal.open) return null;
                const { type } = diskModal;
                
                return (
                    <div className="fixed inset-0 z-[60] flex items-center justify-center bg-black/70" onClick={() => setDiskModal({ open: false, type: null })}>
                        <div className="bg-proxmox-card border border-proxmox-border rounded-xl w-full max-w-lg" onClick={e => e.stopPropagation()}>
                            <div className="p-4 border-b border-proxmox-border flex items-center justify-between">
                                <h3 className="font-semibold text-white">
                                    {type === 'lvm' && 'Create LVM Volume Group'}
                                    {type === 'lvmthin' && 'Create LVM-Thin Pool'}
                                    {type === 'zfs' && 'Create ZFS Pool'}
                                    {type === 'directory' && 'Create Directory Storage'}
                                </h3>
                                <button onClick={() => setDiskModal({ open: false, type: null })} className="p-1 hover:bg-proxmox-dark rounded"><Icons.X /></button>
                            </div>
                            
                            <div className="p-4 space-y-4">
                                {/* Device Selection - for LVM, LVM-Thin (vg), Directory */}
                                {(type === 'lvm' || type === 'directory') && (
                                    <div>
                                        <label className="block text-sm text-gray-400 mb-1">Device *</label>
                                        <select 
                                            value={diskForm.device} 
                                            onChange={e => setDiskForm({...diskForm, device: e.target.value})}
                                            className="w-full bg-proxmox-dark border border-proxmox-border rounded p-2 text-sm"
                                        >
                                            <option value="">Select disk...</option>
                                            {unusedDisks.map(d => (
                                                <option key={d.devpath} value={d.devpath}>
                                                    {d.devpath} - {formatBytes(d.size)} ({d.type || 'hdd'})
                                                </option>
                                            ))}
                                        </select>
                                        {unusedDisks.length === 0 && (
                                            <p className="text-xs text-yellow-400 mt-1">No unused disks available</p>
                                        )}
                                    </div>
                                )}
                                
                                {/* VG Selection for LVM-Thin */}
                                {type === 'lvmthin' && (
                                    <div>
                                        <label className="block text-sm text-gray-400 mb-1">Volume Group *</label>
                                        <select 
                                            value={diskForm.vgname} 
                                            onChange={e => setDiskForm({...diskForm, vgname: e.target.value})}
                                            className="w-full bg-proxmox-dark border border-proxmox-border rounded p-2 text-sm"
                                        >
                                            <option value="">Select VG...</option>
                                            {Array.isArray(data.lvm) && data.lvm.map(v => (
                                                <option key={v.vg} value={v.vg}>
                                                    {v.vg} - {formatBytes(v.free)} free of {formatBytes(v.size)}
                                                </option>
                                            ))}
                                        </select>
                                        {(!Array.isArray(data.lvm) || data.lvm.length === 0) && (
                                            <p className="text-xs text-yellow-400 mt-1">
                                                ‚ö†Ô∏è No LVM Volume Groups found. Create an LVM VG first before creating a thin pool.
                                            </p>
                                        )}
                                    </div>
                                )}
                                
                                {/* Multi-device Selection for ZFS */}
                                {type === 'zfs' && (
                                    <div>
                                        <label className="block text-sm text-gray-400 mb-1">Devices *</label>
                                        <div className="space-y-1 max-h-32 overflow-y-auto bg-proxmox-dark border border-proxmox-border rounded p-2">
                                            {unusedDisks.length > 0 ? unusedDisks.map(d => (
                                                <label key={d.devpath} className="flex items-center gap-2 text-sm cursor-pointer hover:bg-proxmox-hover p-1 rounded">
                                                    <input 
                                                        type="checkbox"
                                                        checked={diskForm.devices.includes(d.devpath)}
                                                        onChange={e => {
                                                            if (e.target.checked) {
                                                                setDiskForm({...diskForm, devices: [...diskForm.devices, d.devpath]});
                                                            } else {
                                                                setDiskForm({...diskForm, devices: diskForm.devices.filter(x => x !== d.devpath)});
                                                            }
                                                        }}
                                                        className="rounded"
                                                    />
                                                    <span className="font-mono">{d.devpath}</span>
                                                    <span className="text-gray-500">({formatBytes(d.size)}, {d.type || 'hdd'})</span>
                                                </label>
                                            )) : <p className="text-xs text-yellow-400">No unused disks available</p>}
                                        </div>
                                        {diskForm.devices.length > 0 && (
                                            <p className="text-xs text-gray-500 mt-1">{diskForm.devices.length} disk(s) selected</p>
                                        )}
                                    </div>
                                )}
                                
                                {/* Name */}
                                <div>
                                    <label className="block text-sm text-gray-400 mb-1">
                                        {type === 'lvmthin' ? 'Pool Name *' : type === 'zfs' ? 'Pool Name *' : 'Name *'}
                                    </label>
                                    <input 
                                        value={diskForm.name}
                                        onChange={e => setDiskForm({...diskForm, name: e.target.value})}
                                        placeholder={type === 'lvm' ? 'myvg' : type === 'lvmthin' ? 'data' : type === 'zfs' ? 'tank' : 'storage'}
                                        className="w-full bg-proxmox-dark border border-proxmox-border rounded p-2 text-sm"
                                    />
                                </div>
                                
                                {/* ZFS Options */}
                                {type === 'zfs' && (
                                    <>
                                        <div className="grid grid-cols-3 gap-3">
                                            <div>
                                                <label className="block text-sm text-gray-400 mb-1">RAID Level</label>
                                                <select 
                                                    value={diskForm.raidlevel}
                                                    onChange={e => setDiskForm({...diskForm, raidlevel: e.target.value})}
                                                    className="w-full bg-proxmox-dark border border-proxmox-border rounded p-2 text-sm"
                                                >
                                                    <option value="single">Single</option>
                                                    <option value="mirror">Mirror</option>
                                                    <option value="raid10">RAID10</option>
                                                    <option value="raidz">RAIDZ</option>
                                                    <option value="raidz2">RAIDZ2</option>
                                                    <option value="raidz3">RAIDZ3</option>
                                                </select>
                                            </div>
                                            <div>
                                                <label className="block text-sm text-gray-400 mb-1">Compression</label>
                                                <select 
                                                    value={diskForm.compression}
                                                    onChange={e => setDiskForm({...diskForm, compression: e.target.value})}
                                                    className="w-full bg-proxmox-dark border border-proxmox-border rounded p-2 text-sm"
                                                >
                                                    <option value="on">On (LZ4)</option>
                                                    <option value="off">Off</option>
                                                    <option value="lz4">LZ4</option>
                                                    <option value="zstd">ZSTD</option>
                                                    <option value="gzip">GZIP</option>
                                                    <option value="lzjb">LZJB</option>
                                                </select>
                                            </div>
                                            <div>
                                                <label className="block text-sm text-gray-400 mb-1">ashift</label>
                                                <select 
                                                    value={diskForm.ashift}
                                                    onChange={e => setDiskForm({...diskForm, ashift: parseInt(e.target.value)})}
                                                    className="w-full bg-proxmox-dark border border-proxmox-border rounded p-2 text-sm"
                                                >
                                                    <option value={9}>9 (512B)</option>
                                                    <option value={12}>12 (4K)</option>
                                                    <option value={13}>13 (8K)</option>
                                                </select>
                                            </div>
                                        </div>
                                        <p className="text-xs text-gray-500">
                                            ‚ÑπÔ∏è Use ashift=12 for modern drives (4K sectors). Mirror needs 2+ disks, RAIDZ needs 3+, RAIDZ2 needs 4+.
                                        </p>
                                    </>
                                )}
                                
                                {/* Directory Options */}
                                {type === 'directory' && (
                                    <div>
                                        <label className="block text-sm text-gray-400 mb-1">Filesystem</label>
                                        <select 
                                            value={diskForm.filesystem}
                                            onChange={e => setDiskForm({...diskForm, filesystem: e.target.value})}
                                            className="w-full bg-proxmox-dark border border-proxmox-border rounded p-2 text-sm"
                                        >
                                            <option value="ext4">ext4 (recommended)</option>
                                            <option value="xfs">XFS</option>
                                        </select>
                                    </div>
                                )}
                                
                                {/* Add to PVE Storage */}
                                <label className="flex items-center gap-2 text-sm">
                                    <input 
                                        type="checkbox"
                                        checked={diskForm.add_storage}
                                        onChange={e => setDiskForm({...diskForm, add_storage: e.target.checked})}
                                        className="rounded"
                                    />
                                    Add to Proxmox VE storage configuration
                                </label>
                            </div>
                            
                            <div className="p-4 border-t border-proxmox-border flex justify-end gap-2">
                                <button 
                                    onClick={() => setDiskModal({ open: false, type: null })}
                                    disabled={diskCreating}
                                    className="px-4 py-2 bg-proxmox-dark hover:bg-proxmox-hover disabled:opacity-50 rounded-lg text-sm"
                                >
                                    Cancel
                                </button>
                                <button 
                                    onClick={createDisk}
                                    disabled={
                                        diskCreating ||
                                        !diskForm.name || 
                                        (type === 'lvm' && !diskForm.device) ||
                                        (type === 'lvmthin' && !diskForm.vgname) ||
                                        (type === 'zfs' && diskForm.devices.length === 0) ||
                                        (type === 'directory' && !diskForm.device)
                                    }
                                    className="px-4 py-2 bg-proxmox-orange hover:bg-orange-600 disabled:opacity-50 disabled:cursor-not-allowed rounded-lg text-sm text-white flex items-center gap-2"
                                >
                                    {diskCreating && <span className="animate-spin">‚è≥</span>}
                                    {diskCreating ? 'Creating...' : 'Create'}
                                </button>
                            </div>
                        </div>
                    </div>
                );
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop bg-black/80">
                    <DiskCreateModal />
                    <div className="w-full max-w-6xl max-h-[90vh] bg-proxmox-card border border-proxmox-border rounded-2xl shadow-2xl animate-scale-in overflow-hidden flex flex-col">
                        <div className="flex items-center justify-between px-6 py-4 border-b border-proxmox-border bg-proxmox-dark">
                            <div className="flex items-center gap-3">
                                <div className="p-2 rounded-lg bg-green-500/10"><Icons.Server /></div>
                                <div><h2 className="font-semibold text-white">{node}</h2><p className="text-xs text-gray-400">Proxmox Node</p></div>
                            </div>
                            <button onClick={onClose} className="p-2 rounded-lg hover:bg-red-500/20 text-gray-400 hover:text-red-400"><Icons.X /></button>
                        </div>

                        <div className="flex items-center gap-1 px-6 py-3 border-b border-proxmox-border bg-proxmox-dark/50 overflow-x-auto">
                            {tabs.map(tab => (
                                <button key={tab.id} onClick={() => setActiveTab(tab.id)}
                                    className={`flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium transition-all whitespace-nowrap ${activeTab === tab.id ? 'bg-proxmox-orange text-white' : 'text-gray-400 hover:text-white hover:bg-proxmox-hover'}`}>
                                    <tab.icon />{tab.label}
                                </button>
                            ))}
                        </div>

                        <div className="flex-1 overflow-y-auto p-6">
                            {loading ? (
                                <div className="flex items-center justify-center h-64"><div className="animate-spin w-8 h-8 border-2 border-proxmox-orange border-t-transparent rounded-full"></div></div>
                            ) : (
                                <>
                                    {activeTab === 'summary' && data.summary && (
                                        <div className="space-y-6">
                                            <div className="grid grid-cols-4 gap-4">
                                                {[
                                                    { label: 'Status', value: data.summary.status, color: 'text-green-400' },
                                                    { label: 'Uptime', value: formatUptime(data.summary.uptime), color: 'text-white' },
                                                    { label: 'CPU', value: `${((data.summary.cpu||0)*100).toFixed(1)}%`, color: 'text-proxmox-orange' },
                                                    { label: 'Load', value: (data.summary.loadavg||[]).join(', '), color: 'text-white' },
                                                ].map((item, i) => (
                                                    <div key={i} className="p-4 bg-proxmox-dark rounded-lg border border-proxmox-border">
                                                        <div className="text-xs text-gray-500 mb-1">{item.label}</div>
                                                        <div className={`text-lg font-semibold ${item.color}`}>{item.value}</div>
                                                    </div>
                                                ))}
                                            </div>
                                            <div className="grid grid-cols-3 gap-4">
                                                {[
                                                    { label: 'Memory', used: data.summary.memory?.used, total: data.summary.memory?.total, color: 'bg-proxmox-orange' },
                                                    { label: 'Swap', used: data.summary.swap?.used, total: data.summary.swap?.total, color: 'bg-blue-500' },
                                                    { label: 'Root FS', used: data.summary.rootfs?.used, total: data.summary.rootfs?.total, color: 'bg-green-500' },
                                                ].map((item, i) => (
                                                    <div key={i} className="p-4 bg-proxmox-dark rounded-lg border border-proxmox-border">
                                                        <div className="text-sm font-medium text-white mb-3">{item.label}</div>
                                                        <div className="space-y-2">
                                                            <div className="flex justify-between text-sm"><span className="text-gray-400">Used</span><span className="text-white">{formatBytes(item.used)}</span></div>
                                                            <div className="flex justify-between text-sm"><span className="text-gray-400">Total</span><span className="text-white">{formatBytes(item.total)}</span></div>
                                                            <div className="w-full bg-proxmox-hover rounded-full h-2">
                                                                <div className={`${item.color} h-2 rounded-full`} style={{ width: `${((item.used||0)/(item.total||1))*100}%` }}></div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                            <div className="p-4 bg-proxmox-dark rounded-lg border border-proxmox-border">
                                                <div className="text-sm font-medium text-white mb-3">System Info</div>
                                                <div className="grid grid-cols-2 gap-4 text-sm">
                                                    <div><span className="text-gray-400">Kernel:</span><span className="ml-2 text-white font-mono">{data.summary.kversion}</span></div>
                                                    <div><span className="text-gray-400">PVE:</span><span className="ml-2 text-white">{data.summary.pveversion}</span></div>
                                                    <div><span className="text-gray-400">CPU:</span><span className="ml-2 text-white">{data.summary.cpuinfo?.model}</span></div>
                                                    <div><span className="text-gray-400">Cores:</span><span className="ml-2 text-white">{data.summary.cpuinfo?.cores} ({data.summary.cpuinfo?.cpus} CPUs)</span></div>
                                                </div>
                                            </div>
                                        </div>
                                    )}

                                    {/* Performance Tab - NS: Added Jan 2026 */}
                                    {activeTab === 'performance' && (
                                        <div className="space-y-6">
                                            {/* Timeframe Selector */}
                                            <div className="flex items-center justify-between">
                                                <h3 className="text-lg font-semibold text-white flex items-center gap-2">
                                                    <Icons.BarChart /> Performance Metrics
                                                </h3>
                                                <div className="flex gap-2">
                                                    {['hour', 'day', 'week', 'month', 'year'].map(tf => (
                                                        <button
                                                            key={tf}
                                                            onClick={() => setPerfTimeframe(tf)}
                                                            className={`px-3 py-1.5 rounded-lg text-sm ${perfTimeframe === tf 
                                                                ? 'bg-proxmox-orange text-white' 
                                                                : 'bg-proxmox-dark text-gray-400 hover:text-white'}`}
                                                        >
                                                            {tf.charAt(0).toUpperCase() + tf.slice(1)}
                                                        </button>
                                                    ))}
                                                </div>
                                            </div>
                                            
                                            {data.performance?.metrics ? (
                                                <div className="grid grid-cols-2 gap-4">
                                                    {/* CPU Chart */}
                                                    <div className="bg-proxmox-dark rounded-lg border border-proxmox-border p-4">
                                                        <div className="flex items-center justify-between mb-3">
                                                            <span className="text-sm font-medium text-white">CPU Usage</span>
                                                            <span className="text-xs text-proxmox-orange">
                                                                {data.performance.metrics.cpu?.length > 0 
                                                                    ? `${data.performance.metrics.cpu[data.performance.metrics.cpu.length - 1]?.toFixed(1)}%`
                                                                    : '--'}
                                                            </span>
                                                        </div>
                                                        <div className="h-32 flex items-end gap-0.5">
                                                            {(data.performance.metrics.cpu || []).slice(-60).map((v, i) => (
                                                                <div 
                                                                    key={i} 
                                                                    className="flex-1 bg-proxmox-orange/80 rounded-t transition-all"
                                                                    style={{ height: `${Math.max(2, v)}%` }}
                                                                    title={`${v?.toFixed(1)}%`}
                                                                />
                                                            ))}
                                                        </div>
                                                    </div>
                                                    
                                                    {/* Memory Chart */}
                                                    <div className="bg-proxmox-dark rounded-lg border border-proxmox-border p-4">
                                                        <div className="flex items-center justify-between mb-3">
                                                            <span className="text-sm font-medium text-white">Memory Usage</span>
                                                            <span className="text-xs text-blue-400">
                                                                {data.performance.metrics.memory?.length > 0 
                                                                    ? `${data.performance.metrics.memory[data.performance.metrics.memory.length - 1]?.toFixed(1)}%`
                                                                    : '--'}
                                                            </span>
                                                        </div>
                                                        <div className="h-32 flex items-end gap-0.5">
                                                            {(data.performance.metrics.memory || []).slice(-60).map((v, i) => (
                                                                <div 
                                                                    key={i} 
                                                                    className="flex-1 bg-blue-500/80 rounded-t transition-all"
                                                                    style={{ height: `${Math.max(2, v)}%` }}
                                                                    title={`${v?.toFixed(1)}%`}
                                                                />
                                                            ))}
                                                        </div>
                                                    </div>
                                                    
                                                    {/* IO Wait Chart */}
                                                    <div className="bg-proxmox-dark rounded-lg border border-proxmox-border p-4">
                                                        <div className="flex items-center justify-between mb-3">
                                                            <span className="text-sm font-medium text-white">IO Wait</span>
                                                            <span className="text-xs text-yellow-400">
                                                                {data.performance.metrics.iowait?.length > 0 
                                                                    ? `${data.performance.metrics.iowait[data.performance.metrics.iowait.length - 1]?.toFixed(1)}%`
                                                                    : '--'}
                                                            </span>
                                                        </div>
                                                        <div className="h-32 flex items-end gap-0.5">
                                                            {(data.performance.metrics.iowait || []).slice(-60).map((v, i) => (
                                                                <div 
                                                                    key={i} 
                                                                    className="flex-1 bg-yellow-500/80 rounded-t transition-all"
                                                                    style={{ height: `${Math.max(2, v)}%` }}
                                                                    title={`${v?.toFixed(1)}%`}
                                                                />
                                                            ))}
                                                        </div>
                                                    </div>
                                                    
                                                    {/* Load Average Chart */}
                                                    <div className="bg-proxmox-dark rounded-lg border border-proxmox-border p-4">
                                                        <div className="flex items-center justify-between mb-3">
                                                            <span className="text-sm font-medium text-white">Load Average</span>
                                                            <span className="text-xs text-green-400">
                                                                {data.performance.metrics.loadavg?.length > 0 
                                                                    ? data.performance.metrics.loadavg[data.performance.metrics.loadavg.length - 1]?.toFixed(2)
                                                                    : '--'}
                                                            </span>
                                                        </div>
                                                        <div className="h-32 flex items-end gap-0.5">
                                                            {(data.performance.metrics.loadavg || []).slice(-60).map((v, i) => {
                                                                const maxLoad = Math.max(...(data.performance.metrics.loadavg || [1]));
                                                                const pct = (v / (maxLoad || 1)) * 100;
                                                                return (
                                                                    <div 
                                                                        key={i} 
                                                                        className="flex-1 bg-green-500/80 rounded-t transition-all"
                                                                        style={{ height: `${Math.max(2, pct)}%` }}
                                                                        title={v?.toFixed(2)}
                                                                    />
                                                                );
                                                            })}
                                                        </div>
                                                    </div>
                                                    
                                                    {/* Network In/Out Chart */}
                                                    <div className="bg-proxmox-dark rounded-lg border border-proxmox-border p-4 col-span-2">
                                                        <div className="flex items-center justify-between mb-3">
                                                            <span className="text-sm font-medium text-white">Network I/O</span>
                                                            <div className="flex gap-4 text-xs">
                                                                <span className="text-cyan-400">
                                                                    ‚Üì {data.performance.metrics.net_in?.length > 0 
                                                                        ? `${data.performance.metrics.net_in[data.performance.metrics.net_in.length - 1]?.toFixed(1)} KB/s`
                                                                        : '--'}
                                                                </span>
                                                                <span className="text-purple-400">
                                                                    ‚Üë {data.performance.metrics.net_out?.length > 0 
                                                                        ? `${data.performance.metrics.net_out[data.performance.metrics.net_out.length - 1]?.toFixed(1)} KB/s`
                                                                        : '--'}
                                                                </span>
                                                            </div>
                                                        </div>
                                                        <div className="h-32 flex items-end gap-0.5 relative">
                                                            {/* Net In */}
                                                            {(data.performance.metrics.net_in || []).slice(-60).map((v, i) => {
                                                                const maxNet = Math.max(
                                                                    Math.max(...(data.performance.metrics.net_in || [1])),
                                                                    Math.max(...(data.performance.metrics.net_out || [1]))
                                                                );
                                                                const pct = (v / (maxNet || 1)) * 100;
                                                                return (
                                                                    <div 
                                                                        key={`in-${i}`} 
                                                                        className="flex-1 bg-cyan-500/60 rounded-t transition-all absolute bottom-0"
                                                                        style={{ 
                                                                            height: `${Math.max(2, pct)}%`,
                                                                            left: `${(i / 60) * 100}%`,
                                                                            width: `${100/60}%`
                                                                        }}
                                                                    />
                                                                );
                                                            })}
                                                            {/* Net Out */}
                                                            {(data.performance.metrics.net_out || []).slice(-60).map((v, i) => {
                                                                const maxNet = Math.max(
                                                                    Math.max(...(data.performance.metrics.net_in || [1])),
                                                                    Math.max(...(data.performance.metrics.net_out || [1]))
                                                                );
                                                                const pct = (v / (maxNet || 1)) * 100;
                                                                return (
                                                                    <div 
                                                                        key={`out-${i}`} 
                                                                        className="flex-1 bg-purple-500/60 rounded-t transition-all absolute bottom-0"
                                                                        style={{ 
                                                                            height: `${Math.max(2, pct)}%`,
                                                                            left: `${(i / 60) * 100}%`,
                                                                            width: `${100/60 * 0.4}%`,
                                                                            marginLeft: `${100/60 * 0.5}%`
                                                                        }}
                                                                    />
                                                                );
                                                            })}
                                                        </div>
                                                    </div>
                                                </div>
                                            ) : (
                                                <div className="text-center text-gray-500 py-12">
                                                    <Icons.BarChart className="mx-auto mb-3 w-12 h-12 opacity-50" />
                                                    <p>No performance data available</p>
                                                    <p className="text-sm mt-1">Try refreshing or selecting a different timeframe</p>
                                                </div>
                                            )}
                                        </div>
                                    )}

                                    {activeTab === 'shell' && (
                                        <div className="h-full flex flex-col">
                                            <div className="flex items-center justify-between mb-4">
                                                <div className="flex items-center gap-3">
                                                    <Icons.Terminal />
                                                    <span className="text-white font-medium">Node Shell</span>
                                                </div>
                                                <button
                                                    onClick={() => setData({...data, shellFullscreen: true})}
                                                    className="flex items-center gap-2 px-3 py-1.5 bg-proxmox-dark border border-proxmox-border rounded-lg text-gray-300 hover:text-white text-sm"
                                                >
                                                    <Icons.Maximize />
                                                    Fullscreen
                                                </button>
                                            </div>
                                            <div className="flex-1 bg-black rounded-lg border border-proxmox-border overflow-hidden min-h-[400px]">
                                                <NodeShellTerminal 
                                                    node={node} 
                                                    clusterId={clusterId} 
                                                    addToast={addToast}
                                                />
                                            </div>
                                        </div>
                                    )}

                                    {activeTab === 'network' && (
                                        <div className="space-y-4">
                                            {/* Action Buttons */}
                                            <div className="flex items-center gap-3 flex-wrap">
                                                <div className="relative">
                                                    <button 
                                                        onClick={() => setData({...data, showCreateMenu: !data.showCreateMenu})}
                                                        className="flex items-center gap-2 px-4 py-2 bg-proxmox-orange rounded-lg text-white text-sm hover:bg-orange-600"
                                                    >
                                                        <Icons.Plus />
                                                        Create
                                                    </button>
                                                    {data.showCreateMenu && (
                                                        <div className="absolute top-full left-0 mt-1 bg-proxmox-card border border-proxmox-border rounded-lg shadow-xl z-10 min-w-[160px]">
                                                            {['bridge', 'bond', 'vlan', 'OVSBridge', 'OVSBond', 'OVSIntPort'].map(ifaceType => (
                                                                <button key={ifaceType} onClick={() => {
                                                                    setData({...data, showCreateMenu: false, editIface: { type: ifaceType, iface: '', isNew: true }});
                                                                }} className="w-full px-4 py-2 text-left text-sm text-gray-300 hover:bg-proxmox-hover hover:text-white">
                                                                    Linux {ifaceType.charAt(0).toUpperCase() + ifaceType.slice(1)}
                                                                </button>
                                                            ))}
                                                        </div>
                                                    )}
                                                </div>
                                                <button 
                                                    onClick={async () => {
                                                        try {
                                                            const res = await fetch(`${API_URL}/clusters/${clusterId}/nodes/${node}/network`, { method: 'PUT' });
                                                            if (res.ok) { addToast(t('networkChangesApplied') || 'Network changes applied'); loadTabData('network'); }
                                                            else { const err = await res.json(); addToast(err.error || t('error'), 'error'); }
                                                        } catch (e) { addToast(t('error') || 'Error', 'error'); }
                                                    }}
                                                    className="px-4 py-2 bg-green-600 rounded-lg text-white text-sm hover:bg-green-700"
                                                >
                                                    Apply Configuration
                                                </button>
                                                <button 
                                                    onClick={async () => {
                                                        if (!confirm('Alle nicht angewendeten Aenderungen verwerfen?')) return;
                                                        try {
                                                            const res = await fetch(`${API_URL}/clusters/${clusterId}/nodes/${node}/network`, { method: 'DELETE' });
                                                            if (res.ok) { addToast(t('changesReverted') || 'Changes reverted'); loadTabData('network'); }
                                                            else { const err = await res.json(); addToast(err.error || t('error'), 'error'); }
                                                        } catch (e) { addToast(t('error') || 'Error', 'error'); }
                                                    }}
                                                    className="px-4 py-2 bg-proxmox-card border border-proxmox-border rounded-lg text-gray-300 text-sm hover:text-white"
                                                >
                                                    Revert
                                                </button>
                                            </div>

                                            {/* Interface List */}
                                            <div className="space-y-2">
                                                {(data.network||[]).map(iface => (
                                                    <div key={iface.iface} className="p-4 bg-proxmox-dark rounded-lg border border-proxmox-border">
                                                        <div className="flex items-center justify-between mb-2">
                                                            <div className="flex items-center gap-3">
                                                                <Icons.Network />
                                                                <span className="font-medium text-white">{iface.iface}</span>
                                                                <span className="text-xs text-gray-500 bg-proxmox-card px-2 py-0.5 rounded">{iface.type}</span>
                                                                {iface.active && <span className="text-xs text-green-400 bg-green-500/10 px-2 py-0.5 rounded">Active</span>}
                                                            </div>
                                                            <div className="flex items-center gap-2">
                                                                <button 
                                                                    onClick={() => setData({...data, editIface: {...iface, isNew: false}})}
                                                                    className="p-1.5 rounded hover:bg-proxmox-hover text-gray-400 hover:text-white"
                                                                    title="Edit"
                                                                >
                                                                    <Icons.Cog />
                                                                </button>
                                                                <button 
                                                                    onClick={async () => {
                                                                        if (!confirm(`${iface.iface}: ${t('deleteInterfaceConfirm')}`)) return;
                                                                        try {
                                                                            const res = await fetch(`${API_URL}/clusters/${clusterId}/nodes/${node}/network/${iface.iface}`, { method: 'DELETE' });
                                                                            if (res.ok) { addToast(`${iface.iface} ${t('deleted')}`); loadTabData('network'); }
                                                                            else { const err = await res.json(); addToast(err.error || t('error'), 'error'); }
                                                                        } catch (e) { addToast(t('error') || 'Error', 'error'); }
                                                                    }}
                                                                    className="p-1.5 rounded hover:bg-red-500/20 text-gray-400 hover:text-red-400"
                                                                    title="Delete"
                                                                >
                                                                    <Icons.Trash />
                                                                </button>
                                                            </div>
                                                        </div>
                                                        <div className="grid grid-cols-4 gap-4 text-sm">
                                                            {iface.address && <div><span className="text-gray-500">IP:</span><span className="ml-2 text-white font-mono">{iface.address}/{iface.netmask || iface.cidr?.split('/')[1] || ''}</span></div>}
                                                            {iface.gateway && <div><span className="text-gray-500">Gateway:</span><span className="ml-2 text-white font-mono">{iface.gateway}</span></div>}
                                                            {iface.bridge_ports && <div><span className="text-gray-500">Ports:</span><span className="ml-2 text-white">{iface.bridge_ports}</span></div>}
                                                            {iface.slaves && <div><span className="text-gray-500">Slaves:</span><span className="ml-2 text-white">{iface.slaves}</span></div>}
                                                            {iface['vlan-raw-device'] && <div><span className="text-gray-500">VLAN Device:</span><span className="ml-2 text-white">{iface['vlan-raw-device']}</span></div>}
                                                            {iface['vlan-id'] && <div><span className="text-gray-500">VLAN ID:</span><span className="ml-2 text-white">{iface['vlan-id']}</span></div>}
                                                            {iface.bond_mode && <div><span className="text-gray-500">Bond Mode:</span><span className="ml-2 text-white">{iface.bond_mode}</span></div>}
                                                            {iface.comments && <div className="col-span-4"><span className="text-gray-500">Comment:</span><span className="ml-2 text-gray-400">{iface.comments}</span></div>}
                                                        </div>
                                                    </div>
                                                ))}
                                                {(!data.network || data.network.length === 0) && <div className="text-center py-8 text-gray-500">Keine Netzwerk-Interfaces</div>}
                                            </div>

                                            {/* Edit/Create Interface Modal */}
                                            {data.editIface && (
                                                <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/80">
                                                    <div className="w-full max-w-xl bg-proxmox-card border border-proxmox-border rounded-xl p-6">
                                                        <h3 className="text-lg font-semibold text-white mb-4">
                                                            {data.editIface.isNew ? `Create: Linux ${data.editIface.type}` : `Edit: ${data.editIface.iface}`}
                                                        </h3>
                                                        <div className="space-y-4">
                                                            <div className="grid grid-cols-2 gap-4">
                                                                <div>
                                                                    <label className="block text-xs text-gray-400 mb-1">Name</label>
                                                                    <input type="text" value={data.editIface.iface || ''} 
                                                                        onChange={(e) => setData({...data, editIface: {...data.editIface, iface: e.target.value}})}
                                                                        disabled={!data.editIface.isNew}
                                                                        placeholder={data.editIface.type === 'bridge' ? 'vmbr0' : data.editIface.type === 'bond' ? 'bond0' : 'vlan0'}
                                                                        className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white text-sm disabled:opacity-50" />
                                                                </div>
                                                                <div>
                                                                    <label className="block text-xs text-gray-400 mb-1">IPv4/CIDR</label>
                                                                    <input type="text" value={data.editIface.cidr || ''} 
                                                                        onChange={(e) => setData({...data, editIface: {...data.editIface, cidr: e.target.value}})}
                                                                        placeholder="192.168.1.1/24"
                                                                        className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white text-sm" />
                                                                </div>
                                                                <div>
                                                                    <label className="block text-xs text-gray-400 mb-1">Gateway (IPv4)</label>
                                                                    <input type="text" value={data.editIface.gateway || ''} 
                                                                        onChange={(e) => setData({...data, editIface: {...data.editIface, gateway: e.target.value}})}
                                                                        placeholder="192.168.1.1"
                                                                        className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white text-sm" />
                                                                </div>
                                                                <div>
                                                                    <label className="block text-xs text-gray-400 mb-1">IPv6/CIDR</label>
                                                                    <input type="text" value={data.editIface.cidr6 || ''} 
                                                                        onChange={(e) => setData({...data, editIface: {...data.editIface, cidr6: e.target.value}})}
                                                                        className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white text-sm" />
                                                                </div>
                                                                <div>
                                                                    <label className="block text-xs text-gray-400 mb-1">Gateway (IPv6)</label>
                                                                    <input type="text" value={data.editIface.gateway6 || ''} 
                                                                        onChange={(e) => setData({...data, editIface: {...data.editIface, gateway6: e.target.value}})}
                                                                        className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white text-sm" />
                                                                </div>
                                                                <div>
                                                                    <label className="block text-xs text-gray-400 mb-1">MTU</label>
                                                                    <input type="number" value={data.editIface.mtu || ''} 
                                                                        onChange={(e) => setData({...data, editIface: {...data.editIface, mtu: e.target.value}})}
                                                                        placeholder="1500"
                                                                        className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white text-sm" />
                                                                </div>
                                                            </div>

                                                            {/* Bridge specific */}
                                                            {data.editIface.type === 'bridge' && (
                                                                <div className="grid grid-cols-2 gap-4">
                                                                    <div>
                                                                        <label className="block text-xs text-gray-400 mb-1">Bridge Ports</label>
                                                                        <input type="text" value={data.editIface.bridge_ports || ''} 
                                                                            onChange={(e) => setData({...data, editIface: {...data.editIface, bridge_ports: e.target.value}})}
                                                                            placeholder="ens18"
                                                                            className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white text-sm" />
                                                                    </div>
                                                                    <div className="flex items-center gap-4 pt-5">
                                                                        <label className="flex items-center gap-2 text-sm text-gray-300">
                                                                            <input type="checkbox" checked={data.editIface.bridge_vlan_aware || false} 
                                                                                onChange={(e) => setData({...data, editIface: {...data.editIface, bridge_vlan_aware: e.target.checked}})} />
                                                                            VLAN aware
                                                                        </label>
                                                                    </div>
                                                                </div>
                                                            )}

                                                            {/* Bond specific */}
                                                            {data.editIface.type === 'bond' && (
                                                                <div className="grid grid-cols-2 gap-4">
                                                                    <div>
                                                                        <label className="block text-xs text-gray-400 mb-1">Slaves</label>
                                                                        <input type="text" value={data.editIface.slaves || ''} 
                                                                            onChange={(e) => setData({...data, editIface: {...data.editIface, slaves: e.target.value}})}
                                                                            placeholder="ens18 ens19"
                                                                            className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white text-sm" />
                                                                    </div>
                                                                    <div>
                                                                        <label className="block text-xs text-gray-400 mb-1">Mode</label>
                                                                        <select value={data.editIface.bond_mode || 'balance-rr'} 
                                                                            onChange={(e) => setData({...data, editIface: {...data.editIface, bond_mode: e.target.value}})}
                                                                            className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white text-sm">
                                                                            <option value="balance-rr">balance-rr</option>
                                                                            <option value="active-backup">active-backup</option>
                                                                            <option value="balance-xor">balance-xor</option>
                                                                            <option value="broadcast">broadcast</option>
                                                                            <option value="802.3ad">LACP (802.3ad)</option>
                                                                            <option value="balance-tlb">balance-tlb</option>
                                                                            <option value="balance-alb">balance-alb</option>
                                                                        </select>
                                                                    </div>
                                                                    <div>
                                                                        <label className="block text-xs text-gray-400 mb-1">Hash Policy</label>
                                                                        <select value={data.editIface.bond_xmit_hash_policy || ''} 
                                                                            onChange={(e) => setData({...data, editIface: {...data.editIface, bond_xmit_hash_policy: e.target.value}})}
                                                                            className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white text-sm">
                                                                            <option value="">Default</option>
                                                                            <option value="layer2">layer2</option>
                                                                            <option value="layer2+3">layer2+3</option>
                                                                            <option value="layer3+4">layer3+4</option>
                                                                        </select>
                                                                    </div>
                                                                    <div>
                                                                        <label className="block text-xs text-gray-400 mb-1">Bond Primary</label>
                                                                        <input type="text" value={data.editIface['bond-primary'] || ''} 
                                                                            onChange={(e) => setData({...data, editIface: {...data.editIface, 'bond-primary': e.target.value}})}
                                                                            className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white text-sm" />
                                                                    </div>
                                                                </div>
                                                            )}

                                                            {/* VLAN specific */}
                                                            {data.editIface.type === 'vlan' && (
                                                                <div className="grid grid-cols-2 gap-4">
                                                                    <div>
                                                                        <label className="block text-xs text-gray-400 mb-1">VLAN raw device</label>
                                                                        <input type="text" value={data.editIface['vlan-raw-device'] || ''} 
                                                                            onChange={(e) => setData({...data, editIface: {...data.editIface, 'vlan-raw-device': e.target.value}})}
                                                                            placeholder="vmbr0"
                                                                            className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white text-sm" />
                                                                    </div>
                                                                    <div>
                                                                        <label className="block text-xs text-gray-400 mb-1">VLAN Tag</label>
                                                                        <input type="number" value={data.editIface['vlan-id'] || ''} 
                                                                            onChange={(e) => setData({...data, editIface: {...data.editIface, 'vlan-id': e.target.value}})}
                                                                            placeholder="100"
                                                                            className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white text-sm" />
                                                                    </div>
                                                                </div>
                                                            )}

                                                            <div className="grid grid-cols-2 gap-4">
                                                                <div className="flex items-center gap-2">
                                                                    <input type="checkbox" checked={data.editIface.autostart !== 0} 
                                                                        onChange={(e) => setData({...data, editIface: {...data.editIface, autostart: e.target.checked ? 1 : 0}})} />
                                                                    <span className="text-sm text-gray-300">Autostart</span>
                                                                </div>
                                                                <div>
                                                                    <label className="block text-xs text-gray-400 mb-1">Comment</label>
                                                                    <input type="text" value={data.editIface.comments || ''} 
                                                                        onChange={(e) => setData({...data, editIface: {...data.editIface, comments: e.target.value}})}
                                                                        className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white text-sm" />
                                                                </div>
                                                            </div>
                                                        </div>

                                                        <div className="flex justify-end gap-3 mt-6">
                                                            <button onClick={() => setData({...data, editIface: null})}
                                                                className="px-4 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-gray-300 hover:text-white">
                                                                Abbrechen
                                                            </button>
                                                            <button onClick={async () => {
                                                                const iface = data.editIface;
                                                                if (!iface.iface) { addToast('Name erforderlich', 'error'); return; }
                                                                try {
                                                                    const payload = { ...iface };
                                                                    delete payload.isNew;
                                                                    delete payload.active;
                                                                    delete payload.exists;
                                                                    delete payload.families;
                                                                    delete payload.method;
                                                                    delete payload.method6;
                                                                    delete payload.priority;
                                                                    
                                                                    const url = iface.isNew 
                                                                        ? `${API_URL}/clusters/${clusterId}/nodes/${node}/network`
                                                                        : `${API_URL}/clusters/${clusterId}/nodes/${node}/network/${iface.iface}`;
                                                                    const method = iface.isNew ? 'POST' : 'PUT';
                                                                    
                                                                    const res = await fetch(url, {
                                                                        method,
                                                                        headers: { 'Content-Type': 'application/json' },
                                                                        body: JSON.stringify(payload)
                                                                    });
                                                                    if (res.ok) {
                                                                        addToast(iface.isNew ? (t('interfaceCreated') || 'Interface created') : (t('interfaceUpdated') || 'Interface updated'));
                                                                        setData({...data, editIface: null});
                                                                        loadTabData('network');
                                                                    } else {
                                                                        const err = await res.json();
                                                                        addToast(err.error || t('error'), 'error');
                                                                    }
                                                                } catch (e) { addToast(t('error') || 'Error', 'error'); }
                                                            }} className="px-4 py-2 bg-proxmox-orange rounded-lg text-white hover:bg-orange-600">
                                                                {data.editIface.isNew ? 'Create' : 'Save'}
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    )}

                                    {activeTab === 'system' && (
                                        <div className="space-y-6">
                                            {/* DNS */}
                                            <div className="p-4 bg-proxmox-dark rounded-lg border border-proxmox-border">
                                                <div className="flex justify-between items-center mb-4">
                                                    <h4 className="font-medium text-white">DNS</h4>
                                                    <button onClick={() => handleSave('dns', data.dns, t('dnsSaved') || 'DNS saved')} className="px-3 py-1 bg-proxmox-orange rounded text-white text-sm hover:bg-orange-600">{t('save')}</button>
                                                </div>
                                                <div className="grid grid-cols-3 gap-4">
                                                    <div>
                                                        <label className="block text-xs text-gray-400 mb-1">{t('searchDomain') || 'Search Domain'}</label>
                                                        <input type="text" value={data.dns?.search||''} onChange={(e) => setData({...data, dns: {...data.dns, search: e.target.value}})}
                                                            className="w-full px-3 py-2 bg-proxmox-card border border-proxmox-border rounded-lg text-white text-sm" />
                                                    </div>
                                                    <div>
                                                        <label className="block text-xs text-gray-400 mb-1">{t('dnsServer') || 'DNS Server'} 1</label>
                                                        <input type="text" value={data.dns?.dns1||''} onChange={(e) => setData({...data, dns: {...data.dns, dns1: e.target.value}})}
                                                            className="w-full px-3 py-2 bg-proxmox-card border border-proxmox-border rounded-lg text-white text-sm" />
                                                    </div>
                                                    <div>
                                                        <label className="block text-xs text-gray-400 mb-1">{t('dnsServer') || 'DNS Server'} 2</label>
                                                        <input type="text" value={data.dns?.dns2||''} onChange={(e) => setData({...data, dns: {...data.dns, dns2: e.target.value}})}
                                                            className="w-full px-3 py-2 bg-proxmox-card border border-proxmox-border rounded-lg text-white text-sm" />
                                                    </div>
                                                </div>
                                            </div>

                                            {/* Time */}
                                            <div className="p-4 bg-proxmox-dark rounded-lg border border-proxmox-border">
                                                <h4 className="font-medium text-white mb-3">{t('time') || 'Time'}</h4>
                                                <div className="grid grid-cols-2 gap-4 text-sm">
                                                    <div><span className="text-gray-400">{t('timezone') || 'Timezone'}:</span><span className="ml-2 text-white">{data.time?.timezone || 'UTC'}</span></div>
                                                    <div><span className="text-gray-400">{t('localTime') || 'Local Time'}:</span><span className="ml-2 text-white font-mono">{data.time?.localtime ? new Date(data.time.localtime * 1000).toLocaleString() : 'N/A'}</span></div>
                                                </div>
                                            </div>

                                            {/* Hosts */}
                                            <div className="p-4 bg-proxmox-dark rounded-lg border border-proxmox-border">
                                                <div className="flex justify-between items-center mb-4">
                                                    <h4 className="font-medium text-white">/etc/hosts</h4>
                                                    <button onClick={() => handleSave('hosts', { data: data.hosts }, t('hostsSaved') || 'Hosts saved')} className="px-3 py-1 bg-proxmox-orange rounded text-white text-sm hover:bg-orange-600">{t('save')}</button>
                                                </div>
                                                <textarea value={data.hosts||''} onChange={(e) => setData({...data, hosts: e.target.value})} rows={5}
                                                    className="w-full px-3 py-2 bg-proxmox-card border border-proxmox-border rounded-lg text-white text-sm font-mono resize-none" />
                                            </div>

                                            {/* Certificates */}
                                            <div className="p-4 bg-proxmox-dark rounded-lg border border-proxmox-border">
                                                <div className="flex justify-between items-center mb-4">
                                                    <h4 className="font-medium text-white">{t('sslCertificates') || 'SSL Certificates'}</h4>
                                                    <button 
                                                        onClick={() => setData({...data, showCertUpload: !data.showCertUpload})}
                                                        className="px-3 py-1 bg-proxmox-card border border-proxmox-border rounded text-gray-300 text-sm hover:text-white hover:border-proxmox-orange"
                                                    >
                                                        {data.showCertUpload ? t('cancel') : (t('uploadCustomCert') || 'Upload Custom Certificate')}
                                                    </button>
                                                </div>
                                                
                                                {/* Current Certificates */}
                                                <div className="space-y-2 mb-4">
                                                    {(data.certificates||[]).length > 0 ? (data.certificates||[]).map((c, i) => (
                                                        <div key={i} className="flex justify-between items-center py-3 px-4 bg-proxmox-card rounded-lg">
                                                            <div>
                                                                <div className="text-white font-medium">{c.filename || 'Certificate'}</div>
                                                                <div className="text-xs text-gray-500">{c.subject || 'N/A'}</div>
                                                                <div className="text-xs text-gray-500">{t('issuer') || 'Issuer'}: {c.issuer || 'N/A'}</div>
                                                            </div>
                                                            <div className="text-right">
                                                                <div className={`text-sm ${c.notafter && c.notafter * 1000 > Date.now() ? 'text-green-400' : 'text-red-400'}`}>
                                                                    {c.notafter ? new Date(c.notafter * 1000).toLocaleDateString() : 'N/A'}
                                                                </div>
                                                                <div className="text-xs text-gray-500">
                                                                    {c.notafter ? (c.notafter * 1000 > Date.now() ? (t('valid') || 'Valid') : (t('expired') || 'Expired')) : ''}
                                                                </div>
                                                            </div>
                                                        </div>
                                                    )) : <div className="text-gray-500 text-sm">{t('noCertificates') || 'No certificates found'}</div>}
                                                </div>

                                                {/* Certificate Upload Form */}
                                                {data.showCertUpload && (
                                                    <div className="mt-4 p-4 bg-proxmox-card rounded-lg border border-proxmox-border space-y-4">
                                                        <div>
                                                            <label className="block text-xs text-gray-400 mb-2">{t('certificate') || 'Certificate'} (PEM {t('format') || 'Format'})</label>
                                                            <textarea 
                                                                value={data.newCert || ''} 
                                                                onChange={(e) => setData({...data, newCert: e.target.value})}
                                                                placeholder="-----BEGIN CERTIFICATE-----&#10;...&#10;-----END CERTIFICATE-----"
                                                                rows={6}
                                                                className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white text-sm font-mono resize-none"
                                                            />
                                                            <p className="text-xs text-gray-500 mt-1">{t('certChainHint') || 'Can contain multiple certificates (chain)'}</p>
                                                        </div>
                                                        <div>
                                                            <label className="block text-xs text-gray-400 mb-2">{t('privateKey') || 'Private Key'} (PEM {t('format') || 'Format'})</label>
                                                            <textarea 
                                                                value={data.newKey || ''} 
                                                                onChange={(e) => setData({...data, newKey: e.target.value})}
                                                                placeholder="-----BEGIN PRIVATE KEY-----&#10;...&#10;-----END PRIVATE KEY-----"
                                                                rows={6}
                                                                className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white text-sm font-mono resize-none"
                                                            />
                                                        </div>
                                                        <div className="flex items-center gap-4">
                                                            <label className="flex items-center gap-2 text-sm text-gray-300">
                                                                <input type="checkbox" checked={data.certRestart !== false} onChange={(e) => setData({...data, certRestart: e.target.checked})} className="rounded" />
                                                                {t('restartPveproxyAfterUpload') || 'Restart pveproxy after upload'}
                                                            </label>
                                                        </div>
                                                        <div className="flex gap-3">
                                                            <button
                                                                onClick={async () => {
                                                                    if (!data.newCert || !data.newKey) {
                                                                        addToast(t('certAndKeyRequired') || 'Certificate and key required', 'error');
                                                                        return;
                                                                    }
                                                                    try {
                                                                        const res = await fetch(`${API_URL}/clusters/${clusterId}/nodes/${node}/certificates/custom`, {
                                                                            method: 'POST',
                                                                            headers: { 'Content-Type': 'application/json' },
                                                                            body: JSON.stringify({
                                                                                certificates: data.newCert,
                                                                                key: data.newKey,
                                                                                restart: data.certRestart !== false,
                                                                                force: true
                                                                            })
                                                                        });
                                                                        if (res.ok) {
                                                                            addToast(t('certUploaded') || 'Certificate uploaded!');
                                                                            setData({...data, newCert: '', newKey: '', showCertUpload: false});
                                                                            loadTabData('system');
                                                                        } else {
                                                                            const err = await res.json();
                                                                            addToast(err.error || t('uploadFailed') || 'Upload failed', 'error');
                                                                        }
                                                                    } catch (e) {
                                                                        addToast(t('connectionError'), 'error');
                                                                    }
                                                                }}
                                                                className="flex items-center gap-2 px-4 py-2 bg-proxmox-orange rounded-lg text-white text-sm hover:bg-orange-600"
                                                            >
                                                                <Icons.Shield />
                                                                {t('uploadCertificate') || 'Upload Certificate'}
                                                            </button>
                                                            <button
                                                                onClick={async () => {
                                                                    if (!confirm(t('deleteCertConfirm') || 'Delete custom certificate and revert to self-signed?')) return;
                                                                    try {
                                                                        const res = await fetch(`${API_URL}/clusters/${clusterId}/nodes/${node}/certificates/custom?restart=true`, {
                                                                            method: 'DELETE'
                                                                        });
                                                                        if (res.ok) {
                                                                            addToast(t('certDeleted') || 'Certificate deleted');
                                                                            loadTabData('system');
                                                                        } else {
                                                                            const err = await res.json();
                                                                            addToast(err.error || t('deleteFailed'), 'error');
                                                                        }
                                                                    } catch (e) {
                                                                        addToast(t('connectionError'), 'error');
                                                                    }
                                                                }}
                                                                className="px-4 py-2 bg-red-500/20 border border-red-500/50 rounded-lg text-red-400 text-sm hover:bg-red-500/30"
                                                            >
                                                                {t('deleteCustomCert') || 'Delete Custom Cert'}
                                                            </button>
                                                        </div>
                                                    </div>
                                                )}
                                            </div>

                                            {/* Syslog */}
                                            <div className="p-4 bg-proxmox-dark rounded-lg border border-proxmox-border">
                                                <div className="flex justify-between items-center mb-3">
                                                    <h4 className="font-medium text-white">{t('syslogLatest') || 'Syslog (latest entries)'}</h4>
                                                    <button 
                                                        onClick={() => loadTabData('system')}
                                                        className="p-1.5 rounded hover:bg-proxmox-hover text-gray-400 hover:text-white"
                                                        title={t('refresh') || 'Refresh'}
                                                    >
                                                        <Icons.RefreshCw />
                                                    </button>
                                                </div>
                                                <div className="max-h-64 overflow-y-auto bg-black/50 rounded p-3">
                                                    {(data.syslog||[]).length > 0 ? (
                                                        <pre className="text-xs text-gray-300 font-mono whitespace-pre-wrap leading-relaxed">{(data.syslog||[]).join('\n')}</pre>
                                                    ) : (
                                                        <div className="text-gray-500 text-sm">{t('noLogEntries') || 'No log entries'}</div>
                                                    )}
                                                </div>
                                            </div>
                                        </div>
                                    )}

                                    {activeTab === 'disks' && (
                                        <div className="space-y-6">
                                            {/* Physical Disks with Actions */}
                                            <div className="bg-proxmox-card border border-proxmox-border rounded-xl overflow-hidden">
                                                <div className="p-4 border-b border-proxmox-border flex items-center justify-between">
                                                    <h3 className="font-medium text-white flex items-center gap-2">
                                                        <Icons.HardDrive />
                                                        Physical Disks
                                                    </h3>
                                                    <button 
                                                        onClick={() => loadTabData('disks')}
                                                        className="p-2 hover:bg-proxmox-hover rounded-lg text-gray-400 hover:text-white"
                                                    >
                                                        <Icons.RefreshCw />
                                                    </button>
                                                </div>
                                                <div className="overflow-x-auto">
                                                    <table className="w-full">
                                                        <thead className="bg-proxmox-dark">
                                                            <tr>
                                                                <th className="text-left p-3 text-sm text-gray-400">Device</th>
                                                                <th className="text-left p-3 text-sm text-gray-400">Model</th>
                                                                <th className="text-left p-3 text-sm text-gray-400">Size</th>
                                                                <th className="text-left p-3 text-sm text-gray-400">Type</th>
                                                                <th className="text-left p-3 text-sm text-gray-400">Usage</th>
                                                                <th className="text-left p-3 text-sm text-gray-400">Health</th>
                                                                <th className="text-left p-3 text-sm text-gray-400">Actions</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            {(data.disks||[]).length > 0 ? (data.disks||[]).map((d, idx) => (
                                                                <tr key={d.devpath || idx} className="border-t border-proxmox-border hover:bg-proxmox-dark/50">
                                                                    <td className="p-3">
                                                                        <span className="font-mono text-white">{d.devpath || 'Unknown'}</span>
                                                                        {d.serial && <div className="text-xs text-gray-500 font-mono">{d.serial}</div>}
                                                                    </td>
                                                                    <td className="p-3 text-gray-400 text-sm max-w-48 truncate">{d.model || 'Unknown'}</td>
                                                                    <td className="p-3 text-proxmox-orange font-medium">{formatBytes(d.size)}</td>
                                                                    <td className="p-3">
                                                                        <span className={`px-2 py-0.5 rounded text-xs ${
                                                                            d.type === 'ssd' ? 'bg-blue-500/20 text-blue-400' :
                                                                            d.type === 'nvme' ? 'bg-purple-500/20 text-purple-400' :
                                                                            'bg-gray-500/20 text-gray-400'
                                                                        }`}>
                                                                            {(d.type || 'hdd').toUpperCase()}
                                                                        </span>
                                                                    </td>
                                                                    <td className="p-3">
                                                                        {d.used === 'unused' || !d.used ? (
                                                                            <span className="text-green-400 text-sm">‚úì Unused</span>
                                                                        ) : (
                                                                            <span className="text-yellow-400 text-sm">{d.used}</span>
                                                                        )}
                                                                    </td>
                                                                    <td className="p-3">
                                                                        <span className={`px-2 py-0.5 rounded text-xs ${
                                                                            d.health === 'PASSED' ? 'bg-green-500/20 text-green-400' :
                                                                            d.health === 'FAILED' ? 'bg-red-500/20 text-red-400' :
                                                                            'bg-gray-500/20 text-gray-400'
                                                                        }`}>
                                                                            {d.health || 'N/A'}
                                                                        </span>
                                                                    </td>
                                                                    <td className="p-3">
                                                                        <div className="flex gap-1">
                                                                            <button 
                                                                                onClick={async () => {
                                                                                    try {
                                                                                        const diskPath = (d.devpath || '').replace('/dev/', '');
                                                                                        const res = await fetch(`${API_URL}/clusters/${clusterId}/nodes/${node}/disks/${encodeURIComponent(diskPath)}/smart`);
                                                                                        if (res.ok) {
                                                                                            const smart = await res.json();
                                                                                            alert(`SMART Data for ${d.devpath}:\n\n${JSON.stringify(smart, null, 2)}`);
                                                                                        } else {
                                                                                            alert('SMART data not available');
                                                                                        }
                                                                                    } catch(e) { alert('Error fetching SMART data'); }
                                                                                }}
                                                                                className="p-1.5 hover:bg-blue-500/20 rounded text-gray-400 hover:text-blue-400"
                                                                                title="SMART Data"
                                                                            >
                                                                                <Icons.Activity />
                                                                            </button>
                                                                            {(d.used === 'unused' || !d.used) && (
                                                                                <>
                                                                                    <button 
                                                                                        onClick={async () => {
                                                                                            if (!confirm(`Initialize ${d.devpath} with GPT partition table?\n\nThis will ERASE all data on the disk!`)) return;
                                                                                            try {
                                                                                                const res = await fetch(`${API_URL}/clusters/${clusterId}/nodes/${node}/disks/initgpt`, {
                                                                                                    method: 'POST',
                                                                                                    headers: { 'Content-Type': 'application/json' },
                                                                                                    body: JSON.stringify({ disk: d.devpath })
                                                                                                });
                                                                                                if (res.ok) {
                                                                                                    addToast('GPT partition table initialized', 'success');
                                                                                                    loadTabData('disks');
                                                                                                } else {
                                                                                                    const err = await res.json();
                                                                                                    addToast(err.error || 'Failed to initialize', 'error');
                                                                                                }
                                                                                            } catch(e) { addToast('Error initializing disk', 'error'); }
                                                                                        }}
                                                                                        className="p-1.5 hover:bg-green-500/20 rounded text-gray-400 hover:text-green-400"
                                                                                        title="Initialize GPT"
                                                                                    >
                                                                                        <Icons.Plus />
                                                                                    </button>
                                                                                    <button 
                                                                                        onClick={async () => {
                                                                                            if (!confirm(`‚ö†Ô∏è DANGER: Wipe disk ${d.devpath}?\n\nThis will DESTROY ALL DATA on the disk!`)) return;
                                                                                            if (!confirm(`Are you ABSOLUTELY SURE?\n\nThis action cannot be undone!`)) return;
                                                                                            try {
                                                                                                const res = await fetch(`${API_URL}/clusters/${clusterId}/nodes/${node}/disks/wipe`, {
                                                                                                    method: 'POST',
                                                                                                    headers: { 'Content-Type': 'application/json' },
                                                                                                    body: JSON.stringify({ disk: d.devpath })
                                                                                                });
                                                                                                if(res.ok) {
                                                                                                    addToast('Disk wiped successfully', 'success');
                                                                                                    loadTabData('disks');
                                                                                                } else {
                                                                                                    const err = await res.json();
                                                                                                    addToast(err.error || 'Failed to wipe', 'error');
                                                                                                }
                                                                                            } catch(e) { addToast('Error wiping disk', 'error'); }
                                                                                        }}
                                                                                        className="p-1.5 hover:bg-red-500/20 rounded text-gray-400 hover:text-red-400"
                                                                                        title="Wipe Disk"
                                                                                    >
                                                                                        <Icons.Trash />
                                                                                    </button>
                                                                                </>
                                                                            )}
                                                                        </div>
                                                                    </td>
                                                                </tr>
                                                            )) : (
                                                                <tr><td colSpan="7" className="p-8 text-center text-gray-500">No physical disks found</td></tr>
                                                            )}
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>

                                            {/* LVM Volume Groups */}
                                            <div className="bg-proxmox-card border border-proxmox-border rounded-xl overflow-hidden">
                                                <div className="p-4 border-b border-proxmox-border flex items-center justify-between">
                                                    <h3 className="font-medium text-white flex items-center gap-2">
                                                        <Icons.Database />
                                                        LVM Volume Groups
                                                    </h3>
                                                    <button 
                                                        onClick={() => openDiskModal('lvm')}
                                                        className="px-3 py-1.5 bg-proxmox-orange hover:bg-orange-600 rounded-lg text-sm"
                                                    >
                                                        <Icons.Plus className="inline mr-1" /> Create LVM
                                                    </button>
                                                </div>
                                                <div className="p-4">
                                                    {(data.lvm||[]).length > 0 ? (
                                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                                                            {data.lvm.map((v, idx) => (
                                                                <div key={v.vg || idx} className="p-4 bg-proxmox-dark rounded-lg border border-proxmox-border">
                                                                    <div className="flex justify-between items-center mb-2">
                                                                        <span className="font-medium text-white">{v.vg || 'Unknown'}</span>
                                                                        <span className="text-proxmox-orange font-medium">{formatBytes(v.size)}</span>
                                                                    </div>
                                                                    {v.free && v.size && (
                                                                        <>
                                                                            <div className="h-2 bg-proxmox-darker rounded-full overflow-hidden">
                                                                                <div 
                                                                                    className="h-full bg-proxmox-orange rounded-full"
                                                                                    style={{ width: `${Math.round((1 - v.free/v.size) * 100)}%` }}
                                                                                />
                                                                            </div>
                                                                            <div className="text-xs text-gray-500 mt-1">
                                                                                {formatBytes(v.free)} free
                                                                            </div>
                                                                        </>
                                                                    )}
                                                                </div>
                                                            ))}
                                                        </div>
                                                    ) : <div className="text-gray-500 text-sm text-center py-4">No LVM Volume Groups</div>}
                                                </div>
                                            </div>

                                            {/* LVM-Thin Pools */}
                                            <div className="bg-proxmox-card border border-proxmox-border rounded-xl overflow-hidden">
                                                <div className="p-4 border-b border-proxmox-border flex items-center justify-between">
                                                    <h3 className="font-medium text-white flex items-center gap-2">
                                                        <Icons.Database />
                                                        LVM-Thin Pools
                                                    </h3>
                                                    <button 
                                                        onClick={() => openDiskModal('lvmthin')}
                                                        className="px-3 py-1.5 bg-proxmox-orange hover:bg-orange-600 rounded-lg text-sm"
                                                    >
                                                        <Icons.Plus className="inline mr-1" /> Create LVM-Thin
                                                    </button>
                                                </div>
                                                <div className="p-4">
                                                    {(data.lvmthin||[]).length > 0 ? (
                                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                                                            {data.lvmthin.map((p, idx) => (
                                                                <div key={p.lv || idx} className="p-4 bg-proxmox-dark rounded-lg border border-proxmox-border">
                                                                    <div className="flex justify-between items-center mb-2">
                                                                        <span className="font-medium text-white">{p.lv || 'Unknown'}</span>
                                                                        <span className="text-proxmox-orange font-medium">{formatBytes(p.lv_size)}</span>
                                                                    </div>
                                                                    <div className="text-xs text-gray-500 mb-2">VG: {p.vg || '?'}</div>
                                                                    <div className="h-2 bg-proxmox-darker rounded-full overflow-hidden">
                                                                        <div 
                                                                            className={`h-full rounded-full ${(p.usage||0) > 80 ? 'bg-red-500' : (p.usage||0) > 60 ? 'bg-yellow-500' : 'bg-green-500'}`}
                                                                            style={{ width: `${p.usage || 0}%` }}
                                                                        />
                                                                    </div>
                                                                    <div className="text-xs text-gray-500 mt-1">{p.usage || 0}% used</div>
                                                                </div>
                                                            ))}
                                                        </div>
                                                    ) : <div className="text-gray-500 text-sm text-center py-4">No LVM-Thin Pools</div>}
                                                </div>
                                            </div>

                                            {/* ZFS Pools */}
                                            <div className="bg-proxmox-card border border-proxmox-border rounded-xl overflow-hidden">
                                                <div className="p-4 border-b border-proxmox-border flex items-center justify-between">
                                                    <h3 className="font-medium text-white flex items-center gap-2">
                                                        <Icons.Database />
                                                        ZFS Pools
                                                    </h3>
                                                    <div className="flex gap-2">
                                                        <button 
                                                            onClick={() => openDiskModal('directory')}
                                                            className="px-3 py-1.5 bg-proxmox-dark hover:bg-proxmox-hover border border-proxmox-border rounded-lg text-sm"
                                                        >
                                                            <Icons.Folder className="inline mr-1" /> Directory
                                                        </button>
                                                        <button 
                                                            onClick={() => openDiskModal('zfs')}
                                                            className="px-3 py-1.5 bg-proxmox-orange hover:bg-orange-600 rounded-lg text-sm"
                                                        >
                                                            <Icons.Plus className="inline mr-1" /> Create ZFS
                                                        </button>
                                                    </div>
                                                </div>
                                                <div className="p-4">
                                                    {(data.zfs||[]).length > 0 ? (
                                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                                                            {data.zfs.map((z, idx) => (
                                                                <div key={z.name || idx} className="p-4 bg-proxmox-dark rounded-lg border border-proxmox-border">
                                                                    <div className="flex justify-between items-center mb-2">
                                                                        <div className="flex items-center gap-2">
                                                                            <span className="font-medium text-white">{z.name || 'Unknown'}</span>
                                                                            <span className={`text-xs px-2 py-0.5 rounded ${
                                                                                z.health === 'ONLINE' ? 'bg-green-500/20 text-green-400' : 'bg-red-500/20 text-red-400'
                                                                            }`}>
                                                                                {z.health || 'N/A'}
                                                                            </span>
                                                                        </div>
                                                                        <span className="text-proxmox-orange font-medium">{formatBytes(z.size)}</span>
                                                                    </div>
                                                                    {z.alloc && z.size && (
                                                                        <>
                                                                            <div className="h-2 bg-proxmox-darker rounded-full overflow-hidden">
                                                                                <div 
                                                                                    className="h-full bg-blue-500 rounded-full"
                                                                                    style={{ width: `${Math.round((z.alloc/z.size) * 100)}%` }}
                                                                                />
                                                                            </div>
                                                                            <div className="text-xs text-gray-500 mt-1">
                                                                                {formatBytes(z.free || (z.size - z.alloc))} free
                                                                            </div>
                                                                        </>
                                                                    )}
                                                                </div>
                                                            ))}
                                                        </div>
                                                    ) : <div className="text-gray-500 text-sm text-center py-4">No ZFS Pools</div>}
                                                </div>
                                            </div>
                                        </div>
                                    )}

                                    {/* APT Repos tab */}
                                    {activeTab === 'repos' && (
                                        <div className="space-y-4">
                                            <div className="flex items-center justify-between">
                                                <h3 className="text-lg font-medium text-white flex items-center gap-2">
                                                    <Icons.Package className="w-5 h-5 text-proxmox-orange" />
                                                    APT {t('repositories') || 'Repositories'}
                                                </h3>
                                                <button
                                                    onClick={async () => {
                                                        try {
                                                            const r = await fetch(`${API_URL}/clusters/${clusterId}/nodes/${node}/repos/refresh`, {
                                                                method: 'POST',
                                                                headers: authHeaders
                                                            });
                                                            if (r.ok) {
                                                                addToast(t('packageListRefreshStarted') || 'Package list refresh started', 'success');
                                                            } else {
                                                                addToast(t('error') || 'Error', 'error');
                                                            }
                                                        } catch (e) {
                                                            addToast(t('error') || 'Error', 'error');
                                                        }
                                                    }}
                                                    className="px-3 py-1.5 bg-proxmox-orange/20 hover:bg-proxmox-orange/30 text-proxmox-orange rounded-lg text-sm flex items-center gap-2"
                                                >
                                                    <Icons.RefreshCw className="w-4 h-4" />
                                                    apt update
                                                </button>
                                            </div>

                                            {/* Info Box */}
                                            <div className="p-3 bg-blue-500/10 border border-blue-500/30 rounded-lg text-sm">
                                                <p className="text-gray-300">
                                                    {t('repoInfo') || 'Manage APT repositories for this node. Enable/disable repositories to control which packages are available.'}
                                                </p>
                                            </div>

                                            {/* Proxmox Source Format Notice */}
                                            <div className="p-3 bg-yellow-500/10 border border-yellow-500/30 rounded-lg text-sm">
                                                <p className="text-yellow-400 flex items-center gap-2">
                                                    <Icons.AlertTriangle className="w-4 h-4 flex-shrink-0" />
                                                    {t('repoProxmoxNotice') || "Note: Due to Proxmox's switch to a new source format, the display may currently be inaccurate. We're working on it."}
                                                </p>
                                            </div>

                                            {/* Repository List */}
                                            {loading ? (
                                                <div className="text-center py-8 text-gray-500">
                                                    <Icons.RotateCw className="w-6 h-6 animate-spin mx-auto mb-2" />
                                                    {t('loading')}...
                                                </div>
                                            ) : (data.repos || []).length > 0 ? (
                                                <div className="space-y-3">
                                                    {(data.repos || []).map(repo => (
                                                        <div 
                                                            key={repo.id}
                                                            className={`p-4 rounded-lg border transition-all ${
                                                                repo.enabled 
                                                                    ? 'bg-green-500/5 border-green-500/30' 
                                                                    : 'bg-proxmox-dark border-proxmox-border'
                                                            }`}
                                                        >
                                                            <div className="flex items-center justify-between">
                                                                <div className="flex items-center gap-3">
                                                                    <div className={`w-10 h-10 rounded-lg flex items-center justify-center ${
                                                                        repo.enabled ? 'bg-green-500/20' : 'bg-gray-500/20'
                                                                    }`}>
                                                                        {repo.requires_subscription ? (
                                                                            <Icons.Shield className={repo.enabled ? 'text-green-400' : 'text-gray-500'} />
                                                                        ) : (
                                                                            <Icons.Package className={repo.enabled ? 'text-green-400' : 'text-gray-500'} />
                                                                        )}
                                                                    </div>
                                                                    <div>
                                                                        <div className="flex items-center gap-2">
                                                                            <h4 className="font-medium text-white">{repo.name}</h4>
                                                                            {repo.is_other && (
                                                                                <span className="text-xs px-1.5 py-0.5 rounded bg-blue-500/20 text-blue-400">
                                                                                    {t('detected') || 'Detected'}
                                                                                </span>
                                                                            )}
                                                                        </div>
                                                                        <p className="text-xs text-gray-500">{repo.description}</p>
                                                                        {repo.requires_subscription && (
                                                                            <span className="inline-block mt-1 text-xs px-2 py-0.5 rounded bg-yellow-500/20 text-yellow-400">
                                                                                {t('requiresSubscription') || 'Requires Subscription'}
                                                                            </span>
                                                                        )}
                                                                        {repo.uri && (
                                                                            <p className="text-xs text-gray-600 mt-1 font-mono truncate max-w-xs">{repo.uri}</p>
                                                                        )}
                                                                    </div>
                                                                </div>
                                                                <div className="flex items-center gap-3">
                                                                    <span className={`text-xs px-2 py-1 rounded ${
                                                                        repo.enabled 
                                                                            ? 'bg-green-500/20 text-green-400' 
                                                                            : 'bg-gray-500/20 text-gray-400'
                                                                    }`}>
                                                                        {repo.enabled ? (t('enabled') || 'Enabled') : (t('disabled') || 'Disabled')}
                                                                    </span>
                                                                    {repo.exists && (
                                                                        <button
                                                                            onClick={async () => {
                                                                                try {
                                                                                    // For "other" repos, include file and index
                                                                                    const bodyData = { enabled: !repo.enabled };
                                                                                    if (repo.is_other) {
                                                                                        bodyData.file = repo.file;
                                                                                        bodyData.index = repo.index;
                                                                                        bodyData.name = repo.name;
                                                                                    }
                                                                                    const r = await fetch(`${API_URL}/clusters/${clusterId}/nodes/${node}/repos/${repo.id}`, {
                                                                                        method: 'PUT',
                                                                                        credentials: 'include',
                                                                                        headers: { 'Content-Type': 'application/json', ...authHeaders },
                                                                                        body: JSON.stringify(bodyData)
                                                                                    });
                                                                                    if (r.ok) {
                                                                                        addToast(`${repo.name} ${!repo.enabled ? 'enabled' : 'disabled'}`, 'success');
                                                                                        loadTabData('repos');
                                                                                    } else {
                                                                                        const err = await r.json();
                                                                                        addToast(err.error || t('error'), 'error');
                                                                                    }
                                                                                } catch (e) {
                                                                                    addToast(t('error') || 'Error', 'error');
                                                                                }
                                                                            }}
                                                                            className={`px-3 py-1.5 rounded-lg text-sm font-medium transition-colors ${
                                                                                repo.enabled
                                                                                    ? 'bg-red-500/20 hover:bg-red-500/30 text-red-400'
                                                                                    : 'bg-green-500/20 hover:bg-green-500/30 text-green-400'
                                                                            }`}
                                                                        >
                                                                            {repo.enabled ? (t('disable') || 'Disable') : (t('enable') || 'Enable')}
                                                                        </button>
                                                                    )}
                                                                    {!repo.exists && (
                                                                        <span className="text-xs text-gray-500">{t('notConfigured') || 'Not configured'}</span>
                                                                    )}
                                                                </div>
                                                            </div>
                                                            {repo.file && (
                                                                <div className="mt-2 text-xs text-gray-500 font-mono">
                                                                    {repo.file}
                                                                </div>
                                                            )}
                                                        </div>
                                                    ))}
                                                </div>
                                            ) : (
                                                <div className="text-center py-8 text-gray-500">
                                                    {t('noReposFound') || 'No repositories found'}
                                                </div>
                                            )}

                                            {/* Warning */}
                                            <div className="p-3 bg-yellow-500/10 border border-yellow-500/30 rounded-lg">
                                                <div className="flex items-start gap-2">
                                                    <Icons.AlertTriangle className="w-5 h-5 text-yellow-500 flex-shrink-0 mt-0.5" />
                                                    <div className="text-sm text-yellow-200">
                                                        <strong>{t('warning') || 'Warning'}:</strong> {t('repoWarning') || 'Mixing enterprise and no-subscription repositories is not recommended. After changing repositories, run "apt update" to refresh the package list.'}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    )}

                                    {activeTab === 'tasks' && (
                                        <div className="space-y-2">
                                            {(data.tasks||[]).length > 0 ? (data.tasks||[]).map((t, idx) => (
                                                <div key={t.upid || idx} className="p-3 bg-proxmox-dark rounded-lg border border-proxmox-border">
                                                    <div className="flex justify-between items-center">
                                                        <div>
                                                            <span className="text-white">{t.type || 'Unknown'}</span>
                                                            <span className={`ml-2 text-xs px-2 py-0.5 rounded ${t.status==='OK'?'text-green-400 bg-green-500/10':t.status?'text-red-400 bg-red-500/10':'text-yellow-400 bg-yellow-500/10'}`}>
                                                                {t.status || 'running'}
                                                            </span>
                                                        </div>
                                                        <span className="text-xs text-gray-500">{t.starttime ? new Date(t.starttime*1000).toLocaleString() : 'N/A'}</span>
                                                    </div>
                                                    <div className="text-xs text-gray-500 mt-1">{t.user || 'unknown'} - {t.id || 'N/A'}</div>
                                                </div>
                                            )) : <div className="text-center py-8 text-gray-500">Keine Tasks</div>}
                                        </div>
                                    )}

                                    {activeTab === 'subscription' && (
                                        <div className="space-y-6">
                                            <div className="p-6 bg-proxmox-dark rounded-lg border border-proxmox-border">
                                                <div className="flex items-center justify-between mb-4">
                                                    <h3 className="font-medium text-white">{t('subscriptionStatus')}</h3>
                                                    <span className={`px-3 py-1 rounded-full text-sm font-medium ${
                                                        data.subscription?.status === 'Active' || data.subscription?.status === 'active' 
                                                            ? 'bg-green-500/20 text-green-400' 
                                                            : 'bg-yellow-500/20 text-yellow-400'
                                                    }`}>
                                                        {data.subscription?.status === 'Active' || data.subscription?.status === 'active' ? t('licensed') : t('notLicensed')}
                                                    </span>
                                                </div>
                                                
                                                {(data.subscription?.status === 'Active' || data.subscription?.status === 'active') ? (
                                                    <div className="space-y-3 text-sm">
                                                        <div className="flex justify-between py-2 border-b border-proxmox-border">
                                                            <span className="text-gray-400">{t('product')}</span>
                                                            <span className="text-white">{data.subscription?.productname || 'Proxmox VE Subscription'}</span>
                                                        </div>
                                                        <div className="flex justify-between py-2 border-b border-proxmox-border">
                                                            <span className="text-gray-400">{t('licenseKey')}</span>
                                                            <span className="text-white font-mono">{data.subscription?.key || 'N/A'}</span>
                                                        </div>
                                                        <div className="flex justify-between py-2 border-b border-proxmox-border">
                                                            <span className="text-gray-400">Server ID</span>
                                                            <span className="text-white font-mono">{data.subscription?.serverid || 'N/A'}</span>
                                                        </div>
                                                        <div className="flex justify-between py-2 border-b border-proxmox-border">
                                                            <span className="text-gray-400">{t('validUntil')}</span>
                                                            <span className="text-white">{data.subscription?.nextduedate || 'N/A'}</span>
                                                        </div>
                                                        <div className="flex justify-between py-2">
                                                            <span className="text-gray-400">{t('supportLevel')}</span>
                                                            <span className="text-white">{data.subscription?.level || 'N/A'}</span>
                                                        </div>
                                                    </div>
                                                ) : (
                                                    <div className="space-y-4">
                                                        <div className="p-4 bg-yellow-500/10 border border-yellow-500/30 rounded-lg">
                                                            <div className="flex items-start gap-3">
                                                                <Icons.AlertTriangle />
                                                                <div>
                                                                    <div className="text-yellow-400 font-medium">{t('noActiveSubscription')}</div>
                                                                    <div className="text-sm text-gray-400 mt-1">
                                                                        {t('noSubscriptionDesc')}
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        
                                                        {data.subscription?.serverid && (
                                                            <div className="text-sm">
                                                                <span className="text-gray-400">Server ID: </span>
                                                                <span className="text-white font-mono">{data.subscription.serverid}</span>
                                                            </div>
                                                        )}
                                                    </div>
                                                )}
                                            </div>

                                            {/* License Key Input */}
                                            <div className="p-6 bg-proxmox-dark rounded-lg border border-proxmox-border">
                                                <h4 className="font-medium text-white mb-4">{t('enterLicenseKey')}</h4>
                                                <div className="space-y-4">
                                                    <div>
                                                        <label className="block text-xs text-gray-400 mb-2">{t('subscriptionKey')}</label>
                                                        <input 
                                                            type="text" 
                                                            value={data.newLicenseKey || ''} 
                                                            onChange={(e) => setData({...data, newLicenseKey: e.target.value})}
                                                            placeholder="pve1c-xxxxxxxxxx"
                                                            className="w-full px-4 py-3 bg-proxmox-card border border-proxmox-border rounded-lg text-white font-mono focus:outline-none focus:border-proxmox-orange"
                                                        />
                                                        <p className="text-xs text-gray-500 mt-2">
                                                            Format: pve1c-xxxxxxxxxx, pve2c-xxxxxxxxxx, pve4c-xxxxxxxxxx, etc.
                                                        </p>
                                                    </div>
                                                    <div className="flex gap-3">
                                                        <button
                                                            onClick={async () => {
                                                                if(!data.newLicenseKey) {
                                                                    addToast(t('pleaseEnterLicenseKey'), 'error');
                                                                    return;
                                                                }
                                                                try {
                                                                    const res = await fetch(`${API_URL}/clusters/${clusterId}/nodes/${node}/subscription`, {
                                                                        method: 'PUT',
                                                                        headers: { 'Content-Type': 'application/json' },
                                                                        body: JSON.stringify({ key: data.newLicenseKey })
                                                                    });
                                                                    if(res.ok) {
                                                                        addToast(t('licenseActivated'));
                                                                        setData({...data, newLicenseKey: ''});
                                                                        loadTabData('subscription');
                                                                    } else {
                                                                        const err = await res.json();
                                                                        addToast(err.error || t('activationFailed'), 'error');
                                                                    }
                                                                } catch (e) {
                                                                    addToast(t('connectionError'), 'error');
                                                                }
                                                            }}
                                                            disabled={!data.newLicenseKey}
                                                            className="flex items-center gap-2 px-4 py-2 bg-proxmox-orange rounded-lg text-white font-medium hover:bg-orange-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                                                        >
                                                            <Icons.Shield />
                                                            {t('activateLicense')}
                                                        </button>
                                                        <button
                                                            onClick={() => loadTabData('subscription')}
                                                            className="flex items-center gap-2 px-4 py-2 bg-proxmox-card border border-proxmox-border rounded-lg text-gray-300 hover:text-white transition-colors"
                                                        >
                                                            <Icons.RefreshCw />
                                                            {t('refreshStatus')}
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>

                                            {/* Info Box */}
                                            <div className="p-4 bg-blue-500/10 border border-blue-500/30 rounded-lg">
                                                <div className="flex items-start gap-3">
                                                    <Icons.Info />
                                                    <div className="text-sm text-gray-300">
                                                        <p className="mb-2">{t('subscriptionBenefits')}:</p>
                                                        <ul className="list-disc list-inside space-y-1 text-gray-400">
                                                            <li>{t('subscriptionBenefit1')}</li>
                                                            <li>{t('subscriptionBenefit2')}</li>
                                                            <li>{t('subscriptionBenefit3')}</li>
                                                        </ul>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                </>
                            )}
                        </div>
                    </div>

                    {/* Fullscreen Shell Modal */}
                    {data.shellFullscreen && (
                        <div className="fixed inset-0 z-[70] bg-black flex flex-col">
                            <div className="flex items-center justify-between px-4 py-2 bg-proxmox-dark border-b border-proxmox-border">
                                <div className="flex items-center gap-3">
                                    <Icons.Terminal />
                                    <span className="text-white font-medium">{node} - Shell</span>
                                </div>
                                <button
                                    onClick={() => setData({...data, shellFullscreen: false})}
                                    className="p-2 rounded-lg hover:bg-red-500/20 text-gray-400 hover:text-red-400"
                                >
                                    <Icons.X />
                                </button>
                            </div>
                            <div className="flex-1">
                                <NodeShellTerminal 
                                    node={node} 
                                    clusterId={clusterId} 
                                    addToast={addToast}
                                />
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // Console Modal Component with noVNC
        // NS: Getting noVNC to work in a React component was... interesting
        // The cleanup logic is important - otherwise you get zombie connections
        function ConsoleModal({ vm, consoleInfo, clusterId, onClose }) {
            const { t } = useTranslation();
            const canvasRef = useRef(null);
            const [isFullscreen, setIsFullscreen] = useState(false);
            const [connectionStatus, setConnectionStatus] = useState('connecting');
            const [vncPort, setVncPort] = useState(null);
            const [rfb, setRfb] = useState(null);
            const rfbRef = useRef(null);
            const containerRef = useRef(null);
            const { getAuthHeaders, sessionId } = useAuth();

            useEffect(() => {
                if(!consoleInfo || !canvasRef.current) return;

                let cancelled = false;
                
                const startVNC = async () => {
                    try {
                        setConnectionStatus('connecting');
                        console.log('VNC: Starting connection...');
                        
                        // Step 1: Get VNC ticket from backend
                        console.log('VNC: Getting ticket...');
                        const ticketResponse = await fetch(
                            `${API_URL}/clusters/${clusterId}/vms/${vm.node}/${vm.type}/${vm.vmid}/console`,
                            { headers: getAuthHeaders() }
                        );
                        
                        if(!ticketResponse.ok) {
                            console.error('VNC: Failed to get ticket');
                            setConnectionStatus('error');
                            return;
                        }
                        
                        const ticketData = await ticketResponse.json();
                        if(!ticketData.success) {
                            console.error('VNC: Ticket error:', ticketData.error);
                            setConnectionStatus('error');
                            return;
                        }
                        
                        const vncPassword = ticketData.ticket;
                        console.log('VNC: Got ticket');
                        
                        if(cancelled) return;
                        
                        // Build WebSocket URL - VNC runs on main port + 1
                        const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                        const mainPort = parseInt(window.location.port) || (window.location.protocol === 'https:' ? 443 : 80);
                        const vncPortNum = mainPort + 1;
                        setVncPort(vncPortNum);
                        const wsUrl = `${wsProtocol}//${window.location.hostname}:${vncPortNum}/api/clusters/${clusterId}/vms/${vm.node}/${vm.type}/${vm.vmid}/vncwebsocket?session=${encodeURIComponent(sessionId)}`;
                        
                        console.log('VNC WebSocket URL:', wsUrl);
                        
                        // Load noVNC - try local first (if downloaded), then CDN
                        if(!window.RFB) {
                            console.log('VNC: Loading noVNC...');
                            await new Promise((resolve, reject) => {
                                const script = document.createElement('script');
                                script.type = 'module';
                                // NS: local path works if --download-static was run
                                const localPath = '/static/js/novnc/rfb.min.js';
                                const cdnPath = 'https://cdn.jsdelivr.net/npm/@novnc/novnc@1.4.0/core/rfb.js';
                                script.textContent = `
                                    let RFB;
                                    try {
                                        // Try local bundled version first
                                        const resp = await fetch('${localPath}', {method: 'HEAD'});
                                        if (resp.ok) {
                                            RFB = (await import('${localPath}')).default;
                                            console.log('VNC: loaded from local');
                                        } else {
                                            throw new Error('local not found');
                                        }
                                    } catch(e) {
                                        // Fallback to CDN
                                        RFB = (await import('${cdnPath}')).default;
                                        console.log('VNC: loaded from CDN');
                                    }
                                    if (RFB) {
                                        window.RFB = RFB;
                                        window.dispatchEvent(new CustomEvent('novnc-loaded'));
                                    } else {
                                        window.dispatchEvent(new CustomEvent('novnc-failed'));
                                    }
                                `;
                                
                                const onLoaded = () => {
                                    window.removeEventListener('novnc-loaded', onLoaded);
                                    window.removeEventListener('novnc-failed', onFailed);
                                    console.log('VNC: noVNC ready');
                                    resolve();
                                };
                                const onFailed = () => {
                                    window.removeEventListener('novnc-loaded', onLoaded);
                                    window.removeEventListener('novnc-failed', onFailed);
                                    reject(new Error('Failed to load noVNC'));
                                };
                                
                                window.addEventListener('novnc-loaded', onLoaded);
                                window.addEventListener('novnc-failed', onFailed);
                                document.head.appendChild(script);
                                
                                setTimeout(() => {
                                    if(!window.RFB) {
                                        window.removeEventListener('novnc-loaded', onLoaded);
                                        window.removeEventListener('novnc-failed', onFailed);
                                        reject(new Error('noVNC load timeout'));
                                    }
                                }, 10000);
                            });
                        }
                        
                        if(cancelled || !window.RFB) {
                            setConnectionStatus('load_error');
                            return;
                        }
                        
                        console.log('VNC: Connecting to', wsUrl);
                        
                        // Create RFB with credentials
                        const rfbInstance = new window.RFB(canvasRef.current, wsUrl, {
                            credentials: { password: vncPassword }
                        });
                        rfbInstance.scaleViewport = true;
                        rfbInstance.resizeSession = true;

                        rfbInstance.addEventListener('connect', () => {
                            console.log('VNC: Connected!');
                            setConnectionStatus('connected');
                        });

                        rfbInstance.addEventListener('disconnect', (e) => {
                            console.log('VNC: Disconnected', e.detail);
                            setConnectionStatus(e.detail.clean ? 'disconnected' : 'error');
                        });

                        rfbInstance.addEventListener('securityfailure', (e) => {
                            console.error('VNC: Security failure', e);
                            setConnectionStatus('auth_failed');
                        });
                        
                        // handle credentials request
                        rfbInstance.addEventListener('credentialsrequired', () => {
                            console.log('VNC: Credentials required, sending...');
                            rfbInstance.sendCredentials({ password: vncPassword });
                        });

                        setRfb(rfbInstance);
                        rfbRef.current = rfbInstance;
                        
                    } catch (e) {
                        console.error('VNC: Error:', e);
                        if(!cancelled) {
                            setConnectionStatus('load_error');
                        }
                    }
                };
                
                startVNC();
                
                return () => {
                    cancelled = true;
                    if(rfbRef.current) {
                        try {
                            rfbRef.current.disconnect();
                        } catch (e) {}
                        rfbRef.current = null;
                    }
                };
            }, [consoleInfo, clusterId, vm]);

            const handleFullscreen = () => {
                if(!document.fullscreenElement) {
                    containerRef.current?.requestFullscreen();
                    setIsFullscreen(true);
                } else {
                    document.exitFullscreen();
                    setIsFullscreen(false);
                }
            };

            const handleCtrlAltDel = () => {
                if(rfb) {
                    rfb.sendCtrlAltDel();
                }
            };

            const openInProxmox = () => {
                const url = `https://${consoleInfo.host}:8006/?console=${vm.type}&novnc=1&vmid=${vm.vmid}&node=${vm.node}`;
                window.open(url, '_blank');
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop bg-black/80">
                    <div 
                        ref={containerRef}
                        className={`bg-proxmox-card border border-proxmox-border rounded-2xl shadow-2xl animate-scale-in overflow-hidden flex flex-col ${
                            isFullscreen ? 'w-full h-full rounded-none' : 'w-full max-w-5xl h-[80vh]'
                        }`}
                    >
                        {/* Header */}
                        <div className="flex items-center justify-between px-4 py-3 border-b border-proxmox-border bg-proxmox-dark">
                            <div className="flex items-center gap-3">
                                <Icons.Monitor />
                                <div>
                                    <h2 className="font-semibold text-white">{vm.name || `VM ${vm.vmid}`}</h2>
                                    <p className="text-xs text-gray-400">
                                        {vm.type.toUpperCase()} ¬∑ {vm.node} ¬∑ 
                                        <span className={`ml-1 ${
                                            connectionStatus === 'connected' ? 'text-green-400' :
                                            connectionStatus === 'connecting' ? 'text-yellow-400' :
                                            'text-red-400'
                                        }`}>
                                            {connectionStatus === 'connected' ? 'Connected' :
                                             connectionStatus === 'connecting' ? 'Connecting...' :
                                             'Error'}
                                        </span>
                                    </p>
                                </div>
                            </div>
                            <div className="flex items-center gap-2">
                                {vm.type === 'qemu' && connectionStatus === 'connected' && (
                                    <button
                                        onClick={handleCtrlAltDel}
                                        className="px-3 py-1.5 bg-proxmox-dark border border-proxmox-border rounded-lg text-xs text-gray-300 hover:text-white hover:border-proxmox-orange transition-colors"
                                    >
                                        Ctrl+Alt+Del
                                    </button>
                                )}
                                <button
                                    onClick={openInProxmox}
                                    className="px-3 py-1.5 bg-proxmox-dark border border-proxmox-border rounded-lg text-xs text-gray-300 hover:text-white hover:border-proxmox-orange transition-colors"
                                >
                                    External
                                </button>
                                <button
                                    onClick={handleFullscreen}
                                    className="p-2 rounded-lg hover:bg-proxmox-hover transition-colors"
                                >
                                    {isFullscreen ? <Icons.Minimize /> : <Icons.Maximize />}
                                </button>
                                <button
                                    onClick={onClose}
                                    className="p-2 rounded-lg hover:bg-red-500/20 text-gray-400 hover:text-red-400 transition-colors"
                                >
                                    <Icons.X />
                                </button>
                            </div>
                        </div>

                        {/* Console Area */}
                        <div className="flex-1 bg-black relative overflow-hidden">
                            {connectionStatus === 'connecting' && (
                                <div className="absolute inset-0 flex items-center justify-center bg-proxmox-darker">
                                    <div className="text-center">
                                        <div className="animate-spin w-8 h-8 border-2 border-proxmox-orange border-t-transparent rounded-full mx-auto mb-4"></div>
                                        <p className="text-gray-400">Connecting to console...</p>
                                    </div>
                                </div>
                            )}
                            {(connectionStatus === 'error' || connectionStatus === 'load_error' || connectionStatus === 'auth_failed') && (
                                <div className="absolute inset-0 flex items-center justify-center bg-proxmox-darker">
                                    <div className="text-center max-w-md p-6">
                                        <div className="text-red-400 text-xl mb-4">‚ö†Ô∏è {t('connectionError')}</div>
                                        
                                        {window.location.protocol === 'https:' && (
                                            <div className="text-gray-400 text-sm mb-4 p-4 bg-proxmox-dark rounded-lg text-left">
                                                <p className="mb-3 font-medium text-white">{t('certInstructions')}</p>
                                                <p className="mb-2">{t('certStep1')}</p>
                                                <a 
                                                    href={`https://${window.location.hostname}:${vncPort || ((parseInt(window.location.port) || 443) + 1)}/`}
                                                    target="_blank" 
                                                    rel="noopener noreferrer"
                                                    className="block text-proxmox-orange hover:underline mb-3 break-all"
                                                >
                                                    https://{window.location.hostname}:{vncPort || ((parseInt(window.location.port) || 443) + 1)}/
                                                </a>
                                                <p className="mb-2">{t('certStep2')}</p>
                                                <p className="text-xs text-gray-500">{t('certStep3')}</p>
                                            </div>
                                        )}
                                        
                                        <div className="flex gap-3 justify-center">
                                            <button
                                                onClick={() => {
                                                    const port = vncPort || ((parseInt(window.location.port) || 443) + 1);
                                                    window.open(`https://${window.location.hostname}:${port}/`, '_blank');
                                                }}
                                                className="px-4 py-2 bg-blue-600 rounded-lg text-white hover:bg-blue-700 transition-colors text-sm"
                                            >
                                                {t('acceptCert')}
                                            </button>
                                            <button
                                                onClick={openInProxmox}
                                                className="px-4 py-2 bg-proxmox-orange rounded-lg text-white hover:bg-orange-600 transition-colors text-sm"
                                            >
                                                {t('openInProxmox')}
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            )}
                            <div ref={canvasRef} className="w-full h-full" />
                        </div>
                    </div>
                </div>
            );
        }

        // Create VM/CT Modal Component
        // LW: This handles both QEMU VMs and LXC containers
        // The wizard steps are a bit complex but users seem to like it
        // ChatGPT helped with the step indicator UI - looks pretty clean
        // TODO: add template support for quick vm creation
        function CreateVmModal({ vmType, clusterId, nodes: initialNodes, onCreate, onClose }) {
            const { t } = useTranslation();
            const { getAuthHeaders } = useAuth();
            const [activeStep, setActiveStep] = useState(0);
            const [loading, setLoading] = useState(false);
            const [storageList, setStorageList] = useState([]);
            const [bridgeList, setBridgeList] = useState([]);
            const [isoList, setIsoList] = useState([]);
            const [templateList, setTemplateList] = useState([]);
            const [nextVmid, setNextVmid] = useState('');
            const [nodes, setNodes] = useState(initialNodes || []);
            // const [advancedMode, setAdvancedMode] = useState(false);  // someday
            
            const isQemu = vmType === 'qemu';
            
            // Local authFetch helper
            const authFetch = async (url, options = {}) => {
                try {
                    const response = await fetch(url, {
                        ...options,
                        credentials: 'include',
                        headers: {
                            ...options.headers,
                            ...getAuthHeaders()
                        }
                    });
                    return response;
                } catch (err) {
                    console.error('Auth fetch error:', err);
                    return null;
                }
            };
            
            // Fetch nodes if not provided
            useEffect(() => {
                const fetchNodes = async () => {
                    if(nodes.length === 0) {
                        try {
                            const response = await authFetch(`${API_URL}/clusters/${clusterId}/nodes`);
                            if(response && response.ok) {
                                const data = await response.json();
                                const nodeNames = data.map(n => n.node || n.name).filter(Boolean);
                                setNodes(nodeNames);
                                if(nodeNames.length > 0) {
                                    setConfig(prev => ({...prev, node: nodeNames[0]}));
                                }
                            }
                        } catch (e) {
                            console.error('fetching nodes:', e);
                        }
                    }
                };
                fetchNodes();
            }, [clusterId]);
            
            const [config, setConfig] = useState({
                // General
                node: nodes[0] || '',
                vmid: '',
                name: '',
                
                // OS (QEMU)
                ostype: 'l26',
                iso: '',
                virtio_iso: '', // VirtIO drivers ISO for Windows
                
                // Template (LXC)
                template: '',
                password: '',
                
                // Hardware
                cores: 2,
                sockets: 1,
                memory: 2048,
                memoryUnit: 'GB',  // LW: easier to work with GB by default
                
                // MK: Advanced CPU (QEMU)
                cpu_affinity: '',      // CPU affinity string e.g. "0-3" or "0,2,4"
                numa: false,           // Enable NUMA
                
                // MK: Advanced Memory (QEMU)
                min_memory: '',        // Minimum memory for ballooning (MB)
                min_memoryUnit: 'MB',  // MK: Unit for minimum memory
                ballooning: true,      // Ballooning device enabled
                shares: 1000,          // Memory shares (0-50000)
                
                // Disk
                storage: 'local-lvm',
                disk_size: isQemu ? '32' : '8',
                disk_type: 'scsi',  // scsi, virtio, ide, sata
                disk_format: '',    // raw, qcow2, vmdk (empty = storage default)
                disk_cache: '',     // none, directsync, writethrough, writeback, unsafe
                disk_discard: true,
                disk_iothread: true,
                disk_ssd: false,
                additional_disks: [], // MK: Array of additional disks {storage, size, type, format}
                
                // Network
                net_bridge: 'vmbr0',
                net_model: 'virtio',
                net_firewall: true,
                net_tag: '',
                net_ip: 'dhcp',
                net_gw: '',
                // MK: Advanced Network
                net_macaddr: '',       // Custom MAC address
                net_disconnect: false, // Disconnect network
                net_mtu: '',           // MTU (1-65520)
                net_rate: '',          // Rate limit in MB/s
                
                // Advanced (QEMU)
                cpu: 'host',
                bios: 'seabios',
                machine: 'i440fx',
                scsihw: 'virtio-scsi-pci',
                vga: 'std',
                agent: true,
                efi_storage: '',     // Storage for EFI disk
                efi_pre_enroll: true, // Pre-enroll Microsoft keys
                tpm_storage: '',     // Storage for TPM state
                tpm_version: 'v2.0', // TPM version
                ha_enabled: false,   // MK: Enable Proxmox native HA
                ha_group: '',        // MK: HA group name
                
                // Advanced (LXC)
                unprivileged: true,
                nesting: false,
                swap: 512,
                swapUnit: 'MB',  // NS: unit selector for swap
                ssh_public_keys: '',
                
                // Network (extended for LXC)
                net_ip_type: 'dhcp',      // dhcp, static, manual
                net_ip6_type: 'dhcp',     // dhcp, static, slaac, manual
                net_ip6: '',
                net_gw6: '',
                net_disconnected: false,
                
                // DNS
                dns_domain: '',
                dns_servers: '',
                
                // Options
                onboot: false,
                start: false,
            });

            useEffect(() => {
                // Set default node if available
                if(nodes.length > 0 && !config.node) {
                    setConfig(prev => ({...prev, node: nodes[0]}));
                }
            }, [nodes]);
            
            useEffect(() => {
                if(config.node) {
                    fetchStorageList();
                    fetchBridgeList();
                    if(isQemu) fetchIsoList();
                    else fetchTemplateList();
                    fetchNextVmid();
                }
            }, [config.node]);

            const fetchStorageList = async () => {
                try {
                    const response = await authFetch(`${API_URL}/clusters/${clusterId}/nodes/${config.node}/storage`);
                    if(response && response.ok) {
                        const data = await response.json();
                        setStorageList(data);
                        // Set default storage if current is not in list
                        if(data.length > 0 && !data.find(s => s.storage === config.storage)) {
                            const defaultStorage = data.find(s => s.storage === 'local-lvm') || data[0];
                            setConfig(prev => ({...prev, storage: defaultStorage.storage}));
                        }
                    }
                } catch (e) { console.error(e); }
            };

            const fetchBridgeList = async () => {
                try {
                    const response = await authFetch(`${API_URL}/clusters/${clusterId}/nodes/${config.node}/networks`);
                    if(response && response.ok) {
                        const data = await response.json();
                        setBridgeList(data);
                        // Set default bridge
                        if(data.length > 0 && !data.find(b => b.iface === config.net_bridge)) {
                            const defaultBridge = data.find(b => b.iface === 'vmbr0') || data.find(b => b.type === 'bridge') || data[0];
                            if(defaultBridge) setConfig(prev => ({...prev, net_bridge: defaultBridge.iface}));
                        }
                    }
                } catch (e) { console.error(e); }
            };

            const fetchIsoList = async () => {
                try {
                    const response = await authFetch(`${API_URL}/clusters/${clusterId}/nodes/${config.node}/isos`);
                    if(response && response.ok) {
                        const data = await response.json();
                        setIsoList(data);
                        console.log('Loaded ISOs:', data);
                    }
                } catch (e) { console.error('loading ISOs:', e); }
            };

            const fetchTemplateList = async () => {
                try {
                    const response = await authFetch(`${API_URL}/clusters/${clusterId}/nodes/${config.node}/templates`);
                    if(response && response.ok) setTemplateList(await response.json());
                } catch (e) { console.error(e); }
            };

            const fetchNextVmid = async () => {
                try {
                    const response = await authFetch(`${API_URL}/clusters/${clusterId}/nodes/${config.node}/nextid`);
                    if(response && response.ok) {
                        const data = await response.json();
                        setNextVmid(data.vmid);
                        if(!config.vmid) setConfig(prev => ({...prev, vmid: data.vmid}));
                    }
                } catch (e) { console.error(e); }
            };

            const handleCreate = async () => {
                setLoading(true);
                await onCreate(vmType, config.node, config);
                setLoading(false);
            };

            const steps = isQemu 
                ? [t('general'), t('os'), t('hardware'), t('disk'), t('network'), t('advanced')]
                : [t('general'), t('template'), t('resources'), t('disk'), t('network'), t('options')];

            const osTypes = [
                { value: 'l26', label: 'Linux 2.6+ Kernel' },
                { value: 'l24', label: 'Linux 2.4 Kernel' },
                { value: 'win11', label: 'Windows 11/2022' },
                { value: 'win10', label: 'Windows 10/2016/2019' },
                { value: 'win8', label: 'Windows 8/2012' },
                { value: 'win7', label: 'Windows 7/2008' },
                { value: 'wxp', label: 'Windows XP/2003' },
                { value: 'other', label: 'Other' },
            ];

            const cpuTypes = [
                'host', 'kvm64', 'kvm32', 'qemu64', 'qemu32', 'max',
                'Broadwell', 'Broadwell-IBRS', 'Broadwell-noTSX', 'Broadwell-noTSX-IBRS',
                'Cascadelake-Server', 'Cascadelake-Server-noTSX', 'Conroe', 'EPYC', 'EPYC-IBPB',
                'EPYC-Milan', 'EPYC-Rome', 'Haswell', 'Haswell-IBRS', 'Haswell-noTSX',
                'Haswell-noTSX-IBRS', 'Icelake-Client', 'Icelake-Client-noTSX', 'Icelake-Server',
                'Icelake-Server-noTSX', 'IvyBridge', 'IvyBridge-IBRS', 'KnightsMill', 'Nehalem',
                'Nehalem-IBRS', 'Opteron_G1', 'Opteron_G2', 'Opteron_G3', 'Opteron_G4', 'Opteron_G5',
                'Penryn', 'SandyBridge', 'SandyBridge-IBRS', 'Skylake-Client', 'Skylake-Client-IBRS',
                'Skylake-Client-noTSX-IBRS', 'Skylake-Server', 'Skylake-Server-IBRS',
                'Skylake-Server-noTSX-IBRS', 'Westmere', 'Westmere-IBRS', 'athlon', 'core2duo',
                'coreduo', 'n270', 'pentium', 'pentium2', 'pentium3', 'phenom', 'x86-64-v2',
                'x86-64-v2-AES', 'x86-64-v3', 'x86-64-v4'
            ];

            const vgaTypes = [
                { value: 'std', label: 'Standard VGA' },
                { value: 'vmware', label: 'VMware compatible' },
                { value: 'qxl', label: 'SPICE (QXL)' },
                { value: 'qxl2', label: 'SPICE (QXL) 2 heads' },
                { value: 'qxl3', label: 'SPICE (QXL) 3 heads' },
                { value: 'qxl4', label: 'SPICE (QXL) 4 heads' },
                { value: 'virtio', label: 'VirtIO-GPU' },
                { value: 'virtio-gl', label: 'VirtIO-GPU (virgl)' },
                { value: 'cirrus', label: 'Cirrus Logic' },
                { value: 'none', label: 'None (headless)' },
            ];

            const scsiControllers = [
                { value: 'virtio-scsi-pci', label: 'VirtIO SCSI' },
                { value: 'virtio-scsi-single', label: 'VirtIO SCSI Single' },
                { value: 'lsi', label: 'LSI 53C895A' },
                { value: 'lsi53c810', label: 'LSI 53C810' },
                { value: 'megasas', label: 'MegaRAID SAS' },
                { value: 'pvscsi', label: 'VMware PVSCSI' },
            ];

            const renderStepContent = () => {
                // Filter storages by content type
                const diskStorages = storageList.filter(s => {
                    const content = s.content || '';
                    return content.includes('images') || content.includes('rootdir') || s.type === 'lvmthin' || s.type === 'lvm' || s.type === 'zfspool' || s.type === 'rbd' || s.type === 'dir';
                });
                const isoStorages = storageList.filter(s => (s.content || '').includes('iso'));
                const templateStorages = storageList.filter(s => (s.content || '').includes('vztmpl'));
                
                if(isQemu) {
                    switch(activeStep) {
                        case 0: // General
                            return (
                                <div className="space-y-4">
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="block text-sm text-gray-400 mb-1">{t('node')}</label>
                                            <select value={config.node} onChange={e => setConfig({...config, node: e.target.value})}
                                                className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white">
                                                {nodes.map(n => <option key={n} value={n}>{n}</option>)}
                                            </select>
                                        </div>
                                        <div>
                                            <label className="block text-sm text-gray-400 mb-1">VM ID</label>
                                            <input type="number" value={config.vmid} onChange={e => setConfig({...config, vmid: e.target.value})}
                                                placeholder={nextVmid ? `${t('next')}: ${nextVmid}` : ''}
                                                className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white" />
                                        </div>
                                    </div>
                                    <div>
                                        <label className="block text-sm text-gray-400 mb-1">{t('name')}</label>
                                        <input type="text" value={config.name} onChange={e => setConfig({...config, name: e.target.value})}
                                            placeholder="my-virtual-machine"
                                            className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white" />
                                    </div>
                                </div>
                            );
                        case 1: // OS
                            return (
                                <div className="space-y-4">
                                    <div>
                                        <label className="block text-sm text-gray-400 mb-1">{t('guestOs')}</label>
                                        <select value={config.ostype} onChange={e => setConfig({...config, ostype: e.target.value})}
                                            className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white">
                                            {osTypes.map(os => <option key={os.value} value={os.value}>{os.label}</option>)}
                                        </select>
                                    </div>
                                    <div>
                                        <label className="block text-sm text-gray-400 mb-1">{t('isoImage')}</label>
                                        <select value={config.iso} onChange={e => setConfig({...config, iso: e.target.value})}
                                            className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white">
                                            <option value="">{t('noIso')}</option>
                                            {isoList.length === 0 && <option disabled>{t('noIsoAvailable')}</option>}
                                            {isoList.map(iso => <option key={iso.volid} value={iso.volid}>{iso.volid.split('/').pop()}</option>)}
                                        </select>
                                        {isoStorages.length === 0 && (
                                            <p className="text-xs text-yellow-500 mt-1">‚ö†Ô∏è {t('noIsoStorage')}</p>
                                        )}
                                    </div>
                                    {config.ostype.startsWith('win') && (
                                        <div>
                                            <label className="block text-sm text-gray-400 mb-1">{t('virtioDrivers')}</label>
                                            <select value={config.virtio_iso} onChange={e => setConfig({...config, virtio_iso: e.target.value})}
                                                className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white">
                                                <option value="">{t('noVirtioDrivers')}</option>
                                                {isoList.filter(iso => iso.volid.toLowerCase().includes('virtio')).map(iso => (
                                                    <option key={iso.volid} value={iso.volid}>{iso.volid.split('/').pop()}</option>
                                                ))}
                                                <optgroup label={t('allIsos')}>
                                                    {isoList.map(iso => <option key={iso.volid} value={iso.volid}>{iso.volid.split('/').pop()}</option>)}
                                                </optgroup>
                                            </select>
                                            <p className="text-xs text-gray-500 mt-1">{t('virtioDriversHint')}</p>
                                        </div>
                                    )}
                                </div>
                            );
                        case 2: // Hardware
                            return (
                                <div className="space-y-4">
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="block text-sm text-gray-400 mb-1">{t('sockets')}</label>
                                            <input type="number" min="1" max="4" value={config.sockets} onChange={e => setConfig({...config, sockets: parseInt(e.target.value)})}
                                                className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white" />
                                        </div>
                                        <div>
                                            <label className="block text-sm text-gray-400 mb-1">{t('cores')}</label>
                                            <input type="number" min="1" max="128" value={config.cores} onChange={e => setConfig({...config, cores: parseInt(e.target.value)})}
                                                className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white" />
                                        </div>
                                    </div>
                                    <div>
                                        <label className="block text-sm text-gray-400 mb-1">{t('memory')}</label>
                                        <div className="flex gap-2">
                                            <input type="number" min={config.memoryUnit === 'GB' ? 0.5 : 128} step={config.memoryUnit === 'GB' ? 0.5 : 128} 
                                                value={config.memoryUnit === 'GB' ? (config.memory / 1024) : config.memory} 
                                                onChange={e => {
                                                    const val = parseFloat(e.target.value) || 0;
                                                    setConfig({...config, memory: config.memoryUnit === 'GB' ? Math.round(val * 1024) : val});
                                                }}
                                                className="flex-1 px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white" />
                                            <select value={config.memoryUnit || 'MB'} onChange={e => setConfig({...config, memoryUnit: e.target.value})}
                                                className="w-20 px-2 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white">
                                                <option value="MB">MB</option>
                                                <option value="GB">GB</option>
                                            </select>
                                        </div>
                                        <p className="text-xs text-gray-500 mt-1">
                                            {config.memoryUnit === 'GB' ? `${config.memory} MB` : `${(config.memory / 1024).toFixed(1)} GB`}
                                        </p>
                                    </div>
                                    
                                    {/* MK: Advanced CPU Section */}
                                    <details className="group">
                                        <summary className="flex items-center justify-between cursor-pointer p-3 bg-blue-500/10 border border-blue-500/30 rounded-lg hover:bg-blue-500/20">
                                            <span className="text-sm font-medium text-blue-400">{t('advancedCpu') || 'Advanced CPU'}</span>
                                            <Icons.ChevronDown className="w-4 h-4 text-blue-400 group-open:rotate-180 transition-transform" />
                                        </summary>
                                        <div className="mt-3 space-y-3 p-3 bg-proxmox-dark/50 rounded-lg">
                                            <div>
                                                <label className="block text-sm text-gray-400 mb-1">{t('cpuAffinity') || 'CPU Affinity'}</label>
                                                <input type="text" value={config.cpu_affinity} onChange={e => setConfig({...config, cpu_affinity: e.target.value})}
                                                    placeholder="e.g. 0-3 or 0,2,4,6"
                                                    className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white" />
                                                <p className="text-xs text-gray-500 mt-1">{t('cpuAffinityHint') || 'Pin vCPUs to specific host CPUs'}</p>
                                            </div>
                                            <label className="flex items-center gap-2 text-sm text-gray-300">
                                                <input type="checkbox" checked={config.numa} onChange={e => setConfig({...config, numa: e.target.checked})} className="rounded" />
                                                {t('enableNuma') || 'Enable NUMA'}
                                            </label>
                                        </div>
                                    </details>
                                    
                                    {/* MK: Advanced Memory Section */}
                                    <details className="group">
                                        <summary className="flex items-center justify-between cursor-pointer p-3 bg-purple-500/10 border border-purple-500/30 rounded-lg hover:bg-purple-500/20">
                                            <span className="text-sm font-medium text-purple-400">{t('advancedMemory') || 'Advanced Memory'}</span>
                                            <Icons.ChevronDown className="w-4 h-4 text-purple-400 group-open:rotate-180 transition-transform" />
                                        </summary>
                                        <div className="mt-3 space-y-3 p-3 bg-proxmox-dark/50 rounded-lg">
                                            <div>
                                                <label className="block text-sm text-gray-400 mb-1">{t('minimumMemory') || 'Minimum Memory'}</label>
                                                <div className="flex gap-2">
                                                    <input type="number" min="0" 
                                                        value={config.min_memoryUnit === 'GB' ? (config.min_memory ? config.min_memory / 1024 : '') : (config.min_memory || '')}
                                                        onChange={e => {
                                                            const val = parseFloat(e.target.value) || '';
                                                            if (val === '') {
                                                                setConfig({...config, min_memory: ''});
                                                            } else {
                                                                setConfig({...config, min_memory: config.min_memoryUnit === 'GB' ? Math.round(val * 1024) : val});
                                                            }
                                                        }}
                                                        placeholder={t('sameAsMemory') || 'Same as Memory'}
                                                        className="flex-1 px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white" />
                                                    <select value={config.min_memoryUnit || 'MB'} onChange={e => setConfig({...config, min_memoryUnit: e.target.value})}
                                                        className="w-20 px-2 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white">
                                                        <option value="MB">MB</option>
                                                        <option value="GB">GB</option>
                                                    </select>
                                                </div>
                                                <p className="text-xs text-gray-500 mt-1">{t('minimumMemoryHint') || 'Lower limit for memory ballooning'}</p>
                                            </div>
                                            <div className="grid grid-cols-2 gap-4">
                                                <label className="flex items-center gap-2 text-sm text-gray-300">
                                                    <input type="checkbox" checked={config.ballooning} onChange={e => setConfig({...config, ballooning: e.target.checked})} className="rounded" />
                                                    {t('ballooningDevice') || 'Ballooning Device'}
                                                </label>
                                            </div>
                                            <div>
                                                <label className="block text-sm text-gray-400 mb-1">{t('memoryShares') || 'Memory Shares'}</label>
                                                <input type="number" min="0" max="50000" value={config.shares} onChange={e => setConfig({...config, shares: parseInt(e.target.value) || 0})}
                                                    className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white" />
                                                <p className="text-xs text-gray-500 mt-1">{t('memorySharesHint') || 'Weight for memory auto-ballooning (0-50000, default: 1000)'}</p>
                                            </div>
                                        </div>
                                    </details>
                                </div>
                            );
                        case 3: // Disk
                            // MK: Helper to render storage bar
                            const renderStorageBar = (selectedStorage) => {
                                const storageInfo = diskStorages.find(s => s.storage === selectedStorage);
                                if (!storageInfo) return null;
                                const total = storageInfo.total || storageInfo.maxdisk || storageInfo.avail || 0;
                                const avail = storageInfo.avail || 0;
                                if (total <= 0) return null;
                                const usedPercent = total > 0 ? ((total - avail) / total) * 100 : 0;
                                const freeGB = (avail / 1024 / 1024 / 1024).toFixed(1);
                                return (
                                    <div className="mt-2">
                                        <div className="flex justify-between text-xs text-gray-500 mb-1">
                                            <span>{freeGB} GB {t('free')}</span>
                                            <span>{usedPercent.toFixed(0)}% {t('used')}</span>
                                        </div>
                                        <div className="h-1.5 bg-proxmox-dark rounded-full overflow-hidden">
                                            <div className={`h-full ${usedPercent > 90 ? 'bg-red-500' : usedPercent > 70 ? 'bg-yellow-500' : 'bg-green-500'}`}
                                                style={{ width: `${usedPercent}%` }} />
                                        </div>
                                    </div>
                                );
                            };
                            
                            return (
                                <div className="space-y-4">
                                    {/* MK: Primary Disk with ALL options */}
                                    <div className="p-4 bg-proxmox-dark/50 rounded-lg border border-proxmox-border">
                                        <h4 className="text-sm font-medium text-white mb-3">{t('primaryDisk') || 'Disk'} 0 ({config.disk_type}0)</h4>
                                        <div className="grid grid-cols-4 gap-3 mb-3">
                                            <div>
                                                <label className="block text-xs text-gray-400 mb-1">{t('busType')}</label>
                                                <select value={config.disk_type} onChange={e => setConfig({...config, disk_type: e.target.value})}
                                                    className="w-full px-2 py-1.5 bg-proxmox-dark border border-proxmox-border rounded text-white text-sm">
                                                    <option value="scsi">SCSI</option>
                                                    <option value="virtio">VirtIO Block</option>
                                                    <option value="ide">IDE</option>
                                                    <option value="sata">SATA</option>
                                                </select>
                                            </div>
                                            <div className="col-span-2">
                                                <label className="block text-xs text-gray-400 mb-1">{t('storage')}</label>
                                                <select value={config.storage} onChange={e => setConfig({...config, storage: e.target.value})}
                                                    className="w-full px-2 py-1.5 bg-proxmox-dark border border-proxmox-border rounded text-white text-sm">
                                                    {diskStorages.map(s => (
                                                        <option key={s.storage} value={s.storage}>
                                                            {s.storage} ({s.type})
                                                        </option>
                                                    ))}
                                                </select>
                                                {renderStorageBar(config.storage)}
                                            </div>
                                            <div>
                                                <label className="block text-xs text-gray-400 mb-1">{t('size')} (GB)</label>
                                                <input type="number" min="1" value={config.disk_size} onChange={e => setConfig({...config, disk_size: e.target.value})}
                                                    className="w-full px-2 py-1.5 bg-proxmox-dark border border-proxmox-border rounded text-white text-sm" />
                                            </div>
                                        </div>
                                        <div className="grid grid-cols-4 gap-3 mb-3">
                                            <div>
                                                <label className="block text-xs text-gray-400 mb-1">{t('format')}</label>
                                                <select value={config.disk_format} onChange={e => setConfig({...config, disk_format: e.target.value})}
                                                    className="w-full px-2 py-1.5 bg-proxmox-dark border border-proxmox-border rounded text-white text-sm">
                                                    <option value="">{t('storageDefault') || 'Default'}</option>
                                                    <option value="raw">Raw</option>
                                                    <option value="qcow2">QCOW2</option>
                                                    <option value="vmdk">VMDK</option>
                                                </select>
                                            </div>
                                            <div>
                                                <label className="block text-xs text-gray-400 mb-1">{t('cache')}</label>
                                                <select value={config.disk_cache} onChange={e => setConfig({...config, disk_cache: e.target.value})}
                                                    className="w-full px-2 py-1.5 bg-proxmox-dark border border-proxmox-border rounded text-white text-sm">
                                                    <option value="">{t('default') || 'Default'}</option>
                                                    <option value="directsync">Direct Sync</option>
                                                    <option value="writethrough">Write Through</option>
                                                    <option value="writeback">Write Back</option>
                                                    <option value="none">{t('none') || 'None'}</option>
                                                </select>
                                            </div>
                                            {config.disk_type === 'scsi' && (
                                                <div>
                                                    <label className="block text-xs text-gray-400 mb-1">{t('scsiController')}</label>
                                                    <select value={config.scsihw} onChange={e => setConfig({...config, scsihw: e.target.value})}
                                                        className="w-full px-2 py-1.5 bg-proxmox-dark border border-proxmox-border rounded text-white text-sm">
                                                        {scsiControllers.map(sc => <option key={sc.value} value={sc.value}>{sc.label}</option>)}
                                                    </select>
                                                </div>
                                            )}
                                        </div>
                                        <div className="flex flex-wrap gap-4">
                                            <label className="flex items-center gap-2 text-xs text-gray-300">
                                                <input type="checkbox" checked={config.disk_discard} onChange={e => setConfig({...config, disk_discard: e.target.checked})} className="rounded" />
                                                {t('discard')} (TRIM)
                                            </label>
                                            {config.disk_type === 'scsi' && (
                                                <label className="flex items-center gap-2 text-xs text-gray-300">
                                                    <input type="checkbox" checked={config.disk_iothread} onChange={e => setConfig({...config, disk_iothread: e.target.checked})} className="rounded" />
                                                    {t('ioThread')}
                                                </label>
                                            )}
                                            <label className="flex items-center gap-2 text-xs text-gray-300">
                                                <input type="checkbox" checked={config.disk_ssd} onChange={e => setConfig({...config, disk_ssd: e.target.checked})} className="rounded" />
                                                {t('ssdEmulation')}
                                            </label>
                                        </div>
                                    </div>
                                    
                                    {/* MK: Additional Disks - each with ALL options */}
                                    {config.additional_disks.map((disk, idx) => (
                                        <div key={idx} className="p-4 bg-proxmox-dark/50 rounded-lg border border-proxmox-border">
                                            <div className="flex items-center justify-between mb-3">
                                                <h4 className="text-sm font-medium text-white">{t('disk') || 'Disk'} {idx + 1} ({disk.type}{idx + 1})</h4>
                                                <button onClick={() => setConfig({...config, additional_disks: config.additional_disks.filter((_, i) => i !== idx)})}
                                                    className="p-1 text-red-400 hover:bg-red-500/20 rounded">
                                                    <Icons.Trash2 className="w-4 h-4" />
                                                </button>
                                            </div>
                                            <div className="grid grid-cols-4 gap-3 mb-3">
                                                <div>
                                                    <label className="block text-xs text-gray-400 mb-1">{t('busType')}</label>
                                                    <select value={disk.type} onChange={e => {
                                                        const newDisks = [...config.additional_disks];
                                                        newDisks[idx] = {...disk, type: e.target.value};
                                                        setConfig({...config, additional_disks: newDisks});
                                                    }}
                                                        className="w-full px-2 py-1.5 bg-proxmox-dark border border-proxmox-border rounded text-white text-sm">
                                                        <option value="scsi">SCSI</option>
                                                        <option value="virtio">VirtIO Block</option>
                                                        <option value="sata">SATA</option>
                                                    </select>
                                                </div>
                                                <div className="col-span-2">
                                                    <label className="block text-xs text-gray-400 mb-1">{t('storage')}</label>
                                                    <select value={disk.storage} onChange={e => {
                                                        const newDisks = [...config.additional_disks];
                                                        newDisks[idx] = {...disk, storage: e.target.value};
                                                        setConfig({...config, additional_disks: newDisks});
                                                    }}
                                                        className="w-full px-2 py-1.5 bg-proxmox-dark border border-proxmox-border rounded text-white text-sm">
                                                        {diskStorages.map(s => <option key={s.storage} value={s.storage}>{s.storage} ({s.type})</option>)}
                                                    </select>
                                                    {renderStorageBar(disk.storage)}
                                                </div>
                                                <div>
                                                    <label className="block text-xs text-gray-400 mb-1">{t('size')} (GB)</label>
                                                    <input type="number" min="1" value={disk.size} onChange={e => {
                                                        const newDisks = [...config.additional_disks];
                                                        newDisks[idx] = {...disk, size: e.target.value};
                                                        setConfig({...config, additional_disks: newDisks});
                                                    }}
                                                        className="w-full px-2 py-1.5 bg-proxmox-dark border border-proxmox-border rounded text-white text-sm" />
                                                </div>
                                            </div>
                                            <div className="grid grid-cols-4 gap-3 mb-3">
                                                <div>
                                                    <label className="block text-xs text-gray-400 mb-1">{t('format')}</label>
                                                    <select value={disk.format || ''} onChange={e => {
                                                        const newDisks = [...config.additional_disks];
                                                        newDisks[idx] = {...disk, format: e.target.value};
                                                        setConfig({...config, additional_disks: newDisks});
                                                    }}
                                                        className="w-full px-2 py-1.5 bg-proxmox-dark border border-proxmox-border rounded text-white text-sm">
                                                        <option value="">{t('storageDefault') || 'Default'}</option>
                                                        <option value="raw">Raw</option>
                                                        <option value="qcow2">QCOW2</option>
                                                        <option value="vmdk">VMDK</option>
                                                    </select>
                                                </div>
                                                <div>
                                                    <label className="block text-xs text-gray-400 mb-1">{t('cache')}</label>
                                                    <select value={disk.cache || ''} onChange={e => {
                                                        const newDisks = [...config.additional_disks];
                                                        newDisks[idx] = {...disk, cache: e.target.value};
                                                        setConfig({...config, additional_disks: newDisks});
                                                    }}
                                                        className="w-full px-2 py-1.5 bg-proxmox-dark border border-proxmox-border rounded text-white text-sm">
                                                        <option value="">{t('default') || 'Default'}</option>
                                                        <option value="directsync">Direct Sync</option>
                                                        <option value="writethrough">Write Through</option>
                                                        <option value="writeback">Write Back</option>
                                                        <option value="none">{t('none') || 'None'}</option>
                                                    </select>
                                                </div>
                                                {disk.type === 'scsi' && (
                                                    <div>
                                                        <label className="block text-xs text-gray-400 mb-1">{t('scsiController')}</label>
                                                        <select value={disk.scsihw || config.scsihw} onChange={e => {
                                                            const newDisks = [...config.additional_disks];
                                                            newDisks[idx] = {...disk, scsihw: e.target.value};
                                                            setConfig({...config, additional_disks: newDisks});
                                                        }}
                                                            className="w-full px-2 py-1.5 bg-proxmox-dark border border-proxmox-border rounded text-white text-sm">
                                                            <option value="virtio-scsi-pci">VirtIO SCSI</option>
                                                            <option value="virtio-scsi-single">VirtIO Single</option>
                                                            <option value="lsi">LSI 53C895A</option>
                                                            <option value="megasas">MegaRAID SAS</option>
                                                        </select>
                                                    </div>
                                                )}
                                            </div>
                                            <div className="flex flex-wrap gap-4">
                                                <label className="flex items-center gap-2 text-xs text-gray-300">
                                                    <input type="checkbox" checked={disk.discard !== false} onChange={e => {
                                                        const newDisks = [...config.additional_disks];
                                                        newDisks[idx] = {...disk, discard: e.target.checked};
                                                        setConfig({...config, additional_disks: newDisks});
                                                    }} className="rounded" />
                                                    {t('discard')} (TRIM)
                                                </label>
                                                {disk.type === 'scsi' && (
                                                    <label className="flex items-center gap-2 text-xs text-gray-300">
                                                        <input type="checkbox" checked={disk.iothread !== false} onChange={e => {
                                                            const newDisks = [...config.additional_disks];
                                                            newDisks[idx] = {...disk, iothread: e.target.checked};
                                                            setConfig({...config, additional_disks: newDisks});
                                                        }} className="rounded" />
                                                        {t('ioThread')}
                                                    </label>
                                                )}
                                                <label className="flex items-center gap-2 text-xs text-gray-300">
                                                    <input type="checkbox" checked={disk.ssd || false} onChange={e => {
                                                        const newDisks = [...config.additional_disks];
                                                        newDisks[idx] = {...disk, ssd: e.target.checked};
                                                        setConfig({...config, additional_disks: newDisks});
                                                    }} className="rounded" />
                                                    {t('ssdEmulation')}
                                                </label>
                                            </div>
                                        </div>
                                    ))}
                                    
                                    {/* MK: Add Disk Button */}
                                    <button onClick={() => setConfig({...config, additional_disks: [...config.additional_disks, {type: 'scsi', storage: config.storage, size: '32', format: '', cache: '', discard: true, iothread: true, ssd: false}]})}
                                        className="w-full px-4 py-2 border-2 border-dashed border-proxmox-border rounded-lg text-gray-400 hover:text-white hover:border-proxmox-orange transition-colors">
                                        + {t('addDisk') || 'Add Disk'}
                                    </button>
                                </div>
                            );
                        case 4: // Network
                            return (
                                <div className="space-y-4">
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="block text-sm text-gray-400 mb-1">{t('bridge')}</label>
                                            <select value={config.net_bridge} onChange={e => setConfig({...config, net_bridge: e.target.value})}
                                                className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white">
                                                {bridgeList.filter(b => b.type === 'bridge').map(b => <option key={b.iface} value={b.iface}>{b.iface}{b.comments ? ` - ${b.comments}` : ''}</option>)}
                                            </select>
                                        </div>
                                        <div>
                                            <label className="block text-sm text-gray-400 mb-1">{t('model')}</label>
                                            <select value={config.net_model} onChange={e => setConfig({...config, net_model: e.target.value})}
                                                className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white">
                                                <option value="virtio">VirtIO (paravirtualized)</option>
                                                <option value="e1000">Intel E1000</option>
                                                <option value="rtl8139">Realtek RTL8139</option>
                                                <option value="vmxnet3">VMware vmxnet3</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="block text-sm text-gray-400 mb-1">{t('vlanTag')}</label>
                                            <input type="text" value={config.net_tag} onChange={e => setConfig({...config, net_tag: e.target.value})}
                                                placeholder={t('vlanExample')}
                                                className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white" />
                                        </div>
                                        <div>
                                            <label className="block text-sm text-gray-400 mb-1">{t('macAddress') || 'MAC Address'}</label>
                                            <input type="text" value={config.net_macaddr} onChange={e => setConfig({...config, net_macaddr: e.target.value})}
                                                placeholder={t('autoGenerate') || 'Auto-generate (leave empty)'}
                                                className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white" />
                                        </div>
                                    </div>
                                    
                                    {/* MK: Advanced Network Options */}
                                    <details className="group">
                                        <summary className="flex items-center justify-between cursor-pointer p-3 bg-green-500/10 border border-green-500/30 rounded-lg hover:bg-green-500/20">
                                            <span className="text-sm font-medium text-green-400">{t('advancedNetwork') || 'Advanced Network'}</span>
                                            <Icons.ChevronDown className="w-4 h-4 text-green-400 group-open:rotate-180 transition-transform" />
                                        </summary>
                                        <div className="mt-3 space-y-3 p-3 bg-proxmox-dark/50 rounded-lg">
                                            <div className="grid grid-cols-2 gap-4">
                                                <div>
                                                    <label className="block text-sm text-gray-400 mb-1">MTU</label>
                                                    <input type="number" min="1" max="65520" value={config.net_mtu} onChange={e => setConfig({...config, net_mtu: e.target.value})}
                                                        placeholder={t('inheritBridge') || 'Inherit from bridge'}
                                                        className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white" />
                                                </div>
                                                <div>
                                                    <label className="block text-sm text-gray-400 mb-1">{t('rateLimit') || 'Rate Limit'} (MB/s)</label>
                                                    <input type="number" min="0" step="0.1" value={config.net_rate} onChange={e => setConfig({...config, net_rate: e.target.value})}
                                                        placeholder={t('unlimited') || 'Unlimited'}
                                                        className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white" />
                                                </div>
                                            </div>
                                            <label className="flex items-center gap-2 text-sm text-gray-300">
                                                <input type="checkbox" checked={config.net_disconnect} onChange={e => setConfig({...config, net_disconnect: e.target.checked})} className="rounded" />
                                                {t('disconnected') || 'Disconnected'} ({t('noLinkOnStart') || 'No network link on start'})
                                            </label>
                                        </div>
                                    </details>
                                    
                                    <label className="flex items-center gap-2 text-sm text-gray-300">
                                        <input type="checkbox" checked={config.net_firewall} onChange={e => setConfig({...config, net_firewall: e.target.checked})} className="rounded" />
                                        {t('enableFirewall')}
                                    </label>
                                </div>
                            );
                        case 5: // Advanced
                            return (
                                <div className="space-y-4">
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="block text-sm text-gray-400 mb-1">{t('cpuType')}</label>
                                            <select value={config.cpu} onChange={e => setConfig({...config, cpu: e.target.value})}
                                                className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white">
                                                {cpuTypes.map(cpu => <option key={cpu} value={cpu}>{cpu}</option>)}
                                            </select>
                                        </div>
                                        <div>
                                            <label className="block text-sm text-gray-400 mb-1">BIOS</label>
                                            <select value={config.bios} onChange={e => {
                                                const newBios = e.target.value;
                                                setConfig({
                                                    ...config, 
                                                    bios: newBios,
                                                    machine: newBios === 'ovmf' ? 'q35' : config.machine,
                                                    efi_storage: newBios === 'ovmf' ? config.storage : ''
                                                });
                                            }}
                                                className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white">
                                                <option value="seabios">SeaBIOS (Legacy BIOS)</option>
                                                <option value="ovmf">OVMF (UEFI)</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    {/* EFI Settings */}
                                    {config.bios === 'ovmf' && (
                                        <div className="p-4 bg-blue-500/10 border border-blue-500/30 rounded-lg space-y-3">
                                            <h4 className="text-sm font-medium text-blue-400">{t('efiSettings')}</h4>
                                            <div className="grid grid-cols-2 gap-4">
                                                <div>
                                                    <label className="block text-sm text-gray-400 mb-1">{t('efiDiskStorage')}</label>
                                                    <select value={config.efi_storage || config.storage} onChange={e => setConfig({...config, efi_storage: e.target.value})}
                                                        className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white">
                                                        {diskStorages.map(s => <option key={s.storage} value={s.storage}>{s.storage}</option>)}
                                                    </select>
                                                </div>
                                                <div className="flex items-end">
                                                    <label className="flex items-center gap-2 text-sm text-gray-300">
                                                        <input type="checkbox" checked={config.efi_pre_enroll} onChange={e => setConfig({...config, efi_pre_enroll: e.target.checked})} className="rounded" />
                                                        {t('preEnrollKeys')}
                                                    </label>
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                    
                                    {/* TPM Settings */}
                                    <div className="p-4 bg-purple-500/10 border border-purple-500/30 rounded-lg space-y-3">
                                        <div className="flex items-center justify-between">
                                            <h4 className="text-sm font-medium text-purple-400">{t('tpmSettings')}</h4>
                                            <label className="flex items-center gap-2 text-sm text-gray-300">
                                                <input type="checkbox" checked={!!config.tpm_storage} onChange={e => setConfig({...config, tpm_storage: e.target.checked ? config.storage : ''})} className="rounded" />
                                                {t('enableTpm')}
                                            </label>
                                        </div>
                                        {config.tpm_storage && (
                                            <div className="grid grid-cols-2 gap-4">
                                                <div>
                                                    <label className="block text-sm text-gray-400 mb-1">{t('tpmStorage')}</label>
                                                    <select value={config.tpm_storage} onChange={e => setConfig({...config, tpm_storage: e.target.value})}
                                                        className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white">
                                                        {diskStorages.map(s => <option key={s.storage} value={s.storage}>{s.storage}</option>)}
                                                    </select>
                                                </div>
                                                <div>
                                                    <label className="block text-sm text-gray-400 mb-1">{t('tpmVersion')}</label>
                                                    <select value={config.tpm_version} onChange={e => setConfig({...config, tpm_version: e.target.value})}
                                                        className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white">
                                                        <option value="v2.0">TPM 2.0 ({t('recommended')})</option>
                                                        <option value="v1.2">TPM 1.2</option>
                                                    </select>
                                                </div>
                                            </div>
                                        )}
                                        {config.ostype.startsWith('win11') && !config.tpm_storage && (
                                            <p className="text-xs text-yellow-400">‚ö†Ô∏è {t('win11NeedsTpm')}</p>
                                        )}
                                    </div>

                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="block text-sm text-gray-400 mb-1">{t('machineType')}</label>
                                            <select value={config.machine} onChange={e => setConfig({...config, machine: e.target.value})}
                                                className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white">
                                                <optgroup label="i440fx (Standard)">
                                                    <option value="i440fx">i440fx (Latest)</option>
                                                    <option value="pc-i440fx-10.1">i440fx 10.1</option>
                                                    <option value="pc-i440fx-9.2+pve1">i440fx 9.2+pve1</option>
                                                    <option value="pc-i440fx-8.2">i440fx 8.2</option>
                                                    <option value="pc-i440fx-7.2">i440fx 7.2</option>
                                                </optgroup>
                                                <optgroup label="q35 (Modern, PCIe)">
                                                    <option value="q35">q35 (Latest)</option>
                                                    <option value="pc-q35-10.1">q35 10.1</option>
                                                    <option value="pc-q35-9.2+pve1">q35 9.2+pve1</option>
                                                    <option value="pc-q35-8.2">q35 8.2</option>
                                                    <option value="pc-q35-7.2">q35 7.2</option>
                                                </optgroup>
                                            </select>
                                        </div>
                                        <div>
                                            <label className="block text-sm text-gray-400 mb-1">VGA</label>
                                            <select value={config.vga} onChange={e => setConfig({...config, vga: e.target.value})}
                                                className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white">
                                                {vgaTypes.map(v => <option key={v.value} value={v.value}>{v.label}</option>)}
                                            </select>
                                        </div>
                                    </div>
                                    {/* MK: High Availability Section */}
                                    <div className="p-4 bg-red-500/10 border border-red-500/30 rounded-lg space-y-3">
                                        <div className="flex items-center justify-between">
                                            <h4 className="text-sm font-medium text-red-400">{t('highAvailability') || 'High Availability'}</h4>
                                            <label className="flex items-center gap-2 text-sm text-gray-300">
                                                <input type="checkbox" checked={config.ha_enabled} onChange={e => setConfig({...config, ha_enabled: e.target.checked})} className="rounded" />
                                                {t('enableHa') || 'Add to Proxmox Native HA'}
                                            </label>
                                        </div>
                                        {config.ha_enabled && (
                                            <div>
                                                <label className="block text-sm text-gray-400 mb-1">{t('haGroup') || 'HA Group'}</label>
                                                <input type="text" value={config.ha_group} onChange={e => setConfig({...config, ha_group: e.target.value})}
                                                    placeholder={t('defaultGroup') || 'Default group (leave empty)'}
                                                    className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white" />
                                            </div>
                                        )}
                                    </div>
                                    
                                    <div className="space-y-2">
                                        <label className="flex items-center gap-2 text-sm text-gray-300">
                                            <input type="checkbox" checked={config.agent} onChange={e => setConfig({...config, agent: e.target.checked})} className="rounded" />
                                            {t('enableQemuAgent')}
                                        </label>
                                        <label className="flex items-center gap-2 text-sm text-gray-300">
                                            <input type="checkbox" checked={config.onboot} onChange={e => setConfig({...config, onboot: e.target.checked})} className="rounded" />
                                            {t('startOnBoot')}
                                        </label>
                                        <label className="flex items-center gap-2 text-sm text-gray-300">
                                            <input type="checkbox" checked={config.start} onChange={e => setConfig({...config, start: e.target.checked})} className="rounded" />
                                            {t('startAfterCreate')}
                                        </label>
                                    </div>
                                </div>
                            );
                    }
                } else {
                    // LXC Container
                    switch(activeStep) {
                        case 0: // Allgemein
                            return (
                                <div className="space-y-4">
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="block text-sm text-gray-400 mb-1">Node</label>
                                            <select value={config.node} onChange={e => setConfig({...config, node: e.target.value})}
                                                className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white">
                                                {nodes.map(n => <option key={n} value={n}>{n}</option>)}
                                            </select>
                                        </div>
                                        <div>
                                            <label className="block text-sm text-gray-400 mb-1">CT ID</label>
                                            <input type="number" value={config.vmid} onChange={e => setConfig({...config, vmid: e.target.value})}
                                                placeholder={nextVmid ? `N√§chste: ${nextVmid}` : ''}
                                                className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white" />
                                        </div>
                                    </div>
                                    <div>
                                        <label className="block text-sm text-gray-400 mb-1">Hostname</label>
                                        <input type="text" value={config.name} onChange={e => setConfig({...config, name: e.target.value})}
                                            placeholder="my-container"
                                            className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white" />
                                    </div>
                                </div>
                            );
                        case 1: // Template
                            return (
                                <div className="space-y-4">
                                    <div>
                                        <label className="block text-sm text-gray-400 mb-1">Template</label>
                                        <select value={config.template} onChange={e => setConfig({...config, template: e.target.value})}
                                            className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white">
                                            <option value="">{t('selectTemplate')}</option>
                                            {templateList.filter(tpl => tpl.type === 'lxc').map(tpl => <option key={tpl.volid} value={tpl.volid}>{tpl.name}</option>)}
                                        </select>
                                    </div>
                                    <div>
                                        <label className="block text-sm text-gray-400 mb-1">{t('rootPassword')}</label>
                                        <input type="password" value={config.password} onChange={e => setConfig({...config, password: e.target.value})}
                                            placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                                            className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white" />
                                    </div>
                                    
                                    {/* SSH Public Keys */}
                                    <div>
                                        <div className="flex items-center justify-between mb-1">
                                            <label className="block text-sm text-gray-400">{t('sshPublicKeys')}</label>
                                            <label className="text-xs text-proxmox-orange cursor-pointer hover:text-orange-400">
                                                <input
                                                    type="file"
                                                    accept=".pub,.txt"
                                                    className="hidden"
                                                    onChange={(e) => {
                                                        const file = e.target.files[0];
                                                        if (file) {
                                                            const reader = new FileReader();
                                                            reader.onload = (event) => {
                                                                const content = event.target.result;
                                                                setConfig(prev => ({
                                                                    ...prev,
                                                                    ssh_public_keys: prev.ssh_public_keys 
                                                                        ? prev.ssh_public_keys + '\n' + content.trim()
                                                                        : content.trim()
                                                                }));
                                                            };
                                                            reader.readAsText(file);
                                                        }
                                                        e.target.value = '';
                                                    }}
                                                />
                                                üìÇ {t('loadSshKeyFile') || 'Load SSH Key File'}
                                            </label>
                                        </div>
                                        <textarea
                                            value={config.ssh_public_keys}
                                            onChange={e => setConfig({...config, ssh_public_keys: e.target.value})}
                                            placeholder="ssh-rsa AAAAB3... user@host"
                                            rows={3}
                                            className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white text-sm font-mono resize-none"
                                        />
                                        <p className="text-xs text-gray-500 mt-1">{t('sshKeyHintMultiple') || 'One key per line. Paste or load from file.'}</p>
                                    </div>
                                </div>
                            );
                        case 2: // Ressourcen
                            return (
                                <div className="space-y-4">
                                    <div>
                                        <label className="block text-sm text-gray-400 mb-1">{t('cpuCoresLabel')}</label>
                                        <input type="number" min="1" max="128" value={config.cores} onChange={e => setConfig({...config, cores: parseInt(e.target.value)})}
                                            className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white" />
                                    </div>
                                    <div>
                                        <label className="block text-sm text-gray-400 mb-1">RAM</label>
                                        <div className="flex gap-2">
                                            <input type="number" min={config.memoryUnit === 'GB' ? 0.1 : 16} step={config.memoryUnit === 'GB' ? 0.25 : 64} 
                                                value={config.memoryUnit === 'GB' ? (config.memory / 1024) : config.memory} 
                                                onChange={e => {
                                                    const val = parseFloat(e.target.value) || 0;
                                                    setConfig({...config, memory: config.memoryUnit === 'GB' ? Math.round(val * 1024) : val});
                                                }}
                                                className="flex-1 px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white" />
                                            <select value={config.memoryUnit || 'MB'} onChange={e => setConfig({...config, memoryUnit: e.target.value})}
                                                className="w-20 px-2 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white">
                                                <option value="MB">MB</option>
                                                <option value="GB">GB</option>
                                            </select>
                                        </div>
                                        <p className="text-xs text-gray-500 mt-1">
                                            {config.memoryUnit === 'GB' ? `${config.memory} MB` : `${(config.memory / 1024).toFixed(1)} GB`}
                                        </p>
                                    </div>
                                    <div>
                                        <label className="block text-sm text-gray-400 mb-1">{t('swapMemory')}</label>
                                        <div className="flex gap-2">
                                            <input type="number" min={config.swapUnit === 'GB' ? 0 : 0} step={config.swapUnit === 'GB' ? 0.25 : 64} 
                                                value={config.swapUnit === 'GB' ? (config.swap / 1024) : config.swap} 
                                                onChange={e => {
                                                    const val = parseFloat(e.target.value) || 0;
                                                    setConfig({...config, swap: config.swapUnit === 'GB' ? Math.round(val * 1024) : val});
                                                }}
                                                className="flex-1 px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white" />
                                            <select value={config.swapUnit || 'MB'} onChange={e => setConfig({...config, swapUnit: e.target.value})}
                                                className="w-20 px-2 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white">
                                                <option value="MB">MB</option>
                                                <option value="GB">GB</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            );
                        case 3: // Disk
                            // MK: Helper to render storage bar for LXC
                            const renderLxcStorageBar = (selectedStorage) => {
                                const storageInfo = storageList.find(s => s.storage === selectedStorage);
                                if (!storageInfo) return null;
                                const total = storageInfo.total || storageInfo.maxdisk || 0;
                                const used = storageInfo.used || storageInfo.disk || 0;
                                const avail = total - used;
                                if (total <= 0) return null;
                                const usedPercent = total > 0 ? (used / total) * 100 : 0;
                                const freeGB = (avail / 1024 / 1024 / 1024).toFixed(1);
                                return (
                                    <div className="mt-2">
                                        <div className="flex justify-between text-xs text-gray-500 mb-1">
                                            <span>{freeGB} GB {t('free')}</span>
                                            <span>{usedPercent.toFixed(0)}% {t('used')}</span>
                                        </div>
                                        <div className="h-1.5 bg-proxmox-dark rounded-full overflow-hidden">
                                            <div className={`h-full ${usedPercent > 90 ? 'bg-red-500' : usedPercent > 70 ? 'bg-yellow-500' : 'bg-green-500'}`}
                                                style={{ width: `${usedPercent}%` }} />
                                        </div>
                                    </div>
                                );
                            };
                            
                            return (
                                <div className="space-y-4">
                                    {/* MK: Root Filesystem */}
                                    <div className="p-4 bg-proxmox-dark/50 rounded-lg border border-proxmox-border">
                                        <h4 className="text-sm font-medium text-white mb-3">{t('rootFilesystem') || 'Root Filesystem'} (rootfs)</h4>
                                        <div className="grid grid-cols-3 gap-4">
                                            <div className="col-span-2">
                                                <label className="block text-xs text-gray-400 mb-1">Storage</label>
                                                <select value={config.storage} onChange={e => setConfig({...config, storage: e.target.value})}
                                                    className="w-full px-2 py-1.5 bg-proxmox-dark border border-proxmox-border rounded text-white text-sm">
                                                    {storageList.map(s => (
                                                        <option key={s.storage} value={s.storage}>
                                                            {s.storage} ({s.type || 'storage'})
                                                        </option>
                                                    ))}
                                                </select>
                                                {renderLxcStorageBar(config.storage)}
                                            </div>
                                            <div>
                                                <label className="block text-xs text-gray-400 mb-1">{t('size')} (GB)</label>
                                                <input type="number" min="1" value={config.disk_size} onChange={e => setConfig({...config, disk_size: e.target.value})}
                                                    className="w-full px-2 py-1.5 bg-proxmox-dark border border-proxmox-border rounded text-white text-sm" />
                                            </div>
                                        </div>
                                    </div>
                                    
                                    {/* MK: Additional Mount Points */}
                                    {config.additional_disks.map((mp, idx) => (
                                        <div key={idx} className="p-4 bg-proxmox-dark/50 rounded-lg border border-proxmox-border">
                                            <div className="flex items-center justify-between mb-3">
                                                <h4 className="text-sm font-medium text-white">{t('mountPoint') || 'Mount Point'} {idx} (mp{idx})</h4>
                                                <button onClick={() => setConfig({...config, additional_disks: config.additional_disks.filter((_, i) => i !== idx)})}
                                                    className="p-1 text-red-400 hover:bg-red-500/20 rounded">
                                                    <Icons.Trash2 className="w-4 h-4" />
                                                </button>
                                            </div>
                                            <div className="grid grid-cols-4 gap-3">
                                                <div className="col-span-2">
                                                    <label className="block text-xs text-gray-400 mb-1">Storage</label>
                                                    <select value={mp.storage} onChange={e => {
                                                        const newMps = [...config.additional_disks];
                                                        newMps[idx] = {...mp, storage: e.target.value};
                                                        setConfig({...config, additional_disks: newMps});
                                                    }}
                                                        className="w-full px-2 py-1.5 bg-proxmox-dark border border-proxmox-border rounded text-white text-sm">
                                                        {storageList.map(s => <option key={s.storage} value={s.storage}>{s.storage} ({s.type || 'storage'})</option>)}
                                                    </select>
                                                    {renderLxcStorageBar(mp.storage)}
                                                </div>
                                                <div>
                                                    <label className="block text-xs text-gray-400 mb-1">{t('size')} (GB)</label>
                                                    <input type="number" min="1" value={mp.size} onChange={e => {
                                                        const newMps = [...config.additional_disks];
                                                        newMps[idx] = {...mp, size: e.target.value};
                                                        setConfig({...config, additional_disks: newMps});
                                                    }}
                                                        className="w-full px-2 py-1.5 bg-proxmox-dark border border-proxmox-border rounded text-white text-sm" />
                                                </div>
                                                <div>
                                                    <label className="block text-xs text-gray-400 mb-1">{t('path') || 'Path'}</label>
                                                    <input type="text" value={mp.path || ''} onChange={e => {
                                                        const newMps = [...config.additional_disks];
                                                        newMps[idx] = {...mp, path: e.target.value};
                                                        setConfig({...config, additional_disks: newMps});
                                                    }}
                                                        placeholder="/mnt/data"
                                                        className="w-full px-2 py-1.5 bg-proxmox-dark border border-proxmox-border rounded text-white text-sm" />
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                    
                                    {/* MK: Add Mount Point Button */}
                                    <button onClick={() => setConfig({...config, additional_disks: [...config.additional_disks, {storage: config.storage, size: '8', path: '/mnt/data' + config.additional_disks.length}]})}
                                        className="w-full px-4 py-2 border-2 border-dashed border-proxmox-border rounded-lg text-gray-400 hover:text-white hover:border-proxmox-orange transition-colors">
                                        + {t('addMountPoint') || 'Add Mount Point'}
                                    </button>
                                </div>
                            );
                        case 4: // Netzwerk
                            return (
                                <div className="space-y-4">
                                    {/* Bridge Selection */}
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="block text-sm text-gray-400 mb-1">Bridge</label>
                                            <select value={config.net_bridge} onChange={e => setConfig({...config, net_bridge: e.target.value})}
                                                className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white">
                                                {bridgeList.map(b => <option key={b.iface} value={b.iface}>{b.iface}{b.comments ? ` - ${b.comments}` : ''}</option>)}
                                            </select>
                                        </div>
                                        <div>
                                            <label className="block text-sm text-gray-400 mb-1">VLAN Tag</label>
                                            <input type="text" value={config.net_tag} onChange={e => setConfig({...config, net_tag: e.target.value})}
                                                placeholder={t('optional') || 'optional'}
                                                className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white" />
                                        </div>
                                    </div>
                                    
                                    {/* MK: Advanced Network for LXC */}
                                    <div className="grid grid-cols-3 gap-4">
                                        <div>
                                            <label className="block text-sm text-gray-400 mb-1">{t('macAddress') || 'MAC Address'}</label>
                                            <input type="text" value={config.net_macaddr} onChange={e => setConfig({...config, net_macaddr: e.target.value})}
                                                placeholder={t('autoGenerate') || 'Auto-generate'}
                                                className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white" />
                                        </div>
                                        <div>
                                            <label className="block text-sm text-gray-400 mb-1">MTU</label>
                                            <input type="number" min="1" max="65520" value={config.net_mtu} onChange={e => setConfig({...config, net_mtu: e.target.value})}
                                                placeholder={t('inheritBridge') || 'Inherit'}
                                                className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white" />
                                        </div>
                                        <div>
                                            <label className="block text-sm text-gray-400 mb-1">{t('rateLimit') || 'Rate Limit'} (MB/s)</label>
                                            <input type="number" min="0" step="0.1" value={config.net_rate} onChange={e => setConfig({...config, net_rate: e.target.value})}
                                                placeholder={t('unlimited') || 'Unlimited'}
                                                className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white" />
                                        </div>
                                    </div>
                                    
                                    {/* IPv4 Configuration */}
                                    <div className="p-3 bg-proxmox-dark/50 rounded-lg border border-proxmox-border">
                                        <div className="flex items-center justify-between mb-3">
                                            <span className="text-sm font-medium text-white">IPv4</span>
                                            <select 
                                                value={config.net_ip_type} 
                                                onChange={e => setConfig({...config, net_ip_type: e.target.value, net_ip: e.target.value === 'dhcp' ? 'dhcp' : ''})}
                                                className="px-2 py-1 bg-proxmox-dark border border-proxmox-border rounded text-white text-sm"
                                            >
                                                <option value="dhcp">DHCP</option>
                                                <option value="static">Static</option>
                                                <option value="manual">{t('manual') || 'Manual'}</option>
                                            </select>
                                        </div>
                                        {config.net_ip_type === 'static' && (
                                            <div className="grid grid-cols-2 gap-3">
                                                <div>
                                                    <label className="block text-xs text-gray-400 mb-1">{t('ipAddress') || 'IP Address'}</label>
                                                    <input type="text" value={config.net_ip} onChange={e => setConfig({...config, net_ip: e.target.value})}
                                                        placeholder="192.168.1.100/24"
                                                        className="w-full px-2 py-1.5 bg-proxmox-dark border border-proxmox-border rounded text-white text-sm" />
                                                </div>
                                                <div>
                                                    <label className="block text-xs text-gray-400 mb-1">Gateway</label>
                                                    <input type="text" value={config.net_gw} onChange={e => setConfig({...config, net_gw: e.target.value})}
                                                        placeholder="192.168.1.1"
                                                        className="w-full px-2 py-1.5 bg-proxmox-dark border border-proxmox-border rounded text-white text-sm" />
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                    
                                    {/* IPv6 Configuration */}
                                    <div className="p-3 bg-proxmox-dark/50 rounded-lg border border-proxmox-border">
                                        <div className="flex items-center justify-between mb-3">
                                            <span className="text-sm font-medium text-white">IPv6</span>
                                            <select 
                                                value={config.net_ip6_type} 
                                                onChange={e => setConfig({...config, net_ip6_type: e.target.value, net_ip6: e.target.value === 'dhcp' ? 'dhcp' : e.target.value === 'slaac' ? 'auto' : ''})}
                                                className="px-2 py-1 bg-proxmox-dark border border-proxmox-border rounded text-white text-sm"
                                            >
                                                <option value="dhcp">DHCP</option>
                                                <option value="slaac">SLAAC</option>
                                                <option value="static">Static</option>
                                                <option value="manual">{t('manual') || 'Manual'}</option>
                                            </select>
                                        </div>
                                        {config.net_ip6_type === 'static' && (
                                            <div className="grid grid-cols-2 gap-3">
                                                <div>
                                                    <label className="block text-xs text-gray-400 mb-1">{t('ipAddress') || 'IP Address'}</label>
                                                    <input type="text" value={config.net_ip6} onChange={e => setConfig({...config, net_ip6: e.target.value})}
                                                        placeholder="2001:db8::100/64"
                                                        className="w-full px-2 py-1.5 bg-proxmox-dark border border-proxmox-border rounded text-white text-sm" />
                                                </div>
                                                <div>
                                                    <label className="block text-xs text-gray-400 mb-1">Gateway</label>
                                                    <input type="text" value={config.net_gw6} onChange={e => setConfig({...config, net_gw6: e.target.value})}
                                                        placeholder="2001:db8::1"
                                                        className="w-full px-2 py-1.5 bg-proxmox-dark border border-proxmox-border rounded text-white text-sm" />
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                    
                                    {/* Network Options */}
                                    <div className="flex flex-wrap gap-4">
                                        <label className="flex items-center gap-2 text-sm text-gray-300 cursor-pointer">
                                            <input type="checkbox" checked={config.net_firewall} onChange={e => setConfig({...config, net_firewall: e.target.checked})} className="rounded" />
                                            {t('enableFirewall')}
                                        </label>
                                        <label className="flex items-center gap-2 text-sm text-gray-300 cursor-pointer">
                                            <input type="checkbox" checked={config.net_disconnected} onChange={e => setConfig({...config, net_disconnected: e.target.checked})} className="rounded" />
                                            {t('disconnected') || 'Disconnected'}
                                        </label>
                                    </div>
                                </div>
                            );
                        case 5: // Optionen
                            return (
                                <div className="space-y-4">
                                    {/* MK: High Availability Section for LXC */}
                                    <div className="p-4 bg-red-500/10 border border-red-500/30 rounded-lg space-y-3">
                                        <div className="flex items-center justify-between">
                                            <h4 className="text-sm font-medium text-red-400">{t('highAvailability') || 'High Availability'}</h4>
                                            <label className="flex items-center gap-2 text-sm text-gray-300">
                                                <input type="checkbox" checked={config.ha_enabled} onChange={e => setConfig({...config, ha_enabled: e.target.checked})} className="rounded" />
                                                {t('enableHa') || 'Add to Proxmox Native HA'}
                                            </label>
                                        </div>
                                        {config.ha_enabled && (
                                            <div>
                                                <label className="block text-sm text-gray-400 mb-1">{t('haGroup') || 'HA Group'}</label>
                                                <input type="text" value={config.ha_group} onChange={e => setConfig({...config, ha_group: e.target.value})}
                                                    placeholder={t('defaultGroup') || 'Default group (leave empty)'}
                                                    className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white" />
                                            </div>
                                        )}
                                    </div>
                                    
                                    {/* Container Options */}
                                    <div className="space-y-2">
                                        <label className="flex items-center gap-2 text-sm text-gray-300">
                                            <input type="checkbox" checked={config.unprivileged} onChange={e => setConfig({...config, unprivileged: e.target.checked})} className="rounded" />
                                            Unprivileged Container ({t('recommended') || 'recommended'})
                                        </label>
                                        <label className="flex items-center gap-2 text-sm text-gray-300">
                                            <input type="checkbox" checked={config.nesting} onChange={e => setConfig({...config, nesting: e.target.checked})} className="rounded" />
                                            Nesting ({t('dockerSupport') || 'Docker support'})
                                        </label>
                                        <label className="flex items-center gap-2 text-sm text-gray-300">
                                            <input type="checkbox" checked={config.onboot} onChange={e => setConfig({...config, onboot: e.target.checked})} className="rounded" />
                                            {t('startOnBoot')}
                                        </label>
                                        <label className="flex items-center gap-2 text-sm text-gray-300">
                                            <input type="checkbox" checked={config.start} onChange={e => setConfig({...config, start: e.target.checked})} className="rounded" />
                                            {t('startAfterCreate')}
                                        </label>
                                    </div>
                                    
                                    {/* DNS Settings */}
                                    <div className="p-3 bg-proxmox-dark/50 rounded-lg border border-proxmox-border">
                                        <h4 className="text-sm font-medium text-white mb-3">DNS</h4>
                                        <div className="space-y-3">
                                            <div>
                                                <label className="block text-xs text-gray-400 mb-1">{t('dnsDomain') || 'DNS Domain'}</label>
                                                <input type="text" value={config.dns_domain} onChange={e => setConfig({...config, dns_domain: e.target.value})}
                                                    placeholder={t('useHostSettings') || 'Use host settings'}
                                                    className="w-full px-2 py-1.5 bg-proxmox-dark border border-proxmox-border rounded text-white text-sm" />
                                            </div>
                                            <div>
                                                <label className="block text-xs text-gray-400 mb-1">{t('dnsServers') || 'DNS Servers'}</label>
                                                <input type="text" value={config.dns_servers} onChange={e => setConfig({...config, dns_servers: e.target.value})}
                                                    placeholder={t('useHostSettings') || 'Use host settings (e.g. 8.8.8.8 1.1.1.1)'}
                                                    className="w-full px-2 py-1.5 bg-proxmox-dark border border-proxmox-border rounded text-white text-sm" />
                                                <p className="text-xs text-gray-500 mt-1">{t('dnsServersHint') || 'Space-separated list of DNS servers'}</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            );
                    }
                }
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/80">
                    <div className="w-full max-w-2xl bg-proxmox-card border border-proxmox-border rounded-xl shadow-2xl animate-scale-in overflow-hidden">
                        {/* Header */}
                        <div className="flex items-center justify-between px-6 py-4 border-b border-proxmox-border bg-proxmox-dark">
                            <div className="flex items-center gap-3">
                                <div className={`p-2 rounded-lg ${isQemu ? 'bg-blue-500/10' : 'bg-purple-500/10'}`}>
                                    {isQemu ? <Icons.VM /> : <Icons.Container />}
                                </div>
                                <h2 className="font-semibold text-white">
                                    {isQemu ? t('createVm') : t('createContainer')}
                                </h2>
                            </div>
                            <button onClick={onClose} className="p-2 hover:bg-proxmox-hover rounded-lg text-gray-400 hover:text-white">
                                <Icons.X />
                            </button>
                        </div>

                        {/* No nodes warning */}
                        {nodes.length === 0 && (
                            <div className="p-4 bg-yellow-500/10 border-b border-yellow-500/30">
                                <p className="text-yellow-400 text-sm">
                                    ‚ö†Ô∏è {t('noNodesAvailable') || 'No nodes available. Please wait for cluster data to load.'}
                                </p>
                            </div>
                        )}
                        
                        {/* Debug info */}
                        {storageList.length === 0 && config.node && (
                            <div className="px-6 pt-2">
                                <p className="text-xs text-gray-500">
                                    {t('loadingStorage') || 'Lade Storage-Liste...'} (Node: {config.node})
                                </p>
                            </div>
                        )}

                        {/* Steps Navigation */}
                        <div className="flex border-b border-proxmox-border bg-proxmox-dark/50">
                            {steps.map((step, idx) => (
                                <button
                                    key={step}
                                    onClick={() => setActiveStep(idx)}
                                    className={`flex-1 px-4 py-3 text-sm font-medium transition-colors ${
                                        activeStep === idx
                                            ? 'text-proxmox-orange border-b-2 border-proxmox-orange'
                                            : 'text-gray-400 hover:text-white'
                                    }`}
                                >
                                    {step}
                                </button>
                            ))}
                        </div>

                        {/* Content */}
                        <div className="p-6 min-h-[300px]">
                            {renderStepContent()}
                        </div>

                        {/* Footer */}
                        <div className="flex items-center justify-between px-6 py-4 border-t border-proxmox-border bg-proxmox-dark">
                            <button
                                onClick={() => setActiveStep(Math.max(0, activeStep - 1))}
                                disabled={activeStep === 0}
                                className="px-4 py-2 text-gray-400 hover:text-white disabled:opacity-50 disabled:cursor-not-allowed"
                            >
                                {t('back')}
                            </button>
                            <div className="flex gap-3">
                                <button onClick={onClose} className="px-4 py-2 text-gray-300 hover:text-white">
                                    {t('cancel')}
                                </button>
                                {activeStep < steps.length - 1 ? (
                                    <button
                                        onClick={() => setActiveStep(activeStep + 1)}
                                        className="px-4 py-2 bg-proxmox-orange rounded-lg text-white hover:bg-orange-600"
                                    >
                                        Weiter
                                    </button>
                                ) : (
                                    <button
                                        onClick={handleCreate}
                                        disabled={loading || (!isQemu && !config.template)}
                                        className="flex items-center gap-2 px-4 py-2 bg-green-600 rounded-lg text-white hover:bg-green-700 disabled:opacity-50"
                                    >
                                        {loading && <Icons.RotateCw />}
                                        {isQemu ? t('createVm') : t('createContainer')}
                                    </button>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // Add Cluster Modal
        // LW: Wizard for adding new Proxmox clusters
        // Defaults are pretty sensible, most users just need host + credentials
        function AddClusterModal({ isOpen, onClose, onSubmit, loading, error }) {
            const { t } = useTranslation();
            // Default config - 20% threshold, 5min interval seems to work well
            const [config, setConfig] = useState({
                name: '',
                host: '',
                user: 'root@pam',
                pass: '',
                ssl_verification: false,
                migration_threshold: 20,
                check_interval: 300,
                auto_migrate: true,
                balance_containers: false,
                balance_local_disks: false,
                dry_run: false,
                ssh_key: '',
            });
            const [showSshSettings, setShowSshSettings] = useState(false);

            if (!isOpen) return null;

            const handleSubmit = (e) => {
                e.preventDefault();
                onSubmit(config);
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop bg-black/60" onClick={onClose}>
                    <div 
                        className="w-full max-w-lg bg-proxmox-card border border-proxmox-border rounded-2xl shadow-2xl animate-scale-in overflow-hidden max-h-[90vh] overflow-y-auto"
                        onClick={e => e.stopPropagation()}
                    >
                        <div className="p-6 border-b border-proxmox-border">
                            <h2 className="text-xl font-bold text-white">{t('addNewCluster')}</h2>
                            <p className="text-sm text-gray-400 mt-1">{t('connectCluster')}</p>
                        </div>

                        {error && (
                            <div className="mx-6 mt-4 p-3 bg-red-500/10 border border-red-500/30 rounded-lg text-red-400 text-sm">
                                {error}
                            </div>
                        )}

                        <form onSubmit={handleSubmit} className="p-6 space-y-5">
                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-sm font-medium text-gray-300 mb-2">{t('clusterName')}</label>
                                    <input
                                        type="text"
                                        value={config.name}
                                        onChange={e => setConfig({...config, name: e.target.value})}
                                        required
                                        className="w-full px-4 py-2.5 bg-proxmox-dark border border-proxmox-border rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-proxmox-orange transition-colors"
                                        placeholder="Production Cluster"
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-300 mb-2">{t('host')}</label>
                                    <input
                                        type="text"
                                        value={config.host}
                                        onChange={e => setConfig({...config, host: e.target.value})}
                                        required
                                        className="w-full px-4 py-2.5 bg-proxmox-dark border border-proxmox-border rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-proxmox-orange transition-colors"
                                        placeholder="proxmox.example.com"
                                    />
                                </div>
                            </div>

                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-sm font-medium text-gray-300 mb-2">{t('username')}</label>
                                    <input
                                        type="text"
                                        value={config.user}
                                        onChange={e => setConfig({...config, user: e.target.value})}
                                        required
                                        className="w-full px-4 py-2.5 bg-proxmox-dark border border-proxmox-border rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-proxmox-orange transition-colors"
                                        placeholder="root@pam or user@pam!tokenid"
                                    />
                                    <p className="mt-1 text-xs text-gray-500">{t('apiTokenHint') || 'For API tokens use: user@realm!tokenid'}</p>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-300 mb-2">{t('passwordOrToken') || t('password')}</label>
                                    <input
                                        type="password"
                                        value={config.pass}
                                        onChange={e => setConfig({...config, pass: e.target.value})}
                                        required
                                        className="w-full px-4 py-2.5 bg-proxmox-dark border border-proxmox-border rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-proxmox-orange transition-colors"
                                        placeholder={config.user.includes('!') ? 'Token Secret' : 'Password'}
                                    />
                                </div>
                            </div>
                            
                            {/* LW: API Token Warning */}
                            {config.user.includes('!') && (
                                <div className="p-4 bg-yellow-500/10 border border-yellow-500/30 rounded-lg">
                                    <div className="flex items-start gap-3">
                                        <span className="text-yellow-400 text-xl">‚ö†Ô∏è</span>
                                        <div>
                                            <p className="font-medium text-yellow-200">
                                                {t('apiTokenWarningTitle') || 'API Token Authentication'}
                                            </p>
                                            <p className="text-sm text-yellow-300/80 mt-1">
                                                {t('apiTokenWarningDesc') || 'Using API tokens is supported but not all features will work correctly. Features requiring SSH access (SMBIOS Auto-Config, Rolling Updates, 2-Node HA, Node Shell) need password authentication. PegaProx recommends using a dedicated privileged user or root with password for full functionality.'}
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {/* SSH Key (Optional) */}
                            <div className="pt-4 border-t border-proxmox-border">
                                <button
                                    type="button"
                                    onClick={() => setShowSshSettings(!showSshSettings)}
                                    className="flex items-center gap-2 text-sm text-gray-400 hover:text-white transition-colors"
                                >
                                    <span className={`transform transition-transform ${showSshSettings ? 'rotate-90' : ''}`}>‚ñ∂</span>
                                    {t('sshKeyOptional') || 'SSH Key (Optional)'}
                                </button>
                                
                                {showSshSettings && (
                                    <div className="mt-4 space-y-4 p-4 bg-proxmox-dark/50 rounded-lg">
                                        <p className="text-xs text-gray-400">
                                            {t('sshKeyExplanation') || 'SSH features (SMBIOS Auto-Config, Custom Scripts, 2-Node HA) use your login credentials automatically. Only add a key here if password authentication is disabled on your nodes.'}
                                        </p>
                                        
                                        <div>
                                            <label className="block text-sm font-medium text-gray-300 mb-2">{t('sshPrivateKey') || 'SSH Private Key'}</label>
                                            <textarea
                                                value={config.ssh_key}
                                                onChange={e => setConfig({...config, ssh_key: e.target.value})}
                                                className="w-full px-4 py-2.5 bg-proxmox-dark border border-proxmox-border rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-proxmox-orange transition-colors font-mono text-xs"
                                                placeholder="-----BEGIN OPENSSH PRIVATE KEY-----&#10;...&#10;-----END OPENSSH PRIVATE KEY-----"
                                                rows={6}
                                            />
                                            <p className="mt-1 text-xs text-gray-500">{t('sshKeyHint') || 'Paste your private key here (id_rsa, id_ed25519, etc.)'}</p>
                                        </div>
                                    </div>
                                )}
                            </div>

                            <div className="space-y-4 pt-4 border-t border-proxmox-border">
                                <Slider
                                    label={t('migrationThreshold')}
                                    description={t('migrationThresholdDesc')}
                                    value={config.migration_threshold}
                                    onChange={v => setConfig({...config, migration_threshold: v})}
                                    min={5}
                                    max={100}
                                />
                                <Slider
                                    label={t('checkInterval')}
                                    description={t('checkIntervalDesc')}
                                    value={config.check_interval}
                                    onChange={v => setConfig({...config, check_interval: v})}
                                    min={60}
                                    max={3600}
                                    step={60}
                                    unit="s"
                                />
                            </div>

                            <div className="flex flex-wrap gap-4 pt-4 border-t border-proxmox-border">
                                <Toggle
                                    checked={config.ssl_verification}
                                    onChange={v => setConfig({...config, ssl_verification: v})}
                                    label={t('sslVerification')}
                                />
                                <Toggle
                                    checked={config.auto_migrate}
                                    onChange={v => setConfig({...config, auto_migrate: v})}
                                    label={t('autoMigrate')}
                                />
                                <Toggle
                                    checked={config.dry_run}
                                    onChange={v => setConfig({...config, dry_run: v})}
                                    label={t('dryRunShort')}
                                />
                            </div>

                            {/* Container Balancing Option */}
                            <div className="pt-4 border-t border-proxmox-border">
                                <div className="flex items-start gap-3">
                                    <Toggle
                                        checked={config.balance_containers}
                                        onChange={v => setConfig({...config, balance_containers: v})}
                                        label={t('balanceContainers')}
                                    />
                                </div>
                                {config.balance_containers && (
                                    <div className="mt-3 p-3 bg-yellow-500/10 border border-yellow-500/30 rounded-lg">
                                        <div className="flex items-start gap-2">
                                            <span className="text-yellow-500">‚ö†Ô∏è</span>
                                            <div className="text-sm text-yellow-200">
                                                <strong>{t('warning')}:</strong> {t('containerBalanceWarning')}
                                            </div>
                                        </div>
                                    </div>
                                )}
                                
                                {/* Local Disk Balancing */}
                                <div className="flex items-start gap-3 pt-3 border-t border-gray-700/50">
                                    <Toggle
                                        checked={config.balance_local_disks}
                                        onChange={v => setConfig({...config, balance_local_disks: v})}
                                        label={t('balanceLocalDisks')}
                                    />
                                </div>
                                <div className="text-xs text-gray-500 mt-1">{t('balanceLocalDisksDesc')}</div>
                                {config.balance_local_disks && (
                                    <div className="mt-3 p-3 bg-orange-500/10 border border-orange-500/30 rounded-lg">
                                        <div className="flex items-start gap-2">
                                            <span className="text-orange-500">üíæ</span>
                                            <div className="text-sm text-orange-200">
                                                {t('localDiskBalanceWarning')}
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </div>

                            <div className="flex gap-3 pt-4">
                                <button
                                    type="button"
                                    onClick={onClose}
                                    className="flex-1 px-4 py-2.5 bg-proxmox-dark border border-proxmox-border rounded-lg text-gray-300 font-medium hover:bg-proxmox-hover transition-colors"
                                >
                                    {t('cancel')}
                                </button>
                                <button
                                    type="submit"
                                    disabled={loading}
                                    className="flex-1 px-4 py-2.5 bg-proxmox-orange rounded-lg text-white font-medium hover:bg-orange-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                                >
                                    {loading ? t('connecting') : t('addCluster')}
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }

        // User Profile Modal with Password Change and 2FA Setup
        function UserProfileModal({ isOpen, onClose, addToast }) {
            const { t } = useTranslation();
            const { getAuthHeaders, user, updatePreferences } = useAuth();
            const [activeTab, setActiveTab] = useState('appearance');
            const [loading, setLoading] = useState(false);
            const [selectedTheme, setSelectedTheme] = useState(user?.theme || 'proxmoxDark');
            
            // Password change
            const [currentPassword, setCurrentPassword] = useState('');
            const [newPassword, setNewPassword] = useState('');
            const [confirmPassword, setConfirmPassword] = useState('');
            
            // 2FA setup
            const [twoFAStatus, setTwoFAStatus] = useState({ enabled: false, available: false });
            const [setupData, setSetupData] = useState(null);
            const [totpCode, setTotpCode] = useState('');
            const [disablePassword, setDisablePassword] = useState('');
            
            // Password Policy state - NS Jan 2026
            const [passwordPolicy, setPasswordPolicy] = useState({
                min_length: 8,
                require_uppercase: true,
                require_lowercase: true,
                require_numbers: true,
                require_special: false
            });
            
            // Generate password policy hint text
            const getPasswordPolicyHint = () => {
                const hints = [];
                hints.push(`${t('minChars') || 'Min.'} ${passwordPolicy.min_length} ${t('characters') || 'characters'}`);
                if (passwordPolicy.require_uppercase) hints.push(t('uppercase') || 'uppercase');
                if (passwordPolicy.require_lowercase) hints.push(t('lowercase') || 'lowercase');
                if (passwordPolicy.require_numbers) hints.push(t('numbers') || 'number');
                if (passwordPolicy.require_special) hints.push(t('specialChar') || 'special char');
                return hints.join(', ');
            };
            
            // Fetch password policy
            const fetchPasswordPolicy = async () => {
                try {
                    const r = await fetch(`${API_URL}/password-policy`);
                    if (r.ok) {
                        const data = await r.json();
                        setPasswordPolicy(data);
                    }
                } catch (e) {
                    console.error('Failed to fetch password policy:', e);
                }
            };
            
            useEffect(() => {
                if (isOpen) {
                    fetch2FAStatus();
                    fetchPasswordPolicy();
                }
            }, [isOpen]);
            
            const fetch2FAStatus = async () => {
                try {
                    const response = await fetch(`${API_URL}/auth/2fa/status`, {
                        credentials: 'include',  // MK: Fix - need cookies for session auth
                        headers: getAuthHeaders()
                    });
                    if (response && response.ok) {
                        setTwoFAStatus(await response.json());
                    }
                } catch (err) {
                    console.error('fetching 2FA status:', err);
                }
            };
            
            const handleChangePassword = async (e) => {
                e.preventDefault();
                if (newPassword !== confirmPassword) {
                    addToast(t('passwordsDoNotMatch'), 'error');
                    return;
                }
                if (newPassword.length < 4) {
                    addToast(t('passwordTooShort'), 'error');
                    return;
                }
                
                setLoading(true);
                try {
                    const response = await fetch(`${API_URL}/auth/change-password`, {
                        method: 'POST',
                        credentials: 'include',  // MK: Fix - need cookies for session auth
                        headers: {
                            'Content-Type': 'application/json',
                            ...getAuthHeaders()
                        },
                        body: JSON.stringify({
                            current_password: currentPassword,
                            new_password: newPassword
                        })
                    });
                    
                    if (response && response.ok) {
                        addToast(t('passwordResetSuccess'), 'success');
                        setCurrentPassword('');
                        setNewPassword('');
                        setConfirmPassword('');
                    } else {
                        const data = await response.json();
                        addToast(data.error || 'Error', 'error');
                    }
                } catch (err) {
                    addToast(t('connectionError'), 'error');
                }
                setLoading(false);
            };
            
            const handleSetup2FA = async () => {
                setLoading(true);
                try {
                    const response = await fetch(`${API_URL}/auth/2fa/setup`, {
                        method: 'POST',
                        credentials: 'include',  // MK: Fix - need cookies for session auth
                        headers: getAuthHeaders()
                    });
                    
                    if (response && response.ok) {
                        setSetupData(await response.json());
                    } else {
                        const data = await response.json();
                        addToast(data.error || 'Error', 'error');
                    }
                } catch (err) {
                    addToast(t('connectionError'), 'error');
                }
                setLoading(false);
            };
            
            const handleVerify2FA = async () => {
                if (totpCode.length !== 6) return;
                
                setLoading(true);
                try {
                    const response = await fetch(`${API_URL}/auth/2fa/verify`, {
                        method: 'POST',
                        credentials: 'include',  // MK: Fix - need cookies for session auth
                        headers: {
                            'Content-Type': 'application/json',
                            ...getAuthHeaders()
                        },
                        body: JSON.stringify({ code: totpCode })
                    });
                    
                    if (response && response.ok) {
                        addToast(t('twoFactorEnabled'), 'success');
                        setSetupData(null);
                        setTotpCode('');
                        fetch2FAStatus();
                    } else {
                        const data = await response.json();
                        addToast(data.error || t('invalid2FACode'), 'error');
                    }
                } catch (err) {
                    addToast(t('connectionError'), 'error');
                }
                setLoading(false);
            };
            
            const handleDisable2FA = async () => {
                if (!disablePassword) {
                    addToast(t('currentPassword') + ' required', 'error');
                    return;
                }
                
                setLoading(true);
                try {
                    const response = await fetch(`${API_URL}/auth/2fa/disable`, {
                        method: 'POST',
                        credentials: 'include',  // MK: Fix - need cookies for session auth
                        headers: {
                            'Content-Type': 'application/json',
                            ...getAuthHeaders()
                        },
                        body: JSON.stringify({ password: disablePassword })
                    });
                    
                    if (response && response.ok) {
                        addToast(t('twoFactorDisabled'), 'success');
                        setDisablePassword('');
                        fetch2FAStatus();
                    } else {
                        const data = await response.json();
                        addToast(data.error || 'Error', 'error');
                    }
                } catch (err) {
                    addToast(t('connectionError'), 'error');
                }
                setLoading(false);
            };
            
            if (!isOpen) return null;
            
            return(
                <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/80" onClick={onClose}>
                    <div 
                        className="w-full max-w-2xl max-h-[90vh] bg-proxmox-card border border-proxmox-border rounded-2xl shadow-2xl overflow-hidden flex flex-col"
                        onClick={e => e.stopPropagation()}
                    >
                        {/* Header */}
                        <div className="flex items-center justify-between p-6 border-b border-proxmox-border">
                            <div className="flex items-center gap-3">
                                <div className="w-10 h-10 rounded-full bg-proxmox-orange/20 flex items-center justify-center text-proxmox-orange font-semibold">
                                    {user?.username?.[0]?.toUpperCase() || 'U'}
                                </div>
                                <div>
                                    <h2 className="text-xl font-bold text-white">{t('myProfile')}</h2>
                                    <p className="text-sm text-gray-400">{user?.display_name || user?.username}</p>
                                </div>
                            </div>
                            <button onClick={onClose} className="p-2 rounded-lg hover:bg-proxmox-dark text-gray-400 hover:text-white">
                                <Icons.X />
                            </button>
                        </div>
                        
                        {/* Tabs */}
                        <div className="flex border-b border-proxmox-border">
                            <button
                                onClick={() => setActiveTab('appearance')}
                                className={`flex-1 px-4 py-3 text-sm font-medium transition-colors flex items-center justify-center gap-2 ${
                                    activeTab === 'appearance' 
                                        ? 'text-proxmox-orange border-b-2 border-proxmox-orange' 
                                        : 'text-gray-400 hover:text-white'
                                }`}
                            >
                                <Icons.Palette />
                                {t('appearance') || 'Appearance'}
                            </button>
                            <button
                                onClick={() => setActiveTab('security')}
                                className={`flex-1 px-4 py-3 text-sm font-medium transition-colors flex items-center justify-center gap-2 ${
                                    activeTab === 'security' 
                                        ? 'text-proxmox-orange border-b-2 border-proxmox-orange' 
                                        : 'text-gray-400 hover:text-white'
                                }`}
                            >
                                <Icons.Lock />
                                {t('security')}
                            </button>
                        </div>
                        
                        {/* Content */}
                        <div className="flex-1 overflow-auto p-6">
                            {/* Appearance Tab */}
                            {activeTab === 'appearance' && (
                                <div className="space-y-6">
                                    <div>
                                        <h3 className="text-lg font-semibold text-white mb-2 flex items-center gap-2">
                                            <Icons.Palette />
                                            {t('chooseTheme') || 'Choose Your Theme'}
                                        </h3>
                                        <p className="text-sm text-gray-400 mb-4">
                                            {t('themePersonal') || 'Select a theme that suits your style. This setting is personal and only affects your account.'}
                                        </p>
                                    </div>
                                    
                                    <div className="grid grid-cols-2 sm:grid-cols-3 gap-3">
                                        {Object.entries(PEGAPROX_THEMES).map(([key, theme]) => {
                                            const isActive = (user?.theme || 'proxmoxDark') === key;
                                            return (
                                                <button
                                                    key={key}
                                                    onClick={async () => {
                                                        setSelectedTheme(key);
                                                        const result = await updatePreferences({ theme: key });
                                                        if (result.success) {
                                                            addToast(`Theme changed to ${theme.name}`, 'success');
                                                        } else {
                                                            addToast('Failed to save theme', 'error');
                                                        }
                                                    }}
                                                    className={`p-3 rounded-xl border-2 transition-all hover:scale-105 ${
                                                        isActive 
                                                            ? 'border-proxmox-orange ring-2 ring-proxmox-orange/30' 
                                                            : 'border-proxmox-border hover:border-gray-500'
                                                    }`}
                                                    title={theme.description || theme.name}
                                                >
                                                    <div 
                                                        className="h-16 rounded-lg mb-2 relative overflow-hidden"
                                                        style={{ 
                                                            background: theme.colors.darker,
                                                            border: `1px solid ${theme.colors.border}`
                                                        }}
                                                    >
                                                        <div className="absolute left-0 top-0 bottom-0 w-4" style={{ background: theme.colors.dark }} />
                                                        <div 
                                                            className="absolute right-2 top-2 bottom-2 left-6 rounded"
                                                            style={{ 
                                                                background: theme.colors.card,
                                                                border: `1px solid ${theme.colors.border}`
                                                            }}
                                                        >
                                                            <div 
                                                                className="w-3/4 h-1.5 rounded-full m-1.5"
                                                                style={{ background: theme.colors.primary }}
                                                            />
                                                        </div>
                                                        {isActive && (
                                                            <div className="absolute top-1 right-1 bg-proxmox-orange rounded-full p-0.5">
                                                                <Icons.Check className="w-3 h-3 text-white" />
                                                            </div>
                                                        )}
                                                    </div>
                                                    <div className="flex items-center justify-center gap-1.5">
                                                        <span className="text-lg">{theme.icon}</span>
                                                        <span className="text-xs font-medium">{theme.name}</span>
                                                    </div>
                                                </button>
                                            );
                                        })}
                                    </div>
                                    
                                    <p className="text-xs text-gray-500 text-center">
                                        {t('themeNote') || 'Theme changes are applied immediately and saved to your account.'}
                                    </p>
                                </div>
                            )}
                            
                            {activeTab === 'security' && (
                                <div className="space-y-6">
                                    {/* Password Change */}
                                    <div className="bg-proxmox-dark border border-proxmox-border rounded-xl p-4">
                                        <h3 className="text-white font-medium mb-4 flex items-center gap-2">
                                            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z" />
                                            </svg>
                                            {t('resetPassword')}
                                        </h3>
                                        <form onSubmit={handleChangePassword} className="space-y-3">
                                            <input
                                                type="password"
                                                value={currentPassword}
                                                onChange={e => setCurrentPassword(e.target.value)}
                                                placeholder={t('currentPassword')}
                                                className="w-full px-3 py-2 bg-proxmox-darker border border-proxmox-border rounded-lg text-white text-sm"
                                                required
                                            />
                                            <input
                                                type="password"
                                                value={newPassword}
                                                onChange={e => setNewPassword(e.target.value)}
                                                placeholder={t('newPassword')}
                                                className="w-full px-3 py-2 bg-proxmox-darker border border-proxmox-border rounded-lg text-white text-sm"
                                                required
                                            />
                                            <p className="text-xs text-gray-500 -mt-1 mb-1">{getPasswordPolicyHint()}</p>
                                            <input
                                                type="password"
                                                value={confirmPassword}
                                                onChange={e => setConfirmPassword(e.target.value)}
                                                placeholder={t('confirmPassword')}
                                                className="w-full px-3 py-2 bg-proxmox-darker border border-proxmox-border rounded-lg text-white text-sm"
                                                required
                                            />
                                            <button
                                                type="submit"
                                                disabled={loading}
                                                className="px-4 py-2 bg-proxmox-orange hover:bg-orange-600 rounded-lg text-sm font-medium disabled:opacity-50"
                                            >
                                                {t('resetPassword')}
                                            </button>
                                        </form>
                                    </div>
                                    
                                    {/* 2FA Section */}
                                    <div className="bg-proxmox-dark border border-proxmox-border rounded-xl p-4">
                                        <h3 className="text-white font-medium mb-4 flex items-center gap-2">
                                            <Icons.Shield />
                                            {t('twoFactorAuth')}
                                        </h3>
                                        
                                        {!twoFAStatus.available ? (
                                            <p className="text-gray-400 text-sm">
                                                2FA nicht verf√ºgbar. Server ben√∂tigt: pip install pyotp qrcode[pil]
                                            </p>
                                        ) : twoFAStatus.enabled ? (
                                            <div className="space-y-3">
                                                <div className="flex items-center gap-2 text-green-400">
                                                    <Icons.Check />
                                                    <span>{t('twoFactorEnabled')}</span>
                                                </div>
                                                <div className="flex gap-2">
                                                    <input
                                                        type="password"
                                                        value={disablePassword}
                                                        onChange={e => setDisablePassword(e.target.value)}
                                                        placeholder={t('currentPassword')}
                                                        className="flex-1 px-3 py-2 bg-proxmox-darker border border-proxmox-border rounded-lg text-white text-sm"
                                                    />
                                                    <button
                                                        onClick={handleDisable2FA}
                                                        disabled={loading || !disablePassword}
                                                        className="px-4 py-2 bg-red-600 hover:bg-red-700 rounded-lg text-sm font-medium disabled:opacity-50"
                                                    >
                                                        {t('disable2FA')}
                                                    </button>
                                                </div>
                                            </div>
                                        ) : setupData ? (
                                            <div className="space-y-4">
                                                <p className="text-gray-400 text-sm">{t('scan2FACode')}</p>
                                                <div className="flex justify-center">
                                                    <img src={setupData.qr_code} alt="QR Code" className="rounded-lg" />
                                                </div>
                                                <div className="text-center">
                                                    <p className="text-xs text-gray-500 mb-1">{t('secretKey')}:</p>
                                                    <code className="text-xs text-proxmox-orange bg-proxmox-darker px-2 py-1 rounded">
                                                        {setupData.secret}
                                                    </code>
                                                </div>
                                                <div className="flex gap-2">
                                                    <input
                                                        type="text"
                                                        value={totpCode}
                                                        onChange={e => setTotpCode(e.target.value.replace(/\D/g, '').slice(0, 6))}
                                                        placeholder={t('enter2FACode')}
                                                        maxLength={6}
                                                        className="flex-1 px-3 py-2 bg-proxmox-darker border border-proxmox-border rounded-lg text-white text-center text-lg tracking-widest"
                                                    />
                                                    <button
                                                        onClick={handleVerify2FA}
                                                        disabled={loading || totpCode.length !== 6}
                                                        className="px-4 py-2 bg-green-600 hover:bg-green-700 rounded-lg text-sm font-medium disabled:opacity-50"
                                                    >
                                                        {t('verify2FA')}
                                                    </button>
                                                </div>
                                                <button
                                                    onClick={() => setSetupData(null)}
                                                    className="text-sm text-gray-400 hover:text-white"
                                                >
                                                    {t('cancel')}
                                                </button>
                                            </div>
                                        ) : (
                                            <button
                                                onClick={handleSetup2FA}
                                                disabled={loading}
                                                className="px-4 py-2 bg-proxmox-orange hover:bg-orange-600 rounded-lg text-sm font-medium disabled:opacity-50"
                                            >
                                                {t('setup2FA')}
                                            </button>
                                        )}
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        // PegaProx Settings Modal with User Management and Audit Log
        function PegaProxSettingsModal({ isOpen, onClose, addToast }) {
            const { t } = useTranslation();
            const { getAuthHeaders, user: currentUser } = useAuth();
            const [activeTab, setActiveTab] = useState('users');
            const [users, setUsers] = useState([]);
            const [auditLogs, setAuditLogs] = useState([]);
            const [loading, setLoading] = useState(false);
            const [showAddUser, setShowAddUser] = useState(false);
            const [editingUser, setEditingUser] = useState(null);
            const [userFilter, setUserFilter] = useState('');
            const [actionFilter, setActionFilter] = useState('');
            const [passwordResetUser, setPasswordResetUser] = useState(null);
            const [newPasswordValue, setNewPasswordValue] = useState('');
            
            // tenant state - NS
            const [tenants, setTenants] = useState([]);
            const [showAddTenant, setShowAddTenant] = useState(false);
            const [newTenant, setNewTenant] = useState({ name: '', clusters: [], groups: [] });
            const [editingTenant, setEditingTenant] = useState(null);
            const [clusters, setClusters] = useState([]);  // for tenant cluster dropdown
            
            // Cluster Groups state - NS Jan 2026
            const [clusterGroups, setClusterGroups] = useState([]);
            const [showAddGroup, setShowAddGroup] = useState(false);
            const [newGroup, setNewGroup] = useState({ name: '', description: '', color: '#E86F2D' });
            const [editingGroup, setEditingGroup] = useState(null);
            
            // permissions state - LW: this got complex fast
            const [allPermissions, setAllPermissions] = useState([]);
            const [rolePermissions, setRolePermissions] = useState({});
            const [selectedUser, setSelectedUser] = useState(null);
            const [userPermissions, setUserPermissions] = useState(null);
            
            // custom roles state - NS: Dec 2025
            const [allRoles, setAllRoles] = useState([]);
            const [showAddRole, setShowAddRole] = useState(false);
            const [newRole, setNewRole] = useState({ id: '', name: '', permissions: [], tenant_id: '' });
            const [editingRole, setEditingRole] = useState(null);
            const [selectedTenantForPerms, setSelectedTenantForPerms] = useState('');  // for per-tenant user perms
            
            // Pool Permissions state - MK Jan 2026
            const [permSubTab, setPermSubTab] = useState('users');  // users, vms, pools
            const [pools, setPools] = useState([]);
            const [selectedPoolCluster, setSelectedPoolCluster] = useState('');
            const [selectedPool, setSelectedPool] = useState(null);
            const [poolPermissions, setPoolPermissions] = useState([]);
            const [showPoolPermModal, setShowPoolPermModal] = useState(false);
            const [poolPermForm, setPoolPermForm] = useState({ subject_type: 'user', subject_id: '', permissions: [] });
            const [availablePoolPerms, setAvailablePoolPerms] = useState([]);
            
            // Pool Management state - NS Jan 2026
            const [showPoolManager, setShowPoolManager] = useState(false);
            const [showCreatePool, setShowCreatePool] = useState(false);
            const [newPoolForm, setNewPoolForm] = useState({ poolid: '', comment: '' });
            const [editingPool, setEditingPool] = useState(null);
            const [poolManagerLoading, setPoolManagerLoading] = useState(false);
            const [vmsWithoutPool, setVmsWithoutPool] = useState([]);
            const [showAddVmToPool, setShowAddVmToPool] = useState(null); // pool_id when open
            
            const [filterDate, setFilterDate] = useState('');
            const [snapshotsSubTab, setSnapshotsTab] = useState('overview');
            const [snapshots, setSnapshots] = useState([]);
            
            // Server settings state
            const [serverSettings, setServerSettings] = useState({
                domain: '',
                port: 5000,
                http_redirect_port: 0,  // NS: 0=auto, -1=disabled, >0=specific port
                ssl_enabled: false,
                ssl_cert: '',
                ssl_key: '',
                ssl_cert_file: null,
                ssl_key_file: null,
                logo_url: '',
                app_name: 'PegaProx',
                default_theme: 'proxmoxDark',  // NS: Default theme for new users - Jan 2026
                // NS: SMTP Settings - Dec 2025
                smtp_enabled: false,
                smtp_host: '',
                smtp_port: 587,
                smtp_user: '',
                smtp_password: '',
                smtp_from_email: '',
                smtp_from_name: 'PegaProx Alerts',
                smtp_tls: true,
                smtp_ssl: false,
                alert_email_recipients: [],
                alert_cooldown: 300
            });
            const [serverLoading, setServerLoading] = useState(false);
            const [showRestartConfirm, setShowRestartConfirm] = useState(false);
            const [restartLoading, setRestartLoading] = useState(false);
            const [testEmailLoading, setTestEmailLoading] = useState(false);
            const [testEmailAddress, setTestEmailAddress] = useState('');
            
            // Password policy state - NS Jan 2026
            const [passwordPolicy, setPasswordPolicy] = useState({
                min_length: 8,
                require_uppercase: true,
                require_lowercase: true,
                require_numbers: true,
                require_special: false
            });
            
            // update checker
            const [updateInfo, setUpdateInfo] = useState(null);
            const [updateLoading, setUpdateLoading] = useState(false);
            const [updateError, setUpdateError] = useState(null);
            const [updateProgress, setUpdateProgress] = useState(null); // { status: 'downloading'|'installing'|'restarting', message: '' }
            const [availableBackups, setAvailableBackups] = useState([]);
            const [showRollbackModal, setShowRollbackModal] = useState(false);
            
            // New user form - MK: added tenant_id for multi-tenant support
            const [newUser, setNewUser] = useState({
                username: '',
                password: '',
                display_name: '',
                email: '',
                role: 'user',
                tenant_id: 'default'
            });
            
            useEffect(() => {
                if (isOpen) {
                    fetchUsers();
                    fetchAuditLogs();
                    fetchServerSettings();
                    fetchTenants();
                    fetchPermissions();
                    fetchClusters();
                    fetchClusterGroups();
                    fetchRoles();
                    fetchTemplates();
                    fetchPasswordPolicy();
                }
            }, [isOpen]);
            
            // NS: Listen for navigate-to-updates event from update notification modal
            useEffect(() => {
                const handleNavigateUpdates = () => {
                    setActiveTab('updates');
                    checkForUpdates();
                };
                window.addEventListener('pegaprox-navigate-updates', handleNavigateUpdates);
                return () => window.removeEventListener('pegaprox-navigate-updates', handleNavigateUpdates);
            }, []);
            
            // Fetch password policy - NS Jan 2026
            const fetchPasswordPolicy = async () => {
                try {
                    const r = await fetch(`${API_URL}/password-policy`);
                    if (r.ok) {
                        const data = await r.json();
                        setPasswordPolicy(data);
                    }
                } catch (e) {
                    console.error('fetchPasswordPolicy error:', e);
                }
            };
            
            // Generate password policy hint from fetched policy - NS Jan 2026
            const getSettingsPasswordPolicyHint = () => {
                const hints = [];
                hints.push(`${t('minChars') || 'Min.'} ${passwordPolicy.min_length || 8} ${t('characters') || 'characters'}`);
                if (passwordPolicy.require_uppercase !== false) hints.push(t('uppercase') || 'uppercase');
                if (passwordPolicy.require_lowercase !== false) hints.push(t('lowercase') || 'lowercase');
                if (passwordPolicy.require_numbers !== false) hints.push(t('numbers') || 'number');
                if (passwordPolicy.require_special) hints.push(t('specialChar') || 'special char');
                return hints.join(', ');
            };
            
            // fetch tenants - NS
            // LW: added error logging after it silently failed once during testing
            const fetchTenants = async () => {
                try {
                    const r = await fetch(`${API_URL}/tenants`, { headers: getAuthHeaders() });
                    if(r.ok) setTenants(await r.json());
                    else console.warn('Failed to fetch tenants:', r.status);
                } catch(e) { console.error('fetchTenants error:', e); }
            };
            
            // fetch clusters for tenant assignment
            const fetchClusters = async () => {
                try {
                    const r = await fetch(`${API_URL}/clusters`, { headers: getAuthHeaders() });
                    if(r.ok) setClusters(await r.json());
                } catch(e) {}
            };
            
            // fetch cluster groups - NS Jan 2026
            const fetchClusterGroups = async () => {
                try {
                    const r = await fetch(`${API_URL}/cluster-groups`, { headers: getAuthHeaders() });
                    if(r.ok) setClusterGroups(await r.json());
                } catch(e) { console.error('fetchClusterGroups error:', e); }
            };
            
            // fetch all roles (builtin + custom) - NS
            const fetchRoles = async () => {
                try {
                    const r = await fetch(`${API_URL}/roles`, { headers: getAuthHeaders() });
                    if(r.ok) setAllRoles(await r.json());
                } catch(e) {}
            };
            
            // check for updates on component mount
            const checkForUpdates = async () => {
                setUpdateLoading(true);
                setUpdateError(null);
                try {
                    const r = await fetch(`${API_URL}/pegaprox/check-update`, { headers: getAuthHeaders() });
                    const data = await r.json();
                    setUpdateInfo(data);
                    // Show error if present but still have version info
                    if (data.error) {
                        setUpdateError(data.error);
                    }
                } catch (e) {
                    setUpdateError('Network error checking for updates');
                } finally {
                    setUpdateLoading(false);
                }
            };
            
            // Perform update
            const performUpdate = async () => {
                if (!confirm(t('confirmUpdate') || 'This will download and install the update. A backup will be created. The server will restart automatically. Continue?')) return;
                setUpdateLoading(true);
                setUpdateProgress({ status: 'downloading', message: t('downloadingUpdate') || 'Downloading update...' });
                try {
                    const r = await fetch(`${API_URL}/pegaprox/update`, {
                        method: 'POST',
                        credentials: 'include',
                        headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
                        body: JSON.stringify({})
                    });
                    const data = await r.json();
                    if (r.ok && data.success) {
                        if (data.restarting) {
                            setUpdateProgress({ status: 'restarting', message: t('serverRestarting') || `Server restarting in ${data.restart_delay || 3} seconds...` });
                            addToast(t('updateSuccessRestarting') || 'Update installed! Server is restarting...', 'success');
                            
                            // Wait and then try to reconnect
                            setTimeout(() => {
                                setUpdateProgress({ status: 'reconnecting', message: t('reconnecting') || 'Reconnecting...' });
                                // Poll until server is back
                                const pollInterval = setInterval(async () => {
                                    try {
                                        const healthCheck = await fetch(`${API_URL}/pegaprox/version`, { 
                                            credentials: 'include',
                                            headers: getAuthHeaders() 
                                        });
                                        if (healthCheck.ok) {
                                            clearInterval(pollInterval);
                                            setUpdateProgress(null);
                                            addToast(t('updateComplete') || 'Update complete! Please refresh the page.', 'success');
                                            // Refresh page after short delay
                                            setTimeout(() => window.location.reload(), 2000);
                                        }
                                    } catch (e) {
                                        // Server still restarting
                                    }
                                }, 2000);
                                
                                // Stop polling after 60 seconds
                                setTimeout(() => clearInterval(pollInterval), 60000);
                            }, (data.restart_delay || 3) * 1000 + 2000);
                        } else {
                            addToast(t('updatePrepared') || 'Update prepared! Check instructions below.', 'success');
                            setUpdateInfo(prev => ({ ...prev, instructions: data.instructions, backup_path: data.backup_path }));
                            setUpdateProgress(null);
                        }
                    } else if (data.message === 'Already up to date') {
                        addToast(t('alreadyUpToDate') || 'Already up to date!', 'info');
                        setUpdateProgress(null);
                    } else {
                        addToast(data.error || t('updateFailed') || 'Update failed', 'error');
                        setUpdateProgress(null);
                    }
                } catch (e) {
                    addToast(t('errorPerformingUpdate') || 'Error performing update', 'error');
                    setUpdateProgress(null);
                } finally {
                    setUpdateLoading(false);
                }
            };
            
            // NS: Load available backups for rollback - Jan 2026
            const loadBackups = async () => {
                try {
                    const r = await fetch(`${API_URL}/pegaprox/update/rollback`, {
                        method: 'POST',
                        credentials: 'include',
                        headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
                        body: JSON.stringify({})
                    });
                    const data = await r.json();
                    if (data.backups) {
                        setAvailableBackups(data.backups);
                    }
                } catch (e) {
                    console.error('Error loading backups:', e);
                }
            };
            
            // NS: Perform rollback - Jan 2026
            const performRollback = async (backupName) => {
                if (!confirm(t('confirmRollback') || `This will restore PegaProx from backup "${backupName}". The server will restart. Continue?`)) return;
                setUpdateLoading(true);
                setUpdateProgress({ status: 'restoring', message: t('restoringBackup') || 'Restoring from backup...' });
                try {
                    const r = await fetch(`${API_URL}/pegaprox/update/rollback`, {
                        method: 'POST',
                        credentials: 'include',
                        headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
                        body: JSON.stringify({ backup: backupName })
                    });
                    const data = await r.json();
                    if (r.ok && data.success) {
                        setShowRollbackModal(false);
                        addToast(t('rollbackSuccess') || 'Rollback successful! Server is restarting...', 'success');
                        setUpdateProgress({ status: 'restarting', message: t('serverRestarting') || 'Server restarting...' });
                        
                        // Poll for reconnection
                        setTimeout(() => {
                            const pollInterval = setInterval(async () => {
                                try {
                                    const healthCheck = await fetch(`${API_URL}/pegaprox/version`, { 
                                        credentials: 'include',
                                        headers: getAuthHeaders() 
                                    });
                                    if (healthCheck.ok) {
                                        clearInterval(pollInterval);
                                        setUpdateProgress(null);
                                        setTimeout(() => window.location.reload(), 2000);
                                    }
                                } catch (e) { }
                            }, 2000);
                            setTimeout(() => clearInterval(pollInterval), 60000);
                        }, 5000);
                    } else {
                        addToast(data.error || t('rollbackFailed') || 'Rollback failed', 'error');
                        setUpdateProgress(null);
                    }
                } catch (e) {
                    addToast(t('errorRollback') || 'Error performing rollback', 'error');
                    setUpdateProgress(null);
                } finally {
                    setUpdateLoading(false);
                }
            };
            
            // create custom role
            const handleCreateRole = async (e) => {
                e && e.preventDefault();
                try {
                    const r = await fetch(`${API_URL}/roles`, {
                        method: 'POST',
                        headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
                        body: JSON.stringify(newRole)
                    });
                    if(r.ok) {
                        setShowAddRole(false);
                        setNewRole({ id: '', name: '', permissions: [], tenant_id: '' });
                        fetchRoles();
                        addToast(t('roleCreated') || 'Role created', 'success');
                    } else {
                        const err = await r.json();
                        addToast(err.error || 'Failed', 'error');
                    }
                } catch(e) { addToast('Error creating role', 'error'); }
            };
            
            // update custom role
            const handleUpdateRole = async (roleId, data) => {
                try {
                    const r = await fetch(`${API_URL}/roles/${roleId}`, {
                        method: 'PUT',
                        headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                    if(r.ok) {
                        setEditingRole(null);
                        fetchRoles();
                        addToast(t('roleSaved') || 'Role saved', 'success');
                    }
                } catch(e) {}
            };
            
            // delete custom role
            const handleDeleteRole = async (roleId, tenantId) => {
                if(!confirm(t('confirmDeleteRole') || 'Delete this role?')) return;
                try {
                    let url = `${API_URL}/roles/${roleId}`;
                    if(tenantId) url += `?tenant_id=${tenantId}`;
                    const r = await fetch(url, { method: 'DELETE', headers: getAuthHeaders() });
                    if(r.ok) {
                        fetchRoles();
                        addToast(t('roleDeleted') || 'Role deleted', 'success');
                    }
                } catch(e) {}
            };
            
            
            // role templates state - NS
            const [roleTemplates, setRoleTemplates] = useState([]);
            const [showTemplateModal, setShowTemplateModal] = useState(false);
            const [selectedTemplate, setSelectedTemplate] = useState(null);
            const [templateConfig, setTemplateConfig] = useState({ role_id: '', name: '', tenant_id: '' });
            
            // fetch role templates
            const fetchTemplates = async () => {
                try {
                    const r = await fetch(`${API_URL}/roles/templates`, { headers: getAuthHeaders() });
                    if(r.ok) setRoleTemplates(await r.json());
                } catch(e) {}
            };
            
            // apply template
            const handleApplyTemplate = async () => {
                if(!selectedTemplate) return;
                try {
                    const r = await fetch(`${API_URL}/roles/templates/${selectedTemplate.id}/apply`, {
                        method: 'POST',
                        headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
                        body: JSON.stringify(templateConfig)
                    });
                    if(r.ok) {
                        setShowTemplateModal(false);
                        setSelectedTemplate(null);
                        setTemplateConfig({ role_id: '', name: '', tenant_id: '' });
                        fetchRoles();
                        addToast(t('roleCreatedFromTemplate') || 'Role created from template', 'success');
                    } else {
                        const err = await r.json();
                        addToast(err.error || 'Failed', 'error');
                    }
                } catch(e) { addToast('Error', 'error'); }
            };
            
            // VM ACL state - NS: Dec 2025
            // AI-assisted: Claude helped with the ACL data structure
            const [vmAcls, setVmAcls] = useState([]);
            const [selectedVmForAcl, setSelectedVmForAcl] = useState(null);
            const [showVmAclModal, setShowVmAclModal] = useState(false);
            const [vmAclUsers, setVmAclUsers] = useState([]);
            const [vmAclPerms, setVmAclPerms] = useState([]);
            const [vmAclInherit, setVmAclInherit] = useState(true);
            const [availableVms, setAvailableVms] = useState([]);
            const [selectedClusterForAcl, setSelectedClusterForAcl] = useState('');
            
            // fetch VMs for ACL management - LW: Dec 2025
            const fetchVmsForAcl = async (clusterId) => {
                if(!clusterId) return;
                try {
                    const r = await fetch(`${API_URL}/clusters/${clusterId}/vms`, { headers: getAuthHeaders() });
                    if(r.ok) {
                        const data = await r.json();
                        setAvailableVms(data.vms || []);
                    }
                } catch(e) { /* silently fail, user will see empty list */ }
            };
            
            // fetch VM ACLs for a cluster
            const fetchVmAcls = async (clusterId) => {
                if(!clusterId) return;
                try {
                    const r = await fetch(`${API_URL}/clusters/${clusterId}/vm-acls`, { headers: getAuthHeaders() });
                    if(r.ok) setVmAcls(await r.json());
                } catch(e) {}
            };
            
            // save VM ACL
            const saveVmAcl = async () => {
                if(!selectedClusterForAcl || !selectedVmForAcl) return;
                try {
                    const r = await fetch(`${API_URL}/clusters/${selectedClusterForAcl}/vm-acls/${selectedVmForAcl}`, {
                        method: 'PUT',
                        headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            users: vmAclUsers,
                            permissions: vmAclPerms,
                            inherit_role: vmAclInherit
                        })
                    });
                    if(r.ok) {
                        setShowVmAclModal(false);
                        fetchVmAcls(selectedClusterForAcl);
                        addToast(t('vmAclSaved') || 'VM permissions saved', 'success');
                    }
                } catch(e) { addToast('Error', 'error'); }
            };
            
            // delete VM ACL
            const deleteVmAcl = async (vmid) => {
                if(!selectedClusterForAcl) return;
                if(!confirm(t('confirmDeleteVmAcl') || 'Remove custom permissions for this VM?')) return;
                try {
                    const r = await fetch(`${API_URL}/clusters/${selectedClusterForAcl}/vm-acls/${vmid}`, {
                        method: 'DELETE',
                        headers: getAuthHeaders()
                    });
                    if(r.ok) {
                        fetchVmAcls(selectedClusterForAcl);
                        addToast(t('vmAclDeleted') || 'VM permissions removed', 'success');
                    }
                } catch(e) {}
            };
            
            // Pool Permissions functions - MK Jan 2026
            const fetchPools = async (clusterId) => {
                if (!clusterId) return;
                try {
                    const r = await fetch(`${API_URL}/clusters/${clusterId}/pools`, { 
                        credentials: 'include',
                        headers: getAuthHeaders() 
                    });
                    if (r.ok) {
                        const data = await r.json();
                        setPools(data);
                    }
                } catch(e) {
                    console.error('Failed to fetch pools:', e);
                }
            };
            
            const fetchPoolPermissions = async (clusterId, poolId) => {
                if (!clusterId || !poolId) return;
                try {
                    const r = await fetch(`${API_URL}/clusters/${clusterId}/pools/${poolId}/permissions`, { 
                        credentials: 'include',
                        headers: getAuthHeaders() 
                    });
                    if (r.ok) {
                        const data = await r.json();
                        setPoolPermissions(data.permissions || []);
                        setAvailablePoolPerms(data.available_permissions || []);
                    }
                } catch(e) {
                    console.error('Failed to fetch pool permissions:', e);
                }
            };
            
            const savePoolPermission = async () => {
                if (!selectedPoolCluster || !selectedPool || !poolPermForm.subject_id) return;
                try {
                    const r = await fetch(`${API_URL}/clusters/${selectedPoolCluster}/pools/${selectedPool}/permissions`, {
                        method: 'POST',
                        credentials: 'include',
                        headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
                        body: JSON.stringify(poolPermForm)
                    });
                    if (r.ok) {
                        setShowPoolPermModal(false);
                        fetchPoolPermissions(selectedPoolCluster, selectedPool);
                        addToast(t('poolPermSaved') || 'Pool permission saved', 'success');
                        setPoolPermForm({ subject_type: 'user', subject_id: '', permissions: [] });
                    } else {
                        const err = await r.json();
                        addToast(err.error || 'Error saving permission', 'error');
                    }
                } catch(e) {
                    addToast('Error saving permission', 'error');
                }
            };
            
            const deletePoolPermission = async (subjectType, subjectId) => {
                if (!selectedPoolCluster || !selectedPool) return;
                if (!confirm(t('confirmDeletePoolPerm') || `Remove permission for ${subjectId}?`)) return;
                try {
                    const r = await fetch(`${API_URL}/clusters/${selectedPoolCluster}/pools/${selectedPool}/permissions/${subjectType}/${subjectId}`, {
                        method: 'DELETE',
                        credentials: 'include',
                        headers: getAuthHeaders()
                    });
                    if (r.ok) {
                        fetchPoolPermissions(selectedPoolCluster, selectedPool);
                        addToast(t('poolPermDeleted') || 'Pool permission removed', 'success');
                    }
                } catch(e) {}
            };
            
            // MK: Refresh pool cache from Proxmox
            const refreshPoolCache = async (clusterId) => {
                if (!clusterId) return;
                try {
                    const r = await fetch(`${API_URL}/clusters/${clusterId}/pools/refresh-cache`, {
                        method: 'POST',
                        credentials: 'include',
                        headers: getAuthHeaders()
                    });
                    if (r.ok) {
                        const data = await r.json();
                        addToast(data.message || 'Pool cache refreshed', 'success');
                        // Refresh pools list
                        fetchPools(clusterId);
                    } else {
                        addToast('Failed to refresh pool cache', 'error');
                    }
                } catch(e) {
                    addToast('Failed to refresh pool cache', 'error');
                }
            };
            
            // ================================================================
            // Pool Management Functions - NS Jan 2026
            // ================================================================
            
            const createPool = async () => {
                if (!selectedPoolCluster || !newPoolForm.poolid.trim()) {
                    addToast(t('poolIdRequired') || 'Pool ID is required', 'error');
                    return;
                }
                
                setPoolManagerLoading(true);
                try {
                    const r = await fetch(`${API_URL}/clusters/${selectedPoolCluster}/pools`, {
                        method: 'POST',
                        headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            poolid: newPoolForm.poolid.trim(),
                            comment: newPoolForm.comment.trim()
                        })
                    });
                    
                    const data = await r.json();
                    if (r.ok) {
                        addToast(data.message || t('poolCreated') || 'Pool created successfully', 'success');
                        setShowCreatePool(false);
                        setNewPoolForm({ poolid: '', comment: '' });
                        // Small delay to let Proxmox process the change
                        setTimeout(() => fetchPools(selectedPoolCluster), 300);
                    } else {
                        addToast(data.error || 'Failed to create pool', 'error');
                    }
                } catch(e) {
                    addToast('Failed to create pool', 'error');
                } finally {
                    setPoolManagerLoading(false);
                }
            };
            
            const updatePool = async () => {
                if (!selectedPoolCluster || !editingPool) return;
                
                setPoolManagerLoading(true);
                try {
                    const r = await fetch(`${API_URL}/clusters/${selectedPoolCluster}/pools/${editingPool.poolid}`, {
                        method: 'PUT',
                        headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            comment: editingPool.comment || ''
                        })
                    });
                    
                    const data = await r.json();
                    if (r.ok) {
                        addToast(data.message || t('poolUpdated') || 'Pool updated successfully', 'success');
                        setEditingPool(null);
                        setTimeout(() => fetchPools(selectedPoolCluster), 300);
                    } else {
                        addToast(data.error || 'Failed to update pool', 'error');
                    }
                } catch(e) {
                    addToast('Failed to update pool', 'error');
                } finally {
                    setPoolManagerLoading(false);
                }
            };
            
            const deletePool = async (poolId) => {
                if (!selectedPoolCluster || !poolId) return;
                if (!confirm(t('confirmDeletePool') || `Are you sure you want to delete pool "${poolId}"? This cannot be undone.`)) return;
                
                setPoolManagerLoading(true);
                try {
                    const r = await fetch(`${API_URL}/clusters/${selectedPoolCluster}/pools/${poolId}`, {
                        method: 'DELETE',
                        headers: getAuthHeaders()
                    });
                    
                    const data = await r.json();
                    if (r.ok) {
                        addToast(data.message || t('poolDeleted') || 'Pool deleted successfully', 'success');
                        if (selectedPool === poolId) {
                            setSelectedPool(null);
                            setPoolPermissions([]);
                        }
                        setTimeout(() => fetchPools(selectedPoolCluster), 300);
                    } else {
                        addToast(data.error || 'Failed to delete pool', 'error');
                    }
                } catch(e) {
                    addToast('Failed to delete pool', 'error');
                } finally {
                    setPoolManagerLoading(false);
                }
            };
            
            const fetchVmsWithoutPool = async (clusterId) => {
                if (!clusterId) return;
                try {
                    const r = await fetch(`${API_URL}/clusters/${clusterId}/vms-without-pool`, {
                        headers: getAuthHeaders()
                    });
                    if (r.ok) {
                        const data = await r.json();
                        setVmsWithoutPool(data);
                    }
                } catch(e) {
                    console.error('Failed to fetch VMs without pool:', e);
                }
            };
            
            const addVmToPool = async (poolId, vmid) => {
                if (!selectedPoolCluster || !poolId || !vmid) return;
                
                setPoolManagerLoading(true);
                try {
                    const r = await fetch(`${API_URL}/clusters/${selectedPoolCluster}/pools/${poolId}/members`, {
                        method: 'POST',
                        headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
                        body: JSON.stringify({ vmid: vmid })
                    });
                    
                    const data = await r.json();
                    if (r.ok) {
                        addToast(data.message || t('vmAddedToPool') || 'VM added to pool', 'success');
                        setTimeout(() => {
                            fetchPools(selectedPoolCluster);
                            fetchVmsWithoutPool(selectedPoolCluster);
                        }, 300);
                    } else {
                        addToast(data.error || 'Failed to add VM to pool', 'error');
                    }
                } catch(e) {
                    addToast('Failed to add VM to pool', 'error');
                } finally {
                    setPoolManagerLoading(false);
                }
            };
            
            const removeVmFromPool = async (poolId, vmid) => {
                if (!selectedPoolCluster || !poolId || !vmid) return;
                if (!confirm(t('confirmRemoveVmFromPool') || `Remove VM ${vmid} from pool "${poolId}"?`)) return;
                
                setPoolManagerLoading(true);
                try {
                    const r = await fetch(`${API_URL}/clusters/${selectedPoolCluster}/pools/${poolId}/members/${vmid}`, {
                        method: 'DELETE',
                        headers: getAuthHeaders()
                    });
                    
                    const data = await r.json();
                    if (r.ok) {
                        addToast(data.message || t('vmRemovedFromPool') || 'VM removed from pool', 'success');
                        setTimeout(() => fetchPools(selectedPoolCluster), 300);
                    } else {
                        addToast(data.error || 'Failed to remove VM from pool', 'error');
                    }
                } catch(e) {
                    addToast('Failed to remove VM from pool', 'error');
                } finally {
                    setPoolManagerLoading(false);
                }
            };
            
            // fetch all permissions
            const fetchPermissions = async () => {
                try {
                    const [permsRes, rolesRes] = await Promise.all([
                        fetch(`${API_URL}/permissions`, { headers: getAuthHeaders() }),
                        fetch(`${API_URL}/permissions/roles`, { headers: getAuthHeaders() })
                    ]);
                    if(permsRes.ok) setAllPermissions(await permsRes.json());
                    if(rolesRes.ok) setRolePermissions(await rolesRes.json());
                } catch(e) {}
            };
            
            // fetch user permissions
            const fetchUserPermissions = async (username) => {
                try {
                    const r = await fetch(`${API_URL}/users/${username}/permissions`, { headers: getAuthHeaders() });
                    if(r.ok) setUserPermissions(await r.json());
                } catch(e) {}
            };
            
            const fetchServerSettings = async () => {
                try {
                    const response = await fetch(`${API_URL}/settings/server`, {
                        credentials: 'include',
                        headers: getAuthHeaders()
                    });
                    if (response && response.ok) {
                        const data = await response.json();
                        setServerSettings(prev => ({
                            ...prev,
                            // Server settings
                            domain: data.domain || '',
                            port: data.port || 5000,
                            ssl_enabled: data.ssl_enabled || false,
                            ssl_cert: data.ssl_cert_exists ? '(Zertifikat vorhanden)' : '',
                            ssl_key: data.ssl_key_exists ? '(Schl√ºssel vorhanden)' : '',
                            http_redirect_port: data.http_redirect_port || 0,
                            default_theme: data.default_theme || 'proxmoxDark',
                            // SMTP settings
                            smtp_enabled: data.smtp_enabled || false,
                            smtp_host: data.smtp_host || '',
                            smtp_port: data.smtp_port || 587,
                            smtp_user: data.smtp_user || '',
                            smtp_password: data.smtp_password || '',
                            smtp_from_email: data.smtp_from_email || '',
                            smtp_from_name: data.smtp_from_name || 'PegaProx Alerts',
                            smtp_tls: data.smtp_tls !== false,
                            smtp_ssl: data.smtp_ssl || false,
                            // Alert settings
                            alert_email_recipients: data.alert_email_recipients || [],
                            alert_cooldown: data.alert_cooldown || 300,
                            // Security settings
                            login_max_attempts: data.login_max_attempts || 5,
                            login_lockout_time: data.login_lockout_time || 300,
                            login_attempt_window: data.login_attempt_window || 300,
                            // Password policy
                            password_min_length: data.password_min_length || 8,
                            password_require_uppercase: data.password_require_uppercase || false,
                            password_require_lowercase: data.password_require_lowercase || false,
                            password_require_numbers: data.password_require_numbers || false,
                            password_require_special: data.password_require_special || false,
                            // Password expiry
                            password_expiry_enabled: data.password_expiry_enabled || false,
                            password_expiry_days: data.password_expiry_days || 90,
                            password_expiry_warning_days: data.password_expiry_warning_days || 14,
                            password_expiry_email_enabled: data.password_expiry_email_enabled !== false,
                            password_expiry_include_admins: data.password_expiry_include_admins || false,
                            // Session
                            session_timeout: data.session_timeout || 86400
                        }));
                    }
                } catch (err) {
                    console.error('fetching server settings:', err);
                }
            };
            
            const handleSaveServerSettings = async () => {
                setServerLoading(true);
                try {
                    const formData = new FormData();
                    formData.append('domain', serverSettings.domain);
                    formData.append('port', serverSettings.port);
                    formData.append('http_redirect_port', serverSettings.http_redirect_port || 0);
                    formData.append('ssl_enabled', serverSettings.ssl_enabled);
                    formData.append('default_theme', serverSettings.default_theme || 'proxmoxDark');
                    
                    if (serverSettings.ssl_cert_file) {
                        formData.append('ssl_cert', serverSettings.ssl_cert_file);
                    }
                    if (serverSettings.ssl_key_file) {
                        formData.append('ssl_key', serverSettings.ssl_key_file);
                    }
                    
                    const response = await fetch(`${API_URL}/settings/server`, {
                        method: 'POST',
                        credentials: 'include',  // Important: send session cookie
                        body: formData
                    });
                    
                    if (response && response.ok) {
                        const data = await response.json();
                        addToast(t('serverSettingsSaved'), 'success');
                        if (data.restart_required) {
                            addToast(t('restartRequired'), 'info');
                        }
                        fetchServerSettings();
                    } else {
                        const err = await response.json();
                        addToast(err.error || t('errorSavingSettings'), 'error');
                    }
                } catch (err) {
                    addToast(t('errorSavingSettings'), 'error');
                }
                setServerLoading(false);
            };
            
            const handleCertFileChange = (e, type) => {
                const file = e.target.files[0];
                if (file) {
                    if (type === 'cert') {
                        setServerSettings(prev => ({ ...prev, ssl_cert_file: file, ssl_cert: file.name }));
                    } else {
                        setServerSettings(prev => ({ ...prev, ssl_key_file: file, ssl_key: file.name }));
                    }
                }
            };
            
            // Save SMTP Settings - NS Jan 2026
            const [smtpLoading, setSmtpLoading] = useState(false);
            
            const handleSaveSMTPSettings = async () => {
                setSmtpLoading(true);
                try {
                    const response = await fetch(`${API_URL}/settings/server`, {
                        method: 'POST',
                        credentials: 'include',
                        headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            smtp_enabled: serverSettings.smtp_enabled,
                            smtp_host: serverSettings.smtp_host,
                            smtp_port: serverSettings.smtp_port,
                            smtp_user: serverSettings.smtp_user,
                            smtp_password: serverSettings.smtp_password,
                            smtp_from_email: serverSettings.smtp_from_email,
                            smtp_from_name: serverSettings.smtp_from_name,
                            smtp_tls: serverSettings.smtp_tls,
                            smtp_ssl: serverSettings.smtp_ssl,
                            alert_email_recipients: serverSettings.alert_email_recipients,
                            alert_cooldown: serverSettings.alert_cooldown
                        })
                    });
                    
                    if (response && response.ok) {
                        addToast(t('smtpSettingsSaved') || 'SMTP settings saved!', 'success');
                        fetchServerSettings();
                    } else {
                        const err = await response.json();
                        addToast(err.error || t('errorSavingSettings'), 'error');
                    }
                } catch (err) {
                    console.error('Save SMTP error:', err);
                    addToast(t('errorSavingSettings'), 'error');
                }
                setSmtpLoading(false);
            };
            
            // Test Email Function - NS Jan 2026
            const handleTestEmail = async () => {
                if (!testEmailAddress) {
                    addToast(t('enterEmailAddress') || 'Please enter an email address', 'error');
                    return;
                }
                
                // Validate required SMTP fields before sending
                if (!serverSettings.smtp_host) {
                    addToast(t('smtpHostRequired') || 'SMTP host is required', 'error');
                    return;
                }
                if (!serverSettings.smtp_from_email) {
                    addToast(t('smtpFromEmailRequired') || 'From email address is required', 'error');
                    return;
                }
                
                setTestEmailLoading(true);
                try {
                    const response = await fetch(`${API_URL}/settings/smtp/test`, {
                        method: 'POST',
                        credentials: 'include',
                        headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            email: testEmailAddress,
                            // Include current SMTP settings in case they haven't been saved yet
                            smtp_host: serverSettings.smtp_host,
                            smtp_port: serverSettings.smtp_port || 587,
                            smtp_user: serverSettings.smtp_user || '',
                            smtp_password: serverSettings.smtp_password || '',
                            smtp_from_email: serverSettings.smtp_from_email,
                            smtp_from_name: serverSettings.smtp_from_name || 'PegaProx Alerts',
                            smtp_tls: serverSettings.smtp_tls !== false,
                            smtp_ssl: serverSettings.smtp_ssl || false
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok && data.success) {
                        addToast(data.message || t('testEmailSuccess') || 'Test email sent!', 'success');
                    } else {
                        addToast(data.error || t('testEmailFailed') || 'Failed to send test email', 'error');
                    }
                } catch (err) {
                    console.error('Test email error:', err);
                    addToast(t('testEmailFailed') || 'Failed to send test email', 'error');
                }
                setTestEmailLoading(false);
            };
            
            const handleRestartServer = async () => {
                setRestartLoading(true);
                try {
                    const response = await fetch(`${API_URL}/settings/server/restart`, {
                        method: 'POST',
                        headers: getAuthHeaders()
                    });
                    
                    if (response && response.ok) {
                        addToast(t('restartInitiated'), 'success');
                        setShowRestartConfirm(false);
                        // Show reconnecting message after a short delay
                        setTimeout(() => {
                            addToast(t('reconnecting'), 'info');
                        }, 2000);
                        // Try to reconnect after server restart
                        setTimeout(() => {
                            window.location.reload();
                        }, 5000);
                    } else {
                        const err = await response.json();
                        addToast(err.error || t('restartFailed'), 'error');
                    }
                } catch (err) {
                    // Expected - server is restarting
                    addToast(t('restartInitiated'), 'success');
                    setShowRestartConfirm(false);
                    setTimeout(() => {
                        window.location.reload();
                    }, 5000);
                }
                setRestartLoading(false);
            };
            
            const fetchUsers = async () => {
                try {
                    const response = await fetch(`${API_URL}/users`, {
                        headers: getAuthHeaders()
                    });
                    if (response && response.ok) {
                        const data = await response.json();
                        setUsers(data);
                    }
                } catch (err) {
                    console.error('fetching users:', err);
                }
            };
            
            const fetchAuditLogs = async () => {
                try {
                    const response = await fetch(`${API_URL}/audit`, {
                        headers: getAuthHeaders()
                    });
                    if (response && response.ok) {
                        const data = await response.json();
                        setAuditLogs(data);
                    }
                } catch (err) {
                    console.error('fetching audit logs:', err);
                }
            };
            
            
            const fetchSnapshots = async (body = null) => {
                try {
                    const res = await fetch(`${API_URL}/snapshots/overview`, {
                        method: body ? 'POST' : 'GET',
                        headers: body ? { 'Content-Type': 'application/json', ...getAuthHeaders() } : getAuthHeaders(),
                        credentials: 'include',
                        body: body ? JSON.stringify(body) : undefined
                    });
                    if (!res.ok) {
                        throw new Error(`HTTP ${res.status}`);
                    }
                    const data = await res.json();
                    setSnapshots(data.snapshots ?? data ?? []);
                } catch (err) {
                    console.error('Snapshot fetch failed:', err);
                    setSnapshots([]);
                }
            };
            
            const applySnapshotFilter = async () => {
                await fetchSnapshots({
                    date: filterDate,
                    tab: snapshotsSubTab
                });
            };
            
            const deleteSnapshot = async (snap) => {
                if (!window.confirm(`Delete snapshot "${snap.snapshot_name}" from VM ${snap.vmid}?`)) {
                    return;
                }
                try {
                    await fetch(`${API_URL}/snapshots/delete`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', ...getAuthHeaders() },
                        credentials: 'include',
                        body: JSON.stringify({ snapshots: [snap] })
                    });
                    addToast('Snapshot deleted', 'success');
                    await fetchSnapshots(filterDate ? { date: filterDate, tab: snapshotsSubTab } : null);
                } catch (err) {
                    console.error('Snapshot delete failed:', err);
                    addToast('Failed to delete snapshot', 'error');
                }
            };
            
            const handleResetPassword = async (username) => {
                if (!newPasswordValue || newPasswordValue.length < 4) {
                    addToast(t('passwordTooShort'), 'error');
                    return;
                }
                
                try {
                    const response = await fetch(`${API_URL}/users/${username}/password`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            ...getAuthHeaders()
                        },
                        body: JSON.stringify({ password: newPasswordValue })
                    });
                    
                    if (response && response.ok) {
                        addToast(t('passwordResetSuccess'), 'success');
                        setPasswordResetUser(null);
                        setNewPasswordValue('');
                        fetchAuditLogs();
                    } else {
                        const data = await response.json();
                        addToast(data.error || 'Error resetting password', 'error');
                    }
                } catch (err) {
                    addToast('Error resetting password', 'error');
                }
            };
            
            const handleDisable2FA = async (username) => {
                if (!confirm(`${t('disable2FA')} f√ºr ${username}?`)) return;
                
                try {
                    const response = await fetch(`${API_URL}/users/${username}/2fa`, {
                        method: 'DELETE',
                        credentials: 'include',  // MK: Fix - need cookies for session auth
                        headers: getAuthHeaders()
                    });
                    
                    if (response && response.ok) {
                        addToast(t('twoFactorDisabled'), 'success');
                        fetchUsers();
                        fetchAuditLogs();
                    } else {
                        const data = await response.json();
                        addToast(data.error || 'Error disabling 2FA', 'error');
                    }
                } catch (err) {
                    addToast('Error disabling 2FA', 'error');
                }
            };
            
            const handleCreateUser = async (e) => {
                e.preventDefault();
                setLoading(true);
                try {
                    const response = await fetch(`${API_URL}/users`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            ...getAuthHeaders()
                        },
                        body: JSON.stringify(newUser)
                    });
                    
                    if (response && response.ok) {
                        addToast(t('userCreated'), 'success');
                        setShowAddUser(false);
                        setNewUser({ username: '', password: '', display_name: '', email: '', role: 'user', tenant_id: 'default' });
                        fetchUsers();
                        fetchAuditLogs();
                        fetchTenants(); // LW: refresh tenant user counts
                    } else {
                        const data = await response.json();
                        addToast(data.error || 'Error creating user', 'error');
                    }
                } catch (err) {
                    addToast('Error creating user', 'error');
                }
                setLoading(false);
            };
            
            const handleUpdateUser = async (username, updates) => {
                try {
                    const response = await fetch(`${API_URL}/users/${username}`, {
                        method: 'PUT',
                        credentials: 'include',
                        headers: {
                            'Content-Type': 'application/json',
                            ...getAuthHeaders()
                        },
                        body: JSON.stringify(updates)
                    });
                    
                    if (response && response.ok) {
                        addToast(t('userUpdated'), 'success');
                        setEditingUser(null);
                        fetchUsers();
                        fetchAuditLogs();
                        fetchTenants(); // NS: refresh tenant user counts
                    } else {
                        const data = await response.json();
                        addToast(data.error || 'Error updating user', 'error');
                    }
                } catch (err) {
                    console.error('Error updating user:', err);
                    addToast('Error updating user', 'error');
                }
            };
            
            const handleDeleteUser = async (username) => {
                if (!confirm(t('deleteUserConfirm'))) return;
                
                try {
                    const response = await fetch(`${API_URL}/users/${username}`, {
                        method: 'DELETE',
                        credentials: 'include',
                        headers: getAuthHeaders()
                    });
                    
                    if (response && response.ok) {
                        addToast(t('userDeleted'), 'success');
                        fetchUsers();
                        fetchAuditLogs();
                    } else {
                        const data = await response.json();
                        addToast(data.error || 'Error deleting user', 'error');
                    }
                } catch (err) {
                    addToast('Error deleting user', 'error');
                }
            };
            
            const exportAuditLog = () => {
                const csv = [
                    ['Timestamp', 'User', 'Cluster', 'Action', 'Details', 'IP Address'].join(','),
                    ...filteredLogs.map(log => [
                        log.timestamp,
                        log.user,
                        log.cluster || '',
                        log.action,
                        `"${(log.details || '').replace(/"/g, '""')}"`,
                        log.ip_address || ''
                    ].join(','))
                ].join('\n');
                
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `pegaprox-audit-${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
                URL.revokeObjectURL(url);
            };
            
            const getActionLabel = (action) => {
                const labels = {
                    'user.login': t('userLogin'),
                    'user.logout': t('userLogout'),
                    'user.created': t('userCreated'),
                    'user.updated': t('userUpdated'),
                    'user.deleted': t('userDeleted'),
                    'user.password_changed': t('passwordChanged'),
                    'cluster.added': t('clusterAdded'),
                    'cluster.deleted': t('clusterDeleted'),
                    'cluster.config_changed': t('clusterConfigChanged'),
                    'vm.started': t('vmStarted'),
                    'vm.stopped': t('vmStopped'),
                    'vm.restarted': t('vmRestarted'),
                    'vm.created': t('vmCreated'),
                    'vm.deleted': t('vmDeleted'),
                    'vm.cloned': t('vmCloned'),
                    'vm.migrated': t('vmMigrated'),
                    'vm.bulk_migrated': t('vmBulkMigrated'),
                    'vm.config_changed': t('vmConfigChanged'),
                    'vm.suspended': t('vmSuspended'),
                    'vm.resumed': t('vmResumed'),
                    'vm.disk_added': t('vmDiskAdded'),
                    'vm.disk_removed': t('vmDiskRemoved'),
                    'vm.disk_resized': t('vmDiskResized'),
                    'vm.disk_moved': t('vmDiskMoved'),
                    'vm.network_added': t('vmNetworkAdded'),
                    'vm.network_removed': t('vmNetworkRemoved'),
                    'vm.network_updated': t('vmNetworkUpdated'),
                    'snapshot.created': t('snapshotCreated'),
                    'snapshot.deleted': t('snapshotDeleted'),
                    'snapshot.restored': t('snapshotRestored'),
                    'replication.created': t('replicationCreated'),
                    'replication.deleted': t('replicationDeleted'),
                    'replication.triggered': t('replicationTriggered'),
                    'ha.enabled': t('haEnabled'),
                    'ha.disabled': t('haDisabled'),
                    'ha.vm_added': t('haVmAdded'),
                    'ha.vm_removed': t('haVmRemoved'),
                    'node.maintenance_entered': t('nodeMaintenanceEntered'),
                    'node.maintenance_exited': t('nodeMaintenanceExited'),
                    'node.update_started': t('nodeUpdateStarted'),
                };
                return labels[action] || action;
            };
            
            const uniqueUsers = [...new Set(auditLogs.map(log => log.user))];
            const uniqueActions = [...new Set(auditLogs.map(log => log.action))];
            
            const filteredLogs = auditLogs.filter(log => {
                if (userFilter && log.user !== userFilter) return false;
                if (actionFilter && log.action !== actionFilter) return false;
                return true;
            });
            
            if (!isOpen) return null;
            
            return (
                <>
                <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/80" onClick={onClose}>
                    <div 
                        className="w-full max-w-5xl max-h-[90vh] bg-proxmox-card border border-proxmox-border rounded-2xl shadow-2xl overflow-hidden flex flex-col"
                        onClick={e => e.stopPropagation()}
                    >
                        {/* Header */}
                        <div className="p-6 border-b border-proxmox-border flex items-center justify-between">
                            <div className="flex items-center gap-3">
                                <div className="w-10 h-10 rounded-xl bg-proxmox-orange/20 flex items-center justify-center">
                                    <Icons.Settings />
                                </div>
                                <div>
                                    <h2 className="text-xl font-bold text-white">{t('pegaproxSettings')}</h2>
                                    <p className="text-sm text-gray-400">PegaProx {PEGAPROX_VERSION}</p>
                                </div>
                            </div>
                            <button onClick={onClose} className="p-2 rounded-lg hover:bg-proxmox-dark text-gray-400 hover:text-white">
                                <Icons.X />
                            </button>
                        </div>
                        
                        {/* Settings tabs */}
                        {/* Multi-tenancy was requested on r/selfhosted - turns out MSPs really need this */}
                        {/* NS: Changed to flex-wrap so tabs wrap to multiple lines instead of scrolling */}
                        <div className="flex flex-wrap border-b border-proxmox-border">
                            <button
                                onClick={() => setActiveTab('users')}
                                className={`flex items-center gap-2 px-4 py-2.5 text-sm font-medium transition-colors whitespace-nowrap ${
                                    activeTab === 'users'
                                        ? 'text-proxmox-orange border-b-2 border-proxmox-orange bg-proxmox-dark/50'
                                        : 'text-gray-400 hover:text-white hover:bg-proxmox-dark/30'
                                }`}
                            >
                                <Icons.Users className="w-4 h-4" />
                                <span className="hidden sm:inline">{t('userManagement')}</span>
                                <span className="sm:hidden">{t('users') || 'Users'}</span>
                            </button>
                            <button
                                onClick={() => setActiveTab('tenants')}
                                className={`flex items-center gap-2 px-4 py-2.5 text-sm font-medium transition-colors whitespace-nowrap ${
                                    activeTab === 'tenants'
                                        ? 'text-proxmox-orange border-b-2 border-proxmox-orange bg-proxmox-dark/50'
                                        : 'text-gray-400 hover:text-white hover:bg-proxmox-dark/30'
                                }`}
                            >
                                <Icons.Building className="w-4 h-4" />
                                <span>{t('tenants') || 'Tenants'}</span>
                            </button>
                            <button
                                onClick={() => setActiveTab('groups')}
                                className={`flex items-center gap-2 px-4 py-2.5 text-sm font-medium transition-colors whitespace-nowrap ${
                                    activeTab === 'groups'
                                        ? 'text-proxmox-orange border-b-2 border-proxmox-orange bg-proxmox-dark/50'
                                        : 'text-gray-400 hover:text-white hover:bg-proxmox-dark/30'
                                }`}
                            >
                                <Icons.Folder className="w-4 h-4" />
                                <span className="hidden sm:inline">{t('clusterGroups') || 'Cluster Groups'}</span>
                                <span className="sm:hidden">{t('groups') || 'Groups'}</span>
                            </button>
                            <button
                                onClick={() => setActiveTab('permissions')}
                                className={`flex items-center gap-2 px-4 py-2.5 text-sm font-medium transition-colors whitespace-nowrap ${
                                    activeTab === 'permissions'
                                        ? 'text-proxmox-orange border-b-2 border-proxmox-orange bg-proxmox-dark/50'
                                        : 'text-gray-400 hover:text-white hover:bg-proxmox-dark/30'
                                }`}
                            >
                                <Icons.Key className="w-4 h-4" />
                                <span>{t('permissions') || 'Permissions'}</span>
                            </button>
                            <button
                                onClick={() => setActiveTab('roles')}
                                className={`flex items-center gap-2 px-4 py-2.5 text-sm font-medium transition-colors whitespace-nowrap ${
                                    activeTab === 'roles'
                                        ? 'text-proxmox-orange border-b-2 border-proxmox-orange bg-proxmox-dark/50'
                                        : 'text-gray-400 hover:text-white hover:bg-proxmox-dark/30'
                                }`}
                            >
                                <Icons.Shield className="w-4 h-4" />
                                <span>{t('roles') || 'Roles'}</span>
                            </button>
                            <button
                                onClick={() => setActiveTab('security')}
                                className={`flex items-center gap-2 px-4 py-2.5 text-sm font-medium transition-colors whitespace-nowrap ${
                                    activeTab === 'security'
                                        ? 'text-proxmox-orange border-b-2 border-proxmox-orange bg-proxmox-dark/50'
                                        : 'text-gray-400 hover:text-white hover:bg-proxmox-dark/30'
                                }`}
                            >
                                <Icons.Lock className="w-4 h-4" />
                                <span className="hidden sm:inline">{t('securitySettings')}</span>
                                <span className="sm:hidden">{t('security') || 'Security'}</span>
                            </button>
                            <button
                                onClick={() => setActiveTab('compliance')}
                                className={`flex items-center gap-2 px-4 py-2.5 text-sm font-medium transition-colors whitespace-nowrap ${
                                    activeTab === 'compliance'
                                        ? 'text-proxmox-orange border-b-2 border-proxmox-orange bg-proxmox-dark/50'
                                        : 'text-gray-400 hover:text-white hover:bg-proxmox-dark/30'
                                }`}
                            >
                                <Icons.Check className="w-4 h-4" />
                                <span className="hidden sm:inline">{t('compliance') || 'Compliance'}</span>
                                <span className="sm:hidden">HIPAA</span>
                            </button>
                            <button
                                onClick={() => setActiveTab('server')}
                                className={`flex items-center gap-2 px-4 py-2.5 text-sm font-medium transition-colors whitespace-nowrap ${
                                    activeTab === 'server'
                                        ? 'text-proxmox-orange border-b-2 border-proxmox-orange bg-proxmox-dark/50'
                                        : 'text-gray-400 hover:text-white hover:bg-proxmox-dark/30'
                                }`}
                            >
                                <Icons.Server className="w-4 h-4" />
                                <span>{t('server') || 'Server'}</span>
                            </button>
                            <button
                                onClick={() => setActiveTab('audit')}
                                className={`flex items-center gap-2 px-4 py-2.5 text-sm font-medium transition-colors whitespace-nowrap ${
                                    activeTab === 'audit'
                                        ? 'text-proxmox-orange border-b-2 border-proxmox-orange bg-proxmox-dark/50'
                                        : 'text-gray-400 hover:text-white hover:bg-proxmox-dark/30'
                                }`}
                            >
                                <Icons.ClipboardList className="w-4 h-4" />
                                <span className="hidden sm:inline">{t('auditLog')}</span>
                                <span className="sm:hidden">Audit</span>
                            </button>
                            <button
                                onClick={() => { setActiveTab('updates'); checkForUpdates(); }}
                                className={`flex items-center gap-2 px-4 py-2.5 text-sm font-medium transition-colors whitespace-nowrap ${
                                    activeTab === 'updates'
                                        ? 'text-proxmox-orange border-b-2 border-proxmox-orange bg-proxmox-dark/50'
                                        : 'text-gray-400 hover:text-white hover:bg-proxmox-dark/30'
                                }`}
                            >
                                <Icons.Download className="w-4 h-4" />
                                <span>Updates</span>
                                {updateInfo?.update_available && (
                                    <span className="px-1.5 py-0.5 text-xs bg-green-500 text-white rounded-full">NEW</span>
                                )}
                            </button>
                            <button
                                onClick={() => setActiveTab('about')}
                                className={`flex items-center gap-2 px-4 py-2.5 text-sm font-medium transition-colors whitespace-nowrap ${
                                    activeTab === 'about'
                                        ? 'text-proxmox-orange border-b-2 border-proxmox-orange bg-proxmox-dark/50'
                                        : 'text-gray-400 hover:text-white hover:bg-proxmox-dark/30'
                                }`}
                            >
                                <Icons.Info className="w-4 h-4" />
                                <span>{t('about') || 'About'}</span>
                            </button>
                        </div>
                        
                        {/* Content */}
                        <div className="flex-1 overflow-auto p-6">
                            {activeTab === 'users' && (
                                <div className="space-y-4">
                                    {/* Add User Button */}
                                    <div className="flex justify-between items-center">
                                        <h3 className="text-lg font-semibold text-white">{t('users')}</h3>
                                        <button
                                            onClick={() => setShowAddUser(true)}
                                            className="flex items-center gap-2 px-4 py-2 bg-proxmox-orange hover:bg-orange-600 rounded-lg text-sm font-medium transition-colors"
                                        >
                                            <Icons.UserPlus />
                                            {t('addUser')}
                                        </button>
                                    </div>
                                    
                                    {/* Add User Form */}
                                    {showAddUser && (
                                        <div className="bg-proxmox-dark border border-proxmox-border rounded-xl p-4">
                                            <h4 className="text-white font-medium mb-4">{t('addUser')}</h4>
                                            <form onSubmit={handleCreateUser} className="grid grid-cols-2 gap-4">
                                                <div>
                                                    <label className="block text-sm text-gray-400 mb-1">{t('usernameLabel')}</label>
                                                    <input
                                                        type="text"
                                                        value={newUser.username}
                                                        onChange={e => setNewUser({...newUser, username: e.target.value})}
                                                        className="w-full px-3 py-2 bg-proxmox-darker border border-proxmox-border rounded-lg text-white text-sm focus:outline-none focus:border-proxmox-orange"
                                                        required
                                                    />
                                                </div>
                                                <div>
                                                    <label className="block text-sm text-gray-400 mb-1">{t('passwordLabel')}</label>
                                                    <input
                                                        type="password"
                                                        value={newUser.password}
                                                        onChange={e => setNewUser({...newUser, password: e.target.value})}
                                                        className="w-full px-3 py-2 bg-proxmox-darker border border-proxmox-border rounded-lg text-white text-sm focus:outline-none focus:border-proxmox-orange"
                                                        required
                                                    />
                                                    <p className="text-xs text-gray-500 mt-1">
                                                        {getSettingsPasswordPolicyHint()}
                                                    </p>
                                                </div>
                                                <div>
                                                    <label className="block text-sm text-gray-400 mb-1">{t('displayName')}</label>
                                                    <input
                                                        type="text"
                                                        value={newUser.display_name}
                                                        onChange={e => setNewUser({...newUser, display_name: e.target.value})}
                                                        className="w-full px-3 py-2 bg-proxmox-darker border border-proxmox-border rounded-lg text-white text-sm focus:outline-none focus:border-proxmox-orange"
                                                    />
                                                </div>
                                                <div>
                                                    <label className="block text-sm text-gray-400 mb-1">{t('email')}</label>
                                                    <input
                                                        type="email"
                                                        value={newUser.email}
                                                        onChange={e => setNewUser({...newUser, email: e.target.value})}
                                                        className="w-full px-3 py-2 bg-proxmox-darker border border-proxmox-border rounded-lg text-white text-sm focus:outline-none focus:border-proxmox-orange"
                                                    />
                                                </div>
                                                <div>
                                                    <label className="block text-sm text-gray-400 mb-1">{t('role')}</label>
                                                    <select
                                                        value={newUser.role}
                                                        onChange={e => {
                                                            const selectedRole = e.target.value;
                                                            // NS: Auto-select tenant when tenant-specific role is chosen
                                                            const roleObj = allRoles.find(r => r.id === selectedRole);
                                                            if (roleObj && roleObj.scope === 'tenant' && roleObj.tenant_id) {
                                                                setNewUser({...newUser, role: selectedRole, tenant_id: roleObj.tenant_id});
                                                            } else {
                                                                setNewUser({...newUser, role: selectedRole});
                                                            }
                                                        }}
                                                        className="w-full px-3 py-2 bg-proxmox-darker border border-proxmox-border rounded-lg text-white text-sm focus:outline-none focus:border-proxmox-orange"
                                                    >
                                                        <optgroup label={t('builtinRole') || 'Builtin Roles'}>
                                                            <option value="admin">{t('roleAdmin')}</option>
                                                            <option value="user">{t('roleUser')}</option>
                                                            <option value="viewer">{t('roleViewer')}</option>
                                                        </optgroup>
                                                        {allRoles.filter(r => !r.builtin && r.scope === 'global').length > 0 && (
                                                            <optgroup label={t('customRoles') || 'Custom Roles (Global)'}>
                                                                {allRoles.filter(r => !r.builtin && r.scope === 'global').map(r => (
                                                                    <option key={r.id} value={r.id}>{r.name || r.id}</option>
                                                                ))}
                                                            </optgroup>
                                                        )}
                                                        {/* NS: Show tenant-specific roles grouped by tenant */}
                                                        {tenants.filter(t => t.id !== 'default').map(tenant => {
                                                            const tenantRoles = allRoles.filter(r => !r.builtin && r.scope === 'tenant' && r.tenant_id === tenant.id);
                                                            if (tenantRoles.length === 0) return null;
                                                            return (
                                                                <optgroup key={tenant.id} label={`${tenant.name} Roles`}>
                                                                    {tenantRoles.map(r => (
                                                                        <option key={r.id} value={r.id}>{r.name || r.id}</option>
                                                                    ))}
                                                                </optgroup>
                                                            );
                                                        })}
                                                    </select>
                                                </div>
                                                <div>
                                                    <label className="block text-sm text-gray-400 mb-1">{t('tenant') || 'Tenant'}</label>
                                                    <select
                                                        value={newUser.tenant_id || 'default'}
                                                        onChange={e => setNewUser({...newUser, tenant_id: e.target.value})}
                                                        className="w-full px-3 py-2 bg-proxmox-darker border border-proxmox-border rounded-lg text-white text-sm focus:outline-none focus:border-proxmox-orange"
                                                    >
                                                        {tenants.map(t => (
                                                            <option key={t.id} value={t.id}>{t.name}</option>
                                                        ))}
                                                    </select>
                                                    <p className="text-xs text-gray-500 mt-1">{t('tenantAutoHint') || 'Auto-set when using tenant role'}</p>
                                                </div>
                                                <div className="flex items-end gap-2">
                                                    <button
                                                        type="submit"
                                                        disabled={loading}
                                                        className="px-4 py-2 bg-proxmox-orange hover:bg-orange-600 rounded-lg text-sm font-medium transition-colors disabled:opacity-50"
                                                    >
                                                        {t('create')}
                                                    </button>
                                                    <button
                                                        type="button"
                                                        onClick={() => setShowAddUser(false)}
                                                        className="px-4 py-2 bg-proxmox-border hover:bg-gray-600 rounded-lg text-sm font-medium transition-colors"
                                                    >
                                                        {t('cancel')}
                                                    </button>
                                                </div>
                                            </form>
                                        </div>
                                    )}
                                    
                                    {/* Users Table */}
                                    <div className="bg-proxmox-dark border border-proxmox-border rounded-xl overflow-hidden">
                                        <table className="w-full">
                                            <thead>
                                                <tr className="border-b border-proxmox-border">
                                                    <th className="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase">{t('usernameLabel')}</th>
                                                    <th className="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase">{t('displayName')}</th>
                                                    <th className="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase">{t('role')}</th>
                                                    <th className="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase">{t('tenant') || 'Tenant'}</th>
                                                    <th className="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase">2FA</th>
                                                    <th className="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase">{t('lastLogin')}</th>
                                                    <th className="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase">{t('status')}</th>
                                                    <th className="px-4 py-3 text-right text-xs font-medium text-gray-400 uppercase">{t('actions')}</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {users.map(user => (
                                                    <tr key={user.username} className="border-b border-gray-700/50 hover:bg-proxmox-hover">
                                                        <td className="px-4 py-3">
                                                            <div className="flex items-center gap-2">
                                                                <div className="w-8 h-8 rounded-full bg-proxmox-orange/20 flex items-center justify-center text-proxmox-orange text-sm font-semibold">
                                                                    {user.username[0].toUpperCase()}
                                                                </div>
                                                                <span className="text-white font-medium">{user.username}</span>
                                                            </div>
                                                        </td>
                                                        <td className="px-4 py-3 text-gray-300">{user.display_name || '-'}</td>
                                                        <td className="px-4 py-3">
                                                            {editingUser === user.username ? (
                                                                <select
                                                                    defaultValue={user.role}
                                                                    onChange={e => {
                                                                        const selectedRole = e.target.value;
                                                                        // LW: Auto-include tenant_id for tenant roles
                                                                        const roleObj = allRoles.find(r => r.id === selectedRole);
                                                                        if (roleObj && roleObj.scope === 'tenant' && roleObj.tenant_id) {
                                                                            handleUpdateUser(user.username, { role: selectedRole, tenant_id: roleObj.tenant_id });
                                                                        } else {
                                                                            handleUpdateUser(user.username, { role: selectedRole });
                                                                        }
                                                                    }}
                                                                    className="px-2 py-1 bg-proxmox-darker border border-proxmox-border rounded text-sm text-white"
                                                                >
                                                                    <optgroup label={t('builtinRole') || 'Builtin'}>
                                                                        <option value="admin">{t('roleAdmin')}</option>
                                                                        <option value="user">{t('roleUser')}</option>
                                                                        <option value="viewer">{t('roleViewer')}</option>
                                                                    </optgroup>
                                                                    {allRoles.filter(r => !r.builtin).length > 0 && (
                                                                        <optgroup label={t('customRoles') || 'Custom'}>
                                                                            {allRoles.filter(r => !r.builtin).map(r => (
                                                                                <option key={r.id} value={r.id}>{r.name || r.id}</option>
                                                                            ))}
                                                                        </optgroup>
                                                                    )}
                                                                </select>
                                                            ) : (
                                                                <span className={`px-2 py-1 rounded text-xs font-medium ${
                                                                    user.role === 'admin' ? 'bg-red-500/10 text-red-400' :
                                                                    user.role === 'user' ? 'bg-blue-500/10 text-blue-400' :
                                                                    user.role === 'viewer' ? 'bg-gray-500/10 text-gray-400' :
                                                                    'bg-purple-500/10 text-purple-400'
                                                                }`}>
                                                                    {user.role === 'admin' ? t('roleAdmin') : 
                                                                     user.role === 'user' ? t('roleUser') : 
                                                                     user.role === 'viewer' ? t('roleViewer') :
                                                                     user.role}
                                                                </span>
                                                            )}
                                                        </td>
                                                        <td className="px-4 py-3 text-gray-400 text-sm">
                                                            {/* NS: Show tenant name - editable when in edit mode */}
                                                            {editingUser === user.username ? (
                                                                <select
                                                                    defaultValue={user.tenant_id || 'default'}
                                                                    onChange={e => handleUpdateUser(user.username, { tenant_id: e.target.value })}
                                                                    className="px-2 py-1 bg-proxmox-darker border border-proxmox-border rounded text-sm text-white"
                                                                >
                                                                    {tenants.map(t => (
                                                                        <option key={t.id} value={t.id}>{t.name}</option>
                                                                    ))}
                                                                </select>
                                                            ) : (
                                                                <span className="px-2 py-1 rounded text-xs bg-cyan-500/10 text-cyan-400">
                                                                    {tenants.find(t => t.id === user.tenant_id)?.name || user.tenant_id || 'Default'}
                                                                </span>
                                                            )}
                                                        </td>
                                                        <td className="px-4 py-3">
                                                            <span className={`px-2 py-1 rounded text-xs font-medium ${
                                                                user.totp_enabled ? 'bg-green-500/10 text-green-400' : 'bg-gray-500/10 text-gray-500'
                                                            }`}>
                                                                {user.totp_enabled ? '‚úì 2FA' : '-'}
                                                            </span>
                                                        </td>
                                                        <td className="px-4 py-3 text-gray-400 text-sm">
                                                            {user.last_login ? new Date(user.last_login).toLocaleString() : t('never')}
                                                        </td>
                                                        <td className="px-4 py-3">
                                                            <span className={`px-2 py-1 rounded text-xs font-medium ${
                                                                user.enabled ? 'bg-green-500/10 text-green-400' : 'bg-red-500/10 text-red-400'
                                                            }`}>
                                                                {user.enabled ? t('enabled') : t('disabled')}
                                                            </span>
                                                        </td>
                                                        <td className="px-4 py-3 text-right">
                                                            <div className="flex items-center justify-end gap-1">
                                                                {/* Password Reset */}
                                                                {passwordResetUser === user.username ? (
                                                                    <div className="flex items-center gap-1">
                                                                        <input
                                                                            type="password"
                                                                            value={newPasswordValue}
                                                                            onChange={e => setNewPasswordValue(e.target.value)}
                                                                            placeholder={t('newPassword')}
                                                                            title={getSettingsPasswordPolicyHint()}
                                                                            className="w-24 px-2 py-1 bg-proxmox-darker border border-proxmox-border rounded text-sm text-white"
                                                                        />
                                                                        <button
                                                                            onClick={() => handleResetPassword(user.username)}
                                                                            className="p-1.5 rounded bg-green-500/20 text-green-400 hover:bg-green-500/30"
                                                                            title="Save"
                                                                        >
                                                                            <Icons.Check />
                                                                        </button>
                                                                        <button
                                                                            onClick={() => { setPasswordResetUser(null); setNewPasswordValue(''); }}
                                                                            className="p-1.5 rounded bg-red-500/20 text-red-400 hover:bg-red-500/30"
                                                                            title="Cancel"
                                                                        >
                                                                            <Icons.X />
                                                                        </button>
                                                                    </div>
                                                                ) : (
                                                                    <>
                                                                        <button
                                                                            onClick={() => setPasswordResetUser(user.username)}
                                                                            className="p-1.5 rounded hover:bg-proxmox-border text-gray-400 hover:text-yellow-400"
                                                                            title={t('resetPassword')}
                                                                        >
                                                                            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z" />
                                                                            </svg>
                                                                        </button>
                                                                        {user.totp_enabled && (
                                                                            <button
                                                                                onClick={() => handleDisable2FA(user.username)}
                                                                                className="p-1.5 rounded hover:bg-proxmox-border text-gray-400 hover:text-orange-400"
                                                                                title={t('disable2FA')}
                                                                            >
                                                                                <Icons.Shield />
                                                                            </button>
                                                                        )}
                                                                        <button
                                                                            onClick={() => setEditingUser(editingUser === user.username ? null : user.username)}
                                                                            className="p-1.5 rounded hover:bg-proxmox-border text-gray-400 hover:text-white"
                                                                            title={t('editUser')}
                                                                        >
                                                                            <Icons.Edit />
                                                                        </button>
                                                                        <button
                                                                            onClick={() => handleUpdateUser(user.username, { enabled: !user.enabled })}
                                                                            className={`p-1.5 rounded hover:bg-proxmox-border ${user.enabled ? 'text-green-400' : 'text-red-400'}`}
                                                                            title={user.enabled ? t('disable') : t('enable')}
                                                                        >
                                                                            {user.enabled ? <Icons.Check /> : <Icons.X />}
                                                                        </button>
                                                                        {user.username !== currentUser?.username && (
                                                                            <button
                                                                                onClick={() => handleDeleteUser(user.username)}
                                                                                className="p-1.5 rounded hover:bg-red-500/10 text-gray-400 hover:text-red-400"
                                                                                title={t('deleteUser')}
                                                                            >
                                                                                <Icons.Trash />
                                                                            </button>
                                                                        )}
                                                                    </>
                                                                )}
                                                            </div>
                                                        </td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            )}
                            
                            {/* Tenants Tab */}
                            {/* This whole section was added after Reddit feedback */}
                            {/* MSPs really wanted separate customer views */}
                            {activeTab === 'tenants' && (
                                <div className="space-y-4">
                                    <div className="flex justify-between items-center">
                                        <h3 className="text-lg font-semibold text-white">{t('tenants') || 'Tenants'}</h3>
                                        <button
                                            onClick={() => setShowAddTenant(true)}
                                            className="flex items-center gap-2 px-4 py-2 bg-proxmox-orange hover:bg-orange-600 rounded-lg text-sm font-medium transition-colors"
                                        >
                                            <Icons.Plus />
                                            {t('addTenant') || 'Add Tenant'}
                                        </button>
                                    </div>
                                    
                                    <p className="text-sm text-gray-400">
                                        {t('tenantsDesc') || 'Tenants allow you to separate users and restrict access to specific clusters.'}
                                    </p>
                                    
                                    {/* Add tenant form */}
                                    {showAddTenant && (
                                        <div className="bg-proxmox-dark border border-proxmox-border rounded-xl p-4">
                                            <h4 className="text-white font-medium mb-4">{t('addTenant') || 'Add Tenant'}</h4>
                                            <div className="space-y-4">
                                                <div>
                                                    <label className="block text-sm text-gray-400 mb-1">Name</label>
                                                    <input
                                                        type="text"
                                                        value={newTenant.name}
                                                        onChange={e => setNewTenant({...newTenant, name: e.target.value})}
                                                        className="w-full px-3 py-2 bg-proxmox-darker border border-proxmox-border rounded-lg text-white text-sm"
                                                        placeholder="Company Name"
                                                    />
                                                </div>
                                                <div>
                                                    <label className="block text-sm text-gray-400 mb-1">{t('clusters') || 'Clusters'}</label>
                                                    <p className="text-xs text-gray-500 mb-2">Select clusters this tenant can access (empty = all)</p>
                                                    <div className="grid grid-cols-2 gap-2 max-h-40 overflow-y-auto">
                                                        {clusters.map(c => (
                                                            <label key={c.id} className="flex items-center gap-2 p-2 bg-proxmox-darker rounded cursor-pointer hover:bg-proxmox-hover">
                                                                <input
                                                                    type="checkbox"
                                                                    checked={newTenant.clusters.includes(c.id)}
                                                                    onChange={e => {
                                                                        if(e.target.checked) {
                                                                            setNewTenant({...newTenant, clusters: [...newTenant.clusters, c.id]});
                                                                        } else {
                                                                            setNewTenant({...newTenant, clusters: newTenant.clusters.filter(x => x !== c.id)});
                                                                        }
                                                                    }}
                                                                    className="rounded"
                                                                />
                                                                <span className="text-sm text-white">{c.name}</span>
                                                            </label>
                                                        ))}
                                                    </div>
                                                </div>
                                                <div className="flex gap-2">
                                                    <button
                                                        onClick={async () => {
                                                            try {
                                                                const r = await fetch(`${API_URL}/tenants`, {
                                                                    method: 'POST',
                                                                    headers: { 'Content-Type': 'application/json', ...getAuthHeaders() },
                                                                    body: JSON.stringify(newTenant)
                                                                });
                                                                if(r.ok) {
                                                                    addToast('Tenant created', 'success');
                                                                    setShowAddTenant(false);
                                                                    setNewTenant({ name: '', clusters: [] });
                                                                    fetchTenants();
                                                                } else {
                                                                    const err = await r.json();
                                                                    addToast(err.error || 'Error', 'error');
                                                                }
                                                            } catch(e) { addToast('Error', 'error'); }
                                                        }}
                                                        className="px-4 py-2 bg-proxmox-orange hover:bg-orange-600 rounded-lg text-sm font-medium"
                                                    >
                                                        {t('create') || 'Create'}
                                                    </button>
                                                    <button
                                                        onClick={() => { setShowAddTenant(false); setNewTenant({ name: '', clusters: [] }); }}
                                                        className="px-4 py-2 bg-proxmox-dark border border-proxmox-border hover:bg-proxmox-hover rounded-lg text-sm text-gray-300"
                                                    >
                                                        {t('cancel')}
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                    
                                    {/* Tenants list */}
                                    <div className="bg-proxmox-dark border border-proxmox-border rounded-xl overflow-hidden">
                                        <table className="w-full">
                                            <thead>
                                                <tr className="border-b border-proxmox-border bg-proxmox-darker">
                                                    <th className="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase">Name</th>
                                                    <th className="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase">{t('clusters')}</th>
                                                    <th className="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase">{t('users')}</th>
                                                    <th className="px-4 py-3 text-right text-xs font-medium text-gray-400 uppercase">{t('actions')}</th>
                                                </tr>
                                            </thead>
                                            <tbody className="divide-y divide-proxmox-border">
                                                {tenants.map(tenant => (
                                                    <tr key={tenant.id} className="hover:bg-proxmox-hover/50">
                                                        <td className="px-4 py-3">
                                                            <div className="flex items-center gap-2">
                                                                <Icons.Building className="w-4 h-4 text-gray-400" />
                                                                <span className="text-white font-medium">{tenant.name}</span>
                                                                {tenant.id === 'default' && (
                                                                    <span className="px-2 py-0.5 text-xs bg-blue-500/20 text-blue-400 rounded">Default</span>
                                                                )}
                                                            </div>
                                                        </td>
                                                        <td className="px-4 py-3 text-sm text-gray-400">
                                                            {tenant.clusters.length === 0 ? 'All clusters' : tenant.clusters.length + ' clusters'}
                                                        </td>
                                                        <td className="px-4 py-3 text-sm text-gray-400">{tenant.user_count || 0}</td>
                                                        <td className="px-4 py-3 text-right">
                                                            <div className="flex items-center justify-end gap-2">
                                                                <button
                                                                    onClick={() => setEditingTenant({...tenant})}
                                                                    className="p-1.5 text-gray-400 hover:text-white hover:bg-proxmox-border rounded"
                                                                    title={t('edit') || 'Edit'}
                                                                >
                                                                    <Icons.Edit className="w-4 h-4" />
                                                                </button>
                                                                {tenant.id !== 'default' && (
                                                                    <button
                                                                        onClick={async () => {
                                                                            if(!confirm(`Delete tenant "${tenant.name}"?`)) return;
                                                                            try {
                                                                                const r = await fetch(`${API_URL}/tenants/${tenant.id}`, {
                                                                                    method: 'DELETE',
                                                                                    headers: getAuthHeaders()
                                                                                });
                                                                                if(r.ok) {
                                                                                    addToast('Tenant deleted', 'success');
                                                                                    fetchTenants();
                                                                                } else {
                                                                                    const err = await r.json();
                                                                                    addToast(err.error || 'Error', 'error');
                                                                                }
                                                                            } catch(e) {}
                                                                        }}
                                                                        className="p-1.5 text-red-400 hover:bg-red-500/20 rounded"
                                                                    >
                                                                        <Icons.Trash className="w-4 h-4" />
                                                                    </button>
                                                                )}
                                                            </div>
                                                        </td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                    
                                    {/* Edit Tenant Modal - NS: Dec 2025 */}
                                    {/* MK: Modal layout generated with Claude, tweaked the styling */}
                                    {editingTenant && (
                                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
                                            <div className="bg-proxmox-darker border border-proxmox-border rounded-xl p-6 w-full max-w-lg">
                                                <h3 className="text-lg font-semibold text-white mb-4">
                                                    {t('editTenant') || 'Edit Tenant'}: {editingTenant.name}
                                                </h3>
                                                
                                                <div className="space-y-4">
                                                    <div>
                                                        <label className="block text-sm text-gray-400 mb-1">Name</label>
                                                        <input
                                                            type="text"
                                                            value={editingTenant.name}
                                                            onChange={e => setEditingTenant({...editingTenant, name: e.target.value})}
                                                            className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white text-sm"
                                                        />
                                                    </div>
                                                    
                                                    <div>
                                                        <label className="block text-sm text-gray-400 mb-1">{t('clusters') || 'Clusters'}</label>
                                                        <p className="text-xs text-gray-500 mb-2">{t('tenantClustersHint') || 'Select which clusters this tenant can access (empty = all)'}</p>
                                                        <div className="grid grid-cols-2 gap-2 max-h-48 overflow-y-auto bg-proxmox-dark rounded-lg p-3">
                                                            {clusters.map(c => (
                                                                <label key={c.id} className="flex items-center gap-2 p-2 hover:bg-proxmox-hover rounded cursor-pointer">
                                                                    <input
                                                                        type="checkbox"
                                                                        checked={editingTenant.clusters?.includes(c.id)}
                                                                        onChange={e => {
                                                                            if(e.target.checked) {
                                                                                setEditingTenant({...editingTenant, clusters: [...(editingTenant.clusters || []), c.id]});
                                                                            } else {
                                                                                setEditingTenant({...editingTenant, clusters: (editingTenant.clusters || []).filter(x => x !== c.id)});
                                                                            }
                                                                        }}
                                                                        className="rounded border-gray-600"
                                                                    />
                                                                    <span className="text-sm text-white">{c.name}</span>
                                                                </label>
                                                            ))}
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <div className="flex gap-2 mt-6">
                                                    <button
                                                        onClick={async () => {
                                                            try {
                                                                const r = await fetch(`${API_URL}/tenants/${editingTenant.id}`, {
                                                                    method: 'PUT',
                                                                    headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
                                                                    body: JSON.stringify({
                                                                        name: editingTenant.name,
                                                                        clusters: editingTenant.clusters || []
                                                                    })
                                                                });
                                                                if(r.ok) {
                                                                    addToast(t('tenantSaved') || 'Tenant saved', 'success');
                                                                    setEditingTenant(null);
                                                                    fetchTenants();
                                                                } else {
                                                                    const err = await r.json();
                                                                    addToast(err.error || 'Error', 'error');
                                                                }
                                                            } catch(e) { addToast('Error', 'error'); }
                                                        }}
                                                        className="flex-1 px-4 py-2 bg-proxmox-orange hover:bg-orange-600 rounded-lg text-sm font-medium"
                                                    >
                                                        {t('save') || 'Save'}
                                                    </button>
                                                    <button
                                                        onClick={() => setEditingTenant(null)}
                                                        className="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg text-sm"
                                                    >
                                                        {t('cancel') || 'Cancel'}
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            )}
                            
                            {/* Cluster Groups Tab - NS Jan 2026 */}
                            {activeTab === 'groups' && (
                                <div className="space-y-4">
                                    <div className="flex justify-between items-center">
                                        <div>
                                            <h3 className="text-lg font-semibold text-white">{t('clusterGroups') || 'Cluster Groups'}</h3>
                                            <p className="text-sm text-gray-400 mt-1">{t('clusterGroupsDesc')}</p>
                                        </div>
                                        <button
                                            onClick={() => setShowAddGroup(true)}
                                            className="flex items-center gap-2 px-4 py-2 bg-proxmox-orange hover:bg-orange-600 rounded-lg text-sm font-medium"
                                        >
                                            <Icons.Plus className="w-4 h-4" />
                                            {t('addGroup') || 'Add Group'}
                                        </button>
                                    </div>
                                    
                                    {/* Groups List */}
                                    <div className="space-y-3">
                                        {clusterGroups.length === 0 ? (
                                            <div className="text-center py-8 text-gray-500">
                                                <Icons.Folder className="w-12 h-12 mx-auto mb-3 opacity-50" />
                                                <p>{t('noGroupsYet')}</p>
                                                <p className="text-sm mt-1">{t('createGroupFirst')}</p>
                                            </div>
                                        ) : (
                                            clusterGroups.map(group => {
                                                const groupClusters = clusters.filter(c => c.group_id === group.id);
                                                const tenant = tenants.find(t => t.id === group.tenant_id);
                                                return (
                                                    <div key={group.id} className="bg-proxmox-dark border border-proxmox-border rounded-xl p-4">
                                                        <div className="flex items-center justify-between">
                                                            <div className="flex items-center gap-3">
                                                                <div className="w-3 h-3 rounded-full" style={{ backgroundColor: group.color || '#E86F2D' }} />
                                                                <div>
                                                                    <h4 className="font-medium text-white">{group.name}</h4>
                                                                    {group.description && <p className="text-xs text-gray-500">{group.description}</p>}
                                                                </div>
                                                            </div>
                                                            <div className="flex items-center gap-4">
                                                                {tenant && (
                                                                    <span className="px-2 py-1 bg-blue-500/20 text-blue-400 rounded text-xs">
                                                                        Tenant: {tenant.name}
                                                                    </span>
                                                                )}
                                                                <span className="text-sm text-gray-400">{groupClusters.length} cluster(s)</span>
                                                                <div className="flex items-center gap-1">
                                                                    <button
                                                                        onClick={() => setEditingGroup(group)}
                                                                        className="p-1.5 text-gray-400 hover:text-white hover:bg-proxmox-hover rounded"
                                                                    >
                                                                        <Icons.Edit className="w-4 h-4" />
                                                                    </button>
                                                                    <button
                                                                        onClick={async () => {
                                                                            if(!confirm(`Delete group "${group.name}"?`)) return;
                                                                            try {
                                                                                const r = await fetch(`${API_URL}/cluster-groups/${group.id}`, {
                                                                                    method: 'DELETE',
                                                                                    headers: getAuthHeaders()
                                                                                });
                                                                                if(r.ok) {
                                                                                    addToast('Group deleted', 'success');
                                                                                    fetchClusterGroups();
                                                                                } else {
                                                                                    const err = await r.json();
                                                                                    addToast(err.error || 'Error', 'error');
                                                                                }
                                                                            } catch(e) {}
                                                                        }}
                                                                        className="p-1.5 text-red-400 hover:bg-red-500/20 rounded"
                                                                    >
                                                                        <Icons.Trash className="w-4 h-4" />
                                                                    </button>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        {/* Clusters in this group */}
                                                        {groupClusters.length > 0 && (
                                                            <div className="mt-3 pt-3 border-t border-proxmox-border">
                                                                <div className="flex flex-wrap gap-2">
                                                                    {groupClusters.map(c => (
                                                                        <span key={c.id} className="px-2 py-1 bg-proxmox-card border border-proxmox-border rounded text-xs text-gray-300">
                                                                            {c.display_name || c.name || c.host}
                                                                        </span>
                                                                    ))}
                                                                </div>
                                                            </div>
                                                        )}
                                                    </div>
                                                );
                                            })
                                        )}
                                    </div>
                                    
                                    {/* Add/Edit Group Modal */}
                                    {(showAddGroup || editingGroup) && (
                                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
                                            <div className="bg-proxmox-card border border-proxmox-border rounded-xl w-full max-w-md p-6">
                                                <h3 className="text-lg font-semibold mb-4">{editingGroup ? 'Edit Group' : 'Add Cluster Group'}</h3>
                                                <div className="space-y-4">
                                                    <div>
                                                        <label className="block text-sm text-gray-400 mb-1">Name *</label>
                                                        <input
                                                            type="text"
                                                            value={editingGroup ? editingGroup.name : newGroup.name}
                                                            onChange={e => editingGroup ? setEditingGroup({...editingGroup, name: e.target.value}) : setNewGroup({...newGroup, name: e.target.value})}
                                                            placeholder="Production Clusters"
                                                            className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white"
                                                        />
                                                    </div>
                                                    <div>
                                                        <label className="block text-sm text-gray-400 mb-1">Description</label>
                                                        <input
                                                            type="text"
                                                            value={editingGroup ? editingGroup.description : newGroup.description}
                                                            onChange={e => editingGroup ? setEditingGroup({...editingGroup, description: e.target.value}) : setNewGroup({...newGroup, description: e.target.value})}
                                                            placeholder="Production environment clusters"
                                                            className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white"
                                                        />
                                                    </div>
                                                    <div>
                                                        <label className="block text-sm text-gray-400 mb-1">Color</label>
                                                        <div className="flex items-center gap-2">
                                                            <input
                                                                type="color"
                                                                value={editingGroup ? editingGroup.color : newGroup.color}
                                                                onChange={e => editingGroup ? setEditingGroup({...editingGroup, color: e.target.value}) : setNewGroup({...newGroup, color: e.target.value})}
                                                                className="w-10 h-10 rounded cursor-pointer"
                                                            />
                                                            <span className="text-sm text-gray-400">{editingGroup ? editingGroup.color : newGroup.color}</span>
                                                        </div>
                                                    </div>
                                                    <div>
                                                        <label className="block text-sm text-gray-400 mb-1">Assign to Tenant (optional)</label>
                                                        <select
                                                            value={editingGroup ? (editingGroup.tenant_id || '') : (newGroup.tenant_id || '')}
                                                            onChange={e => editingGroup ? setEditingGroup({...editingGroup, tenant_id: e.target.value || null}) : setNewGroup({...newGroup, tenant_id: e.target.value || null})}
                                                            className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white"
                                                        >
                                                            <option value="">No tenant (visible to all)</option>
                                                            {tenants.filter(t => t.id !== 'default').map(t => (
                                                                <option key={t.id} value={t.id}>{t.name}</option>
                                                            ))}
                                                        </select>
                                                        <p className="text-xs text-gray-500 mt-1">If assigned, only this tenant can see clusters in this group</p>
                                                    </div>
                                                </div>
                                                <div className="flex justify-end gap-3 mt-6">
                                                    <button
                                                        onClick={() => { setShowAddGroup(false); setEditingGroup(null); setNewGroup({ name: '', description: '', color: '#E86F2D' }); }}
                                                        className="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg text-sm"
                                                    >
                                                        Cancel
                                                    </button>
                                                    <button
                                                        onClick={async () => {
                                                            const data = editingGroup || newGroup;
                                                            if(!data.name) { addToast('Name required', 'error'); return; }
                                                            try {
                                                                const url = editingGroup ? `${API_URL}/cluster-groups/${editingGroup.id}` : `${API_URL}/cluster-groups`;
                                                                const r = await fetch(url, {
                                                                    method: editingGroup ? 'PUT' : 'POST',
                                                                    headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
                                                                    body: JSON.stringify(data)
                                                                });
                                                                if(r.ok) {
                                                                    addToast(editingGroup ? 'Group updated' : 'Group created', 'success');
                                                                    setShowAddGroup(false);
                                                                    setEditingGroup(null);
                                                                    setNewGroup({ name: '', description: '', color: '#E86F2D' });
                                                                    fetchClusterGroups();
                                                                } else {
                                                                    const err = await r.json();
                                                                    addToast(err.error || 'Error', 'error');
                                                                }
                                                            } catch(e) { addToast('Error', 'error'); }
                                                        }}
                                                        className="px-4 py-2 bg-proxmox-orange hover:bg-orange-600 rounded-lg text-sm"
                                                    >
                                                        {editingGroup ? 'Save' : 'Create'}
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            )}
                            
                            {/* Permissions Tab - LW: granular access control */}
                            {activeTab === 'permissions' && (
                                <div className="space-y-4">
                                    <div className="flex justify-between items-center">
                                        <h3 className="text-lg font-semibold text-white">{t('permissions') || 'Permissions'}</h3>
                                    </div>
                                    
                                    {/* Sub-tabs for permissions */}
                                    <div className="flex gap-2 border-b border-proxmox-border pb-2">
                                        <button
                                            onClick={() => setPermSubTab('users')}
                                            className={`px-4 py-2 rounded-t-lg text-sm font-medium transition-colors ${
                                                permSubTab === 'users'
                                                    ? 'bg-proxmox-orange text-white'
                                                    : 'bg-proxmox-dark text-gray-400 hover:text-white'
                                            }`}
                                        >
                                            <div className="flex items-center gap-2">
                                                <Icons.User />
                                                {t('userPermissions') || 'User Permissions'}
                                            </div>
                                        </button>
                                        <button
                                            onClick={() => setPermSubTab('vms')}
                                            className={`px-4 py-2 rounded-t-lg text-sm font-medium transition-colors ${
                                                permSubTab === 'vms'
                                                    ? 'bg-proxmox-orange text-white'
                                                    : 'bg-proxmox-dark text-gray-400 hover:text-white'
                                            }`}
                                        >
                                            <div className="flex items-center gap-2">
                                                <Icons.VM />
                                                {t('vmPermissions') || 'VM Permissions'}
                                            </div>
                                        </button>
                                        <button
                                            onClick={() => setPermSubTab('pools')}
                                            className={`px-4 py-2 rounded-t-lg text-sm font-medium transition-colors ${
                                                permSubTab === 'pools'
                                                    ? 'bg-proxmox-orange text-white'
                                                    : 'bg-proxmox-dark text-gray-400 hover:text-white'
                                            }`}
                                        >
                                            <div className="flex items-center gap-2">
                                                <Icons.Layers />
                                                {t('poolPermissions') || 'Pool Permissions'}
                                            </div>
                                        </button>
                                    </div>
                                    
                                    {/* User Permissions Sub-Tab */}
                                    {permSubTab === 'users' && (
                                    <div>
                                    <p className="text-sm text-gray-400 mb-4">
                                        {t('permissionsDesc') || 'Configure granular permissions for users. Role-based defaults can be overridden per user.'}
                                    </p>
                                    
                                    <div className="grid grid-cols-3 gap-4">
                                        {/* User selector */}
                                        <div className="bg-proxmox-dark border border-proxmox-border rounded-xl p-4">
                                            <h4 className="font-medium text-white mb-3">{t('selectUser') || 'Select User'}</h4>
                                            <div className="space-y-2 max-h-96 overflow-y-auto">
                                                {users.map(u => (
                                                    <button
                                                        key={u.username}
                                                        onClick={() => { setSelectedUser(u.username); fetchUserPermissions(u.username); }}
                                                        className={`w-full text-left px-3 py-2 rounded-lg text-sm transition-colors ${
                                                            selectedUser === u.username
                                                                ? 'bg-proxmox-orange text-white'
                                                                : 'bg-proxmox-darker text-gray-300 hover:bg-proxmox-hover'
                                                        }`}
                                                    >
                                                        <div className="font-medium">{u.display_name || u.username}</div>
                                                        <div className="text-xs opacity-70">{u.role}</div>
                                                    </button>
                                                ))}
                                            </div>
                                        </div>
                                        
                                        {/* Permissions editor */}
                                        <div className="col-span-2 bg-proxmox-dark border border-proxmox-border rounded-xl p-4">
                                            {selectedUser && userPermissions ? (
                                                <div className="space-y-4">
                                                    <div className="flex justify-between items-center">
                                                        <h4 className="font-medium text-white">
                                                            Permissions for {selectedUser}
                                                            <span className="ml-2 text-xs text-gray-400">({userPermissions.role})</span>
                                                        </h4>
                                                        <button
                                                            onClick={async () => {
                                                                try {
                                                                    const r = await fetch(`${API_URL}/users/${selectedUser}/permissions`, {
                                                                        method: 'PUT',
                                                                        headers: { 'Content-Type': 'application/json', ...getAuthHeaders() },
                                                                        body: JSON.stringify({
                                                                            permissions: userPermissions.extra_permissions,
                                                                            denied_permissions: userPermissions.denied_permissions
                                                                        })
                                                                    });
                                                                    if(r.ok) {
                                                                        addToast('Permissions saved', 'success');
                                                                        fetchUserPermissions(selectedUser);
                                                                    }
                                                                } catch(e) {}
                                                            }}
                                                            className="px-3 py-1.5 bg-proxmox-orange hover:bg-orange-600 rounded text-sm font-medium"
                                                        >
                                                            {t('save')}
                                                        </button>
                                                    </div>
                                                    
                                                    <div className="text-xs text-gray-500 mb-2">
                                                        ‚úì = granted by role | + = extra permission | ‚úó = denied
                                                    </div>
                                                    
                                                    <div className="grid grid-cols-2 gap-4 max-h-80 overflow-y-auto">
                                                        {Object.entries(
                                                            allPermissions.reduce((acc, p) => {
                                                                const cat = p.category;
                                                                if(!acc[cat]) acc[cat] = [];
                                                                acc[cat].push(p);
                                                                return acc;
                                                            }, {})
                                                        ).map(([category, perms]) => (
                                                            <div key={category} className="bg-proxmox-darker rounded-lg p-3">
                                                                <h5 className="text-sm font-medium text-white mb-2 capitalize">{category}</h5>
                                                                <div className="space-y-1">
                                                                    {perms.map(p => {
                                                                        const fromRole = userPermissions.role_permissions?.includes(p.permission);
                                                                        const extra = userPermissions.extra_permissions?.includes(p.permission);
                                                                        const denied = userPermissions.denied_permissions?.includes(p.permission);
                                                                        const effective = userPermissions.effective_permissions?.includes(p.permission);
                                                                        
                                                                        return(
                                                                            <div key={p.permission} className="flex items-center justify-between py-1">
                                                                                <span className={`text-xs ${effective ? 'text-green-400' : 'text-gray-500'}`}>
                                                                                    {p.permission.split('.')[1]}
                                                                                </span>
                                                                                <div className="flex items-center gap-1">
                                                                                    {fromRole && <span className="text-xs text-blue-400">‚úì</span>}
                                                                                    <button
                                                                                        onClick={() => {
                                                                                            if(extra) {
                                                                                                setUserPermissions({
                                                                                                    ...userPermissions,
                                                                                                    extra_permissions: userPermissions.extra_permissions.filter(x => x !== p.permission)
                                                                                                });
                                                                                            } else {
                                                                                                setUserPermissions({
                                                                                                    ...userPermissions,
                                                                                                    extra_permissions: [...(userPermissions.extra_permissions || []), p.permission],
                                                                                                    denied_permissions: (userPermissions.denied_permissions || []).filter(x => x !== p.permission)
                                                                                                });
                                                                                            }
                                                                                        }}
                                                                                        className={`px-1.5 py-0.5 text-xs rounded ${extra ? 'bg-green-500/20 text-green-400' : 'bg-proxmox-dark text-gray-500 hover:text-green-400'}`}
                                                                                    >
                                                                                        +
                                                                                    </button>
                                                                                    <button
                                                                                        onClick={() => {
                                                                                            if(denied) {
                                                                                                setUserPermissions({
                                                                                                    ...userPermissions,
                                                                                                    denied_permissions: userPermissions.denied_permissions.filter(x => x !== p.permission)
                                                                                                });
                                                                                            } else {
                                                                                                setUserPermissions({
                                                                                                    ...userPermissions,
                                                                                                    denied_permissions: [...(userPermissions.denied_permissions || []), p.permission],
                                                                                                    extra_permissions: (userPermissions.extra_permissions || []).filter(x => x !== p.permission)
                                                                                                });
                                                                                            }
                                                                                        }}
                                                                                        className={`px-1.5 py-0.5 text-xs rounded ${denied ? 'bg-red-500/20 text-red-400' : 'bg-proxmox-dark text-gray-500 hover:text-red-400'}`}
                                                                                    >
                                                                                        ‚úó
                                                                                    </button>
                                                                                </div>
                                                                            </div>
                                                                        );
                                                                    })}
                                                                </div>
                                                            </div>
                                                        ))}
                                                    </div>
                                                </div>
                                            ) : (
                                                <div className="flex items-center justify-center h-64 text-gray-500">
                                                    {t('selectUserToEdit') || 'Select a user to edit permissions'}
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                    </div>
                                    )}
                                    
                                    {/* VM Permissions Sub-Tab */}
                                    {permSubTab === 'vms' && (
                                    <div>
                                    {/* VM-Level Access Control Section - NS: Dec 2025 */}
                                    <div className="pt-2">
                                        <div className="flex justify-between items-center mb-4">
                                            <div>
                                                <h4 className="text-md font-semibold text-white flex items-center gap-2">
                                                    <Icons.Shield />
                                                    {t('vmAcl') || 'VM Access Control'}
                                                </h4>
                                                <p className="text-xs text-gray-500 mt-1">{t('vmAclDesc') || 'Grant specific users access to individual VMs'}</p>
                                            </div>
                                        </div>
                                        
                                        <div className="grid grid-cols-3 gap-4">
                                            {/* Cluster selector */}
                                            <div className="bg-proxmox-dark border border-proxmox-border rounded-xl p-4">
                                                <label className="block text-sm text-gray-400 mb-2">{t('selectCluster') || 'Select Cluster'}</label>
                                                <select
                                                    value={selectedClusterForAcl}
                                                    onChange={e => {
                                                        setSelectedClusterForAcl(e.target.value);
                                                        fetchVmAcls(e.target.value);
                                                        fetchVmsForAcl(e.target.value);
                                                    }}
                                                    className="w-full px-3 py-2 bg-proxmox-darker border border-proxmox-border rounded-lg text-white text-sm"
                                                >
                                                    <option value="">{t('select') || '-- Select --'}</option>
                                                    {clusters.map(c => (
                                                        <option key={c.id} value={c.id}>{c.name}</option>
                                                    ))}
                                                </select>
                                                
                                                {selectedClusterForAcl && (
                                                    <button
                                                        onClick={() => {
                                                            setSelectedVmForAcl(null);
                                                            setVmAclUsers([]);
                                                            setVmAclPerms([]);
                                                            setVmAclInherit(true);
                                                            setShowVmAclModal(true);
                                                        }}
                                                        className="mt-3 w-full px-3 py-2 bg-proxmox-orange hover:bg-orange-600 rounded-lg text-sm font-medium flex items-center justify-center gap-2"
                                                    >
                                                        <Icons.Plus />
                                                        {t('addVmAcl') || 'Add VM Permission'}
                                                    </button>
                                                )}
                                            </div>
                                            
                                            {/* VM ACLs list */}
                                            <div className="col-span-2 bg-proxmox-dark border border-proxmox-border rounded-xl p-4">
                                                <h4 className="font-medium text-white mb-3">{t('vmPermissions') || 'VM Permissions'}</h4>
                                                {selectedClusterForAcl ? (
                                                    vmAcls.length > 0 ? (
                                                        <div className="space-y-2 max-h-64 overflow-y-auto">
                                                            {vmAcls.map(acl => {
                                                                const vm = availableVms.find(v => v.vmid === acl.vmid);
                                                                return (
                                                                    <div key={acl.vmid} className="flex items-center justify-between p-3 bg-proxmox-darker rounded-lg">
                                                                        <div>
                                                                            <div className="text-white text-sm font-medium">
                                                                                {vm?.name || `VM ${acl.vmid}`}
                                                                                <span className="ml-2 text-xs text-gray-500">({acl.vmid})</span>
                                                                            </div>
                                                                            <div className="text-xs text-gray-400 mt-1">
                                                                                {acl.users?.length || 0} users ‚Ä¢ 
                                                                                {acl.inherit_role ? ' Inherits role permissions' : ` ${acl.permissions?.length || 0} custom permissions`}
                                                                            </div>
                                                                        </div>
                                                                        <div className="flex items-center gap-2">
                                                                            <button
                                                                                onClick={() => {
                                                                                    setSelectedVmForAcl(acl.vmid);
                                                                                    setVmAclUsers(acl.users || []);
                                                                                    setVmAclPerms(acl.permissions || []);
                                                                                    setVmAclInherit(acl.inherit_role !== false);
                                                                                    setShowVmAclModal(true);
                                                                                }}
                                                                                className="px-2 py-1 text-xs bg-proxmox-border hover:bg-gray-600 rounded"
                                                                            >
                                                                                {t('edit') || 'Edit'}
                                                                            </button>
                                                                            <button
                                                                                onClick={() => deleteVmAcl(acl.vmid)}
                                                                                className="px-2 py-1 text-xs bg-red-500/20 text-red-400 hover:bg-red-500/30 rounded"
                                                                            >
                                                                                {t('delete') || 'Delete'}
                                                                            </button>
                                                                        </div>
                                                                    </div>
                                                                );
                                                            })}
                                                        </div>
                                                    ) : (
                                                        <div className="text-center py-8 text-gray-500">
                                                            {t('noVmAcls') || 'No VM-specific permissions configured. All VMs follow role-based access.'}
                                                        </div>
                                                    )
                                                ) : (
                                                    <div className="text-center py-8 text-gray-500">
                                                        {t('selectClusterFirst') || 'Select a cluster to manage VM permissions'}
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    </div>
                                    
                                    {/* VM ACL Modal */}
                                    {showVmAclModal && (
                                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
                                            <div className="bg-proxmox-darker border border-proxmox-border rounded-xl p-6 w-full max-w-lg">
                                                <h3 className="text-lg font-semibold text-white mb-4">
                                                    {selectedVmForAcl ? t('editVmAcl') || 'Edit VM Permission' : t('addVmAcl') || 'Add VM Permission'}
                                                </h3>
                                                
                                                <div className="space-y-4">
                                                    {/* VM selector (only for new) */}
                                                    {!selectedVmForAcl && (
                                                        <div>
                                                            <label className="block text-sm text-gray-400 mb-1">{t('selectVm') || 'Select VM'}</label>
                                                            <select
                                                                value={selectedVmForAcl || ''}
                                                                onChange={e => {
                                                                    const val = e.target.value;
                                                                    setSelectedVmForAcl(val ? parseInt(val) : null);
                                                                }}
                                                                className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white text-sm"
                                                            >
                                                                <option value="">-- {t('selectVm') || 'Select VM'} --</option>
                                                                {availableVms.map(vm => (
                                                                    <option key={vm.vmid} value={vm.vmid}>
                                                                        {vm.name || `VM ${vm.vmid}`} ({vm.vmid}) - {vm.status}
                                                                    </option>
                                                                ))}
                                                            </select>
                                                            {availableVms.length === 0 && (
                                                                <p className="text-xs text-yellow-500 mt-1">{t('noVmsInCluster') || 'No VMs found in this cluster'}</p>
                                                            )}
                                                        </div>
                                                    )}
                                                    
                                                    {/* Users with access */}
                                                    <div>
                                                        <label className="block text-sm text-gray-400 mb-1">{t('usersWithAccess') || 'Users with Access'}</label>
                                                        <div className="max-h-40 overflow-y-auto bg-proxmox-dark rounded-lg p-2">
                                                            {users.map(u => (
                                                                <label key={u.username} className="flex items-center gap-2 p-2 hover:bg-proxmox-darker rounded cursor-pointer">
                                                                    <input
                                                                        type="checkbox"
                                                                        checked={vmAclUsers.includes(u.username)}
                                                                        onChange={e => {
                                                                            if(e.target.checked) {
                                                                                setVmAclUsers([...vmAclUsers, u.username]);
                                                                            } else {
                                                                                setVmAclUsers(vmAclUsers.filter(x => x !== u.username));
                                                                            }
                                                                        }}
                                                                        className="rounded border-gray-600"
                                                                    />
                                                                    <span className="text-sm text-white">{u.display_name || u.username}</span>
                                                                    <span className="text-xs text-gray-500">({u.role})</span>
                                                                </label>
                                                            ))}
                                                        </div>
                                                    </div>
                                                    
                                                    {/* Inherit role permissions */}
                                                    <label className="flex items-center gap-2 cursor-pointer">
                                                        <input
                                                            type="checkbox"
                                                            checked={vmAclInherit}
                                                            onChange={e => setVmAclInherit(e.target.checked)}
                                                            className="rounded border-gray-600"
                                                        />
                                                        <span className="text-sm text-gray-300">{t('inheritRolePerms') || 'Use role-based permissions'}</span>
                                                    </label>
                                                    
                                                    {/* Custom permissions (if not inheriting) */}
                                                    {!vmAclInherit && (
                                                        <div>
                                                            <label className="block text-sm text-gray-400 mb-1">{t('customPermissions') || 'Custom Permissions'}</label>
                                                            <div className="grid grid-cols-2 gap-1 max-h-40 overflow-y-auto bg-proxmox-dark rounded-lg p-2">
                                                                {allPermissions.filter(p => p.permission.startsWith('vm.')).map(p => (
                                                                    <label key={p.permission} className="flex items-center gap-2 p-1 text-xs text-gray-300 cursor-pointer hover:text-white">
                                                                        <input
                                                                            type="checkbox"
                                                                            checked={vmAclPerms.includes(p.permission)}
                                                                            onChange={e => {
                                                                                if(e.target.checked) {
                                                                                    setVmAclPerms([...vmAclPerms, p.permission]);
                                                                                } else {
                                                                                    setVmAclPerms(vmAclPerms.filter(x => x !== p.permission));
                                                                                }
                                                                            }}
                                                                            className="rounded border-gray-600"
                                                                        />
                                                                        {p.permission}
                                                                    </label>
                                                                ))}
                                                            </div>
                                                        </div>
                                                    )}
                                                </div>
                                                
                                                <div className="flex gap-2 mt-6">
                                                    <button
                                                        onClick={saveVmAcl}
                                                        disabled={!selectedVmForAcl || vmAclUsers.length === 0}
                                                        className="flex-1 px-4 py-2 bg-proxmox-orange hover:bg-orange-600 disabled:opacity-50 disabled:cursor-not-allowed rounded-lg text-sm font-medium"
                                                    >
                                                        {t('save') || 'Save'}
                                                    </button>
                                                    <button
                                                        onClick={() => setShowVmAclModal(false)}
                                                        className="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg text-sm"
                                                    >
                                                        {t('cancel') || 'Cancel'}
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                    </div>
                                    )}
                                    
                                    {/* Pool Permissions Sub-Tab - MK Jan 2026 */}
                                    {permSubTab === 'pools' && (
                                    <div>
                                    <p className="text-sm text-gray-400 mb-4">
                                        {t('poolPermissionsDesc') || 'Grant users or groups access to Proxmox resource pools. Permissions apply to all VMs within the pool.'}
                                    </p>
                                    
                                    <div className="grid grid-cols-3 gap-4">
                                        {/* Cluster & Pool Selector */}
                                        <div className="bg-proxmox-dark border border-proxmox-border rounded-xl p-4">
                                            <label className="block text-sm text-gray-400 mb-2">{t('selectCluster') || 'Select Cluster'}</label>
                                            <div className="flex gap-2">
                                                <select
                                                    value={selectedPoolCluster}
                                                    onChange={e => {
                                                        setSelectedPoolCluster(e.target.value);
                                                        setSelectedPool(null);
                                                        setPoolPermissions([]);
                                                        if (e.target.value) fetchPools(e.target.value);
                                                    }}
                                                    className="flex-1 px-3 py-2 bg-proxmox-darker border border-proxmox-border rounded-lg text-white text-sm"
                                                >
                                                    <option value="">{t('select') || '-- Select --'}</option>
                                                    {clusters.map(c => (
                                                        <option key={c.id} value={c.id}>{c.name}</option>
                                                    ))}
                                                </select>
                                                {selectedPoolCluster && (
                                                    <button
                                                        onClick={() => refreshPoolCache(selectedPoolCluster)}
                                                        className="px-3 py-2 bg-proxmox-border hover:bg-gray-600 rounded-lg text-sm"
                                                        title={t('refreshPools') || 'Refresh pools from Proxmox'}
                                                    >
                                                        <Icons.Refresh className="w-4 h-4" />
                                                    </button>
                                                )}
                                                {selectedPoolCluster && (
                                                    <button
                                                        onClick={() => {
                                                            setShowPoolManager(true);
                                                            fetchVmsWithoutPool(selectedPoolCluster);
                                                        }}
                                                        className="px-3 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg text-sm"
                                                        title={t('managePools') || 'Manage Pools'}
                                                    >
                                                        <Icons.Settings className="w-4 h-4" />
                                                    </button>
                                                )}
                                            </div>
                                            
                                            {selectedPoolCluster && pools.length > 0 && (
                                                <div className="mt-4">
                                                    <label className="block text-sm text-gray-400 mb-2">{t('selectPool') || 'Select Pool'}</label>
                                                    <div className="space-y-2 max-h-64 overflow-y-auto">
                                                        {pools.map(pool => (
                                                            <button
                                                                key={pool.poolid}
                                                                onClick={() => {
                                                                    setSelectedPool(pool.poolid);
                                                                    fetchPoolPermissions(selectedPoolCluster, pool.poolid);
                                                                }}
                                                                className={`w-full text-left px-3 py-2 rounded-lg text-sm transition-colors ${
                                                                    selectedPool === pool.poolid
                                                                        ? 'bg-proxmox-orange text-white'
                                                                        : 'bg-proxmox-darker text-gray-300 hover:bg-proxmox-hover'
                                                                }`}
                                                            >
                                                                <div className="font-medium flex items-center gap-2">
                                                                    <Icons.Layers className="w-4 h-4" />
                                                                    {pool.poolid}
                                                                </div>
                                                                <div className="text-xs opacity-70 mt-1">
                                                                    {pool.vms || 0} VMs ‚Ä¢ {pool.comment || t('noDescription') || 'No description'}
                                                                </div>
                                                            </button>
                                                        ))}
                                                    </div>
                                                </div>
                                            )}
                                            
                                            {selectedPoolCluster && pools.length === 0 && (
                                                <div className="mt-4 text-sm text-gray-500 text-center py-4">
                                                    {t('noPools') || 'No resource pools found in this cluster'}
                                                </div>
                                            )}
                                        </div>
                                        
                                        {/* Pool Permissions List */}
                                        <div className="col-span-2 bg-proxmox-dark border border-proxmox-border rounded-xl p-4">
                                            <div className="flex justify-between items-center mb-3">
                                                <h4 className="font-medium text-white">
                                                    {selectedPool ? `${t('permissionsFor') || 'Permissions for'} "${selectedPool}"` : t('poolPermissions') || 'Pool Permissions'}
                                                </h4>
                                                {selectedPool && (
                                                    <button
                                                        onClick={() => {
                                                            setPoolPermForm({ subject_type: 'user', subject_id: '', permissions: [] });
                                                            setShowPoolPermModal(true);
                                                        }}
                                                        className="px-3 py-1.5 bg-proxmox-orange hover:bg-orange-600 rounded-lg text-sm font-medium flex items-center gap-2"
                                                    >
                                                        <Icons.Plus className="w-4 h-4" />
                                                        {t('addPermission') || 'Add Permission'}
                                                    </button>
                                                )}
                                            </div>
                                            
                                            {selectedPool ? (
                                                poolPermissions.length > 0 ? (
                                                    <div className="space-y-2 max-h-80 overflow-y-auto">
                                                        {poolPermissions.map((perm, idx) => (
                                                            <div key={idx} className="flex items-center justify-between p-3 bg-proxmox-darker rounded-lg">
                                                                <div>
                                                                    <div className="text-white text-sm font-medium flex items-center gap-2">
                                                                        {perm.subject_type === 'user' ? <Icons.User className="w-4 h-4" /> : <Icons.Users className="w-4 h-4" />}
                                                                        {perm.subject_id}
                                                                        <span className="text-xs px-1.5 py-0.5 rounded bg-gray-700 text-gray-400">
                                                                            {perm.subject_type}
                                                                        </span>
                                                                    </div>
                                                                    <div className="flex flex-wrap gap-1 mt-2">
                                                                        {perm.permissions.map((p, i) => (
                                                                            <span key={i} className="px-1.5 py-0.5 text-xs rounded bg-blue-500/20 text-blue-400">
                                                                                {p.replace('pool.', '').replace('vm.', '')}
                                                                            </span>
                                                                        ))}
                                                                    </div>
                                                                </div>
                                                                <div className="flex items-center gap-2">
                                                                    <button
                                                                        onClick={() => {
                                                                            setPoolPermForm({
                                                                                subject_type: perm.subject_type,
                                                                                subject_id: perm.subject_id,
                                                                                permissions: perm.permissions
                                                                            });
                                                                            setShowPoolPermModal(true);
                                                                        }}
                                                                        className="px-2 py-1 text-xs bg-proxmox-border hover:bg-gray-600 rounded"
                                                                    >
                                                                        {t('edit') || 'Edit'}
                                                                    </button>
                                                                    <button
                                                                        onClick={() => deletePoolPermission(perm.subject_type, perm.subject_id)}
                                                                        className="px-2 py-1 text-xs bg-red-500/20 text-red-400 hover:bg-red-500/30 rounded"
                                                                    >
                                                                        {t('delete') || 'Delete'}
                                                                    </button>
                                                                </div>
                                                            </div>
                                                        ))}
                                                    </div>
                                                ) : (
                                                    <div className="text-center py-8 text-gray-500">
                                                        {t('noPoolPerms') || 'No permissions configured for this pool'}
                                                    </div>
                                                )
                                            ) : (
                                                <div className="text-center py-8 text-gray-500">
                                                    {t('selectPoolFirst') || 'Select a cluster and pool to manage permissions'}
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                    
                                    {/* Pool Permission Modal */}
                                    {showPoolPermModal && (
                                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
                                            <div className="bg-proxmox-darker border border-proxmox-border rounded-xl p-6 w-full max-w-lg">
                                                <h3 className="text-lg font-semibold text-white mb-4">
                                                    {poolPermForm.subject_id ? t('editPoolPerm') || 'Edit Pool Permission' : t('addPoolPerm') || 'Add Pool Permission'}
                                                </h3>
                                                
                                                <div className="space-y-4">
                                                    {/* Subject Type */}
                                                    <div>
                                                        <label className="block text-sm text-gray-400 mb-1">{t('subjectType') || 'Subject Type'}</label>
                                                        <select
                                                            value={poolPermForm.subject_type}
                                                            onChange={e => setPoolPermForm({...poolPermForm, subject_type: e.target.value})}
                                                            className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white text-sm"
                                                        >
                                                            <option value="user">{t('user') || 'User'}</option>
                                                            <option value="group">{t('group') || 'Group'}</option>
                                                        </select>
                                                    </div>
                                                    
                                                    {/* Subject ID */}
                                                    <div>
                                                        <label className="block text-sm text-gray-400 mb-1">
                                                            {poolPermForm.subject_type === 'user' ? t('selectUser') || 'Select User' : t('groupName') || 'Group Name'}
                                                        </label>
                                                        {poolPermForm.subject_type === 'user' ? (
                                                            <select
                                                                value={poolPermForm.subject_id}
                                                                onChange={e => setPoolPermForm({...poolPermForm, subject_id: e.target.value})}
                                                                className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white text-sm"
                                                            >
                                                                <option value="">{t('select') || '-- Select --'}</option>
                                                                {users.map(u => (
                                                                    <option key={u.username} value={u.username}>
                                                                        {u.display_name || u.username} ({u.role})
                                                                    </option>
                                                                ))}
                                                            </select>
                                                        ) : (
                                                            <input
                                                                type="text"
                                                                value={poolPermForm.subject_id}
                                                                onChange={e => setPoolPermForm({...poolPermForm, subject_id: e.target.value})}
                                                                placeholder="developers"
                                                                className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white text-sm"
                                                            />
                                                        )}
                                                    </div>
                                                    
                                                    {/* Permissions */}
                                                    <div>
                                                        <label className="block text-sm text-gray-400 mb-2">{t('permissions') || 'Permissions'}</label>
                                                        <div className="grid grid-cols-2 gap-2 max-h-48 overflow-y-auto bg-proxmox-dark p-3 rounded-lg border border-proxmox-border">
                                                            {availablePoolPerms.map(perm => (
                                                                <label key={perm} className="flex items-center gap-2 text-sm cursor-pointer hover:bg-proxmox-hover p-1 rounded">
                                                                    <input
                                                                        type="checkbox"
                                                                        checked={poolPermForm.permissions.includes(perm)}
                                                                        onChange={e => {
                                                                            if (e.target.checked) {
                                                                                setPoolPermForm({
                                                                                    ...poolPermForm,
                                                                                    permissions: [...poolPermForm.permissions, perm]
                                                                                });
                                                                            } else {
                                                                                setPoolPermForm({
                                                                                    ...poolPermForm,
                                                                                    permissions: poolPermForm.permissions.filter(p => p !== perm)
                                                                                });
                                                                            }
                                                                        }}
                                                                        className="w-4 h-4 rounded border-proxmox-border bg-proxmox-dark text-proxmox-orange"
                                                                    />
                                                                    <span className={poolPermForm.permissions.includes(perm) ? 'text-white' : 'text-gray-400'}>
                                                                        {perm.replace('pool.', '').replace('vm.', '')}
                                                                    </span>
                                                                </label>
                                                            ))}
                                                        </div>
                                                        
                                                        {/* Quick select buttons */}
                                                        <div className="flex gap-2 mt-2">
                                                            <button
                                                                type="button"
                                                                onClick={() => setPoolPermForm({
                                                                    ...poolPermForm,
                                                                    permissions: ['pool.view', 'vm.start', 'vm.stop', 'vm.console']
                                                                })}
                                                                className="px-2 py-1 text-xs bg-blue-500/20 text-blue-400 hover:bg-blue-500/30 rounded"
                                                            >
                                                                Operator
                                                            </button>
                                                            <button
                                                                type="button"
                                                                onClick={() => setPoolPermForm({
                                                                    ...poolPermForm,
                                                                    permissions: ['pool.view', 'vm.start', 'vm.stop', 'vm.console', 'vm.config', 'vm.snapshot', 'vm.backup']
                                                                })}
                                                                className="px-2 py-1 text-xs bg-green-500/20 text-green-400 hover:bg-green-500/30 rounded"
                                                            >
                                                                Power User
                                                            </button>
                                                            <button
                                                                type="button"
                                                                onClick={() => setPoolPermForm({
                                                                    ...poolPermForm,
                                                                    permissions: ['pool.admin']
                                                                })}
                                                                className="px-2 py-1 text-xs bg-proxmox-orange/20 text-proxmox-orange hover:bg-proxmox-orange/30 rounded"
                                                            >
                                                                Admin
                                                            </button>
                                                            <button
                                                                type="button"
                                                                onClick={() => setPoolPermForm({...poolPermForm, permissions: []})}
                                                                className="px-2 py-1 text-xs bg-gray-500/20 text-gray-400 hover:bg-gray-500/30 rounded"
                                                            >
                                                                Clear
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <div className="flex gap-3 mt-6">
                                                    <button
                                                        onClick={savePoolPermission}
                                                        disabled={!poolPermForm.subject_id || poolPermForm.permissions.length === 0}
                                                        className="flex-1 px-4 py-2 bg-proxmox-orange hover:bg-orange-600 disabled:opacity-50 disabled:cursor-not-allowed rounded-lg text-sm font-medium"
                                                    >
                                                        {t('save') || 'Save'}
                                                    </button>
                                                    <button
                                                        onClick={() => setShowPoolPermModal(false)}
                                                        className="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg text-sm"
                                                    >
                                                        {t('cancel') || 'Cancel'}
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                    
                                    {/* Pool Manager Modal - NS Jan 2026 */}
                                    {showPoolManager && (
                                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
                                            <div className="bg-proxmox-card border border-proxmox-border rounded-xl w-full max-w-4xl max-h-[85vh] overflow-hidden flex flex-col">
                                                <div className="p-4 border-b border-proxmox-border flex items-center justify-between">
                                                    <h3 className="text-lg font-semibold text-white flex items-center gap-2">
                                                        <Icons.Layers />
                                                        {t('managePools') || 'Manage Pools'}
                                                    </h3>
                                                    <button onClick={() => setShowPoolManager(false)} className="p-1 hover:bg-proxmox-dark rounded">
                                                        <Icons.X />
                                                    </button>
                                                </div>
                                                
                                                <div className="flex-1 overflow-auto p-4">
                                                    {/* Create Pool Button */}
                                                    <div className="flex justify-between items-center mb-4">
                                                        <p className="text-sm text-gray-400">
                                                            {t('poolManagerDesc') || 'Create, edit, and delete resource pools. Assign VMs to pools for organized permission management.'}
                                                        </p>
                                                        <button
                                                            onClick={() => setShowCreatePool(true)}
                                                            className="flex items-center gap-2 px-4 py-2 bg-proxmox-orange hover:bg-orange-600 rounded-lg text-sm font-medium"
                                                        >
                                                            <Icons.Plus className="w-4 h-4" />
                                                            {t('createPool') || 'Create Pool'}
                                                        </button>
                                                    </div>
                                                    
                                                    {/* Pools List */}
                                                    <div className="space-y-3">
                                                        {pools.length === 0 ? (
                                                            <div className="text-center py-12 text-gray-500">
                                                                <Icons.Layers className="w-12 h-12 mx-auto mb-3 opacity-50" />
                                                                <p>{t('noPoolsYet') || 'No pools yet'}</p>
                                                                <p className="text-sm mt-1">{t('createFirstPool') || 'Create your first pool to organize VMs'}</p>
                                                            </div>
                                                        ) : (
                                                            pools.map(pool => (
                                                                <div key={pool.poolid} className="bg-proxmox-dark border border-proxmox-border rounded-xl p-4">
                                                                    <div className="flex items-start justify-between">
                                                                        <div className="flex-1">
                                                                            <div className="flex items-center gap-3">
                                                                                <Icons.Layers className="w-5 h-5 text-blue-400" />
                                                                                <h4 className="font-semibold text-white">{pool.poolid}</h4>
                                                                                <span className="px-2 py-0.5 bg-gray-700 rounded text-xs text-gray-400">
                                                                                    {pool.members?.length || 0} {t('members') || 'members'}
                                                                                </span>
                                                                            </div>
                                                                            {pool.comment && (
                                                                                <p className="text-sm text-gray-500 mt-1 ml-8">{pool.comment}</p>
                                                                            )}
                                                                            
                                                                            {/* Pool Members (VMs) */}
                                                                            {pool.members && pool.members.length > 0 && (
                                                                                <div className="mt-3 ml-8">
                                                                                    <p className="text-xs text-gray-500 mb-2">{t('poolMembers') || 'Members'}:</p>
                                                                                    <div className="flex flex-wrap gap-2">
                                                                                        {pool.members.filter(m => m.type === 'qemu' || m.type === 'lxc').map(member => (
                                                                                            <div key={member.id} className="flex items-center gap-1 px-2 py-1 bg-proxmox-darker rounded text-xs">
                                                                                                {member.type === 'qemu' ? (
                                                                                                    <Icons.Monitor className="w-3 h-3 text-blue-400" />
                                                                                                ) : (
                                                                                                    <Icons.Box className="w-3 h-3 text-yellow-400" />
                                                                                                )}
                                                                                                <span className="text-gray-300">{member.vmid} - {member.name || 'unnamed'}</span>
                                                                                                <button
                                                                                                    onClick={() => removeVmFromPool(pool.poolid, member.vmid)}
                                                                                                    className="ml-1 text-red-400 hover:text-red-300"
                                                                                                    title={t('removeFromPool') || 'Remove from pool'}
                                                                                                >
                                                                                                    <Icons.X className="w-3 h-3" />
                                                                                                </button>
                                                                                            </div>
                                                                                        ))}
                                                                                    </div>
                                                                                </div>
                                                                            )}
                                                                        </div>
                                                                        
                                                                        {/* Actions */}
                                                                        <div className="flex items-center gap-2">
                                                                            <button
                                                                                onClick={() => setShowAddVmToPool(pool.poolid)}
                                                                                className="px-3 py-1.5 bg-green-600 hover:bg-green-700 rounded text-xs flex items-center gap-1"
                                                                                title={t('addVmToPool') || 'Add VM to pool'}
                                                                            >
                                                                                <Icons.Plus className="w-3 h-3" />
                                                                                VM
                                                                            </button>
                                                                            <button
                                                                                onClick={() => setEditingPool({ poolid: pool.poolid, comment: pool.comment || '' })}
                                                                                className="p-1.5 text-gray-400 hover:text-white hover:bg-proxmox-hover rounded"
                                                                                title={t('edit') || 'Edit'}
                                                                            >
                                                                                <Icons.Edit className="w-4 h-4" />
                                                                            </button>
                                                                            <button
                                                                                onClick={() => deletePool(pool.poolid)}
                                                                                className="p-1.5 text-red-400 hover:text-red-300 hover:bg-red-500/20 rounded"
                                                                                title={t('delete') || 'Delete'}
                                                                            >
                                                                                <Icons.Trash className="w-4 h-4" />
                                                                            </button>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            ))
                                                        )}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                    
                                    {/* Create Pool Modal */}
                                    {showCreatePool && (
                                        <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-[60]">
                                            <div className="bg-proxmox-darker border border-proxmox-border rounded-xl p-6 w-full max-w-md">
                                                <h3 className="text-lg font-semibold text-white mb-4 flex items-center gap-2">
                                                    <Icons.Plus />
                                                    {t('createPool') || 'Create Pool'}
                                                </h3>
                                                
                                                <div className="space-y-4">
                                                    <div>
                                                        <label className="block text-sm text-gray-400 mb-1">{t('poolId') || 'Pool ID'} *</label>
                                                        <input
                                                            type="text"
                                                            value={newPoolForm.poolid}
                                                            onChange={e => setNewPoolForm({...newPoolForm, poolid: e.target.value.replace(/[^a-zA-Z0-9_-]/g, '')})}
                                                            placeholder="my-pool"
                                                            className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white text-sm"
                                                        />
                                                        <p className="text-xs text-gray-500 mt-1">{t('poolIdHint') || 'Letters, numbers, dashes and underscores only'}</p>
                                                    </div>
                                                    
                                                    <div>
                                                        <label className="block text-sm text-gray-400 mb-1">{t('comment') || 'Description'}</label>
                                                        <input
                                                            type="text"
                                                            value={newPoolForm.comment}
                                                            onChange={e => setNewPoolForm({...newPoolForm, comment: e.target.value})}
                                                            placeholder={t('optionalDescription') || 'Optional description...'}
                                                            className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white text-sm"
                                                        />
                                                    </div>
                                                </div>
                                                
                                                <div className="flex gap-3 mt-6">
                                                    <button
                                                        onClick={createPool}
                                                        disabled={poolManagerLoading || !newPoolForm.poolid.trim()}
                                                        className="flex-1 px-4 py-2 bg-proxmox-orange hover:bg-orange-600 disabled:opacity-50 rounded-lg text-sm font-medium flex items-center justify-center gap-2"
                                                    >
                                                        {poolManagerLoading && <Icons.Loader className="w-4 h-4 animate-spin" />}
                                                        {t('create') || 'Create'}
                                                    </button>
                                                    <button
                                                        onClick={() => { setShowCreatePool(false); setNewPoolForm({ poolid: '', comment: '' }); }}
                                                        className="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg text-sm"
                                                    >
                                                        {t('cancel') || 'Cancel'}
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                    
                                    {/* Edit Pool Modal */}
                                    {editingPool && (
                                        <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-[60]">
                                            <div className="bg-proxmox-darker border border-proxmox-border rounded-xl p-6 w-full max-w-md">
                                                <h3 className="text-lg font-semibold text-white mb-4 flex items-center gap-2">
                                                    <Icons.Edit />
                                                    {t('editPool') || 'Edit Pool'}: {editingPool.poolid}
                                                </h3>
                                                
                                                <div className="space-y-4">
                                                    <div>
                                                        <label className="block text-sm text-gray-400 mb-1">{t('poolId') || 'Pool ID'}</label>
                                                        <input
                                                            type="text"
                                                            value={editingPool.poolid}
                                                            disabled
                                                            className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-gray-500 text-sm cursor-not-allowed"
                                                        />
                                                        <p className="text-xs text-gray-500 mt-1">{t('poolIdCannotChange') || 'Pool ID cannot be changed'}</p>
                                                    </div>
                                                    
                                                    <div>
                                                        <label className="block text-sm text-gray-400 mb-1">{t('comment') || 'Description'}</label>
                                                        <input
                                                            type="text"
                                                            value={editingPool.comment}
                                                            onChange={e => setEditingPool({...editingPool, comment: e.target.value})}
                                                            placeholder={t('optionalDescription') || 'Optional description...'}
                                                            className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white text-sm"
                                                        />
                                                    </div>
                                                </div>
                                                
                                                <div className="flex gap-3 mt-6">
                                                    <button
                                                        onClick={updatePool}
                                                        disabled={poolManagerLoading}
                                                        className="flex-1 px-4 py-2 bg-proxmox-orange hover:bg-orange-600 disabled:opacity-50 rounded-lg text-sm font-medium flex items-center justify-center gap-2"
                                                    >
                                                        {poolManagerLoading && <Icons.Loader className="w-4 h-4 animate-spin" />}
                                                        {t('save') || 'Save'}
                                                    </button>
                                                    <button
                                                        onClick={() => setEditingPool(null)}
                                                        className="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg text-sm"
                                                    >
                                                        {t('cancel') || 'Cancel'}
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                    
                                    {/* Add VM to Pool Modal */}
                                    {showAddVmToPool && (
                                        <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-[60]">
                                            <div className="bg-proxmox-darker border border-proxmox-border rounded-xl p-6 w-full max-w-lg max-h-[70vh] flex flex-col">
                                                <h3 className="text-lg font-semibold text-white mb-4 flex items-center gap-2">
                                                    <Icons.Plus />
                                                    {t('addVmToPool') || 'Add VM to Pool'}: {showAddVmToPool}
                                                </h3>
                                                
                                                <div className="flex-1 overflow-auto">
                                                    {vmsWithoutPool.length === 0 ? (
                                                        <div className="text-center py-8 text-gray-500">
                                                            <Icons.Check className="w-12 h-12 mx-auto mb-2 opacity-50" />
                                                            <p>{t('allVmsInPools') || 'All VMs are already in pools'}</p>
                                                        </div>
                                                    ) : (
                                                        <div className="space-y-2">
                                                            <p className="text-sm text-gray-400 mb-3">{t('selectVmToAdd') || 'Select a VM to add to this pool'}:</p>
                                                            {vmsWithoutPool.map(vm => (
                                                                <button
                                                                    key={vm.vmid}
                                                                    onClick={() => {
                                                                        addVmToPool(showAddVmToPool, vm.vmid);
                                                                        setShowAddVmToPool(null);
                                                                    }}
                                                                    className="w-full flex items-center gap-3 p-3 bg-proxmox-dark hover:bg-proxmox-hover border border-proxmox-border rounded-lg text-left transition-colors"
                                                                >
                                                                    {vm.type === 'qemu' ? (
                                                                        <Icons.Monitor className="w-5 h-5 text-blue-400" />
                                                                    ) : (
                                                                        <Icons.Box className="w-5 h-5 text-yellow-400" />
                                                                    )}
                                                                    <div className="flex-1">
                                                                        <div className="font-medium text-white">{vm.vmid} - {vm.name}</div>
                                                                        <div className="text-xs text-gray-500">{vm.node} ‚Ä¢ {vm.type === 'qemu' ? 'VM' : 'Container'}</div>
                                                                    </div>
                                                                    <span className={`px-2 py-0.5 rounded text-xs ${
                                                                        vm.status === 'running' ? 'bg-green-500/20 text-green-400' : 'bg-gray-500/20 text-gray-400'
                                                                    }`}>
                                                                        {vm.status}
                                                                    </span>
                                                                </button>
                                                            ))}
                                                        </div>
                                                    )}
                                                </div>
                                                
                                                <div className="mt-4 pt-4 border-t border-proxmox-border">
                                                    <button
                                                        onClick={() => setShowAddVmToPool(null)}
                                                        className="w-full px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg text-sm"
                                                    >
                                                        {t('close') || 'Close'}
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                    </div>
                                    )}
                                </div>
                            )}
                            
                            {/* Roles Tab - NS: Dec 2025 */}
                            {activeTab === 'roles' && (
                                <div className="space-y-4">
                                    <div className="flex justify-between items-center">
                                        <h3 className="text-lg font-semibold text-white">{t('customRoles') || 'Custom Roles'}</h3>
                                        <button
                                            onClick={() => setShowAddRole(true)}
                                            className="flex items-center gap-2 px-4 py-2 bg-proxmox-orange hover:bg-orange-600 rounded-lg text-sm font-medium"
                                        >
                                            <Icons.Plus />
                                            {t('createRole') || 'Create Role'}
                                        </button>
                                    </div>
                                    
                                    <p className="text-sm text-gray-400">{t('rolesDesc') || 'Create custom roles with specific permissions. Roles can be global or tenant-specific.'}</p>
                                    
                                    {/* Add Role Form */}
                                    {showAddRole && (
                                        <div className="bg-proxmox-dark border border-proxmox-border rounded-xl p-4">
                                            <h4 className="text-white font-medium mb-4">{t('createRole') || 'Create Role'}</h4>
                                            <form onSubmit={handleCreateRole} className="space-y-4">
                                                <div className="grid grid-cols-3 gap-4">
                                                    <div>
                                                        <label className="block text-sm text-gray-400 mb-1">{t('roleId') || 'Role ID'}</label>
                                                        <input
                                                            type="text"
                                                            value={newRole.id}
                                                            onChange={e => setNewRole({...newRole, id: e.target.value.toLowerCase().replace(/[^a-z0-9_-]/g, '')})}
                                                            placeholder="operator"
                                                            className="w-full px-3 py-2 bg-proxmox-darker border border-proxmox-border rounded-lg text-white text-sm"
                                                            required
                                                        />
                                                    </div>
                                                    <div>
                                                        <label className="block text-sm text-gray-400 mb-1">{t('roleName') || 'Display Name'}</label>
                                                        <input
                                                            type="text"
                                                            value={newRole.name}
                                                            onChange={e => setNewRole({...newRole, name: e.target.value})}
                                                            placeholder="Operator"
                                                            className="w-full px-3 py-2 bg-proxmox-darker border border-proxmox-border rounded-lg text-white text-sm"
                                                        />
                                                    </div>
                                                    <div>
                                                        <label className="block text-sm text-gray-400 mb-1">{t('scope') || 'Scope'}</label>
                                                        <select
                                                            value={newRole.tenant_id}
                                                            onChange={e => setNewRole({...newRole, tenant_id: e.target.value})}
                                                            className="w-full px-3 py-2 bg-proxmox-darker border border-proxmox-border rounded-lg text-white text-sm"
                                                        >
                                                            <option value="">{t('global') || 'Global'}</option>
                                                            {tenants.map(t => (
                                                                <option key={t.id} value={t.id}>{t.name}</option>
                                                            ))}
                                                        </select>
                                                    </div>
                                                </div>
                                                
                                                {/* Permission checkboxes */}
                                                <div>
                                                    <label className="block text-sm text-gray-400 mb-2">{t('permissions') || 'Permissions'}</label>
                                                    <div className="grid grid-cols-4 gap-2 max-h-64 overflow-y-auto bg-proxmox-darker p-3 rounded-lg">
                                                        {allPermissions.map(p => (
                                                            <label key={p.permission} className="flex items-center gap-2 text-xs text-gray-300 cursor-pointer hover:text-white">
                                                                <input
                                                                    type="checkbox"
                                                                    checked={newRole.permissions.includes(p.permission)}
                                                                    onChange={e => {
                                                                        if(e.target.checked) {
                                                                            setNewRole({...newRole, permissions: [...newRole.permissions, p.permission]});
                                                                        } else {
                                                                            setNewRole({...newRole, permissions: newRole.permissions.filter(x => x !== p.permission)});
                                                                        }
                                                                    }}
                                                                    className="rounded border-gray-600"
                                                                />
                                                                {p.permission}
                                                            </label>
                                                        ))}
                                                    </div>
                                                </div>
                                                
                                                <div className="flex gap-2">
                                                    <button type="submit" className="px-4 py-2 bg-proxmox-orange hover:bg-orange-600 rounded-lg text-sm">
                                                        {t('create') || 'Create'}
                                                    </button>
                                                    <button type="button" onClick={() => setShowAddRole(false)} className="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg text-sm">
                                                        {t('cancel') || 'Cancel'}
                                                    </button>
                                                </div>
                                            </form>
                                        </div>
                                    )}
                                    
                                    {/* Roles List */}
                                    <div className="bg-proxmox-dark border border-proxmox-border rounded-xl overflow-hidden">
                                        <table className="w-full">
                                            <thead className="bg-proxmox-darker">
                                                <tr>
                                                    <th className="px-4 py-3 text-left text-sm font-medium text-gray-400">{t('role') || 'Role'}</th>
                                                    <th className="px-4 py-3 text-left text-sm font-medium text-gray-400">{t('scope') || 'Scope'}</th>
                                                    <th className="px-4 py-3 text-left text-sm font-medium text-gray-400">{t('permissions') || 'Permissions'}</th>
                                                    <th className="px-4 py-3 text-right text-sm font-medium text-gray-400">{t('actions') || 'Actions'}</th>
                                                </tr>
                                            </thead>
                                            <tbody className="divide-y divide-proxmox-border">
                                                {allRoles.map(role => (
                                                    <tr key={`${role.id}-${role.tenant_id || 'global'}`} className="hover:bg-proxmox-darker/50">
                                                        <td className="px-4 py-3">
                                                            <div className="font-medium text-white">{role.name || role.id}</div>
                                                            <div className="text-xs text-gray-500">{role.id}</div>
                                                        </td>
                                                        <td className="px-4 py-3">
                                                            <span className={`px-2 py-1 text-xs rounded ${
                                                                role.builtin ? 'bg-blue-500/20 text-blue-400' :
                                                                role.scope === 'global' ? 'bg-purple-500/20 text-purple-400' :
                                                                'bg-green-500/20 text-green-400'
                                                            }`}>
                                                                {role.builtin ? 'Builtin' : role.scope === 'global' ? 'Global' : `Tenant: ${role.tenant_id}`}
                                                            </span>
                                                        </td>
                                                        <td className="px-4 py-3 text-sm text-gray-400">
                                                            {role.permissions?.length || 0} permissions
                                                        </td>
                                                        <td className="px-4 py-3 text-right">
                                                            {!role.builtin && (
                                                                <button
                                                                    onClick={() => handleDeleteRole(role.id, role.tenant_id)}
                                                                    className="text-red-400 hover:text-red-300 text-sm"
                                                                >
                                                                    {t('delete') || 'Delete'}
                                                                </button>
                                                            )}
                                                        </td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                    
                                    {/* Role Templates Section */}
                                    <div className="mt-6">
                                        <h4 className="text-md font-semibold text-white mb-3 flex items-center gap-2">
                                            <Icons.FileText />
                                            {t('roleTemplates') || 'Role Templates'}
                                        </h4>
                                        <p className="text-sm text-gray-400 mb-4">{t('roleTemplatesDesc') || 'Quick-start templates for common role configurations'}</p>
                                        
                                        <div className="grid grid-cols-2 md:grid-cols-3 gap-3">
                                            {roleTemplates.map(tpl => (
                                                <div 
                                                    key={tpl.id}
                                                    className="bg-proxmox-dark border border-proxmox-border rounded-lg p-4 hover:border-proxmox-orange/50 cursor-pointer transition-colors"
                                                    onClick={() => {
                                                        setSelectedTemplate(tpl);
                                                        setTemplateConfig({ role_id: tpl.id, name: tpl.name, tenant_id: '' });
                                                        setShowTemplateModal(true);
                                                    }}
                                                >
                                                    <div className="font-medium text-white text-sm">{tpl.name}</div>
                                                    <div className="text-xs text-gray-500 mt-1">{tpl.description}</div>
                                                    <div className="text-xs text-proxmox-orange mt-2">{tpl.permission_count} {t('permissions') || 'permissions'}</div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                    
                                    {/* Template Apply Modal */}
                                    {showTemplateModal && selectedTemplate && (
                                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
                                            <div className="bg-proxmox-darker border border-proxmox-border rounded-xl p-6 w-full max-w-md">
                                                <h3 className="text-lg font-semibold text-white mb-4">
                                                    {t('createFromTemplate') || 'Create from Template'}: {selectedTemplate.name}
                                                </h3>
                                                
                                                <div className="space-y-4">
                                                    <div>
                                                        <label className="block text-sm text-gray-400 mb-1">{t('roleId') || 'Role ID'}</label>
                                                        <input
                                                            type="text"
                                                            value={templateConfig.role_id}
                                                            onChange={e => setTemplateConfig({...templateConfig, role_id: e.target.value.toLowerCase().replace(/[^a-z0-9_-]/g, '')})}
                                                            className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white text-sm"
                                                        />
                                                    </div>
                                                    <div>
                                                        <label className="block text-sm text-gray-400 mb-1">{t('roleName') || 'Display Name'}</label>
                                                        <input
                                                            type="text"
                                                            value={templateConfig.name}
                                                            onChange={e => setTemplateConfig({...templateConfig, name: e.target.value})}
                                                            className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white text-sm"
                                                        />
                                                    </div>
                                                    <div>
                                                        <label className="block text-sm text-gray-400 mb-1">{t('scope') || 'Scope'}</label>
                                                        <select
                                                            value={templateConfig.tenant_id}
                                                            onChange={e => setTemplateConfig({...templateConfig, tenant_id: e.target.value})}
                                                            className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-white text-sm"
                                                        >
                                                            <option value="">{t('global') || 'Global'}</option>
                                                            {tenants.map(t => (
                                                                <option key={t.id} value={t.id}>{t.name}</option>
                                                            ))}
                                                        </select>
                                                    </div>
                                                    
                                                    <div className="bg-proxmox-dark rounded-lg p-3 max-h-40 overflow-y-auto">
                                                        <div className="text-xs text-gray-400 mb-2">{t('includedPermissions') || 'Included Permissions'}:</div>
                                                        <div className="flex flex-wrap gap-1">
                                                            {selectedTemplate.permissions.map(p => (
                                                                <span key={p} className="px-2 py-0.5 bg-proxmox-darker text-xs text-gray-300 rounded">{p}</span>
                                                            ))}
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <div className="flex gap-2 mt-6">
                                                    <button
                                                        onClick={handleApplyTemplate}
                                                        className="flex-1 px-4 py-2 bg-proxmox-orange hover:bg-orange-600 rounded-lg text-sm font-medium"
                                                    >
                                                        {t('create') || 'Create'}
                                                    </button>
                                                    <button
                                                        onClick={() => { setShowTemplateModal(false); setSelectedTemplate(null); }}
                                                        className="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg text-sm"
                                                    >
                                                        {t('cancel') || 'Cancel'}
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            )}
                            
                            {/* Security Settings Tab */}
                            {activeTab === 'security' && (
                                <SecuritySettingsSection addToast={addToast} />
                            )}
                            
                            {/* Compliance Tab (HIPAA/ISO 27001) */}
                            {activeTab === 'compliance' && (
                                <ComplianceSection addToast={addToast} />
                            )}
                            
                            {/* Server Settings Tab */}
                            {activeTab === 'server' && (
                                <div className="space-y-6">
                                    <h3 className="text-lg font-semibold text-white">{t('serverSettings')}</h3>
                                    
                                    {/* Default Theme for New Users */}
                                    <div className="bg-proxmox-dark border border-proxmox-border rounded-xl p-4 space-y-4">
                                        <h4 className="font-medium text-white flex items-center gap-2">
                                            <Icons.Palette />
                                            {t('defaultTheme') || 'Default Theme'}
                                        </h4>
                                        <p className="text-sm text-gray-400">
                                            {t('defaultThemeDesc') || 'Set the default theme for new users. Users can change their theme in My Profile.'}
                                        </p>
                                        
                                        <div className="grid grid-cols-4 sm:grid-cols-6 md:grid-cols-8 gap-2">
                                            {Object.entries(PEGAPROX_THEMES).map(([key, theme]) => {
                                                const isActive = (serverSettings.default_theme || 'proxmoxDark') === key;
                                                return (
                                                    <button
                                                        key={key}
                                                        onClick={() => setServerSettings({...serverSettings, default_theme: key})}
                                                        className={`p-2 rounded-lg border-2 transition-all hover:scale-105 ${
                                                            isActive 
                                                                ? 'border-proxmox-orange ring-2 ring-proxmox-orange/30' 
                                                                : 'border-proxmox-border hover:border-gray-500'
                                                        }`}
                                                        title={theme.name}
                                                    >
                                                        <div 
                                                            className="h-8 rounded mb-1 relative overflow-hidden"
                                                            style={{ 
                                                                background: theme.colors.darker,
                                                                border: `1px solid ${theme.colors.border}`
                                                            }}
                                                        >
                                                            <div 
                                                                className="absolute inset-1 rounded"
                                                                style={{ background: theme.colors.card }}
                                                            >
                                                                <div 
                                                                    className="w-1/2 h-1 rounded-full m-1"
                                                                    style={{ background: theme.colors.primary }}
                                                                />
                                                            </div>
                                                            {isActive && (
                                                                <div className="absolute top-0 right-0 bg-proxmox-orange rounded-full p-0.5">
                                                                    <Icons.Check className="w-2 h-2 text-white" />
                                                                </div>
                                                            )}
                                                        </div>
                                                        <div className="text-center text-xs truncate">
                                                            {theme.icon}
                                                        </div>
                                                    </button>
                                                );
                                            })}
                                        </div>
                                        <p className="text-xs text-gray-500">
                                            {t('currentDefault') || 'Current default'}: {PEGAPROX_THEMES[serverSettings.default_theme || 'proxmoxDark']?.name || 'Proxmox Dark'}
                                        </p>
                                    </div>
                                    
                                    {/* Domain & Port */}
                                    <div className="bg-proxmox-dark border border-proxmox-border rounded-xl p-4 space-y-4">
                                        <h4 className="font-medium text-white flex items-center gap-2">
                                            <Icons.Globe />
                                            {t('networkSettings')}
                                        </h4>
                                        
                                        <div className="grid grid-cols-2 gap-4">
                                            <div>
                                                <label className="block text-sm text-gray-400 mb-1">{t('domain')}</label>
                                                <input
                                                    type="text"
                                                    value={serverSettings.domain}
                                                    onChange={e => setServerSettings({...serverSettings, domain: e.target.value})}
                                                    placeholder="pegaprox.example.com"
                                                    className="w-full px-3 py-2 bg-proxmox-darker border border-proxmox-border rounded-lg text-white text-sm focus:outline-none focus:border-proxmox-orange"
                                                />
                                                <p className="text-xs text-gray-500 mt-1">{t('domainHint')}</p>
                                            </div>
                                            <div>
                                                <label className="block text-sm text-gray-400 mb-1">{t('port')}</label>
                                                <input
                                                    type="number"
                                                    value={serverSettings.port}
                                                    onChange={e => setServerSettings({...serverSettings, port: parseInt(e.target.value)})}
                                                    min="1"
                                                    max="65535"
                                                    className="w-full px-3 py-2 bg-proxmox-darker border border-proxmox-border rounded-lg text-white text-sm focus:outline-none focus:border-proxmox-orange"
                                                />
                                                <p className="text-xs text-gray-500 mt-1">{t('portHint')}</p>
                                            </div>
                                            <div>
                                                <label className="block text-sm text-gray-400 mb-1">{t('httpRedirectPort') || 'HTTP Redirect Port'}</label>
                                                <input
                                                    type="number"
                                                    value={serverSettings.http_redirect_port || 0}
                                                    onChange={e => setServerSettings({...serverSettings, http_redirect_port: parseInt(e.target.value)})}
                                                    min="-1"
                                                    max="65535"
                                                    className="w-full px-3 py-2 bg-proxmox-darker border border-proxmox-border rounded-lg text-white text-sm focus:outline-none focus:border-proxmox-orange"
                                                />
                                                <p className="text-xs text-gray-500 mt-1">{t('httpRedirectPortHint') || '0 = auto (80 if root), -1 = disabled'}</p>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    {/* SSL/TLS Settings */}
                                    <div className="bg-proxmox-dark border border-proxmox-border rounded-xl p-4 space-y-4">
                                        <div className="flex items-center justify-between">
                                            <h4 className="font-medium text-white flex items-center gap-2">
                                                <Icons.Shield />
                                                {t('sslSettings')}
                                            </h4>
                                            <label className="flex items-center gap-2 cursor-pointer">
                                                <input
                                                    type="checkbox"
                                                    checked={serverSettings.ssl_enabled}
                                                    onChange={e => setServerSettings({...serverSettings, ssl_enabled: e.target.checked})}
                                                    className="rounded border-proxmox-border bg-proxmox-darker"
                                                />
                                                <span className="text-sm text-gray-300">{t('enableSsl')}</span>
                                            </label>
                                        </div>
                                        
                                        {serverSettings.ssl_enabled && (
                                            <div className="space-y-4 pt-2">
                                                <div className="p-3 bg-yellow-500/10 border border-yellow-500/30 rounded-lg">
                                                    <p className="text-sm text-yellow-400">
                                                        ‚ö†Ô∏è {t('sslWarning')}
                                                    </p>
                                                </div>
                                                
                                                <div>
                                                    <label className="block text-sm text-gray-400 mb-1">{t('sslCertificate')} (.pem, .crt)</label>
                                                    <div className="flex gap-2">
                                                        <input
                                                            type="text"
                                                            value={serverSettings.ssl_cert}
                                                            readOnly
                                                            placeholder={t('noCertSelected')}
                                                            className="flex-1 px-3 py-2 bg-proxmox-darker border border-proxmox-border rounded-lg text-white text-sm"
                                                        />
                                                        <label className="px-4 py-2 bg-proxmox-hover hover:bg-proxmox-border rounded-lg text-sm cursor-pointer transition-colors">
                                                            <input
                                                                type="file"
                                                                accept=".pem,.crt,.cer"
                                                                onChange={e => handleCertFileChange(e, 'cert')}
                                                                className="hidden"
                                                            />
                                                            {t('browse')}
                                                        </label>
                                                    </div>
                                                </div>
                                                
                                                <div>
                                                    <label className="block text-sm text-gray-400 mb-1">{t('sslKey')} (.pem, .key)</label>
                                                    <div className="flex gap-2">
                                                        <input
                                                            type="text"
                                                            value={serverSettings.ssl_key}
                                                            readOnly
                                                            placeholder={t('noKeySelected')}
                                                            className="flex-1 px-3 py-2 bg-proxmox-darker border border-proxmox-border rounded-lg text-white text-sm"
                                                        />
                                                        <label className="px-4 py-2 bg-proxmox-hover hover:bg-proxmox-border rounded-lg text-sm cursor-pointer transition-colors">
                                                            <input
                                                                type="file"
                                                                accept=".pem,.key"
                                                                onChange={e => handleCertFileChange(e, 'key')}
                                                                className="hidden"
                                                            />
                                                            {t('browse')}
                                                        </label>
                                                    </div>
                                                </div>
                                                
                                                <div className="p-3 bg-blue-500/10 border border-blue-500/30 rounded-lg">
                                                    <p className="text-sm text-blue-400">
                                                        üí° {t('sslHint')}
                                                    </p>
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                    
                                    {/* NS: SMTP Settings - Dec 2025 */}
                                    <div className="bg-proxmox-dark border border-proxmox-border rounded-xl p-4 space-y-4">
                                        <div className="flex items-center justify-between">
                                            <h4 className="font-medium text-white flex items-center gap-2">
                                                <Icons.Mail />
                                                {t('smtpSettings')}
                                            </h4>
                                            <label className="flex items-center gap-2 cursor-pointer">
                                                <input
                                                    type="checkbox"
                                                    checked={serverSettings.smtp_enabled}
                                                    onChange={e => setServerSettings({...serverSettings, smtp_enabled: e.target.checked})}
                                                    className="rounded border-proxmox-border bg-proxmox-darker"
                                                />
                                                <span className="text-sm text-gray-300">{t('enabled')}</span>
                                            </label>
                                        </div>
                                        
                                        {serverSettings.smtp_enabled && (
                                            <div className="space-y-4 pt-2">
                                                <div className="grid grid-cols-2 gap-4">
                                                    <div>
                                                        <label className="block text-sm text-gray-400 mb-1">{t('smtpHost')}</label>
                                                        <input
                                                            type="text"
                                                            value={serverSettings.smtp_host}
                                                            onChange={e => setServerSettings({...serverSettings, smtp_host: e.target.value})}
                                                            placeholder="smtp.gmail.com"
                                                            className="w-full px-3 py-2 bg-proxmox-darker border border-proxmox-border rounded-lg text-white text-sm"
                                                        />
                                                    </div>
                                                    <div>
                                                        <label className="block text-sm text-gray-400 mb-1">{t('smtpPort')}</label>
                                                        <input
                                                            type="number"
                                                            value={serverSettings.smtp_port}
                                                            onChange={e => setServerSettings({...serverSettings, smtp_port: parseInt(e.target.value)})}
                                                            className="w-full px-3 py-2 bg-proxmox-darker border border-proxmox-border rounded-lg text-white text-sm"
                                                        />
                                                    </div>
                                                </div>
                                                
                                                <div className="grid grid-cols-2 gap-4">
                                                    <div>
                                                        <label className="block text-sm text-gray-400 mb-1">{t('smtpUser')}</label>
                                                        <input
                                                            type="text"
                                                            value={serverSettings.smtp_user}
                                                            onChange={e => setServerSettings({...serverSettings, smtp_user: e.target.value})}
                                                            placeholder="user@example.com"
                                                            className="w-full px-3 py-2 bg-proxmox-darker border border-proxmox-border rounded-lg text-white text-sm"
                                                        />
                                                    </div>
                                                    <div>
                                                        <label className="block text-sm text-gray-400 mb-1">{t('smtpPassword')}</label>
                                                        <input
                                                            type="password"
                                                            value={serverSettings.smtp_password}
                                                            onChange={e => setServerSettings({...serverSettings, smtp_password: e.target.value})}
                                                            placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                                                            className="w-full px-3 py-2 bg-proxmox-darker border border-proxmox-border rounded-lg text-white text-sm"
                                                        />
                                                    </div>
                                                </div>
                                                
                                                <div className="grid grid-cols-2 gap-4">
                                                    <div>
                                                        <label className="block text-sm text-gray-400 mb-1">{t('smtpFromEmail')}</label>
                                                        <input
                                                            type="email"
                                                            value={serverSettings.smtp_from_email}
                                                            onChange={e => setServerSettings({...serverSettings, smtp_from_email: e.target.value})}
                                                            placeholder="noreply@example.com"
                                                            className="w-full px-3 py-2 bg-proxmox-darker border border-proxmox-border rounded-lg text-white text-sm"
                                                        />
                                                    </div>
                                                    <div>
                                                        <label className="block text-sm text-gray-400 mb-1">{t('smtpFromName')}</label>
                                                        <input
                                                            type="text"
                                                            value={serverSettings.smtp_from_name}
                                                            onChange={e => setServerSettings({...serverSettings, smtp_from_name: e.target.value})}
                                                            placeholder="PegaProx Alerts"
                                                            className="w-full px-3 py-2 bg-proxmox-darker border border-proxmox-border rounded-lg text-white text-sm"
                                                        />
                                                    </div>
                                                </div>
                                                
                                                <div className="flex gap-6">
                                                    <label className="flex items-center gap-2 cursor-pointer">
                                                        <input
                                                            type="checkbox"
                                                            checked={serverSettings.smtp_tls}
                                                            onChange={e => setServerSettings({...serverSettings, smtp_tls: e.target.checked, smtp_ssl: e.target.checked ? false : serverSettings.smtp_ssl})}
                                                            className="rounded"
                                                        />
                                                        <span className="text-sm text-gray-300">{t('smtpTls')} (STARTTLS)</span>
                                                    </label>
                                                    <label className="flex items-center gap-2 cursor-pointer">
                                                        <input
                                                            type="checkbox"
                                                            checked={serverSettings.smtp_ssl}
                                                            onChange={e => setServerSettings({...serverSettings, smtp_ssl: e.target.checked, smtp_tls: e.target.checked ? false : serverSettings.smtp_tls})}
                                                            className="rounded"
                                                        />
                                                        <span className="text-sm text-gray-300">{t('smtpSsl')} (SSL/TLS)</span>
                                                    </label>
                                                </div>
                                                
                                                {/* Test Email */}
                                                <div className="pt-3 border-t border-proxmox-border">
                                                    <label className="block text-sm text-gray-400 mb-1">{t('testEmail')}</label>
                                                    <div className="flex gap-2">
                                                        <input
                                                            type="email"
                                                            value={testEmailAddress}
                                                            onChange={e => setTestEmailAddress(e.target.value)}
                                                            placeholder="test@example.com"
                                                            className="flex-1 px-3 py-2 bg-proxmox-darker border border-proxmox-border rounded-lg text-white text-sm"
                                                        />
                                                        <button
                                                            onClick={handleTestEmail}
                                                            disabled={testEmailLoading || !serverSettings.smtp_host}
                                                            className="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg text-sm font-medium transition-colors disabled:opacity-50"
                                                        >
                                                            {testEmailLoading ? '...' : t('testEmail')}
                                                        </button>
                                                    </div>
                                                </div>
                                                
                                                {/* Save SMTP Button */}
                                                <div className="pt-3 flex justify-end">
                                                    <button
                                                        onClick={handleSaveSMTPSettings}
                                                        disabled={smtpLoading}
                                                        className="px-4 py-2 bg-proxmox-orange hover:bg-orange-600 rounded-lg text-sm font-medium transition-colors disabled:opacity-50 flex items-center gap-2"
                                                    >
                                                        {smtpLoading && <Icons.Loader className="w-4 h-4 animate-spin" />}
                                                        {t('saveSmtpSettings') || 'Save SMTP Settings'}
                                                    </button>
                                                </div>
                                            </div>
                                        )}
                                        
                                        {/* Save SMTP Button - always visible when disabled to allow enabling */}
                                        {!serverSettings.smtp_enabled && (
                                            <div className="pt-3 flex justify-end border-t border-proxmox-border mt-3">
                                                <p className="text-xs text-gray-500 mr-auto my-auto">
                                                    {t('enableSmtpHint') || 'Enable SMTP to configure email settings'}
                                                </p>
                                                <button
                                                    onClick={handleSaveSMTPSettings}
                                                    disabled={smtpLoading}
                                                    className="px-4 py-2 bg-proxmox-orange hover:bg-orange-600 rounded-lg text-sm font-medium transition-colors disabled:opacity-50 flex items-center gap-2"
                                                >
                                                    {smtpLoading && <Icons.Loader className="w-4 h-4 animate-spin" />}
                                                    {t('save') || 'Save'}
                                                </button>
                                            </div>
                                        )}
                                    </div>
                                    
                                    {/* Alert Email Recipients */}
                                    <div className="bg-proxmox-dark border border-proxmox-border rounded-xl p-4 space-y-4">
                                        <h4 className="font-medium text-white flex items-center gap-2">
                                            <Icons.Bell />
                                            {t('emailRecipients')}
                                        </h4>
                                        <p className="text-sm text-gray-400">{t('alertsDesc')}</p>
                                        
                                        <div className="space-y-2">
                                            {(serverSettings.alert_email_recipients || []).map((email, idx) => (
                                                <div key={idx} className="flex items-center gap-2">
                                                    <span className="flex-1 px-3 py-2 bg-proxmox-darker border border-proxmox-border rounded-lg text-white text-sm">{email}</span>
                                                    <button
                                                        onClick={() => setServerSettings({
                                                            ...serverSettings,
                                                            alert_email_recipients: serverSettings.alert_email_recipients.filter((_, i) => i !== idx)
                                                        })}
                                                        className="p-2 text-red-400 hover:text-red-300"
                                                    >
                                                        <Icons.Trash />
                                                    </button>
                                                </div>
                                            ))}
                                            
                                            <div className="flex gap-2">
                                                <input
                                                    type="email"
                                                    id="newRecipientEmail"
                                                    placeholder="admin@example.com"
                                                    className="flex-1 px-3 py-2 bg-proxmox-darker border border-proxmox-border rounded-lg text-white text-sm"
                                                />
                                                <button
                                                    onClick={() => {
                                                        const input = document.getElementById('newRecipientEmail');
                                                        if (input.value && input.value.includes('@')) {
                                                            setServerSettings({
                                                                ...serverSettings,
                                                                alert_email_recipients: [...(serverSettings.alert_email_recipients || []), input.value]
                                                            });
                                                            input.value = '';
                                                        }
                                                    }}
                                                    className="px-4 py-2 bg-proxmox-hover hover:bg-proxmox-border rounded-lg text-sm"
                                                >
                                                    {t('addRecipient')}
                                                </button>
                                            </div>
                                        </div>
                                        
                                        <div>
                                            <label className="block text-sm text-gray-400 mb-1">{t('alertCooldown')}</label>
                                            <input
                                                type="number"
                                                value={serverSettings.alert_cooldown}
                                                onChange={e => setServerSettings({...serverSettings, alert_cooldown: parseInt(e.target.value)})}
                                                min="60"
                                                className="w-32 px-3 py-2 bg-proxmox-darker border border-proxmox-border rounded-lg text-white text-sm"
                                            />
                                            <span className="text-xs text-gray-500 ml-2">(min 60s)</span>
                                        </div>
                                    </div>
                                    
                                    {/* Save Button */}
                                    <div className="flex justify-end gap-3">
                                        <button
                                            onClick={handleSaveServerSettings}
                                            disabled={serverLoading}
                                            className="flex items-center gap-2 px-6 py-2 bg-proxmox-orange hover:bg-orange-600 rounded-lg text-sm font-medium transition-colors disabled:opacity-50"
                                        >
                                            {serverLoading ? <Icons.RotateCw /> : <Icons.Save />}
                                            {t('saveSettings')}
                                        </button>
                                    </div>
                                    
                                    {/* Restart Server Section */}
                                    <div className="p-4 bg-red-500/10 border border-red-500/30 rounded-xl">
                                        <div className="flex items-center justify-between">
                                            <div>
                                                <h4 className="font-medium text-white flex items-center gap-2">
                                                    <Icons.RefreshCw />
                                                    {t('restartServer')}
                                                </h4>
                                                <p className="text-sm text-gray-400 mt-1">
                                                    {t('restartServerDesc')}
                                                </p>
                                            </div>
                                            <button
                                                onClick={() => setShowRestartConfirm(true)}
                                                className="flex items-center gap-2 px-4 py-2 bg-red-600 hover:bg-red-700 rounded-lg text-sm font-medium transition-colors"
                                            >
                                                <Icons.Power />
                                                {t('restartNow')}
                                            </button>
                                        </div>
                                    </div>
                                    
                                    {/* Info Box */}
                                    <div className="p-4 bg-proxmox-dark border border-proxmox-border rounded-xl">
                                        <h4 className="font-medium text-white mb-2">{t('restartInfo')}</h4>
                                        <p className="text-sm text-gray-400">
                                            {t('restartInfoDesc')}
                                        </p>
                                    </div>
                                </div>
                            )}
                            
                            {/* Restart Confirmation Modal */}
                            {showRestartConfirm && (
                                <div className="fixed inset-0 z-[70] flex items-center justify-center p-4 bg-black/80">
                                    <div className="w-full max-w-md bg-proxmox-card border border-red-500/30 rounded-xl overflow-hidden animate-scale-in">
                                        <div className="p-6 border-b border-red-500/30 bg-red-500/10">
                                            <div className="flex items-center gap-3">
                                                <div className="p-3 rounded-full bg-red-500/20">
                                                    <Icons.AlertTriangle />
                                                </div>
                                                <div>
                                                    <h3 className="text-lg font-semibold text-white">{t('confirmRestart')}</h3>
                                                    <p className="text-sm text-red-400">{t('restartWarning')}</p>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div className="p-6">
                                            <p className="text-gray-300 mb-4">{t('restartConfirmText')}</p>
                                            <ul className="text-sm text-gray-400 space-y-1 mb-4">
                                                <li>‚Ä¢ {t('restartEffect1')}</li>
                                                <li>‚Ä¢ {t('restartEffect2')}</li>
                                                <li>‚Ä¢ {t('restartEffect3')}</li>
                                            </ul>
                                        </div>
                                        
                                        <div className="flex items-center justify-end gap-3 p-4 border-t border-proxmox-border bg-proxmox-dark">
                                            <button 
                                                onClick={() => setShowRestartConfirm(false)} 
                                                className="px-4 py-2 text-gray-300 hover:text-white"
                                            >
                                                {t('cancel')}
                                            </button>
                                            <button
                                                onClick={handleRestartServer}
                                                disabled={restartLoading}
                                                className="flex items-center gap-2 px-4 py-2 bg-red-600 rounded-lg text-white hover:bg-red-700 disabled:opacity-50"
                                            >
                                                {restartLoading ? (
                                                    <>
                                                        <Icons.RotateCw />
                                                        {t('restarting')}
                                                    </>
                                                ) : (
                                                    <>
                                                        <Icons.Power />
                                                        {t('yesRestart')}
                                                    </>
                                                )}
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            )}
                            
                            {activeTab === 'audit' && (
                                <div className="space-y-4">
                                    {/* Filters and Export */}
                                    <div className="flex items-center justify-between gap-4">
                                        <div className="flex items-center gap-3">
                                            <select
                                                value={userFilter}
                                                onChange={e => setUserFilter(e.target.value)}
                                                className="px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-sm text-white focus:outline-none focus:border-proxmox-orange"
                                            >
                                                <option value="">{t('allUsers')}</option>
                                                {uniqueUsers.map(u => (
                                                    <option key={u} value={u}>{u}</option>
                                                ))}
                                            </select>
                                            <select
                                                value={actionFilter}
                                                onChange={e => setActionFilter(e.target.value)}
                                                className="px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-sm text-white focus:outline-none focus:border-proxmox-orange"
                                            >
                                                <option value="">{t('allActions')}</option>
                                                {uniqueActions.map(a => (
                                                    <option key={a} value={a}>{getActionLabel(a)}</option>
                                                ))}
                                            </select>
                                        </div>
                                        <div className="flex items-center gap-2">
                                            <button
                                                onClick={fetchAuditLogs}
                                                className="flex items-center gap-2 px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-sm text-gray-300 hover:text-white hover:border-proxmox-orange transition-colors"
                                            >
                                                <Icons.RefreshCw />
                                                {t('refreshAuditLog')}
                                            </button>
                                            <button
                                                onClick={exportAuditLog}
                                                className="flex items-center gap-2 px-3 py-2 bg-proxmox-orange hover:bg-orange-600 rounded-lg text-sm font-medium transition-colors"
                                            >
                                                <Icons.Download />
                                                {t('exportAuditLog')}
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <p className="text-sm text-gray-400">{t('auditLogDescription')}</p>
                                    
                                    {/* Audit Log Table */}
                                    <div className="bg-proxmox-dark border border-proxmox-border rounded-xl overflow-hidden">
                                        <div className="max-h-[400px] overflow-auto">
                                            <table className="w-full">
                                                <thead className="sticky top-0 bg-proxmox-dark">
                                                    <tr className="border-b border-proxmox-border">
                                                        <th className="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase">{t('timestamp')}</th>
                                                        <th className="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase">{t('usernameLabel')}</th>
                                                        <th className="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase">{t('cluster')}</th>
                                                        <th className="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase">{t('action')}</th>
                                                        <th className="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase">{t('details')}</th>
                                                        <th className="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase">{t('ipAddress')}</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {filteredLogs.length === 0 ? (
                                                        <tr>
                                                            <td colSpan="6" className="px-4 py-8 text-center text-gray-400">
                                                                {t('noAuditLogs')}
                                                            </td>
                                                        </tr>
                                                    ) : (
                                                        filteredLogs.map((log, idx) => (
                                                            <tr key={idx} className="border-b border-gray-700/50 hover:bg-proxmox-hover">
                                                                <td className="px-4 py-3 text-gray-400 text-sm whitespace-nowrap">
                                                                    {new Date(log.timestamp).toLocaleString()}
                                                                </td>
                                                                <td className="px-4 py-3 text-white font-medium">{log.user}</td>
                                                                <td className="px-4 py-3 text-sm">
                                                                    {log.cluster ? (
                                                                        <span className="px-2 py-1 rounded bg-proxmox-dark border border-proxmox-border text-proxmox-orange text-xs">
                                                                            {log.cluster}
                                                                        </span>
                                                                    ) : (
                                                                        <span className="text-gray-500">-</span>
                                                                    )}
                                                                </td>
                                                                <td className="px-4 py-3">
                                                                    <span className={`px-2 py-1 rounded text-xs font-medium ${
                                                                        log.action.includes('login') ? 'bg-green-500/10 text-green-400' :
                                                                        log.action.includes('logout') ? 'bg-yellow-500/10 text-yellow-400' :
                                                                        log.action.includes('delete') ? 'bg-red-500/10 text-red-400' :
                                                                        log.action.includes('create') || log.action.includes('added') ? 'bg-blue-500/10 text-blue-400' :
                                                                        'bg-gray-500/10 text-gray-400'
                                                                    }`}>
                                                                        {getActionLabel(log.action)}
                                                                    </span>
                                                                </td>
                                                                <td className="px-4 py-3 text-gray-300 text-sm max-w-xs truncate" title={log.details}>
                                                                    {log.details || '-'}
                                                                </td>
                                                                <td className="px-4 py-3 text-gray-400 text-sm font-mono">
                                                                    {log.ip_address || '-'}
                                                                </td>
                                                            </tr>
                                                        ))
                                                    )}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            )}
                            
                            {/* Updates Tab */}
                            {activeTab === 'updates' && (
                                <div className="space-y-6">
                                    {/* Current Version */}
                                    <div className="bg-proxmox-dark border border-proxmox-border rounded-xl p-6">
                                        <div className="flex items-center justify-between">
                                            <div>
                                                <h3 className="text-lg font-semibold text-white flex items-center gap-2">
                                                    <Icons.Package />
                                                    Current Version
                                                </h3>
                                                <div className="mt-2 space-y-1">
                                                    <p className="text-2xl font-bold text-proxmox-orange">
                                                        PegaProx {updateInfo?.current_version || PEGAPROX_VERSION}
                                                    </p>
                                                    <p className="text-sm text-gray-400">
                                                        Build: {updateInfo?.current_build || '2026.01'}
                                                    </p>
                                                </div>
                                            </div>
                                            <button
                                                onClick={checkForUpdates}
                                                disabled={updateLoading}
                                                className="flex items-center gap-2 px-4 py-2 bg-proxmox-orange hover:bg-orange-600 disabled:bg-gray-600 rounded-lg text-sm font-medium transition-colors"
                                            >
                                                {updateLoading ? (
                                                    <Icons.Loader className="animate-spin" />
                                                ) : (
                                                    <Icons.RefreshCw />
                                                )}
                                                Check for Updates
                                            </button>
                                        </div>
                                    </div>
                                    
                                    {/* Error */}
                                    {updateError && (
                                        <div className="bg-red-500/10 border border-red-500/30 rounded-xl p-4 flex items-center gap-3">
                                            <Icons.AlertTriangle className="text-red-400" />
                                            <span className="text-red-400">{updateError}</span>
                                        </div>
                                    )}
                                    
                                    {/* Update Available */}
                                    {updateInfo?.update_available && (
                                        <div className="bg-green-500/10 border border-green-500/30 rounded-xl p-6">
                                            <div className="flex items-start justify-between">
                                                <div>
                                                    <h3 className="text-lg font-semibold text-green-400 flex items-center gap-2">
                                                        <Icons.Download />
                                                        {t('updateAvailable') || 'Update Available!'}
                                                    </h3>
                                                    <p className="text-2xl font-bold text-white mt-2">
                                                        Version {updateInfo.latest_version}
                                                    </p>
                                                    <p className="text-sm text-gray-400 mt-1">
                                                        {t('released') || 'Released'}: {updateInfo.release_date || 'Unknown'}
                                                    </p>
                                                </div>
                                                <button
                                                    onClick={performUpdate}
                                                    disabled={updateLoading || updateProgress}
                                                    className="flex items-center gap-2 px-6 py-3 bg-green-500 hover:bg-green-600 disabled:bg-gray-600 rounded-lg font-medium transition-colors"
                                                >
                                                    {updateLoading ? (
                                                        <Icons.Loader className="animate-spin" />
                                                    ) : (
                                                        <Icons.Download />
                                                    )}
                                                    {t('installUpdate') || 'Install Update'}
                                                </button>
                                            </div>
                                            
                                            {/* Changelog */}
                                            {updateInfo.changelog && updateInfo.changelog.length > 0 && (
                                                <div className="mt-4 pt-4 border-t border-green-500/30">
                                                    <h4 className="text-sm font-medium text-gray-300 mb-2">{t('whatsNew') || "What's New"}:</h4>
                                                    <ul className="space-y-1">
                                                        {updateInfo.changelog.map((item, idx) => (
                                                            <li key={idx} className="text-sm text-gray-400 flex items-start gap-2">
                                                                <span className="text-green-400 mt-1">‚Ä¢</span>
                                                                {item}
                                                            </li>
                                                        ))}
                                                    </ul>
                                                </div>
                                            )}
                                            
                                            {/* Breaking Changes */}
                                            {updateInfo.breaking_changes && updateInfo.breaking_changes.length > 0 && (
                                                <div className="mt-4 pt-4 border-t border-yellow-500/30 bg-yellow-500/5 rounded-lg p-3">
                                                    <h4 className="text-sm font-medium text-yellow-400 mb-2 flex items-center gap-2">
                                                        <Icons.AlertTriangle />
                                                        {t('breakingChanges') || 'Breaking Changes'}:
                                                    </h4>
                                                    <ul className="space-y-1">
                                                        {updateInfo.breaking_changes.map((item, idx) => (
                                                            <li key={idx} className="text-sm text-yellow-300">{item}</li>
                                                        ))}
                                                    </ul>
                                                </div>
                                            )}
                                        </div>
                                    )}
                                    
                                    {/* Update Progress */}
                                    {updateProgress && (
                                        <div className="bg-blue-500/10 border border-blue-500/30 rounded-xl p-6">
                                            <div className="flex items-center gap-4">
                                                <div className="relative">
                                                    <Icons.Loader className="w-8 h-8 text-blue-400 animate-spin" />
                                                </div>
                                                <div>
                                                    <h3 className="text-lg font-semibold text-blue-400">
                                                        {updateProgress.status === 'downloading' && (t('downloadingUpdate') || 'Downloading Update...')}
                                                        {updateProgress.status === 'installing' && (t('installingUpdate') || 'Installing Update...')}
                                                        {updateProgress.status === 'restarting' && (t('serverRestarting') || 'Server Restarting...')}
                                                        {updateProgress.status === 'reconnecting' && (t('reconnecting') || 'Reconnecting...')}
                                                        {updateProgress.status === 'restoring' && (t('restoringBackup') || 'Restoring from Backup...')}
                                                    </h3>
                                                    <p className="text-sm text-gray-400 mt-1">{updateProgress.message}</p>
                                                </div>
                                            </div>
                                            <div className="mt-4 w-full bg-proxmox-dark rounded-full h-2 overflow-hidden">
                                                <div className="h-full bg-blue-500 animate-pulse" style={{ width: '100%' }} />
                                            </div>
                                            <p className="text-xs text-gray-500 mt-2">
                                                {t('doNotCloseWindow') || 'Please do not close this window...'}
                                            </p>
                                        </div>
                                    )}
                                    
                                    {/* No Update Available - only show if no error */}
                                    {updateInfo && !updateInfo.update_available && !updateInfo.error && (
                                        <div className="bg-proxmox-dark border border-proxmox-border rounded-xl p-6 text-center">
                                            <Icons.CheckCircle className="w-12 h-12 text-green-400 mx-auto mb-3" />
                                            <h3 className="text-lg font-semibold text-white">You're up to date!</h3>
                                            <p className="text-gray-400 mt-1">
                                                PegaProx {updateInfo.current_version} is the latest version.
                                            </p>
                                        </div>
                                    )}
                                    
                                    {/* Rollback Section - NS Jan 2026 */}
                                    <div className="bg-proxmox-dark border border-proxmox-border rounded-xl p-6">
                                        <div className="flex items-center justify-between">
                                            <div>
                                                <h3 className="text-lg font-semibold text-white flex items-center gap-2">
                                                    <Icons.RotateCcw />
                                                    {t('rollback') || 'Rollback'}
                                                </h3>
                                                <p className="text-sm text-gray-400 mt-1">
                                                    {t('rollbackDesc') || 'Restore a previous version from backup'}
                                                </p>
                                            </div>
                                            <button
                                                onClick={() => { loadBackups(); setShowRollbackModal(true); }}
                                                disabled={updateLoading || updateProgress}
                                                className="flex items-center gap-2 px-4 py-2 bg-yellow-600 hover:bg-yellow-700 disabled:bg-gray-600 rounded-lg text-sm font-medium transition-colors"
                                            >
                                                <Icons.RotateCcw />
                                                {t('viewBackups') || 'View Backups'}
                                            </button>
                                        </div>
                                    </div>
                                    
                                    {/* Update Instructions */}
                                    {updateInfo?.instructions && (
                                        <div className="bg-blue-500/10 border border-blue-500/30 rounded-xl p-6">
                                            <h3 className="text-lg font-semibold text-blue-400 flex items-center gap-2 mb-4">
                                                <Icons.FileText />
                                                Update Instructions
                                            </h3>
                                            <div className="bg-proxmox-dark rounded-lg p-4 font-mono text-sm">
                                                {updateInfo.instructions.map((line, idx) => (
                                                    <p key={idx} className={`${line.startsWith('#') ? 'text-gray-500' : 'text-gray-300'} ${line === '' ? 'h-4' : ''}`}>
                                                        {line || '\u00A0'}
                                                    </p>
                                                ))}
                                            </div>
                                            {updateInfo.backup_path && (
                                                <p className="text-sm text-gray-400 mt-3">
                                                    ‚úì Backup created: <code className="text-green-400">{updateInfo.backup_path}</code>
                                                </p>
                                            )}
                                            {updateInfo.download_url && (
                                                <a
                                                    href={updateInfo.download_url}
                                                    target="_blank"
                                                    rel="noopener noreferrer"
                                                    className="inline-flex items-center gap-2 mt-4 px-4 py-2 bg-blue-500 hover:bg-blue-600 rounded-lg text-sm font-medium transition-colors"
                                                >
                                                    <Icons.ExternalLink />
                                                    Open GitHub Release
                                                </a>
                                            )}
                                        </div>
                                    )}
                                    
                                    {/* GitHub Link */}
                                    <div className="text-center text-sm text-gray-500">
                                        <a 
                                            href="https://github.com/PegaProx/project-pegaprox" 
                                            target="_blank"
                                            rel="noopener noreferrer"
                                            className="hover:text-proxmox-orange transition-colors inline-flex items-center gap-1"
                                        >
                                            <Icons.Github />
                                            View on GitHub
                                        </a>
                                    </div>
                                </div>
                            )}
                            
                            {/* About Tab - LW styled this */}
                            {activeTab === 'about' && (
                                <div className="space-y-6">
                                    {/* Version Info */}
                                    <div className="bg-proxmox-dark border border-proxmox-border rounded-xl p-6 text-center">
                                        <div className="inline-flex items-center justify-center w-20 h-20 rounded-2xl mb-4">
                                            <img src="/images/pegaprox.png" alt="PegaProx" className="w-20 h-20 object-contain" />
                                        </div>
                                        <h2 className="text-3xl font-bold text-white">PegaProx</h2>
                                        <p className="text-xl text-proxmox-orange mt-1">{PEGAPROX_VERSION}</p>
                                        <p className="text-sm text-gray-400 mt-2">Multi-Cluster Proxmox Management</p>
                                        <p className="text-xs text-gray-500 mt-1">Build 2026.01 ‚Ä¢ ¬© 2025-2026 PegaProx Team</p>
                                    </div>
                                    
                                    {/* Team */}
                                    <div className="bg-proxmox-dark border border-proxmox-border rounded-xl p-6">
                                        <h3 className="text-lg font-semibold text-white mb-4 flex items-center gap-2">
                                            <Icons.Users />
                                            {t('developmentTeam') || 'Development Team'}
                                        </h3>
                                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                            <div className="bg-proxmox-darker rounded-lg p-4 text-center">
                                                <div className="w-12 h-12 rounded-full bg-proxmox-orange/20 flex items-center justify-center mx-auto mb-2">
                                                    <span className="text-proxmox-orange font-bold">NS</span>
                                                </div>
                                                <h4 className="font-medium text-white">Nico Schmidt</h4>
                                                <p className="text-sm text-gray-400">Lead Developer & Founder</p>
                                            </div>
                                            <div className="bg-proxmox-darker rounded-lg p-4 text-center">
                                                <div className="w-12 h-12 rounded-full bg-blue-500/20 flex items-center justify-center mx-auto mb-2">
                                                    <span className="text-blue-400 font-bold">MK</span>
                                                </div>
                                                <h4 className="font-medium text-white">Marcus Kellermann</h4>
                                                <p className="text-sm text-gray-400">Backend Developer</p>
                                            </div>
                                            <div className="bg-proxmox-darker rounded-lg p-4 text-center">
                                                <div className="w-12 h-12 rounded-full bg-pink-500/20 flex items-center justify-center mx-auto mb-2">
                                                    <span className="text-pink-400 font-bold">LW</span>
                                                </div>
                                                <h4 className="font-medium text-white">Laura Weber</h4>
                                                <p className="text-sm text-gray-400">Frontend Developer</p>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    {/* Credits & Acknowledgments */}
                                    <div className="bg-proxmox-dark border border-proxmox-border rounded-xl p-6">
                                        <h3 className="text-lg font-semibold text-white mb-4 flex items-center gap-2">
                                            <Icons.Heart />
                                            {t('creditsAcknowledgments') || 'Credits & Acknowledgments'}
                                        </h3>
                                        <div className="space-y-4">
                                            {/* ProxLB Credit */}
                                            <div className="bg-proxmox-darker rounded-lg p-4">
                                                <div className="flex items-start gap-4">
                                                    <div className="w-12 h-12 rounded-lg bg-green-500/20 flex items-center justify-center flex-shrink-0">
                                                        <Icons.Scale />
                                                    </div>
                                                    <div>
                                                        <h4 className="font-medium text-white">ProxLB by gyptazy</h4>
                                                        <p className="text-sm text-gray-400 mt-1">
                                                            Our load balancing functionality is based on the excellent work from ProxLB. 
                                                            Special thanks to gyptazy for creating and open-sourcing this amazing tool!
                                                        </p>
                                                        <a 
                                                            href="https://github.com/gyptazy/ProxLB" 
                                                            target="_blank"
                                                            rel="noopener noreferrer"
                                                            className="inline-flex items-center gap-1 text-sm text-proxmox-orange hover:underline mt-2"
                                                        >
                                                            <Icons.Github className="w-4 h-4" />
                                                            github.com/gyptazy/ProxLB
                                                            <Icons.ExternalLink className="w-3 h-3" />
                                                        </a>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            {/* ProxSnap Credit */}
                                            <div className="bg-proxmox-darker rounded-lg p-4">
                                                <div className="flex items-start gap-4">
                                                    <div className="w-12 h-12 rounded-lg bg-blue-500/20 flex items-center justify-center flex-shrink-0">
                                                        <Icons.Camera />
                                                    </div>
                                                    <div>
                                                        <h4 className="font-medium text-white">ProxSnap by gyptazy</h4>
                                                        <p className="text-sm text-gray-400 mt-1">
                                                            The snapshot overview feature was inspired by ProxSnap - a powerful CLI tool 
                                                            for managing Proxmox snapshots. Thanks to gyptazy for the great contribution!
                                                        </p>
                                                        <a 
                                                            href="https://github.com/gyptazy/ProxSnap" 
                                                            target="_blank"
                                                            rel="noopener noreferrer"
                                                            className="inline-flex items-center gap-1 text-sm text-proxmox-orange hover:underline mt-2"
                                                        >
                                                            <Icons.Github className="w-4 h-4" />
                                                            github.com/gyptazy/ProxSnap
                                                            <Icons.ExternalLink className="w-3 h-3" />
                                                        </a>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            {/* Other Credits */}
                                            <div className="grid grid-cols-2 md:grid-cols-4 gap-3 text-center text-sm">
                                                <div className="bg-proxmox-darker rounded-lg p-3">
                                                    <p className="text-gray-400">Proxmox VE</p>
                                                    <p className="text-white font-medium">API Integration</p>
                                                </div>
                                                <div className="bg-proxmox-darker rounded-lg p-3">
                                                    <p className="text-gray-400">noVNC</p>
                                                    <p className="text-white font-medium">Console Access</p>
                                                </div>
                                                <div className="bg-proxmox-darker rounded-lg p-3">
                                                    <p className="text-gray-400">xterm.js</p>
                                                    <p className="text-white font-medium">Terminal Emulator</p>
                                                </div>
                                                <div className="bg-proxmox-darker rounded-lg p-3">
                                                    <p className="text-gray-400">React</p>
                                                    <p className="text-white font-medium">UI Framework</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    {/* Links */}
                                    <div className="bg-proxmox-dark border border-proxmox-border rounded-xl p-6">
                                        <h3 className="text-lg font-semibold text-white mb-4 flex items-center gap-2">
                                            <Icons.Link />
                                            {t('links') || 'Links'}
                                        </h3>
                                        <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                                            <a href="https://pegaprox.com" target="_blank" rel="noopener noreferrer"
                                                className="flex items-center gap-2 p-3 bg-proxmox-darker rounded-lg hover:bg-proxmox-hover transition-colors">
                                                <Icons.Globe className="text-proxmox-orange" />
                                                <span className="text-sm text-gray-300">pegaprox.com</span>
                                            </a>
                                            <a href="https://github.com/PegaProx/project-pegaprox" target="_blank" rel="noopener noreferrer"
                                                className="flex items-center gap-2 p-3 bg-proxmox-darker rounded-lg hover:bg-proxmox-hover transition-colors">
                                                <Icons.Github className="text-gray-400" />
                                                <span className="text-sm text-gray-300">GitHub</span>
                                            </a>
                                            <a href="https://docs.pegaprox.com" target="_blank" rel="noopener noreferrer"
                                                className="flex items-center gap-2 p-3 bg-proxmox-darker rounded-lg hover:bg-proxmox-hover transition-colors">
                                                <Icons.Book className="text-blue-400" />
                                                <span className="text-sm text-gray-300">Documentation</span>
                                            </a>
                                            <a href="mailto:sponsor@pegaprox.com" 
                                                className="flex items-center gap-2 p-3 bg-proxmox-darker rounded-lg hover:bg-proxmox-hover transition-colors">
                                                <Icons.Heart className="text-pink-400" />
                                                <span className="text-sm text-gray-300">Sponsor</span>
                                            </a>
                                        </div>
                                    </div>
                                    
                                    {/* License */}
                                    <div className="text-center text-sm text-gray-500 space-y-1">
                                        <p>PegaProx is open source software licensed under the AGPL-3.0 License.</p>
                                        <p>Made with ‚ù§Ô∏è in Austria and Germany</p>
                                        <p>¬© 2025-2026 PegaProx Team</p>
                                    </div>
                                </div>
                            )}
                            
                        </div>
                    </div>
                </div>
                    
                    {/* Rollback Modal - NS Jan 2026 */}
                    {showRollbackModal && (
                        <div className="fixed inset-0 z-[70] flex items-center justify-center p-4 bg-black/80" onClick={() => setShowRollbackModal(false)}>
                            <div 
                                className="w-full max-w-lg bg-proxmox-card border border-proxmox-border rounded-xl shadow-2xl overflow-hidden"
                                onClick={e => e.stopPropagation()}
                            >
                                <div className="p-4 border-b border-proxmox-border flex items-center justify-between">
                                    <h3 className="text-lg font-semibold text-white flex items-center gap-2">
                                        <Icons.RotateCcw className="text-yellow-400" />
                                        {t('selectBackup') || 'Select Backup to Restore'}
                                    </h3>
                                    <button onClick={() => setShowRollbackModal(false)} className="p-1 hover:bg-proxmox-dark rounded">
                                        <Icons.X />
                                    </button>
                                </div>
                                <div className="p-4 max-h-[400px] overflow-y-auto">
                                    {availableBackups.length === 0 ? (
                                        <div className="text-center py-8 text-gray-500">
                                            <Icons.Archive className="w-12 h-12 mx-auto mb-2 opacity-50" />
                                            <p>{t('noBackupsFound') || 'No backups found'}</p>
                                        </div>
                                    ) : (
                                        <div className="space-y-2">
                                            {availableBackups.map((backup, idx) => (
                                                <div 
                                                    key={idx}
                                                    className="bg-proxmox-dark border border-proxmox-border rounded-lg p-4 hover:border-yellow-500/50 transition-colors"
                                                >
                                                    <div className="flex items-center justify-between">
                                                        <div>
                                                            <p className="font-medium text-white">{backup.name}</p>
                                                            <p className="text-xs text-gray-500 mt-1">
                                                                {t('created') || 'Created'}: {new Date(backup.created).toLocaleString()}
                                                            </p>
                                                            <p className="text-xs text-gray-500">
                                                                {t('files') || 'Files'}: {backup.files?.join(', ') || 'unknown'}
                                                            </p>
                                                        </div>
                                                        <button
                                                            onClick={() => performRollback(backup.name)}
                                                            disabled={updateLoading}
                                                            className="px-3 py-1.5 bg-yellow-600 hover:bg-yellow-700 disabled:bg-gray-600 rounded-lg text-sm font-medium transition-colors"
                                                        >
                                                            {t('restore') || 'Restore'}
                                                        </button>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                                <div className="p-4 border-t border-proxmox-border bg-proxmox-dark/50">
                                    <p className="text-xs text-gray-500 text-center">
                                        {t('rollbackWarning') || '‚ö†Ô∏è Rollback will restart the server. Make sure you have saved any unsaved work.'}
                                    </p>
                                </div>
                            </div>
                        </div>
                    )}
                </>
            );
        }

        // Task Bar Component with Task Viewer
        function TaskBar({ tasks, onClear, onClose, onCancel, onRefresh, clusterId }) {
            const { t } = useTranslation();
            const [expanded, setExpanded] = useState(false);
            const [selectedTask, setSelectedTask] = useState(null);
            const [taskLog, setTaskLog] = useState('');
            const [taskLogLoading, setTaskLogLoading] = useState(false);
            const [filter, setFilter] = useState('all'); // all, running, error, today
            const { getAuthHeaders } = useAuth();
            
            // Ensure tasks is an array
            const safeTasks = Array.isArray(tasks) ? tasks : [];
            
            const runningCount = safeTasks.filter(task => task && task.status === 'running').length;
            const failedCount = safeTasks.filter(task => task && (task.status === 'failed' || task.status === 'error')).length;
            
            // Filter tasks
            const filteredTasks = safeTasks.filter(task => {
                if (!task) return false;
                if (filter === 'running') return task.status === 'running';
                if (filter === 'error') return task.status === 'failed' || task.status === 'error';
                if (filter === 'today') {
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    return task.starttime && (task.starttime * 1000) >= today.getTime();
                }
                return true;
            });
            
            const formatTaskType = (type) => {
                if (!type) return 'Task';
                const types = {
                    'qmigrate': 'VM Migration', 'vzmigrate': 'CT Migration',
                    'qmstart': 'VM Start', 'vzstart': 'CT Start',
                    'qmstop': 'VM Stop', 'vzstop': 'CT Stop',
                    'qmshutdown': 'VM Shutdown', 'vzshutdown': 'CT Shutdown',
                    'qmreboot': 'VM Reboot', 'vzreboot': 'CT Reboot',
                    'qmcreate': 'VM Create', 'vzcreate': 'CT Create',
                    'qmdestroy': 'VM Delete', 'vzdestroy': 'CT Delete',
                    'qmclone': 'VM Clone', 'vzclone': 'CT Clone',
                    'qmsnapshot': 'Snapshot', 'vzsnapshot': 'Snapshot',
                    'imgcopy': 'Disk Copy', 'move_volume': 'Disk Move',
                    'resize': 'Disk Resize', 'download': 'Download',
                    'vzdump': 'Backup', 'qmrestore': 'Restore', 'vzrestore': 'Restore',
                };
                return types[type] || type;
            };
            
            const formatDuration = (start, end) => {
                if (!start) return '-';
                const endTime = end || Math.floor(Date.now() / 1000);
                const duration = endTime - start;
                const hours = Math.floor(duration / 3600);
                const mins = Math.floor((duration % 3600) / 60);
                const secs = duration % 60;
                if (hours > 0) return `${hours}h ${mins}m ${secs}s`;
                if (mins > 0) return `${mins}m ${secs}s`;
                return `${secs}s`;
            };
            
            // Fetch task log
            const fetchTaskLog = async (task) => {
                if (!task || !task.node || !task.upid || !clusterId) return;
                
                setTaskLogLoading(true);
                setTaskLog('');
                
                try {
                    const response = await fetch(
                        `${API_URL}/clusters/${clusterId}/nodes/${task.node}/tasks/${encodeURIComponent(task.upid)}/log`,
                        { headers: getAuthHeaders() }
                    );
                    
                    if (response.ok) {
                        const data = await response.json();
                        setTaskLog(data.log || t('noOutput'));
                    } else {
                        setTaskLog(t('errorLoadingLog'));
                    }
                } catch (err) {
                    setTaskLog(t('errorLoadingLog'));
                } finally {
                    setTaskLogLoading(false);
                }
            };
            
            // Open task detail
            const openTaskDetail = (task) => {
                setSelectedTask(task);
                fetchTaskLog(task);
            };
            
            return (
                <div className={`fixed bottom-0 left-0 right-0 z-40 transition-all duration-300 ${expanded ? 'h-96' : 'h-10'}`}>
                    {/* Task Detail Modal */}
                    {selectedTask && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/70" onClick={() => setSelectedTask(null)}>
                            <div className="w-full max-w-3xl bg-proxmox-card border border-proxmox-border rounded-xl overflow-hidden" onClick={e => e.stopPropagation()}>
                                {/* Header */}
                                <div className="flex items-center justify-between p-4 border-b border-proxmox-border bg-proxmox-dark">
                                    <div className="flex items-center gap-3">
                                        <span className={`w-3 h-3 rounded-full ${
                                            selectedTask.status === 'running' ? 'bg-blue-500 animate-pulse' :
                                            selectedTask.status === 'failed' || selectedTask.status === 'error' ? 'bg-red-500' :
                                            'bg-green-500'
                                        }`} />
                                        <div>
                                            <h3 className="text-white font-semibold">
                                                {formatTaskType(selectedTask.type)} {selectedTask.vmid ? `(${selectedTask.vmid})` : ''}
                                            </h3>
                                            <p className="text-xs text-gray-400">
                                                {selectedTask.node} ‚Ä¢ {selectedTask.user ? selectedTask.user.split('@')[0] : '-'}
                                            </p>
                                        </div>
                                    </div>
                                    <button onClick={() => setSelectedTask(null)} className="p-2 hover:bg-proxmox-border rounded">
                                        <Icons.X />
                                    </button>
                                </div>
                                
                                {/* Info Grid */}
                                <div className="p-4 border-b border-proxmox-border grid grid-cols-4 gap-4 text-sm">
                                    <div>
                                        <span className="text-gray-500 block">{t('status')}</span>
                                        <span className={`font-medium ${
                                            selectedTask.status === 'running' ? 'text-blue-400' :
                                            selectedTask.status === 'failed' || selectedTask.status === 'error' ? 'text-red-400' :
                                            'text-green-400'
                                        }`}>{selectedTask.status || '-'}</span>
                                    </div>
                                    <div>
                                        <span className="text-gray-500 block">{t('startTime')}</span>
                                        <span className="text-white">
                                            {selectedTask.starttime ? new Date(selectedTask.starttime * 1000).toLocaleString() : '-'}
                                        </span>
                                    </div>
                                    <div>
                                        <span className="text-gray-500 block">{t('endTime')}</span>
                                        <span className="text-white">
                                            {selectedTask.endtime ? new Date(selectedTask.endtime * 1000).toLocaleString() : '-'}
                                        </span>
                                    </div>
                                    <div>
                                        <span className="text-gray-500 block">{t('duration')}</span>
                                        <span className="text-white">{formatDuration(selectedTask.starttime, selectedTask.endtime)}</span>
                                    </div>
                                </div>
                                
                                {/* Task Log */}
                                <div className="p-4">
                                    <div className="flex items-center justify-between mb-2">
                                        <span className="text-sm text-gray-400">{t('taskOutput')}</span>
                                        <button 
                                            onClick={() => fetchTaskLog(selectedTask)}
                                            className="text-xs text-gray-400 hover:text-white"
                                        >
                                            <Icons.RefreshCw />
                                        </button>
                                    </div>
                                    <div className={`h-64 overflow-auto rounded-lg font-mono text-xs p-3 ${
                                        selectedTask.status === 'failed' || selectedTask.status === 'error'
                                            ? 'bg-red-500/5 border border-red-500/20 text-red-300'
                                            : 'bg-proxmox-darker border border-proxmox-border text-gray-300'
                                    }`}>
                                        {taskLogLoading ? (
                                            <span className="text-gray-500">{t('loading')}...</span>
                                        ) : (
                                            <pre className="whitespace-pre-wrap">{taskLog || selectedTask.error || selectedTask.exitstatus || t('noOutput')}</pre>
                                        )}
                                    </div>
                                </div>
                                
                                {/* Actions */}
                                {selectedTask.status === 'running' && onCancel && (
                                    <div className="p-4 border-t border-proxmox-border bg-proxmox-dark">
                                        <button
                                            onClick={() => { onCancel(selectedTask); setSelectedTask(null); }}
                                            className="px-4 py-2 bg-red-600 hover:bg-red-700 rounded-lg text-white text-sm"
                                        >
                                            {t('cancelTask')}
                                        </button>
                                    </div>
                                )}
                            </div>
                        </div>
                    )}
                    
                    <div className="h-full bg-proxmox-darker border-t border-proxmox-border flex flex-col">
                        {/* Header Bar */}
                        <div 
                            className="h-10 min-h-[40px] px-4 flex items-center justify-between cursor-pointer hover:bg-proxmox-dark/50"
                            onClick={() => setExpanded(!expanded)}
                        >
                            <div className="flex items-center gap-3">
                                <div className="flex items-center gap-2 text-sm">
                                    <Icons.Layers />
                                    <span className="font-medium">{t('tasks')}</span>
                                </div>
                                
                                {runningCount > 0 && (
                                    <span className="px-2 py-0.5 rounded-full bg-blue-500/20 text-blue-400 text-xs">
                                        {runningCount} {t('running')}
                                    </span>
                                )}
                                {failedCount > 0 && (
                                    <span className="px-2 py-0.5 rounded-full bg-red-500/20 text-red-400 text-xs">
                                        {failedCount} {t('failed')}
                                    </span>
                                )}
                            </div>
                            
                            <div className="flex items-center gap-2">
                                <span className={`transition-transform ${expanded ? '' : 'rotate-180'}`}>
                                    <Icons.ChevronDown />
                                </span>
                            </div>
                        </div>
                        
                        {/* Expanded Task Viewer */}
                        {expanded && (
                            <div className="flex-1 flex flex-col overflow-hidden">
                                {/* Toolbar */}
                                <div className="px-4 py-2 border-b border-proxmox-border flex items-center justify-between bg-proxmox-dark/50">
                                    <div className="flex items-center gap-2">
                                        <select
                                            value={filter}
                                            onChange={e => setFilter(e.target.value)}
                                            className="px-2 py-1 bg-proxmox-dark border border-proxmox-border rounded text-sm text-white"
                                        >
                                            <option value="all">{t('allTasks')}</option>
                                            <option value="running">{t('runningTasks')}</option>
                                            <option value="error">{t('failedTasks')}</option>
                                            <option value="today">{t('todaysTasks')}</option>
                                        </select>
                                        <span className="text-xs text-gray-500">
                                            {filteredTasks.length} {t('tasksShown')}
                                        </span>
                                    </div>
                                    <div className="flex items-center gap-2">
                                        {onRefresh && (
                                            <button 
                                                onClick={(e) => { e.stopPropagation(); onRefresh(); }}
                                                className="p-1.5 text-gray-400 hover:text-white hover:bg-proxmox-border rounded"
                                                title={t('refresh')}
                                            >
                                                <Icons.RefreshCw />
                                            </button>
                                        )}
                                        <button 
                                            onClick={(e) => { e.stopPropagation(); onClear(); }}
                                            className="px-2 py-1 text-xs text-gray-400 hover:text-white hover:bg-proxmox-border rounded"
                                        >
                                            {t('clearCompleted')}
                                        </button>
                                        <button 
                                            onClick={(e) => { e.stopPropagation(); onClose(); }}
                                            className="p-1.5 text-gray-400 hover:text-white hover:bg-proxmox-border rounded"
                                        >
                                            <Icons.X />
                                        </button>
                                    </div>
                                </div>
                                
                                {/* Task Table */}
                                <div className="flex-1 overflow-auto bg-proxmox-darker">
                                    <table className="w-full text-sm">
                                        <thead className="sticky top-0 bg-proxmox-dark">
                                            <tr className="border-b border-proxmox-border text-left">
                                                <th className="px-4 py-2 text-gray-400 font-medium w-10"></th>
                                                <th className="px-4 py-2 text-gray-400 font-medium">{t('startTime')}</th>
                                                <th className="px-4 py-2 text-gray-400 font-medium">{t('endTime')}</th>
                                                <th className="px-4 py-2 text-gray-400 font-medium">{t('node')}</th>
                                                <th className="px-4 py-2 text-gray-400 font-medium">{t('user')}</th>
                                                <th className="px-4 py-2 text-gray-400 font-medium">{t('description')}</th>
                                                <th className="px-4 py-2 text-gray-400 font-medium">{t('status')}</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {filteredTasks.length === 0 ? (
                                                <tr>
                                                    <td colSpan="7" className="px-4 py-8 text-center text-gray-500">
                                                        {t('noTasks')}
                                                    </td>
                                                </tr>
                                            ) : filteredTasks.map((task, idx) => {
                                                if (!task) return null;
                                                const isRunning = task.status === 'running';
                                                const isFailed = task.status === 'failed' || task.status === 'error';
                                                
                                                return (
                                                    <tr 
                                                        key={task.upid || `task-${idx}`}
                                                        className="border-b border-gray-700/50 hover:bg-proxmox-dark/50 cursor-pointer"
                                                        onClick={() => openTaskDetail(task)}
                                                    >
                                                        <td className="px-4 py-2">
                                                            <span className={`inline-block w-2 h-2 rounded-full ${
                                                                isRunning ? 'bg-blue-500 animate-pulse' :
                                                                isFailed ? 'bg-red-500' :
                                                                'bg-green-500'
                                                            }`} />
                                                        </td>
                                                        <td className="px-4 py-2 text-gray-400 whitespace-nowrap">
                                                            {task.starttime ? new Date(task.starttime * 1000).toLocaleString() : '-'}
                                                        </td>
                                                        <td className="px-4 py-2 text-gray-400 whitespace-nowrap">
                                                            {task.endtime ? new Date(task.endtime * 1000).toLocaleString() : '-'}
                                                        </td>
                                                        <td className="px-4 py-2 text-white">{task.node || '-'}</td>
                                                        <td className="px-4 py-2 text-gray-300">{task.user ? task.user.split('@')[0] : '-'}</td>
                                                        <td className="px-4 py-2 text-white">
                                                            {formatTaskType(task.type)}
                                                            {task.vmid && <span className="text-gray-500 ml-1">({task.vmid})</span>}
                                                        </td>
                                                        <td className="px-4 py-2">
                                                            <span className={`px-2 py-0.5 rounded text-xs ${
                                                                isRunning ? 'bg-blue-500/20 text-blue-400' : 
                                                                isFailed ? 'bg-red-500/20 text-red-400' : 
                                                                'bg-green-500/20 text-green-400'
                                                            }`}>
                                                                {task.status || '-'}
                                                            </span>
                                                        </td>
                                                    </tr>
                                                );
                                            })}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        // Main Dashboard Component
        // NS: This is the heart of the app, everything connects here
        // State management is a bit messy but it works ¬Ø\_(„ÉÑ)_/¬Ø
        // LW: Password Expiry Warning Banner - Dec 2025
        // Shows a warning when user's password is about to expire or has expired
        function PasswordExpiryBanner({ onChangePassword }) {
            const { t } = useTranslation();
            const { passwordExpiry, user } = useAuth();
            const [dismissed, setDismissed] = useState(false);
            
            // Don't show if no expiry info or dismissed
            // NS: removed admin check here - backend now handles include_admins setting
            if (!passwordExpiry || !passwordExpiry.enabled || dismissed) return null;
            
            const { expired, warning, days_until_expiry } = passwordExpiry;
            
            // only show if expired or in warning period
            if (!expired && !warning) return null;
            
            return (
                <div className={`px-4 py-3 ${expired ? 'bg-red-500/20 border-red-500/50' : 'bg-yellow-500/20 border-yellow-500/50'} border-b`}>
                    <div className="max-w-7xl mx-auto flex items-center justify-between">
                        <div className="flex items-center gap-3">
                            <div className={`p-1.5 rounded-full ${expired ? 'bg-red-500/30' : 'bg-yellow-500/30'}`}>
                                <Icons.AlertTriangle className={`w-4 h-4 ${expired ? 'text-red-400' : 'text-yellow-400'}`} />
                            </div>
                            <div>
                                <span className={`font-medium ${expired ? 'text-red-400' : 'text-yellow-400'}`}>
                                    {expired 
                                        ? (t('passwordExpired') || 'Ihr Passwort ist abgelaufen!')
                                        : (t('passwordExpiresIn') || `Ihr Passwort l√§uft in ${days_until_expiry} Tagen ab`).replace('{days}', days_until_expiry)
                                    }
                                </span>
                                <span className="text-gray-400 ml-2 text-sm">
                                    {expired
                                        ? (t('pleaseChangeNow') || 'Bitte √§ndern Sie es jetzt.')
                                        : (t('pleaseChangeSoon') || 'Bitte √§ndern Sie es rechtzeitig.')
                                    }
                                </span>
                            </div>
                        </div>
                        <div className="flex items-center gap-2">
                            <button
                                onClick={onChangePassword}
                                className={`px-4 py-1.5 rounded-lg text-sm font-medium transition-colors ${
                                    expired 
                                        ? 'bg-red-500 hover:bg-red-600 text-white' 
                                        : 'bg-yellow-500 hover:bg-yellow-600 text-black'
                                }`}
                            >
                                {t('changePassword') || 'Passwort √§ndern'}
                            </button>
                            {!expired && (
                                <button
                                    onClick={() => setDismissed(true)}
                                    className="p-1.5 text-gray-400 hover:text-white rounded"
                                    title={t('dismissForNow') || 'Sp√§ter erinnern'}
                                >
                                    <Icons.X className="w-4 h-4" />
                                </button>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        // Cluster Sidebar Item Component - NS Jan 2026
        function ClusterSidebarItem({ cluster, idx, selectedCluster, setSelectedCluster, nodeAlerts, clusterGroups, isAdmin, handleDeleteCluster, setShowAssignGroup, t, getAuthHeaders, fetchClusters, addToast }) {
            const offlineNodesCount = Object.values(nodeAlerts || {})
                .filter(alert => alert.cluster_id === cluster.id && alert.status === 'offline')
                .length;
            const hasOfflineNodes = offlineNodesCount > 0;
            
            return (
                <div
                    onClick={() => setSelectedCluster(cluster)}
                    className={`card-hover cursor-pointer rounded-xl p-3 border transition-all animate-slide-up ${
                        selectedCluster?.id === cluster.id
                            ? 'bg-proxmox-orange/10 border-proxmox-orange/50'
                            : cluster.connected === false
                            ? 'bg-red-500/5 border-red-500/30'
                            : hasOfflineNodes
                            ? 'bg-orange-500/5 border-orange-500/30'
                            : 'bg-proxmox-card border-proxmox-border hover:border-proxmox-orange/30'
                    }`}
                    style={{ animationDelay: `${idx * 50}ms` }}
                >
                    <div className="flex items-center justify-between">
                        <div className="flex items-center gap-2">
                            <div className={`w-2 h-2 rounded-full flex-shrink-0 ${
                                cluster.connected === false 
                                    ? 'bg-red-500 animate-pulse' 
                                    : hasOfflineNodes
                                    ? 'bg-orange-500 animate-pulse'
                                    : cluster.status === 'running' 
                                    ? 'bg-green-500 status-online' 
                                    : 'bg-gray-500'
                            }`} />
                            <div className="min-w-0">
                                <h3 className="font-medium text-sm truncate">{cluster.name}</h3>
                                <p className="text-xs text-gray-500 truncate">{cluster.host}</p>
                            </div>
                        </div>
                        <div className="flex flex-col gap-1 flex-shrink-0">
                            <button
                                onClick={(e) => {
                                    e.stopPropagation();
                                    handleDeleteCluster(cluster.id);
                                }}
                                className="p-1 rounded hover:bg-red-500/10 text-gray-500 hover:text-red-400 transition-colors"
                                title={t('delete')}
                            >
                                <Icons.Trash className="w-3.5 h-3.5" />
                            </button>
                            {isAdmin && (
                                <button
                                    onClick={(e) => {
                                        e.stopPropagation();
                                        setShowAssignGroup(cluster);
                                    }}
                                    className="p-1 rounded hover:bg-blue-500/10 text-gray-500 hover:text-blue-400 transition-colors"
                                    title={t('assignToGroup')}
                                >
                                    <Icons.FolderInput className="w-3.5 h-3.5" />
                                </button>
                            )}
                        </div>
                    </div>
                    {/* Status Tags */}
                    <div className="flex gap-1 mt-2 flex-wrap">
                        {cluster.connected === false && (
                            <span className="text-[10px] bg-red-500/10 text-red-400 px-1.5 py-0.5 rounded">Offline</span>
                        )}
                        {hasOfflineNodes && cluster.connected !== false && (
                            <span className="text-[10px] bg-orange-500/10 text-orange-400 px-1.5 py-0.5 rounded animate-pulse">
                                {offlineNodesCount} Node{offlineNodesCount > 1 ? 's' : ''} ‚ö†
                            </span>
                        )}
                        {cluster.dry_run && (
                            <span className="text-[10px] bg-yellow-500/10 text-yellow-400 px-1.5 py-0.5 rounded">Dry</span>
                        )}
                        {cluster.auto_migrate && (
                            <span className="text-[10px] bg-green-500/10 text-green-400 px-1.5 py-0.5 rounded">Auto</span>
                        )}
                        {!cluster.enabled && (
                            <span className="text-[10px] bg-gray-500/10 text-gray-400 px-1.5 py-0.5 rounded">Paused</span>
                        )}
                    </div>
                </div>
            );
        }

        function PegaProxDashboard() {
            const { t } = useTranslation();
            const { user, sessionId, logout, getAuthHeaders, isAdmin, passwordExpiry } = useAuth();
            const [clusters, setClusters] = useState([]);
            const [clusterGroups, setClusterGroups] = useState([]); // NS Jan 2026 - for grouping
            const [collapsedGroups, setCollapsedGroups] = useState({}); // Track which groups are collapsed
            const [showGroupManager, setShowGroupManager] = useState(false); // Group management modal
            const [showAssignGroup, setShowAssignGroup] = useState(null); // Cluster to assign to group
            const [selectedCluster, setSelectedCluster] = useState(null);
            const [clusterMetrics, setClusterMetrics] = useState({});
            const [allClusterMetrics, setAllClusterMetrics] = useState({}); // LW: metrics cache for overview page
            const [topGuests, setTopGuests] = useState([]); // top vms for overview table
            const [knownNodes, setKnownNodes] = useState({}); // NS: Track all nodes ever seen to show offline ones
            const [clusterResources, setClusterResources] = useState([]);
            const [lastUpdate, setLastUpdate] = useState(null);
            const [migrationLogs, setMigrationLogs] = useState([]);
            const [nodeAlerts, setNodeAlerts] = useState({}); // Track node offline/online alerts
            const [showAddModal, setShowAddModal] = useState(false);
            const [showCreateVm, setShowCreateVm] = useState(null); // 'qemu' or 'lxc'
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);
            const [toasts, setToasts] = useState([]);
            const [activeTab, setActiveTab] = useState('overview');
            const [resourcesSubTab, setResourcesSubTab] = useState('management'); 
            const [showUserMenu, setShowUserMenu] = useState(false);
            const [showSettings, setShowSettings] = useState(false);
            const [showProfile, setShowProfile] = useState(false);
            const [wsConnected, setWsConnected] = useState(false);
            const [tasks, setTasks] = useState([]);
            const [showUpdateNotification, setShowUpdateNotification] = useState(false); // LW: Show update modal on login
            const [pendingUpdate, setPendingUpdate] = useState(null); // LW: Store update info for notification
            
            // NS: Task update timestamp to prevent race conditions
            // This was causing tasks to "jump back" when SSE and polling raced
            const taskUpdateTimestamp = useRef(0);
            const initialTaskFetchPending = useRef(true);  // NS: skip stale check on initial load
            const [showTaskBar, setShowTaskBar] = useState(true);  // localStorage.getItem('showTaskBar') !== 'false'
            const [actionLoading, setActionLoading] = useState({});
            const wsRef = useRef(null);
            const retryCount = useRef(0);  // unused but might need later
            const selectedClusterRef = useRef(null);  // for ws callback, dont ask
            const [connectionError, setConnectionError] = useState(null);
            const [lastRefresh, setLastRefresh] = useState(null);  // not used yet
            
            // HA Settings state
            // NS: these defaults should probably come from backend
            const [haSettings, setHaSettings] = useState({
                quorum_enabled: true,
                quorum_hosts: '',
                quorum_gateway: '',
                quorum_required_votes: 2,
                self_fence_enabled: true,
                verify_network: true,
                recovery_delay: 30,  // seconds
                failure_threshold: 3,
                // 2-Node Cluster Mode - NS Jan 2026
                two_node_mode: false,
                // Storage-based Split-Brain Protection - NS Jan 2026
                storage_heartbeat_enabled: false,
                storage_heartbeat_path: '',
                storage_heartbeat_timeout: 30,
                poison_pill_enabled: true,
                strict_fencing: false,
            });
            const [haStatus, setHaStatus] = useState(null);
            const [showHaSettings, setShowHaSettings] = useState(false);
            
            // NS: Global Search state - Jan 2026
            const [globalSearchQuery, setGlobalSearchQuery] = useState('');
            const [globalSearchResults, setGlobalSearchResults] = useState(null);
            const [globalSearchLoading, setGlobalSearchLoading] = useState(false);
            const [showGlobalSearch, setShowGlobalSearch] = useState(false);
            const [highlightedVm, setHighlightedVm] = useState(null);  // {vmid, node} - for scrolling to VM in table
            
            // NS: User Favorites state
            const [favorites, setFavorites] = useState({ vms: [], nodes: [], clusters: [] });
            const [datacenterSummary, setDatacenterSummary] = useState(null);
            
            // NS: VM Tags state - Jan 2026
            const [vmTags, setVmTags] = useState({});  // cluster -> vmid -> tags
            const [clusterTags, setClusterTags] = useState([]);  // available tags in current cluster
            const [showTagEditor, setShowTagEditor] = useState(null);  // {clusterId, vmid, vmName}
            const [newTagName, setNewTagName] = useState('');
            
            
            const [snapshotFilterDate, setSnapshotFilterDate] = useState('');
            const [globalSnapshots, setGlobalSnapshots] = useState([]);
            const [snapshotSortBy, setSnapshotSortBy] = useState('age'); // vmid, vm_name, node, snapshot_name, snapshot_date, age
            const [snapshotSortDir, setSnapshotSortDir] = useState('desc');
            
            // NS: Scheduled Actions state
            const [schedules, setSchedules] = useState([]);
            const [showScheduleModal, setShowScheduleModal] = useState(false);
            const [editingSchedule, setEditingSchedule] = useState(null);
            
            // NS: Automation Tab state - Jan 2026
            const [automationSubTab, setAutomationSubTab] = useState('schedules');
            const [clusterAlerts, setClusterAlerts] = useState([]);
            const [showAlertModal, setShowAlertModal] = useState(false);
            const [clusterAffinityRules, setClusterAffinityRules] = useState([]);
            const [showAffinityModal, setShowAffinityModal] = useState(false);
            
            // Custom Scripts state - MK Jan 2026
            const [customScripts, setCustomScripts] = useState([]);
            const [showScriptModal, setShowScriptModal] = useState(false);
            const [editingScript, setEditingScript] = useState(null);
            // Script execution state - MK Jan 2026
            const [showScriptRunModal, setShowScriptRunModal] = useState(null); // script to run
            const [scriptRunPassword, setScriptRunPassword] = useState('');
            const [scriptRunning, setScriptRunning] = useState(false);
            const [scriptOutput, setScriptOutput] = useState(null); // {name, output, results}
            
            // NS: Reports/Analytics state
            const [reportData, setReportData] = useState(null);
            const [reportPeriod, setReportPeriod] = useState('day');
            const [reportLoading, setReportLoading] = useState(false);
            const [topVms, setTopVms] = useState([]);
            
            // Auth fetch helper - simple version without timeout abort
            // TODO: add retry logic? - LW
            // TODO: maybe use axios instead? -ns
            const authFetch = async (url, opts = {}) => {
                try {
                    const res = await fetch(url, {
                        ...opts,
                        credentials: 'include',
                        headers: { ...opts.headers, ...getAuthHeaders() }
                    });
                    setConnectionError(null);
                    return res;
                } catch (err) {
                    console.error('authFetch err:', err);
                    // setConnectionError('Network error');  // too annoying
                    return null;
                }
            };
            
            // Keep ref in sync with state
            // NS: this is a hack for the websocket callback closure issue
            // NS: Reset ref IMMEDIATELY when cluster changes to prevent cross-cluster data leaks
            useEffect(() => {
                // First update the ref synchronously
                selectedClusterRef.current = selectedCluster;
            }, [selectedCluster]);

            const addToast = (message, type = 'success') => {
                const id = Date.now();
                setToasts(prev => [...prev, { id, message, type }]);
                // auto remove after 5 seconds
                setTimeout(() => {
                    setToasts(prev => prev.filter(t => t.id !== id));
                }, 5000);
            };

            const removeToast = (id) => {
                setToasts(prev => prev.filter(toast => toast.id !== id));
            };

            // NS: Global Search function - Jan 2026
            const performGlobalSearch = async (query) => {
                if (!query || query.length < 2) {
                    setGlobalSearchResults(null);
                    return;
                }
                
                setGlobalSearchLoading(true);
                try {
                    const response = await authFetch(`${API_URL}/global/search?q=${encodeURIComponent(query)}`);
                    if (response && response.ok) {
                        const data = await response.json();
                        setGlobalSearchResults(data);
                    }
                } catch (err) {
                    console.error('Global search error:', err);
                }
                setGlobalSearchLoading(false);
            };
            
            // NS: Load user favorites
            const loadFavorites = async () => {
                try {
                    const response = await authFetch(`${API_URL}/user/favorites`);
                    if (response && response.ok) {
                        const data = await response.json();
                        setFavorites(data);
                    }
                } catch (err) {
                    console.error('Load favorites error:', err);
                }
            };
            
            // NS: Toggle favorite
            const toggleFavorite = async (type, clusterId, vmid = null, vmType = null, nodeName = null) => {
                const currentFavs = favorites[type + 's'] || [];
                let isFavorite = false;
                
                if (type === 'vm') {
                    isFavorite = currentFavs.some(f => f.cluster_id === clusterId && f.vmid === vmid);
                } else if (type === 'node') {
                    isFavorite = currentFavs.some(f => f.cluster_id === clusterId && f.node === nodeName);
                } else if (type === 'cluster') {
                    isFavorite = currentFavs.includes(clusterId);
                }
                
                const action = isFavorite ? 'remove' : 'add';
                
                try {
                    const body = { action, type, cluster_id: clusterId };
                    if (vmid) body.vmid = vmid;
                    if (vmType) body.vm_type = vmType;
                    if (nodeName) body.node = nodeName;
                    
                    const response = await authFetch(`${API_URL}/user/favorites`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(body)
                    });
                    
                    if (response && response.ok) {
                        const data = await response.json();
                        setFavorites(data.favorites);
                    }
                } catch (err) {
                    console.error('Toggle favorite error:', err);
                }
            };
            
            // NS: Check if item is favorite
            const isFavorite = (type, clusterId, vmid = null, nodeName = null) => {
                if (type === 'vm') {
                    return (favorites.vms || []).some(f => f.cluster_id === clusterId && f.vmid === vmid);
                } else if (type === 'node') {
                    return (favorites.nodes || []).some(f => f.cluster_id === clusterId && f.node === nodeName);
                } else if (type === 'cluster') {
                    return (favorites.clusters || []).includes(clusterId);
                }
                return false;
            };
            
            // NS: Load datacenter summary
            const loadDatacenterSummary = async () => {
                try {
                    const response = await authFetch(`${API_URL}/global/summary`);
                    if (response && response.ok) {
                        const data = await response.json();
                        setDatacenterSummary(data);
                    }
                } catch (err) {
                    console.error('Datacenter summary error:', err);
                }
            };
            
            // ============================================
            // VM Tags Functions - NS Jan 2026
            // ============================================
            
            const loadClusterTags = async (clusterId) => {
                if (!clusterId) return;
                try {
                    const response = await authFetch(`${API_URL}/clusters/${clusterId}/tags`);
                    if (response && response.ok) {
                        const data = await response.json();
                        setClusterTags(data);
                    }
                } catch (err) {
                    console.error('Failed to load cluster tags:', err);
                }
            };
            
            const loadVmTags = async (clusterId, vmid) => {
                try {
                    const response = await authFetch(`${API_URL}/clusters/${clusterId}/vms/${vmid}/tags`);
                    if (response && response.ok) {
                        const data = await response.json();
                        setVmTags(prev => ({
                            ...prev,
                            [clusterId]: { ...(prev[clusterId] || {}), [vmid]: data }
                        }));
                    }
                } catch (err) {
                    console.error('Failed to load VM tags:', err);
                }
            };
            
            const addTagToVm = async (clusterId, vmid, tagName, color = null) => {
                try {
                    const response = await authFetch(`${API_URL}/clusters/${clusterId}/vms/${vmid}/tags`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ tag: tagName, color })
                    });
                    if (response && response.ok) {
                        const data = await response.json();
                        setVmTags(prev => ({
                            ...prev,
                            [clusterId]: { ...(prev[clusterId] || {}), [vmid]: data.tags }
                        }));
                        loadClusterTags(clusterId);
                        return true;
                    }
                } catch (err) {
                    console.error('Failed to add tag:', err);
                }
                return false;
            };
            
            const removeTagFromVm = async (clusterId, vmid, tagName) => {
                try {
                    const response = await authFetch(`${API_URL}/clusters/${clusterId}/vms/${vmid}/tags/${encodeURIComponent(tagName)}`, {
                        method: 'DELETE'
                    });
                    if (response && response.ok) {
                        // Remove from local state
                        setVmTags(prev => {
                            const clusterTags = prev[clusterId] || {};
                            const vmTagList = (clusterTags[vmid] || []).filter(
                                t => (t.name || t) !== tagName
                            );
                            return {
                                ...prev,
                                [clusterId]: { ...clusterTags, [vmid]: vmTagList }
                            };
                        });
                    }
                } catch (err) {
                    console.error('Failed to remove tag:', err);
                }
            };
            
            // Get tags for a VM (from local state)
            const getVmTags = (clusterId, vmid) => {
                return vmTags[clusterId]?.[vmid] || [];
            };
            
            // ============================================
              
            // LW: Added cluster filter and sorting
            // ============================================
            
            const fetchGlobalSnapshots = async (clusterId = null, filterDate = null) => {
                try {
                    const body = {};
                    if (clusterId) body.cluster_id = clusterId;
                    if (filterDate) body.date = filterDate;
                    
                    const res = await authFetch(`${API_URL}/snapshots/overview`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(body)
                    });
                    if (res && res.ok) {
                        const data = await res.json();
                        setGlobalSnapshots(data.snapshots ?? data ?? []);
                    } else {
                        setGlobalSnapshots([]);
                    }
                } catch (err) {
                    console.error('Snapshot fetch failed:', err);
                    setGlobalSnapshots([]);
                }
            };
            
            const applySnapshotFilter = async (clusterId) => {
                await fetchGlobalSnapshots(clusterId, snapshotFilterDate || null);
            };
            
            const deleteGlobalSnapshot = async (snap, clusterId) => {
                if (!window.confirm(`Delete snapshot "${snap.snapshot_name}" from VM ${snap.vmid}?`)) {
                    return;
                }
                try {
                    await authFetch(`${API_URL}/snapshots/delete`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ snapshots: [snap] })
                    });
                    addToast('Snapshot deleted', 'success');
                    await fetchGlobalSnapshots(clusterId, snapshotFilterDate || null);
                } catch (err) {
                    console.error('Snapshot delete failed:', err);
                    addToast('Failed to delete snapshot', 'error')
                }
            };
            
            
            const sortedSnapshots = useMemo(() => {
                if (!globalSnapshots || globalSnapshots.length === 0) return [];
                
                return [...globalSnapshots].sort((a, b) => {
                    let aVal = a[snapshotSortBy];
                    let bVal = b[snapshotSortBy];
                    
                    // Handle age specially - extract number
                    if (snapshotSortBy === 'age') {
                        const extractNum = (val) => {
                            if (!val) return 0;
                            const match = val.match(/(\d+)/);
                            return match ? parseInt(match[1]) : 0;
                        };
                        aVal = extractNum(aVal);
                        bVal = extractNum(bVal);
                    }
                    
                    // Handle numeric fields
                    if (snapshotSortBy === 'vmid') {
                        aVal = parseInt(aVal) || 0;
                        bVal = parseInt(bVal) || 0;
                    }
                    
                    if (aVal < bVal) return snapshotSortDir === 'asc' ? -1 : 1;
                    if (aVal > bVal) return snapshotSortDir === 'asc' ? 1 : -1;
                    return 0;
                });
            }, [globalSnapshots, snapshotSortBy, snapshotSortDir]);
            
            const toggleSnapshotSort = (field) => {
                if (snapshotSortBy === field) {
                    setSnapshotSortDir(snapshotSortDir === 'asc' ? 'desc' : 'asc');
                } else {
                    setSnapshotSortBy(field);
                    setSnapshotSortDir('asc');
                }
            };
            
            // ============================================
            // Scheduled Actions Functions - MK Jan 2026  
            // ============================================
            
            const loadSchedules = async () => {
                try {
                    const response = await authFetch(`${API_URL}/schedules`);
                    if (response && response.ok) {
                        const data = await response.json();
                        setSchedules(data);
                    }
                } catch (err) {
                    console.error('Failed to load schedules:', err);
                }
            };
            
            const createSchedule = async (scheduleData) => {
                try {
                    const response = await authFetch(`${API_URL}/schedules`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(scheduleData)
                    });
                    if (response && response.ok) {
                        await loadSchedules();
                        addToast(t('scheduleCreated') || 'Schedule created', 'success');
                        return true;
                    } else {
                        const err = await response.json();
                        addToast(err.error || 'Failed to create schedule', 'error');
                    }
                } catch (err) {
                    console.error('Failed to create schedule:', err);
                    addToast('Failed to create schedule', 'error');
                }
                return false;
            };
            
            const deleteSchedule = async (scheduleId) => {
                try {
                    const response = await authFetch(`${API_URL}/schedules/${scheduleId}`, {
                        method: 'DELETE'
                    });
                    if (response && response.ok) {
                        setSchedules(prev => prev.filter(s => s.id !== scheduleId));
                        addToast(t('scheduleDeleted') || 'Schedule deleted', 'success');
                    }
                } catch (err) {
                    console.error('Failed to delete schedule:', err);
                }
            };
            
            const toggleScheduleEnabled = async (scheduleId, enabled) => {
                try {
                    const response = await authFetch(`${API_URL}/schedules/${scheduleId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ enabled })
                    });
                    if (response && response.ok) {
                        setSchedules(prev => prev.map(s => 
                            s.id === scheduleId ? { ...s, enabled } : s
                        ));
                    }
                } catch (err) {
                    console.error('Failed to toggle schedule:', err);
                }
            };
            
            // ============================================
            // Cluster Alerts Functions - NS Jan 2026
            // ============================================
            
            const loadClusterAlerts = async (clusterId) => {
                if (!clusterId) return;
                try {
                    const response = await authFetch(`${API_URL}/clusters/${clusterId}/alerts`);
                    if (response && response.ok) {
                        const data = await response.json();
                        setClusterAlerts(data.alerts || []);
                    } else {
                        setClusterAlerts([]);
                    }
                } catch (err) {
                    console.error('Failed to load cluster alerts:', err);
                    setClusterAlerts([]);
                }
            };
            
            const createClusterAlert = async (alertData) => {
                if (!selectedCluster?.id) return;
                try {
                    const response = await authFetch(`${API_URL}/clusters/${selectedCluster.id}/alerts`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(alertData)
                    });
                    if (response && response.ok) {
                        setShowAlertModal(false);
                        loadClusterAlerts(selectedCluster.id);
                        addToast(t('alertCreated') || 'Alert created', 'success');
                    }
                } catch (err) {
                    console.error('Failed to create alert:', err);
                }
            };
            
            const deleteClusterAlert = async (alertId) => {
                if (!selectedCluster?.id) return;
                try {
                    const response = await authFetch(`${API_URL}/clusters/${selectedCluster.id}/alerts/${alertId}`, {
                        method: 'DELETE'
                    });
                    if (response && response.ok) {
                        setClusterAlerts(prev => prev.filter(a => a.id !== alertId));
                    }
                } catch (err) {
                    console.error('Failed to delete alert:', err);
                }
            };
            
            const toggleAlertEnabled = async (alertId, enabled) => {
                if (!selectedCluster?.id) return;
                try {
                    const response = await authFetch(`${API_URL}/clusters/${selectedCluster.id}/alerts/${alertId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ enabled })
                    });
                    if (response && response.ok) {
                        setClusterAlerts(prev => prev.map(a => 
                            a.id === alertId ? { ...a, enabled } : a
                        ));
                    }
                } catch (err) {
                    console.error('Failed to toggle alert:', err);
                }
            };
            
            // ============================================
            // Cluster Affinity Rules Functions - NS Jan 2026
            // ============================================
            
            const loadClusterAffinityRules = async (clusterId) => {
                if (!clusterId) return;
                try {
                    const response = await authFetch(`${API_URL}/clusters/${clusterId}/affinity-rules`);
                    if (response && response.ok) {
                        const data = await response.json();
                        setClusterAffinityRules(data.rules || []);
                    } else {
                        setClusterAffinityRules([]);
                    }
                } catch (err) {
                    console.error('Failed to load affinity rules:', err);
                    setClusterAffinityRules([]);
                }
            };
            
            const createClusterAffinityRule = async (ruleData) => {
                if (!selectedCluster?.id) return;
                try {
                    const response = await authFetch(`${API_URL}/clusters/${selectedCluster.id}/affinity-rules`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(ruleData)
                    });
                    if (response && response.ok) {
                        setShowAffinityModal(false);
                        loadClusterAffinityRules(selectedCluster.id);
                        addToast(t('ruleCreated') || 'Rule created', 'success');
                    }
                } catch (err) {
                    console.error('Failed to create affinity rule:', err);
                }
            };
            
            const deleteClusterAffinityRule = async (ruleId) => {
                if (!selectedCluster?.id) return;
                try {
                    const response = await authFetch(`${API_URL}/clusters/${selectedCluster.id}/affinity-rules/${ruleId}`, {
                        method: 'DELETE'
                    });
                    if (response && response.ok) {
                        setClusterAffinityRules(prev => prev.filter(r => r.id !== ruleId));
                    }
                } catch (err) {
                    console.error('Failed to delete affinity rule:', err);
                }
            };
            
            // ============================================
            // Reports/Analytics Functions - NS Jan 2026
            // Now cluster-based, not global
            // ============================================
            
            const loadReportSummary = async (period = 'day', clusterId = null) => {
                const clId = clusterId || selectedCluster?.id;
                if (!clId) return;
                
                setReportLoading(true);
                try {
                    const response = await authFetch(`${API_URL}/clusters/${clId}/reports/summary?period=${period}`);
                    if (response && response.ok) {
                        const data = await response.json();
                        setReportData(data);
                    } else {
                        setReportData(null);
                    }
                } catch (err) {
                    console.error('Failed to load report:', err);
                    setReportData(null);
                }
                setReportLoading(false);
            };
            
            const loadTopVms = async (metric = 'cpu', limit = 10, clusterId = null) => {
                const clId = clusterId || selectedCluster?.id;
                if (!clId) return;
                
                try {
                    const response = await authFetch(`${API_URL}/clusters/${clId}/reports/top-vms?metric=${metric}&limit=${limit}`);
                    if (response && response.ok) {
                        const data = await response.json();
                        setTopVms(data);
                    } else {
                        setTopVms([]);
                    }
                } catch (err) {
                    console.error('Failed to load top VMs:', err);
                    setTopVms([]);
                }
            };
            
            // Load favorites and summary on mount
            useEffect(() => {
                if (user) {
                    loadFavorites();
                    loadDatacenterSummary();
                    loadSchedules();  // Also load schedules
                }
            }, [user]);
            
            // Load reports when tab changes to reports OR cluster changes
            useEffect(() => {
                if (activeTab === 'reports' && selectedCluster?.id) {
                    loadReportSummary(reportPeriod, selectedCluster.id);
                    loadTopVms('cpu', 10, selectedCluster.id);
                }
            }, [activeTab, reportPeriod, selectedCluster?.id]);
            
            // Load automation data when tab changes to automation OR cluster changes
            useEffect(() => {
                if (activeTab === 'automation' && selectedCluster?.id) {
                    loadClusterTags(selectedCluster.id);
                    loadClusterAlerts(selectedCluster.id);
                    loadClusterAffinityRules(selectedCluster.id);
                    loadCustomScripts(selectedCluster.id);
                }
            }, [activeTab, selectedCluster?.id]);
            
            // Load custom scripts
            const loadCustomScripts = async (clusterId) => {
                if (!clusterId) return;
                console.log('[Scripts] Loading scripts for cluster:', clusterId);
                try {
                    const res = await authFetch(`${API_URL}/clusters/${clusterId}/scripts`);
                    console.log('[Scripts] Response:', res?.status, res?.ok);
                    if (res && res.ok) {
                        const data = await res.json();
                        console.log('[Scripts] Loaded:', data?.length, 'scripts', data);
                        setCustomScripts(data || []);
                    } else {
                        const errorData = await res.json().catch(() => ({}));
                        console.error('[Scripts] Failed to load, status:', res?.status, 'error:', errorData);
                        setCustomScripts([]);
                    }
                } catch (e) {
                    console.error('[Scripts] Error loading scripts:', e);
                    setCustomScripts([]);
                }
            };

            // HA Settings functions
            const fetchHAStatus = async (clusterId) => {
                if (!clusterId) return;
                try {
                    const response = await authFetch(`${API_URL}/clusters/${clusterId}/ha/status`);
                    if (response && response.ok) {
                        const data = await response.json();
                        setHaStatus(data);
                        setHaSettings({
                            quorum_enabled: data.split_brain_prevention?.quorum_enabled ?? true,
                            quorum_hosts: (data.split_brain_prevention?.quorum_hosts || []).join(', '),
                            quorum_gateway: data.split_brain_prevention?.quorum_gateway || '',
                            quorum_required_votes: data.split_brain_prevention?.quorum_required_votes || 2,
                            self_fence_enabled: data.split_brain_prevention?.self_fence_enabled ?? true,
                            verify_network: data.split_brain_prevention?.verify_network ?? true,
                            recovery_delay: data.split_brain_prevention?.recovery_delay || 30,
                            failure_threshold: data.failure_threshold || 3,
                            // 2-Node Mode
                            two_node_mode: data.split_brain_prevention?.two_node_mode ?? false,
                            // Storage-based Split-Brain Protection - NS Jan 2026
                            storage_heartbeat_enabled: data.split_brain_prevention?.storage_heartbeat_enabled ?? false,
                            storage_heartbeat_path: data.split_brain_prevention?.storage_heartbeat_path || '',
                            storage_heartbeat_timeout: data.split_brain_prevention?.storage_heartbeat_timeout || 30,
                            poison_pill_enabled: data.split_brain_prevention?.poison_pill_enabled ?? true,
                            strict_fencing: data.split_brain_prevention?.strict_fencing ?? false,
                        });
                        
                        // update nodeAlerts based on HA status
                        // LW: Include cluster_id to filter correctly!
                        if (data.nodes && clusterId) {
                            const newAlerts = { ...nodeAlerts };
                            Object.entries(data.nodes).forEach(([nodeName, nodeData]) => {
                                if (nodeData.status === 'offline') {
                                    // Add to alerts if not already there
                                    if (!newAlerts[nodeName]) {
                                        newAlerts[nodeName] = {
                                            status: 'offline',
                                            message: `Node ${nodeName} is offline`,
                                            timestamp: nodeData.last_seen || new Date().toISOString(),
                                            severity: 'critical',
                                            cluster_id: clusterId  // Important for filtering!
                                        };
                                    }
                                } else if (nodeData.status === 'online' && newAlerts[nodeName]) {
                                    // Remove from alerts if back online
                                    delete newAlerts[nodeName];
                                }
                            });
                            setNodeAlerts(newAlerts);
                        }
                    }
                } catch (err) {
                    console.error('fetching HA status:', err);
                }
            };

            const handleSaveHASettings = async () => {
                if (!selectedCluster) return;
                try {
                    const response = await authFetch(`${API_URL}/clusters/${selectedCluster.id}/ha/config`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            quorum_enabled: haSettings.quorum_enabled,
                            quorum_hosts: haSettings.quorum_hosts.split(',').map(h => h.trim()).filter(h => h),
                            quorum_gateway: haSettings.quorum_gateway,
                            quorum_required_votes: parseInt(haSettings.quorum_required_votes) || 2,
                            self_fence_enabled: haSettings.self_fence_enabled,
                            verify_network: haSettings.verify_network,
                            recovery_delay: parseInt(haSettings.recovery_delay) || 30,
                            failure_threshold: parseInt(haSettings.failure_threshold) || 3,
                            // 2-Node Cluster Mode - uses cluster credentials automatically
                            two_node_mode: haSettings.two_node_mode,
                            force_quorum_on_failure: haSettings.two_node_mode,
                            // Storage-based Split-Brain Protection - NS Jan 2026
                            storage_heartbeat_enabled: haSettings.storage_heartbeat_enabled,
                            storage_heartbeat_path: haSettings.storage_heartbeat_path,
                            storage_heartbeat_timeout: parseInt(haSettings.storage_heartbeat_timeout) || 30,
                            poison_pill_enabled: haSettings.poison_pill_enabled,
                            strict_fencing: haSettings.strict_fencing,
                        })
                    });
                    
                    if (response && response.ok) {
                        addToast(t('haSettingsSaved'));
                        setShowHaSettings(false);
                        fetchHAStatus(selectedCluster.id);
                    } else {
                        const err = await response?.json();
                        addToast(err?.error || t('operationFailed'), 'error');
                    }
                } catch (err) {
                    addToast(t('operationFailed'), 'error');
                }
            };

            // Task management
            const addTask = (task) => {
                if (!task) return;
                taskUpdateTimestamp.current = Date.now();
                setTasks(prev => {
                    // update existing task or add new one
                    const existing = prev.findIndex(item => item && item.upid === task.upid);
                    if (existing >= 0) {
                        const updated = [...prev];
                        updated[existing] = { ...updated[existing], ...task };
                        return updated;
                    }
                    // Add new task and sort by starttime
                    return [task, ...prev]
                        .sort((a, b) => (b.starttime || 0) - (a.starttime || 0))
                        .slice(0, 50);
                });
            };

            const clearCompletedTasks = () => {
                taskUpdateTimestamp.current = Date.now();
                setTasks(prev => prev.filter(item => item && item.status === 'running'));
            };

            // Cancel a running task
            const cancelTask = async (task) => {
                if (!selectedCluster || !task || !task.upid || !task.node) return;
                
                try {
                    const response = await authFetch(
                        `${API_URL}/clusters/${selectedCluster.id}/nodes/${task.node}/tasks/${encodeURIComponent(task.upid)}`,
                        { method: 'DELETE' }
                    );
                    
                    if (response && response.ok) {
                        addToast(t('taskCancelled'), 'success');
                        // update task status locally
                        setTasks(prev => prev.map(t => 
                            t && t.upid === task.upid ? { ...t, status: 'cancelled' } : t
                        ));
                    } else {
                        const err = await response?.json();
                        addToast(err?.error || t('taskCancelFailed'), 'error');
                    }
                } catch (error) {
                    console.error('cancelling task:', error);
                    addToast(t('taskCancelFailed'), 'error');
                }
            };

            // Fetch tasks from cluster
            const fetchTasks = async (clusterId) => {
                const fetchStartTime = Date.now();
                const isInitialFetch = initialTaskFetchPending.current;
                try {
                    const response = await authFetch(`${API_URL}/clusters/${clusterId}/tasks`);
                    if (response && response.ok) {
                        const data = await response.json();
                        
                        if (Array.isArray(data)) {
                            // NS: On initial fetch, always accept response (no stale check)
                            // SSE events during fetch would otherwise cause "stale" rejection
                            if (!isInitialFetch && fetchStartTime < taskUpdateTimestamp.current) {
                                console.log('Skipping stale task fetch response');
                                return;
                            }
                            
                            // Mark initial fetch as done
                            if (isInitialFetch) {
                                initialTaskFetchPending.current = false;
                            }
                            
                            taskUpdateTimestamp.current = Date.now();
                            
                            setTasks(prev => {
                                // If no new data, keep existing
                                if (data.length === 0) return prev;
                                
                                const taskMap = new Map();
                                // Add existing tasks
                                prev.forEach(task => {
                                    if (task && task.upid) taskMap.set(task.upid, task);
                                });
                                // Add/update new tasks
                                data.forEach(task => {
                                    if (task && task.upid) {
                                        const existing = taskMap.get(task.upid);
                                        taskMap.set(task.upid, existing ? { ...existing, ...task } : task);
                                    }
                                });
                                // Convert back to array, sort by starttime desc, limit to 50
                                return Array.from(taskMap.values())
                                    .sort((a, b) => (b.starttime || 0) - (a.starttime || 0))
                                    .slice(0, 50);
                            });
                        }
                    }
                } catch (err) {
                    console.error('fetching tasks:', err);
                }
            };

            // Fetch tasks when cluster changes
            useEffect(() => {
                if (selectedCluster) {
                    console.log('Cluster changed, fetching tasks for:', selectedCluster.id);
                    // NS: Reset flags for new cluster - allows initial fetch to bypass stale check
                    taskUpdateTimestamp.current = 0;
                    initialTaskFetchPending.current = true;
                    setTasks([]);  // Clear old tasks immediately
                    fetchTasks(selectedCluster.id);
                    fetchHAStatus(selectedCluster.id);
                    
                    // Poll HA status every 30 seconds to detect offline nodes
                    const haInterval = setInterval(() => {
                        fetchHAStatus(selectedCluster.id);
                    }, 30000);
                    
                    return () => clearInterval(haInterval);
                } else {
                    setTasks([]);
                    setNodeAlerts({});
                }
            }, [selectedCluster?.id]);  // Use ID, not whole object to prevent loop

            // SSE (Server-Sent Events) connection for live updates
            // More reliable than WebSocket - no threading issues on server
            useEffect(() => {
                if (!user || !sessionId) {
                    console.log('SSE: Waiting for user/session', { user: !!user, sessionId: !!sessionId });
                    return;
                }
                
                let eventSource = null;
                let reconnectTimeout = null;
                let reconnectAttempts = 0;
                let isClosing = false;
                let sseToken = null;
                let tokenRefreshInterval = null;
                
                // Get SSE token (more secure than session ID in URL)
                const getSseToken = async () => {
                    try {
                        const resp = await authFetch(`${API_URL}/sse/token`, { method: 'POST' });
                        if (resp && resp.ok) {
                            const data = await resp.json();
                            sseToken = data.token;
                            console.log('SSE token obtained (expires in', data.expires_in, 's)');
                            return true;
                        }
                    } catch (e) {
                        console.warn('Failed to get SSE token, falling back to session:', e);
                    }
                    return false;
                };
                
                const connectSSE = async () => {
                    if (isClosing) return;
                    
                    console.log('Connecting to SSE...');
                    
                    // Try to get SSE token first (preferred - doesn't expose session in logs)
                    await getSseToken();
                    
                    // Use token if available, otherwise fall back to session
                    let sseUrl;
                    if (sseToken) {
                        sseUrl = `${API_URL}/sse/updates?token=${encodeURIComponent(sseToken)}`;
                    } else {
                        // Fallback to session (legacy, less secure)
                        console.warn('SSE: Using session ID (token unavailable)');
                        sseUrl = `${API_URL}/sse/updates?session=${encodeURIComponent(sessionId)}`;
                    }
                    
                    eventSource = new EventSource(sseUrl, { withCredentials: true });
                    
                    eventSource.onopen = () => {
                        console.log('SSE connected');
                        reconnectAttempts = 0;
                        setWsConnected(true);
                        
                        // Refresh token every 4 minutes (token valid for 5 min)
                        if (tokenRefreshInterval) clearInterval(tokenRefreshInterval);
                        tokenRefreshInterval = setInterval(async () => {
                            const newToken = await getSseToken();
                            if (newToken && eventSource) {
                                // Reconnect with new token
                                console.log('SSE: Refreshing token...');
                                eventSource.close();
                                connectSSE();
                            }
                        }, 4 * 60 * 1000);
                    };
                    
                    eventSource.onmessage = (event) => {
                        try {
                            const data = JSON.parse(event.data);
                            const currentCluster = selectedClusterRef.current;
                            
                            if (data.type === 'connected') {
                                console.log('SSE authenticated');
                            } else if (data.type === 'tasks') {
                                // Tasks kommen mit cluster_id - nur vom aktuellen Cluster anzeigen
                                if (currentCluster && data.cluster_id === currentCluster.id) {
                                    if (Array.isArray(data.data)) {
                                        console.log(`SSE tasks received for cluster ${data.cluster_id}:`, data.data.length);
                                        // NS: Use merge logic same as fetchTasks to prevent jumping
                                        taskUpdateTimestamp.current = Date.now();
                                        setTasks(prev => {
                                            const taskMap = new Map();
                                            // Add existing tasks first
                                            prev.forEach(task => {
                                                if (task && task.upid) taskMap.set(task.upid, task);
                                            });
                                            // SSE data is authoritative - update/add all
                                            data.data.forEach(task => {
                                                if (task && task.upid) {
                                                    taskMap.set(task.upid, task);
                                                }
                                            });
                                            // Sort by starttime desc, limit to 50
                                            return Array.from(taskMap.values())
                                                .sort((a, b) => (b.starttime || 0) - (a.starttime || 0))
                                                .slice(0, 50);
                                        });
                                    }
                                } else if (!currentCluster) {
                                    // Kein Cluster ausgew√§hlt - alle Tasks sammeln
                                    if (Array.isArray(data.data)) {
                                        taskUpdateTimestamp.current = Date.now();
                                        setTasks(prev => {
                                            // Entferne alte Tasks vom gleichen Cluster, f√ºge neue hinzu
                                            const otherClusterTasks = prev.filter(t => t.cluster_id !== data.cluster_id);
                                            const newTasks = data.data.map(t => ({...t, cluster_id: data.cluster_id}));
                                            return [...otherClusterTasks, ...newTasks]
                                                .sort((a, b) => (b.starttime || 0) - (a.starttime || 0))
                                                .slice(0, 50);
                                        });
                                    }
                                }
                            } else if (data.type === 'metrics') {
                                // Only update detailed clusterMetrics for the selected cluster
                                // LW: allClusterMetrics is updated via fetchClusters using datacenter/status API
                                if (currentCluster && data.cluster_id === currentCluster.id) {
                                    setClusterMetrics(data.data);
                                    setLastUpdate(new Date());
                                    
                                    // NS: Track all nodes - nodes in metrics are online
                                    setKnownNodes(prev => {
                                        const updated = { ...prev };
                                        const now = new Date().toISOString();
                                        
                                        // Mark all nodes in metrics as online
                                        Object.keys(data.data || {}).forEach(nodeName => {
                                            updated[nodeName] = {
                                                status: 'online',
                                                lastSeen: now,
                                                metrics: data.data[nodeName]
                                            };
                                        });
                                        
                                        // DON'T mark nodes as offline based on metrics
                                        // Let the node_status SSE event handle offline detection
                                        
                                        return updated;
                                    });
                                }
                            } else if (data.type === 'resources') {
                                // NS: ONLY process resources for the currently selected cluster
                                if (currentCluster && data.cluster_id === currentCluster.id) {
                                    setClusterResources(data.data);
                                    // MK: Store in window for access from ConfigModal reassign feature
                                    window.pegaproxVmList = data.data;
                                    setLastUpdate(new Date());
                                }
                            } else if (data.type === 'action') {
                                const action = data.data;
                                const currentUser = user?.username;
                                if (action.user && action.user !== currentUser) {
                                    const actionNames = {
                                        'start': t('started'), 'stop': t('stopped'),
                                        'shutdown': t('stopped'), 'reboot': t('restarted')
                                    };
                                    const actionName = actionNames[action.action] || action.action;
                                    const resourceType = action.resource_type === 'qemu' ? 'VM' : 'CT';
                                    addToast(`${action.user}: ${resourceType} ${action.resource_id} ${actionName}`, 'info');
                                }
                            } else if (data.type === 'node_status') {
                                // handle node online/offline events
                                // NS: ONLY process events for the currently selected cluster!
                                const nodeEvent = data.data;
                                if (currentCluster && nodeEvent.cluster_id === currentCluster.id) {
                                    if (nodeEvent.event === 'node_offline') {
                                        // Show critical alert for node offline
                                        addToast(`‚ö†Ô∏è CRITICAL: ${nodeEvent.message}`, 'error');
                                        setNodeAlerts(prev => ({
                                            ...prev,
                                            [nodeEvent.node]: {
                                                status: 'offline',
                                                message: nodeEvent.message,
                                                timestamp: new Date().toISOString(),
                                                severity: 'critical',
                                                cluster_id: nodeEvent.cluster_id
                                            }
                                        }));
                                    } else if (nodeEvent.event === 'node_online') {
                                        // Node is back online
                                        addToast(`‚úì ${nodeEvent.message}`, 'success');
                                        setNodeAlerts(prev => {
                                            const newAlerts = { ...prev };
                                            delete newAlerts[nodeEvent.node];
                                            return newAlerts;
                                        });
                                    }
                                }
                            }
                        } catch (e) {
                            console.error('SSE message error:', e);
                        }
                    };
                    
                    eventSource.onerror = (error) => {
                        console.error('SSE error, reconnecting...');
                        setWsConnected(false);
                        eventSource.close();
                        
                        if (!isClosing) {
                            const delay = Math.min(1000 * Math.pow(2, reconnectAttempts), 30000);
                            reconnectAttempts++;
                            reconnectTimeout = setTimeout(connectSSE, delay);
                        }
                    };
                };
                
                connectSSE();
                
                return () => {
                    isClosing = true;
                    if (reconnectTimeout) clearTimeout(reconnectTimeout);
                    if (tokenRefreshInterval) clearInterval(tokenRefreshInterval);
                    if (eventSource) eventSource.close();
                };
            }, [user, sessionId]);  // React to both user and sessionId changes
            
            // update WebSocket subscription when selected cluster changes
            useEffect(() => {
                if (wsRef.current && wsRef.current.readyState === WebSocket.OPEN && selectedCluster) {
                    wsRef.current.send(JSON.stringify({
                        type: 'subscribe',
                        clusters: [selectedCluster.id]
                    }));
                }
            }, [selectedCluster?.id]);

            useEffect(() => {
                fetchClusters();
                fetchClusterGroups();
                const interval = setInterval(fetchClusters, 30000);
                return () => clearInterval(interval);
            }, []);
            
            // LW: Check for updates on login (admins only)
            useEffect(() => {
                if (!isAdmin) return;
                
                const checkForUpdate = async () => {
                    try {
                        const resp = await fetch(`${API_URL}/pegaprox/check-update`, {
                            credentials: 'include',
                            headers: getAuthHeaders()
                        });
                        if (resp.ok) {
                            const data = await resp.json();
                            if (data.update_available) {
                                setPendingUpdate(data);
                                setShowUpdateNotification(true);
                            }
                        }
                    } catch (e) {
                        console.log('Update check failed:', e);
                    }
                };
                
                // Delay check slightly to let UI settle
                const timer = setTimeout(checkForUpdate, 2000);
                return () => clearTimeout(timer);
            }, [isAdmin]);

            useEffect(() => {
                // Reset data when switching clusters to avoid showing old data
                // NS: Always reset first, even if no cluster selected (prevents cross-cluster leaks)
                setClusterMetrics({});
                setClusterResources([]);
                setTasks([]);
                setKnownNodes({}); // NS: Clear known nodes when switching clusters
                setNodeAlerts({}); // Also clear node alerts
                setGlobalSnapshots([]); 
                setResourcesSubTab('management');
                setSnapshotFilterDate(''); 
                setSnapshotSortBy('age'); 
                setSnapshotSortDir('desc');
                
                if (selectedCluster) {
                    // Fetch new data
                    fetchClusterMetrics(selectedCluster.id);
                    fetchClusterResources(selectedCluster.id);
                    fetchMigrationLogs(selectedCluster.id);
                    fetchTasks(selectedCluster.id);
                    
                    // Auto-refresh polling
                    // NS: If SSE is connected, we poll less frequently as backup only
                    // SSE provides real-time updates, polling is just a fallback
                    const taskInterval = setInterval(() => {
                        // Skip polling if SSE just updated us (within last 3 seconds)
                        if (Date.now() - taskUpdateTimestamp.current < 3000) {
                            return;
                        }
                        fetchTasks(selectedCluster.id);
                    }, 5000);
                    
                    const resourceInterval = setInterval(() => {
                        fetchClusterMetrics(selectedCluster.id);
                        fetchClusterResources(selectedCluster.id);
                    }, 15000);
                    
                    const logsInterval = setInterval(() => {
                        fetchMigrationLogs(selectedCluster.id);
                    }, 30000);
                    
                    return () => {
                        clearInterval(taskInterval);
                        clearInterval(resourceInterval);
                        clearInterval(logsInterval);
                    };
                }
            }, [selectedCluster?.id]);

            const fetchClusters = async () => {
                try {
                    const response = await authFetch(`${API_URL}/clusters`);
                    if (response && response.ok) {
                        const data = await response.json();
                        setClusters(data);
                        if (selectedCluster) {
                            const updated = data.find(c => c.id === selectedCluster.id);
                            if (updated) setSelectedCluster(updated);
                        }
                        
                        // fetch status for all clusters (overview)
                        const connectedClusters = data.filter(c => c.connected);
                        const allGuests = [];
                        
                        for (const cluster of connectedClusters) {
                            try {
                                // datacenter status
                                const statusResp = await authFetch(`${API_URL}/clusters/${cluster.id}/datacenter/status`);
                                if (statusResp && statusResp.ok) {
                                    const statusData = await statusResp.json();
                                    setAllClusterMetrics(prev => ({
                                        ...prev,
                                        [cluster.id]: {
                                            data: statusData,
                                            lastUpdate: new Date()
                                        }
                                    }));
                                }
                                
                                // get vms/cts for the top guests table
                                const resourcesResp = await authFetch(`${API_URL}/clusters/${cluster.id}/resources`);
                                if (resourcesResp && resourcesResp.ok) {
                                    const resources = await resourcesResp.json();
                                    resources.filter(r => r.type === 'qemu' || r.type === 'lxc').forEach(r => {
                                        allGuests.push({
                                            ...r,
                                            cluster_id: cluster.id,
                                            cluster_name: cluster.display_name || cluster.name
                                        });
                                    });
                                }
                            } catch (e) {
                                console.log(`Failed to fetch data for cluster ${cluster.id}:`, e);
                            }
                        }
                        
                        // sort by combined cpu+ram usage
                        const runningGuests = allGuests.filter(g => g.status === 'running');
                        runningGuests.sort((a, b) => {
                            const aScore = ((a.cpu || 0) * 100) + (a.maxmem > 0 ? (a.mem / a.maxmem) * 100 : 0);
                            const bScore = ((b.cpu || 0) * 100) + (b.maxmem > 0 ? (b.mem / b.maxmem) * 100 : 0);
                            return bScore - aScore;
                        });
                        setTopGuests(runningGuests.slice(0, 10));
                    }
                } catch (error) {
                    console.error('fetching clusters:', error);
                }
            };
            
            // NS Jan 2026 - fetch cluster groups for sidebar display
            const fetchClusterGroups = async () => {
                try {
                    const response = await authFetch(`${API_URL}/cluster-groups`);
                    if (response && response.ok) {
                        setClusterGroups(await response.json());
                    }
                } catch (error) {
                    console.error('fetching cluster groups:', error);
                }
            };

            const fetchClusterMetrics = async (clusterId) => {
                try {
                    const response = await authFetch(`${API_URL}/clusters/${clusterId}/metrics`);
                    if (response && response.ok) {
                        const data = await response.json();
                        
                        // Don't update if we got an error response
                        if (data.error) {
                            console.warn('Metrics returned error:', data.error);
                            return; // Keep old data
                        }
                        
                        setClusterMetrics(data);
                        
                        // NS: Also update knownNodes when fetching metrics
                        setKnownNodes(prev => {
                            const updated = { ...prev };
                            const now = new Date().toISOString();
                            
                            // Mark all nodes in metrics as online
                            Object.keys(data || {}).forEach(nodeName => {
                                // Skip error keys
                                if (nodeName === 'error' || nodeName === 'offline') return;
                                
                                updated[nodeName] = {
                                    status: 'online',
                                    lastSeen: now,
                                    metrics: data[nodeName]
                                };
                            });
                            
                            // DON'T mark nodes as offline just because they're missing from metrics
                            // This could be a temporary connection issue - let HA events handle this
                            
                            return updated;
                        });
                    } else if (response && response.status === 503) {
                        // Cluster temporarily offline - don't clear data
                        console.warn('Cluster temporarily offline, keeping cached data');
                    }
                } catch (error) {
                    console.error('fetching metrics:', error);
                    // Don't update state on error - keep old data
                }
            };

            const fetchClusterResources = async (clusterId) => {
                try {
                    const response = await authFetch(`${API_URL}/clusters/${clusterId}/resources`);
                    if (response && response.ok) {
                        const data = await response.json();
                        setClusterResources(data);
                        // MK: Store in window for access from ConfigModal reassign feature
                        window.pegaproxVmList = data;
                        setLastUpdate(new Date());
                        
                        // NS: Also track nodes from resources - this includes offline nodes!
                        const nodeResources = (data || []).filter(r => r.type === 'node');
                        if (nodeResources.length > 0) {
                            setKnownNodes(prev => {
                                const updated = { ...prev };
                                const now = new Date().toISOString();
                                
                                nodeResources.forEach(nodeRes => {
                                    const nodeName = nodeRes.node;
                                    const isOnline = nodeRes.status === 'online';
                                    
                                    if (isOnline) {
                                        updated[nodeName] = {
                                            status: 'online',
                                            lastSeen: now,
                                            resourceData: nodeRes
                                        };
                                    } else if (!updated[nodeName] || updated[nodeName].status === 'online') {
                                        // Node went offline or is new and offline
                                        updated[nodeName] = {
                                            ...updated[nodeName],
                                            status: 'offline',
                                            offlineSince: updated[nodeName]?.lastSeen || now,
                                            resourceData: nodeRes
                                        };
                                    }
                                });
                                
                                return updated;
                            });
                        }
                    }
                } catch (error) {
                    // silently fail, will retry on next interval
                }
            };

            const fetchMigrationLogs = async (clusterId) => {
                try {
                    const response = await authFetch(`${API_URL}/clusters/${clusterId}/migrations`);
                    if (response && response.ok) {
                        const data = await response.json();
                        setMigrationLogs(data);
                    }
                } catch (e) {}  // dont care if this fails
            };

            const handleAddCluster = async (config) => {
                setLoading(true);
                setError(null);
                
                try {
                    const response = await authFetch(`${API_URL}/clusters`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(config)
                    });
                    
                    if (response && response.ok) {
                        await fetchClusters();
                        setShowAddModal(false);
                        addToast(t('clusterAdded') || 'Cluster added successfully');
                    } else {
                        const err = await response.json();
                        setError(err.error || t('connectionFailed'));
                    }
                } catch (error) {
                    setError(t('connectionError') + ': ' + error.message);
                }
                setLoading(false);
            };

            const handleDeleteCluster = async (clusterId) => {
                if (!window.confirm(t('deleteClusterConfirm'))) return;
                
                try {
                    const response = await authFetch(`${API_URL}/clusters/${clusterId}`, { method: 'DELETE' });
                    if (response && response.ok) {
                        await fetchClusters();
                        if (selectedCluster?.id === clusterId) setSelectedCluster(null);
                        addToast(t('clusterDeleted') || 'Cluster deleted');
                    }
                } catch (error) {
                    addToast(t('deleteError') || 'Delete error', 'error');
                }
            };

            // Debounced config update - batches rapid changes
            const pendingConfigUpdates = useRef({});
            const configUpdateTimer = useRef(null);
            
            const updateConfig = (key, value) => {
                if (!selectedCluster) return;
                
                // Special handling for HA enable/disable
                if (key === 'ha_enabled') {
                    handleHAToggle(value);
                    return;
                }
                
                // update local state immediately for responsive UI
                setSelectedCluster(prev => prev ? {...prev, [key]: value} : prev);
                
                // Batch the update
                pendingConfigUpdates.current[key] = value;
                
                // Debounce the API call
                if (configUpdateTimer.current) {
                    clearTimeout(configUpdateTimer.current);
                }
                
                configUpdateTimer.current = setTimeout(async () => {
                    const updates = {...pendingConfigUpdates.current};
                    pendingConfigUpdates.current = {};
                    
                    try {
                        const response = await authFetch(`${API_URL}/clusters/${selectedCluster.id}/config`, {
                            method: 'PATCH',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(updates)
                        });
                        
                        if (response && response.ok) {
                            // Don't refetch - we already updated local state
                            addToast(t('settingsSaved') || 'Settings saved');
                        } else {
                            // Revert on error
                            fetchClusters();
                            addToast(t('saveError') || 'Error saving', 'error');
                        }
                    } catch (error) {
                        fetchClusters();
                        addToast(t('saveError') || 'Error saving', 'error');
                    }
                }, 500); // Wait 500ms after last change before saving
            };
            
            const handleHAToggle = async (enable) => {
                if (!selectedCluster) return;
                
                try {
                    const endpoint = enable ? 'enable' : 'disable';
                    const response = await authFetch(`${API_URL}/clusters/${selectedCluster.id}/ha/${endpoint}`, {
                        method: 'POST'
                    });
                    
                    if (response && response.ok) {
                        setSelectedCluster(prev => prev ? {...prev, ha_enabled: enable} : prev);
                        addToast(enable ? t('haEnabled') : t('haDisabled'));
                        
                        // Also update the clusters list
                        setClusters(prev => prev.map(c => 
                            c.id === selectedCluster.id ? {...c, ha_enabled: enable} : c
                        ));
                    } else {
                        const err = await response?.json();
                        addToast(err?.error || t('operationFailed'), 'error');
                    }
                } catch (error) {
                    addToast(t('operationFailed'), 'error');
                }
            };

            const handleMaintenanceToggle = async (nodeName, enable) => {
                if (!selectedCluster) return;
                
                try {
                    if (enable) {
                        addToast(`${t('startingMaintenanceMode') || 'Starting maintenance mode'}: ${nodeName}...`, 'info');
                        const response = await authFetch(`${API_URL}/clusters/${selectedCluster.id}/nodes/${nodeName}/maintenance`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ enable: true })
                        });
                        
                        if (response && response.ok) {
                            addToast(`${t('maintenanceModeEnabled') || 'Maintenance mode enabled'}: ${nodeName}`);
                            await fetchClusterMetrics(selectedCluster.id);
                        } else {
                            const err = await response.json();
                            addToast(err.error || t('activationError') || 'Activation error', 'error');
                        }
                    } else {
                        const response = await authFetch(`${API_URL}/clusters/${selectedCluster.id}/nodes/${nodeName}/maintenance`, {
                            method: 'DELETE'
                        });
                        
                        if (response && response.ok) {
                            addToast(`${t('nodeMaintenanceExited') || 'Maintenance mode exited'}: ${nodeName}`);
                            await fetchClusterMetrics(selectedCluster.id);
                        } else {
                            const err = await response.json();
                            addToast(err.error || t('deactivationError') || 'Deactivation error', 'error');
                        }
                    }
                } catch (error) {
                    addToast(t('connectionError'), 'error');
                }
            };

            const handleStartUpdate = async (nodeName, reboot) => {
                if (!selectedCluster) return;
                
                try {
                    addToast(t('startingUpdateFor') + ` ${nodeName}...`, 'info');
                    const response = await authFetch(`${API_URL}/clusters/${selectedCluster.id}/nodes/${nodeName}/update`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ reboot })
                    });
                    
                    if (response && response.ok) {
                        addToast(t('updateStartedFor') + ` ${nodeName}`);
                        await fetchClusterMetrics(selectedCluster.id);
                    } else {
                        const err = await response.json();
                        addToast(err.error || t('errorStartingUpdate'), 'error');
                    }
                } catch (error) {
                    addToast(t('connectionError'), 'error');
                }
            };

            const handleNodeAction = async (nodeName, action) => {
                if (!selectedCluster) return;
                
                try {
                    const actionText = action === 'reboot' ? t('rebootNode') : t('shutdownNode');
                    addToast(`${actionText}: ${nodeName}...`, 'info');
                    
                    const response = await authFetch(`${API_URL}/clusters/${selectedCluster.id}/nodes/${nodeName}/action/${action}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    
                    if (response && response.ok) {
                        addToast(`${nodeName} ${action === 'reboot' ? t('rebootInitiated') : t('shutdownInitiated')}`, 'success');
                        await fetchClusterMetrics(selectedCluster.id);
                    } else {
                        const err = await response.json();
                        if (err.error?.includes('sudo')) {
                            addToast(t('sudoNotAvailable'), 'error');
                        } else {
                            addToast(err.error || t('nodeActionFailed'), 'error');
                        }
                    }
                } catch (error) {
                    addToast(t('connectionError'), 'error');
                }
            };

            const handleVmAction = async (resource, action) => {
                if (!selectedCluster) return;
                
                // LW: Optimistic UI update - show expected status immediately
                // This makes the UI feel much snappier while we wait for Proxmox
                const expectedStatus = {
                    'start': 'running',
                    'stop': 'stopped',
                    'shutdown': 'stopped',
                    'reboot': 'running',
                    'reset': 'running',
                    'suspend': 'suspended',
                    'resume': 'running'
                };
                
                if (expectedStatus[action]) {
                    setClusterResources(prev => 
                        prev.map(r => 
                            r.vmid === resource.vmid && r.node === resource.node 
                                ? { ...r, status: expectedStatus[action], _optimistic: true }
                                : r
                        )
                    );
                }
                
                try {
                    const response = await fetch(
                        `${API_URL}/clusters/${selectedCluster.id}/vms/${resource.node}/${resource.type}/${resource.vmid}/${action}`,
                        { method: 'POST' }
                    );
                    
                    if (response && response.ok) {
                        addToast(`${action} ${t('successful') || 'successful'}: ${resource.name || resource.vmid}`);
                        // SSE will push the real status update, but fetch as backup
                        setTimeout(() => fetchClusterResources(selectedCluster.id), 2000);
                    } else {
                        const err = await response.json();
                        addToast(err.error || `${action} ${t('actionFailed')}`, 'error');
                        // Revert optimistic update on error
                        fetchClusterResources(selectedCluster.id);
                    }
                } catch (error) {
                    addToast(t('connectionError'), 'error');
                    // Revert optimistic update on error
                    fetchClusterResources(selectedCluster.id);
                }
            };

            const handleMigrate = async (vm, targetNode, online, options = {}) => {
                if (!selectedCluster) return;
                
                try {
                    addToast(t('startingMigration') + ` ${vm.name || vm.vmid}...`);
                    const response = await fetch(
                        `${API_URL}/clusters/${selectedCluster.id}/vms/${vm.node}/${vm.type}/${vm.vmid}/migrate`,
                        {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ 
                                target: targetNode, 
                                online,
                                targetstorage: options.targetStorage || null,
                                'with-local-disks': options.withLocalDisks || false,
                                force: options.forceConntrack || false
                            })
                        }
                    );
                    
                    if (response && response.ok) {
                        addToast(t('migrationStarted') + ` ${vm.name || vm.vmid} ‚Üí ${targetNode}`);
                        // WebSocket will handle task updates in real-time
                        setTimeout(() => fetchClusterResources(selectedCluster.id), 3000);
                    } else {
                        const err = await response.json();
                        addToast(err.error || t('migrationFailed'), 'error');
                    }
                } catch (error) {
                    addToast(t('connectionError'), 'error');
                }
            };

            const handleBulkMigrate = async (vms, targetNode, online) => {
                if (!selectedCluster) return;
                
                try {
                    addToast(`${t('startingBulkMigration')} ${vms.length} VMs...`);
                    const response = await fetch(
                        `${API_URL}/clusters/${selectedCluster.id}/vms/bulk-migrate`,
                        {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ vms, target: targetNode, online })
                        }
                    );
                    
                    if (response && response.ok) {
                        const result = await response.json();
                        addToast(`${result.successful}/${result.total} ${t('migrationsStarted') || 'migrations started'}`);
                        setTimeout(() => fetchClusterResources(selectedCluster.id), 3000);
                    } else {
                        const err = await response.json();
                        addToast(err.error || t('bulkMigrationFailed'), 'error');
                    }
                } catch (error) {
                    addToast(t('connectionError'), 'error');
                }
            };

            const handleCreateVm = async (vmType, node, config) => {
                if (!selectedCluster) return;
                
                try {
                    const endpoint = vmType === 'qemu' ? 'qemu' : 'lxc';
                    const response = await fetch(
                        `${API_URL}/clusters/${selectedCluster.id}/nodes/${node}/${endpoint}`,
                        {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(config)
                        }
                    );
                    
                    if (response && response.ok) {
                        const result = await response.json();
                        addToast(`${vmType === 'qemu' ? 'VM' : 'Container'} ${result.vmid} ${t('created') || 'created'}`);
                        setShowCreateVm(null);
                        setTimeout(() => fetchClusterResources(selectedCluster.id), 2000);
                    } else {
                        const err = await response.json();
                        addToast(err.error || t('creationFailed'), 'error');
                    }
                } catch (error) {
                    addToast(t('connectionError'), 'error');
                }
            };

            const handleDeleteVm = async (vm, options = {}) => {
                if (!selectedCluster) return;
                
                try {
                    const response = await fetch(
                        `${API_URL}/clusters/${selectedCluster.id}/vms/${vm.node}/${vm.type}/${vm.vmid}`,
                        {
                            method: 'DELETE',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(options)
                        }
                    );
                    
                    if (response && response.ok) {
                        const result = await response.json();
                        addToast(result.message || `${vm.type === 'qemu' ? 'VM' : 'Container'} ${vm.vmid} deleted`);
                        setTimeout(() => fetchClusterResources(selectedCluster.id), 2000);
                    } else {
                        const err = await response.json();
                        addToast(err.error || 'Delete failed', 'error');
                    }
                } catch (error) {
                    addToast(t('connectionError'), 'error');
                }
            };

            const handleCloneVm = async (vm, cloneConfig) => {
                if (!selectedCluster) return;
                
                try {
                    const response = await fetch(
                        `${API_URL}/clusters/${selectedCluster.id}/vms/${vm.node}/${vm.type}/${vm.vmid}/clone`,
                        {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                newid: parseInt(cloneConfig.newid),
                                name: cloneConfig.name,
                                full: cloneConfig.full,
                                target_node: cloneConfig.target_node,
                                description: cloneConfig.description
                            })
                        }
                    );
                    
                    if (response && response.ok) {
                        const result = await response.json();
                        addToast(result.message || `${t('cloneStarted') || 'Clone started'}: ${vm.vmid} ‚Üí ${cloneConfig.newid}`);
                        setShowCloneModal(null);
                        setTimeout(() => fetchClusterResources(selectedCluster.id), 3000);
                    } else {
                        const err = await response.json();
                        addToast(err.error || t('cloneFailed'), 'error');
                    }
                } catch (error) {
                    addToast(t('connectionError'), 'error');
                }
            };

            const handleForceStop = async (resource) => {
                console.log('handleForceStop called with:', resource);
                if (!selectedCluster) {
                    console.log('No selectedCluster, returning');
                    return;
                }
                
                if (!confirm(`${resource.name || resource.vmid} ${t('forceStopConfirm')}`)) {
                    console.log('User cancelled');
                    return;
                }
                
                setActionLoading(prev => ({...prev, [`${resource.vmid}-stop`]: true}));
                
                const url = `${API_URL}/clusters/${selectedCluster.id}/vms/${resource.node}/${resource.type}/${resource.vmid}/stop`;
                console.log('Force Stop URL:', url);
                console.log('Force Stop body:', JSON.stringify({ force: true }));
                
                try {
                    const response = await authFetch(url, { 
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ force: true })
                    });
                    
                    console.log('Force Stop response:', response);
                    
                    if (response && response.ok) {
                        addToast(`${resource.name || resource.vmid} wird hart ausgeschaltet...`);
                        setTimeout(() => fetchClusterResources(selectedCluster.id), 2000);
                    } else if (response) {
                        const err = await response.json();
                        console.log('Force Stop error:', err);
                        addToast(err.error || t('forceStopFailed'), 'error');
                    } else {
                        console.log('No response from authFetch');
                        addToast(t('connectionFailed'), 'error');
                    }
                } catch (error) {
                    console.error('Force Stop exception:', error);
                    addToast(t('connectionError'), 'error');
                }
                
                setActionLoading(prev => ({...prev, [`${resource.vmid}-stop`]: false}));
            };

            const handleCrossClusterMigrate = async (migrationConfig) => {
                try {
                    const response = await authFetch(
                        `${API_URL}/cross-cluster-migrate`,
                        {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(migrationConfig)
                        }
                    );
                    
                    if (response && response.ok) {
                        const result = await response.json();
                        addToast(result.message || t('crossClusterStarted'));
                        setTimeout(() => fetchClusterResources(selectedCluster.id), 5000);
                    } else if (response) {
                        const err = await response.json();
                        addToast(err.error || t('crossClusterFailed'), 'error');
                    }
                } catch (error) {
                    addToast(t('connectionError'), 'error');
                }
            };

            const [consoleVm, setConsoleVm] = useState(null);
            const [consoleInfo, setConsoleInfo] = useState(null);
            const [configVm, setConfigVm] = useState(null);
            const [configNode, setConfigNode] = useState(null);

            const handleOpenConsole = async (resource) => {
                if (!selectedCluster) return;
                
                // Just open the console modal - WebSocket proxy handles authentication
                setConsoleInfo({ 
                    vmid: resource.vmid,
                    node: resource.node,
                    type: resource.type
                });
                setConsoleVm(resource);
            };

            const handleCloseConsole = () => {
                setConsoleVm(null);
                setConsoleInfo(null);
            };

            const handleOpenConfig = (resource) => {
                setConfigVm(resource);
            };

            const handleCloseConfig = () => {
                setConfigVm(null);
                // Refresh resources after config changes
                if (selectedCluster) {
                    fetchClusterResources(selectedCluster.id);
                }
            };

            return (
                <div className="min-h-screen bg-proxmox-darker text-white">
                    {/* LW: Password Expiry Warning */}
                    <PasswordExpiryBanner onChangePassword={() => setShowProfile(true)} />
                    
                    {/* Node Offline Alert Banner */}
                    <NodeAlertBanner 
                        alerts={nodeAlerts} 
                        currentClusterId={selectedCluster?.id}
                        onDismiss={(nodeName) => setNodeAlerts(prev => {
                            const newAlerts = { ...prev };
                            delete newAlerts[nodeName];
                            return newAlerts;
                        })}
                    />
                    
                    {/* Background gradient mesh */}
                    <div className="fixed inset-0 gradient-mesh pointer-events-none" />
                    
                    {/* Header */}
                    <header className="sticky top-0 z-30 border-b border-proxmox-border bg-proxmox-dark/80 backdrop-blur-xl">
                        <div className="max-w-[1600px] mx-auto px-6 py-4">
                            <div className="flex items-center justify-between">
                                {/* MK: Click logo to return to All Clusters Overview */}
                                <button 
                                    onClick={() => setSelectedCluster(null)}
                                    className="flex items-center gap-4 hover:opacity-80 transition-opacity"
                                    title={t('allClustersOverview') || 'All Clusters Overview'}
                                >
                                    {/* PegaProx Logo */}
                                    <img 
                                        src="/images/pegaprox.png" 
                                        alt="PegaProx" 
                                        className="w-10 h-10 rounded-xl object-contain"
                                        onError={(e) => {
                                            // fallback to SVG if PNG not found
                                            e.target.style.display = 'none';
                                            e.target.nextSibling.style.display = 'flex';
                                        }}
                                    />
                                    <div className="w-10 h-10 rounded-xl bg-gradient-to-br from-proxmox-orange to-orange-600 items-center justify-center shadow-lg glow-orange hidden">
                                        <svg viewBox="0 0 24 24" className="w-6 h-6 text-white" fill="currentColor">
                                            {/* Pegasus wing + P shape */}
                                            <path d="M12 2C9.5 2 7 3.5 6 6c-1.5 0-3 1-3 3 0 1.5 1 2.5 2 3l1 6c0 1 1 2 2 2h8c1 0 2-1 2-2l1-6c1-.5 2-1.5 2-3 0-2-1.5-3-3-3-1-2.5-3.5-4-6-4zm0 2c2 0 3.5 1 4 3H8c.5-2 2-3 4-3zM5 9h14c.5 0 1 .5 1 1s-.5 1.5-1 2l-1 5H6l-1-5c-.5-.5-1-1-1-2s.5-1 1-1zm7 1a2 2 0 100 4 2 2 0 000-4z"/>
                                        </svg>
                                    </div>
                                    <div className="text-left">
                                        <h1 className="text-xl font-bold">PegaProx</h1>
                                        <p className="text-xs text-gray-500">{t('clusterManagement')}</p>
                                    </div>
                                </button>
                                <div className="flex items-center gap-3">
                                    {/* NS: Global Search - Jan 2026 */}
                                    <div className="relative">
                                        <div className="flex items-center bg-proxmox-dark border border-proxmox-border rounded-lg overflow-hidden">
                                            <input
                                                type="text"
                                                placeholder={t('searchAllClusters') || 'Search all clusters...'}
                                                value={globalSearchQuery}
                                                onChange={(e) => {
                                                    setGlobalSearchQuery(e.target.value);
                                                    if (e.target.value.length >= 2) {
                                                        performGlobalSearch(e.target.value);
                                                    } else {
                                                        setGlobalSearchResults(null);
                                                    }
                                                }}
                                                onFocus={() => setShowGlobalSearch(true)}
                                                onKeyDown={(e) => {
                                                    // NS: Enter scrolls to first result in compact view
                                                    if (e.key === 'Enter' && globalSearchResults?.results?.length > 0) {
                                                        const result = globalSearchResults.results[0];
                                                        const cluster = clusters.find(c => c.id === result.cluster_id);
                                                        if (cluster) {
                                                            setSelectedCluster(cluster);
                                                            if (result.type === 'vm' || result.type === 'ct' || result.type === 'qemu' || result.type === 'lxc') {
                                                                setTimeout(() => {
                                                                    setHighlightedVm({ vmid: result.vmid, node: result.node });
                                                                    setTimeout(() => setHighlightedVm(null), 3000);
                                                                }, 300);
                                                            }
                                                        }
                                                        setShowGlobalSearch(false);
                                                        setGlobalSearchQuery('');
                                                    } else if (e.key === 'Escape') {
                                                        setShowGlobalSearch(false);
                                                    }
                                                }}
                                                className="w-48 md:w-64 px-3 py-2 bg-transparent text-white placeholder-gray-500 focus:outline-none text-sm"
                                            />
                                            <button
                                                onClick={() => performGlobalSearch(globalSearchQuery)}
                                                className="px-3 py-2 text-gray-400 hover:text-white"
                                            >
                                                {globalSearchLoading ? (
                                                    <Icons.RotateCw className="w-4 h-4 animate-spin" />
                                                ) : (
                                                    <Icons.Search className="w-4 h-4" />
                                                )}
                                            </button>
                                        </div>
                                        
                                        {/* Search Results Dropdown */}
                                        {showGlobalSearch && globalSearchResults && (
                                            <>
                                                <div className="fixed inset-0 z-40" onClick={() => setShowGlobalSearch(false)} />
                                                <div className="absolute top-full left-0 mt-2 w-96 max-h-96 overflow-y-auto bg-proxmox-card border border-proxmox-border rounded-xl shadow-xl z-50">
                                                    <div className="p-3 border-b border-proxmox-border flex justify-between items-center">
                                                        <span className="text-sm text-gray-400">
                                                            {globalSearchResults.count} {t('results') || 'results'}
                                                        </span>
                                                        <button onClick={() => setShowGlobalSearch(false)} className="text-gray-500 hover:text-white">
                                                            <Icons.X className="w-4 h-4" />
                                                        </button>
                                                    </div>
                                                    {globalSearchResults.results.length === 0 ? (
                                                        <div className="p-4 text-center text-gray-500">
                                                            <Icons.Search className="mx-auto mb-2 opacity-50" />
                                                            <p>{t('noResults') || 'No results'}</p>
                                                        </div>
                                                    ) : (
                                                        <div className="divide-y divide-proxmox-border">
                                                            {globalSearchResults.results.slice(0, 20).map((result, idx) => (
                                                                <div
                                                                    key={idx}
                                                                    className={`p-3 hover:bg-proxmox-hover cursor-pointer flex items-center gap-3 ${idx === 0 ? 'bg-proxmox-orange/10 border-l-2 border-proxmox-orange' : ''}`}
                                                                    onClick={() => {
                                                                        // LW: jump to VM in compact view instead of opening config modal
                                                                        // users kept asking for this, finally did it lol
                                                                        const cluster = clusters.find(c => c.id === result.cluster_id);
                                                                        if (cluster) {
                                                                            setSelectedCluster(cluster);
                                                                            if (result.type === 'vm' || result.type === 'ct' || result.type === 'qemu' || result.type === 'lxc') {
                                                                                // need delay for cluster data to load
                                                                                setTimeout(() => {
                                                                                    setHighlightedVm({ vmid: result.vmid, node: result.node });
                                                                                    setTimeout(() => setHighlightedVm(null), 3000);  // 3s highlight then fade
                                                                                }, 300);
                                                                            }
                                                                        }
                                                                        setShowGlobalSearch(false);
                                                                        setGlobalSearchQuery('');
                                                                    }}
                                                                >
                                                                    <span className="text-lg">
                                                                        {result.type === 'vm' ? 'üñ•Ô∏è' : result.type === 'ct' ? 'üì¶' : 'üñß'}
                                                                    </span>
                                                                    <div className="flex-1 min-w-0">
                                                                        <div className="flex items-center gap-2">
                                                                            <span className="font-medium truncate">{result.name}</span>
                                                                            {result.vmid && (
                                                                                <span className="text-xs text-gray-500">#{result.vmid}</span>
                                                                            )}
                                                                            <span className={`px-1.5 py-0.5 text-xs rounded ${
                                                                                result.status === 'running' ? 'bg-green-500/20 text-green-400' :
                                                                                result.status === 'stopped' ? 'bg-gray-500/20 text-gray-400' :
                                                                                'bg-yellow-500/20 text-yellow-400'
                                                                            }`}>
                                                                                {result.status}
                                                                            </span>
                                                                        </div>
                                                                        <div className="text-xs text-gray-500 flex items-center gap-2">
                                                                            <span>{result.cluster_name}</span>
                                                                            {result.node && <span>‚Ä¢ {result.node}</span>}
                                                                            {result.ip && <span>‚Ä¢ {result.ip}</span>}
                                                                        </div>
                                                                    </div>
                                                                    <button
                                                                        onClick={(e) => {
                                                                            e.stopPropagation();
                                                                            toggleFavorite(result.type, result.cluster_id, result.vmid, result.type === 'vm' ? 'qemu' : 'lxc', result.name);
                                                                        }}
                                                                        className="p-1 hover:bg-proxmox-dark rounded text-gray-500 hover:text-yellow-400"
                                                                        title={t('toggleFavorite') || 'Toggle favorite'}
                                                                    >
                                                                        <Icons.Star className={`w-4 h-4 ${isFavorite(result.type, result.cluster_id, result.vmid, result.name) ? 'fill-yellow-400 text-yellow-400' : ''}`} />
                                                                    </button>
                                                                </div>
                                                            ))}
                                                        </div>
                                                    )}
                                                    {/* Keyboard hint */}
                                                    {globalSearchResults.results.length > 0 && (
                                                        <div className="p-2 border-t border-proxmox-border text-xs text-gray-500 flex items-center gap-2">
                                                            <kbd className="px-1.5 py-0.5 bg-proxmox-dark rounded text-gray-400">‚Üµ</kbd>
                                                            <span>{t('pressEnterToOpen') || 'Press Enter to jump to VM'}</span>
                                                        </div>
                                                    )}
                                                </div>
                                            </>
                                        )}
                                    </div>
                                    
                                    <LanguageSwitcher />
                                    
                                    {/* Settings Button - Admin Only */}
                                    {isAdmin && (
                                        <button
                                            onClick={() => setShowSettings(true)}
                                            className="p-2.5 bg-proxmox-dark border border-proxmox-border rounded-lg hover:border-proxmox-orange/50 transition-colors text-gray-400 hover:text-white"
                                            title={t('pegaproxSettings')}
                                        >
                                            <Icons.Settings />
                                        </button>
                                    )}
                                    
                                    {/* Live Status Indicator */}
                                    <div className="flex items-center gap-2 px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg" title={wsConnected ? 'Live-Updates aktiv' : 'Polling-Modus'}>
                                        <div className={`w-2 h-2 rounded-full ${wsConnected ? 'bg-green-500 animate-pulse' : 'bg-yellow-500'}`}></div>
                                        <span className="text-xs text-gray-400 hidden sm:inline">{wsConnected ? 'Live' : 'Polling'}</span>
                                    </div>
                                    
                                    {isAdmin && (
                                        <button
                                            onClick={() => setShowAddModal(true)}
                                            className="flex items-center gap-2 px-4 py-2.5 bg-proxmox-orange hover:bg-orange-600 rounded-lg font-medium transition-all hover:shadow-lg hover:shadow-proxmox-orange/25"
                                        >
                                            <Icons.Plus />
                                            <span>{t('addCluster')}</span>
                                        </button>
                                    )}
                                    
                                    {/* Task Bar Toggle - disabled for debugging */}
                                    {false && !showTaskBar && tasks.length > 0 && (
                                        <button
                                            onClick={() => setShowTaskBar(true)}
                                            className="relative flex items-center gap-2 px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg hover:border-proxmox-orange/50 transition-colors"
                                            title={t('tasks')}
                                        >
                                            <Icons.Layers />
                                            {tasks.filter(task => task && task.status === 'running').length > 0 && (
                                                <span className="absolute -top-1 -right-1 w-4 h-4 bg-blue-500 rounded-full text-xs flex items-center justify-center animate-pulse">
                                                    {tasks.filter(task => task && task.status === 'running').length}
                                                </span>
                                            )}
                                            {tasks.filter(task => task && (task.status === 'failed' || task.status === 'error')).length > 0 && (
                                                <span className="absolute -top-1 -right-1 w-4 h-4 bg-red-500 rounded-full text-xs flex items-center justify-center">
                                                    {tasks.filter(task => task && (task.status === 'failed' || task.status === 'error')).length}
                                                </span>
                                            )}
                                        </button>
                                    )}
                                    
                                    {/* User Menu */}
                                    <div className="relative z-50">
                                        <button
                                            onClick={() => setShowUserMenu(!showUserMenu)}
                                            className="flex items-center gap-2 px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg hover:border-proxmox-orange/50 transition-colors"
                                        >
                                            <div className="w-8 h-8 rounded-full bg-proxmox-orange/20 flex items-center justify-center text-proxmox-orange font-semibold">
                                                {user?.username?.[0]?.toUpperCase() || 'U'}
                                            </div>
                                            <span className="text-sm text-gray-300 hidden sm:inline">{user?.display_name || user?.username}</span>
                                            <Icons.ChevronDown />
                                        </button>
                                        
                                        {showUserMenu && (
                                            <>
                                                <div className="fixed inset-0 z-40" onClick={() => setShowUserMenu(false)} />
                                                <div className="absolute right-0 top-full mt-2 w-56 bg-proxmox-card border border-proxmox-border rounded-xl shadow-xl z-50 overflow-hidden">
                                                    <div className="p-3 border-b border-proxmox-border">
                                                        <p className="font-medium text-white">{user?.display_name || user?.username}</p>
                                                        <p className="text-xs text-gray-400">{user?.role === 'admin' ? t('roleAdmin') : user?.role === 'user' ? t('roleUser') : t('roleViewer')}</p>
                                                    </div>
                                                    <div className="py-1">
                                                        <button
                                                            onClick={() => {
                                                                setShowUserMenu(false);
                                                                setShowProfile(true);
                                                            }}
                                                            className="w-full px-4 py-2 text-left text-gray-300 hover:bg-proxmox-hover transition-colors flex items-center gap-2"
                                                        >
                                                            <Icons.User />
                                                            {t('myProfile')}
                                                        </button>
                                                        {isAdmin && (
                                                            <button
                                                                onClick={() => {
                                                                    setShowUserMenu(false);
                                                                    setShowSettings(true);
                                                                }}
                                                                className="w-full px-4 py-2 text-left text-gray-300 hover:bg-proxmox-hover transition-colors flex items-center gap-2"
                                                            >
                                                                <Icons.Settings />
                                                                {t('pegaproxSettings')}
                                                            </button>
                                                        )}
                                                        <button
                                                            onClick={() => {
                                                                setShowUserMenu(false);
                                                                logout();
                                                            }}
                                                            className="w-full px-4 py-2 text-left text-red-400 hover:bg-red-500/10 transition-colors flex items-center gap-2"
                                                        >
                                                            <Icons.LogOut />
                                                            {t('logout')}
                                                        </button>
                                                    </div>
                                                </div>
                                            </>
                                        )}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </header>

                    <div className="relative max-w-[1600px] mx-auto px-6 py-6">
                        <div className="flex gap-6">
                            {/* Sidebar - Cluster List with Groups */}
                            <div className="w-72 flex-shrink-0">
                                <div className="sticky top-6 space-y-4">
                                    {/* Header with Group Management */}
                                    <div className="flex items-center justify-between px-1">
                                        <h2 className="text-sm font-semibold text-gray-400 uppercase tracking-wider">{t('clusters')}</h2>
                                        {isAdmin && (
                                            <button
                                                onClick={() => setShowGroupManager(true)}
                                                className="p-1 text-gray-500 hover:text-proxmox-orange rounded transition-colors"
                                                title={t('manageGroups') || 'Manage Groups'}
                                            >
                                                <Icons.FolderPlus className="w-4 h-4" />
                                            </button>
                                        )}
                                    </div>
                                    
                                    {clusters.length === 0 ? (
                                        <div className="bg-proxmox-card border border-proxmox-border rounded-xl p-6 text-center">
                                            <div className="w-12 h-12 mx-auto mb-3 rounded-full bg-proxmox-dark flex items-center justify-center">
                                                <Icons.Server />
                                            </div>
                                            <p className="text-gray-400 text-sm">{t('noClusterSelected')}</p>
                                            <button
                                                onClick={() => setShowAddModal(true)}
                                                className="mt-3 text-proxmox-orange text-sm hover:underline"
                                            >
                                                {t('addFirstCluster')}
                                            </button>
                                        </div>
                                    ) : (
                                        <div className="space-y-3">
                                            {/* MK: overview button */}
                                            <button
                                                onClick={() => setSelectedCluster(null)}
                                                className={`w-full flex items-center gap-3 px-3 py-2.5 rounded-xl transition-all ${
                                                    !selectedCluster 
                                                        ? 'bg-gradient-to-r from-proxmox-orange/20 to-orange-600/10 border border-proxmox-orange/30 text-white' 
                                                        : 'bg-proxmox-card border border-proxmox-border hover:border-proxmox-orange/30 text-gray-300 hover:text-white'
                                                }`}
                                            >
                                                <div className={`w-8 h-8 rounded-lg flex items-center justify-center ${
                                                    !selectedCluster ? 'bg-proxmox-orange/20' : 'bg-proxmox-dark'
                                                }`}>
                                                    <Icons.Grid className="w-4 h-4" />
                                                </div>
                                                <div className="flex-1 text-left">
                                                    <div className="text-sm font-medium">{t('allClusters') || 'All Clusters'}</div>
                                                    <div className="text-xs text-gray-500">{clusters.length} {t('clusters').toLowerCase()}</div>
                                                </div>
                                                {!selectedCluster && (
                                                    <div className="w-2 h-2 rounded-full bg-proxmox-orange" />
                                                )}
                                            </button>
                                            
                                            {/* Grouped Clusters */}
                                            {clusterGroups.map(group => {
                                                const groupClusters = clusters.filter(c => c.group_id === group.id);
                                                if (groupClusters.length === 0) return null;
                                                
                                                const isCollapsed = collapsedGroups[group.id];
                                                
                                                return (
                                                    <div key={group.id} className="space-y-2">
                                                        {/* Group Header */}
                                                        <button
                                                            onClick={() => setCollapsedGroups(prev => ({...prev, [group.id]: !prev[group.id]}))}
                                                            className="w-full flex items-center gap-2 px-2 py-1.5 rounded-lg hover:bg-proxmox-hover transition-colors group"
                                                        >
                                                            <div className="w-4 h-4 flex items-center justify-center text-gray-500">
                                                                {isCollapsed ? <Icons.ChevronRight className="w-3 h-3" /> : <Icons.ChevronDown className="w-3 h-3" />}
                                                            </div>
                                                            <Icons.Folder className="w-4 h-4" style={{ color: group.color || '#E86F2D' }} />
                                                            <span className="text-sm text-gray-300 flex-1 text-left">{group.name}</span>
                                                            <span className="text-xs text-gray-500">{groupClusters.length}</span>
                                                        </button>
                                                        
                                                        {/* Group Clusters */}
                                                        {!isCollapsed && (
                                                            <div className="ml-4 space-y-2">
                                                                {groupClusters.map((cluster, idx) => (
                                                                    <ClusterSidebarItem 
                                                                        key={cluster.id}
                                                                        cluster={cluster}
                                                                        idx={idx}
                                                                        selectedCluster={selectedCluster}
                                                                        setSelectedCluster={setSelectedCluster}
                                                                        nodeAlerts={nodeAlerts}
                                                                        clusterGroups={clusterGroups}
                                                                        isAdmin={isAdmin}
                                                                        handleDeleteCluster={handleDeleteCluster}
                                                                        setShowAssignGroup={setShowAssignGroup}
                                                                        t={t}
                                                                        getAuthHeaders={getAuthHeaders}
                                                                        fetchClusters={fetchClusters}
                                                                        addToast={addToast}
                                                                    />
                                                                ))}
                                                            </div>
                                                        )}
                                                    </div>
                                                );
                                            })}
                                            
                                            {/* Ungrouped Clusters */}
                                            {(() => {
                                                const ungroupedClusters = clusters.filter(c => !c.group_id || !clusterGroups.find(g => g.id === c.group_id));
                                                if (ungroupedClusters.length === 0) return null;
                                                
                                                return (
                                                    <div className="space-y-2">
                                                        {clusterGroups.length > 0 && (
                                                            <div className="flex items-center gap-2 px-2 py-1.5 text-gray-500">
                                                                <Icons.Server className="w-4 h-4" />
                                                                <span className="text-xs uppercase tracking-wider">{t('ungrouped')}</span>
                                                            </div>
                                                        )}
                                                        {ungroupedClusters.map((cluster, idx) => (
                                                            <ClusterSidebarItem 
                                                                key={cluster.id}
                                                                cluster={cluster}
                                                                idx={idx}
                                                                selectedCluster={selectedCluster}
                                                                setSelectedCluster={setSelectedCluster}
                                                                nodeAlerts={nodeAlerts}
                                                                clusterGroups={clusterGroups}
                                                                isAdmin={isAdmin}
                                                                handleDeleteCluster={handleDeleteCluster}
                                                                setShowAssignGroup={setShowAssignGroup}
                                                                t={t}
                                                                getAuthHeaders={getAuthHeaders}
                                                                fetchClusters={fetchClusters}
                                                                addToast={addToast}
                                                            />
                                                        ))}
                                                    </div>
                                                );
                                            })()}
                                        </div>
                                    )}
                                </div>
                            </div>

                            {/* Main Content */}
                            <div className="flex-1 min-w-0">
                                {selectedCluster ? (
                                    <div className="space-y-6">
                                        {/* Tabs */}
                                        <div className="flex items-center gap-1 p-1 bg-proxmox-card border border-proxmox-border rounded-xl w-fit flex-wrap">
                                            {[
                                                { id: 'overview', labelKey: 'overview', icon: Icons.Activity },
                                                { id: 'resources', labelKey: 'resources', icon: Icons.Server },
                                                { id: 'datacenter', labelKey: 'datacenter', icon: Icons.HardDrive },
                                                { id: 'datastore', labelKey: 'datastore', icon: Icons.Database },
                                                { id: 'automation', labelKey: 'automation', icon: Icons.Zap },
                                                { id: 'reports', labelKey: 'reports', icon: Icons.BarChart },
                                                { id: 'settings', labelKey: 'settings', icon: Icons.Settings },
                                            ].map(tab => (
                                                <button
                                                    key={tab.id}
                                                    onClick={() => setActiveTab(tab.id)}
                                                    className={`flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium transition-all ${
                                                        activeTab === tab.id
                                                            ? 'bg-proxmox-orange text-white'
                                                            : 'text-gray-400 hover:text-white hover:bg-proxmox-hover'
                                                    }`}
                                                >
                                                    <tab.icon />
                                                    {t(tab.labelKey)}
                                                </button>
                                            ))}
                                        </div>

                                        {/* Overview Tab */}
                                        {activeTab === 'overview' && (
                                            <div className="grid grid-cols-1 xl:grid-cols-3 gap-6">
                                                <div className="xl:col-span-2 space-y-6">
                                                    {/* Node Grid */}
                                                    <div>
                                                        <h2 className="text-sm font-semibold text-gray-400 uppercase tracking-wider mb-4">{t('nodes')}</h2>
                                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                            {/* Online nodes from metrics */}
                                                            {Object.entries(clusterMetrics)
                                                                .sort(([a], [b]) => a.localeCompare(b))
                                                                .map(([node, metrics], idx) => (
                                                                <NodeCard 
                                                                    key={node} 
                                                                    name={node} 
                                                                    metrics={metrics} 
                                                                    index={idx} 
                                                                    clusterId={selectedCluster.id}
                                                                    onMaintenanceToggle={handleMaintenanceToggle}
                                                                    onStartUpdate={handleStartUpdate}
                                                                    onOpenNodeConfig={(nodeName) => setConfigNode(nodeName)}
                                                                    onNodeAction={handleNodeAction}
                                                                />
                                                            ))}
                                                            {/* Offline nodes from knownNodes */}
                                                            {Object.entries(knownNodes)
                                                                .filter(([nodeName, nodeData]) => nodeData.status === 'offline' && !clusterMetrics[nodeName])
                                                                .map(([nodeName, nodeData], idx) => (
                                                                <div 
                                                                    key={`offline-${nodeName}`}
                                                                    className="relative bg-proxmox-card border-2 border-red-500/50 rounded-xl p-4"
                                                                >
                                                                    <div className="absolute top-2 right-2">
                                                                        <span className="px-2 py-1 bg-red-500 text-white text-xs font-bold rounded animate-pulse">
                                                                            OFFLINE
                                                                        </span>
                                                                    </div>
                                                                    <div className="flex items-center gap-3 mb-4">
                                                                        <div className="p-2 bg-red-500/20 rounded-lg">
                                                                            <Icons.Server className="text-red-400" />
                                                                        </div>
                                                                        <div>
                                                                            <h3 className="font-semibold text-white">{nodeName}</h3>
                                                                            <p className="text-xs text-red-400">{t('nodeUnreachable') || 'Node unreachable'}</p>
                                                                        </div>
                                                                    </div>
                                                                    <div className="space-y-3 opacity-50">
                                                                        <div>
                                                                            <div className="flex justify-between text-xs mb-1">
                                                                                <span className="text-gray-500">CPU</span>
                                                                                <span className="text-gray-500">--</span>
                                                                            </div>
                                                                            <div className="h-2 bg-proxmox-dark rounded-full" />
                                                                        </div>
                                                                        <div>
                                                                            <div className="flex justify-between text-xs mb-1">
                                                                                <span className="text-gray-500">RAM</span>
                                                                                <span className="text-gray-500">--</span>
                                                                            </div>
                                                                            <div className="h-2 bg-proxmox-dark rounded-full" />
                                                                        </div>
                                                                    </div>
                                                                    <div className="mt-4 pt-3 border-t border-red-500/30 text-xs text-red-400">
                                                                        <Icons.AlertTriangle className="inline w-3 h-3 mr-1" />
                                                                        {t('offlineSince') || 'Offline since'}: {nodeData.offlineSince ? new Date(nodeData.offlineSince).toLocaleTimeString() : 'Unknown'}
                                                                    </div>
                                                                    <div className="text-xs text-gray-500 mt-2">
                                                                        {t('lastSeen') || 'Last seen'}: {nodeData.lastSeen ? new Date(nodeData.lastSeen).toLocaleString() : 'Unknown'}
                                                                    </div>
                                                                </div>
                                                            ))}
                                                            {/* Also show nodes from nodeAlerts (SSE events) - filter by cluster */}
                                                            {Object.entries(nodeAlerts)
                                                                .filter(([nodeName, alert]) => 
                                                                    alert.cluster_id === selectedCluster.id && 
                                                                    !clusterMetrics[nodeName] && 
                                                                    !knownNodes[nodeName]?.status
                                                                )
                                                                .map(([nodeName, alert], idx) => (
                                                                <div 
                                                                    key={`alert-${nodeName}`}
                                                                    className="relative bg-proxmox-card border-2 border-red-500/50 rounded-xl p-4 animate-pulse"
                                                                >
                                                                    <div className="absolute top-2 right-2">
                                                                        <span className="px-2 py-1 bg-red-500 text-white text-xs font-bold rounded animate-pulse">
                                                                            OFFLINE
                                                                        </span>
                                                                    </div>
                                                                    <div className="flex items-center gap-3 mb-4">
                                                                        <div className="p-2 bg-red-500/20 rounded-lg">
                                                                            <Icons.Server className="text-red-400" />
                                                                        </div>
                                                                        <div>
                                                                            <h3 className="font-semibold text-white">{nodeName}</h3>
                                                                            <p className="text-xs text-red-400">{t('nodeUnreachable') || 'Node unreachable'}</p>
                                                                        </div>
                                                                    </div>
                                                                    <div className="space-y-3 opacity-50">
                                                                        <div>
                                                                            <div className="flex justify-between text-xs mb-1">
                                                                                <span className="text-gray-500">CPU</span>
                                                                                <span className="text-gray-500">--</span>
                                                                            </div>
                                                                            <div className="h-2 bg-proxmox-dark rounded-full" />
                                                                        </div>
                                                                        <div>
                                                                            <div className="flex justify-between text-xs mb-1">
                                                                                <span className="text-gray-500">RAM</span>
                                                                                <span className="text-gray-500">--</span>
                                                                            </div>
                                                                            <div className="h-2 bg-proxmox-dark rounded-full" />
                                                                        </div>
                                                                    </div>
                                                                    <div className="mt-4 pt-3 border-t border-red-500/30 text-xs text-red-400">
                                                                        <Icons.AlertTriangle className="inline w-3 h-3 mr-1" />
                                                                        {t('offlineSince') || 'Offline since'}: {new Date(alert.timestamp).toLocaleTimeString()}
                                                                    </div>
                                                                </div>
                                                            ))}
                                                        </div>
                                                        {Object.keys(clusterMetrics).length === 0 && Object.keys(nodeAlerts).length === 0 && (
                                                            <div className="bg-proxmox-card border border-proxmox-border rounded-xl p-8 text-center">
                                                                {connectionError ? (
                                                                    <div className="text-red-400">
                                                                        <Icons.AlertTriangle className="mx-auto mb-2" />
                                                                        <p className="font-medium">{t('connectionError') || 'Connection Error'}</p>
                                                                        <p className="text-sm text-gray-500 mt-1">{connectionError}</p>
                                                                        <button 
                                                                            onClick={() => { setConnectionError(null); fetchClusterMetrics(selectedCluster.id); }}
                                                                            className="mt-3 px-4 py-2 bg-proxmox-orange hover:bg-orange-600 rounded-lg text-sm text-white"
                                                                        >
                                                                            {t('retry') || 'Retry'}
                                                                        </button>
                                                                    </div>
                                                                ) : (
                                                                    <div>
                                                                        <Icons.RotateCw className="mx-auto mb-2 animate-spin text-gray-500" />
                                                                        <p className="text-gray-500">{t('loadingMetrics') || 'Loading metrics...'}</p>
                                                                    </div>
                                                                )}
                                                            </div>
                                                        )}
                                                    </div>
                                                </div>

                                                <div className="space-y-6">
                                                    {/* Cluster Health */}
                                                    <ClusterHealth metrics={clusterMetrics} />

                                                    {/* Migration History */}
                                                    <div className="bg-proxmox-card border border-proxmox-border rounded-xl p-5">
                                                        <h3 className="text-sm font-semibold text-gray-400 uppercase tracking-wider mb-4">
                                                            {t('lastMigrations')}
                                                        </h3>
                                                        <MigrationHistory logs={migrationLogs} />
                                                    </div>
                                                </div>
                                            </div>
                                        )}

                                        {/* Resources Tab */}
                                        {activeTab === 'resources' && (
                                            <div className="space-y-4">
                                                {/* Sub-Tab Navigation */}
                                                <div className="flex items-center gap-1 border-b border-proxmox-border pb-2">
                                                    <button
                                                        onClick={() => setResourcesSubTab('management')}
                                                        className={`flex items-center gap-2 px-4 py-2 rounded-lg text-sm transition-colors ${
                                                            resourcesSubTab === 'management'
                                                                ? 'bg-proxmox-orange text-white'
                                                                : 'text-gray-400 hover:text-white hover:bg-proxmox-hover'
                                                        }`}
                                                    >
                                                        <Icons.Server className="w-4 h-4" />
                                                        {t('resourcesLabel') || 'Resources'}
                                                    </button>
                                                    <button
                                                        onClick={() => { setResourcesSubTab('snapshots'); fetchGlobalSnapshots(selectedCluster.id); }}
                                                        className={`flex items-center gap-2 px-4 py-2 rounded-lg text-sm transition-colors ${
                                                            resourcesSubTab === 'snapshots'
                                                                ? 'bg-proxmox-orange text-white'
                                                                : 'text-gray-400 hover:text-white hover:bg-proxmox-hover'
                                                        }`}
                                                    >
                                                        <Icons.Camera className="w-4 h-4" />
                                                        {t('snapshotsOverview') || 'Snapshot Overview'}
                                                    </button>
                                                </div>
                                                
                                                {/* Resources Management Sub-Tab */}
                                                {resourcesSubTab === 'management' && (
                                                    <div className="bg-proxmox-card border border-proxmox-border rounded-xl p-6">
                                                        <ResourceTable 
                                                            resources={clusterResources} 
                                                            clusterId={selectedCluster.id}
                                                            clusters={clusters}
                                                            sourceCluster={selectedCluster}
                                                            onVmAction={handleVmAction}
                                                            onOpenConsole={handleOpenConsole}
                                                            onOpenConfig={handleOpenConfig}
                                                            onMigrate={handleMigrate}
                                                            onBulkMigrate={handleBulkMigrate}
                                                            onDelete={handleDeleteVm}
                                                            onClone={handleCloneVm}
                                                            onForceStop={handleForceStop}
                                                            onCrossClusterMigrate={handleCrossClusterMigrate}
                                                            nodes={Object.keys(clusterMetrics)}
                                                            onOpenTags={(resource) => {
                                                                loadVmTags(selectedCluster.id, resource.vmid);
                                                                loadClusterTags(selectedCluster.id);
                                                                setShowTagEditor({ 
                                                                    clusterId: selectedCluster.id, 
                                                                    vmid: resource.vmid, 
                                                                    vmName: resource.name || `VM ${resource.vmid}` 
                                                                });
                                                            }}
                                                            highlightedVm={highlightedVm}
                                                            addToast={addToast}
                                                        />
                                                        
                                                        {/* Create VM/CT Buttons */}
                                                        <div className="flex gap-3 mt-4">
                                                            <button
                                                                onClick={() => setShowCreateVm('qemu')}
                                                                className="flex items-center gap-2 px-4 py-2 bg-blue-600 rounded-lg text-white hover:bg-blue-700 transition-colors"
                                                            >
                                                                <Icons.Plus />
                                                                {t('createVm')}
                                                            </button>
                                                            <button
                                                                onClick={() => setShowCreateVm('lxc')}
                                                                className="flex items-center gap-2 px-4 py-2 bg-purple-600 rounded-lg text-white hover:bg-purple-700 transition-colors"
                                                            >
                                                                <Icons.Plus />
                                                                {t('createContainer')}
                                                            </button>
                                                        </div>
                                                    </div>
                                                )}
                                                
                                                {/* Snapshot Overview Sub-Tab @gyptazy */}
                                                {resourcesSubTab === 'snapshots' && (
                                                    <div className="bg-proxmox-card border border-proxmox-border rounded-xl p-6 space-y-4">
                                                        <div className="flex items-center justify-between">
                                                            <div>
                                                                <h3 className="text-lg font-semibold text-white">{t('snapshotsOverview') || 'Snapshot Overview'}</h3>
                                                                <p className="text-sm text-gray-400 mt-1">
                                                                    {t('snapshotsDesc') || 'Overview of the oldest snapshots in this cluster'}
                                                                </p>
                                                            </div>
                                                            <div className="flex items-center gap-2">
                                                                <input
                                                                    type="date"
                                                                    value={snapshotFilterDate}
                                                                    onChange={(e) => setSnapshotFilterDate(e.target.value)}
                                                                    className="rounded-lg bg-proxmox-dark border border-proxmox-border px-3 py-2 text-sm text-white focus:outline-none focus:ring-2 focus:ring-proxmox-orange"
                                                                />
                                                                <button
                                                                    onClick={() => applySnapshotFilter(selectedCluster.id)}
                                                                    disabled={!snapshotFilterDate}
                                                                    className="rounded-lg bg-proxmox-orange px-4 py-2 text-sm font-medium text-white hover:bg-proxmox-orange/90 disabled:opacity-50 disabled:cursor-not-allowed"
                                                                >
                                                                    {t('filter') || 'Filter'}
                                                                </button>
                                                                <button
                                                                    onClick={() => fetchGlobalSnapshots(selectedCluster.id)}
                                                                    className="p-2 rounded-lg bg-proxmox-dark border border-proxmox-border text-gray-400 hover:text-white"
                                                                    title="Refresh"
                                                                >
                                                                    <Icons.RotateCw className="w-4 h-4" />
                                                                </button>
                                                            </div>
                                                        </div>

                                                        {!Array.isArray(sortedSnapshots) || sortedSnapshots.length === 0 ? (
                                                            <div className="bg-proxmox-dark rounded-xl p-8 text-center">
                                                                <Icons.Camera className="mx-auto mb-3 w-10 h-10 text-gray-600" />
                                                                <p className="text-gray-500">
                                                                    {t('noSnapshots') || 'No snapshots found'}
                                                                </p>
                                                                <p className="text-xs text-gray-600 mt-2">
                                                                    {t('snapshotsHint') || 'Create snapshots on VMs to see them listed here'}
                                                                </p>
                                                            </div>
                                                        ) : (
                                                            <div className="overflow-x-auto bg-proxmox-dark rounded-xl border border-gray-800">
                                                                <table className="min-w-full text-sm">
                                                                    <thead className="bg-black/40 text-gray-400">
                                                                        <tr>
                                                                            <th 
                                                                                className="px-4 py-3 text-left cursor-pointer hover:text-white"
                                                                                onClick={() => toggleSnapshotSort('vmid')}
                                                                            >
                                                                                VM ID {snapshotSortBy === 'vmid' && (snapshotSortDir === 'asc' ? '‚Üë' : '‚Üì')}
                                                                            </th>
                                                                            <th 
                                                                                className="px-4 py-3 text-left cursor-pointer hover:text-white"
                                                                                onClick={() => toggleSnapshotSort('vm_name')}
                                                                            >
                                                                                VM Name {snapshotSortBy === 'vm_name' && (snapshotSortDir === 'asc' ? '‚Üë' : '‚Üì')}
                                                                            </th>
                                                                            <th 
                                                                                className="px-4 py-3 text-left cursor-pointer hover:text-white"
                                                                                onClick={() => toggleSnapshotSort('vm_type')}
                                                                            >
                                                                                {t('snapshotsType') || 'Type'} {snapshotSortBy === 'vm_type' && (snapshotSortDir === 'asc' ? '‚Üë' : '‚Üì')}
                                                                            </th>
                                                                            <th 
                                                                                className="px-4 py-3 text-left cursor-pointer hover:text-white"
                                                                                onClick={() => toggleSnapshotSort('node')}
                                                                            >
                                                                                Node {snapshotSortBy === 'node' && (snapshotSortDir === 'asc' ? '‚Üë' : '‚Üì')}
                                                                            </th>
                                                                            <th 
                                                                                className="px-4 py-3 text-left cursor-pointer hover:text-white"
                                                                                onClick={() => toggleSnapshotSort('snapshot_name')}
                                                                            >
                                                                                Snapshot {snapshotSortBy === 'snapshot_name' && (snapshotSortDir === 'asc' ? '‚Üë' : '‚Üì')}
                                                                            </th>
                                                                            <th 
                                                                                className="px-4 py-3 text-left cursor-pointer hover:text-white"
                                                                                onClick={() => toggleSnapshotSort('snapshot_date')}
                                                                            >
                                                                                {t('snapshotsDate') || 'Created'} {snapshotSortBy === 'snapshot_date' && (snapshotSortDir === 'asc' ? '‚Üë' : '‚Üì')}
                                                                            </th>
                                                                            <th 
                                                                                className="px-4 py-3 text-left cursor-pointer hover:text-white"
                                                                                onClick={() => toggleSnapshotSort('age')}
                                                                            >
                                                                                {t('snapshotsAge') || 'Age'} {snapshotSortBy === 'age' && (snapshotSortDir === 'asc' ? '‚Üë' : '‚Üì')}
                                                                            </th>
                                                                            <th className="px-4 py-3 text-right w-12">{t('snapshotsAction') || 'Action'}</th>
                                                                        </tr>
                                                                    </thead>
                                                                    <tbody className="divide-y divide-gray-800">
                                                                        {sortedSnapshots.map((snap, idx) => (
                                                                            <tr
                                                                                key={`${snap.vmid}-${snap.snapshot_name}-${idx}`}
                                                                                className="group hover:bg-white/5 transition-colors"
                                                                            >
                                                                                <td className="px-4 py-3 text-gray-300">{snap.vmid ?? '-'}</td>
                                                                                <td className="px-4 py-3 text-gray-200">{snap.vm_name ?? '-'}</td>
                                                                                <td className="px-4 py-3">
                                                                                    <span className={`px-2 py-1 rounded text-xs ${snap.vm_type === 'qemu' ? 'bg-blue-500/20 text-blue-400' : 'bg-purple-500/20 text-purple-400'}`}>
                                                                                        {snap.vm_type === 'qemu' ? 'VM' : 'CT'}
                                                                                    </span>
                                                                                </td>
                                                                                <td className="px-4 py-3 text-gray-300">{snap.node ?? '-'}</td>
                                                                                <td className="px-4 py-3 font-mono text-gray-200">{snap.snapshot_name ?? '-'}</td>
                                                                                <td className="px-4 py-3 text-gray-300">{snap.snapshot_date ?? '-'}</td>
                                                                                <td className="px-4 py-3 text-yellow-400">{snap.age ?? '-'}</td>
                                                                                <td className="px-4 py-3 text-right">
                                                                                    <button
                                                                                        onClick={() => deleteGlobalSnapshot(snap, selectedCluster.id)}
                                                                                        className="opacity-0 group-hover:opacity-100 transition text-red-500 hover:text-red-400"
                                                                                        title="Delete snapshot"
                                                                                    >
                                                                                        <Icons.Trash className="w-4 h-4" />
                                                                                    </button>
                                                                                </td>
                                                                            </tr>
                                                                        ))}
                                                                    </tbody>
                                                                </table>
                                                            </div>
                                                        )}
                                                    </div>
                                                )}
                                            </div>
                                        )}

                                        {/* Datacenter Tab */}
                                        {activeTab === 'datacenter' && (
                                            <DatacenterTab clusterId={selectedCluster.id} addToast={addToast} />
                                        )}

                                        {/* Datastore Tab */}
                                        {activeTab === 'datastore' && (
                                            <DatastoreTab clusterId={selectedCluster.id} addToast={addToast} />
                                        )}

                                        {/* Automation Tab - NS Jan 2026 - Combines Schedules, Tags, Alerts, Affinity, Scripts */}
                                        {activeTab === 'automation' && (
                                            <div className="space-y-6">
                                                {/* Sub-Tab Navigation */}
                                                <div className="flex items-center gap-1 border-b border-proxmox-border pb-2">
                                                    {[
                                                        { id: 'schedules', label: t('scheduledActions') || 'Schedules', icon: Icons.Clock },
                                                        { id: 'tags', label: t('tagsLabels') || 'Tags', icon: Icons.Tag },
                                                        { id: 'alerts', label: t('alerts') || 'Alerts', icon: Icons.Bell },
                                                        { id: 'affinity', label: t('affinityRules') || 'Affinity', icon: Icons.Link },
                                                        { id: 'scripts', label: t('customScripts') || 'Scripts', icon: Icons.Terminal }
                                                    ].map(sub => (
                                                        <button
                                                            key={sub.id}
                                                            onClick={() => setAutomationSubTab(sub.id)}
                                                            className={`flex items-center gap-2 px-4 py-2 rounded-lg text-sm transition-colors ${
                                                                automationSubTab === sub.id
                                                                    ? 'bg-proxmox-orange text-white'
                                                                    : 'text-gray-400 hover:text-white hover:bg-proxmox-hover'
                                                            }`}
                                                        >
                                                            <sub.icon className="w-4 h-4" />
                                                            {sub.label}
                                                        </button>
                                                    ))}
                                                </div>
                                                
                                                {/* Schedules Sub-Tab */}
                                                {automationSubTab === 'schedules' && (
                                                    <div className="space-y-4">
                                                        <div className="flex justify-between items-center">
                                                            <p className="text-sm text-gray-400">{t('schedulesDesc') || 'Automatically start, stop, reboot or snapshot VMs on a schedule'}</p>
                                                            <button
                                                                onClick={() => { setEditingSchedule(null); setShowScheduleModal(true); }}
                                                                className="flex items-center gap-2 px-4 py-2 bg-proxmox-orange hover:bg-orange-600 rounded-lg text-sm"
                                                            >
                                                                <Icons.Plus /> {t('newSchedule') || 'New Schedule'}
                                                            </button>
                                                        </div>
                                                        
                                                        {schedules.filter(s => s.cluster_id === selectedCluster?.id).length === 0 ? (
                                                            <div className="bg-proxmox-dark rounded-xl p-8 text-center">
                                                                <Icons.Clock className="mx-auto mb-3 w-10 h-10 text-gray-600" />
                                                                <p className="text-gray-500">{t('noSchedules') || 'No scheduled actions for this cluster'}</p>
                                                            </div>
                                                        ) : (
                                                            <div className="bg-proxmox-card border border-proxmox-border rounded-xl overflow-hidden">
                                                                <table className="w-full">
                                                                    <thead className="bg-proxmox-dark">
                                                                        <tr className="text-left text-xs text-gray-500 uppercase">
                                                                            <th className="p-3">{t('status') || 'Status'}</th>
                                                                            <th className="p-3">{t('name') || 'Name'}</th>
                                                                            <th className="p-3">VM</th>
                                                                            <th className="p-3">{t('action') || 'Action'}</th>
                                                                            <th className="p-3">{t('schedule') || 'Schedule'}</th>
                                                                            <th className="p-3">{t('lastRun') || 'Last Run'}</th>
                                                                            <th className="p-3 w-16"></th>
                                                                        </tr>
                                                                    </thead>
                                                                    <tbody className="divide-y divide-proxmox-border">
                                                                        {schedules.filter(s => s.cluster_id === selectedCluster?.id).map(schedule => (
                                                                            <tr key={schedule.id} className="hover:bg-proxmox-hover">
                                                                                <td className="p-3">
                                                                                    <button
                                                                                        onClick={() => toggleScheduleEnabled(schedule.id, !schedule.enabled)}
                                                                                        className={`w-9 h-5 rounded-full relative transition-colors ${schedule.enabled ? 'bg-green-500' : 'bg-gray-600'}`}
                                                                                    >
                                                                                        <span className={`absolute top-0.5 w-4 h-4 bg-white rounded-full transition-transform ${schedule.enabled ? 'left-4' : 'left-0.5'}`} />
                                                                                    </button>
                                                                                </td>
                                                                                <td className="p-3 font-medium">{schedule.name}</td>
                                                                                <td className="p-3 text-sm">{schedule.vm_type === 'lxc' ? 'üì¶' : 'üñ•Ô∏è'} {schedule.vmid}</td>
                                                                                <td className="p-3">
                                                                                    <span className={`px-2 py-1 rounded text-xs ${
                                                                                        schedule.action === 'start' ? 'bg-green-500/20 text-green-400' :
                                                                                        schedule.action === 'stop' ? 'bg-red-500/20 text-red-400' :
                                                                                        schedule.action === 'snapshot' ? 'bg-blue-500/20 text-blue-400' :
                                                                                        'bg-yellow-500/20 text-yellow-400'
                                                                                    }`}>{schedule.action}</span>
                                                                                </td>
                                                                                <td className="p-3 text-sm text-gray-400">
                                                                                    {schedule.time} ‚Ä¢ {schedule.schedule_type === 'daily' ? t('daily') || 'Daily' :
                                                                                     schedule.schedule_type === 'weekdays' ? t('weekdays') || 'Weekdays' :
                                                                                     schedule.schedule_type === 'weekends' ? t('weekends') || 'Weekends' :
                                                                                     schedule.schedule_type === 'weekly' ? (schedule.days || []).join(', ') :
                                                                                     schedule.date}
                                                                                </td>
                                                                                <td className="p-3 text-xs text-gray-500">
                                                                                    {schedule.last_run || '-'}
                                                                                    {schedule.run_count > 0 && ` (${schedule.run_count}x)`}
                                                                                </td>
                                                                                <td className="p-3">
                                                                                    <button onClick={() => deleteSchedule(schedule.id)} className="p-1 hover:bg-red-500/20 rounded text-gray-500 hover:text-red-400">
                                                                                        <Icons.Trash className="w-4 h-4" />
                                                                                    </button>
                                                                                </td>
                                                                            </tr>
                                                                        ))}
                                                                    </tbody>
                                                                </table>
                                                            </div>
                                                        )}
                                                    </div>
                                                )}
                                                
                                                {/* Tags Sub-Tab */}
                                                {automationSubTab === 'tags' && (
                                                    <div className="space-y-4">
                                                        <p className="text-sm text-gray-400">{t('tagsDesc') || 'Organize VMs with tags. Click the tag icon on any VM to add tags.'}</p>
                                                        
                                                        {clusterTags.length === 0 ? (
                                                            <div className="bg-proxmox-dark rounded-xl p-8 text-center">
                                                                <Icons.Tag className="mx-auto mb-3 w-10 h-10 text-gray-600" />
                                                                <p className="text-gray-500">{t('noTagsInCluster') || 'No tags in this cluster yet'}</p>
                                                                <p className="text-xs text-gray-600 mt-2">{t('addTagHint') || 'Use the tag button on VMs in the Resources tab'}</p>
                                                            </div>
                                                        ) : (
                                                            <div className="space-y-4">
                                                                <div className="flex flex-wrap gap-2">
                                                                    {clusterTags.map((tag, idx) => (
                                                                        <span
                                                                            key={idx}
                                                                            className="flex items-center gap-2 px-3 py-1.5 rounded-full border"
                                                                            style={{ backgroundColor: (tag.color || '#6b7280') + '20', borderColor: tag.color || '#6b7280', color: tag.color || '#9ca3af' }}
                                                                        >
                                                                            {tag.name}
                                                                            <span className="text-xs opacity-60">({tag.count || 0})</span>
                                                                        </span>
                                                                    ))}
                                                                </div>
                                                                <div className="text-xs text-gray-500">
                                                                    {clusterTags.length} {t('tagsTotal') || 'tags'} ‚Ä¢ {t('clickVmTag') || 'Click tag icon on VMs to manage'}
                                                                </div>
                                                            </div>
                                                        )}
                                                    </div>
                                                )}
                                                
                                                {/* Alerts Sub-Tab */}
                                                {automationSubTab === 'alerts' && (
                                                    <div className="space-y-4">
                                                        <div className="flex justify-between items-center">
                                                            <p className="text-sm text-gray-400">{t('alertsDesc') || 'Get notified when resources exceed thresholds'}</p>
                                                            <button
                                                                onClick={() => setShowAlertModal(true)}
                                                                className="flex items-center gap-2 px-4 py-2 bg-proxmox-orange hover:bg-orange-600 rounded-lg text-sm"
                                                            >
                                                                <Icons.Plus /> {t('newAlert') || 'New Alert'}
                                                            </button>
                                                        </div>
                                                        
                                                        {clusterAlerts.length === 0 ? (
                                                            <div className="bg-proxmox-dark rounded-xl p-8 text-center">
                                                                <Icons.Bell className="mx-auto mb-3 w-10 h-10 text-gray-600" />
                                                                <p className="text-gray-500">{t('noAlertsCluster') || 'No alerts for this cluster'}</p>
                                                            </div>
                                                        ) : (
                                                            <div className="space-y-2">
                                                                {clusterAlerts.map(alert => (
                                                                    <div key={alert.id} className={`flex items-center justify-between p-3 rounded-lg border ${alert.enabled ? 'bg-proxmox-dark border-proxmox-border' : 'bg-proxmox-darker border-proxmox-darker opacity-60'}`}>
                                                                        <div className="flex items-center gap-3">
                                                                            <button
                                                                                onClick={() => toggleAlertEnabled(alert.id, !alert.enabled)}
                                                                                className={`w-9 h-5 rounded-full relative transition-colors ${alert.enabled ? 'bg-green-500' : 'bg-gray-600'}`}
                                                                            >
                                                                                <span className={`absolute top-0.5 w-4 h-4 bg-white rounded-full transition-transform ${alert.enabled ? 'left-4' : 'left-0.5'}`} />
                                                                            </button>
                                                                            <div>
                                                                                <div className="font-medium flex items-center gap-2">
                                                                                    {alert.name}
                                                                                    <span className={`px-1.5 py-0.5 text-xs rounded ${
                                                                                        alert.target_type === 'vm' ? 'bg-blue-500/20 text-blue-400' :
                                                                                        alert.target_type === 'node' ? 'bg-purple-500/20 text-purple-400' :
                                                                                        'bg-gray-500/20 text-gray-400'
                                                                                    }`}>
                                                                                        {alert.target_type === 'vm' ? `VM ${alert.target_id || ''}` :
                                                                                         alert.target_type === 'node' ? `Node ${alert.target_id || ''}` :
                                                                                         t('cluster') || 'Cluster'}
                                                                                    </span>
                                                                                </div>
                                                                                <div className="text-xs text-gray-500">
                                                                                    {alert.metric?.toUpperCase()} {alert.operator} {alert.threshold}%
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                        <button onClick={() => deleteClusterAlert(alert.id)} className="p-1.5 hover:bg-red-500/20 rounded text-gray-500 hover:text-red-400">
                                                                            <Icons.Trash className="w-4 h-4" />
                                                                        </button>
                                                                    </div>
                                                                ))}
                                                            </div>
                                                        )}
                                                    </div>
                                                )}
                                                
                                                {/* Affinity Sub-Tab */}
                                                {automationSubTab === 'affinity' && (
                                                    <div className="space-y-4">
                                                        <div className="flex justify-between items-center">
                                                            <p className="text-sm text-gray-400">{t('affinityDesc') || 'Keep VMs together or separate across nodes'}</p>
                                                            <button
                                                                onClick={() => setShowAffinityModal(true)}
                                                                className="flex items-center gap-2 px-4 py-2 bg-proxmox-orange hover:bg-orange-600 rounded-lg text-sm"
                                                            >
                                                                <Icons.Plus /> {t('newRule') || 'New Rule'}
                                                            </button>
                                                        </div>
                                                        
                                                        {clusterAffinityRules.length === 0 ? (
                                                            <div className="bg-proxmox-dark rounded-xl p-8 text-center">
                                                                <Icons.Link className="mx-auto mb-3 w-10 h-10 text-gray-600" />
                                                                <p className="text-gray-500">{t('noAffinityCluster') || 'No affinity rules for this cluster'}</p>
                                                            </div>
                                                        ) : (
                                                            <div className="space-y-2">
                                                                {clusterAffinityRules.map(rule => (
                                                                    <div key={rule.id} className="flex items-center justify-between p-3 bg-proxmox-dark rounded-lg border border-proxmox-border">
                                                                        <div className="flex items-center gap-3">
                                                                            <span className={`px-2 py-1 rounded text-xs ${rule.type === 'together' ? 'bg-green-500/20 text-green-400' : 'bg-red-500/20 text-red-400'}`}>
                                                                                {rule.type === 'together' ? t('together') || 'Together' : t('separate') || 'Separate'}
                                                                            </span>
                                                                            {rule.enforce && <span className="px-1.5 py-0.5 text-xs bg-yellow-500/20 text-yellow-400 rounded">{t('enforced') || 'Enforced'}</span>}
                                                                            <span className="text-sm text-gray-400">VMs: {(rule.vm_ids || []).join(', ')}</span>
                                                                        </div>
                                                                        <button onClick={() => deleteClusterAffinityRule(rule.id)} className="p-1.5 hover:bg-red-500/20 rounded text-gray-500 hover:text-red-400">
                                                                            <Icons.Trash className="w-4 h-4" />
                                                                        </button>
                                                                    </div>
                                                                ))}
                                                            </div>
                                                        )}
                                                    </div>
                                                )}
                                                
                                                {/* Custom Scripts Sub-Tab */}
                                                {automationSubTab === 'scripts' && (
                                                    <div className="space-y-4">
                                                        <div className="flex justify-between items-center">
                                                            <p className="text-sm text-gray-400">{t('scriptsDesc') || 'Run custom .sh or .py scripts on cluster nodes with permission control'}</p>
                                                            <div className="flex items-center gap-2">
                                                                <button
                                                                    onClick={() => loadCustomScripts(selectedCluster?.id)}
                                                                    className="flex items-center gap-1 px-3 py-2 bg-proxmox-dark hover:bg-proxmox-hover rounded-lg text-sm text-gray-400"
                                                                    title={t('refresh') || 'Refresh'}
                                                                >
                                                                    <Icons.RefreshCw className="w-4 h-4" />
                                                                </button>
                                                                <button
                                                                    onClick={() => { setEditingScript(null); setShowScriptModal(true); }}
                                                                    className="flex items-center gap-2 px-4 py-2 bg-proxmox-orange hover:bg-orange-600 rounded-lg text-sm"
                                                                >
                                                                    <Icons.Plus /> {t('newScript') || 'New Script'}
                                                                </button>
                                                            </div>
                                                        </div>
                                                        
                                                        {/* Scripts List */}
                                                        {(!customScripts || customScripts.length === 0) ? (
                                                            <div className="bg-proxmox-dark rounded-xl p-8 text-center">
                                                                <Icons.Terminal className="mx-auto mb-3 w-10 h-10 text-gray-600" />
                                                                <p className="text-gray-500">{t('noScripts') || 'No custom scripts configured'}</p>
                                                                <p className="text-xs text-gray-600 mt-2">{t('scriptsInfo') || 'Create scripts to automate tasks across your cluster nodes'}</p>
                                                            </div>
                                                        ) : (
                                                            <div className="space-y-3">
                                                                {customScripts.map(script => (
                                                                    <div key={script.id} className="bg-proxmox-card border border-proxmox-border rounded-xl p-4">
                                                                        <div className="flex items-center justify-between">
                                                                            <div className="flex items-center gap-3">
                                                                                <div className={`w-10 h-10 rounded-lg flex items-center justify-center ${
                                                                                    script.type === 'python' ? 'bg-blue-500/20 text-blue-400' : 'bg-green-500/20 text-green-400'
                                                                                }`}>
                                                                                    {script.type === 'python' ? 'üêç' : 'üìú'}
                                                                                </div>
                                                                                <div>
                                                                                    <h4 className="font-medium text-white">{script.name}</h4>
                                                                                    <p className="text-xs text-gray-500">
                                                                                        {script.type === 'python' ? 'Python' : 'Bash'} ‚Ä¢ {script.target_nodes === 'all' ? 'All Nodes' : script.target_nodes}
                                                                                        {script.created_by && <span className="ml-2">‚Ä¢ Created by {script.created_by}</span>}
                                                                                    </p>
                                                                                </div>
                                                                            </div>
                                                                            <div className="flex items-center gap-2">
                                                                                {/* Run Script - opens password confirmation */}
                                                                                <button
                                                                                    onClick={() => setShowScriptRunModal(script)}
                                                                                    className="p-2 rounded-lg bg-green-500/20 text-green-400 hover:bg-green-500/30"
                                                                                    title={t('runScript') || 'Run Script'}
                                                                                    disabled={!script.enabled}
                                                                                >
                                                                                    <Icons.Play className="w-4 h-4" />
                                                                                </button>
                                                                                {/* View Last Output */}
                                                                                {script.last_run && (
                                                                                    <button
                                                                                        onClick={async () => {
                                                                                            try {
                                                                                                const res = await authFetch(`${API_URL}/clusters/${selectedCluster.id}/scripts/${script.id}/output`);
                                                                                                if (res.ok) {
                                                                                                    const data = await res.json();
                                                                                                    setScriptOutput({ name: data.name, output: data.output, last_run: data.last_run, last_status: data.last_status });
                                                                                                }
                                                                                            } catch (e) {
                                                                                                addToast('Error loading output', 'error');
                                                                                            }
                                                                                        }}
                                                                                        className="p-2 rounded-lg bg-blue-500/20 text-blue-400 hover:bg-blue-500/30"
                                                                                        title={t('viewOutput') || 'View Last Output'}
                                                                                    >
                                                                                        <Icons.FileText className="w-4 h-4" />
                                                                                    </button>
                                                                                )}
                                                                                <button
                                                                                    onClick={() => { setEditingScript(script); setShowScriptModal(true); }}
                                                                                    className="p-2 rounded-lg bg-proxmox-dark text-gray-400 hover:bg-proxmox-hover hover:text-white"
                                                                                >
                                                                                    <Icons.Edit className="w-4 h-4" />
                                                                                </button>
                                                                                <button
                                                                                    onClick={async () => {
                                                                                        if (!confirm(t('confirmDeleteScript') || 'Delete this script? It will be permanently removed after 20 days.')) return;
                                                                                        try {
                                                                                            const res = await authFetch(`${API_URL}/clusters/${selectedCluster.id}/scripts/${script.id}`, { method: 'DELETE' });
                                                                                            if (res.ok) {
                                                                                                const result = await res.json();
                                                                                                addToast(result.message || t('scriptMarkedForDeletion') || 'Script marked for deletion (20 days)', 'success');
                                                                                                setCustomScripts(prev => prev.filter(s => s.id !== script.id));
                                                                                            }
                                                                                        } catch (e) {
                                                                                            addToast('Error deleting script', 'error');
                                                                                        }
                                                                                    }}
                                                                                    className="p-2 rounded-lg bg-red-500/20 text-red-400 hover:bg-red-500/30"
                                                                                >
                                                                                    <Icons.Trash className="w-4 h-4" />
                                                                                </button>
                                                                            </div>
                                                                        </div>
                                                                        {script.description && (
                                                                            <p className="text-sm text-gray-400 mt-2">{script.description}</p>
                                                                        )}
                                                                        {script.last_run && (
                                                                            <p className="text-xs text-gray-600 mt-2">
                                                                                Last run: {new Date(script.last_run).toLocaleString()} - 
                                                                                <span className={
                                                                                    script.last_status === 'success' ? 'text-green-400 ml-1' :
                                                                                    script.last_status === 'partial' ? 'text-yellow-400 ml-1' :
                                                                                    'text-red-400 ml-1'
                                                                                }>{script.last_status}</span>
                                                                            </p>
                                                                        )}
                                                                    </div>
                                                                ))}
                                                            </div>
                                                        )}
                                                        
                                                        {/* Permissions Info */}
                                                        <div className="bg-blue-500/10 border border-blue-500/30 rounded-xl p-4">
                                                            <div className="flex items-start gap-3">
                                                                <Icons.Shield className="text-blue-400 w-5 h-5 mt-0.5" />
                                                                <div>
                                                                    <h4 className="font-medium text-blue-300">{t('scriptPermissions') || 'Script Permissions'}</h4>
                                                                    <p className="text-sm text-gray-400 mt-1">
                                                                        {t('scriptPermissionsDesc') || 'Scripts require SSH access to nodes. Configure SSH key in cluster settings. Scripts run with the SSH user\'s permissions.'}
                                                                    </p>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                )}
                                            </div>
                                        )}

                                        {/* Reports Tab - NS Jan 2026 - Now cluster-based */}
                                        {activeTab === 'reports' && (
                                            <div className="space-y-6">
                                                <div className="flex justify-between items-center">
                                                    <h2 className="text-lg font-semibold flex items-center gap-2">
                                                        <Icons.BarChart />
                                                        {t('reportsAnalytics') || 'Reports & Analytics'}: {selectedCluster?.name}
                                                    </h2>
                                                    <div className="flex items-center gap-2">
                                                        {['hour', 'day', 'week'].map(p => (
                                                            <button
                                                                key={p}
                                                                onClick={() => setReportPeriod(p)}
                                                                className={`px-3 py-1.5 rounded-lg text-sm ${
                                                                    reportPeriod === p 
                                                                        ? 'bg-proxmox-orange text-white' 
                                                                        : 'bg-proxmox-dark text-gray-400 hover:text-white'
                                                                }`}
                                                            >
                                                                {p === 'hour' ? t('lastHour') || 'Last Hour' :
                                                                 p === 'day' ? t('last24h') || 'Last 24h' :
                                                                 t('lastWeek') || 'Last Week'}
                                                            </button>
                                                        ))}
                                                        <button
                                                            onClick={() => { loadReportSummary(reportPeriod); loadTopVms(); }}
                                                            className="p-2 hover:bg-proxmox-hover rounded-lg text-gray-400 hover:text-white"
                                                        >
                                                            <Icons.RotateCw className={reportLoading ? 'animate-spin' : ''} />
                                                        </button>
                                                    </div>
                                                </div>
                                                
                                                {reportLoading ? (
                                                    <div className="flex items-center justify-center py-12">
                                                        <Icons.RotateCw className="animate-spin w-8 h-8 text-gray-500" />
                                                    </div>
                                                ) : (
                                                    <div className="space-y-6">
                                                        {/* Live Metrics Row */}
                                                        <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                                            <div className="bg-proxmox-card border border-proxmox-border rounded-xl p-4 text-center">
                                                                <div className="text-3xl font-bold text-blue-400">{reportData?.cpu?.current || reportData?.live?.cpu_percent || 0}%</div>
                                                                <div className="text-sm text-gray-500">CPU</div>
                                                                {reportData?.data_points > 0 && (
                                                                    <div className="text-xs text-gray-600 mt-1">avg: {reportData?.cpu?.avg || 0}%</div>
                                                                )}
                                                            </div>
                                                            <div className="bg-proxmox-card border border-proxmox-border rounded-xl p-4 text-center">
                                                                <div className="text-3xl font-bold text-green-400">{reportData?.memory?.current || reportData?.live?.mem_percent || 0}%</div>
                                                                <div className="text-sm text-gray-500">Memory</div>
                                                                {reportData?.data_points > 0 && (
                                                                    <div className="text-xs text-gray-600 mt-1">avg: {reportData?.memory?.avg || 0}%</div>
                                                                )}
                                                            </div>
                                                            <div className="bg-proxmox-card border border-proxmox-border rounded-xl p-4 text-center">
                                                                <div className="text-3xl font-bold text-orange-400">{reportData?.live?.vms_running || reportData?.vms_running?.current || 0}</div>
                                                                <div className="text-sm text-gray-500">VMs</div>
                                                            </div>
                                                            <div className="bg-proxmox-card border border-proxmox-border rounded-xl p-4 text-center">
                                                                <div className="text-3xl font-bold text-purple-400">{reportData?.live?.cts_running || 0}</div>
                                                                <div className="text-sm text-gray-500">Container</div>
                                                            </div>
                                                        </div>
                                                        
                                                        {/* Historical info */}
                                                        {reportData?.data_points > 0 && (
                                                            <div className="bg-proxmox-card border border-proxmox-border rounded-xl p-4">
                                                                <h3 className="font-semibold mb-3 text-sm text-gray-400">{t('historicalRange') || 'Historical Range'}</h3>
                                                                <div className="grid grid-cols-2 gap-4">
                                                                    <div>
                                                                        <div className="flex justify-between text-xs text-gray-500 mb-1">
                                                                            <span>CPU</span>
                                                                            <span>{reportData.cpu?.min || 0}% - {reportData.cpu?.max || 0}%</span>
                                                                        </div>
                                                                        <div className="h-2 bg-proxmox-dark rounded-full overflow-hidden relative">
                                                                            <div className="absolute h-full bg-blue-500/30" style={{ left: `${reportData.cpu?.min || 0}%`, width: `${(reportData.cpu?.max || 0) - (reportData.cpu?.min || 0)}%` }} />
                                                                            <div className="absolute h-full w-1 bg-blue-400" style={{ left: `${reportData.cpu?.current || 0}%` }} />
                                                                        </div>
                                                                    </div>
                                                                    <div>
                                                                        <div className="flex justify-between text-xs text-gray-500 mb-1">
                                                                            <span>Memory</span>
                                                                            <span>{reportData.memory?.min || 0}% - {reportData.memory?.max || 0}%</span>
                                                                        </div>
                                                                        <div className="h-2 bg-proxmox-dark rounded-full overflow-hidden relative">
                                                                            <div className="absolute h-full bg-green-500/30" style={{ left: `${reportData.memory?.min || 0}%`, width: `${(reportData.memory?.max || 0) - (reportData.memory?.min || 0)}%` }} />
                                                                            <div className="absolute h-full w-1 bg-green-400" style={{ left: `${reportData.memory?.current || 0}%` }} />
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                                <div className="text-xs text-gray-600 text-center mt-3">
                                                                    {reportData.data_points} {t('dataPoints') || 'data points'} ‚Ä¢ {reportData.period}
                                                                </div>
                                                            </div>
                                                        )}
                                                        
                                                        {/* Top VMs - CPU and Memory side by side */}
                                                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                                            {/* Top VMs by CPU */}
                                                            <div className="bg-proxmox-card border border-proxmox-border rounded-xl p-4">
                                                                <h3 className="font-semibold mb-3 flex items-center gap-2 text-sm">
                                                                    <Icons.Cpu className="text-blue-400 w-4 h-4" />
                                                                    {t('topVmsCpu') || 'Highest CPU Usage'}
                                                                </h3>
                                                                <div className="space-y-2">
                                                                    {topVms.length > 0 ? topVms.slice(0, 5).map((vm, idx) => (
                                                                        <div key={idx} className="flex items-center gap-2 p-2 bg-proxmox-dark rounded-lg text-sm">
                                                                            <span className="text-xs text-gray-500 w-4">{idx + 1}</span>
                                                                            <span>{vm.type === 'lxc' ? 'üì¶' : 'üñ•Ô∏è'}</span>
                                                                            <span className="flex-1 truncate">{vm.name || `VM ${vm.vmid}`}</span>
                                                                            <div className="w-16 h-1.5 bg-proxmox-hover rounded-full overflow-hidden">
                                                                                <div className="h-full bg-blue-500" style={{ width: `${Math.min((vm.cpu || 0) * 100, 100)}%` }} />
                                                                            </div>
                                                                            <span className="font-mono text-xs w-10 text-right">{((vm.cpu || 0) * 100).toFixed(0)}%</span>
                                                                        </div>
                                                                    )) : (
                                                                        <p className="text-gray-500 text-center py-4 text-sm">{t('noRunningVms') || 'No running VMs'}</p>
                                                                    )}
                                                                </div>
                                                            </div>
                                                            
                                                            {/* Top VMs by Memory */}
                                                            <div className="bg-proxmox-card border border-proxmox-border rounded-xl p-4">
                                                                <h3 className="font-semibold mb-3 flex items-center gap-2 text-sm">
                                                                    <Icons.HardDrive className="text-green-400 w-4 h-4" />
                                                                    {t('topVmsMem') || 'Highest Memory Usage'}
                                                                </h3>
                                                                <div className="space-y-2">
                                                                    {topVms.length > 0 ? [...topVms].sort((a, b) => (b.mem_percent || 0) - (a.mem_percent || 0)).slice(0, 5).map((vm, idx) => (
                                                                        <div key={idx} className="flex items-center gap-2 p-2 bg-proxmox-dark rounded-lg text-sm">
                                                                            <span className="text-xs text-gray-500 w-4">{idx + 1}</span>
                                                                            <span>{vm.type === 'lxc' ? 'üì¶' : 'üñ•Ô∏è'}</span>
                                                                            <span className="flex-1 truncate">{vm.name || `VM ${vm.vmid}`}</span>
                                                                            <div className="w-16 h-1.5 bg-proxmox-hover rounded-full overflow-hidden">
                                                                                <div className="h-full bg-green-500" style={{ width: `${Math.min(vm.mem_percent || 0, 100)}%` }} />
                                                                            </div>
                                                                            <span className="font-mono text-xs w-10 text-right">{(vm.mem_percent || 0).toFixed(0)}%</span>
                                                                        </div>
                                                                    )) : (
                                                                        <p className="text-gray-500 text-center py-4 text-sm">{t('noRunningVms') || 'No running VMs'}</p>
                                                                    )}
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                )}
                                            </div>
                                        )}

                                        {/* Settings Tab */}
                                        {activeTab === 'settings' && (
                                            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                                <div className="bg-proxmox-card border border-proxmox-border rounded-xl p-6 space-y-6">
                                                    <h3 className="font-semibold">{t('balancingConfig')}</h3>
                                                    
                                                    <Slider
                                                        label={t('migrationThreshold')}
                                                        description={t('migrationThresholdDesc')}
                                                        value={selectedCluster.migration_threshold}
                                                        onChange={v => updateConfig('migration_threshold', v)}
                                                        min={5}
                                                        max={100}
                                                    />
                                                    
                                                    <Slider
                                                        label={t('checkInterval')}
                                                        description={t('intervalBetweenChecks')}
                                                        value={selectedCluster.check_interval}
                                                        onChange={v => updateConfig('check_interval', v)}
                                                        min={60}
                                                        max={3600}
                                                        step={60}
                                                        unit="s"
                                                    />
                                                    
                                                    {/* LW: Excluded Nodes Section - GitHub Feature Request */}
                                                    <div className="pt-4 border-t border-proxmox-border">
                                                        <h4 className="text-sm font-medium text-gray-400 mb-3 flex items-center gap-2">
                                                            <Icons.Ban className="w-4 h-4 text-red-400" />
                                                            {t('excludedNodes') || 'Excluded Nodes'}
                                                        </h4>
                                                        <p className="text-xs text-gray-500 mb-3">
                                                            {t('excludedNodesDesc') || 'These nodes will never be targets for automatic VM balancing.'}
                                                        </p>
                                                        
                                                        {/* Current excluded nodes */}
                                                        {(selectedCluster.excluded_nodes || []).length > 0 ? (
                                                            <div className="space-y-2 mb-3">
                                                                {(selectedCluster.excluded_nodes || []).map(nodeName => (
                                                                    <div key={nodeName} className="flex items-center justify-between bg-proxmox-dark rounded-lg p-2">
                                                                        <div className="flex items-center gap-2">
                                                                            <Icons.Server className="w-4 h-4 text-red-400" />
                                                                            <span className="text-sm">{nodeName}</span>
                                                                        </div>
                                                                        <button
                                                                            onClick={async () => {
                                                                                try {
                                                                                    const res = await fetch(`${API_URL}/clusters/${selectedCluster.id}/excluded-nodes/${nodeName}`, {
                                                                                        method: 'DELETE',
                                                                                        credentials: 'include',
                                                                                        headers: getAuthHeaders()
                                                                                    });
                                                                                    if (res.ok) {
                                                                                        fetchClusters();
                                                                                        addToast(`${nodeName} ${t('reincludedInBalancing') || 're-included in balancing'}`, 'success');
                                                                                    }
                                                                                } catch(e) { console.error(e); }
                                                                            }}
                                                                            className="text-xs text-green-400 hover:text-green-300"
                                                                        >
                                                                            {t('include') || 'Include'}
                                                                        </button>
                                                                    </div>
                                                                ))}
                                                            </div>
                                                        ) : (
                                                            <div className="text-xs text-gray-600 mb-3 p-2 bg-proxmox-dark rounded-lg">
                                                                {t('noExcludedNodes') || 'No nodes excluded'}
                                                            </div>
                                                        )}
                                                        
                                                        {/* Add node dropdown */}
                                                        <div className="flex gap-2">
                                                            <select
                                                                id="excludeNodeSelect"
                                                                className="flex-1 bg-proxmox-dark border border-proxmox-border rounded-lg px-3 py-2 text-sm"
                                                                defaultValue=""
                                                            >
                                                                <option value="" disabled>{t('selectNodeToExclude') || 'Select node to exclude...'}</option>
                                                                {Object.keys(clusterMetrics || {})
                                                                    .filter(n => !(selectedCluster.excluded_nodes || []).includes(n))
                                                                    .map(nodeName => (
                                                                        <option key={nodeName} value={nodeName}>{nodeName}</option>
                                                                    ))
                                                                }
                                                            </select>
                                                            <button
                                                                onClick={async () => {
                                                                    const select = document.getElementById('excludeNodeSelect');
                                                                    const nodeName = select?.value;
                                                                    if (!nodeName) return;
                                                                    try {
                                                                        const res = await fetch(`${API_URL}/clusters/${selectedCluster.id}/excluded-nodes/${nodeName}`, {
                                                                            method: 'POST',
                                                                            credentials: 'include',
                                                                            headers: getAuthHeaders()
                                                                        });
                                                                        if (res.ok) {
                                                                            fetchClusters();
                                                                            addToast(`${nodeName} ${t('excludedFromBalancing') || 'excluded from balancing'}`, 'success');
                                                                            select.value = '';
                                                                        }
                                                                    } catch(e) { console.error(e); }
                                                                }}
                                                                className="px-3 py-2 bg-red-500/20 text-red-400 rounded-lg hover:bg-red-500/30 text-sm flex items-center gap-1"
                                                            >
                                                                <Icons.Ban className="w-4 h-4" />
                                                                {t('exclude') || 'Exclude'}
                                                            </button>
                                                        </div>
                                                    </div>
                                                    
                                                    {/* MK: Excluded VMs Section */}
                                                    <div className="pt-4 border-t border-proxmox-border">
                                                        <h4 className="text-sm font-medium text-gray-400 mb-3 flex items-center gap-2">
                                                            <Icons.Monitor className="w-4 h-4 text-red-400" />
                                                            {t('excludedVMs') || 'Excluded VMs'}
                                                        </h4>
                                                        <p className="text-xs text-gray-500 mb-3">
                                                            {t('excludedVMsDesc') || 'These VMs will never be automatically migrated during load balancing.'}
                                                        </p>
                                                        
                                                        {/* Current excluded VMs */}
                                                        <ExcludedVMsList clusterId={selectedCluster.id} clusterMetrics={clusterMetrics} addToast={addToast} getAuthHeaders={getAuthHeaders} />
                                                    </div>
                                                </div>

                                                <div className="bg-proxmox-card border border-proxmox-border rounded-xl p-6 space-y-6">
                                                    <h3 className="font-semibold">{t('optionsTitle')}</h3>
                                                    
                                                    <div className="space-y-4">
                                                        <Toggle
                                                            checked={selectedCluster.enabled}
                                                            onChange={v => updateConfig('enabled', v)}
                                                            label={t('balancingEnabled')}
                                                        />
                                                        <Toggle
                                                            checked={selectedCluster.auto_migrate}
                                                            onChange={v => updateConfig('auto_migrate', v)}
                                                            label={t('autoMigrate')}
                                                        />
                                                        <Toggle
                                                            checked={selectedCluster.dry_run}
                                                            onChange={v => updateConfig('dry_run', v)}
                                                            label={t('dryRun')}
                                                        />
                                                        
                                                        {/* Container Balancing */}
                                                        <div className="pt-3 border-t border-gray-700/50">
                                                            <Toggle
                                                                checked={selectedCluster.balance_containers || false}
                                                                onChange={v => updateConfig('balance_containers', v)}
                                                                label={t('balanceContainers')}
                                                            />
                                                            {selectedCluster.balance_containers && (
                                                                <div className="mt-2 ml-12 p-3 bg-yellow-500/10 border border-yellow-500/30 rounded-lg">
                                                                    <div className="flex items-start gap-2">
                                                                        <span className="text-yellow-500">‚ö†Ô∏è</span>
                                                                        <div className="text-xs text-yellow-200">
                                                                            {t('containerBalanceWarning')}
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            )}
                                                        </div>
                                                        
                                                        {/* Local Disk Balancing - NS: new feature, use with caution */}
                                                        <div className="pt-3 border-t border-gray-700/50">
                                                            <Toggle
                                                                checked={selectedCluster.balance_local_disks || false}
                                                                onChange={v => updateConfig('balance_local_disks', v)}
                                                                label={t('balanceLocalDisks')}
                                                            />
                                                            <div className="text-xs text-gray-500 pl-12 mt-1">
                                                                {t('balanceLocalDisksDesc')}
                                                            </div>
                                                            {selectedCluster.balance_local_disks && (
                                                                <div className="mt-2 ml-12 p-3 bg-orange-500/10 border border-orange-500/30 rounded-lg">
                                                                    <div className="flex items-start gap-2">
                                                                        <span className="text-orange-500">üíæ</span>
                                                                        <div className="text-xs text-orange-200">
                                                                            {t('localDiskBalanceWarning')}
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            )}
                                                        </div>
                                                    </div>

                                                    {/* HA Section */}
                                                    <div className="pt-4 border-t border-proxmox-border">
                                                        <h4 className="text-sm font-medium text-gray-400 mb-3">{t('highAvailability')}</h4>
                                                        <div className="space-y-3">
                                                            <Toggle
                                                                checked={selectedCluster.ha_enabled || false}
                                                                onChange={v => updateConfig('ha_enabled', v)}
                                                                label={t('haEnabled')}
                                                            />
                                                            <div className="text-xs text-gray-500 pl-12">
                                                                {t('haMonitorDesc')}
                                                            </div>
                                                            {selectedCluster.ha_enabled && (
                                                                <>
                                                                    <div className="ml-12 p-3 bg-green-500/10 border border-green-500/20 rounded-lg">
                                                                        <div className="flex items-center gap-2 text-green-400 text-sm">
                                                                            <span className="w-2 h-2 rounded-full bg-green-500 animate-pulse" />
                                                                            {t('haMonitorActive')}
                                                                        </div>
                                                                    </div>
                                                                    
                                                                    {/* Auto-discovered Fallback Hosts */}
                                                                    <div className="ml-12 mt-3 p-3 bg-proxmox-dark rounded-lg border border-proxmox-border">
                                                                        <div className="text-xs text-gray-400 mb-2">
                                                                            {t('fallbackHostsAuto')}
                                                                        </div>
                                                                        <div className="flex items-center gap-2">
                                                                            <span className="text-gray-500">{t('primary')}:</span>
                                                                            <span className="font-mono text-sm text-white">{selectedCluster.host}</span>
                                                                            {selectedCluster.current_host && selectedCluster.current_host !== selectedCluster.host && (
                                                                                <span className="text-yellow-400 text-xs">({t('fallback')})</span>
                                                                            )}
                                                                        </div>
                                                                        {selectedCluster.fallback_hosts && selectedCluster.fallback_hosts.length > 0 ? (
                                                                            <div className="flex items-center gap-2 mt-1">
                                                                                <span className="text-gray-500">{t('fallbacks')}:</span>
                                                                                <span className="font-mono text-sm text-gray-300">
                                                                                    {selectedCluster.fallback_hosts.join(', ')}
                                                                                </span>
                                                                            </div>
                                                                        ) : (
                                                                            <div className="text-xs text-gray-600 mt-1">
                                                                                {t('noFallbackHosts')}
                                                                            </div>
                                                                        )}
                                                                    </div>
                                                                </>
                                                            )}
                                                            
                                                            {/* Split-Brain Prevention Settings Button */}
                                                            {selectedCluster.ha_enabled && (
                                                                <button
                                                                    onClick={() => { setShowHaSettings(true); fetchHAStatus(selectedCluster.id); }}
                                                                    className="ml-12 mt-2 text-xs text-proxmox-orange hover:text-orange-400 flex items-center gap-1"
                                                                >
                                                                    <Icons.Settings className="w-3 h-3" />
                                                                    {t('splitBrainPrevention')} ({t('important2NodeCluster')})
                                                                </button>
                                                            )}
                                                        </div>
                                                    </div>

                                                    {/* Proxmox Native HA Section */}
                                                    <div className="pt-4 border-t border-proxmox-border">
                                                        <h4 className="text-sm font-medium text-gray-400 mb-3">{t('proxmoxNativeHa')}</h4>
                                                        <div className="text-xs text-gray-500 mb-3">
                                                            {t('nativeHaDesc')}
                                                        </div>
                                                        <ProxmoxHaSection clusterId={selectedCluster.id} />
                                                    </div>

                                                    <div className="pt-4 border-t border-proxmox-border">
                                                        <h4 className="text-sm font-medium text-gray-400 mb-3">{t('clusterInfo')}</h4>
                                                        <div className="space-y-2 text-sm">
                                                            <div className="flex justify-between">
                                                                <span className="text-gray-500">{t('primaryHost')}</span>
                                                                <span className="font-mono">{selectedCluster.host}</span>
                                                            </div>
                                                            {selectedCluster.current_host && selectedCluster.current_host !== selectedCluster.host && (
                                                                <div className="flex justify-between">
                                                                    <span className="text-gray-500">{t('connectedTo')}</span>
                                                                    <span className="font-mono text-yellow-400">{selectedCluster.current_host} ({t('fallback')})</span>
                                                                </div>
                                                            )}
                                                            {selectedCluster.fallback_hosts && selectedCluster.fallback_hosts.length > 0 && (
                                                                <div className="flex justify-between">
                                                                    <span className="text-gray-500">{t('fallbackHosts')}</span>
                                                                    <span className="font-mono text-xs text-gray-400">{selectedCluster.fallback_hosts.length} {t('configured')}</span>
                                                                </div>
                                                            )}
                                                            <div className="flex justify-between">
                                                                <span className="text-gray-500">{t('status')}</span>
                                                                <span className={selectedCluster.status === 'running' ? 'text-green-400' : 'text-gray-400'}>
                                                                    {selectedCluster.status === 'running' ? t('running') : selectedCluster.status}
                                                                </span>
                                                            </div>
                                                            {selectedCluster.last_run && (
                                                                <div className="flex justify-between">
                                                                    <span className="text-gray-500">{t('lastCheck')}</span>
                                                                    <span>{new Date(selectedCluster.last_run).toLocaleString()}</span>
                                                                </div>
                                                            )}
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                {/* Update Manager Section */}
                                                <div className="lg:col-span-2">
                                                    <UpdateManagerSection key={selectedCluster.id} clusterId={selectedCluster.id} addToast={addToast} />
                                                </div>
                                                
                                                {/* SMBIOS Auto-Configurator Section */}
                                                <div className="lg:col-span-2 bg-proxmox-card border border-proxmox-border rounded-xl p-6">
                                                    <SmbiosAutoConfigSection 
                                                        clusterId={selectedCluster?.id} 
                                                        selectedCluster={selectedCluster}
                                                        updateConfig={updateConfig}
                                                        addToast={addToast}
                                                    />
                                                </div>
                                                
                                                {/* Appearance Info - Now in My Profile */}
                                                <div className="lg:col-span-2 bg-proxmox-card border border-proxmox-border rounded-xl p-6">
                                                    <h3 className="font-semibold mb-4 flex items-center gap-2">
                                                        <Icons.Palette className="w-5 h-5" />
                                                        {t('appearance') || 'Appearance'}
                                                    </h3>
                                                    <div className="flex items-center gap-4">
                                                        <div 
                                                            className="w-16 h-16 rounded-xl relative overflow-hidden flex-shrink-0"
                                                            style={{ 
                                                                background: PEGAPROX_THEMES[user?.theme || 'proxmoxDark']?.colors?.darker || '#080B0E',
                                                                border: `2px solid ${PEGAPROX_THEMES[user?.theme || 'proxmoxDark']?.colors?.border || '#30363D'}`
                                                            }}
                                                        >
                                                            <div className="absolute left-0 top-0 bottom-0 w-3" style={{ background: PEGAPROX_THEMES[user?.theme || 'proxmoxDark']?.colors?.dark || '#0F1419' }} />
                                                            <div className="absolute right-1 top-1 bottom-1 left-4 rounded" style={{ background: PEGAPROX_THEMES[user?.theme || 'proxmoxDark']?.colors?.card || '#161B22' }}>
                                                                <div className="w-2/3 h-1 rounded-full m-1" style={{ background: PEGAPROX_THEMES[user?.theme || 'proxmoxDark']?.colors?.primary || '#E57000' }} />
                                                            </div>
                                                        </div>
                                                        <div className="flex-1">
                                                            <p className="text-white font-medium flex items-center gap-2">
                                                                <span className="text-xl">{PEGAPROX_THEMES[user?.theme || 'proxmoxDark']?.icon || 'üåô'}</span>
                                                                {PEGAPROX_THEMES[user?.theme || 'proxmoxDark']?.name || 'Proxmox Dark'}
                                                            </p>
                                                            <p className="text-sm text-gray-400 mt-1">
                                                                {t('themeInProfile') || 'Change your theme in My Profile (click your username in the top right)'}
                                                            </p>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                ) : (
                                    /* show overview when no cluster selected */
                                    <AllClustersOverview 
                                        clusters={clusters}
                                        allMetrics={allClusterMetrics}
                                        clusterGroups={clusterGroups}
                                        topGuests={topGuests}
                                        onSelectCluster={setSelectedCluster}
                                        onSelectVm={(cluster, vmid, node) => {
                                            // jump to vm
                                            setSelectedCluster(cluster);
                                            setHighlightedVm({ vmid, node });
                                            setTimeout(() => setHighlightedVm(null), 5000);
                                        }}
                                    />
                                )}
                            </div>
                        </div>
                    </div>

                    {/* LW: Update Notification Modal - shown on login when update available */}
                    {showUpdateNotification && pendingUpdate && (
                        <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/70 backdrop-blur-sm">
                            <div className="bg-proxmox-card border border-proxmox-border rounded-2xl shadow-2xl max-w-md w-full animate-scale-in overflow-hidden">
                                <div className="p-6 text-center">
                                    <div className="w-16 h-16 mx-auto mb-4 rounded-full bg-gradient-to-br from-green-500/20 to-emerald-500/20 flex items-center justify-center">
                                        <Icons.Download className="w-8 h-8 text-green-400" />
                                    </div>
                                    <h2 className="text-xl font-bold text-white mb-2">
                                        {t('newVersionAvailable') || 'New Version Available!'}
                                    </h2>
                                    <p className="text-gray-400 mb-2">
                                        {t('updateTo') || 'Update to'} <span className="text-green-400 font-semibold">{pendingUpdate.latest_version}</span>
                                    </p>
                                    <p className="text-sm text-gray-500 mb-6">
                                        {t('currentVersion') || 'Current version'}: {pendingUpdate.current_version}
                                    </p>
                                    
                                    <div className="flex gap-3">
                                        <button
                                            onClick={() => setShowUpdateNotification(false)}
                                            className="flex-1 px-4 py-2.5 bg-proxmox-dark hover:bg-proxmox-hover border border-proxmox-border rounded-lg text-gray-300 transition-colors"
                                        >
                                            {t('later') || 'Later'}
                                        </button>
                                        <button
                                            onClick={() => {
                                                setShowUpdateNotification(false);
                                                setShowSettings(true);
                                                // Small delay to let settings modal open, then navigate to updates tab
                                                setTimeout(() => {
                                                    const event = new CustomEvent('pegaprox-navigate-updates');
                                                    window.dispatchEvent(event);
                                                }, 100);
                                            }}
                                            className="flex-1 px-4 py-2.5 bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-600 hover:to-emerald-600 rounded-lg text-white font-medium transition-all"
                                        >
                                            {t('viewUpdate') || 'View Update'}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Config Modal */}
                    {configVm && selectedCluster && (
                        <ConfigModal 
                            vm={configVm}
                            clusterId={selectedCluster.id}
                            onClose={handleCloseConfig}
                            addToast={addToast}
                        />
                    )}

                    {/* Node Config Modal */}
                    {configNode && selectedCluster && (
                        <NodeModal 
                            node={configNode}
                            clusterId={selectedCluster.id}
                            onClose={() => setConfigNode(null)}
                            addToast={addToast}
                        />
                    )}

                    {/* Create VM/CT Modal */}
                    {showCreateVm && selectedCluster && (
                        <CreateVmModal
                            vmType={showCreateVm}
                            clusterId={selectedCluster.id}
                            nodes={Object.keys(clusterMetrics)}
                            onCreate={handleCreateVm}
                            onClose={() => setShowCreateVm(null)}
                        />
                    )}

                    {/* Console Modal */}
                    {consoleVm && consoleInfo && (
                        <ConsoleModal 
                            vm={consoleVm}
                            consoleInfo={consoleInfo}
                            clusterId={selectedCluster?.id}
                            onClose={handleCloseConsole}
                        />
                    )}

                    {/* HA Split-Brain Prevention Settings Modal */}
                    {showHaSettings && selectedCluster && (
                        <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4" onClick={() => setShowHaSettings(false)}>
                            <div className="bg-proxmox-card border border-proxmox-border rounded-xl w-full max-w-xl max-h-[85vh] overflow-hidden" onClick={e => e.stopPropagation()}>
                                <div className="flex justify-between items-center p-4 border-b border-proxmox-border bg-proxmox-dark">
                                    <div>
                                        <h2 className="text-lg font-semibold text-white flex items-center gap-2">
                                            <Icons.Shield className="text-green-400" />
                                            {t('splitBrainProtection')}
                                        </h2>
                                        <p className="text-sm text-gray-500">{selectedCluster.name}</p>
                                    </div>
                                    <button onClick={() => setShowHaSettings(false)} className="p-2 hover:bg-proxmox-hover rounded-lg">
                                        <Icons.X />
                                    </button>
                                </div>
                                
                                <div className="p-4 overflow-y-auto" style={{ maxHeight: 'calc(85vh - 140px)' }}>
                                    {/* SELF-FENCE - Main Feature */}
                                    <div className="p-4 bg-green-500/10 border border-green-500/30 rounded-xl mb-4">
                                        <div className="flex items-center gap-2 mb-3">
                                            <span className="text-2xl">üõ°Ô∏è</span>
                                            <h4 className="text-green-400 font-medium">{t('selfFenceProtection')}</h4>
                                            <span className="px-2 py-1 rounded text-xs bg-green-500/20 text-green-400 ml-auto">
                                                {t('recommended')}
                                            </span>
                                        </div>
                                        
                                        <p className="text-sm text-gray-300 mb-3">
                                            {t('selfFenceExplain')}
                                        </p>
                                        
                                        {/* Status */}
                                        {haStatus?.self_fence_installed ? (
                                            <div className="p-3 bg-green-500/20 rounded-lg">
                                                <div className="flex items-center justify-between">
                                                    <div>
                                                        <p className="text-green-400 font-medium">‚úÖ {t('selfFenceActive')}</p>
                                                        <p className="text-xs text-gray-400 mt-1">
                                                            {t('agentInstalledOnNodes')}: {haStatus.self_fence_nodes?.join(', ') || t('allNodes')}
                                                        </p>
                                                    </div>
                                                    <button
                                                        onClick={async () => {
                                                            if (!confirm(t('confirmUninstallAgent'))) return;
                                                            try {
                                                                const res = await authFetch(`${API_URL}/clusters/${selectedCluster.id}/ha/uninstall-self-fence`, { method: 'POST' });
                                                                if (res.ok) {
                                                                    addToast(t('selfFenceUninstalling'), 'success');
                                                                    setTimeout(() => fetchHAStatus(selectedCluster.id), 3000);
                                                                }
                                                            } catch (e) {
                                                                addToast(t('error') + ': ' + e.message, 'error');
                                                            }
                                                        }}
                                                        className="px-3 py-1 text-xs bg-red-500/20 hover:bg-red-500/30 text-red-400 rounded-lg"
                                                    >
                                                        {t('uninstall')}
                                                    </button>
                                                </div>
                                            </div>
                                        ) : (
                                            <div className="space-y-3">
                                                <div className="p-3 bg-yellow-500/20 rounded-lg">
                                                    <p className="text-yellow-400 font-medium">‚ö° {t('selfFenceNotInstalled')}</p>
                                                    <p className="text-xs text-gray-300 mt-1">{t('selfFenceInstallHint')}</p>
                                                </div>
                                                <button
                                                    onClick={async () => {
                                                        try {
                                                            const res = await authFetch(`${API_URL}/clusters/${selectedCluster.id}/ha/install-self-fence`, { method: 'POST' });
                                                            if (res.ok) {
                                                                addToast(t('selfFenceInstalling'), 'success');
                                                                setTimeout(() => fetchHAStatus(selectedCluster.id), 5000);
                                                            }
                                                        } catch (e) {
                                                            addToast(t('error') + ': ' + e.message, 'error');
                                                        }
                                                    }}
                                                    className="w-full px-4 py-2 bg-green-600 hover:bg-green-500 rounded-lg text-white font-medium"
                                                >
                                                    üõ°Ô∏è {t('installSelfFenceAgent')}
                                                </button>
                                            </div>
                                        )}
                                        
                                        <div className="mt-3 text-xs text-gray-400">
                                            ‚úì {t('noSharedStorageNeeded')} ‚Ä¢ ‚úì {t('worksWithLvmIscsi')}
                                        </div>
                                    </div>
                                    
                                    {/* 2-Node Cluster Mode */}
                                    <label className="flex items-center gap-3 p-3 bg-proxmox-dark border border-proxmox-border rounded-xl mb-4 cursor-pointer hover:border-proxmox-orange/50">
                                        <input
                                            type="checkbox"
                                            checked={haSettings.two_node_mode}
                                            onChange={(e) => setHaSettings({...haSettings, two_node_mode: e.target.checked})}
                                            className="w-5 h-5 rounded border-proxmox-border bg-proxmox-darker text-proxmox-orange"
                                        />
                                        <div>
                                            <span className="text-white font-medium">{t('enable2NodeMode')}</span>
                                            <p className="text-xs text-gray-500">{t('twoNodeModeDesc')}</p>
                                        </div>
                                    </label>
                                    
                                    {/* Basic Settings */}
                                    <div className="grid grid-cols-2 gap-4 mb-4">
                                        <div>
                                            <label className="block text-sm text-gray-400 mb-1">{t('recoveryDelay')}</label>
                                            <input
                                                type="number"
                                                min="10"
                                                max="300"
                                                value={haSettings.recovery_delay}
                                                onChange={(e) => setHaSettings({...haSettings, recovery_delay: parseInt(e.target.value) || 30})}
                                                className="w-full bg-proxmox-dark border border-proxmox-border rounded-lg px-3 py-2 text-white"
                                            />
                                            <p className="text-xs text-gray-500 mt-1">{t('recoveryDelayHint')}</p>
                                        </div>
                                        <div>
                                            <label className="block text-sm text-gray-400 mb-1">{t('failureThreshold')}</label>
                                            <input
                                                type="number"
                                                min="1"
                                                max="10"
                                                value={haSettings.failure_threshold}
                                                onChange={(e) => setHaSettings({...haSettings, failure_threshold: parseInt(e.target.value) || 3})}
                                                className="w-full bg-proxmox-dark border border-proxmox-border rounded-lg px-3 py-2 text-white"
                                            />
                                            <p className="text-xs text-gray-500 mt-1">{t('failureThresholdHint')}</p>
                                        </div>
                                    </div>
                                    
                                    {/* Advanced Settings - Collapsed */}
                                    <details className="bg-proxmox-dark border border-proxmox-border rounded-xl overflow-hidden">
                                        <summary className="p-3 cursor-pointer hover:bg-proxmox-hover flex items-center justify-between text-sm">
                                            <span className="text-gray-400">{t('advancedSettings')}</span>
                                            <Icons.ChevronDown className="w-4 h-4 text-gray-400" />
                                        </summary>
                                        <div className="p-3 pt-0 space-y-3 border-t border-proxmox-border">
                                            <div className="grid grid-cols-2 gap-3">
                                                <label className="flex items-center gap-2 p-2 bg-proxmox-darker rounded-lg">
                                                    <input
                                                        type="checkbox"
                                                        checked={haSettings.self_fence_enabled}
                                                        onChange={(e) => setHaSettings({...haSettings, self_fence_enabled: e.target.checked})}
                                                        className="w-4 h-4 rounded"
                                                    />
                                                    <span className="text-sm text-white">{t('selfFencing')}</span>
                                                </label>
                                                <label className="flex items-center gap-2 p-2 bg-proxmox-darker rounded-lg">
                                                    <input
                                                        type="checkbox"
                                                        checked={haSettings.verify_network}
                                                        onChange={(e) => setHaSettings({...haSettings, verify_network: e.target.checked})}
                                                        className="w-4 h-4 rounded"
                                                    />
                                                    <span className="text-sm text-white">{t('networkCheck')}</span>
                                                </label>
                                            </div>
                                            
                                            <div>
                                                <label className="block text-xs text-gray-400 mb-1">{t('additionalQuorumHosts')}</label>
                                                <input
                                                    type="text"
                                                    value={haSettings.quorum_hosts}
                                                    onChange={(e) => setHaSettings({...haSettings, quorum_hosts: e.target.value})}
                                                    placeholder="8.8.8.8, 1.1.1.1"
                                                    className="w-full bg-proxmox-darker border border-proxmox-border rounded-lg px-3 py-2 text-white text-sm"
                                                />
                                            </div>
                                            
                                            <div>
                                                <label className="block text-xs text-gray-400 mb-1">{t('gatewayIp')}</label>
                                                <input
                                                    type="text"
                                                    value={haSettings.quorum_gateway}
                                                    onChange={(e) => setHaSettings({...haSettings, quorum_gateway: e.target.value})}
                                                    placeholder="192.168.1.1"
                                                    className="w-full bg-proxmox-darker border border-proxmox-border rounded-lg px-3 py-2 text-white text-sm"
                                                />
                                            </div>
                                        </div>
                                    </details>
                                </div>
                                
                                {/* Footer */}
                                <div className="flex justify-end gap-2 p-4 border-t border-proxmox-border bg-proxmox-dark">
                                    <button
                                        onClick={() => setShowHaSettings(false)}
                                        className="px-4 py-2 bg-proxmox-dark hover:bg-proxmox-hover border border-proxmox-border rounded-lg"
                                    >
                                        {t('cancel')}
                                    </button>
                                    <button
                                        onClick={handleSaveHASettings}
                                        className="flex items-center gap-2 px-4 py-2 bg-proxmox-orange hover:bg-orange-600 rounded-lg"
                                    >
                                        <Icons.Save className="w-4 h-4" />
                                        {t('saveSettings')}
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Sponsor Footer */}
                    <footer className="border-t border-proxmox-border bg-proxmox-dark/50 mt-8">
                        <div className="max-w-[800px] mx-auto px-6 py-6">
                            <div className="text-center mb-4">
                                <p className="text-sm text-gray-400">
                                    ‚ù§Ô∏è {t('thanksToSponsors') || 'Thanks to our Sponsors'}
                                </p>
                            </div>
                            <div className="flex justify-center gap-3 flex-wrap">
                                {/* Sponsor logos from /images/sponsors/ folder */}
                                {[1, 2, 3, 4, 5, 6, 7, 8].map(num => (
                                    <SponsorSlot key={num} num={num} />
                                ))}
                            </div>
                            <div className="text-center mt-4 text-xs text-gray-600">
                                <p>PegaProx {PEGAPROX_VERSION} ‚Ä¢ {t('madeWithLove') || 'Made with ‚ù§Ô∏è for the Proxmox community'}</p>
                            </div>
                        </div>
                    </footer>

                    {/* Toast Notifications */}
                    <div className="fixed bottom-6 right-6 z-50 space-y-2">
                        {toasts.map(toast => (
                            <Toast
                                key={toast.id}
                                message={toast.message}
                                type={toast.type}
                                onClose={() => removeToast(toast.id)}
                            />
                        ))}
                    </div>

                    {/* Schedule Modal - MK Jan 2026 */}
                    {showScheduleModal && (
                        <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
                            <div className="bg-proxmox-card border border-proxmox-border rounded-xl w-full max-w-md">
                                <div className="p-4 border-b border-proxmox-border flex justify-between items-center">
                                    <h3 className="text-lg font-semibold">
                                        {editingSchedule ? (t('editSchedule') || 'Edit Schedule') : (t('newSchedule') || 'New Schedule')}
                                    </h3>
                                    <button onClick={() => setShowScheduleModal(false)} className="p-1 hover:bg-proxmox-hover rounded">
                                        <Icons.X />
                                    </button>
                                </div>
                                <form onSubmit={async (e) => {
                                    e.preventDefault();
                                    const form = e.target;
                                    const data = {
                                        cluster_id: selectedCluster?.id,
                                        vmid: parseInt(form.vmid.value),
                                        vm_type: form.vm_type.value,
                                        action: form.action.value,
                                        schedule_type: form.schedule_type.value,
                                        time: form.time.value,
                                        name: form.name.value || `${form.action.value} VM ${form.vmid.value}`,
                                        date: form.date?.value,
                                        days: Array.from(form.querySelectorAll('input[name="days"]:checked')).map(cb => cb.value)
                                    };
                                    const success = await createSchedule(data);
                                    if (success) setShowScheduleModal(false);
                                }} className="p-4 space-y-4">
                                    <div>
                                        <label className="block text-sm text-gray-400 mb-1">{t('name') || 'Name'}</label>
                                        <input name="name" type="text" placeholder={t('optionalName') || 'Optional name'} 
                                            className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg" />
                                    </div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="block text-sm text-gray-400 mb-1">VMID</label>
                                            <input name="vmid" type="number" required 
                                                className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg" />
                                        </div>
                                        <div>
                                            <label className="block text-sm text-gray-400 mb-1">{t('type') || 'Type'}</label>
                                            <select name="vm_type" className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg">
                                                <option value="qemu">VM (QEMU)</option>
                                                <option value="lxc">Container (LXC)</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div>
                                        <label className="block text-sm text-gray-400 mb-1">{t('action') || 'Action'}</label>
                                        <select name="action" required className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg">
                                            <option value="start">{t('start') || 'Start'}</option>
                                            <option value="stop">{t('stop') || 'Stop'}</option>
                                            <option value="shutdown">{t('shutdown') || 'Shutdown'}</option>
                                            <option value="reboot">{t('reboot') || 'Reboot'}</option>
                                            <option value="snapshot">{t('snapshot') || 'Snapshot'}</option>
                                        </select>
                                    </div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="block text-sm text-gray-400 mb-1">{t('scheduleType') || 'Schedule Type'}</label>
                                            <select name="schedule_type" required className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg">
                                                <option value="daily">{t('daily') || 'Daily'}</option>
                                                <option value="weekdays">{t('weekdays') || 'Weekdays'}</option>
                                                <option value="weekends">{t('weekends') || 'Weekends'}</option>
                                                <option value="weekly">{t('weekly') || 'Weekly'}</option>
                                                <option value="once">{t('once') || 'Once'}</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label className="block text-sm text-gray-400 mb-1">{t('time') || 'Time'}</label>
                                            <input name="time" type="time" required 
                                                className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg" />
                                        </div>
                                    </div>
                                    <div>
                                        <label className="block text-sm text-gray-400 mb-1">{t('date') || 'Date'} ({t('forOnce') || 'for once'})</label>
                                        <input name="date" type="date" 
                                            className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg" />
                                    </div>
                                    <div>
                                        <label className="block text-sm text-gray-400 mb-1">{t('days') || 'Days'} ({t('forWeekly') || 'for weekly'})</label>
                                        <div className="flex flex-wrap gap-2">
                                            {['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'].map(day => (
                                                <label key={day} className="flex items-center gap-1 text-sm">
                                                    <input type="checkbox" name="days" value={day} className="rounded" />
                                                    {day.slice(0, 3)}
                                                </label>
                                            ))}
                                        </div>
                                    </div>
                                    <div className="flex gap-2 justify-end pt-2">
                                        <button type="button" onClick={() => setShowScheduleModal(false)}
                                            className="px-4 py-2 bg-proxmox-dark hover:bg-proxmox-hover rounded-lg">
                                            {t('cancel') || 'Cancel'}
                                        </button>
                                        <button type="submit" className="px-4 py-2 bg-proxmox-orange hover:bg-orange-600 rounded-lg">
                                            {t('save') || 'Save'}
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}

                    {/* Tag Editor Modal - NS Jan 2026 */}
                    {showTagEditor && (
                        <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4" onClick={() => setShowTagEditor(null)}>
                            <div className="bg-proxmox-card border border-proxmox-border rounded-xl w-full max-w-sm" onClick={e => e.stopPropagation()}>
                                <div className="p-4 border-b border-proxmox-border">
                                    <h3 className="font-semibold flex items-center gap-2">
                                        <Icons.Tag />
                                        {t('manageTags') || 'Manage Tags'}: {showTagEditor.vmName}
                                    </h3>
                                </div>
                                <div className="p-4 space-y-4">
                                    {/* Current tags */}
                                    <div className="flex flex-wrap gap-2">
                                        {getVmTags(showTagEditor.clusterId, showTagEditor.vmid).map((tag, idx) => (
                                            <span 
                                                key={idx}
                                                className="flex items-center gap-1 px-2 py-1 rounded-full text-xs"
                                                style={{ backgroundColor: (tag.color || '#6b7280') + '30', color: tag.color || '#9ca3af' }}
                                            >
                                                {tag.name || tag}
                                                <button 
                                                    onClick={() => removeTagFromVm(showTagEditor.clusterId, showTagEditor.vmid, tag.name || tag)}
                                                    className="hover:text-red-400"
                                                >
                                                    <Icons.X className="w-3 h-3" />
                                                </button>
                                            </span>
                                        ))}
                                        {getVmTags(showTagEditor.clusterId, showTagEditor.vmid).length === 0 && (
                                            <span className="text-gray-500 text-sm">{t('noTags') || 'No tags'}</span>
                                        )}
                                    </div>
                                    
                                    {/* Add new tag */}
                                    <div className="flex gap-2">
                                        <input
                                            type="text"
                                            value={newTagName}
                                            onChange={e => setNewTagName(e.target.value)}
                                            onKeyDown={async e => {
                                                if (e.key === 'Enter' && newTagName.trim()) {
                                                    await addTagToVm(showTagEditor.clusterId, showTagEditor.vmid, newTagName.trim());
                                                    setNewTagName('');
                                                }
                                            }}
                                            placeholder={t('newTag') || 'New tag...'}
                                            className="flex-1 px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg text-sm"
                                        />
                                        <button
                                            onClick={async () => {
                                                if (newTagName.trim()) {
                                                    await addTagToVm(showTagEditor.clusterId, showTagEditor.vmid, newTagName.trim());
                                                    setNewTagName('');
                                                }
                                            }}
                                            className="px-3 py-2 bg-proxmox-orange hover:bg-orange-600 rounded-lg"
                                        >
                                            <Icons.Plus className="w-4 h-4" />
                                        </button>
                                    </div>
                                    
                                    {/* Suggested tags from cluster */}
                                    {clusterTags.length > 0 && (
                                        <div>
                                            <p className="text-xs text-gray-500 mb-2">{t('existingTags') || 'Existing tags'}:</p>
                                            <div className="flex flex-wrap gap-1">
                                                {clusterTags.filter(t => 
                                                    !getVmTags(showTagEditor.clusterId, showTagEditor.vmid).some(vt => (vt.name || vt) === t.name)
                                                ).slice(0, 10).map((tag, idx) => (
                                                    <button
                                                        key={idx}
                                                        onClick={() => addTagToVm(showTagEditor.clusterId, showTagEditor.vmid, tag.name, tag.color)}
                                                        className="px-2 py-0.5 rounded-full text-xs hover:opacity-80"
                                                        style={{ backgroundColor: (tag.color || '#6b7280') + '30', color: tag.color || '#9ca3af' }}
                                                    >
                                                        + {tag.name}
                                                    </button>
                                                ))}
                                            </div>
                                        </div>
                                    )}
                                </div>
                                <div className="p-4 border-t border-proxmox-border">
                                    <button
                                        onClick={() => setShowTagEditor(null)}
                                        className="w-full px-4 py-2 bg-proxmox-dark hover:bg-proxmox-hover rounded-lg"
                                    >
                                        {t('close') || 'Close'}
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Alert Modal - NS Jan 2026 - Supports Cluster/Node/VM targeting */}
                    {showAlertModal && (
                        <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4" onClick={() => setShowAlertModal(false)}>
                            <div className="bg-proxmox-card border border-proxmox-border rounded-xl w-full max-w-md" onClick={e => e.stopPropagation()}>
                                <div className="p-4 border-b border-proxmox-border flex justify-between items-center">
                                    <h3 className="text-lg font-semibold">{t('newAlert') || 'New Alert'}</h3>
                                    <button onClick={() => setShowAlertModal(false)} className="p-1 hover:bg-proxmox-hover rounded">
                                        <Icons.X />
                                    </button>
                                </div>
                                <form onSubmit={async (e) => {
                                    e.preventDefault();
                                    const form = e.target;
                                    await createClusterAlert({
                                        name: form.name.value,
                                        target_type: form.target_type.value,
                                        target_id: form.target_id.value || null,
                                        metric: form.metric.value,
                                        operator: form.operator.value,
                                        threshold: parseInt(form.threshold.value),
                                        action: form.action.value,
                                        enabled: true
                                    });
                                }} className="p-4 space-y-4">
                                    <div>
                                        <label className="block text-sm text-gray-400 mb-1">{t('name') || 'Name'}</label>
                                        <input name="name" required placeholder="High CPU Alert" className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg" />
                                    </div>
                                    
                                    {/* Target Type Selection */}
                                    <div className="grid grid-cols-2 gap-3">
                                        <div>
                                            <label className="block text-sm text-gray-400 mb-1">{t('targetType') || 'Apply to'}</label>
                                            <select name="target_type" className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg">
                                                <option value="cluster">{t('entireCluster') || 'Entire Cluster'}</option>
                                                <option value="node">{t('specificNode') || 'Specific Node'}</option>
                                                <option value="vm">{t('specificVm') || 'Specific VM'}</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label className="block text-sm text-gray-400 mb-1">{t('targetId') || 'Target'} <span className="text-xs text-gray-600">({t('optional') || 'optional'})</span></label>
                                            <input name="target_id" placeholder="node1 or VMID" className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg" />
                                        </div>
                                    </div>
                                    
                                    <div className="grid grid-cols-3 gap-3">
                                        <div>
                                            <label className="block text-sm text-gray-400 mb-1">{t('metric') || 'Metric'}</label>
                                            <select name="metric" className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg">
                                                <option value="cpu">CPU</option>
                                                <option value="memory">Memory</option>
                                                <option value="disk">Disk</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label className="block text-sm text-gray-400 mb-1">{t('condition') || 'Condition'}</label>
                                            <select name="operator" className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg">
                                                <option value=">">&gt; above</option>
                                                <option value="<">&lt; below</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label className="block text-sm text-gray-400 mb-1">{t('threshold') || 'Threshold'} %</label>
                                            <input name="threshold" type="number" min="0" max="100" defaultValue="80" required className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg" />
                                        </div>
                                    </div>
                                    <div>
                                        <label className="block text-sm text-gray-400 mb-1">{t('action') || 'Action'}</label>
                                        <select name="action" className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg">
                                            <option value="log">Log Only</option>
                                            <option value="email">Email</option>
                                        </select>
                                    </div>
                                    <div className="flex gap-2 justify-end pt-2">
                                        <button type="button" onClick={() => setShowAlertModal(false)} className="px-4 py-2 bg-proxmox-dark hover:bg-proxmox-hover rounded-lg">
                                            {t('cancel') || 'Cancel'}
                                        </button>
                                        <button type="submit" className="px-4 py-2 bg-proxmox-orange hover:bg-orange-600 rounded-lg">
                                            {t('create') || 'Create'}
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}

                    {/* Affinity Rule Modal - NS Jan 2026 */}
                    {showAffinityModal && (
                        <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4" onClick={() => setShowAffinityModal(false)}>
                            <div className="bg-proxmox-card border border-proxmox-border rounded-xl w-full max-w-md" onClick={e => e.stopPropagation()}>
                                <div className="p-4 border-b border-proxmox-border flex justify-between items-center">
                                    <h3 className="text-lg font-semibold">{t('newRule') || 'New Affinity Rule'}</h3>
                                    <button onClick={() => setShowAffinityModal(false)} className="p-1 hover:bg-proxmox-hover rounded">
                                        <Icons.X />
                                    </button>
                                </div>
                                <form onSubmit={async (e) => {
                                    e.preventDefault();
                                    const form = e.target;
                                    const vmIds = form.vm_ids.value.split(',').map(id => parseInt(id.trim())).filter(Boolean);
                                    await createClusterAffinityRule({
                                        type: form.type.value,
                                        vm_ids: vmIds,
                                        enforce: form.enforce.checked
                                    });
                                }} className="p-4 space-y-4">
                                    <div>
                                        <label className="block text-sm text-gray-400 mb-1">{t('ruleType') || 'Rule Type'}</label>
                                        <select name="type" className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg">
                                            <option value="together">{t('together') || 'Together'} - VMs on same node</option>
                                            <option value="separate">{t('separate') || 'Separate'} - VMs on different nodes</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label className="block text-sm text-gray-400 mb-1">VMIDs ({t('commaSeparated') || 'comma-separated'})</label>
                                        <input name="vm_ids" required placeholder="100, 101, 102" className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg" />
                                    </div>
                                    <label className="flex items-center gap-2 cursor-pointer">
                                        <input name="enforce" type="checkbox" className="rounded" />
                                        <span className="text-sm">{t('enforced') || 'Enforce'}</span>
                                        <span className="text-xs text-gray-500">({t('enforceHint') || 'Block migrations that violate rule'})</span>
                                    </label>
                                    <div className="flex gap-2 justify-end pt-2">
                                        <button type="button" onClick={() => setShowAffinityModal(false)} className="px-4 py-2 bg-proxmox-dark hover:bg-proxmox-hover rounded-lg">
                                            {t('cancel') || 'Cancel'}
                                        </button>
                                        <button type="submit" className="px-4 py-2 bg-proxmox-orange hover:bg-orange-600 rounded-lg">
                                            {t('create') || 'Create'}
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}

                    {/* Script Run Confirmation Modal - Password required */}
                    {showScriptRunModal && (
                        <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4" onClick={() => setShowScriptRunModal(null)}>
                            <div className="bg-proxmox-card border border-proxmox-border rounded-xl w-full max-w-md" onClick={e => e.stopPropagation()}>
                                <div className="flex items-center justify-between p-4 border-b border-proxmox-border">
                                    <h3 className="text-lg font-semibold">{t('runScript') || 'Run Script'}</h3>
                                    <button onClick={() => setShowScriptRunModal(null)} className="p-1 hover:bg-proxmox-hover rounded">
                                        <Icons.X className="w-5 h-5" />
                                    </button>
                                </div>
                                <form className="p-4 space-y-4" onSubmit={async (e) => {
                                    e.preventDefault();
                                    const password = e.target.password.value;
                                    if (!password) return;
                                    
                                    try {
                                        const res = await authFetch(`${API_URL}/clusters/${selectedCluster.id}/scripts/${showScriptRunModal.id}/run`, {
                                            method: 'POST',
                                            headers: { 'Content-Type': 'application/json' },
                                            body: JSON.stringify({ password })
                                        });
                                        
                                        if (res && res.ok) {
                                            const data = await res.json();
                                            addToast(data.message || (t('scriptStarted') || 'Script execution started'), 'success');
                                            setShowScriptRunModal(null);
                                            // Reload scripts to show last_run update
                                            setTimeout(() => loadCustomScripts(selectedCluster.id), 1000);
                                        } else {
                                            const err = await res.json().catch(() => ({}));
                                            addToast(err.error || 'Failed to run script', 'error');
                                        }
                                    } catch (e) {
                                        addToast('Error: ' + e.message, 'error');
                                    }
                                }}>
                                    <div className="p-3 bg-yellow-500/10 border border-yellow-500/30 rounded-lg text-yellow-300 text-sm">
                                        <strong>{t('warning') || 'Warning'}:</strong> {t('scriptWarning') || 'Scripts run with SSH user permissions. Ensure scripts are safe before running.'}
                                    </div>
                                    
                                    <div className="bg-proxmox-dark rounded-lg p-3">
                                        <div className="flex items-center gap-3">
                                            <div className={`w-10 h-10 rounded-lg flex items-center justify-center ${
                                                showScriptRunModal.type === 'python' ? 'bg-blue-500/20 text-blue-400' : 'bg-green-500/20 text-green-400'
                                            }`}>
                                                {showScriptRunModal.type === 'python' ? 'üêç' : 'üìú'}
                                            </div>
                                            <div>
                                                <h4 className="font-medium text-white">{showScriptRunModal.name}</h4>
                                                <p className="text-xs text-gray-500">{showScriptRunModal.description || 'No description'}</p>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label className="block text-sm text-gray-400 mb-1">{t('confirmPassword') || 'Confirm your password'} *</label>
                                        <input 
                                            name="password" 
                                            type="password" 
                                            required 
                                            autoFocus
                                            placeholder={t('enterPassword') || 'Enter your password'}
                                            className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg" 
                                        />
                                        <p className="text-xs text-gray-500 mt-1">{t('passwordRequiredForScripts') || 'Password confirmation required for security'}</p>
                                    </div>
                                    
                                    <div className="flex justify-end gap-3 pt-2">
                                        <button type="button" onClick={() => setShowScriptRunModal(null)} className="px-4 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg hover:bg-proxmox-hover">
                                            {t('cancel') || 'Cancel'}
                                        </button>
                                        <button type="submit" className="px-4 py-2 bg-green-600 hover:bg-green-700 rounded-lg flex items-center gap-2">
                                            <Icons.Play className="w-4 h-4" />
                                            {t('runScript') || 'Run Script'}
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}

                    {/* Script Output Modal */}
                    {scriptOutput && (
                        <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4" onClick={() => setScriptOutput(null)}>
                            <div className="bg-proxmox-card border border-proxmox-border rounded-xl w-full max-w-3xl max-h-[80vh] flex flex-col" onClick={e => e.stopPropagation()}>
                                <div className="flex items-center justify-between p-4 border-b border-proxmox-border">
                                    <div>
                                        <h3 className="text-lg font-semibold">{scriptOutput.name} - {t('output') || 'Output'}</h3>
                                        <p className="text-xs text-gray-500">
                                            {t('lastRun') || 'Last run'}: {scriptOutput.last_run ? new Date(scriptOutput.last_run).toLocaleString() : (t('never') || 'Never')} 
                                            {scriptOutput.last_status && (
                                                <span className={`ml-2 px-2 py-0.5 rounded text-xs ${
                                                    scriptOutput.last_status === 'success' ? 'bg-green-500/20 text-green-400' :
                                                    scriptOutput.last_status === 'partial' ? 'bg-yellow-500/20 text-yellow-400' :
                                                    'bg-red-500/20 text-red-400'
                                                }`}>
                                                    {scriptOutput.last_status}
                                                </span>
                                            )}
                                        </p>
                                    </div>
                                    <button onClick={() => setScriptOutput(null)} className="p-1 hover:bg-proxmox-hover rounded">
                                        <Icons.X className="w-5 h-5" />
                                    </button>
                                </div>
                                <div className="p-4 flex-1 overflow-auto">
                                    <pre className="bg-proxmox-dark p-4 rounded-lg text-sm font-mono whitespace-pre-wrap text-gray-300 max-h-[60vh] overflow-auto">
                                        {scriptOutput.output || t('noOutput') || 'No output available'}
                                    </pre>
                                </div>
                                <div className="p-4 border-t border-proxmox-border flex justify-end">
                                    <button onClick={() => setScriptOutput(null)} className="px-4 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg hover:bg-proxmox-hover">
                                        {t('close') || 'Close'}
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Custom Script Modal */}
                    {showScriptModal && (
                        <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4" onClick={() => { setShowScriptModal(false); setEditingScript(null); }}>
                            <div className="bg-proxmox-card border border-proxmox-border rounded-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto" onClick={e => e.stopPropagation()}>
                                <div className="flex items-center justify-between p-4 border-b border-proxmox-border">
                                    <h3 className="text-lg font-semibold">{editingScript ? (t('editScript') || 'Edit Script') : (t('newScript') || 'New Script')}</h3>
                                    <button onClick={() => { setShowScriptModal(false); setEditingScript(null); }} className="p-1 hover:bg-proxmox-hover rounded">
                                        <Icons.X className="w-5 h-5" />
                                    </button>
                                </div>
                                <form className="p-4 space-y-4" onSubmit={async (e) => {
                                    e.preventDefault();
                                    const form = e.target;
                                    const data = {
                                        name: form.name.value,
                                        description: form.description.value,
                                        type: form.type.value,
                                        content: form.content.value,
                                        target_nodes: form.target_nodes.value,
                                        enabled: form.enabled.checked
                                    };
                                    
                                    try {
                                        const url = editingScript 
                                            ? `${API_URL}/clusters/${selectedCluster.id}/scripts/${editingScript.id}`
                                            : `${API_URL}/clusters/${selectedCluster.id}/scripts`;
                                        console.log('[Script] Saving to:', url, 'Data:', data);
                                        const res = await authFetch(url, {
                                            method: editingScript ? 'PUT' : 'POST',
                                            headers: { 'Content-Type': 'application/json' },
                                            body: JSON.stringify(data)
                                        });
                                        console.log('[Script] Response:', res?.status, res?.ok);
                                        
                                        if (res && res.ok) {
                                            addToast(editingScript ? (t('scriptUpdated') || 'Script updated') : (t('scriptCreated') || 'Script created'), 'success');
                                            setShowScriptModal(false);
                                            setEditingScript(null);
                                            // Reload scripts
                                            loadCustomScripts(selectedCluster.id);
                                        } else {
                                            const err = await res.json().catch(() => ({}));
                                            console.error('[Script] Error response:', err);
                                            addToast(err.error || 'Failed to save script', 'error');
                                        }
                                    } catch (e) {
                                        console.error('[Script] Exception:', e);
                                        addToast('Error saving script: ' + e.message, 'error');
                                    }
                                }}>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="block text-sm text-gray-400 mb-1">{t('name') || 'Name'} *</label>
                                            <input name="name" required defaultValue={editingScript?.name || ''} placeholder="my-script" className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg" />
                                        </div>
                                        <div>
                                            <label className="block text-sm text-gray-400 mb-1">{t('type') || 'Type'}</label>
                                            <select name="type" defaultValue={editingScript?.type || 'bash'} className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg">
                                                <option value="bash">Bash (.sh)</option>
                                                <option value="python">Python (.py)</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label className="block text-sm text-gray-400 mb-1">{t('description') || 'Description'}</label>
                                        <input name="description" defaultValue={editingScript?.description || ''} placeholder="What does this script do?" className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg" />
                                    </div>
                                    
                                    <div>
                                        <label className="block text-sm text-gray-400 mb-1">{t('targetNodes') || 'Target Nodes'}</label>
                                        <input name="target_nodes" defaultValue={editingScript?.target_nodes || 'all'} placeholder="all or node1,node2" className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg" />
                                        <p className="text-xs text-gray-600 mt-1">Use "all" for all nodes or comma-separated node names</p>
                                    </div>
                                    
                                    <div>
                                        <label className="block text-sm text-gray-400 mb-1">{t('scriptContent') || 'Script Content'} *</label>
                                        <textarea 
                                            name="content" 
                                            required 
                                            rows={12}
                                            defaultValue={editingScript?.content || (editingScript?.type === 'python' ? '#!/usr/bin/env python3\n# Your script here\n\nprint("Hello from PegaProx!")' : '#!/bin/bash\n# Your script here\n\necho "Hello from PegaProx!"')}
                                            placeholder="#!/bin/bash"
                                            className="w-full px-3 py-2 bg-proxmox-dark border border-proxmox-border rounded-lg font-mono text-sm"
                                        />
                                    </div>
                                    
                                    <label className="flex items-center gap-2">
                                        <input type="checkbox" name="enabled" defaultChecked={editingScript?.enabled !== false} className="w-4 h-4 rounded" />
                                        <span>{t('enabled') || 'Enabled'}</span>
                                    </label>
                                    
                                    <div className="bg-yellow-500/10 border border-yellow-500/30 rounded-lg p-3">
                                        <div className="flex items-start gap-2">
                                            <Icons.AlertTriangle className="text-yellow-500 w-5 h-5 mt-0.5" />
                                            <div className="text-sm text-yellow-200">
                                                <strong>{t('warning') || 'Warning'}:</strong> {t('scriptWarning') || 'Scripts run with SSH user permissions. Ensure scripts are safe before running.'}
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div className="flex gap-2 justify-end pt-2">
                                        <button type="button" onClick={() => { setShowScriptModal(false); setEditingScript(null); }} className="px-4 py-2 bg-proxmox-dark hover:bg-proxmox-hover rounded-lg">
                                            {t('cancel') || 'Cancel'}
                                        </button>
                                        <button type="submit" className="px-4 py-2 bg-proxmox-orange hover:bg-orange-600 rounded-lg">
                                            {editingScript ? (t('update') || 'Update') : (t('create') || 'Create')}
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}

                    {/* Add Cluster Modal */}
                    <AddClusterModal
                        isOpen={showAddModal}
                        onClose={() => {
                            setShowAddModal(false);
                            setError(null);
                        }}
                        onSubmit={handleAddCluster}
                        loading={loading}
                        error={error}
                    />
                    
                    {/* User Profile Modal */}
                    <UserProfileModal
                        isOpen={showProfile}
                        onClose={() => setShowProfile(false)}
                        addToast={addToast}
                    />
                    
                    {/* PegaProx Settings Modal */}
                    <PegaProxSettingsModal
                        isOpen={showSettings}
                        onClose={() => setShowSettings(false)}
                        addToast={addToast}
                    />
                    
                    {/* Group Manager Modal */}
                    {showGroupManager && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
                            <div className="bg-proxmox-card border border-proxmox-border rounded-xl w-full max-w-lg p-6 max-h-[80vh] overflow-auto">
                                <div className="flex items-center justify-between mb-4">
                                    <h3 className="text-lg font-semibold">{t('clusterGroups')}</h3>
                                    <button onClick={() => setShowGroupManager(false)} className="text-gray-400 hover:text-white">
                                        <Icons.X />
                                    </button>
                                </div>
                                
                                <p className="text-sm text-gray-400 mb-4">
                                    {t('clusterGroupsDesc')}
                                </p>
                                
                                {/* Add New Group */}
                                <div className="mb-4 p-3 bg-proxmox-dark rounded-lg">
                                    <div className="flex gap-2">
                                        <input
                                            type="text"
                                            placeholder={t('groupName') + '...'}
                                            id="newGroupName"
                                            className="flex-1 px-3 py-2 bg-proxmox-darker border border-proxmox-border rounded text-white text-sm"
                                        />
                                        <input
                                            type="color"
                                            defaultValue="#E86F2D"
                                            id="newGroupColor"
                                            className="w-10 h-10 rounded cursor-pointer"
                                        />
                                        <button
                                            onClick={async () => {
                                                const name = document.getElementById('newGroupName').value;
                                                const color = document.getElementById('newGroupColor').value;
                                                if (!name) return;
                                                try {
                                                    const r = await fetch(`${API_URL}/cluster-groups`, {
                                                        method: 'POST',
                                                        headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
                                                        body: JSON.stringify({ name, color })
                                                    });
                                                    if (r.ok) {
                                                        document.getElementById('newGroupName').value = '';
                                                        fetchClusterGroups();
                                                        addToast(t('groupCreated'), 'success');
                                                    }
                                                } catch(e) {}
                                            }}
                                            className="px-4 py-2 bg-proxmox-orange hover:bg-orange-600 rounded text-sm font-medium"
                                        >
                                            {t('add')}
                                        </button>
                                    </div>
                                </div>
                                
                                {/* Groups List */}
                                <div className="space-y-2">
                                    {clusterGroups.length === 0 ? (
                                        <p className="text-gray-500 text-center py-4">{t('noGroupsYet')}</p>
                                    ) : (
                                        clusterGroups.map(group => {
                                            const groupClusters = clusters.filter(c => c.group_id === group.id);
                                            const tenant = group.tenant_id ? 
                                                // We don't have tenants here, show ID
                                                group.tenant_id : null;
                                            return (
                                                <div key={group.id} className="flex items-center justify-between p-3 bg-proxmox-dark rounded-lg">
                                                    <div className="flex items-center gap-3">
                                                        <div className="w-3 h-3 rounded-full" style={{ backgroundColor: group.color || '#E86F2D' }} />
                                                        <div>
                                                            <span className="text-white font-medium">{group.name}</span>
                                                            <span className="text-xs text-gray-500 ml-2">({groupClusters.length} clusters)</span>
                                                            {tenant && (
                                                                <span className="ml-2 px-1.5 py-0.5 text-[10px] bg-blue-500/20 text-blue-400 rounded">
                                                                    Tenant: {tenant}
                                                                </span>
                                                            )}
                                                        </div>
                                                    </div>
                                                    <button
                                                        onClick={async () => {
                                                            if (!confirm(`Delete group "${group.name}"?`)) return;
                                                            try {
                                                                const r = await fetch(`${API_URL}/cluster-groups/${group.id}`, {
                                                                    method: 'DELETE',
                                                                    headers: getAuthHeaders()
                                                                });
                                                                if (r.ok) {
                                                                    fetchClusterGroups();
                                                                    fetchClusters();
                                                                    addToast('Group deleted', 'success');
                                                                }
                                                            } catch(e) {}
                                                        }}
                                                        className="p-1 text-red-400 hover:bg-red-500/20 rounded"
                                                    >
                                                        <Icons.Trash className="w-4 h-4" />
                                                    </button>
                                                </div>
                                            );
                                        })
                                    )}
                                </div>
                                
                                <div className="mt-4 pt-4 border-t border-proxmox-border">
                                    <p className="text-xs text-gray-500">
                                        {t('groupsTip')}
                                    </p>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {/* Assign Group Modal */}
                    {showAssignGroup && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
                            <div className="bg-proxmox-card border border-proxmox-border rounded-xl w-full max-w-sm p-6">
                                <div className="flex items-center justify-between mb-4">
                                    <h3 className="text-lg font-semibold">{t('assignToGroup')}</h3>
                                    <button onClick={() => setShowAssignGroup(null)} className="text-gray-400 hover:text-white">
                                        <Icons.X />
                                    </button>
                                </div>
                                
                                <p className="text-sm text-gray-400 mb-4">
                                    {t('assignToGroup')}: <span className="text-white font-medium">{showAssignGroup.name}</span>
                                </p>
                                
                                <div className="space-y-2">
                                    <button
                                        onClick={async () => {
                                            try {
                                                const r = await fetch(`${API_URL}/clusters/${showAssignGroup.id}/group`, {
                                                    method: 'PUT',
                                                    headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
                                                    body: JSON.stringify({ group_id: null })
                                                });
                                                if (r.ok) {
                                                    fetchClusters();
                                                    setShowAssignGroup(null);
                                                    addToast(t('removeFromGroup'), 'success');
                                                }
                                            } catch(e) {}
                                        }}
                                        className={`w-full p-3 rounded-lg text-left transition-colors ${
                                            !showAssignGroup.group_id ? 'bg-proxmox-orange/20 border border-proxmox-orange' : 'bg-proxmox-dark hover:bg-proxmox-hover border border-transparent'
                                        }`}
                                    >
                                        <div className="flex items-center gap-3">
                                            <Icons.Server className="w-4 h-4 text-gray-400" />
                                            <span className="text-gray-300">{t('noGroup')} ({t('ungrouped')})</span>
                                        </div>
                                    </button>
                                    
                                    {clusterGroups.map(group => (
                                        <button
                                            key={group.id}
                                            onClick={async () => {
                                                try {
                                                    const r = await fetch(`${API_URL}/clusters/${showAssignGroup.id}/group`, {
                                                        method: 'PUT',
                                                        headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
                                                        body: JSON.stringify({ group_id: group.id })
                                                    });
                                                    if (r.ok) {
                                                        fetchClusters();
                                                        setShowAssignGroup(null);
                                                        addToast(t('groupUpdated'), 'success');
                                                    }
                                                } catch(e) {}
                                            }}
                                            className={`w-full p-3 rounded-lg text-left transition-colors ${
                                                showAssignGroup.group_id === group.id ? 'bg-proxmox-orange/20 border border-proxmox-orange' : 'bg-proxmox-dark hover:bg-proxmox-hover border border-transparent'
                                            }`}
                                        >
                                            <div className="flex items-center gap-3">
                                                <Icons.Folder className="w-4 h-4" style={{ color: group.color || '#E86F2D' }} />
                                                <span className="text-gray-300">{group.name}</span>
                                            </div>
                                        </button>
                                    ))}
                                </div>
                                
                                {clusterGroups.length === 0 && (
                                    <p className="text-sm text-gray-500 text-center mt-4">
                                        {t('createGroupFirst')}
                                    </p>
                                )}
                            </div>
                        </div>
                    )}
                    
                    {/* Task Bar */}
                    {showTaskBar && (
                        <TaskBar 
                            tasks={tasks}
                            onClear={clearCompletedTasks}
                            onClose={() => setShowTaskBar(false)}
                            onCancel={cancelTask}
                            onRefresh={() => selectedCluster && fetchTasks(selectedCluster.id)}
                            clusterId={selectedCluster?.id}
                        />
                    )}
                </div>
            );
        }

        // Main App with Auth Check
        function App() {
            const { user, loading } = useAuth();
            
            if (loading) {
                return (
                    <div className="min-h-screen bg-proxmox-darker flex items-center justify-center">
                        <div className="text-center">
                            <div className="inline-flex items-center justify-center w-16 h-16 rounded-2xl bg-proxmox-orange mb-4">
                                <svg className="w-8 h-8 text-white animate-spin" fill="none" viewBox="0 0 24 24">
                                    <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                                    <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                            </div>
                            <p className="text-gray-400">Loading...</p>
                        </div>
                    </div>
                );
            }
            
            if (!user) {
                return <LoginScreen />;
            }
            
            return <PegaProxDashboard />;
        }

        ReactDOM.render(
            <LanguageProvider>
                <AuthProvider>
                    <App />
                </AuthProvider>
            </LanguageProvider>,
            document.getElementById('root')
        );
        
        // LW: Hide loading screen after React renders
        const loadingScreen = document.getElementById('loading-screen');
        if (loadingScreen) {
            loadingScreen.style.opacity = '0';
            loadingScreen.style.transition = 'opacity 0.3s ease';
            setTimeout(() => loadingScreen.remove(), 300);
        }
    </script>
</body>
</html>